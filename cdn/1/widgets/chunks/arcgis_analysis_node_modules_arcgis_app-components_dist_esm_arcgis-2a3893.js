"use strict";
(self["webpackChunkexb_client"] = self["webpackChunkexb_client"] || []).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-2a3893"],{

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/arcgis-smart-mapping-panels-type_3.entry.js":
/*!*************************************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/arcgis-smart-mapping-panels-type_3.entry.js ***!
  \*************************************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   arcgis_smart_mapping_panels_type: () => (/* binding */ ArcgisSmartMappingPanelsType),
/* harmony export */   arcgis_smart_mapping_type_actions_popover: () => (/* binding */ ArcgisSmartMappingTypeActionsPopover),
/* harmony export */   arcgis_smart_mapping_type_add_value: () => (/* binding */ ArcgisSmartMappingTypeAddValue)
/* harmony export */ });
/* harmony import */ var _index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./index-e3bf7da7.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-e3bf7da7.js");
/* harmony import */ var _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./raster-unique-value-0976ec7f.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/raster-unique-value-0976ec7f.js");
/* harmony import */ var _loadModules_b4ac1247_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./loadModules-b4ac1247.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/loadModules-b4ac1247.js");
/* harmony import */ var _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./commonEnums-fcf13661.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/commonEnums-fcf13661.js");
/* harmony import */ var _symbolStyler_04635b2b_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./symbolStyler-04635b2b.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/symbolStyler-04635b2b.js");
/* harmony import */ var _type_0ace5d2e_js__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./type-0ace5d2e.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/type-0ace5d2e.js");
/* harmony import */ var _languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./languageUtil-ef0e54b2.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/languageUtil-ef0e54b2.js");
/* harmony import */ var _sortable_esm_7e785780_js__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./sortable.esm-7e785780.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/sortable.esm-7e785780.js");
/* harmony import */ var _date_79c7d93c_js__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./date-79c7d93c.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/date-79c7d93c.js");
/* harmony import */ var _locale_050b6db9_js__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ./locale-050b6db9.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/locale-050b6db9.js");
/* harmony import */ var _dom_4d367677_js__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ./dom-4d367677.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/dom-4d367677.js");
/* harmony import */ var _index_05956cab_js__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! ./index-05956cab.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-05956cab.js");
/* harmony import */ var _commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_12__ = __webpack_require__(/*! ./commonFunctions-b0830e9e.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/commonFunctions-b0830e9e.js");
/* harmony import */ var _location_e26b539f_js__WEBPACK_IMPORTED_MODULE_13__ = __webpack_require__(/*! ./location-e26b539f.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/location-e26b539f.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v4.0.58
 */















const arcgisSmartMappingPanelsTypeCss = ":host{width:100%}.flow-item{height:100%}.hidden{display:none}.type-block{overflow-x:hidden}.check-placeholder{width:32px;height:24px}.type-panel-msg{font-size:80%;margin:5px}.toggle-button{margin-top:2px}.toggle-div{padding-top:6px}.top-padding{padding-top:10px}.symbol-selector{background-color:rgb(255, 255, 255);display:flex;padding:9px 9px;justify-content:space-between;align-items:center;border-radius:3px;cursor:pointer;transition:box-shadow 250ms ease-in-out;box-shadow:0 0 0 1px #e0e0e0}.symbol-selector :last-child{margin-bottom:0}.symbol-selector :last-child svg{fill:#c0c0c0}.symbol-selector :hover{box-shadow:0 0 0 1px #c0c0c0}.symbol-selector :hover svg{fill:#404040}.symbol-selector--selected,.symbol-selector--selected:hover{outline:1px solid var(--calcite-color-brand)}.symbol-selector--selected svg,.symbol-selector--selected:hover svg{fill:#404040}.symbol-is-white{background-color:#f3f3f3}.symbol-icon{min-width:26px;display:flex}.symbol-icon div{margin:auto}.symbol-icon.transparent{height:15px;width:100%}.symbol-icon.transparent svg{height:15px;width:95%;stroke:#e0e0e0;stroke-width:1px}.group-header{display:flex;padding:6px 0;justify-content:space-between;align-items:center;border-bottom:1px solid #e0e0e0}.group-heading{font-weight:bold}.no-group-heading{color:rgba(50, 50, 50, 0.4);font-style:italic}.group{border:1px solid #e0e0e0;margin:5px 0}.group-text{padding:3px 9px 0 9px;word-break:break-all}.group-text-active{cursor:pointer}.group-count{padding-top:7px}.group-count-no-menu{padding-right:3px}.values-items-only{padding:6px 6px}.value{display:flex;padding:6px 0;justify-content:space-between;align-items:center}.value-part1{display:flex;width:-webkit-fill-available;width:-moz-available;align-items:center;margin:0 5px}.value-part2{display:flex}.group-handle,.class-handle{color:rgba(50, 50, 50, 0.4);cursor:grab;width:16px;display:flex}.group-handle-disabled,.class-handle-disabled{color:#e0e0e0;width:16px;display:flex}.value-symbol{margin:0 5px;padding:4px;cursor:pointer}.value-text{padding:0 9px;word-break:break-all;cursor:pointer}.value-count{padding:3px 3px 0 3px}.menu-placeholder{width:32px}.value-handle-placeholder{min-width:16px}.other{border:1px solid #e0e0e0}.default-value{border-bottom:1px solid #e0e0e0}.other-value-text{cursor:default}.symbol-styler-panel{width:328px;min-height:300px}.symbol-styler-div{width:100%}.avatar{background-color:#f0efef}.value-text:focus,.group-text:focus,.symbol:focus{outline:2px solid var(--calcite-color-brand)}";

const ArcgisSmartMappingPanelsType = class {
    constructor(hostRef) {
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
        this.arcgisSmartMappingPanelsTypeBackClick = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisSmartMappingPanelsTypeBackClick", 7);
        this.arcgisSmartMappingPanelsTypeClose = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisSmartMappingPanelsTypeClose", 7);
        this.arcgisSmartMappingPanelsTypeClusterRequiresUpdate = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisSmartMappingPanelsTypeClusterRequiresUpdate", 7);
        this.arcgisSmartMappingPanelsTypeError = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisSmartMappingPanelsTypeError", 7);
        this.groupMenuNodes = [];
        this.groupInputNodes = [];
        this.groupTextNodes = [];
        this.valueInputNodes = [];
        this.valueTextNodes = [];
        this.symbolNodes = [];
        this.checkedClasses = [];
        this.classSortable = [];
        this.groupSortable = undefined;
        this.otherSortable = undefined;
        this.maxCountOtherValues = 200;
        this.symbolStylerOpen = false;
        this.dragRenderToggle = true;
        this.hideRotation = false;
        this.hideTransparency = false;
        this.menuOpen = undefined;
        this.showBackButton = undefined;
        this.beforeBack = undefined;
    }
    //--------------------------------------------------------------------------
    //
    //  Public Methods
    //
    //--------------------------------------------------------------------------
    async setFocus() {
        var _a;
        (_a = this.flowItemNode) === null || _a === void 0 ? void 0 : _a.setFocus();
    }
    //-------------------------------------------------------------------
    //
    //  Lifecycle
    //
    //-------------------------------------------------------------------
    async componentWillLoad() {
        var _a;
        const { layer: smLayer, mapView, modules, strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const layer = smLayer;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const rendererType = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.g)();
        _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s.lastDefault = {
            defaultSymbol: renderer.defaultSymbol || (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.S)(layer, mapView),
            defaultLabel: renderer.defaultLabel || strings.panels.type.other
        };
        this.originalRendererJSON = renderer.toJSON();
        this.originalFeatureReduction =
            "featureReduction" in layer && layer.featureReduction
                ? modules.esriLang.clone(layer.featureReduction)
                : undefined;
        this.originalOrderBy = layer.orderBy;
        // get all unique values
        try {
            const result = await (0,_type_0ace5d2e_js__WEBPACK_IMPORTED_MODULE_5__.c)({
                fieldInfos: [
                    {
                        field: renderer.field,
                        expression: renderer.valueExpression,
                        expressionTitle: renderer.valueExpressionTitle
                    }
                ],
                typeScheme: (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__._)()
            });
            if ((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.q)(layer) && rendererType === "type-size") {
                // need to convert fill symbols to marker symbols
                let refSymbol = ((_a = renderer.uniqueValueInfos) === null || _a === void 0 ? void 0 : _a.length)
                    ? renderer.uniqueValueInfos[0].symbol
                    : (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.S)(layer, mapView);
                if (refSymbol.type !== "simple-marker") {
                    // might be a picture marker
                    refSymbol = new modules.SimpleMarkerSymbol();
                }
                result.uniqueValueInfos.map((info) => {
                    const newSymbol = modules.esriLang.clone(refSymbol);
                    (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.r)(newSymbol, (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.t)(info.symbol));
                    info.symbol = newSymbol;
                });
            }
            _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s.allUniqueValues = result.uniqueValueInfos;
            return Promise.resolve(result);
        }
        catch (error) {
            this.arcgisSmartMappingPanelsTypeError.emit({
                message: error,
                type: "error"
            });
            return Promise.reject(error);
        }
    }
    componentDidLoad() {
        requestAnimationFrame(() => { var _a; return (_a = this.flowItemNode) === null || _a === void 0 ? void 0 : _a.setFocus(); });
    }
    disconnectedCallback() {
        this.closePopovers();
    }
    //-------------------------------------------------------------------
    //
    //  Render Methods
    //
    //-------------------------------------------------------------------
    render() {
        var _a;
        const { hideLayerTitle, isRTL, layer, mapImageSublayer, strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const title = hideLayerTitle ? undefined : (_a = mapImageSublayer === null || mapImageSublayer === void 0 ? void 0 : mapImageSublayer.title) !== null && _a !== void 0 ? _a : layer.title;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "calcite-match-height" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { class: {
                "flow-item": true,
                [_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_6__.C.rtl]: isRTL
            }, heading: strings.panels.type.styleOptions, closable: (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.aa)(this.hostElement), menuOpen: this.menuOpen, beforeBack: this.beforeBack,
            // @ts-ignore
            showBackButton: this.showBackButton, description: title, onCalciteFlowItemBack: () => this.arcgisSmartMappingPanelsTypeBackClick.emit(), ref: (node) => (this.flowItemNode = node) }, this.renderVisualizationContent(), this.renderTransparency(), this.renderRotation(), this.renderDoneButton(), this.renderCancelButton())));
    }
    renderVisualizationContent() {
        const { layer, strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const hasOtherBlocks = !this.hideTransparency || !this.hideRotation;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const field = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.u)(renderer.field);
        const isDate = (field === null || field === void 0 ? void 0 : field.simpleFieldType) === _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.w.DATE ||
            (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.z)(field === null || field === void 0 ? void 0 : field.layerField) === "date-only";
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { class: "type-block", heading: isDate ? strings.panels.type.typeStyleDate : strings.panels.type.typeStyle, collapsible: hasOtherBlocks, open: true }, this.renderTypesSymbol(), this.renderDrawingOrder(), this.renderGroups(), this.renderBackgroundStyle()));
    }
    renderTypesSymbol() {
        var _a;
        const { layer, mapView, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const groups = renderer.uniqueValueGroups;
        if (!(groups === null || groups === void 0 ? void 0 : groups.length) || !((_a = groups[0].classes) === null || _a === void 0 ? void 0 : _a.length)) {
            return null;
        }
        const allClasses = [];
        groups.forEach((group) => group.classes.forEach((uvClass) => allClasses.push(uvClass)));
        const schemes = modules.typeSchemes.getSchemes({
            basemap: mapView.map.basemap,
            geometryType: (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.D)(layer)
        });
        const colorRampsAndSchemes = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.a9)(schemes, Math.min(allClasses.length, 10));
        const defaultColors = colorRampsAndSchemes[0].colors;
        let colors = (allClasses === null || allClasses === void 0 ? void 0 : allClasses.length)
            ? allClasses
                .slice(0, 10)
                .map((uvClass, idx) => (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.t)(uvClass.symbol) ||
                new modules.esriColor(defaultColors[idx % defaultColors.length]))
            : [];
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-smart-mapping-symbol-button", { rampType: "discrete", colors: colors, type: "type-ramp", onArcgisSmartMappingSymbolButtonSymbolChange: () => {
                (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
                this.rotationNode && (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.rotationNode);
            } }));
    }
    renderDrawingOrder() {
        const { layer, mapImageSublayer, strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        if (mapImageSublayer) {
            return null;
        }
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { class: "toggle-div", layout: "inline-space-between" }, strings.panels.type.drawingOrder, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-switch", { class: "toggle-button", scale: "s", checked: renderer.orderByClassesEnabled, onCalciteSwitchChange: (event) => {
                const node = event.target;
                this.handleDrawingOrderToggle(node.checked);
            } })));
    }
    renderGroups() {
        var _a, _b;
        const { layer, strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const hasNoGroup = !((_a = renderer.uniqueValueGroups) === null || _a === void 0 ? void 0 : _a.length);
        const fieldName = renderer.field
            ? (_b = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.u)(renderer.field)) === null || _b === void 0 ? void 0 : _b.label
            : renderer.valueExpressionTitle || strings.expression;
        const typeGroups = hasNoGroup
            ? [this.renderNoGroup()]
            : renderer.uniqueValueGroups.map((uniqueValueGroup, groupIdx) => this.renderGroup(uniqueValueGroup, groupIdx));
        const otherValues = this.renderOtherValues();
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "top-padding" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, fieldName), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { key: renderer.uniqueValueGroups.length, ref: (node) => {
                var _a;
                if (node) {
                    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
                    if (renderer.uniqueValueGroups.length) {
                        (_a = this.groupSortable) === null || _a === void 0 ? void 0 : _a.destroy();
                        this.groupSortable = _sortable_esm_7e785780_js__WEBPACK_IMPORTED_MODULE_7__.S.create(node, {
                            group: { name: "shared", pull: true, put: false },
                            dataIdAttr: "group-sort-values",
                            ghostClass: "avatar",
                            onSort: () => this.handleSortGroups(),
                            handle: `.group-handle`
                        });
                    }
                }
            } }, typeGroups), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "other", key: `${otherValues.length}${this.dragRenderToggle}` }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: typeGroups.length ? "" : "values-items-only" }, this.renderDefaultValue()), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { ref: (node) => {
                var _a;
                if (node) {
                    (_a = this.otherSortable) === null || _a === void 0 ? void 0 : _a.destroy();
                    this.otherSortable = _sortable_esm_7e785780_js__WEBPACK_IMPORTED_MODULE_7__.S.create(node, {
                        group: { name: "shared", pull: false, put: true },
                        filter: ".nodrag",
                        sort: false
                    });
                }
            } }, otherValues, this.renderMsg()))));
    }
    renderNoGroup() {
        const { strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "group" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "group-header" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "value-part1" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "group-handle-disabled", "aria-hidden": "true" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "drag" })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "group-text no-group-heading", role: "button", tabIndex: 0, "aria-label": strings.panels.type.accessibility.editLabelFor.replace("${value}", strings.panels.type.groupNameHint) }, strings.panels.type.groupNameHint)), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "value-part2" }, this.renderGroupMenuNode(-2))), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", null, "\u00A0")));
    }
    renderGroup(uniqueValueGroup, groupIdx) {
        const classValues = uniqueValueGroup.classes.map((uniqueValueClass, classIdx) => this.renderValue(uniqueValueClass, groupIdx, classIdx));
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { key: uniqueValueGroup.toJSON(), class: "group", "group-sort-values": `${groupIdx}` }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "group-header" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "value-part1" }, this.renderGroupHandleNode(groupIdx), this.renderGroupTextNode(uniqueValueGroup, groupIdx)), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "value-part2" }, this.renderGroupCountNode(uniqueValueGroup), this.renderGroupMenuNode(groupIdx, uniqueValueGroup))), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { ref: (node) => {
                var _a, _b;
                if (node) {
                    (_b = (_a = this.classSortable) === null || _a === void 0 ? void 0 : _a[groupIdx]) === null || _b === void 0 ? void 0 : _b.destroy();
                    this.classSortable[groupIdx] = _sortable_esm_7e785780_js__WEBPACK_IMPORTED_MODULE_7__.S.create(node, {
                        group: { name: "nested", pull: true, put: ["nested"] },
                        dataIdAttr: "class-sort-values",
                        ghostClass: "avatar",
                        onSort: () => this.handleSortClasses(groupIdx),
                        handle: `.class-handle`
                    });
                }
            } }, classValues)));
    }
    renderGroupHandleNode(groupIdx) {
        const { strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const isShowingInput = this.selectedValueText === `${groupIdx}`;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: isShowingInput ? "group-handle-disabled" : "group-handle", "aria-hidden": "true", onMouseOver: (event) => {
                const referenceNode = event.target;
                !isShowingInput &&
                    this.onMouseOver(`values-${groupIdx}-handle-tooltip`, referenceNode, strings.panels.type.tooltips.dragGroup);
            }, onMouseOut: () => this.onMouseOut(`values-${groupIdx}-handle-tooltip`) }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "drag" })));
    }
    renderGroupTextNode(uniqueValueGroup, groupIdx) {
        const { strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        let eventHandled = false; // to prevent duplicate handling and unnecessary updates from the same user event
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.F, null, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { class: "hidden", value: uniqueValueGroup.heading || "", onKeyDown: (event) => {
                if (event.key === "Escape" || event.key === "Enter") {
                    if (!eventHandled) {
                        event.preventDefault();
                        event.stopPropagation();
                        eventHandled = true;
                        const node = event.target;
                        this.handleGroupTextChange(groupIdx, node.value);
                    }
                }
            }, onFocusout: (event) => {
                if (!eventHandled) {
                    eventHandled = true;
                    const node = event.target;
                    this.handleGroupTextChange(groupIdx, node.value);
                }
            }, ref: (node) => {
                if (node) {
                    this.groupInputNodes[groupIdx] = node;
                }
            } }), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: `group-text group-text-active ${uniqueValueGroup.heading ? "group-heading" : "no-group-heading"}`, role: "button", tabIndex: 0, "aria-label": strings.panels.type.accessibility.editLabelFor.replace("${value}", uniqueValueGroup.heading || strings.panels.type.groupNameHint), onClick: () => {
                this.onMouseOut(`group-${groupIdx}-text-tooltip`);
                this.handleGroupTextClick(groupIdx);
            }, onMouseOver: (event) => {
                const referenceNode = event.target;
                this.onMouseOver(`group-${groupIdx}-text-tooltip`, referenceNode, strings.panels.type.tooltips.renameGroup);
            }, onMouseOut: () => this.onMouseOut(`group-${groupIdx}-text-tooltip`), onKeyDown: (event) => {
                if (event.key === " " || event.key === "Enter") {
                    event.preventDefault();
                    event.stopPropagation();
                    this.handleGroupTextClick(groupIdx);
                }
            }, ref: (node) => {
                if (node) {
                    this.groupTextNodes[groupIdx] = node;
                }
            } }, uniqueValueGroup.heading || strings.panels.type.groupNameHint)));
    }
    renderValue(uniqueValueClass, groupIdx, classIdx) {
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { key: `values-${uniqueValueClass.label}`, class: "value", "class-sort-values": `${groupIdx}/${classIdx}` }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "value-part1" }, this.renderHandleNode(groupIdx, classIdx), this.renderCheckNode(groupIdx, classIdx), this.renderSymbolNode(uniqueValueClass, groupIdx, classIdx), this.renderTextNode(uniqueValueClass, groupIdx, classIdx)), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "value-part2" }, this.renderCountNode(uniqueValueClass))));
    }
    renderHandleNode(groupIdx, classIdx) {
        const { strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const isShowingInput = this.selectedValueText === `${groupIdx}/${classIdx}`;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: isShowingInput ? "class-handle-disabled" : "class-handle", "aria-hidden": "true", onMouseOver: (event) => {
                const referenceNode = event.target;
                this.onMouseOver(`values-${groupIdx}-${classIdx}-handle-tooltip`, referenceNode, strings.panels.type.tooltips.dragType);
            }, onMouseOut: () => this.onMouseOut(`values-${groupIdx}-${classIdx}-handle-tooltip`) }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "drag" })));
    }
    renderCheckNode(groupIdx, classIdx, last) {
        const { strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const isChecked = this.checkedClasses.find((info) => info.groupIdx === groupIdx && info.classIdx === classIdx);
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { scale: "s", icon: isChecked ? "check-square" : "square", text: strings.panels.type.checkValue, appearance: "transparent", onClick: (event) => {
                const node = event.currentTarget;
                this.handleCheck(groupIdx, classIdx, node);
            }, onKeyDown: (event) => {
                var _a;
                if (groupIdx === -1 && last && !event.shiftKey && event.key === "Tab") {
                    // send focus to the actions popover
                    (_a = this.actionsPopoverNode) === null || _a === void 0 ? void 0 : _a.focusActionPad();
                }
            }, ref: (node) => {
                if (groupIdx === -1 && last) {
                    this.lastOtherValueCheckNode = node;
                }
            } }));
    }
    renderSymbolNode(uniqueValueClass, groupIdx, classIdx) {
        const { layer, strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const symbolNodeClasses = {
            "value-symbol": true,
            "symbol-is-white": (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.aq)(uniqueValueClass.symbol)
        };
        const symbolClasses = {
            "symbol": true,
            [(0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.D)(layer)]: true,
            "symbol-selector--selected": this.selectedValue === `${groupIdx}/${classIdx}`
        };
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: symbolNodeClasses, onClick: () => this.handleValueSymbolClick(groupIdx, classIdx), role: "button", "aria-label": strings.panels.type.accessibility.editSymbolFor.replace("${value}", uniqueValueClass.label), "aria-haspopup": "true", "aria-expanded": this.selectedValue === `${groupIdx}/${classIdx}`, onMouseOver: (event) => {
                const referenceNode = event.target;
                this.onMouseOver(`values-${groupIdx}-${classIdx}-icon-tooltip`, referenceNode, strings.panels.type.tooltips.changeSymbol);
            }, onMouseOut: () => this.onMouseOut(`values-${groupIdx}-${classIdx}-icon-tooltip`), onKeyDown: (event) => {
                if (event.key === " " || event.key === "Enter") {
                    event.preventDefault();
                    event.stopPropagation();
                    this.handleValueSymbolClick(groupIdx, classIdx);
                }
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: symbolClasses, tabIndex: 0, ref: (node) => {
                if (node) {
                    if (!this.symbolNodes[groupIdx]) {
                        this.symbolNodes[groupIdx] = [];
                    }
                    this.symbolNodes[groupIdx][classIdx] = node;
                    this.afterCreateValueSymbol(groupIdx, classIdx, node);
                }
            }, "aria-hidden": "true" })));
    }
    renderTextNode(uniqueValueClass, groupIdx, classIdx) {
        var _a;
        const { strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        let eventHandled = false; // to prevent duplicate handling and unnecessary updates from the same user event
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.F, null, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { class: "hidden", value: uniqueValueClass.label, onKeyDown: (event) => {
                if (event.key === "Escape" || event.key === "Enter") {
                    event.preventDefault();
                    event.stopPropagation();
                    if (!eventHandled) {
                        eventHandled = true;
                        const node = event.target;
                        this.handleValueTextChange(groupIdx, classIdx, node.value);
                    }
                }
            }, onFocusout: (event) => {
                if (!eventHandled) {
                    eventHandled = true;
                    const node = event.target;
                    this.handleValueTextChange(groupIdx, classIdx, node.value);
                }
            }, ref: (node) => {
                if (node) {
                    if (!this.valueInputNodes[groupIdx]) {
                        this.valueInputNodes[groupIdx] = [];
                    }
                    this.valueInputNodes[groupIdx][classIdx] = node;
                }
            } }), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "value-text", role: "button", tabIndex: 0, "aria-label": strings.panels.type.accessibility.editLabelFor.replace("${value}", uniqueValueClass.label), onClick: () => {
                this.onMouseOut(`value-${groupIdx}-${classIdx}-text-tooltip`);
                this.handleValueTextClick(groupIdx, classIdx);
            }, onMouseOver: (event) => {
                const referenceNode = event.target;
                this.onMouseOver(`value-${groupIdx}-${classIdx}-text-tooltip`, referenceNode, strings.panels.type.tooltips.renameType);
            }, onMouseOut: () => this.onMouseOut(`value-${groupIdx}-${classIdx}-text-tooltip`), onKeyDown: (event) => {
                if (event.key === " " || event.key === "Enter") {
                    event.preventDefault();
                    event.stopPropagation();
                    this.handleValueTextClick(groupIdx, classIdx);
                }
                else if (!event.shiftKey && event.key === "Tab" && groupIdx === -1) {
                    const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
                    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
                    const otherUniqueValueInfos = (0,_type_0ace5d2e_js__WEBPACK_IMPORTED_MODULE_5__.g)();
                    let rendererClassCount = 0;
                    renderer.uniqueValueGroups.forEach((uniqueValueGroup) => (rendererClassCount += uniqueValueGroup.classes.length));
                    const hasOtherValues = !!(otherUniqueValueInfos === null || otherUniqueValueInfos === void 0 ? void 0 : otherUniqueValueInfos.length) &&
                        !(otherUniqueValueInfos.length === 1 && !otherUniqueValueInfos[0].value) &&
                        rendererClassCount < 200;
                    if (!hasOtherValues) {
                        // send focus to the actions popover
                        this.actionsPopoverNode.focusActionPad();
                    }
                }
            }, ref: (node) => {
                if (node) {
                    if (groupIdx === -1 && classIdx === -1) {
                        this.otherTextNode = node;
                    }
                    else {
                        if (!this.valueTextNodes[groupIdx]) {
                            this.valueTextNodes[groupIdx] = [];
                        }
                        this.valueTextNodes[groupIdx][classIdx] = node;
                    }
                }
            } }, ((_a = uniqueValueClass.label) === null || _a === void 0 ? void 0 : _a.trim().length)
            ? uniqueValueClass.label
            : // adding nbsp elements if label contains only whitespace to ensure user can select
                "\u00A0\u00A0\u00A0\u00A0\u00A0\u00A0")));
    }
    renderCountNode(uniqueValueClass) {
        const { allUniqueValues, strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        if (!(allUniqueValues === null || allUniqueValues === void 0 ? void 0 : allUniqueValues.length)) {
            return;
        }
        let count = undefined;
        if (uniqueValueClass.values.length > 1) {
            count = uniqueValueClass.values.reduce((mergedCount, value) => {
                var _a;
                return mergedCount + ((_a = this.getUniqueValue(value.value)) === null || _a === void 0 ? void 0 : _a.count) || 0;
            }, 0);
        }
        else {
            const value = uniqueValueClass.values[0].value;
            const info = this.getUniqueValue(value);
            if (info && !(0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.ac)(info.count)) {
                return null;
            }
            else if (!info && (allUniqueValues === null || allUniqueValues === void 0 ? void 0 : allUniqueValues.length)) {
                // if !info must be a user added value; display 0 if other values have a count
                const firstInfo = this.getUniqueValue(allUniqueValues[0].value);
                if (!(0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.ac)(firstInfo === null || firstInfo === void 0 ? void 0 : firstInfo.count)) {
                    return null;
                }
            }
            count = !info ? 0 : info.count;
        }
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "value-count", "aria-label": strings.panels.type.accessibility.countFor.replace("${value}", uniqueValueClass.label) }, `${count}`));
    }
    renderGroupCountNode(uniqueValueGroup) {
        const { allUniqueValues, strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        if (!(allUniqueValues === null || allUniqueValues === void 0 ? void 0 : allUniqueValues.length)) {
            return;
        }
        let totalCount = 0;
        uniqueValueGroup.classes.forEach((uniqueValueClass) => {
            uniqueValueClass.values.forEach((value) => {
                var _a;
                const info = this.getUniqueValue(value.value);
                if (info && !(0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.ac)(info.count)) {
                    return;
                }
                else if (!info && (allUniqueValues === null || allUniqueValues === void 0 ? void 0 : allUniqueValues.length)) {
                    // if !info must be a user added value; display 0 if other values have a count
                    const firstInfo = this.getUniqueValue(allUniqueValues[0].value);
                    if (!(0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.ac)(firstInfo === null || firstInfo === void 0 ? void 0 : firstInfo.count)) {
                        return;
                    }
                }
                totalCount += (_a = info === null || info === void 0 ? void 0 : info.count) !== null && _a !== void 0 ? _a : 0;
            });
        });
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "group-count", "aria-label": strings.panels.type.accessibility.countFor.replace("${value}", uniqueValueGroup.heading) }, `${!allUniqueValues ? "" : totalCount}`));
    }
    renderGroupMenuNode(groupIdx, uniqueValueGroup) {
        const { layer, strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const groups = renderer.uniqueValueGroups;
        let canSelect = false;
        let hasMergedValues = false;
        let otherValueClasses;
        if (groupIdx === -1) {
            otherValueClasses = (0,_type_0ace5d2e_js__WEBPACK_IMPORTED_MODULE_5__.b)();
            // don't show more than 200 values total
            let countCurrentClasses = 0;
            renderer.uniqueValueGroups.forEach((uniqueValueGroup) => { var _a, _b; return (countCurrentClasses += (_b = (_a = uniqueValueGroup.classes) === null || _a === void 0 ? void 0 : _a.length) !== null && _b !== void 0 ? _b : 0); });
            if (countCurrentClasses + otherValueClasses.length > 200) {
                otherValueClasses = otherValueClasses.slice(0, 200 - countCurrentClasses);
            }
            canSelect = !!otherValueClasses.find((_, idx) => !this.checkedClasses.find((info) => info.groupIdx === -1 && info.classIdx === idx));
        }
        else {
            canSelect = !!(uniqueValueGroup === null || uniqueValueGroup === void 0 ? void 0 : uniqueValueGroup.classes.find((_, idx) => !this.checkedClasses.find((info) => info.groupIdx === groupIdx && info.classIdx === idx)));
            hasMergedValues = !!(uniqueValueGroup === null || uniqueValueGroup === void 0 ? void 0 : uniqueValueGroup.classes.find((uvClass) => uvClass.values.length > 1));
        }
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown", { placement: "bottom-end", scale: "s", overlayPositioning: "absolute", ref: (node) => {
                if (node) {
                    this.groupMenuNodes[groupIdx] = node;
                }
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { slot: "trigger", scale: "s", text: strings.panels.type.tooltips.options }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "ellipsis" })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-group", { "selection-mode": "none" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { "icon-start": "pin-plus", label: strings.panels.type.addValue, onClick: () => this.handleAddValue(groupIdx), onKeyDown: (event) => {
                event.stopPropagation();
                if (event.key === " " || event.key === "Enter") {
                    this.handleAddValue(groupIdx);
                }
            } }, strings.panels.type.addValue), groups.length > 0 && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { "icon-start": "palette", label: strings.panels.type.changeColors, onClick: () => this.openSymbolStylerForGroup(groupIdx), onKeyDown: (event) => {
                event.stopPropagation();
                if (event.key === " " || event.key === "Enter") {
                    this.openSymbolStylerForGroup(groupIdx);
                }
            } }, strings.panels.type.changeColors))), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-group", { "selection-mode": "none" }, canSelect && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { "icon-start": "check-circle", label: strings.panels.type.selectAllValues, onClick: () => this.handleSelectAllValues(groupIdx), onKeyDown: (event) => {
                event.stopPropagation();
                if (event.key === " " || event.key === "Enter") {
                    this.handleSelectAllValues(groupIdx);
                }
            } }, strings.panels.type.selectAllValues)), hasMergedValues && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { "icon-start": "group-x", label: strings.panels.type.separateValues, onClick: () => this.handleSeparateValues(groupIdx), onKeyDown: (event) => {
                event.stopPropagation();
                if (event.key === " " || event.key === "Enter") {
                    this.handleSeparateValues(groupIdx);
                }
            } }, strings.panels.type.separateValues)), groupIdx > 0 && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { "icon-start": "arrow-bold-up", label: strings.panels.type.moveUp, onClick: () => this.handleGroupMoveUp(groupIdx), onKeyDown: (event) => {
                event.stopPropagation();
                if (event.key === " " || event.key === "Enter") {
                    this.handleGroupMoveUp(groupIdx);
                }
            } }, strings.panels.type.moveUp)), groups.length > 0 && groupIdx < groups.length - 1 && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { "icon-start": "arrow-bold-down", label: strings.panels.type.moveDown, onClick: () => this.handleGroupMoveDown(groupIdx), onKeyDown: (event) => {
                event.stopPropagation();
                if (event.key === " " || event.key === "Enter") {
                    this.handleGroupMoveDown(groupIdx);
                }
            } }, strings.panels.type.moveDown)))));
    }
    renderDefaultValue() {
        const { layer, lastDefault, strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const defaultSymbol = renderer.defaultSymbol || lastDefault.defaultSymbol;
        const defaultLabel = renderer.defaultLabel || lastDefault.defaultLabel;
        const otherUniqueValueInfos = (0,_type_0ace5d2e_js__WEBPACK_IMPORTED_MODULE_5__.g)();
        const otherCount = otherUniqueValueInfos ? this.getOtherCount(otherUniqueValueInfos) : -1;
        let rendererClassCount = 0;
        renderer.uniqueValueGroups.forEach((uniqueValueGroup) => (rendererClassCount += uniqueValueGroup.classes.length));
        const hasOtherValues = !!(otherUniqueValueInfos === null || otherUniqueValueInfos === void 0 ? void 0 : otherUniqueValueInfos.length) && rendererClassCount < 200;
        const hasOnlyNullValue = hasOtherValues && otherUniqueValueInfos.length === 1 && !otherUniqueValueInfos[0].value;
        const symbolNodeClasses = {
            "value-symbol": true,
            "symbol-is-white": (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.aq)(defaultSymbol)
        };
        const symbolClasses = {
            "symbol": true,
            [(0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.D)(layer)]: true,
            "symbol-selector--selected": this.selectedValue === `-1`
        };
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: `value ${hasOtherValues ? "default-value" : ""}` }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "value-part1" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-checkbox", { scale: "s", checked: !!renderer.defaultSymbol, onMouseOver: (event) => {
                const referenceNode = event.target;
                this.onMouseOver("default-value-checkbox-tooltip", referenceNode, strings.panels.type.tooltips.otherTooltip);
            }, onMouseOut: () => this.onMouseOut("default-value-checkbox-tooltip"), onClick: () => this.handleDefaultCheckChange() }), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: symbolNodeClasses, onClick: () => this.handleValueSymbolClick(-1, 0), role: "button", "aria-haspopup": "true", "aria-expanded": this.selectedValue === `-1/0`, "aria-label": strings.panels.type.accessibility.editSymbolFor.replace("${fieldName}", defaultLabel), onMouseOver: (event) => {
                const referenceNode = event.target;
                this.onMouseOver("default-value-symbol-tooltip", referenceNode, strings.panels.type.tooltips.changeSymbol);
            }, onMouseOut: () => this.onMouseOut("default-value-symbol-tooltip"), onKeyDown: (event) => {
                if (event.key === " " || event.key === "Enter") {
                    event.preventDefault();
                    event.stopPropagation();
                    this.handleValueSymbolClick(-1, 0);
                }
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: symbolClasses, tabIndex: 0, ref: (node) => {
                if (node) {
                    if (!this.symbolNodes[-1]) {
                        this.symbolNodes[-1] = [];
                    }
                    this.symbolNodes[-1][0] = node;
                    this.afterCreateValueSymbol(-1, 0, node);
                }
            }, "aria-hidden": "true" })), this.renderTextNode({
            symbol: defaultSymbol,
            label: defaultLabel
        }, -1, -1)), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "value-part2" }, otherCount > -1 ? ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: `group-count ${(!hasOtherValues || hasOnlyNullValue) && "group-count-no-menu"}`, "aria-label": strings.panels.type.accessibility.countFor.replace("${value}", defaultLabel) }, `${otherCount}`)) : null, hasOtherValues && !hasOnlyNullValue && this.renderDefaultMenuNode())));
    }
    renderDefaultMenuNode() {
        const { strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const otherUniqueValueClasses = (0,_type_0ace5d2e_js__WEBPACK_IMPORTED_MODULE_5__.b)();
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown", { placement: "bottom-end", scale: "s", overlayPositioning: "absolute", ref: (node) => {
                if (node) {
                    this.groupMenuNodes[-1] = node;
                }
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { slot: "trigger", scale: "s", text: strings.panels.type.tooltips.options }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "ellipsis" })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-group", { "selection-mode": "none" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { "icon-start": "arrow-bold-up", label: strings.panels.type.moveUp, onClick: () => this.handleMoveUpAll(otherUniqueValueClasses), onKeyDown: (event) => {
                event.stopPropagation();
                if (event.key === " " || event.key === "Enter") {
                    this.handleMoveUpAll(otherUniqueValueClasses);
                }
            } }, strings.panels.type.moveUp))));
    }
    renderOtherValues() {
        const { allUniqueValues, layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        if (!allUniqueValues || !allUniqueValues.length) {
            return null;
        }
        let otherValueClasses = (0,_type_0ace5d2e_js__WEBPACK_IMPORTED_MODULE_5__.b)();
        // don't show more than 200 values total
        let countCurrentClasses = 0;
        renderer.uniqueValueGroups.forEach((uniqueValueGroup) => { var _a, _b; return (countCurrentClasses += (_b = (_a = uniqueValueGroup.classes) === null || _a === void 0 ? void 0 : _a.length) !== null && _b !== void 0 ? _b : 0); });
        if (countCurrentClasses + otherValueClasses.length > 200) {
            otherValueClasses = otherValueClasses.slice(0, 200 - countCurrentClasses);
        }
        const otherValueNodes = otherValueClasses.map((otherValueClass, idx) => this.renderOtherValue(otherValueClass, idx, idx === otherValueClasses.length - 1));
        return otherValueNodes;
    }
    renderOtherValue(uniqueValueClass, idx, last) {
        const { strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "value nodrag", key: uniqueValueClass.toJSON() }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "value-part1" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "value-handle-placeholder" }, "\u00A0"), uniqueValueClass.values[0].value ? (this.renderCheckNode(-1, idx, last)) : ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "check-placeholder" }, "\u00A0")), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "value-text other-value-text", "aria-label": uniqueValueClass.label }, uniqueValueClass.values[0].value === null
            ? strings.panels.type.noData
            : uniqueValueClass.label)), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "value-part2" }, this.renderCountNode(uniqueValueClass))));
    }
    renderMsg() {
        const { allUniqueValues, layer, lastDefault, strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        // TODO estimatedValuesMsg
        if (allUniqueValues && allUniqueValues.length > this.maxCountOtherValues) {
            return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "type-panel-msg" }, strings.panels.type.errors.tooManyValues.replace("${count}", this.maxCountOtherValues.toString())));
        }
        else if (!renderer.uniqueValueInfos.length && !(allUniqueValues === null || allUniqueValues === void 0 ? void 0 : allUniqueValues.length)) {
            // only otherCategory
            return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "type-panel-msg" }, strings.panels.type.errors.noFeatures.replace("${other}", lastDefault.defaultLabel)));
        }
        else {
            return null;
        }
    }
    renderBackgroundStyle() {
        const { mapImageSublayer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        if ((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.g)() !== "type-size" || mapImageSublayer) {
            return null;
        }
        return (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-smart-mapping-background-symbol", null);
    }
    renderTransparency() {
        if (this.hideTransparency) {
            return null;
        }
        const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const opacityVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.a)((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer), "opacity");
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-smart-mapping-transparency", { open: !!opacityVisVar, onArcgisSmartMappingSymbolTransparencyError: ({ detail }) => this.arcgisSmartMappingPanelsTypeError.emit(detail), onKeyDown: (event) => {
                const rendererType = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.g)();
                if (rendererType === "type" && event.shiftKey && event.key === "Tab") {
                    this.actionsPopoverNode.focusLastAction();
                }
            }, ref: (node) => {
                if (node) {
                    this.transparencyNode = node;
                }
            } }));
    }
    renderRotation() {
        if (this.hideRotation) {
            return null;
        }
        const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const opacityVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.a)((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer), "opacity");
        const rotationVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.a)((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer), "rotation");
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-smart-mapping-rotation", { open: !opacityVisVar && !!rotationVisVar, onArcgisSmartMappingRotationError: ({ detail }) => this.arcgisSmartMappingPanelsTypeError.emit(detail), ref: (node) => (this.rotationNode = node) }));
    }
    renderDoneButton() {
        const { strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { slot: "footer", label: strings.done, onClick: () => this.arcgisSmartMappingPanelsTypeClose.emit("save"), appearance: "solid", width: "half", onKeyDown: (event) => {
                const rendererType = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.g)();
                if (rendererType === "type-size" && event.shiftKey && event.key === "Tab") {
                    this.actionsPopoverNode.focusLastAction();
                }
            }, ref: (node) => (this.doneButtonNode = node) }, strings.done));
    }
    renderCancelButton() {
        const { strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { slot: "footer", label: strings.cancel, onClick: () => {
                const { layer: smLayer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
                const layer = smLayer;
                const { originalRendererJSON, originalFeatureReduction, originalOrderBy } = this;
                this.closePopovers();
                layer.orderBy = originalOrderBy;
                (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.j)(originalRendererJSON, originalFeatureReduction);
                this.arcgisSmartMappingPanelsTypeClose.emit("cancel");
            }, appearance: "outline-fill", width: "half" }, strings.cancel));
    }
    //-------------------------------------------------------------------
    //
    //  Private Methods
    //
    //-------------------------------------------------------------------
    addActionsPopover() {
        this.closePopovers();
        this.actionsPopoverNode = document.createElement("arcgis-smart-mapping-type-actions-popover");
        this.actionsPopoverNode.referenceNode = this.flowItemNode;
        this.actionsPopoverNode.checkedClasses = this.checkedClasses;
        this.actionsPopoverNode.groupMenuNodes = this.groupMenuNodes;
        this.actionsPopoverNode.addEventListener("arcgisSmartMappingTypeActionsPopoverChange", (event) => {
            var _a;
            if ((_a = event.detail) === null || _a === void 0 ? void 0 : _a.checkedClasses) {
                this.checkedClasses = event.detail.checkedClasses;
            }
            this.removeActionsPopover();
            (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
            this.checkCluster();
        });
        this.actionsPopoverNode.addEventListener("arcgisSmartMappingTypeActionsPopoverFocusExit", (event) => {
            var _a, _b;
            if (event.detail === "bottom") {
                const rendererType = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.g)();
                if (rendererType === "type") {
                    (_a = this.transparencyNode) === null || _a === void 0 ? void 0 : _a.setFocus();
                }
                else {
                    // type-size
                    (_b = this.doneButtonNode) === null || _b === void 0 ? void 0 : _b.setFocus();
                }
            }
            else if (event.detail === "top") {
                this.lastOtherValueCheckNode
                    ? this.lastOtherValueCheckNode.setFocus()
                    : this.otherTextNode.focus();
            }
        });
        document.body.appendChild(this.actionsPopoverNode);
    }
    afterCreateValueSymbol(groupIdx, classIdx, node) {
        var _a;
        const { layer, lastDefault, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        let symbol;
        if (groupIdx === -1) {
            symbol = renderer.defaultSymbol || lastDefault.defaultSymbol;
        }
        else {
            symbol = renderer.uniqueValueGroups[groupIdx].classes[classIdx].symbol.clone();
        }
        // remove old symbol if there is one
        while ((_a = node === null || node === void 0 ? void 0 : node.childNodes) === null || _a === void 0 ? void 0 : _a.length) {
            node.removeChild(node.childNodes[0]);
        }
        if (symbol) {
            // add new symbol
            modules.symbolUtils
                .renderPreviewHTML(symbol, {
                size: (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.ar)(symbol),
                symbolConfig: 
                //symbol.type === "simple-fill" || ... while CIMs have that shape
                symbol.type === "cim" && symbol.data.symbol.type === "CIMPolygonSymbol"
                    ? { isSquareFill: true }
                    : undefined
            })
                .then((symbolNode) => node.appendChild(symbolNode));
        }
    }
    checkCluster() {
        const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        "featureReduction" in layer &&
            layer.featureReduction &&
            this.arcgisSmartMappingPanelsTypeClusterRequiresUpdate.emit();
    }
    closePopovers() {
        this.removeActionsPopover();
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.E)();
    }
    getOtherCount(otherInfos) {
        let totalCount = 0;
        otherInfos.map((info) => (totalCount += info.count));
        return otherInfos.length ? totalCount : -1;
    }
    getUniqueValue(value) {
        const { allUniqueValues } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        if (!allUniqueValues) {
            return null;
        }
        // no exact match!
        const infos = allUniqueValues.filter((info) => info.value == value);
        return infos.length ? infos[0] : null;
    }
    handleAddValue(groupIdx) {
        const addValuePopover = document.createElement("arcgis-smart-mapping-type-add-value");
        addValuePopover.groupIdx = groupIdx;
        addValuePopover.flowItemNode = this.flowItemNode;
        addValuePopover.referenceNode = this.groupMenuNodes[groupIdx];
        addValuePopover.addEventListener("arcgisSmartMappingTypeAddValuePopoverClose", () => {
            setTimeout(() => this.groupMenuNodes[groupIdx].setFocus(), 300);
            addValuePopover === null || addValuePopover === void 0 ? void 0 : addValuePopover.parentElement.removeChild(addValuePopover);
        });
        addValuePopover.addEventListener("arcgisSmartMappingTypeAddValuePopoverNewValue", () => {
            this.updateRendererAndUI();
            this.checkCluster();
            setTimeout(() => this.groupMenuNodes[groupIdx].setFocus(), 300);
            addValuePopover === null || addValuePopover === void 0 ? void 0 : addValuePopover.parentElement.removeChild(addValuePopover);
        });
        document.body.appendChild(addValuePopover);
    }
    handleCheck(groupIdx, classIdx, node) {
        const idx = this.checkedClasses.findIndex((info) => info.groupIdx === groupIdx && info.classIdx === classIdx);
        if (idx > -1) {
            // item is already checked, user clicks again to uncheck
            this.checkedClasses.splice(idx, 1);
            node.icon = "square";
            this.actionsPopoverNode.checkedClasses = this.checkedClasses;
            (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.actionsPopoverNode);
            if (!this.checkedClasses.length) {
                this.removeActionsPopover();
            }
        }
        else {
            this.checkedClasses = [...this.checkedClasses, { groupIdx: groupIdx, classIdx: classIdx }];
            node.icon = "check-square";
            if (this.actionsPopoverNode) {
                this.actionsPopoverNode.checkedClasses = this.checkedClasses;
                (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.actionsPopoverNode);
            }
            else {
                this.addActionsPopover();
            }
        }
    }
    handleDefaultCheckChange() {
        const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        if (renderer.defaultSymbol) {
            renderer.defaultSymbol = undefined;
            renderer.defaultLabel = undefined;
        }
        else {
            const { lastDefault } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
            renderer.defaultSymbol = lastDefault.defaultSymbol;
            renderer.defaultLabel = lastDefault.defaultLabel;
        }
        this.updateRendererAndUI();
    }
    handleDrawingOrderToggle(checked) {
        const { layer: smLayer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const layer = smLayer;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.E)();
        renderer.orderByClassesEnabled = checked;
        if (checked) {
            layer.orderBy = null;
        }
        else {
            layer.orderBy = this.originalOrderBy;
        }
        this.updateRendererAndUI();
    }
    handleGroupMoveUp(groupIdx) {
        this.closePopovers();
        const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        if (groupIdx > 0) {
            const uvRenderer = renderer;
            const groups = uvRenderer.uniqueValueGroups;
            const group = groups.splice(groupIdx, 1)[0];
            groups.splice(groupIdx - 1, 0, group);
            uvRenderer.uniqueValueGroups = groups;
            this.checkedClasses = [];
            this.updateRendererAndUI();
            this.checkCluster();
            // if we do this too early the enter key executes on the focused div
            setTimeout(() => { var _a; return (_a = this.groupMenuNodes[groupIdx - 1]) === null || _a === void 0 ? void 0 : _a.setFocus(); }, 300);
        }
    }
    handleGroupMoveDown(groupIdx) {
        this.closePopovers();
        const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const groups = renderer.uniqueValueGroups;
        if (groupIdx < groups.length - 1) {
            const uvRenderer = renderer;
            const groups = uvRenderer.uniqueValueGroups;
            const group = groups.splice(groupIdx, 1)[0];
            groups.splice(groupIdx + 1, 0, group);
            uvRenderer.uniqueValueGroups = groups;
            this.checkedClasses = [];
            this.updateRendererAndUI();
            this.checkCluster();
            // if we do this too early the enter key executes on the focused div
            setTimeout(() => { var _a; return (_a = this.groupMenuNodes[groupIdx + 1]) === null || _a === void 0 ? void 0 : _a.setFocus(); }, 300);
        }
    }
    handleGroupTextChange(groupIdx, label) {
        var _a;
        const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const groups = renderer.uniqueValueGroups;
        this.groupInputNodes[groupIdx].classList.add("hidden");
        if (!(label === null || label === void 0 ? void 0 : label.length)) {
            if ((_a = renderer.uniqueValueGroups[groupIdx].heading) === null || _a === void 0 ? void 0 : _a.length) {
                label = renderer.uniqueValueGroups[groupIdx].heading;
            }
        }
        groups[groupIdx].heading = label;
        renderer.uniqueValueGroups = groups;
        this.selectedValueText = undefined;
        this.updateRendererAndUI();
        this.groupTextNodes[groupIdx].classList.remove("hidden");
        setTimeout(() => this.groupTextNodes[groupIdx].focus(), 300);
    }
    handleGroupTextClick(groupIdx) {
        this.selectedValueText = `${groupIdx}`;
        this.groupTextNodes[groupIdx].classList.add("hidden");
        this.groupInputNodes[groupIdx].classList.remove("hidden");
        this.groupInputNodes[groupIdx].setFocus();
    }
    handleMoveUpAll(uniqueValueClasses) {
        uniqueValueClasses = uniqueValueClasses.filter((uvClass) => uvClass.values[0].value !== null);
        const { layer, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        this.selectedValue = undefined;
        this.selectedValueText = undefined;
        this.closePopovers();
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const groups = renderer.uniqueValueGroups;
        // don't show more than 200 values total
        let currentLength = 0;
        groups.forEach((uniqueValueGroup) => { var _a, _b; return (currentLength += (_b = (_a = uniqueValueGroup.classes) === null || _a === void 0 ? void 0 : _a.length) !== null && _b !== void 0 ? _b : 0); });
        if (currentLength + uniqueValueClasses.length > 200) {
            // don't add all classes
            uniqueValueClasses.length = 200 - currentLength;
        }
        if (groups.length === 1 && !groups[0].heading) {
            // add to existing group
            groups[0].classes = groups[0].classes.concat(uniqueValueClasses);
        }
        else {
            // add all to a new group
            const newGroup = new modules.UniqueValueGroup({
                heading: (0,_type_0ace5d2e_js__WEBPACK_IMPORTED_MODULE_5__.d)(groups),
                classes: uniqueValueClasses
            });
            groups.push(newGroup);
        }
        renderer.uniqueValueGroups = groups;
        this.updateRendererAndUI();
        this.checkCluster();
    }
    handleSelectAllValues(groupIdx) {
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.E)();
        const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const uvRenderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const groups = uvRenderer.uniqueValueGroups;
        groups[groupIdx].classes.forEach((_, idx) => {
            if (!this.checkedClasses.find((info) => info.groupIdx === groupIdx && info.classIdx === idx)) {
                this.checkedClasses.push({ groupIdx, classIdx: idx });
            }
        });
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
        if (this.actionsPopoverNode) {
            this.actionsPopoverNode.checkedClasses = this.checkedClasses;
            (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.actionsPopoverNode);
        }
        else {
            this.addActionsPopover();
        }
    }
    handleSeparateValues(groupIdx) {
        this.closePopovers();
        this.separateGroupValues(groupIdx);
        this.updateRendererAndUI();
        this.checkCluster();
    }
    handleSortClasses(groupIdx) {
        var _a;
        const groupIdxClassIds = ((_a = this.classSortable) === null || _a === void 0 ? void 0 : _a[groupIdx].toArray()) || [];
        const { layer, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        this.closePopovers();
        const beforeOtherValuesLength = (0,_type_0ace5d2e_js__WEBPACK_IMPORTED_MODULE_5__.b)().length;
        let beforeLength = 0;
        renderer.uniqueValueGroups.forEach((uniqueValueGroup) => { var _a, _b; return (beforeLength += (_b = (_a = uniqueValueGroup.classes) === null || _a === void 0 ? void 0 : _a.length) !== null && _b !== void 0 ? _b : 0); });
        const uvRenderer = renderer;
        const oldGroups = uvRenderer.clone().uniqueValueGroups;
        const newGroups = [];
        oldGroups.forEach((group, idx) => {
            if (idx === groupIdx) {
                const newGroup = new modules.UniqueValueGroup({ heading: group.heading, classes: [] });
                groupIdxClassIds.forEach((groupIdxClassIds) => {
                    const [groupIdx, classIdx] = groupIdxClassIds
                        .split("/")
                        .map((value) => parseInt(value));
                    newGroup.classes.push(oldGroups[groupIdx].classes[classIdx]);
                });
                newGroups.push(newGroup);
            }
            else {
                newGroups.push(oldGroups[idx]);
            }
        });
        // remove groups with no classes
        renderer.uniqueValueGroups = newGroups.filter((group) => !!group.classes.length);
        const afterOtherValuesLength = (0,_type_0ace5d2e_js__WEBPACK_IMPORTED_MODULE_5__.b)().length;
        this.selectedValue = undefined;
        this.selectedValueText = undefined;
        this.checkedClasses = [];
        if (beforeOtherValuesLength === afterOtherValuesLength) {
            // update dragRenderToggle flag to force rerender if a newly created value was dragged into the 'Other' group
            this.dragRenderToggle = !this.dragRenderToggle;
        }
        setTimeout(() => this.updateRendererAndUI(), 300);
        this.checkCluster();
        let afterLength = 0;
        renderer.uniqueValueGroups.forEach((uniqueValueGroup) => { var _a, _b; return (afterLength += (_b = (_a = uniqueValueGroup.classes) === null || _a === void 0 ? void 0 : _a.length) !== null && _b !== void 0 ? _b : 0); });
        beforeLength !== afterLength ? this.checkCluster() : null;
    }
    handleSortGroups() {
        const groupIdxs = this.groupSortable ? this.groupSortable.toArray() : [];
        const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        this.closePopovers();
        const oldGroups = renderer.uniqueValueGroups;
        const newGroups = [];
        groupIdxs.forEach((groupIdx) => {
            newGroups.push(oldGroups[parseInt(groupIdx)]);
        });
        renderer.uniqueValueGroups = newGroups;
        this.selectedValue = undefined;
        this.selectedValueText = undefined;
        this.checkedClasses = [];
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
    }
    handleValueSymbolClick(groupIdx, classIdx) {
        this.symbolNodes[groupIdx][classIdx].classList.remove("symbol-selector--selected");
        if (this.symbolStylerOpen) {
            this.selectedValue = undefined;
            this.selectedValueText = undefined;
            (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.E)();
            this.symbolStylerOpen = false;
        }
        else {
            const selectedValue = `${groupIdx}/${classIdx}`;
            this.selectedValue = this.selectedValue !== selectedValue ? selectedValue : undefined;
            this.selectedValueText = undefined;
            if ((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.ac)(this.selectedValue)) {
                this.openSymbolStylerForValue(groupIdx, classIdx);
            }
            else {
                this.symbolNodes[groupIdx][classIdx].classList.remove("symbol-selector--selected");
                (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.E)();
                this.symbolStylerOpen = false;
            }
        }
    }
    handleValueTextChange(groupIdx, classIdx, label) {
        var _a;
        const { allUniqueValues, lastDefault, layer: smLayer, modules, strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const layer = smLayer;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const groups = renderer.uniqueValueGroups;
        this.valueInputNodes[groupIdx][classIdx].classList.add("hidden");
        // only update if new value is different
        if (((_a = groups[groupIdx]) === null || _a === void 0 ? void 0 : _a.classes[classIdx].label) !== label) {
            // if user cleared out label entirely, set back to default
            if (!(label === null || label === void 0 ? void 0 : label.length)) {
                if (groupIdx === -1) {
                    label = this.originalRendererJSON.defaultLabel || strings.panels.type.other;
                }
                else {
                    let matchingInfo = allUniqueValues.find((value) => value.value === renderer.uniqueValueGroups[groupIdx].classes[classIdx].values[0].value);
                    label =
                        (matchingInfo === null || matchingInfo === void 0 ? void 0 : matchingInfo.label) || renderer.uniqueValueGroups[groupIdx].classes[classIdx].label;
                }
            }
            if (groupIdx === -1 && !renderer.defaultSymbol) {
                lastDefault.defaultLabel = label;
            }
            if (groupIdx === -1) {
                if (renderer.defaultSymbol) {
                    renderer.defaultLabel = label || lastDefault.defaultLabel;
                }
            }
            else {
                const groups = renderer.uniqueValueGroups;
                const field = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.u)(renderer.field);
                if (label) {
                    groups[groupIdx].classes[classIdx].label = label;
                }
                else {
                    // re-create default label
                    const defaultLabels = groups[groupIdx].classes[classIdx].values.map((uniqueValue) => {
                        var _a;
                        const value = uniqueValue.value;
                        const defaultLabel = (_a = allUniqueValues === null || allUniqueValues === void 0 ? void 0 : allUniqueValues.find((uv) => uv.value === value)) === null || _a === void 0 ? void 0 : _a.label;
                        if (defaultLabel) {
                            return defaultLabel;
                        }
                        else if ((field === null || field === void 0 ? void 0 : field.simpleFieldType) === _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.w.DATE ||
                            (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.z)(field === null || field === void 0 ? void 0 : field.layerField) === "date-only") {
                            return (0,_type_0ace5d2e_js__WEBPACK_IMPORTED_MODULE_5__.e)(value, field);
                        }
                        else if ((field === null || field === void 0 ? void 0 : field.simpleFieldType) === _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.w.NUMBER) {
                            return modules.intl.formatNumber(value);
                        }
                        else {
                            // string
                            return value;
                        }
                    });
                    groups[groupIdx].classes[classIdx].label = defaultLabels.join(", ");
                }
                renderer.uniqueValueGroups = groups;
            }
        }
        this.selectedValueText = undefined;
        this.updateRendererAndUI();
        setTimeout(() => {
            const textNode = groupIdx === -1 && classIdx === -1
                ? this.otherTextNode
                : this.valueTextNodes[groupIdx][classIdx];
            textNode.classList.remove("hidden");
            textNode.focus(), 300;
        });
    }
    handleValueTextClick(groupIdx, classIdx) {
        var _a, _b;
        this.selectedValueText = `${groupIdx}/${classIdx}`;
        const textNode = groupIdx === -1 && classIdx === -1
            ? this.otherTextNode
            : this.valueTextNodes[groupIdx][classIdx];
        textNode.classList.add("hidden");
        (_a = this.valueInputNodes[groupIdx][classIdx]) === null || _a === void 0 ? void 0 : _a.classList.remove("hidden");
        (_b = this.valueInputNodes[groupIdx][classIdx]) === null || _b === void 0 ? void 0 : _b.setFocus();
    }
    onMouseOver(id, referenceNode, label) {
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.ae)();
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.aF)(referenceNode, label, id);
    }
    onMouseOut(id) {
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.aG)(id);
    }
    openSymbolStylerForGroup(groupIdx) {
        const { strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.E)();
        const popoverNode = (0,_symbolStyler_04635b2b_js__WEBPACK_IMPORTED_MODULE_4__.c)({
            referenceElement: this.flowItemNode,
            heading: strings.panels.type.symbolStyle
        });
        popoverNode.addEventListener("arcgisSmartMappingStylerPopoverClose", () => {
            (0,_symbolStyler_04635b2b_js__WEBPACK_IMPORTED_MODULE_4__.r)(popoverNode);
            this.selectedValue = undefined;
            this.selectedValueText = undefined;
            // if we do this too early the enter key executes on the focused div
            setTimeout(() => { var _a; return (_a = this.groupMenuNodes[groupIdx]) === null || _a === void 0 ? void 0 : _a.setFocus(); }, 300);
        });
        popoverNode.addEventListener("arcgisSmartMappingStylerPopoverDisconnected", () => {
            this.selectedValue = undefined;
            this.selectedValueText = undefined;
            (0,_symbolStyler_04635b2b_js__WEBPACK_IMPORTED_MODULE_4__.r)(popoverNode);
            // if we do this too early the enter key executes on the focused div
            setTimeout(() => { var _a; return (_a = this.groupMenuNodes[groupIdx]) === null || _a === void 0 ? void 0 : _a.setFocus(); }, 300);
        });
        (0,_symbolStyler_04635b2b_js__WEBPACK_IMPORTED_MODULE_4__.e)({
            groupIdx,
            popoverNode,
            onChange: () => {
                this.updateRendererAndUI();
            }
        });
    }
    openSymbolStylerForValue(groupIdx, classIdx) {
        const { strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.E)();
        const popoverNode = (0,_symbolStyler_04635b2b_js__WEBPACK_IMPORTED_MODULE_4__.c)({
            referenceElement: this.flowItemNode,
            heading: strings.panels.type.symbolStyle
        });
        popoverNode.addEventListener("arcgisSmartMappingStylerPopoverClose", () => {
            let symbolNode = this.symbolNodes[groupIdx][classIdx];
            this.selectedValue = undefined;
            this.selectedValueText = undefined;
            (0,_symbolStyler_04635b2b_js__WEBPACK_IMPORTED_MODULE_4__.r)(popoverNode);
            // if we do this too early the enter key executes on the focused div
            setTimeout(() => {
                symbolNode.classList.remove("symbol-selector--selected");
                this.symbolStylerOpen = false;
                symbolNode.focus();
            }, 300);
        });
        popoverNode.addEventListener("arcgisSmartMappingStylerPopoverDisconnected", () => {
            let symbolNode = this.symbolNodes[groupIdx][classIdx];
            this.selectedValue = undefined;
            this.selectedValueText = undefined;
            (0,_symbolStyler_04635b2b_js__WEBPACK_IMPORTED_MODULE_4__.r)(popoverNode);
            // if we do this too early the enter key executes on the focused div
            setTimeout(() => {
                symbolNode.classList.remove("symbol-selector--selected");
                this.symbolStylerOpen = false;
                symbolNode.focus();
            }, 300);
        });
        (0,_symbolStyler_04635b2b_js__WEBPACK_IMPORTED_MODULE_4__.f)({
            selectedValue: this.selectedValue,
            popoverNode,
            onChange: () => {
                this.updateRendererAndUI();
                this.rotationNode && (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.rotationNode);
            }
        });
        this.symbolStylerOpen = true;
        this.symbolNodes[groupIdx][classIdx].classList.add("symbol-selector--selected");
    }
    removeActionsPopover() {
        var _a, _b;
        (_b = (_a = this.actionsPopoverNode) === null || _a === void 0 ? void 0 : _a.parentElement) === null || _b === void 0 ? void 0 : _b.removeChild(this.actionsPopoverNode);
        this.actionsPopoverNode = null;
    }
    separateGroupValues(groupIdx) {
        const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const groups = renderer.uniqueValueGroups;
        (0,_type_0ace5d2e_js__WEBPACK_IMPORTED_MODULE_5__.f)(groups[groupIdx]);
        this.checkedClasses = [];
    }
    updateRendererAndUI() {
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.ab)();
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
    }
    get hostElement() { return (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisSmartMappingPanelsType.style = arcgisSmartMappingPanelsTypeCss;

const ArcgisSmartMappingTypeActionsPopover = class {
    constructor(hostRef) {
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
        this.arcgisSmartMappingTypeActionsPopoverChange = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisSmartMappingTypeActionsPopoverChange", 7);
        this.arcgisSmartMappingTypeActionsPopoverFocusExit = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisSmartMappingTypeActionsPopoverFocusExit", 7);
        this.checkedClasses = undefined;
        this.groupMenuNodes = undefined;
        this.referenceNode = undefined;
        this.showMoveToGroup = false;
    }
    //--------------------------------------------------------------------------
    //
    //  Lifecycle
    //
    //--------------------------------------------------------------------------
    componentWillLoad() {
        this.topActionHandler = (event) => {
            // send focus back to the panel
            if (event.shiftKey && event.key === "Tab") {
                this.arcgisSmartMappingTypeActionsPopoverFocusExit.emit("top");
            }
        };
    }
    componentDidRender() {
        var _a, _b;
        const topAction = (!((_a = this.moveUpNode) === null || _a === void 0 ? void 0 : _a.disabled) ? this.moveUpNode : undefined) ||
            (!((_b = this.moveDownNode) === null || _b === void 0 ? void 0 : _b.disabled) ? this.moveDownNode : undefined) ||
            this.mergeNode ||
            this.separateNode ||
            this.moveToGroupNode;
        topAction === null || topAction === void 0 ? void 0 : topAction.removeEventListener("keydown", this.topActionHandler);
        topAction.addEventListener("keydown", this.topActionHandler);
    }
    //--------------------------------------------------------------------------
    //
    //  Public methods
    //
    //--------------------------------------------------------------------------
    async focusActionPad() {
        var _a;
        (_a = this.actionPadNode) === null || _a === void 0 ? void 0 : _a.setFocus();
    }
    async focusLastAction() {
        if (this.actionPadNode) {
            let actionNodes = Array.from(this.actionPadNode.querySelectorAll("calcite-action"));
            let enabledActionNodes = actionNodes.filter((node) => node.disabled === false);
            enabledActionNodes[enabledActionNodes.length - 1].setFocus();
        }
    }
    //--------------------------------------------------------------------------
    //
    //  Render Methods
    //
    //--------------------------------------------------------------------------
    render() {
        var _a, _b;
        const { strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        if (!((_a = this.checkedClasses) === null || _a === void 0 ? void 0 : _a.length)) {
            return null;
        }
        const rect = (_b = this.referenceNode) === null || _b === void 0 ? void 0 : _b.getBoundingClientRect();
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.H, null, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-popover", { class: "js-app-flyout", placement: "leading-start", offsetDistance: 10, offsetSkidding: (rect.height - 120) / 4 + 70, pointerDisabled: true, label: strings.panels.type.typeActions, triggerDisabled: true, referenceElement: this.referenceNode, open: true, ref: (node) => (this.popoverNode = node) }, this.showMoveToGroup ? this.renderMoveToGroup() : this.renderActions())));
    }
    renderActions() {
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action-pad", { layout: "vertical", position: "start", expanded: true, expandDisabled: true, ref: (node) => {
                if (node) {
                    this.actionPadNode = node;
                }
            } }, this.renderGroup1(), this.renderGroup2(), this.renderGroup3()));
    }
    renderMoveToGroup() {
        if (!this.showMoveToGroup) {
            return null;
        }
        const { layer, strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const groups = renderer.uniqueValueGroups;
        const multipleGroups = !!this.checkedClasses.find((checkedClass) => checkedClass.groupIdx !== this.checkedClasses[0].groupIdx);
        const disableGroupIdx = !multipleGroups && this.checkedClasses[0].groupIdx;
        const listItems = groups.map((group, idx) => {
            return this.renderMoveToGroupListItem(group, idx);
        });
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-panel", { heading: strings.panels.type.moveToGroup, closable: true, onCalcitePanelClose: () => {
                this.showMoveToGroup = false;
                (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
                setTimeout(() => this.moveToGroupNode.setFocus(), 300);
            }, ref: (node) => node === null || node === void 0 ? void 0 : node.setFocus() }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-list", { filterEnabled: groups.length >= 10, filterPlaceholder: strings.panels.type.searchGroups, label: strings.panels.type.selectGroup, selectionMode: "single" }, listItems, !renderer.uniqueValueGroups.length && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-list-item", { label: strings.panels.type.untitledGroup, onCalciteListItemSelect: () => this.moveToNewGroup(true) })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-list-item", { label: renderer.defaultLabel || strings.panels.type.other, value: -1, disabled: disableGroupIdx === -1, onCalciteListItemSelect: () => {
                this.checkedClasses.sort((a, b) => b.groupIdx - a.groupIdx === 0 ? b.classIdx - a.classIdx : b.groupIdx - a.groupIdx);
                this.checkedClasses.forEach((checkedClass) => {
                    if (checkedClass.groupIdx !== -1) {
                        groups[checkedClass.groupIdx].classes.splice(checkedClass.classIdx, 1);
                        if (!groups[checkedClass.groupIdx].classes.length) {
                            groups.splice(checkedClass.groupIdx, 1);
                        }
                    }
                });
                this.checkedClasses = [];
                renderer.uniqueValueGroups = groups;
                (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.ab)();
                this.popoverNode.open = false;
                this.arcgisSmartMappingTypeActionsPopoverChange.emit({
                    checkedClasses: this.checkedClasses
                });
                // if we do this too early the enter key executes on the focused div
                setTimeout(() => { var _a; return (_a = this.groupMenuNodes[-1]) === null || _a === void 0 ? void 0 : _a.setFocus(); }, 300);
            } })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "outline", label: strings.cancel, innerHTML: strings.cancel, width: "full", slot: "footer", onClick: () => {
                this.showMoveToGroup = false;
                (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
                setTimeout(() => this.moveToGroupNode.setFocus(), 300);
            } })));
    }
    renderMoveToGroupListItem(group, idx) {
        const { layer, strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const groups = renderer.uniqueValueGroups;
        const multipleGroups = !!this.checkedClasses.find((checkedClass) => checkedClass.groupIdx !== this.checkedClasses[0].groupIdx);
        const disableGroupIdx = !multipleGroups && this.checkedClasses[0].groupIdx;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-list-item", { label: group.heading || strings.panels.type.untitledGroup, value: idx, disabled: disableGroupIdx === idx, onCalciteListItemSelect: (event) => {
                const node = event.target;
                const idx = node.value;
                let uniqueValueClasses = this.checkedClasses
                    .filter((checkedClass) => checkedClass.groupIdx !== -1)
                    .map((checkedClass) => groups[checkedClass.groupIdx].classes[checkedClass.classIdx]);
                const otherUniqueValueClasses = (0,_type_0ace5d2e_js__WEBPACK_IMPORTED_MODULE_5__.b)();
                uniqueValueClasses = uniqueValueClasses.concat(this.checkedClasses
                    .filter((checkedClass) => checkedClass.groupIdx === -1)
                    .map((checkedClass) => otherUniqueValueClasses[checkedClass.classIdx]));
                const group = groups[idx];
                group.classes = group.classes.concat(uniqueValueClasses);
                // remove from old position
                this.checkedClasses.sort((a, b) => b.groupIdx - a.groupIdx === 0 ? b.classIdx - a.classIdx : b.groupIdx - a.groupIdx);
                this.checkedClasses.forEach((checkedClass) => {
                    if (checkedClass.groupIdx !== -1) {
                        groups[checkedClass.groupIdx].classes.splice(checkedClass.classIdx, 1);
                        if (!groups[checkedClass.groupIdx].classes.length) {
                            groups.splice(checkedClass.groupIdx, 1);
                        }
                    }
                });
                this.checkedClasses = [];
                renderer.uniqueValueGroups = groups;
                (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.ab)();
                this.popoverNode.open = false;
                this.arcgisSmartMappingTypeActionsPopoverChange.emit({
                    checkedClasses: this.checkedClasses
                });
                // if we do this too early the enter key executes on the focused div
                setTimeout(() => { var _a; return (_a = this.groupMenuNodes[idx]) === null || _a === void 0 ? void 0 : _a.setFocus(); }, 300);
            } }));
    }
    renderGroup1() {
        var _a;
        const { layer, strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const groups = renderer.uniqueValueGroups;
        const classIdxs = this.checkedClasses.map((checkedClass) => checkedClass.classIdx);
        const len = classIdxs.length;
        const grpClsLen = (_a = groups[this.checkedClasses[0].groupIdx]) === null || _a === void 0 ? void 0 : _a.classes.length;
        classIdxs.sort((a, b) => a - b);
        const canMoveUp = classIdxs[0] > 0 ||
            !!classIdxs.find((classIdx, idx) => idx > 0 && classIdx - 1 > classIdxs[idx - 1]);
        const canMoveDown = classIdxs[len - 1] < grpClsLen - 1 ||
            !!classIdxs.find((classIdx, idx) => idx < len - 1 && classIdx + 1 < classIdxs[idx + 1]);
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action-group", null, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: strings.panels.type.moveUp, textEnabled: true, disabled: !canMoveUp, icon: "arrow-bold-up", onClick: () => this.moveUp(), ref: (node) => (this.moveUpNode = node) }), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: strings.panels.type.moveDown, textEnabled: true, disabled: !canMoveDown, icon: "arrow-bold-down", onClick: () => this.moveDown(), ref: (node) => (this.moveDownNode = node) })));
    }
    renderGroup2() {
        const { layer, strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const groups = renderer.uniqueValueGroups;
        const multipleGroups = !!this.checkedClasses.find((checkedClass) => checkedClass.groupIdx !== this.checkedClasses[0].groupIdx);
        const canMerge = !!this.checkedClasses.find((info) => info.groupIdx !== -1) &&
            this.checkedClasses.length > 1;
        const canSeparate = !!this.checkedClasses.find((info) => info.groupIdx !== -1 && groups[info.groupIdx].classes[info.classIdx].values.length > 1);
        const disabled = !multipleGroups &&
            this.checkedClasses[0].groupIdx !== -1 &&
            this.checkedClasses.length === groups[this.checkedClasses[0].groupIdx].classes.length;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action-group", null, canMerge && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: strings.panels.type.mergeValues, textEnabled: true, onClick: () => this.mergeValues(), ref: (node) => (this.mergeNode = node) })), canSeparate && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: strings.panels.type.separateValues, textEnabled: true, onClick: () => this.separateSelectedValues(), ref: (node) => (this.separateNode = node) })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: strings.panels.type.moveToGroup, textEnabled: true, onClick: () => this.moveToGroup(), ref: (node) => {
                if (node) {
                    this.moveToGroupNode = node;
                }
            } }), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: strings.panels.type.newGroup, textEnabled: true, disabled: disabled, onClick: () => this.moveToNewGroup(), ref: (node) => (this.moveToNewGroupNode = node) })));
    }
    renderGroup3() {
        const { strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action-group", null, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: strings.panels.type.clearSelection, textEnabled: true, onClick: () => this.clearSelection(), onKeyDown: (event) => {
                if (!event.shiftKey && event.key === "Tab") {
                    this.arcgisSmartMappingTypeActionsPopoverFocusExit.emit("bottom");
                }
            } })));
    }
    //--------------------------------------------------------------------------
    //
    //  Private Methods
    //
    //--------------------------------------------------------------------------
    clearSelection() {
        let minGroup = -1;
        this.checkedClasses.forEach((checkedClass) => (minGroup =
            checkedClass.groupIdx === -1
                ? minGroup
                : minGroup === -1
                    ? checkedClass.groupIdx
                    : Math.min(minGroup, checkedClass.groupIdx)));
        this.checkedClasses = [];
        this.popoverNode.open = false;
        this.arcgisSmartMappingTypeActionsPopoverChange.emit({ checkedClasses: this.checkedClasses });
        // if we do this too early the enter key executes on the focused div
        setTimeout(() => { var _a; return (_a = this.groupMenuNodes[minGroup]) === null || _a === void 0 ? void 0 : _a.setFocus(); }, 300);
    }
    mergeValues() {
        const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const groups = renderer.uniqueValueGroups;
        this.checkedClasses.sort((a, b) => a.groupIdx - b.groupIdx === 0
            ? a.classIdx - b.classIdx
            : a.groupIdx === -1 || b.groupIdx === -1
                ? b.groupIdx - a.groupIdx
                : a.groupIdx - b.groupIdx);
        const mergedClass = groups[this.checkedClasses[0].groupIdx].classes[this.checkedClasses[0].classIdx];
        const otherUniqueValueClasses = (0,_type_0ace5d2e_js__WEBPACK_IMPORTED_MODULE_5__.b)();
        this.checkedClasses.forEach((info, idx) => {
            // merge all values to this.checkedClasses[0]
            if (idx > 0) {
                const uvClass = info.groupIdx === -1
                    ? otherUniqueValueClasses[info.classIdx]
                    : groups[info.groupIdx].classes[info.classIdx];
                mergedClass.values = mergedClass.values.concat(uvClass.values);
                mergedClass.label += `, ${uvClass.label}`;
            }
        });
        const newGroups = [];
        groups.forEach((group, groupIdx) => {
            const newClasses = [];
            group.classes.forEach((uvClass, classIdx) => {
                if (this.checkedClasses[0].groupIdx === groupIdx &&
                    this.checkedClasses[0].classIdx === classIdx) {
                    // replace with the merged class
                    newClasses.push(mergedClass);
                }
                else if (!this.checkedClasses.find((info) => info.groupIdx === groupIdx && info.classIdx === classIdx)) {
                    // keep as is
                    newClasses.push(uvClass);
                } // else remove
            });
            if (newClasses.length) {
                group.classes = newClasses;
                newGroups.push(group);
            }
        });
        renderer.uniqueValueGroups = newGroups;
        this.checkedClasses = [];
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.ab)();
        this.popoverNode.open = false;
        this.arcgisSmartMappingTypeActionsPopoverChange.emit({ checkedClasses: this.checkedClasses });
    }
    moveDown() {
        const { layer, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const uvRenderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const groups = uvRenderer.uniqueValueGroups;
        const group = groups[this.checkedClasses[0].groupIdx];
        this.checkedClasses.sort((a, b) => b.groupIdx - a.groupIdx === 0 ? b.classIdx - a.classIdx : b.groupIdx - a.groupIdx);
        const newCheckedClasses = modules.esriLang.clone(this.checkedClasses);
        this.checkedClasses.forEach((checkedClass, idx) => {
            if (checkedClass.classIdx < group.classes.length - 1 &&
                (idx === 0 ||
                    (idx > 0 && newCheckedClasses[idx - 1].classIdx !== checkedClass.classIdx + 1))) {
                const uniqueClass = group.classes.splice(checkedClass.classIdx, 1)[0];
                group.classes.splice(checkedClass.classIdx + 1, 0, uniqueClass);
                newCheckedClasses[idx].classIdx = checkedClass.classIdx + 1;
            }
        });
        this.checkedClasses = newCheckedClasses;
        uvRenderer.uniqueValueGroups = groups;
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.ab)();
        this.arcgisSmartMappingTypeActionsPopoverChange.emit({ checkedClasses: this.checkedClasses });
        setTimeout(() => {
            this.moveDownNode.disabled ? this.moveUpNode.setFocus() : this.moveDownNode.setFocus();
        }, 300);
    }
    moveToGroup() {
        this.showMoveToGroup = true;
    }
    moveToNewGroup(untitled = false) {
        const { layer, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const groups = renderer.uniqueValueGroups;
        let uniqueValueClasses = this.checkedClasses
            .filter((checkedClass) => checkedClass.groupIdx !== -1)
            .map((checkedClass) => groups[checkedClass.groupIdx].classes[checkedClass.classIdx]);
        const otherUniqueValueClasses = (0,_type_0ace5d2e_js__WEBPACK_IMPORTED_MODULE_5__.b)();
        uniqueValueClasses = uniqueValueClasses.concat(this.checkedClasses
            .filter((checkedClass) => checkedClass.groupIdx === -1)
            .map((checkedClass) => otherUniqueValueClasses[checkedClass.classIdx]));
        const newGroup = new modules.UniqueValueGroup({
            heading: untitled ? null : (0,_type_0ace5d2e_js__WEBPACK_IMPORTED_MODULE_5__.d)(groups),
            classes: uniqueValueClasses
        });
        groups.push(newGroup);
        this.checkedClasses.sort((a, b) => b.groupIdx - a.groupIdx === 0 ? b.classIdx - a.classIdx : b.groupIdx - a.groupIdx);
        this.checkedClasses.forEach((checkedClass) => {
            if (checkedClass.groupIdx !== -1) {
                groups[checkedClass.groupIdx].classes.splice(checkedClass.classIdx, 1);
                if (!groups[checkedClass.groupIdx].classes.length) {
                    groups.splice(checkedClass.groupIdx, 1);
                }
            }
        });
        this.checkedClasses = [];
        renderer.uniqueValueGroups = groups;
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.ab)();
        this.popoverNode.open = false;
        this.arcgisSmartMappingTypeActionsPopoverChange.emit({ checkedClasses: this.checkedClasses });
        // if we do this too early the enter key executes on the focused div
        setTimeout(() => { var _a; return (_a = this.groupMenuNodes[groups.length - 1]) === null || _a === void 0 ? void 0 : _a.setFocus(); }, 300);
    }
    moveUp() {
        const { layer, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const uvRenderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const groups = uvRenderer.uniqueValueGroups;
        const group = groups[this.checkedClasses[0].groupIdx];
        this.checkedClasses.sort((a, b) => a.groupIdx - b.groupIdx === 0 ? a.classIdx - b.classIdx : a.groupIdx - b.groupIdx);
        const newCheckedClasses = modules.esriLang.clone(this.checkedClasses);
        this.checkedClasses.forEach((checkedClass, idx) => {
            if (checkedClass.classIdx > 0 &&
                (idx === 0 ||
                    (idx > 0 && newCheckedClasses[idx - 1].classIdx !== checkedClass.classIdx - 1))) {
                const uniqueClass = group.classes.splice(checkedClass.classIdx, 1)[0];
                group.classes.splice(checkedClass.classIdx - 1, 0, uniqueClass);
                newCheckedClasses[idx].classIdx = checkedClass.classIdx - 1;
            }
        });
        this.checkedClasses = newCheckedClasses;
        uvRenderer.uniqueValueGroups = groups;
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.ab)();
        this.arcgisSmartMappingTypeActionsPopoverChange.emit({ checkedClasses: this.checkedClasses });
        setTimeout(() => {
            this.moveUpNode.disabled ? this.moveDownNode.setFocus() : this.moveUpNode.setFocus();
        }, 300);
    }
    separateSelectedValues() {
        const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const groups = renderer.uniqueValueGroups;
        this.checkedClasses.sort((a, b) => a.groupIdx - b.groupIdx === 0 ? a.classIdx - b.classIdx : a.groupIdx - b.groupIdx);
        const groupInfos = [];
        let lastGroupIdx = -2;
        let classIdxs = [];
        this.checkedClasses.forEach((info) => {
            if (info.groupIdx !== -1) {
                if (lastGroupIdx !== info.groupIdx) {
                    if (lastGroupIdx !== -2) {
                        groupInfos.push({ groupIdx: lastGroupIdx, classIdxs });
                    }
                    lastGroupIdx = info.groupIdx;
                    classIdxs = [info.classIdx];
                }
                else {
                    classIdxs.push(info.classIdx);
                }
            }
        });
        if (lastGroupIdx !== -2) {
            groupInfos.push({ groupIdx: lastGroupIdx, classIdxs });
        }
        groupInfos.forEach((info) => (0,_type_0ace5d2e_js__WEBPACK_IMPORTED_MODULE_5__.f)(groups[info.groupIdx], info.classIdxs));
        this.checkedClasses = [];
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.ab)();
        this.popoverNode.open = false;
        this.arcgisSmartMappingTypeActionsPopoverChange.emit({ checkedClasses: this.checkedClasses });
    }
    get hostElement() { return (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};

const ArcgisSmartMappingTypeAddValue = class {
    constructor(hostRef) {
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
        this.arcgisSmartMappingTypeAddValuePopoverClose = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisSmartMappingTypeAddValuePopoverClose", 7);
        this.arcgisSmartMappingTypeAddValuePopoverNewValue = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisSmartMappingTypeAddValuePopoverNewValue", 7);
        this.userTouchedLabel = false;
        this.flowItemNode = undefined;
        this.referenceNode = undefined;
        this.groupIdx = undefined;
    }
    //--------------------------------------------------------------------------
    //
    //  Lifecycle
    //
    //--------------------------------------------------------------------------
    componentWillLoad() {
        var _a, _b;
        const { allUniqueValues, layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        // gather all unique values of layer
        this.allValues = allUniqueValues === null || allUniqueValues === void 0 ? void 0 : allUniqueValues.map((uniqueValueInfo) => "" + uniqueValueInfo.value);
        // add the custom added values to the list
        renderer.uniqueValueGroups.forEach((uniqueValueGroup) => {
            uniqueValueGroup.classes.forEach((uniqueValueClass) => {
                var _a;
                const value = (_a = uniqueValueClass.values) === null || _a === void 0 ? void 0 : _a[0].value;
                if (this.allValues.indexOf("" + value) === -1) {
                    this.allValues.push("" + value);
                }
            });
        });
        this.field = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.u)(renderer.field);
        this.isDate = ((_a = this.field) === null || _a === void 0 ? void 0 : _a.simpleFieldType) === _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.w.DATE;
        this.isNumber = ((_b = this.field) === null || _b === void 0 ? void 0 : _b.simpleFieldType) === _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.w.NUMBER;
        this.isInt =
            this.field &&
                ["small-integer", "integer", "long"].indexOf((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.z)(this.field.layerField)) > -1;
    }
    componentDidLoad() {
        var _a;
        (_a = this.panelNode) === null || _a === void 0 ? void 0 : _a.setFocus();
    }
    //--------------------------------------------------------------------------
    //
    //  Render Methods
    //
    //--------------------------------------------------------------------------
    render() {
        const { strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.H, null, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-popover", { referenceElement: this.referenceNode, placement: "bottom-end", offsetDistance: 0, offsetSkidding: 0, label: strings.panels.type.addValue, open: true, ref: (node) => (this.popoverNode = node) }, this.renderContent())));
    }
    renderContent() {
        var _a;
        const { strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const nodeWidth = (_a = this.flowItemNode) === null || _a === void 0 ? void 0 : _a.getBoundingClientRect().width;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-panel", { heading: strings.panels.type.addValue, closable: true, onCalcitePanelClose: () => this.arcgisSmartMappingTypeAddValuePopoverClose.emit(), ref: (node) => (this.panelNode = node) }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { ref: (node) => {
                if (node) {
                    node.style.padding = "15px";
                    node.style.width = `${nodeWidth ? nodeWidth + 20 : 280}px`;
                }
            } }, this.renderValueInput(), this.renderLabelInput()), this.renderDoneButton()));
    }
    renderValueInput() {
        const { strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const { isDate, isInt, isNumber } = this;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { scale: "s" }, strings.panels.type.value, 
        // date
        isDate ? ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input-date-picker", { scale: "s", overlayPositioning: "fixed", onCalciteInputDatePickerChange: (event) => {
                const node = event.target;
                this.handleAddDate(node.value);
            } })) : // number
            isNumber ? ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input-number", { step: isInt ? 1 : "any", scale: "s", label: strings.panels.type.value, placeholder: strings.panels.type.storedValue, onCalciteInputNumberInput: (event) => {
                    const node = event.target;
                    this.handleAddNumber(node.value);
                } })) : (
            // string
            (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { scale: "s", label: strings.panels.type.value, placeholder: strings.panels.type.storedValue, onCalciteInputInput: () => this.handleAddString(this.valueInputNode.value), ref: (node) => {
                    if (node) {
                        this.valueInputNode = node;
                    }
                } })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input-message", { hidden: true, icon: "exclamation-mark-triangle", status: "invalid", ref: (node) => (this.valueInputMessageNode = node) }, strings.panels.type.valueNotUnique)));
    }
    renderLabelInput() {
        const { strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { scale: "s" }, strings.panels.type.label, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { type: "text", value: "", scale: "s", placeholder: strings.panels.type.displayedValue, label: strings.panels.type.label, onCalciteInputInput: () => {
                this.userTouchedLabel = true;
            }, ref: (node) => (this.labelInputNode = node) })));
    }
    renderDoneButton() {
        const { locale, mapView, modules, strings } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const { field, isDate, isInt, isNumber } = this;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "solid", label: strings.done, width: "full", slot: "footer", disabled: true, onClick: () => {
                this.popoverNode.open = false;
                const value = this.valueInputNode.value;
                let newLabel;
                let newValue;
                if (isDate) {
                    // value for date returns a string like this 2022-08-01, which is UTC time
                    // the date value must be UTC, but the label must be local time
                    newValue = (0,_date_79c7d93c_js__WEBPACK_IMPORTED_MODULE_8__.d)(value, mapView.timeZone);
                    modules.intl.setLocale(locale);
                    newLabel = this.labelInputNode.value || (0,_type_0ace5d2e_js__WEBPACK_IMPORTED_MODULE_5__.e)(newValue, field);
                }
                else if (isNumber) {
                    newValue = isInt ? parseInt(value) : parseFloat(value);
                    newLabel = this.labelInputNode.value || modules.intl.formatNumber(newValue);
                }
                else {
                    // string
                    newLabel = this.labelInputNode.value || value;
                    newValue = value;
                }
                this.addValue(newLabel, newValue);
            }, ref: (node) => (this.doneButtonNode = node) }, strings.done));
    }
    //--------------------------------------------------------------------------
    //
    //  Private Methods
    //
    //--------------------------------------------------------------------------
    addValue(label, value) {
        var _a;
        const { layer, mapView, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        const symbol = modules.esriLang.clone(((_a = renderer.uniqueValueInfos.find((uniqueValueInfo) => {
            var _a;
            return ["simple-marker", "simple-line", "simple-fill", "cim"].indexOf((_a = uniqueValueInfo.symbol) === null || _a === void 0 ? void 0 : _a.type) > -1;
        })) === null || _a === void 0 ? void 0 : _a.symbol) || (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.S)(layer, mapView, (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.g)()));
        const scheme = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__._)();
        if (scheme) {
            const color = scheme.colors[renderer.uniqueValueInfos.length % scheme.colors.length];
            color && (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.r)(symbol, color);
        }
        else {
            // just pick some colors from the primary scheme
            const primaryRampColors = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.$)().colors;
            const color = new modules.esriColor(primaryRampColors[renderer.uniqueValueInfos.length % 10]);
            color && (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.r)(symbol, color);
        }
        let groups = renderer.uniqueValueGroups;
        if (this.groupIdx === -2) {
            // there are no groups yet
            groups = [new modules.UniqueValueGroup({ heading: undefined, classes: [] })];
            this.groupIdx = 0;
        }
        groups[this.groupIdx].classes.push(new modules.UniqueValueClass({
            values: [new modules.UniqueValue({ value })],
            label: label,
            symbol
        }));
        renderer.uniqueValueGroups = groups;
        this.arcgisSmartMappingTypeAddValuePopoverNewValue.emit();
    }
    handleAddDate(value) {
        const { allUniqueValues, mapView, layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.h)(layer);
        // gather all unique values of layer
        const allValues = allUniqueValues === null || allUniqueValues === void 0 ? void 0 : allUniqueValues.map((uniqueValueInfo) => "" + uniqueValueInfo.value);
        // add the custom added values to the list
        renderer.uniqueValueGroups.forEach((uniqueValueGroup) => {
            uniqueValueGroup.classes.forEach((uniqueValueClass) => {
                var _a;
                const value = (_a = uniqueValueClass.values) === null || _a === void 0 ? void 0 : _a[0].value;
                if (allValues.indexOf("" + value) === -1) {
                    allValues.push("" + value);
                }
            });
        });
        const field = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.u)(renderer.field);
        if (!this.userTouchedLabel) {
            // value for date returns a string like this 2022-08-01
            // the date value must be stored in UTC
            const newValue = (0,_date_79c7d93c_js__WEBPACK_IMPORTED_MODULE_8__.d)(value, mapView.timeZone);
            this.labelInputNode.value = (0,_type_0ace5d2e_js__WEBPACK_IMPORTED_MODULE_5__.e)(newValue, field);
        }
        this.valueInputMessageNode.hidden = allValues.indexOf(value) === -1;
        this.doneButtonNode.disabled = !value.length || allValues.indexOf(value) > -1;
    }
    handleAddNumber(value) {
        const { modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_1__.s;
        if (value.length && this.isInt) {
            let strValue = "" + Math.round(parseFloat(value));
            if (strValue.indexOf(".") > -1) {
                strValue = strValue.substring(0, strValue.indexOf("."));
            }
            if (strValue !== value) {
                value = strValue;
            }
        }
        if (!this.userTouchedLabel) {
            const newValue = this.isInt ? parseInt(value) : parseFloat(value);
            this.labelInputNode.value = modules.intl.formatNumber(newValue);
        }
        this.valueInputMessageNode.hidden = this.allValues.indexOf(value) === -1;
        this.doneButtonNode.disabled = !value.length || this.allValues.indexOf(value) > -1;
    }
    handleAddString(value) {
        if (!this.userTouchedLabel) {
            this.labelInputNode.value = value;
        }
        this.valueInputMessageNode.hidden = this.allValues.indexOf(value) === -1;
        this.doneButtonNode.disabled = !value.length || this.allValues.indexOf(value) > -1;
    }
    get hostElement() { return (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};



//# sourceMappingURL=arcgis-smart-mapping-panels-type_3.entry.js.map

/***/ }),

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/date-79c7d93c.js":
/*!**********************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/date-79c7d93c.js ***!
  \**********************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   a: () => (/* binding */ addDateFormatFunctions),
/* harmony export */   b: () => (/* binding */ utcToTimePicker),
/* harmony export */   d: () => (/* binding */ datePickerToUTC),
/* harmony export */   u: () => (/* binding */ utcToDatePicker)
/* harmony export */ });
/* harmony import */ var _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./raster-unique-value-0976ec7f.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/raster-unique-value-0976ec7f.js");
/* harmony import */ var _loadModules_b4ac1247_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./loadModules-b4ac1247.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/loadModules-b4ac1247.js");
/* harmony import */ var _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./commonEnums-fcf13661.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/commonEnums-fcf13661.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v4.0.58
 */




function addDateFormatFunctions(config, timeZone) {
    config.labelFormatFunction = (value) => {
        return getDateDisplayString(value, timeZone, "short-date");
    };
    config.inputFormatFunction = (value) => {
        return getDateDisplayString(value, timeZone, "short-date");
    };
    config.inputParseFunction = (value) => {
        return mapTZToUTC(Date.parse(value), timeZone);
    };
}
function utcToDatePicker(value, timeZone) {
    // date is in UTC
    // we need a map timezone
    let str;
    if (!timeZone || timeZone === "system") {
        const diff = new Date().getTimezoneOffset();
        str = new Date(value - diff * 60000).toISOString();
    }
    else if (timeZone === "unknown") {
        str = new Date(value).toISOString();
    }
    else {
        const diff = new Date().getTimezoneOffset();
        const mapDateStr = new Date(value).toLocaleString("en-US", { timeZone });
        str = new Date(new Date(mapDateStr).getTime() - diff * 60000).toISOString();
    }
    // console.log("utcToDatePicker", value, " - ", new Date(value).toISOString(), " -> ", str);
    return str;
}
function utcToTimePicker(value, timeZone, addSeconds) {
    // date is in UTC
    // we need a map timezone
    let str;
    if (!timeZone || timeZone === "system") {
        const diff = new Date().getTimezoneOffset();
        str = new Date(value - diff * 60000).toISOString();
    }
    else if (timeZone === "unknown") {
        str = new Date(value).toISOString();
    }
    else {
        const diff = new Date().getTimezoneOffset();
        const mapDateStr = new Date(value).toLocaleString("en-US", { timeZone });
        str = new Date(new Date(mapDateStr).getTime() - diff * 60000).toISOString();
    }
    // str = "2023-09-20T13:06:00.000Z"
    str = addSeconds ? str.substring(11, 19) : str.substring(11, 16);
    // console.log("utcToTimePicker", value, " - ", new Date(value).toISOString(), " -> ", str);
    return str;
}
function datePickerToUTC(dateString, timeZone) {
    // date is in map timezone
    // we need a UTC UNIX timestamp
    let date = new Date(dateString);
    // this is read as current time; toISOString() would reaturn UTC time (e.g. +7 hours from pacific)
    // fix the offset
    date = new Date(date.getTime() - date.getTimezoneOffset() * 60000);
    // date now contains the user's entered time
    let value;
    if (!timeZone || timeZone === "system") {
        // add difference between local time and UTC
        value = date.getTime() + date.getTimezoneOffset() * 60000;
    }
    else if (timeZone === "unknown") {
        // take what you get
        value = date.getTime();
    }
    else {
        // add difference between map time and UTC
        const diff = new Date(date.toLocaleString("en-US", { timeZone: "utc" })).getTime() -
            new Date(date.toLocaleString("en-US", { timeZone })).getTime();
        value = date.getTime() + diff;
    }
    // console.log("datePickerToUTC", date.toISOString(), " -> ", new Date(value).toISOString());
    return value;
}
function mapTZToUTC(value, timeZone) {
    if (!value) {
        return value;
    }
    // value is in map timezone
    // we need a UTC timestamp
    let newValue;
    if (!timeZone || timeZone === "system") {
        // add difference between local time and UTC
        const date = new Date();
        newValue = value + date.getTimezoneOffset() * 60000;
    }
    else if (timeZone === "unknown") {
        // take what you get
        newValue = value;
    }
    else {
        // add difference between map time and UTC
        const date = new Date();
        const diff = new Date(date.toLocaleString("en-US", { timeZone: "utc" })).getTime() -
            new Date(date.toLocaleString("en-US", { timeZone })).getTime();
        newValue = value + diff;
    }
    console.log("mapTZToUTC", value, " - ", new Date(value).toISOString(), " - ", new Date(newValue).toISOString());
    return newValue;
}
function getDateDisplayString(value, timeZone, dateFormat) {
    const { modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    let str;
    if (timeZone === "unknown") {
        str = modules.intl.formatDate(value, Object.assign(Object.assign({}, modules.intl.convertDateFormatToIntlOptions(dateFormat || "short-date-short-time")), { timeZone: "utc", timeZoneName: "shortOffset" }));
    }
    else {
        // known issues with formatting it-CH
        str = modules.intl.formatDate(value, Object.assign(Object.assign({}, modules.intl.convertDateFormatToIntlOptions(dateFormat || "short-date-short-time")), { timeZone }));
    }
    // console.log("getDateDisplayString", value, " - ", new Date(value).toISOString(), " -> ", str);
    return str;
}



//# sourceMappingURL=date-79c7d93c.js.map

/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0cy9jaHVua3MvYXJjZ2lzX2FuYWx5c2lzX25vZGVfbW9kdWxlc19hcmNnaXNfYXBwLWNvbXBvbmVudHNfZGlzdF9lc21fYXJjZ2lzLTJhMzg5My5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQzhJO0FBQ3FmO0FBQ2htQjtBQUNBO0FBQ2lKO0FBQ2lCO0FBQ3ZJO0FBQ0g7QUFDRDtBQUM1QjtBQUNIO0FBQ0U7QUFDVTtBQUNQOztBQUVoQywrQ0FBK0MsV0FBVyxXQUFXLFlBQVksUUFBUSxhQUFhLFlBQVksa0JBQWtCLG1CQUFtQixXQUFXLFlBQVksZ0JBQWdCLGNBQWMsV0FBVyxlQUFlLGVBQWUsWUFBWSxnQkFBZ0IsYUFBYSxpQkFBaUIsaUJBQWlCLG9DQUFvQyxhQUFhLGdCQUFnQiw4QkFBOEIsbUJBQW1CLGtCQUFrQixlQUFlLHdDQUF3Qyw2QkFBNkIsNkJBQTZCLGdCQUFnQixpQ0FBaUMsYUFBYSx3QkFBd0IsNkJBQTZCLDRCQUE0QixhQUFhLDREQUE0RCw2Q0FBNkMsb0VBQW9FLGFBQWEsaUJBQWlCLHlCQUF5QixhQUFhLGVBQWUsYUFBYSxpQkFBaUIsWUFBWSx5QkFBeUIsWUFBWSxXQUFXLDZCQUE2QixZQUFZLFVBQVUsZUFBZSxpQkFBaUIsY0FBYyxhQUFhLGNBQWMsOEJBQThCLG1CQUFtQixnQ0FBZ0MsZUFBZSxpQkFBaUIsa0JBQWtCLDRCQUE0QixrQkFBa0IsT0FBTyx5QkFBeUIsYUFBYSxZQUFZLHNCQUFzQixxQkFBcUIsbUJBQW1CLGVBQWUsYUFBYSxnQkFBZ0IscUJBQXFCLGtCQUFrQixtQkFBbUIsZ0JBQWdCLE9BQU8sYUFBYSxjQUFjLDhCQUE4QixtQkFBbUIsYUFBYSxhQUFhLDZCQUE2QixxQkFBcUIsbUJBQW1CLGFBQWEsYUFBYSxhQUFhLDRCQUE0Qiw0QkFBNEIsWUFBWSxXQUFXLGFBQWEsOENBQThDLGNBQWMsV0FBVyxhQUFhLGNBQWMsYUFBYSxZQUFZ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QTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNkRBQTZELGlCQUFpQjtBQUM5RSxvREFBb0QsVUFBVTtBQUM5RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxZQUFZLFVBQVUsRUFBRSwrREFBaUI7QUFDekM7QUFDQTtBQUNBLDJFQUEyRSx5RkFBeUYsOENBQThDO0FBQ2xOO0FBQ0E7QUFDQTtBQUNBLDJFQUEyRSx5RkFBeUYsVUFBVTtBQUM5SztBQUNBO0FBQ0E7QUFDQTs7QUFFeUc7O0FBRXpHIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vZXhiLWNsaWVudC8uL2V4dGVuc2lvbnMvd2lkZ2V0cy9hcmNnaXMvYW5hbHlzaXMvbm9kZV9tb2R1bGVzL0BhcmNnaXMvYXBwLWNvbXBvbmVudHMvZGlzdC9lc20vYXJjZ2lzLXNtYXJ0LW1hcHBpbmctcGFuZWxzLXR5cGVfMy5lbnRyeS5qcyIsIndlYnBhY2s6Ly9leGItY2xpZW50Ly4vZXh0ZW5zaW9ucy93aWRnZXRzL2FyY2dpcy9hbmFseXNpcy9ub2RlX21vZHVsZXMvQGFyY2dpcy9hcHAtY29tcG9uZW50cy9kaXN0L2VzbS9kYXRlLTc5YzdkOTNjLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQWxsIG1hdGVyaWFsIGNvcHlyaWdodCBFU1JJLCBBbGwgUmlnaHRzIFJlc2VydmVkLCB1bmxlc3Mgb3RoZXJ3aXNlIHNwZWNpZmllZC5cbiAqIHY0LjAuNThcbiAqL1xuaW1wb3J0IHsgciBhcyByZWdpc3Rlckluc3RhbmNlLCBjIGFzIGNyZWF0ZUV2ZW50LCBoLCBIIGFzIEhvc3QsIEYgYXMgRnJhZ21lbnQsIGYgYXMgZm9yY2VVcGRhdGUsIGQgYXMgZ2V0RWxlbWVudCB9IGZyb20gJy4vaW5kZXgtZTNiZjdkYTcuanMnO1xuaW1wb3J0IHsgZyBhcyBnZXRSZW5kZXJlclR5cGUsIHMgYXMgc21hcnRNYXBwaW5nU3RhdGUsIFMgYXMgZ2V0RGVmYXVsdFN5bWJvbCwgXyBhcyBmaW5kVHlwZVNjaGVtZSwgcSBhcyBpc1BvbHlnb25UeXBlLCByIGFzIGFwcGx5U3ltYm9sQ29sb3IsIHQgYXMgZ2V0U3ltYm9sQ29sb3IsIGFhIGFzIGlzVG9wRmxvd0l0ZW0sIHUgYXMgZ2V0RmllbGQsIHcgYXMgc2ltcGxlRmllbGRUeXBlcywgeiBhcyBnZXRGaWVsZFR5cGUsIEQgYXMgZ2V0R2VvbWV0cnlUeXBlLCBhcSBhcyBpc1N5bWJvbEFsbW9zdFdoaXRlLCBhYyBhcyBpc0RlZmluZWQsIGEgYXMgZ2V0VmlzVmFyLCBhciBhcyBnZXRSZW5kZXJQcmV2aWV3U2l6ZSwgRSBhcyBjbG9zZVBvcG92ZXJzLCBhZSBhcyByZW1vdmVTbWFydE1hcHBpbmdUb29sdGlwLCBhRiBhcyBhZGRTbWFydE1hcHBpbmdUb29sdGlwV2l0aElkLCBhRyBhcyByZW1vdmVTbWFydE1hcHBpbmdUb29sdGlwQnlJZCwgYWIgYXMgdXBkYXRlUmVuZGVyZXIsIGggYXMgZ2V0UmVuZGVyZXIsIGogYXMgYXBwbHlSZW5kZXJlclRvQWxsLCBhOSBhcyBnZXRDb2xvclJhbXBzV2l0aFNjaGVtZXMsICQgYXMgZ2V0UHJpbWFyeVR5cGVTY2hlbWUgfSBmcm9tICcuL3Jhc3Rlci11bmlxdWUtdmFsdWUtMDk3NmVjN2YuanMnO1xuaW1wb3J0ICcuL2xvYWRNb2R1bGVzLWI0YWMxMjQ3LmpzJztcbmltcG9ydCAnLi9jb21tb25FbnVtcy1mY2YxMzY2MS5qcyc7XG5pbXBvcnQgeyBjIGFzIGNyZWF0ZVN5bWJvbFN0eWxlclBvcG92ZXIsIHIgYXMgcmVtb3ZlU3ltYm9sU3R5bGVyUG9wb3ZlciwgZSBhcyBidWlsZFN5bWJvbFN0eWxlckZvclR5cGVHcm91cCwgZiBhcyBidWlsZFN5bWJvbFN0eWxlckZvclR5cGVWYWx1ZSB9IGZyb20gJy4vc3ltYm9sU3R5bGVyLTA0NjM1YjJiLmpzJztcbmltcG9ydCB7IGMgYXMgY3JlYXRlVHlwZVJlbmRlcmVyLCBnIGFzIGdldE90aGVyVW5pcXVlVmFsdWVJbmZvcywgYiBhcyBnZXRPdGhlclVuaXF1ZVZhbHVlQ2xhc3NlcywgZCBhcyBnZXRVbmlxdWVHcm91cE5hbWUsIGUgYXMgZ2V0RGF0ZUxhYmVsLCBmIGFzIHNlcGFyYXRlTWVyZ2VkQ2xhc3NlcyB9IGZyb20gJy4vdHlwZS0wYWNlNWQyZS5qcyc7XG5pbXBvcnQgeyBDIGFzIENTU19VVElMSVRZIH0gZnJvbSAnLi9sYW5ndWFnZVV0aWwtZWYwZTU0YjIuanMnO1xuaW1wb3J0IHsgUyBhcyBTb3J0YWJsZSB9IGZyb20gJy4vc29ydGFibGUuZXNtLTdlNzg1NzgwLmpzJztcbmltcG9ydCB7IGQgYXMgZGF0ZVBpY2tlclRvVVRDIH0gZnJvbSAnLi9kYXRlLTc5YzdkOTNjLmpzJztcbmltcG9ydCAnLi9sb2NhbGUtMDUwYjZkYjkuanMnO1xuaW1wb3J0ICcuL2RvbS00ZDM2NzY3Ny5qcyc7XG5pbXBvcnQgJy4vaW5kZXgtMDU5NTZjYWIuanMnO1xuaW1wb3J0ICcuL2NvbW1vbkZ1bmN0aW9ucy1iMDgzMGU5ZS5qcyc7XG5pbXBvcnQgJy4vbG9jYXRpb24tZTI2YjUzOWYuanMnO1xuXG5jb25zdCBhcmNnaXNTbWFydE1hcHBpbmdQYW5lbHNUeXBlQ3NzID0gXCI6aG9zdHt3aWR0aDoxMDAlfS5mbG93LWl0ZW17aGVpZ2h0OjEwMCV9LmhpZGRlbntkaXNwbGF5Om5vbmV9LnR5cGUtYmxvY2t7b3ZlcmZsb3cteDpoaWRkZW59LmNoZWNrLXBsYWNlaG9sZGVye3dpZHRoOjMycHg7aGVpZ2h0OjI0cHh9LnR5cGUtcGFuZWwtbXNne2ZvbnQtc2l6ZTo4MCU7bWFyZ2luOjVweH0udG9nZ2xlLWJ1dHRvbnttYXJnaW4tdG9wOjJweH0udG9nZ2xlLWRpdntwYWRkaW5nLXRvcDo2cHh9LnRvcC1wYWRkaW5ne3BhZGRpbmctdG9wOjEwcHh9LnN5bWJvbC1zZWxlY3RvcntiYWNrZ3JvdW5kLWNvbG9yOnJnYigyNTUsIDI1NSwgMjU1KTtkaXNwbGF5OmZsZXg7cGFkZGluZzo5cHggOXB4O2p1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuO2FsaWduLWl0ZW1zOmNlbnRlcjtib3JkZXItcmFkaXVzOjNweDtjdXJzb3I6cG9pbnRlcjt0cmFuc2l0aW9uOmJveC1zaGFkb3cgMjUwbXMgZWFzZS1pbi1vdXQ7Ym94LXNoYWRvdzowIDAgMCAxcHggI2UwZTBlMH0uc3ltYm9sLXNlbGVjdG9yIDpsYXN0LWNoaWxke21hcmdpbi1ib3R0b206MH0uc3ltYm9sLXNlbGVjdG9yIDpsYXN0LWNoaWxkIHN2Z3tmaWxsOiNjMGMwYzB9LnN5bWJvbC1zZWxlY3RvciA6aG92ZXJ7Ym94LXNoYWRvdzowIDAgMCAxcHggI2MwYzBjMH0uc3ltYm9sLXNlbGVjdG9yIDpob3ZlciBzdmd7ZmlsbDojNDA0MDQwfS5zeW1ib2wtc2VsZWN0b3ItLXNlbGVjdGVkLC5zeW1ib2wtc2VsZWN0b3ItLXNlbGVjdGVkOmhvdmVye291dGxpbmU6MXB4IHNvbGlkIHZhcigtLWNhbGNpdGUtY29sb3ItYnJhbmQpfS5zeW1ib2wtc2VsZWN0b3ItLXNlbGVjdGVkIHN2Zywuc3ltYm9sLXNlbGVjdG9yLS1zZWxlY3RlZDpob3ZlciBzdmd7ZmlsbDojNDA0MDQwfS5zeW1ib2wtaXMtd2hpdGV7YmFja2dyb3VuZC1jb2xvcjojZjNmM2YzfS5zeW1ib2wtaWNvbnttaW4td2lkdGg6MjZweDtkaXNwbGF5OmZsZXh9LnN5bWJvbC1pY29uIGRpdnttYXJnaW46YXV0b30uc3ltYm9sLWljb24udHJhbnNwYXJlbnR7aGVpZ2h0OjE1cHg7d2lkdGg6MTAwJX0uc3ltYm9sLWljb24udHJhbnNwYXJlbnQgc3Zne2hlaWdodDoxNXB4O3dpZHRoOjk1JTtzdHJva2U6I2UwZTBlMDtzdHJva2Utd2lkdGg6MXB4fS5ncm91cC1oZWFkZXJ7ZGlzcGxheTpmbGV4O3BhZGRpbmc6NnB4IDA7anVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47YWxpZ24taXRlbXM6Y2VudGVyO2JvcmRlci1ib3R0b206MXB4IHNvbGlkICNlMGUwZTB9Lmdyb3VwLWhlYWRpbmd7Zm9udC13ZWlnaHQ6Ym9sZH0ubm8tZ3JvdXAtaGVhZGluZ3tjb2xvcjpyZ2JhKDUwLCA1MCwgNTAsIDAuNCk7Zm9udC1zdHlsZTppdGFsaWN9Lmdyb3Vwe2JvcmRlcjoxcHggc29saWQgI2UwZTBlMDttYXJnaW46NXB4IDB9Lmdyb3VwLXRleHR7cGFkZGluZzozcHggOXB4IDAgOXB4O3dvcmQtYnJlYWs6YnJlYWstYWxsfS5ncm91cC10ZXh0LWFjdGl2ZXtjdXJzb3I6cG9pbnRlcn0uZ3JvdXAtY291bnR7cGFkZGluZy10b3A6N3B4fS5ncm91cC1jb3VudC1uby1tZW51e3BhZGRpbmctcmlnaHQ6M3B4fS52YWx1ZXMtaXRlbXMtb25seXtwYWRkaW5nOjZweCA2cHh9LnZhbHVle2Rpc3BsYXk6ZmxleDtwYWRkaW5nOjZweCAwO2p1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuO2FsaWduLWl0ZW1zOmNlbnRlcn0udmFsdWUtcGFydDF7ZGlzcGxheTpmbGV4O3dpZHRoOi13ZWJraXQtZmlsbC1hdmFpbGFibGU7d2lkdGg6LW1vei1hdmFpbGFibGU7YWxpZ24taXRlbXM6Y2VudGVyO21hcmdpbjowIDVweH0udmFsdWUtcGFydDJ7ZGlzcGxheTpmbGV4fS5ncm91cC1oYW5kbGUsLmNsYXNzLWhhbmRsZXtjb2xvcjpyZ2JhKDUwLCA1MCwgNTAsIDAuNCk7Y3Vyc29yOmdyYWI7d2lkdGg6MTZweDtkaXNwbGF5OmZsZXh9Lmdyb3VwLWhhbmRsZS1kaXNhYmxlZCwuY2xhc3MtaGFuZGxlLWRpc2FibGVke2NvbG9yOiNlMGUwZTA7d2lkdGg6MTZweDtkaXNwbGF5OmZsZXh9LnZhbHVlLXN5bWJvbHttYXJnaW46MCA1cHg7cGFkZGluZzo0cHg7Y3Vyc29yOnBvaW50ZXJ9LnZhbHVlLXRleHR7cGFkZGluZzowIDlweDt3b3JkLWJyZWFrOmJyZWFrLWFsbDtjdXJzb3I6cG9pbnRlcn0udmFsdWUtY291bnR7cGFkZGluZzozcHggM3B4IDAgM3B4fS5tZW51LXBsYWNlaG9sZGVye3dpZHRoOjMycHh9LnZhbHVlLWhhbmRsZS1wbGFjZWhvbGRlcnttaW4td2lkdGg6MTZweH0ub3RoZXJ7Ym9yZGVyOjFweCBzb2xpZCAjZTBlMGUwfS5kZWZhdWx0LXZhbHVle2JvcmRlci1ib3R0b206MXB4IHNvbGlkICNlMGUwZTB9Lm90aGVyLXZhbHVlLXRleHR7Y3Vyc29yOmRlZmF1bHR9LnN5bWJvbC1zdHlsZXItcGFuZWx7d2lkdGg6MzI4cHg7bWluLWhlaWdodDozMDBweH0uc3ltYm9sLXN0eWxlci1kaXZ7d2lkdGg6MTAwJX0uYXZhdGFye2JhY2tncm91bmQtY29sb3I6I2YwZWZlZn0udmFsdWUtdGV4dDpmb2N1cywuZ3JvdXAtdGV4dDpmb2N1cywuc3ltYm9sOmZvY3Vze291dGxpbmU6MnB4IHNvbGlkIHZhcigtLWNhbGNpdGUtY29sb3ItYnJhbmQpfVwiO1xuXG5jb25zdCBBcmNnaXNTbWFydE1hcHBpbmdQYW5lbHNUeXBlID0gY2xhc3Mge1xuICAgIGNvbnN0cnVjdG9yKGhvc3RSZWYpIHtcbiAgICAgICAgcmVnaXN0ZXJJbnN0YW5jZSh0aGlzLCBob3N0UmVmKTtcbiAgICAgICAgdGhpcy5hcmNnaXNTbWFydE1hcHBpbmdQYW5lbHNUeXBlQmFja0NsaWNrID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNTbWFydE1hcHBpbmdQYW5lbHNUeXBlQmFja0NsaWNrXCIsIDcpO1xuICAgICAgICB0aGlzLmFyY2dpc1NtYXJ0TWFwcGluZ1BhbmVsc1R5cGVDbG9zZSA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzU21hcnRNYXBwaW5nUGFuZWxzVHlwZUNsb3NlXCIsIDcpO1xuICAgICAgICB0aGlzLmFyY2dpc1NtYXJ0TWFwcGluZ1BhbmVsc1R5cGVDbHVzdGVyUmVxdWlyZXNVcGRhdGUgPSBjcmVhdGVFdmVudCh0aGlzLCBcImFyY2dpc1NtYXJ0TWFwcGluZ1BhbmVsc1R5cGVDbHVzdGVyUmVxdWlyZXNVcGRhdGVcIiwgNyk7XG4gICAgICAgIHRoaXMuYXJjZ2lzU21hcnRNYXBwaW5nUGFuZWxzVHlwZUVycm9yID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNTbWFydE1hcHBpbmdQYW5lbHNUeXBlRXJyb3JcIiwgNyk7XG4gICAgICAgIHRoaXMuZ3JvdXBNZW51Tm9kZXMgPSBbXTtcbiAgICAgICAgdGhpcy5ncm91cElucHV0Tm9kZXMgPSBbXTtcbiAgICAgICAgdGhpcy5ncm91cFRleHROb2RlcyA9IFtdO1xuICAgICAgICB0aGlzLnZhbHVlSW5wdXROb2RlcyA9IFtdO1xuICAgICAgICB0aGlzLnZhbHVlVGV4dE5vZGVzID0gW107XG4gICAgICAgIHRoaXMuc3ltYm9sTm9kZXMgPSBbXTtcbiAgICAgICAgdGhpcy5jaGVja2VkQ2xhc3NlcyA9IFtdO1xuICAgICAgICB0aGlzLmNsYXNzU29ydGFibGUgPSBbXTtcbiAgICAgICAgdGhpcy5ncm91cFNvcnRhYmxlID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLm90aGVyU29ydGFibGUgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMubWF4Q291bnRPdGhlclZhbHVlcyA9IDIwMDtcbiAgICAgICAgdGhpcy5zeW1ib2xTdHlsZXJPcGVuID0gZmFsc2U7XG4gICAgICAgIHRoaXMuZHJhZ1JlbmRlclRvZ2dsZSA9IHRydWU7XG4gICAgICAgIHRoaXMuaGlkZVJvdGF0aW9uID0gZmFsc2U7XG4gICAgICAgIHRoaXMuaGlkZVRyYW5zcGFyZW5jeSA9IGZhbHNlO1xuICAgICAgICB0aGlzLm1lbnVPcGVuID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLnNob3dCYWNrQnV0dG9uID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLmJlZm9yZUJhY2sgPSB1bmRlZmluZWQ7XG4gICAgfVxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvL1xuICAgIC8vICBQdWJsaWMgTWV0aG9kc1xuICAgIC8vXG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIGFzeW5jIHNldEZvY3VzKCkge1xuICAgICAgICB2YXIgX2E7XG4gICAgICAgIChfYSA9IHRoaXMuZmxvd0l0ZW1Ob2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2V0Rm9jdXMoKTtcbiAgICB9XG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy9cbiAgICAvLyAgTGlmZWN5Y2xlXG4gICAgLy9cbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICBhc3luYyBjb21wb25lbnRXaWxsTG9hZCgpIHtcbiAgICAgICAgdmFyIF9hO1xuICAgICAgICBjb25zdCB7IGxheWVyOiBzbUxheWVyLCBtYXBWaWV3LCBtb2R1bGVzLCBzdHJpbmdzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgY29uc3QgbGF5ZXIgPSBzbUxheWVyO1xuICAgICAgICBjb25zdCByZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKTtcbiAgICAgICAgY29uc3QgcmVuZGVyZXJUeXBlID0gZ2V0UmVuZGVyZXJUeXBlKCk7XG4gICAgICAgIHNtYXJ0TWFwcGluZ1N0YXRlLmxhc3REZWZhdWx0ID0ge1xuICAgICAgICAgICAgZGVmYXVsdFN5bWJvbDogcmVuZGVyZXIuZGVmYXVsdFN5bWJvbCB8fCBnZXREZWZhdWx0U3ltYm9sKGxheWVyLCBtYXBWaWV3KSxcbiAgICAgICAgICAgIGRlZmF1bHRMYWJlbDogcmVuZGVyZXIuZGVmYXVsdExhYmVsIHx8IHN0cmluZ3MucGFuZWxzLnR5cGUub3RoZXJcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5vcmlnaW5hbFJlbmRlcmVySlNPTiA9IHJlbmRlcmVyLnRvSlNPTigpO1xuICAgICAgICB0aGlzLm9yaWdpbmFsRmVhdHVyZVJlZHVjdGlvbiA9XG4gICAgICAgICAgICBcImZlYXR1cmVSZWR1Y3Rpb25cIiBpbiBsYXllciAmJiBsYXllci5mZWF0dXJlUmVkdWN0aW9uXG4gICAgICAgICAgICAgICAgPyBtb2R1bGVzLmVzcmlMYW5nLmNsb25lKGxheWVyLmZlYXR1cmVSZWR1Y3Rpb24pXG4gICAgICAgICAgICAgICAgOiB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMub3JpZ2luYWxPcmRlckJ5ID0gbGF5ZXIub3JkZXJCeTtcbiAgICAgICAgLy8gZ2V0IGFsbCB1bmlxdWUgdmFsdWVzXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjcmVhdGVUeXBlUmVuZGVyZXIoe1xuICAgICAgICAgICAgICAgIGZpZWxkSW5mb3M6IFtcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQ6IHJlbmRlcmVyLmZpZWxkLFxuICAgICAgICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbjogcmVuZGVyZXIudmFsdWVFeHByZXNzaW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvblRpdGxlOiByZW5kZXJlci52YWx1ZUV4cHJlc3Npb25UaXRsZVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICB0eXBlU2NoZW1lOiBmaW5kVHlwZVNjaGVtZSgpXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGlmIChpc1BvbHlnb25UeXBlKGxheWVyKSAmJiByZW5kZXJlclR5cGUgPT09IFwidHlwZS1zaXplXCIpIHtcbiAgICAgICAgICAgICAgICAvLyBuZWVkIHRvIGNvbnZlcnQgZmlsbCBzeW1ib2xzIHRvIG1hcmtlciBzeW1ib2xzXG4gICAgICAgICAgICAgICAgbGV0IHJlZlN5bWJvbCA9ICgoX2EgPSByZW5kZXJlci51bmlxdWVWYWx1ZUluZm9zKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKVxuICAgICAgICAgICAgICAgICAgICA/IHJlbmRlcmVyLnVuaXF1ZVZhbHVlSW5mb3NbMF0uc3ltYm9sXG4gICAgICAgICAgICAgICAgICAgIDogZ2V0RGVmYXVsdFN5bWJvbChsYXllciwgbWFwVmlldyk7XG4gICAgICAgICAgICAgICAgaWYgKHJlZlN5bWJvbC50eXBlICE9PSBcInNpbXBsZS1tYXJrZXJcIikge1xuICAgICAgICAgICAgICAgICAgICAvLyBtaWdodCBiZSBhIHBpY3R1cmUgbWFya2VyXG4gICAgICAgICAgICAgICAgICAgIHJlZlN5bWJvbCA9IG5ldyBtb2R1bGVzLlNpbXBsZU1hcmtlclN5bWJvbCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXN1bHQudW5pcXVlVmFsdWVJbmZvcy5tYXAoKGluZm8pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV3U3ltYm9sID0gbW9kdWxlcy5lc3JpTGFuZy5jbG9uZShyZWZTeW1ib2wpO1xuICAgICAgICAgICAgICAgICAgICBhcHBseVN5bWJvbENvbG9yKG5ld1N5bWJvbCwgZ2V0U3ltYm9sQ29sb3IoaW5mby5zeW1ib2wpKTtcbiAgICAgICAgICAgICAgICAgICAgaW5mby5zeW1ib2wgPSBuZXdTeW1ib2w7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzbWFydE1hcHBpbmdTdGF0ZS5hbGxVbmlxdWVWYWx1ZXMgPSByZXN1bHQudW5pcXVlVmFsdWVJbmZvcztcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzdWx0KTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRoaXMuYXJjZ2lzU21hcnRNYXBwaW5nUGFuZWxzVHlwZUVycm9yLmVtaXQoe1xuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGVycm9yLFxuICAgICAgICAgICAgICAgIHR5cGU6IFwiZXJyb3JcIlxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7IHZhciBfYTsgcmV0dXJuIChfYSA9IHRoaXMuZmxvd0l0ZW1Ob2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2V0Rm9jdXMoKTsgfSk7XG4gICAgfVxuICAgIGRpc2Nvbm5lY3RlZENhbGxiYWNrKCkge1xuICAgICAgICB0aGlzLmNsb3NlUG9wb3ZlcnMoKTtcbiAgICB9XG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy9cbiAgICAvLyAgUmVuZGVyIE1ldGhvZHNcbiAgICAvL1xuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIHJlbmRlcigpIHtcbiAgICAgICAgdmFyIF9hO1xuICAgICAgICBjb25zdCB7IGhpZGVMYXllclRpdGxlLCBpc1JUTCwgbGF5ZXIsIG1hcEltYWdlU3VibGF5ZXIsIHN0cmluZ3MgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgICAgICBjb25zdCB0aXRsZSA9IGhpZGVMYXllclRpdGxlID8gdW5kZWZpbmVkIDogKF9hID0gbWFwSW1hZ2VTdWJsYXllciA9PT0gbnVsbCB8fCBtYXBJbWFnZVN1YmxheWVyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBtYXBJbWFnZVN1YmxheWVyLnRpdGxlKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiBsYXllci50aXRsZTtcbiAgICAgICAgcmV0dXJuIChoKEhvc3QsIHsgY2xhc3M6IFwiY2FsY2l0ZS1tYXRjaC1oZWlnaHRcIiB9LCBoKFwiY2FsY2l0ZS1mbG93LWl0ZW1cIiwgeyBjbGFzczoge1xuICAgICAgICAgICAgICAgIFwiZmxvdy1pdGVtXCI6IHRydWUsXG4gICAgICAgICAgICAgICAgW0NTU19VVElMSVRZLnJ0bF06IGlzUlRMXG4gICAgICAgICAgICB9LCBoZWFkaW5nOiBzdHJpbmdzLnBhbmVscy50eXBlLnN0eWxlT3B0aW9ucywgY2xvc2FibGU6IGlzVG9wRmxvd0l0ZW0odGhpcy5ob3N0RWxlbWVudCksIG1lbnVPcGVuOiB0aGlzLm1lbnVPcGVuLCBiZWZvcmVCYWNrOiB0aGlzLmJlZm9yZUJhY2ssXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICBzaG93QmFja0J1dHRvbjogdGhpcy5zaG93QmFja0J1dHRvbiwgZGVzY3JpcHRpb246IHRpdGxlLCBvbkNhbGNpdGVGbG93SXRlbUJhY2s6ICgpID0+IHRoaXMuYXJjZ2lzU21hcnRNYXBwaW5nUGFuZWxzVHlwZUJhY2tDbGljay5lbWl0KCksIHJlZjogKG5vZGUpID0+ICh0aGlzLmZsb3dJdGVtTm9kZSA9IG5vZGUpIH0sIHRoaXMucmVuZGVyVmlzdWFsaXphdGlvbkNvbnRlbnQoKSwgdGhpcy5yZW5kZXJUcmFuc3BhcmVuY3koKSwgdGhpcy5yZW5kZXJSb3RhdGlvbigpLCB0aGlzLnJlbmRlckRvbmVCdXR0b24oKSwgdGhpcy5yZW5kZXJDYW5jZWxCdXR0b24oKSkpKTtcbiAgICB9XG4gICAgcmVuZGVyVmlzdWFsaXphdGlvbkNvbnRlbnQoKSB7XG4gICAgICAgIGNvbnN0IHsgbGF5ZXIsIHN0cmluZ3MgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgICAgICBjb25zdCBoYXNPdGhlckJsb2NrcyA9ICF0aGlzLmhpZGVUcmFuc3BhcmVuY3kgfHwgIXRoaXMuaGlkZVJvdGF0aW9uO1xuICAgICAgICBjb25zdCByZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKTtcbiAgICAgICAgY29uc3QgZmllbGQgPSBnZXRGaWVsZChyZW5kZXJlci5maWVsZCk7XG4gICAgICAgIGNvbnN0IGlzRGF0ZSA9IChmaWVsZCA9PT0gbnVsbCB8fCBmaWVsZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmllbGQuc2ltcGxlRmllbGRUeXBlKSA9PT0gc2ltcGxlRmllbGRUeXBlcy5EQVRFIHx8XG4gICAgICAgICAgICBnZXRGaWVsZFR5cGUoZmllbGQgPT09IG51bGwgfHwgZmllbGQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGZpZWxkLmxheWVyRmllbGQpID09PSBcImRhdGUtb25seVwiO1xuICAgICAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWJsb2NrXCIsIHsgY2xhc3M6IFwidHlwZS1ibG9ja1wiLCBoZWFkaW5nOiBpc0RhdGUgPyBzdHJpbmdzLnBhbmVscy50eXBlLnR5cGVTdHlsZURhdGUgOiBzdHJpbmdzLnBhbmVscy50eXBlLnR5cGVTdHlsZSwgY29sbGFwc2libGU6IGhhc090aGVyQmxvY2tzLCBvcGVuOiB0cnVlIH0sIHRoaXMucmVuZGVyVHlwZXNTeW1ib2woKSwgdGhpcy5yZW5kZXJEcmF3aW5nT3JkZXIoKSwgdGhpcy5yZW5kZXJHcm91cHMoKSwgdGhpcy5yZW5kZXJCYWNrZ3JvdW5kU3R5bGUoKSkpO1xuICAgIH1cbiAgICByZW5kZXJUeXBlc1N5bWJvbCgpIHtcbiAgICAgICAgdmFyIF9hO1xuICAgICAgICBjb25zdCB7IGxheWVyLCBtYXBWaWV3LCBtb2R1bGVzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcik7XG4gICAgICAgIGNvbnN0IGdyb3VwcyA9IHJlbmRlcmVyLnVuaXF1ZVZhbHVlR3JvdXBzO1xuICAgICAgICBpZiAoIShncm91cHMgPT09IG51bGwgfHwgZ3JvdXBzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBncm91cHMubGVuZ3RoKSB8fCAhKChfYSA9IGdyb3Vwc1swXS5jbGFzc2VzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYWxsQ2xhc3NlcyA9IFtdO1xuICAgICAgICBncm91cHMuZm9yRWFjaCgoZ3JvdXApID0+IGdyb3VwLmNsYXNzZXMuZm9yRWFjaCgodXZDbGFzcykgPT4gYWxsQ2xhc3Nlcy5wdXNoKHV2Q2xhc3MpKSk7XG4gICAgICAgIGNvbnN0IHNjaGVtZXMgPSBtb2R1bGVzLnR5cGVTY2hlbWVzLmdldFNjaGVtZXMoe1xuICAgICAgICAgICAgYmFzZW1hcDogbWFwVmlldy5tYXAuYmFzZW1hcCxcbiAgICAgICAgICAgIGdlb21ldHJ5VHlwZTogZ2V0R2VvbWV0cnlUeXBlKGxheWVyKVxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgY29sb3JSYW1wc0FuZFNjaGVtZXMgPSBnZXRDb2xvclJhbXBzV2l0aFNjaGVtZXMoc2NoZW1lcywgTWF0aC5taW4oYWxsQ2xhc3Nlcy5sZW5ndGgsIDEwKSk7XG4gICAgICAgIGNvbnN0IGRlZmF1bHRDb2xvcnMgPSBjb2xvclJhbXBzQW5kU2NoZW1lc1swXS5jb2xvcnM7XG4gICAgICAgIGxldCBjb2xvcnMgPSAoYWxsQ2xhc3NlcyA9PT0gbnVsbCB8fCBhbGxDbGFzc2VzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhbGxDbGFzc2VzLmxlbmd0aClcbiAgICAgICAgICAgID8gYWxsQ2xhc3Nlc1xuICAgICAgICAgICAgICAgIC5zbGljZSgwLCAxMClcbiAgICAgICAgICAgICAgICAubWFwKCh1dkNsYXNzLCBpZHgpID0+IGdldFN5bWJvbENvbG9yKHV2Q2xhc3Muc3ltYm9sKSB8fFxuICAgICAgICAgICAgICAgIG5ldyBtb2R1bGVzLmVzcmlDb2xvcihkZWZhdWx0Q29sb3JzW2lkeCAlIGRlZmF1bHRDb2xvcnMubGVuZ3RoXSkpXG4gICAgICAgICAgICA6IFtdO1xuICAgICAgICByZXR1cm4gKGgoXCJhcmNnaXMtc21hcnQtbWFwcGluZy1zeW1ib2wtYnV0dG9uXCIsIHsgcmFtcFR5cGU6IFwiZGlzY3JldGVcIiwgY29sb3JzOiBjb2xvcnMsIHR5cGU6IFwidHlwZS1yYW1wXCIsIG9uQXJjZ2lzU21hcnRNYXBwaW5nU3ltYm9sQnV0dG9uU3ltYm9sQ2hhbmdlOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgZm9yY2VVcGRhdGUodGhpcy5ob3N0RWxlbWVudCk7XG4gICAgICAgICAgICAgICAgdGhpcy5yb3RhdGlvbk5vZGUgJiYgZm9yY2VVcGRhdGUodGhpcy5yb3RhdGlvbk5vZGUpO1xuICAgICAgICAgICAgfSB9KSk7XG4gICAgfVxuICAgIHJlbmRlckRyYXdpbmdPcmRlcigpIHtcbiAgICAgICAgY29uc3QgeyBsYXllciwgbWFwSW1hZ2VTdWJsYXllciwgc3RyaW5ncyB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgICAgIGlmIChtYXBJbWFnZVN1YmxheWVyKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCByZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKTtcbiAgICAgICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1sYWJlbFwiLCB7IGNsYXNzOiBcInRvZ2dsZS1kaXZcIiwgbGF5b3V0OiBcImlubGluZS1zcGFjZS1iZXR3ZWVuXCIgfSwgc3RyaW5ncy5wYW5lbHMudHlwZS5kcmF3aW5nT3JkZXIsIGgoXCJjYWxjaXRlLXN3aXRjaFwiLCB7IGNsYXNzOiBcInRvZ2dsZS1idXR0b25cIiwgc2NhbGU6IFwic1wiLCBjaGVja2VkOiByZW5kZXJlci5vcmRlckJ5Q2xhc3Nlc0VuYWJsZWQsIG9uQ2FsY2l0ZVN3aXRjaENoYW5nZTogKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3Qgbm9kZSA9IGV2ZW50LnRhcmdldDtcbiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZURyYXdpbmdPcmRlclRvZ2dsZShub2RlLmNoZWNrZWQpO1xuICAgICAgICAgICAgfSB9KSkpO1xuICAgIH1cbiAgICByZW5kZXJHcm91cHMoKSB7XG4gICAgICAgIHZhciBfYSwgX2I7XG4gICAgICAgIGNvbnN0IHsgbGF5ZXIsIHN0cmluZ3MgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgICAgICBjb25zdCByZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKTtcbiAgICAgICAgY29uc3QgaGFzTm9Hcm91cCA9ICEoKF9hID0gcmVuZGVyZXIudW5pcXVlVmFsdWVHcm91cHMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpO1xuICAgICAgICBjb25zdCBmaWVsZE5hbWUgPSByZW5kZXJlci5maWVsZFxuICAgICAgICAgICAgPyAoX2IgPSBnZXRGaWVsZChyZW5kZXJlci5maWVsZCkpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5sYWJlbFxuICAgICAgICAgICAgOiByZW5kZXJlci52YWx1ZUV4cHJlc3Npb25UaXRsZSB8fCBzdHJpbmdzLmV4cHJlc3Npb247XG4gICAgICAgIGNvbnN0IHR5cGVHcm91cHMgPSBoYXNOb0dyb3VwXG4gICAgICAgICAgICA/IFt0aGlzLnJlbmRlck5vR3JvdXAoKV1cbiAgICAgICAgICAgIDogcmVuZGVyZXIudW5pcXVlVmFsdWVHcm91cHMubWFwKCh1bmlxdWVWYWx1ZUdyb3VwLCBncm91cElkeCkgPT4gdGhpcy5yZW5kZXJHcm91cCh1bmlxdWVWYWx1ZUdyb3VwLCBncm91cElkeCkpO1xuICAgICAgICBjb25zdCBvdGhlclZhbHVlcyA9IHRoaXMucmVuZGVyT3RoZXJWYWx1ZXMoKTtcbiAgICAgICAgcmV0dXJuIChoKFwiZGl2XCIsIHsgY2xhc3M6IFwidG9wLXBhZGRpbmdcIiB9LCBoKFwiY2FsY2l0ZS1sYWJlbFwiLCBudWxsLCBmaWVsZE5hbWUpLCBoKFwiZGl2XCIsIHsga2V5OiByZW5kZXJlci51bmlxdWVWYWx1ZUdyb3Vwcy5sZW5ndGgsIHJlZjogKG5vZGUpID0+IHtcbiAgICAgICAgICAgICAgICB2YXIgX2E7XG4gICAgICAgICAgICAgICAgaWYgKG5vZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcik7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZW5kZXJlci51bmlxdWVWYWx1ZUdyb3Vwcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIChfYSA9IHRoaXMuZ3JvdXBTb3J0YWJsZSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmRlc3Ryb3koKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ3JvdXBTb3J0YWJsZSA9IFNvcnRhYmxlLmNyZWF0ZShub2RlLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXA6IHsgbmFtZTogXCJzaGFyZWRcIiwgcHVsbDogdHJ1ZSwgcHV0OiBmYWxzZSB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFJZEF0dHI6IFwiZ3JvdXAtc29ydC12YWx1ZXNcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnaG9zdENsYXNzOiBcImF2YXRhclwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uU29ydDogKCkgPT4gdGhpcy5oYW5kbGVTb3J0R3JvdXBzKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlOiBgLmdyb3VwLWhhbmRsZWBcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSB9LCB0eXBlR3JvdXBzKSwgaChcImRpdlwiLCB7IGNsYXNzOiBcIm90aGVyXCIsIGtleTogYCR7b3RoZXJWYWx1ZXMubGVuZ3RofSR7dGhpcy5kcmFnUmVuZGVyVG9nZ2xlfWAgfSwgaChcImRpdlwiLCB7IGNsYXNzOiB0eXBlR3JvdXBzLmxlbmd0aCA/IFwiXCIgOiBcInZhbHVlcy1pdGVtcy1vbmx5XCIgfSwgdGhpcy5yZW5kZXJEZWZhdWx0VmFsdWUoKSksIGgoXCJkaXZcIiwgeyByZWY6IChub2RlKSA9PiB7XG4gICAgICAgICAgICAgICAgdmFyIF9hO1xuICAgICAgICAgICAgICAgIGlmIChub2RlKSB7XG4gICAgICAgICAgICAgICAgICAgIChfYSA9IHRoaXMub3RoZXJTb3J0YWJsZSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmRlc3Ryb3koKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vdGhlclNvcnRhYmxlID0gU29ydGFibGUuY3JlYXRlKG5vZGUsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwOiB7IG5hbWU6IFwic2hhcmVkXCIsIHB1bGw6IGZhbHNlLCBwdXQ6IHRydWUgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlcjogXCIubm9kcmFnXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBzb3J0OiBmYWxzZVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IH0sIG90aGVyVmFsdWVzLCB0aGlzLnJlbmRlck1zZygpKSkpKTtcbiAgICB9XG4gICAgcmVuZGVyTm9Hcm91cCgpIHtcbiAgICAgICAgY29uc3QgeyBzdHJpbmdzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgcmV0dXJuIChoKFwiZGl2XCIsIHsgY2xhc3M6IFwiZ3JvdXBcIiB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IFwiZ3JvdXAtaGVhZGVyXCIgfSwgaChcImRpdlwiLCB7IGNsYXNzOiBcInZhbHVlLXBhcnQxXCIgfSwgaChcImRpdlwiLCB7IGNsYXNzOiBcImdyb3VwLWhhbmRsZS1kaXNhYmxlZFwiLCBcImFyaWEtaGlkZGVuXCI6IFwidHJ1ZVwiIH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBzY2FsZTogXCJzXCIsIGljb246IFwiZHJhZ1wiIH0pKSwgaChcImRpdlwiLCB7IGNsYXNzOiBcImdyb3VwLXRleHQgbm8tZ3JvdXAtaGVhZGluZ1wiLCByb2xlOiBcImJ1dHRvblwiLCB0YWJJbmRleDogMCwgXCJhcmlhLWxhYmVsXCI6IHN0cmluZ3MucGFuZWxzLnR5cGUuYWNjZXNzaWJpbGl0eS5lZGl0TGFiZWxGb3IucmVwbGFjZShcIiR7dmFsdWV9XCIsIHN0cmluZ3MucGFuZWxzLnR5cGUuZ3JvdXBOYW1lSGludCkgfSwgc3RyaW5ncy5wYW5lbHMudHlwZS5ncm91cE5hbWVIaW50KSksIGgoXCJkaXZcIiwgeyBjbGFzczogXCJ2YWx1ZS1wYXJ0MlwiIH0sIHRoaXMucmVuZGVyR3JvdXBNZW51Tm9kZSgtMikpKSwgaChcImRpdlwiLCBudWxsLCBcIlxcdTAwQTBcIikpKTtcbiAgICB9XG4gICAgcmVuZGVyR3JvdXAodW5pcXVlVmFsdWVHcm91cCwgZ3JvdXBJZHgpIHtcbiAgICAgICAgY29uc3QgY2xhc3NWYWx1ZXMgPSB1bmlxdWVWYWx1ZUdyb3VwLmNsYXNzZXMubWFwKCh1bmlxdWVWYWx1ZUNsYXNzLCBjbGFzc0lkeCkgPT4gdGhpcy5yZW5kZXJWYWx1ZSh1bmlxdWVWYWx1ZUNsYXNzLCBncm91cElkeCwgY2xhc3NJZHgpKTtcbiAgICAgICAgcmV0dXJuIChoKFwiZGl2XCIsIHsga2V5OiB1bmlxdWVWYWx1ZUdyb3VwLnRvSlNPTigpLCBjbGFzczogXCJncm91cFwiLCBcImdyb3VwLXNvcnQtdmFsdWVzXCI6IGAke2dyb3VwSWR4fWAgfSwgaChcImRpdlwiLCB7IGNsYXNzOiBcImdyb3VwLWhlYWRlclwiIH0sIGgoXCJkaXZcIiwgeyBjbGFzczogXCJ2YWx1ZS1wYXJ0MVwiIH0sIHRoaXMucmVuZGVyR3JvdXBIYW5kbGVOb2RlKGdyb3VwSWR4KSwgdGhpcy5yZW5kZXJHcm91cFRleHROb2RlKHVuaXF1ZVZhbHVlR3JvdXAsIGdyb3VwSWR4KSksIGgoXCJkaXZcIiwgeyBjbGFzczogXCJ2YWx1ZS1wYXJ0MlwiIH0sIHRoaXMucmVuZGVyR3JvdXBDb3VudE5vZGUodW5pcXVlVmFsdWVHcm91cCksIHRoaXMucmVuZGVyR3JvdXBNZW51Tm9kZShncm91cElkeCwgdW5pcXVlVmFsdWVHcm91cCkpKSwgaChcImRpdlwiLCB7IHJlZjogKG5vZGUpID0+IHtcbiAgICAgICAgICAgICAgICB2YXIgX2EsIF9iO1xuICAgICAgICAgICAgICAgIGlmIChub2RlKSB7XG4gICAgICAgICAgICAgICAgICAgIChfYiA9IChfYSA9IHRoaXMuY2xhc3NTb3J0YWJsZSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hW2dyb3VwSWR4XSkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmRlc3Ryb3koKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbGFzc1NvcnRhYmxlW2dyb3VwSWR4XSA9IFNvcnRhYmxlLmNyZWF0ZShub2RlLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBncm91cDogeyBuYW1lOiBcIm5lc3RlZFwiLCBwdWxsOiB0cnVlLCBwdXQ6IFtcIm5lc3RlZFwiXSB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YUlkQXR0cjogXCJjbGFzcy1zb3J0LXZhbHVlc1wiLFxuICAgICAgICAgICAgICAgICAgICAgICAgZ2hvc3RDbGFzczogXCJhdmF0YXJcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIG9uU29ydDogKCkgPT4gdGhpcy5oYW5kbGVTb3J0Q2xhc3Nlcyhncm91cElkeCksXG4gICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGU6IGAuY2xhc3MtaGFuZGxlYFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IH0sIGNsYXNzVmFsdWVzKSkpO1xuICAgIH1cbiAgICByZW5kZXJHcm91cEhhbmRsZU5vZGUoZ3JvdXBJZHgpIHtcbiAgICAgICAgY29uc3QgeyBzdHJpbmdzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgY29uc3QgaXNTaG93aW5nSW5wdXQgPSB0aGlzLnNlbGVjdGVkVmFsdWVUZXh0ID09PSBgJHtncm91cElkeH1gO1xuICAgICAgICByZXR1cm4gKGgoXCJkaXZcIiwgeyBjbGFzczogaXNTaG93aW5nSW5wdXQgPyBcImdyb3VwLWhhbmRsZS1kaXNhYmxlZFwiIDogXCJncm91cC1oYW5kbGVcIiwgXCJhcmlhLWhpZGRlblwiOiBcInRydWVcIiwgb25Nb3VzZU92ZXI6IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlZmVyZW5jZU5vZGUgPSBldmVudC50YXJnZXQ7XG4gICAgICAgICAgICAgICAgIWlzU2hvd2luZ0lucHV0ICYmXG4gICAgICAgICAgICAgICAgICAgIHRoaXMub25Nb3VzZU92ZXIoYHZhbHVlcy0ke2dyb3VwSWR4fS1oYW5kbGUtdG9vbHRpcGAsIHJlZmVyZW5jZU5vZGUsIHN0cmluZ3MucGFuZWxzLnR5cGUudG9vbHRpcHMuZHJhZ0dyb3VwKTtcbiAgICAgICAgICAgIH0sIG9uTW91c2VPdXQ6ICgpID0+IHRoaXMub25Nb3VzZU91dChgdmFsdWVzLSR7Z3JvdXBJZHh9LWhhbmRsZS10b29sdGlwYCkgfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcInNcIiwgaWNvbjogXCJkcmFnXCIgfSkpKTtcbiAgICB9XG4gICAgcmVuZGVyR3JvdXBUZXh0Tm9kZSh1bmlxdWVWYWx1ZUdyb3VwLCBncm91cElkeCkge1xuICAgICAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgICAgICBsZXQgZXZlbnRIYW5kbGVkID0gZmFsc2U7IC8vIHRvIHByZXZlbnQgZHVwbGljYXRlIGhhbmRsaW5nIGFuZCB1bm5lY2Vzc2FyeSB1cGRhdGVzIGZyb20gdGhlIHNhbWUgdXNlciBldmVudFxuICAgICAgICByZXR1cm4gKGgoRnJhZ21lbnQsIG51bGwsIGgoXCJjYWxjaXRlLWlucHV0XCIsIHsgY2xhc3M6IFwiaGlkZGVuXCIsIHZhbHVlOiB1bmlxdWVWYWx1ZUdyb3VwLmhlYWRpbmcgfHwgXCJcIiwgb25LZXlEb3duOiAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQua2V5ID09PSBcIkVzY2FwZVwiIHx8IGV2ZW50LmtleSA9PT0gXCJFbnRlclwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghZXZlbnRIYW5kbGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBldmVudEhhbmRsZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgbm9kZSA9IGV2ZW50LnRhcmdldDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlR3JvdXBUZXh0Q2hhbmdlKGdyb3VwSWR4LCBub2RlLnZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIG9uRm9jdXNvdXQ6IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghZXZlbnRIYW5kbGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50SGFuZGxlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG5vZGUgPSBldmVudC50YXJnZXQ7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlR3JvdXBUZXh0Q2hhbmdlKGdyb3VwSWR4LCBub2RlLnZhbHVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LCByZWY6IChub2RlKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKG5vZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5ncm91cElucHV0Tm9kZXNbZ3JvdXBJZHhdID0gbm9kZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IH0pLCBoKFwiZGl2XCIsIHsgY2xhc3M6IGBncm91cC10ZXh0IGdyb3VwLXRleHQtYWN0aXZlICR7dW5pcXVlVmFsdWVHcm91cC5oZWFkaW5nID8gXCJncm91cC1oZWFkaW5nXCIgOiBcIm5vLWdyb3VwLWhlYWRpbmdcIn1gLCByb2xlOiBcImJ1dHRvblwiLCB0YWJJbmRleDogMCwgXCJhcmlhLWxhYmVsXCI6IHN0cmluZ3MucGFuZWxzLnR5cGUuYWNjZXNzaWJpbGl0eS5lZGl0TGFiZWxGb3IucmVwbGFjZShcIiR7dmFsdWV9XCIsIHVuaXF1ZVZhbHVlR3JvdXAuaGVhZGluZyB8fCBzdHJpbmdzLnBhbmVscy50eXBlLmdyb3VwTmFtZUhpbnQpLCBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5vbk1vdXNlT3V0KGBncm91cC0ke2dyb3VwSWR4fS10ZXh0LXRvb2x0aXBgKTtcbiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUdyb3VwVGV4dENsaWNrKGdyb3VwSWR4KTtcbiAgICAgICAgICAgIH0sIG9uTW91c2VPdmVyOiAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCByZWZlcmVuY2VOb2RlID0gZXZlbnQudGFyZ2V0O1xuICAgICAgICAgICAgICAgIHRoaXMub25Nb3VzZU92ZXIoYGdyb3VwLSR7Z3JvdXBJZHh9LXRleHQtdG9vbHRpcGAsIHJlZmVyZW5jZU5vZGUsIHN0cmluZ3MucGFuZWxzLnR5cGUudG9vbHRpcHMucmVuYW1lR3JvdXApO1xuICAgICAgICAgICAgfSwgb25Nb3VzZU91dDogKCkgPT4gdGhpcy5vbk1vdXNlT3V0KGBncm91cC0ke2dyb3VwSWR4fS10ZXh0LXRvb2x0aXBgKSwgb25LZXlEb3duOiAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQua2V5ID09PSBcIiBcIiB8fCBldmVudC5rZXkgPT09IFwiRW50ZXJcIikge1xuICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVHcm91cFRleHRDbGljayhncm91cElkeCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgcmVmOiAobm9kZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChub2RlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZ3JvdXBUZXh0Tm9kZXNbZ3JvdXBJZHhdID0gbm9kZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IH0sIHVuaXF1ZVZhbHVlR3JvdXAuaGVhZGluZyB8fCBzdHJpbmdzLnBhbmVscy50eXBlLmdyb3VwTmFtZUhpbnQpKSk7XG4gICAgfVxuICAgIHJlbmRlclZhbHVlKHVuaXF1ZVZhbHVlQ2xhc3MsIGdyb3VwSWR4LCBjbGFzc0lkeCkge1xuICAgICAgICByZXR1cm4gKGgoXCJkaXZcIiwgeyBrZXk6IGB2YWx1ZXMtJHt1bmlxdWVWYWx1ZUNsYXNzLmxhYmVsfWAsIGNsYXNzOiBcInZhbHVlXCIsIFwiY2xhc3Mtc29ydC12YWx1ZXNcIjogYCR7Z3JvdXBJZHh9LyR7Y2xhc3NJZHh9YCB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IFwidmFsdWUtcGFydDFcIiB9LCB0aGlzLnJlbmRlckhhbmRsZU5vZGUoZ3JvdXBJZHgsIGNsYXNzSWR4KSwgdGhpcy5yZW5kZXJDaGVja05vZGUoZ3JvdXBJZHgsIGNsYXNzSWR4KSwgdGhpcy5yZW5kZXJTeW1ib2xOb2RlKHVuaXF1ZVZhbHVlQ2xhc3MsIGdyb3VwSWR4LCBjbGFzc0lkeCksIHRoaXMucmVuZGVyVGV4dE5vZGUodW5pcXVlVmFsdWVDbGFzcywgZ3JvdXBJZHgsIGNsYXNzSWR4KSksIGgoXCJkaXZcIiwgeyBjbGFzczogXCJ2YWx1ZS1wYXJ0MlwiIH0sIHRoaXMucmVuZGVyQ291bnROb2RlKHVuaXF1ZVZhbHVlQ2xhc3MpKSkpO1xuICAgIH1cbiAgICByZW5kZXJIYW5kbGVOb2RlKGdyb3VwSWR4LCBjbGFzc0lkeCkge1xuICAgICAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgICAgICBjb25zdCBpc1Nob3dpbmdJbnB1dCA9IHRoaXMuc2VsZWN0ZWRWYWx1ZVRleHQgPT09IGAke2dyb3VwSWR4fS8ke2NsYXNzSWR4fWA7XG4gICAgICAgIHJldHVybiAoaChcImRpdlwiLCB7IGNsYXNzOiBpc1Nob3dpbmdJbnB1dCA/IFwiY2xhc3MtaGFuZGxlLWRpc2FibGVkXCIgOiBcImNsYXNzLWhhbmRsZVwiLCBcImFyaWEtaGlkZGVuXCI6IFwidHJ1ZVwiLCBvbk1vdXNlT3ZlcjogKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVmZXJlbmNlTm9kZSA9IGV2ZW50LnRhcmdldDtcbiAgICAgICAgICAgICAgICB0aGlzLm9uTW91c2VPdmVyKGB2YWx1ZXMtJHtncm91cElkeH0tJHtjbGFzc0lkeH0taGFuZGxlLXRvb2x0aXBgLCByZWZlcmVuY2VOb2RlLCBzdHJpbmdzLnBhbmVscy50eXBlLnRvb2x0aXBzLmRyYWdUeXBlKTtcbiAgICAgICAgICAgIH0sIG9uTW91c2VPdXQ6ICgpID0+IHRoaXMub25Nb3VzZU91dChgdmFsdWVzLSR7Z3JvdXBJZHh9LSR7Y2xhc3NJZHh9LWhhbmRsZS10b29sdGlwYCkgfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcInNcIiwgaWNvbjogXCJkcmFnXCIgfSkpKTtcbiAgICB9XG4gICAgcmVuZGVyQ2hlY2tOb2RlKGdyb3VwSWR4LCBjbGFzc0lkeCwgbGFzdCkge1xuICAgICAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgICAgICBjb25zdCBpc0NoZWNrZWQgPSB0aGlzLmNoZWNrZWRDbGFzc2VzLmZpbmQoKGluZm8pID0+IGluZm8uZ3JvdXBJZHggPT09IGdyb3VwSWR4ICYmIGluZm8uY2xhc3NJZHggPT09IGNsYXNzSWR4KTtcbiAgICAgICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBzY2FsZTogXCJzXCIsIGljb246IGlzQ2hlY2tlZCA/IFwiY2hlY2stc3F1YXJlXCIgOiBcInNxdWFyZVwiLCB0ZXh0OiBzdHJpbmdzLnBhbmVscy50eXBlLmNoZWNrVmFsdWUsIGFwcGVhcmFuY2U6IFwidHJhbnNwYXJlbnRcIiwgb25DbGljazogKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3Qgbm9kZSA9IGV2ZW50LmN1cnJlbnRUYXJnZXQ7XG4gICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVDaGVjayhncm91cElkeCwgY2xhc3NJZHgsIG5vZGUpO1xuICAgICAgICAgICAgfSwgb25LZXlEb3duOiAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICB2YXIgX2E7XG4gICAgICAgICAgICAgICAgaWYgKGdyb3VwSWR4ID09PSAtMSAmJiBsYXN0ICYmICFldmVudC5zaGlmdEtleSAmJiBldmVudC5rZXkgPT09IFwiVGFiXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gc2VuZCBmb2N1cyB0byB0aGUgYWN0aW9ucyBwb3BvdmVyXG4gICAgICAgICAgICAgICAgICAgIChfYSA9IHRoaXMuYWN0aW9uc1BvcG92ZXJOb2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZm9jdXNBY3Rpb25QYWQoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LCByZWY6IChub2RlKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGdyb3VwSWR4ID09PSAtMSAmJiBsYXN0KSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubGFzdE90aGVyVmFsdWVDaGVja05vZGUgPSBub2RlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gfSkpO1xuICAgIH1cbiAgICByZW5kZXJTeW1ib2xOb2RlKHVuaXF1ZVZhbHVlQ2xhc3MsIGdyb3VwSWR4LCBjbGFzc0lkeCkge1xuICAgICAgICBjb25zdCB7IGxheWVyLCBzdHJpbmdzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgY29uc3Qgc3ltYm9sTm9kZUNsYXNzZXMgPSB7XG4gICAgICAgICAgICBcInZhbHVlLXN5bWJvbFwiOiB0cnVlLFxuICAgICAgICAgICAgXCJzeW1ib2wtaXMtd2hpdGVcIjogaXNTeW1ib2xBbG1vc3RXaGl0ZSh1bmlxdWVWYWx1ZUNsYXNzLnN5bWJvbClcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3Qgc3ltYm9sQ2xhc3NlcyA9IHtcbiAgICAgICAgICAgIFwic3ltYm9sXCI6IHRydWUsXG4gICAgICAgICAgICBbZ2V0R2VvbWV0cnlUeXBlKGxheWVyKV06IHRydWUsXG4gICAgICAgICAgICBcInN5bWJvbC1zZWxlY3Rvci0tc2VsZWN0ZWRcIjogdGhpcy5zZWxlY3RlZFZhbHVlID09PSBgJHtncm91cElkeH0vJHtjbGFzc0lkeH1gXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiAoaChcImRpdlwiLCB7IGNsYXNzOiBzeW1ib2xOb2RlQ2xhc3Nlcywgb25DbGljazogKCkgPT4gdGhpcy5oYW5kbGVWYWx1ZVN5bWJvbENsaWNrKGdyb3VwSWR4LCBjbGFzc0lkeCksIHJvbGU6IFwiYnV0dG9uXCIsIFwiYXJpYS1sYWJlbFwiOiBzdHJpbmdzLnBhbmVscy50eXBlLmFjY2Vzc2liaWxpdHkuZWRpdFN5bWJvbEZvci5yZXBsYWNlKFwiJHt2YWx1ZX1cIiwgdW5pcXVlVmFsdWVDbGFzcy5sYWJlbCksIFwiYXJpYS1oYXNwb3B1cFwiOiBcInRydWVcIiwgXCJhcmlhLWV4cGFuZGVkXCI6IHRoaXMuc2VsZWN0ZWRWYWx1ZSA9PT0gYCR7Z3JvdXBJZHh9LyR7Y2xhc3NJZHh9YCwgb25Nb3VzZU92ZXI6IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlZmVyZW5jZU5vZGUgPSBldmVudC50YXJnZXQ7XG4gICAgICAgICAgICAgICAgdGhpcy5vbk1vdXNlT3ZlcihgdmFsdWVzLSR7Z3JvdXBJZHh9LSR7Y2xhc3NJZHh9LWljb24tdG9vbHRpcGAsIHJlZmVyZW5jZU5vZGUsIHN0cmluZ3MucGFuZWxzLnR5cGUudG9vbHRpcHMuY2hhbmdlU3ltYm9sKTtcbiAgICAgICAgICAgIH0sIG9uTW91c2VPdXQ6ICgpID0+IHRoaXMub25Nb3VzZU91dChgdmFsdWVzLSR7Z3JvdXBJZHh9LSR7Y2xhc3NJZHh9LWljb24tdG9vbHRpcGApLCBvbktleURvd246IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChldmVudC5rZXkgPT09IFwiIFwiIHx8IGV2ZW50LmtleSA9PT0gXCJFbnRlclwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVZhbHVlU3ltYm9sQ2xpY2soZ3JvdXBJZHgsIGNsYXNzSWR4KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IH0sIGgoXCJkaXZcIiwgeyBjbGFzczogc3ltYm9sQ2xhc3NlcywgdGFiSW5kZXg6IDAsIHJlZjogKG5vZGUpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAobm9kZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuc3ltYm9sTm9kZXNbZ3JvdXBJZHhdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN5bWJvbE5vZGVzW2dyb3VwSWR4XSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3ltYm9sTm9kZXNbZ3JvdXBJZHhdW2NsYXNzSWR4XSA9IG5vZGU7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYWZ0ZXJDcmVhdGVWYWx1ZVN5bWJvbChncm91cElkeCwgY2xhc3NJZHgsIG5vZGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIFwiYXJpYS1oaWRkZW5cIjogXCJ0cnVlXCIgfSkpKTtcbiAgICB9XG4gICAgcmVuZGVyVGV4dE5vZGUodW5pcXVlVmFsdWVDbGFzcywgZ3JvdXBJZHgsIGNsYXNzSWR4KSB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgY29uc3QgeyBzdHJpbmdzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgbGV0IGV2ZW50SGFuZGxlZCA9IGZhbHNlOyAvLyB0byBwcmV2ZW50IGR1cGxpY2F0ZSBoYW5kbGluZyBhbmQgdW5uZWNlc3NhcnkgdXBkYXRlcyBmcm9tIHRoZSBzYW1lIHVzZXIgZXZlbnRcbiAgICAgICAgcmV0dXJuIChoKEZyYWdtZW50LCBudWxsLCBoKFwiY2FsY2l0ZS1pbnB1dFwiLCB7IGNsYXNzOiBcImhpZGRlblwiLCB2YWx1ZTogdW5pcXVlVmFsdWVDbGFzcy5sYWJlbCwgb25LZXlEb3duOiAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQua2V5ID09PSBcIkVzY2FwZVwiIHx8IGV2ZW50LmtleSA9PT0gXCJFbnRlclwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWV2ZW50SGFuZGxlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRIYW5kbGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5vZGUgPSBldmVudC50YXJnZXQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVZhbHVlVGV4dENoYW5nZShncm91cElkeCwgY2xhc3NJZHgsIG5vZGUudmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgb25Gb2N1c291dDogKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFldmVudEhhbmRsZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgZXZlbnRIYW5kbGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgbm9kZSA9IGV2ZW50LnRhcmdldDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVWYWx1ZVRleHRDaGFuZ2UoZ3JvdXBJZHgsIGNsYXNzSWR4LCBub2RlLnZhbHVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LCByZWY6IChub2RlKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKG5vZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLnZhbHVlSW5wdXROb2Rlc1tncm91cElkeF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudmFsdWVJbnB1dE5vZGVzW2dyb3VwSWR4XSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudmFsdWVJbnB1dE5vZGVzW2dyb3VwSWR4XVtjbGFzc0lkeF0gPSBub2RlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gfSksIGgoXCJkaXZcIiwgeyBjbGFzczogXCJ2YWx1ZS10ZXh0XCIsIHJvbGU6IFwiYnV0dG9uXCIsIHRhYkluZGV4OiAwLCBcImFyaWEtbGFiZWxcIjogc3RyaW5ncy5wYW5lbHMudHlwZS5hY2Nlc3NpYmlsaXR5LmVkaXRMYWJlbEZvci5yZXBsYWNlKFwiJHt2YWx1ZX1cIiwgdW5pcXVlVmFsdWVDbGFzcy5sYWJlbCksIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uTW91c2VPdXQoYHZhbHVlLSR7Z3JvdXBJZHh9LSR7Y2xhc3NJZHh9LXRleHQtdG9vbHRpcGApO1xuICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlVmFsdWVUZXh0Q2xpY2soZ3JvdXBJZHgsIGNsYXNzSWR4KTtcbiAgICAgICAgICAgIH0sIG9uTW91c2VPdmVyOiAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCByZWZlcmVuY2VOb2RlID0gZXZlbnQudGFyZ2V0O1xuICAgICAgICAgICAgICAgIHRoaXMub25Nb3VzZU92ZXIoYHZhbHVlLSR7Z3JvdXBJZHh9LSR7Y2xhc3NJZHh9LXRleHQtdG9vbHRpcGAsIHJlZmVyZW5jZU5vZGUsIHN0cmluZ3MucGFuZWxzLnR5cGUudG9vbHRpcHMucmVuYW1lVHlwZSk7XG4gICAgICAgICAgICB9LCBvbk1vdXNlT3V0OiAoKSA9PiB0aGlzLm9uTW91c2VPdXQoYHZhbHVlLSR7Z3JvdXBJZHh9LSR7Y2xhc3NJZHh9LXRleHQtdG9vbHRpcGApLCBvbktleURvd246IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChldmVudC5rZXkgPT09IFwiIFwiIHx8IGV2ZW50LmtleSA9PT0gXCJFbnRlclwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVZhbHVlVGV4dENsaWNrKGdyb3VwSWR4LCBjbGFzc0lkeCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFldmVudC5zaGlmdEtleSAmJiBldmVudC5rZXkgPT09IFwiVGFiXCIgJiYgZ3JvdXBJZHggPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgbGF5ZXIgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCByZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3RoZXJVbmlxdWVWYWx1ZUluZm9zID0gZ2V0T3RoZXJVbmlxdWVWYWx1ZUluZm9zKCk7XG4gICAgICAgICAgICAgICAgICAgIGxldCByZW5kZXJlckNsYXNzQ291bnQgPSAwO1xuICAgICAgICAgICAgICAgICAgICByZW5kZXJlci51bmlxdWVWYWx1ZUdyb3Vwcy5mb3JFYWNoKCh1bmlxdWVWYWx1ZUdyb3VwKSA9PiAocmVuZGVyZXJDbGFzc0NvdW50ICs9IHVuaXF1ZVZhbHVlR3JvdXAuY2xhc3Nlcy5sZW5ndGgpKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaGFzT3RoZXJWYWx1ZXMgPSAhIShvdGhlclVuaXF1ZVZhbHVlSW5mb3MgPT09IG51bGwgfHwgb3RoZXJVbmlxdWVWYWx1ZUluZm9zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvdGhlclVuaXF1ZVZhbHVlSW5mb3MubGVuZ3RoKSAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgIShvdGhlclVuaXF1ZVZhbHVlSW5mb3MubGVuZ3RoID09PSAxICYmICFvdGhlclVuaXF1ZVZhbHVlSW5mb3NbMF0udmFsdWUpICYmXG4gICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJlckNsYXNzQ291bnQgPCAyMDA7XG4gICAgICAgICAgICAgICAgICAgIGlmICghaGFzT3RoZXJWYWx1ZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNlbmQgZm9jdXMgdG8gdGhlIGFjdGlvbnMgcG9wb3ZlclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3Rpb25zUG9wb3Zlck5vZGUuZm9jdXNBY3Rpb25QYWQoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIHJlZjogKG5vZGUpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAobm9kZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZ3JvdXBJZHggPT09IC0xICYmIGNsYXNzSWR4ID09PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vdGhlclRleHROb2RlID0gbm9kZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy52YWx1ZVRleHROb2Rlc1tncm91cElkeF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZhbHVlVGV4dE5vZGVzW2dyb3VwSWR4XSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy52YWx1ZVRleHROb2Rlc1tncm91cElkeF1bY2xhc3NJZHhdID0gbm9kZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gfSwgKChfYSA9IHVuaXF1ZVZhbHVlQ2xhc3MubGFiZWwpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS50cmltKCkubGVuZ3RoKVxuICAgICAgICAgICAgPyB1bmlxdWVWYWx1ZUNsYXNzLmxhYmVsXG4gICAgICAgICAgICA6IC8vIGFkZGluZyBuYnNwIGVsZW1lbnRzIGlmIGxhYmVsIGNvbnRhaW5zIG9ubHkgd2hpdGVzcGFjZSB0byBlbnN1cmUgdXNlciBjYW4gc2VsZWN0XG4gICAgICAgICAgICAgICAgXCJcXHUwMEEwXFx1MDBBMFxcdTAwQTBcXHUwMEEwXFx1MDBBMFxcdTAwQTBcIikpKTtcbiAgICB9XG4gICAgcmVuZGVyQ291bnROb2RlKHVuaXF1ZVZhbHVlQ2xhc3MpIHtcbiAgICAgICAgY29uc3QgeyBhbGxVbmlxdWVWYWx1ZXMsIHN0cmluZ3MgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgICAgICBpZiAoIShhbGxVbmlxdWVWYWx1ZXMgPT09IG51bGwgfHwgYWxsVW5pcXVlVmFsdWVzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhbGxVbmlxdWVWYWx1ZXMubGVuZ3RoKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGxldCBjb3VudCA9IHVuZGVmaW5lZDtcbiAgICAgICAgaWYgKHVuaXF1ZVZhbHVlQ2xhc3MudmFsdWVzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgIGNvdW50ID0gdW5pcXVlVmFsdWVDbGFzcy52YWx1ZXMucmVkdWNlKChtZXJnZWRDb3VudCwgdmFsdWUpID0+IHtcbiAgICAgICAgICAgICAgICB2YXIgX2E7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG1lcmdlZENvdW50ICsgKChfYSA9IHRoaXMuZ2V0VW5pcXVlVmFsdWUodmFsdWUudmFsdWUpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY291bnQpIHx8IDA7XG4gICAgICAgICAgICB9LCAwKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gdW5pcXVlVmFsdWVDbGFzcy52YWx1ZXNbMF0udmFsdWU7XG4gICAgICAgICAgICBjb25zdCBpbmZvID0gdGhpcy5nZXRVbmlxdWVWYWx1ZSh2YWx1ZSk7XG4gICAgICAgICAgICBpZiAoaW5mbyAmJiAhaXNEZWZpbmVkKGluZm8uY291bnQpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmICghaW5mbyAmJiAoYWxsVW5pcXVlVmFsdWVzID09PSBudWxsIHx8IGFsbFVuaXF1ZVZhbHVlcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYWxsVW5pcXVlVmFsdWVzLmxlbmd0aCkpIHtcbiAgICAgICAgICAgICAgICAvLyBpZiAhaW5mbyBtdXN0IGJlIGEgdXNlciBhZGRlZCB2YWx1ZTsgZGlzcGxheSAwIGlmIG90aGVyIHZhbHVlcyBoYXZlIGEgY291bnRcbiAgICAgICAgICAgICAgICBjb25zdCBmaXJzdEluZm8gPSB0aGlzLmdldFVuaXF1ZVZhbHVlKGFsbFVuaXF1ZVZhbHVlc1swXS52YWx1ZSk7XG4gICAgICAgICAgICAgICAgaWYgKCFpc0RlZmluZWQoZmlyc3RJbmZvID09PSBudWxsIHx8IGZpcnN0SW5mbyA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmlyc3RJbmZvLmNvdW50KSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb3VudCA9ICFpbmZvID8gMCA6IGluZm8uY291bnQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIChoKFwiZGl2XCIsIHsgY2xhc3M6IFwidmFsdWUtY291bnRcIiwgXCJhcmlhLWxhYmVsXCI6IHN0cmluZ3MucGFuZWxzLnR5cGUuYWNjZXNzaWJpbGl0eS5jb3VudEZvci5yZXBsYWNlKFwiJHt2YWx1ZX1cIiwgdW5pcXVlVmFsdWVDbGFzcy5sYWJlbCkgfSwgYCR7Y291bnR9YCkpO1xuICAgIH1cbiAgICByZW5kZXJHcm91cENvdW50Tm9kZSh1bmlxdWVWYWx1ZUdyb3VwKSB7XG4gICAgICAgIGNvbnN0IHsgYWxsVW5pcXVlVmFsdWVzLCBzdHJpbmdzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgaWYgKCEoYWxsVW5pcXVlVmFsdWVzID09PSBudWxsIHx8IGFsbFVuaXF1ZVZhbHVlcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYWxsVW5pcXVlVmFsdWVzLmxlbmd0aCkpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBsZXQgdG90YWxDb3VudCA9IDA7XG4gICAgICAgIHVuaXF1ZVZhbHVlR3JvdXAuY2xhc3Nlcy5mb3JFYWNoKCh1bmlxdWVWYWx1ZUNsYXNzKSA9PiB7XG4gICAgICAgICAgICB1bmlxdWVWYWx1ZUNsYXNzLnZhbHVlcy5mb3JFYWNoKCh2YWx1ZSkgPT4ge1xuICAgICAgICAgICAgICAgIHZhciBfYTtcbiAgICAgICAgICAgICAgICBjb25zdCBpbmZvID0gdGhpcy5nZXRVbmlxdWVWYWx1ZSh2YWx1ZS52YWx1ZSk7XG4gICAgICAgICAgICAgICAgaWYgKGluZm8gJiYgIWlzRGVmaW5lZChpbmZvLmNvdW50KSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFpbmZvICYmIChhbGxVbmlxdWVWYWx1ZXMgPT09IG51bGwgfHwgYWxsVW5pcXVlVmFsdWVzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhbGxVbmlxdWVWYWx1ZXMubGVuZ3RoKSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBpZiAhaW5mbyBtdXN0IGJlIGEgdXNlciBhZGRlZCB2YWx1ZTsgZGlzcGxheSAwIGlmIG90aGVyIHZhbHVlcyBoYXZlIGEgY291bnRcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmlyc3RJbmZvID0gdGhpcy5nZXRVbmlxdWVWYWx1ZShhbGxVbmlxdWVWYWx1ZXNbMF0udmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWlzRGVmaW5lZChmaXJzdEluZm8gPT09IG51bGwgfHwgZmlyc3RJbmZvID09PSB2b2lkIDAgPyB2b2lkIDAgOiBmaXJzdEluZm8uY291bnQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdG90YWxDb3VudCArPSAoX2EgPSBpbmZvID09PSBudWxsIHx8IGluZm8gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGluZm8uY291bnQpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IDA7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiAoaChcImRpdlwiLCB7IGNsYXNzOiBcImdyb3VwLWNvdW50XCIsIFwiYXJpYS1sYWJlbFwiOiBzdHJpbmdzLnBhbmVscy50eXBlLmFjY2Vzc2liaWxpdHkuY291bnRGb3IucmVwbGFjZShcIiR7dmFsdWV9XCIsIHVuaXF1ZVZhbHVlR3JvdXAuaGVhZGluZykgfSwgYCR7IWFsbFVuaXF1ZVZhbHVlcyA/IFwiXCIgOiB0b3RhbENvdW50fWApKTtcbiAgICB9XG4gICAgcmVuZGVyR3JvdXBNZW51Tm9kZShncm91cElkeCwgdW5pcXVlVmFsdWVHcm91cCkge1xuICAgICAgICBjb25zdCB7IGxheWVyLCBzdHJpbmdzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcik7XG4gICAgICAgIGNvbnN0IGdyb3VwcyA9IHJlbmRlcmVyLnVuaXF1ZVZhbHVlR3JvdXBzO1xuICAgICAgICBsZXQgY2FuU2VsZWN0ID0gZmFsc2U7XG4gICAgICAgIGxldCBoYXNNZXJnZWRWYWx1ZXMgPSBmYWxzZTtcbiAgICAgICAgbGV0IG90aGVyVmFsdWVDbGFzc2VzO1xuICAgICAgICBpZiAoZ3JvdXBJZHggPT09IC0xKSB7XG4gICAgICAgICAgICBvdGhlclZhbHVlQ2xhc3NlcyA9IGdldE90aGVyVW5pcXVlVmFsdWVDbGFzc2VzKCk7XG4gICAgICAgICAgICAvLyBkb24ndCBzaG93IG1vcmUgdGhhbiAyMDAgdmFsdWVzIHRvdGFsXG4gICAgICAgICAgICBsZXQgY291bnRDdXJyZW50Q2xhc3NlcyA9IDA7XG4gICAgICAgICAgICByZW5kZXJlci51bmlxdWVWYWx1ZUdyb3Vwcy5mb3JFYWNoKCh1bmlxdWVWYWx1ZUdyb3VwKSA9PiB7IHZhciBfYSwgX2I7IHJldHVybiAoY291bnRDdXJyZW50Q2xhc3NlcyArPSAoX2IgPSAoX2EgPSB1bmlxdWVWYWx1ZUdyb3VwLmNsYXNzZXMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpICE9PSBudWxsICYmIF9iICE9PSB2b2lkIDAgPyBfYiA6IDApOyB9KTtcbiAgICAgICAgICAgIGlmIChjb3VudEN1cnJlbnRDbGFzc2VzICsgb3RoZXJWYWx1ZUNsYXNzZXMubGVuZ3RoID4gMjAwKSB7XG4gICAgICAgICAgICAgICAgb3RoZXJWYWx1ZUNsYXNzZXMgPSBvdGhlclZhbHVlQ2xhc3Nlcy5zbGljZSgwLCAyMDAgLSBjb3VudEN1cnJlbnRDbGFzc2VzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhblNlbGVjdCA9ICEhb3RoZXJWYWx1ZUNsYXNzZXMuZmluZCgoXywgaWR4KSA9PiAhdGhpcy5jaGVja2VkQ2xhc3Nlcy5maW5kKChpbmZvKSA9PiBpbmZvLmdyb3VwSWR4ID09PSAtMSAmJiBpbmZvLmNsYXNzSWR4ID09PSBpZHgpKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGNhblNlbGVjdCA9ICEhKHVuaXF1ZVZhbHVlR3JvdXAgPT09IG51bGwgfHwgdW5pcXVlVmFsdWVHcm91cCA9PT0gdm9pZCAwID8gdm9pZCAwIDogdW5pcXVlVmFsdWVHcm91cC5jbGFzc2VzLmZpbmQoKF8sIGlkeCkgPT4gIXRoaXMuY2hlY2tlZENsYXNzZXMuZmluZCgoaW5mbykgPT4gaW5mby5ncm91cElkeCA9PT0gZ3JvdXBJZHggJiYgaW5mby5jbGFzc0lkeCA9PT0gaWR4KSkpO1xuICAgICAgICAgICAgaGFzTWVyZ2VkVmFsdWVzID0gISEodW5pcXVlVmFsdWVHcm91cCA9PT0gbnVsbCB8fCB1bmlxdWVWYWx1ZUdyb3VwID09PSB2b2lkIDAgPyB2b2lkIDAgOiB1bmlxdWVWYWx1ZUdyb3VwLmNsYXNzZXMuZmluZCgodXZDbGFzcykgPT4gdXZDbGFzcy52YWx1ZXMubGVuZ3RoID4gMSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAoaChcImNhbGNpdGUtZHJvcGRvd25cIiwgeyBwbGFjZW1lbnQ6IFwiYm90dG9tLWVuZFwiLCBzY2FsZTogXCJzXCIsIG92ZXJsYXlQb3NpdGlvbmluZzogXCJhYnNvbHV0ZVwiLCByZWY6IChub2RlKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKG5vZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5ncm91cE1lbnVOb2Rlc1tncm91cElkeF0gPSBub2RlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gfSwgaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgc2xvdDogXCJ0cmlnZ2VyXCIsIHNjYWxlOiBcInNcIiwgdGV4dDogc3RyaW5ncy5wYW5lbHMudHlwZS50b29sdGlwcy5vcHRpb25zIH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBzY2FsZTogXCJzXCIsIGljb246IFwiZWxsaXBzaXNcIiB9KSksIGgoXCJjYWxjaXRlLWRyb3Bkb3duLWdyb3VwXCIsIHsgXCJzZWxlY3Rpb24tbW9kZVwiOiBcIm5vbmVcIiB9LCBoKFwiY2FsY2l0ZS1kcm9wZG93bi1pdGVtXCIsIHsgXCJpY29uLXN0YXJ0XCI6IFwicGluLXBsdXNcIiwgbGFiZWw6IHN0cmluZ3MucGFuZWxzLnR5cGUuYWRkVmFsdWUsIG9uQ2xpY2s6ICgpID0+IHRoaXMuaGFuZGxlQWRkVmFsdWUoZ3JvdXBJZHgpLCBvbktleURvd246IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgIGlmIChldmVudC5rZXkgPT09IFwiIFwiIHx8IGV2ZW50LmtleSA9PT0gXCJFbnRlclwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlQWRkVmFsdWUoZ3JvdXBJZHgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gfSwgc3RyaW5ncy5wYW5lbHMudHlwZS5hZGRWYWx1ZSksIGdyb3Vwcy5sZW5ndGggPiAwICYmIChoKFwiY2FsY2l0ZS1kcm9wZG93bi1pdGVtXCIsIHsgXCJpY29uLXN0YXJ0XCI6IFwicGFsZXR0ZVwiLCBsYWJlbDogc3RyaW5ncy5wYW5lbHMudHlwZS5jaGFuZ2VDb2xvcnMsIG9uQ2xpY2s6ICgpID0+IHRoaXMub3BlblN5bWJvbFN0eWxlckZvckdyb3VwKGdyb3VwSWR4KSwgb25LZXlEb3duOiAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQua2V5ID09PSBcIiBcIiB8fCBldmVudC5rZXkgPT09IFwiRW50ZXJcIikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm9wZW5TeW1ib2xTdHlsZXJGb3JHcm91cChncm91cElkeCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSB9LCBzdHJpbmdzLnBhbmVscy50eXBlLmNoYW5nZUNvbG9ycykpKSwgaChcImNhbGNpdGUtZHJvcGRvd24tZ3JvdXBcIiwgeyBcInNlbGVjdGlvbi1tb2RlXCI6IFwibm9uZVwiIH0sIGNhblNlbGVjdCAmJiAoaChcImNhbGNpdGUtZHJvcGRvd24taXRlbVwiLCB7IFwiaWNvbi1zdGFydFwiOiBcImNoZWNrLWNpcmNsZVwiLCBsYWJlbDogc3RyaW5ncy5wYW5lbHMudHlwZS5zZWxlY3RBbGxWYWx1ZXMsIG9uQ2xpY2s6ICgpID0+IHRoaXMuaGFuZGxlU2VsZWN0QWxsVmFsdWVzKGdyb3VwSWR4KSwgb25LZXlEb3duOiAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQua2V5ID09PSBcIiBcIiB8fCBldmVudC5rZXkgPT09IFwiRW50ZXJcIikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVNlbGVjdEFsbFZhbHVlcyhncm91cElkeCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSB9LCBzdHJpbmdzLnBhbmVscy50eXBlLnNlbGVjdEFsbFZhbHVlcykpLCBoYXNNZXJnZWRWYWx1ZXMgJiYgKGgoXCJjYWxjaXRlLWRyb3Bkb3duLWl0ZW1cIiwgeyBcImljb24tc3RhcnRcIjogXCJncm91cC14XCIsIGxhYmVsOiBzdHJpbmdzLnBhbmVscy50eXBlLnNlcGFyYXRlVmFsdWVzLCBvbkNsaWNrOiAoKSA9PiB0aGlzLmhhbmRsZVNlcGFyYXRlVmFsdWVzKGdyb3VwSWR4KSwgb25LZXlEb3duOiAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQua2V5ID09PSBcIiBcIiB8fCBldmVudC5rZXkgPT09IFwiRW50ZXJcIikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVNlcGFyYXRlVmFsdWVzKGdyb3VwSWR4KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IH0sIHN0cmluZ3MucGFuZWxzLnR5cGUuc2VwYXJhdGVWYWx1ZXMpKSwgZ3JvdXBJZHggPiAwICYmIChoKFwiY2FsY2l0ZS1kcm9wZG93bi1pdGVtXCIsIHsgXCJpY29uLXN0YXJ0XCI6IFwiYXJyb3ctYm9sZC11cFwiLCBsYWJlbDogc3RyaW5ncy5wYW5lbHMudHlwZS5tb3ZlVXAsIG9uQ2xpY2s6ICgpID0+IHRoaXMuaGFuZGxlR3JvdXBNb3ZlVXAoZ3JvdXBJZHgpLCBvbktleURvd246IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgIGlmIChldmVudC5rZXkgPT09IFwiIFwiIHx8IGV2ZW50LmtleSA9PT0gXCJFbnRlclwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlR3JvdXBNb3ZlVXAoZ3JvdXBJZHgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gfSwgc3RyaW5ncy5wYW5lbHMudHlwZS5tb3ZlVXApKSwgZ3JvdXBzLmxlbmd0aCA+IDAgJiYgZ3JvdXBJZHggPCBncm91cHMubGVuZ3RoIC0gMSAmJiAoaChcImNhbGNpdGUtZHJvcGRvd24taXRlbVwiLCB7IFwiaWNvbi1zdGFydFwiOiBcImFycm93LWJvbGQtZG93blwiLCBsYWJlbDogc3RyaW5ncy5wYW5lbHMudHlwZS5tb3ZlRG93biwgb25DbGljazogKCkgPT4gdGhpcy5oYW5kbGVHcm91cE1vdmVEb3duKGdyb3VwSWR4KSwgb25LZXlEb3duOiAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQua2V5ID09PSBcIiBcIiB8fCBldmVudC5rZXkgPT09IFwiRW50ZXJcIikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUdyb3VwTW92ZURvd24oZ3JvdXBJZHgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gfSwgc3RyaW5ncy5wYW5lbHMudHlwZS5tb3ZlRG93bikpKSkpO1xuICAgIH1cbiAgICByZW5kZXJEZWZhdWx0VmFsdWUoKSB7XG4gICAgICAgIGNvbnN0IHsgbGF5ZXIsIGxhc3REZWZhdWx0LCBzdHJpbmdzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcik7XG4gICAgICAgIGNvbnN0IGRlZmF1bHRTeW1ib2wgPSByZW5kZXJlci5kZWZhdWx0U3ltYm9sIHx8IGxhc3REZWZhdWx0LmRlZmF1bHRTeW1ib2w7XG4gICAgICAgIGNvbnN0IGRlZmF1bHRMYWJlbCA9IHJlbmRlcmVyLmRlZmF1bHRMYWJlbCB8fCBsYXN0RGVmYXVsdC5kZWZhdWx0TGFiZWw7XG4gICAgICAgIGNvbnN0IG90aGVyVW5pcXVlVmFsdWVJbmZvcyA9IGdldE90aGVyVW5pcXVlVmFsdWVJbmZvcygpO1xuICAgICAgICBjb25zdCBvdGhlckNvdW50ID0gb3RoZXJVbmlxdWVWYWx1ZUluZm9zID8gdGhpcy5nZXRPdGhlckNvdW50KG90aGVyVW5pcXVlVmFsdWVJbmZvcykgOiAtMTtcbiAgICAgICAgbGV0IHJlbmRlcmVyQ2xhc3NDb3VudCA9IDA7XG4gICAgICAgIHJlbmRlcmVyLnVuaXF1ZVZhbHVlR3JvdXBzLmZvckVhY2goKHVuaXF1ZVZhbHVlR3JvdXApID0+IChyZW5kZXJlckNsYXNzQ291bnQgKz0gdW5pcXVlVmFsdWVHcm91cC5jbGFzc2VzLmxlbmd0aCkpO1xuICAgICAgICBjb25zdCBoYXNPdGhlclZhbHVlcyA9ICEhKG90aGVyVW5pcXVlVmFsdWVJbmZvcyA9PT0gbnVsbCB8fCBvdGhlclVuaXF1ZVZhbHVlSW5mb3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG90aGVyVW5pcXVlVmFsdWVJbmZvcy5sZW5ndGgpICYmIHJlbmRlcmVyQ2xhc3NDb3VudCA8IDIwMDtcbiAgICAgICAgY29uc3QgaGFzT25seU51bGxWYWx1ZSA9IGhhc090aGVyVmFsdWVzICYmIG90aGVyVW5pcXVlVmFsdWVJbmZvcy5sZW5ndGggPT09IDEgJiYgIW90aGVyVW5pcXVlVmFsdWVJbmZvc1swXS52YWx1ZTtcbiAgICAgICAgY29uc3Qgc3ltYm9sTm9kZUNsYXNzZXMgPSB7XG4gICAgICAgICAgICBcInZhbHVlLXN5bWJvbFwiOiB0cnVlLFxuICAgICAgICAgICAgXCJzeW1ib2wtaXMtd2hpdGVcIjogaXNTeW1ib2xBbG1vc3RXaGl0ZShkZWZhdWx0U3ltYm9sKVxuICAgICAgICB9O1xuICAgICAgICBjb25zdCBzeW1ib2xDbGFzc2VzID0ge1xuICAgICAgICAgICAgXCJzeW1ib2xcIjogdHJ1ZSxcbiAgICAgICAgICAgIFtnZXRHZW9tZXRyeVR5cGUobGF5ZXIpXTogdHJ1ZSxcbiAgICAgICAgICAgIFwic3ltYm9sLXNlbGVjdG9yLS1zZWxlY3RlZFwiOiB0aGlzLnNlbGVjdGVkVmFsdWUgPT09IGAtMWBcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIChoKFwiZGl2XCIsIHsgY2xhc3M6IGB2YWx1ZSAke2hhc090aGVyVmFsdWVzID8gXCJkZWZhdWx0LXZhbHVlXCIgOiBcIlwifWAgfSwgaChcImRpdlwiLCB7IGNsYXNzOiBcInZhbHVlLXBhcnQxXCIgfSwgaChcImNhbGNpdGUtY2hlY2tib3hcIiwgeyBzY2FsZTogXCJzXCIsIGNoZWNrZWQ6ICEhcmVuZGVyZXIuZGVmYXVsdFN5bWJvbCwgb25Nb3VzZU92ZXI6IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlZmVyZW5jZU5vZGUgPSBldmVudC50YXJnZXQ7XG4gICAgICAgICAgICAgICAgdGhpcy5vbk1vdXNlT3ZlcihcImRlZmF1bHQtdmFsdWUtY2hlY2tib3gtdG9vbHRpcFwiLCByZWZlcmVuY2VOb2RlLCBzdHJpbmdzLnBhbmVscy50eXBlLnRvb2x0aXBzLm90aGVyVG9vbHRpcCk7XG4gICAgICAgICAgICB9LCBvbk1vdXNlT3V0OiAoKSA9PiB0aGlzLm9uTW91c2VPdXQoXCJkZWZhdWx0LXZhbHVlLWNoZWNrYm94LXRvb2x0aXBcIiksIG9uQ2xpY2s6ICgpID0+IHRoaXMuaGFuZGxlRGVmYXVsdENoZWNrQ2hhbmdlKCkgfSksIGgoXCJkaXZcIiwgeyBjbGFzczogc3ltYm9sTm9kZUNsYXNzZXMsIG9uQ2xpY2s6ICgpID0+IHRoaXMuaGFuZGxlVmFsdWVTeW1ib2xDbGljaygtMSwgMCksIHJvbGU6IFwiYnV0dG9uXCIsIFwiYXJpYS1oYXNwb3B1cFwiOiBcInRydWVcIiwgXCJhcmlhLWV4cGFuZGVkXCI6IHRoaXMuc2VsZWN0ZWRWYWx1ZSA9PT0gYC0xLzBgLCBcImFyaWEtbGFiZWxcIjogc3RyaW5ncy5wYW5lbHMudHlwZS5hY2Nlc3NpYmlsaXR5LmVkaXRTeW1ib2xGb3IucmVwbGFjZShcIiR7ZmllbGROYW1lfVwiLCBkZWZhdWx0TGFiZWwpLCBvbk1vdXNlT3ZlcjogKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVmZXJlbmNlTm9kZSA9IGV2ZW50LnRhcmdldDtcbiAgICAgICAgICAgICAgICB0aGlzLm9uTW91c2VPdmVyKFwiZGVmYXVsdC12YWx1ZS1zeW1ib2wtdG9vbHRpcFwiLCByZWZlcmVuY2VOb2RlLCBzdHJpbmdzLnBhbmVscy50eXBlLnRvb2x0aXBzLmNoYW5nZVN5bWJvbCk7XG4gICAgICAgICAgICB9LCBvbk1vdXNlT3V0OiAoKSA9PiB0aGlzLm9uTW91c2VPdXQoXCJkZWZhdWx0LXZhbHVlLXN5bWJvbC10b29sdGlwXCIpLCBvbktleURvd246IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChldmVudC5rZXkgPT09IFwiIFwiIHx8IGV2ZW50LmtleSA9PT0gXCJFbnRlclwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVZhbHVlU3ltYm9sQ2xpY2soLTEsIDApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gfSwgaChcImRpdlwiLCB7IGNsYXNzOiBzeW1ib2xDbGFzc2VzLCB0YWJJbmRleDogMCwgcmVmOiAobm9kZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChub2RlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5zeW1ib2xOb2Rlc1stMV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3ltYm9sTm9kZXNbLTFdID0gW107XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zeW1ib2xOb2Rlc1stMV1bMF0gPSBub2RlO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFmdGVyQ3JlYXRlVmFsdWVTeW1ib2woLTEsIDAsIG5vZGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIFwiYXJpYS1oaWRkZW5cIjogXCJ0cnVlXCIgfSkpLCB0aGlzLnJlbmRlclRleHROb2RlKHtcbiAgICAgICAgICAgIHN5bWJvbDogZGVmYXVsdFN5bWJvbCxcbiAgICAgICAgICAgIGxhYmVsOiBkZWZhdWx0TGFiZWxcbiAgICAgICAgfSwgLTEsIC0xKSksIGgoXCJkaXZcIiwgeyBjbGFzczogXCJ2YWx1ZS1wYXJ0MlwiIH0sIG90aGVyQ291bnQgPiAtMSA/IChoKFwiZGl2XCIsIHsgY2xhc3M6IGBncm91cC1jb3VudCAkeyghaGFzT3RoZXJWYWx1ZXMgfHwgaGFzT25seU51bGxWYWx1ZSkgJiYgXCJncm91cC1jb3VudC1uby1tZW51XCJ9YCwgXCJhcmlhLWxhYmVsXCI6IHN0cmluZ3MucGFuZWxzLnR5cGUuYWNjZXNzaWJpbGl0eS5jb3VudEZvci5yZXBsYWNlKFwiJHt2YWx1ZX1cIiwgZGVmYXVsdExhYmVsKSB9LCBgJHtvdGhlckNvdW50fWApKSA6IG51bGwsIGhhc090aGVyVmFsdWVzICYmICFoYXNPbmx5TnVsbFZhbHVlICYmIHRoaXMucmVuZGVyRGVmYXVsdE1lbnVOb2RlKCkpKSk7XG4gICAgfVxuICAgIHJlbmRlckRlZmF1bHRNZW51Tm9kZSgpIHtcbiAgICAgICAgY29uc3QgeyBzdHJpbmdzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgY29uc3Qgb3RoZXJVbmlxdWVWYWx1ZUNsYXNzZXMgPSBnZXRPdGhlclVuaXF1ZVZhbHVlQ2xhc3NlcygpO1xuICAgICAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWRyb3Bkb3duXCIsIHsgcGxhY2VtZW50OiBcImJvdHRvbS1lbmRcIiwgc2NhbGU6IFwic1wiLCBvdmVybGF5UG9zaXRpb25pbmc6IFwiYWJzb2x1dGVcIiwgcmVmOiAobm9kZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChub2RlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZ3JvdXBNZW51Tm9kZXNbLTFdID0gbm9kZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IH0sIGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IHNsb3Q6IFwidHJpZ2dlclwiLCBzY2FsZTogXCJzXCIsIHRleHQ6IHN0cmluZ3MucGFuZWxzLnR5cGUudG9vbHRpcHMub3B0aW9ucyB9LCBoKFwiY2FsY2l0ZS1pY29uXCIsIHsgc2NhbGU6IFwic1wiLCBpY29uOiBcImVsbGlwc2lzXCIgfSkpLCBoKFwiY2FsY2l0ZS1kcm9wZG93bi1ncm91cFwiLCB7IFwic2VsZWN0aW9uLW1vZGVcIjogXCJub25lXCIgfSwgaChcImNhbGNpdGUtZHJvcGRvd24taXRlbVwiLCB7IFwiaWNvbi1zdGFydFwiOiBcImFycm93LWJvbGQtdXBcIiwgbGFiZWw6IHN0cmluZ3MucGFuZWxzLnR5cGUubW92ZVVwLCBvbkNsaWNrOiAoKSA9PiB0aGlzLmhhbmRsZU1vdmVVcEFsbChvdGhlclVuaXF1ZVZhbHVlQ2xhc3NlcyksIG9uS2V5RG93bjogKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50LmtleSA9PT0gXCIgXCIgfHwgZXZlbnQua2V5ID09PSBcIkVudGVyXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVNb3ZlVXBBbGwob3RoZXJVbmlxdWVWYWx1ZUNsYXNzZXMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gfSwgc3RyaW5ncy5wYW5lbHMudHlwZS5tb3ZlVXApKSkpO1xuICAgIH1cbiAgICByZW5kZXJPdGhlclZhbHVlcygpIHtcbiAgICAgICAgY29uc3QgeyBhbGxVbmlxdWVWYWx1ZXMsIGxheWVyIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcik7XG4gICAgICAgIGlmICghYWxsVW5pcXVlVmFsdWVzIHx8ICFhbGxVbmlxdWVWYWx1ZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBsZXQgb3RoZXJWYWx1ZUNsYXNzZXMgPSBnZXRPdGhlclVuaXF1ZVZhbHVlQ2xhc3NlcygpO1xuICAgICAgICAvLyBkb24ndCBzaG93IG1vcmUgdGhhbiAyMDAgdmFsdWVzIHRvdGFsXG4gICAgICAgIGxldCBjb3VudEN1cnJlbnRDbGFzc2VzID0gMDtcbiAgICAgICAgcmVuZGVyZXIudW5pcXVlVmFsdWVHcm91cHMuZm9yRWFjaCgodW5pcXVlVmFsdWVHcm91cCkgPT4geyB2YXIgX2EsIF9iOyByZXR1cm4gKGNvdW50Q3VycmVudENsYXNzZXMgKz0gKF9iID0gKF9hID0gdW5pcXVlVmFsdWVHcm91cC5jbGFzc2VzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKSAhPT0gbnVsbCAmJiBfYiAhPT0gdm9pZCAwID8gX2IgOiAwKTsgfSk7XG4gICAgICAgIGlmIChjb3VudEN1cnJlbnRDbGFzc2VzICsgb3RoZXJWYWx1ZUNsYXNzZXMubGVuZ3RoID4gMjAwKSB7XG4gICAgICAgICAgICBvdGhlclZhbHVlQ2xhc3NlcyA9IG90aGVyVmFsdWVDbGFzc2VzLnNsaWNlKDAsIDIwMCAtIGNvdW50Q3VycmVudENsYXNzZXMpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IG90aGVyVmFsdWVOb2RlcyA9IG90aGVyVmFsdWVDbGFzc2VzLm1hcCgob3RoZXJWYWx1ZUNsYXNzLCBpZHgpID0+IHRoaXMucmVuZGVyT3RoZXJWYWx1ZShvdGhlclZhbHVlQ2xhc3MsIGlkeCwgaWR4ID09PSBvdGhlclZhbHVlQ2xhc3Nlcy5sZW5ndGggLSAxKSk7XG4gICAgICAgIHJldHVybiBvdGhlclZhbHVlTm9kZXM7XG4gICAgfVxuICAgIHJlbmRlck90aGVyVmFsdWUodW5pcXVlVmFsdWVDbGFzcywgaWR4LCBsYXN0KSB7XG4gICAgICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgICAgIHJldHVybiAoaChcImRpdlwiLCB7IGNsYXNzOiBcInZhbHVlIG5vZHJhZ1wiLCBrZXk6IHVuaXF1ZVZhbHVlQ2xhc3MudG9KU09OKCkgfSwgaChcImRpdlwiLCB7IGNsYXNzOiBcInZhbHVlLXBhcnQxXCIgfSwgaChcImRpdlwiLCB7IGNsYXNzOiBcInZhbHVlLWhhbmRsZS1wbGFjZWhvbGRlclwiIH0sIFwiXFx1MDBBMFwiKSwgdW5pcXVlVmFsdWVDbGFzcy52YWx1ZXNbMF0udmFsdWUgPyAodGhpcy5yZW5kZXJDaGVja05vZGUoLTEsIGlkeCwgbGFzdCkpIDogKGgoXCJkaXZcIiwgeyBjbGFzczogXCJjaGVjay1wbGFjZWhvbGRlclwiIH0sIFwiXFx1MDBBMFwiKSksIGgoXCJkaXZcIiwgeyBjbGFzczogXCJ2YWx1ZS10ZXh0IG90aGVyLXZhbHVlLXRleHRcIiwgXCJhcmlhLWxhYmVsXCI6IHVuaXF1ZVZhbHVlQ2xhc3MubGFiZWwgfSwgdW5pcXVlVmFsdWVDbGFzcy52YWx1ZXNbMF0udmFsdWUgPT09IG51bGxcbiAgICAgICAgICAgID8gc3RyaW5ncy5wYW5lbHMudHlwZS5ub0RhdGFcbiAgICAgICAgICAgIDogdW5pcXVlVmFsdWVDbGFzcy5sYWJlbCkpLCBoKFwiZGl2XCIsIHsgY2xhc3M6IFwidmFsdWUtcGFydDJcIiB9LCB0aGlzLnJlbmRlckNvdW50Tm9kZSh1bmlxdWVWYWx1ZUNsYXNzKSkpKTtcbiAgICB9XG4gICAgcmVuZGVyTXNnKCkge1xuICAgICAgICBjb25zdCB7IGFsbFVuaXF1ZVZhbHVlcywgbGF5ZXIsIGxhc3REZWZhdWx0LCBzdHJpbmdzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcik7XG4gICAgICAgIC8vIFRPRE8gZXN0aW1hdGVkVmFsdWVzTXNnXG4gICAgICAgIGlmIChhbGxVbmlxdWVWYWx1ZXMgJiYgYWxsVW5pcXVlVmFsdWVzLmxlbmd0aCA+IHRoaXMubWF4Q291bnRPdGhlclZhbHVlcykge1xuICAgICAgICAgICAgcmV0dXJuIChoKFwiZGl2XCIsIHsgY2xhc3M6IFwidHlwZS1wYW5lbC1tc2dcIiB9LCBzdHJpbmdzLnBhbmVscy50eXBlLmVycm9ycy50b29NYW55VmFsdWVzLnJlcGxhY2UoXCIke2NvdW50fVwiLCB0aGlzLm1heENvdW50T3RoZXJWYWx1ZXMudG9TdHJpbmcoKSkpKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmICghcmVuZGVyZXIudW5pcXVlVmFsdWVJbmZvcy5sZW5ndGggJiYgIShhbGxVbmlxdWVWYWx1ZXMgPT09IG51bGwgfHwgYWxsVW5pcXVlVmFsdWVzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhbGxVbmlxdWVWYWx1ZXMubGVuZ3RoKSkge1xuICAgICAgICAgICAgLy8gb25seSBvdGhlckNhdGVnb3J5XG4gICAgICAgICAgICByZXR1cm4gKGgoXCJkaXZcIiwgeyBjbGFzczogXCJ0eXBlLXBhbmVsLW1zZ1wiIH0sIHN0cmluZ3MucGFuZWxzLnR5cGUuZXJyb3JzLm5vRmVhdHVyZXMucmVwbGFjZShcIiR7b3RoZXJ9XCIsIGxhc3REZWZhdWx0LmRlZmF1bHRMYWJlbCkpKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJlbmRlckJhY2tncm91bmRTdHlsZSgpIHtcbiAgICAgICAgY29uc3QgeyBtYXBJbWFnZVN1YmxheWVyIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgaWYgKGdldFJlbmRlcmVyVHlwZSgpICE9PSBcInR5cGUtc2l6ZVwiIHx8IG1hcEltYWdlU3VibGF5ZXIpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBoKFwiYXJjZ2lzLXNtYXJ0LW1hcHBpbmctYmFja2dyb3VuZC1zeW1ib2xcIiwgbnVsbCk7XG4gICAgfVxuICAgIHJlbmRlclRyYW5zcGFyZW5jeSgpIHtcbiAgICAgICAgaWYgKHRoaXMuaGlkZVRyYW5zcGFyZW5jeSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgeyBsYXllciB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgICAgIGNvbnN0IG9wYWNpdHlWaXNWYXIgPSBnZXRWaXNWYXIoZ2V0UmVuZGVyZXIobGF5ZXIpLCBcIm9wYWNpdHlcIik7XG4gICAgICAgIHJldHVybiAoaChcImFyY2dpcy1zbWFydC1tYXBwaW5nLXRyYW5zcGFyZW5jeVwiLCB7IG9wZW46ICEhb3BhY2l0eVZpc1Zhciwgb25BcmNnaXNTbWFydE1hcHBpbmdTeW1ib2xUcmFuc3BhcmVuY3lFcnJvcjogKHsgZGV0YWlsIH0pID0+IHRoaXMuYXJjZ2lzU21hcnRNYXBwaW5nUGFuZWxzVHlwZUVycm9yLmVtaXQoZGV0YWlsKSwgb25LZXlEb3duOiAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCByZW5kZXJlclR5cGUgPSBnZXRSZW5kZXJlclR5cGUoKTtcbiAgICAgICAgICAgICAgICBpZiAocmVuZGVyZXJUeXBlID09PSBcInR5cGVcIiAmJiBldmVudC5zaGlmdEtleSAmJiBldmVudC5rZXkgPT09IFwiVGFiXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3Rpb25zUG9wb3Zlck5vZGUuZm9jdXNMYXN0QWN0aW9uKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgcmVmOiAobm9kZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChub2RlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudHJhbnNwYXJlbmN5Tm9kZSA9IG5vZGU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSB9KSk7XG4gICAgfVxuICAgIHJlbmRlclJvdGF0aW9uKCkge1xuICAgICAgICBpZiAodGhpcy5oaWRlUm90YXRpb24pIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHsgbGF5ZXIgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgICAgICBjb25zdCBvcGFjaXR5VmlzVmFyID0gZ2V0VmlzVmFyKGdldFJlbmRlcmVyKGxheWVyKSwgXCJvcGFjaXR5XCIpO1xuICAgICAgICBjb25zdCByb3RhdGlvblZpc1ZhciA9IGdldFZpc1ZhcihnZXRSZW5kZXJlcihsYXllciksIFwicm90YXRpb25cIik7XG4gICAgICAgIHJldHVybiAoaChcImFyY2dpcy1zbWFydC1tYXBwaW5nLXJvdGF0aW9uXCIsIHsgb3BlbjogIW9wYWNpdHlWaXNWYXIgJiYgISFyb3RhdGlvblZpc1Zhciwgb25BcmNnaXNTbWFydE1hcHBpbmdSb3RhdGlvbkVycm9yOiAoeyBkZXRhaWwgfSkgPT4gdGhpcy5hcmNnaXNTbWFydE1hcHBpbmdQYW5lbHNUeXBlRXJyb3IuZW1pdChkZXRhaWwpLCByZWY6IChub2RlKSA9PiAodGhpcy5yb3RhdGlvbk5vZGUgPSBub2RlKSB9KSk7XG4gICAgfVxuICAgIHJlbmRlckRvbmVCdXR0b24oKSB7XG4gICAgICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgICAgIHJldHVybiAoaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgc2xvdDogXCJmb290ZXJcIiwgbGFiZWw6IHN0cmluZ3MuZG9uZSwgb25DbGljazogKCkgPT4gdGhpcy5hcmNnaXNTbWFydE1hcHBpbmdQYW5lbHNUeXBlQ2xvc2UuZW1pdChcInNhdmVcIiksIGFwcGVhcmFuY2U6IFwic29saWRcIiwgd2lkdGg6IFwiaGFsZlwiLCBvbktleURvd246IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlbmRlcmVyVHlwZSA9IGdldFJlbmRlcmVyVHlwZSgpO1xuICAgICAgICAgICAgICAgIGlmIChyZW5kZXJlclR5cGUgPT09IFwidHlwZS1zaXplXCIgJiYgZXZlbnQuc2hpZnRLZXkgJiYgZXZlbnQua2V5ID09PSBcIlRhYlwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYWN0aW9uc1BvcG92ZXJOb2RlLmZvY3VzTGFzdEFjdGlvbigpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIHJlZjogKG5vZGUpID0+ICh0aGlzLmRvbmVCdXR0b25Ob2RlID0gbm9kZSkgfSwgc3RyaW5ncy5kb25lKSk7XG4gICAgfVxuICAgIHJlbmRlckNhbmNlbEJ1dHRvbigpIHtcbiAgICAgICAgY29uc3QgeyBzdHJpbmdzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBzbG90OiBcImZvb3RlclwiLCBsYWJlbDogc3RyaW5ncy5jYW5jZWwsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB7IGxheWVyOiBzbUxheWVyIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgICAgICAgICBjb25zdCBsYXllciA9IHNtTGF5ZXI7XG4gICAgICAgICAgICAgICAgY29uc3QgeyBvcmlnaW5hbFJlbmRlcmVySlNPTiwgb3JpZ2luYWxGZWF0dXJlUmVkdWN0aW9uLCBvcmlnaW5hbE9yZGVyQnkgfSA9IHRoaXM7XG4gICAgICAgICAgICAgICAgdGhpcy5jbG9zZVBvcG92ZXJzKCk7XG4gICAgICAgICAgICAgICAgbGF5ZXIub3JkZXJCeSA9IG9yaWdpbmFsT3JkZXJCeTtcbiAgICAgICAgICAgICAgICBhcHBseVJlbmRlcmVyVG9BbGwob3JpZ2luYWxSZW5kZXJlckpTT04sIG9yaWdpbmFsRmVhdHVyZVJlZHVjdGlvbik7XG4gICAgICAgICAgICAgICAgdGhpcy5hcmNnaXNTbWFydE1hcHBpbmdQYW5lbHNUeXBlQ2xvc2UuZW1pdChcImNhbmNlbFwiKTtcbiAgICAgICAgICAgIH0sIGFwcGVhcmFuY2U6IFwib3V0bGluZS1maWxsXCIsIHdpZHRoOiBcImhhbGZcIiB9LCBzdHJpbmdzLmNhbmNlbCkpO1xuICAgIH1cbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvL1xuICAgIC8vICBQcml2YXRlIE1ldGhvZHNcbiAgICAvL1xuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIGFkZEFjdGlvbnNQb3BvdmVyKCkge1xuICAgICAgICB0aGlzLmNsb3NlUG9wb3ZlcnMoKTtcbiAgICAgICAgdGhpcy5hY3Rpb25zUG9wb3Zlck5vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLXNtYXJ0LW1hcHBpbmctdHlwZS1hY3Rpb25zLXBvcG92ZXJcIik7XG4gICAgICAgIHRoaXMuYWN0aW9uc1BvcG92ZXJOb2RlLnJlZmVyZW5jZU5vZGUgPSB0aGlzLmZsb3dJdGVtTm9kZTtcbiAgICAgICAgdGhpcy5hY3Rpb25zUG9wb3Zlck5vZGUuY2hlY2tlZENsYXNzZXMgPSB0aGlzLmNoZWNrZWRDbGFzc2VzO1xuICAgICAgICB0aGlzLmFjdGlvbnNQb3BvdmVyTm9kZS5ncm91cE1lbnVOb2RlcyA9IHRoaXMuZ3JvdXBNZW51Tm9kZXM7XG4gICAgICAgIHRoaXMuYWN0aW9uc1BvcG92ZXJOb2RlLmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNTbWFydE1hcHBpbmdUeXBlQWN0aW9uc1BvcG92ZXJDaGFuZ2VcIiwgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICB2YXIgX2E7XG4gICAgICAgICAgICBpZiAoKF9hID0gZXZlbnQuZGV0YWlsKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY2hlY2tlZENsYXNzZXMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNoZWNrZWRDbGFzc2VzID0gZXZlbnQuZGV0YWlsLmNoZWNrZWRDbGFzc2VzO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5yZW1vdmVBY3Rpb25zUG9wb3ZlcigpO1xuICAgICAgICAgICAgZm9yY2VVcGRhdGUodGhpcy5ob3N0RWxlbWVudCk7XG4gICAgICAgICAgICB0aGlzLmNoZWNrQ2x1c3RlcigpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5hY3Rpb25zUG9wb3Zlck5vZGUuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc1NtYXJ0TWFwcGluZ1R5cGVBY3Rpb25zUG9wb3ZlckZvY3VzRXhpdFwiLCAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgIHZhciBfYSwgX2I7XG4gICAgICAgICAgICBpZiAoZXZlbnQuZGV0YWlsID09PSBcImJvdHRvbVwiKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVuZGVyZXJUeXBlID0gZ2V0UmVuZGVyZXJUeXBlKCk7XG4gICAgICAgICAgICAgICAgaWYgKHJlbmRlcmVyVHlwZSA9PT0gXCJ0eXBlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgKF9hID0gdGhpcy50cmFuc3BhcmVuY3lOb2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2V0Rm9jdXMoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIHR5cGUtc2l6ZVxuICAgICAgICAgICAgICAgICAgICAoX2IgPSB0aGlzLmRvbmVCdXR0b25Ob2RlKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Iuc2V0Rm9jdXMoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChldmVudC5kZXRhaWwgPT09IFwidG9wXCIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxhc3RPdGhlclZhbHVlQ2hlY2tOb2RlXG4gICAgICAgICAgICAgICAgICAgID8gdGhpcy5sYXN0T3RoZXJWYWx1ZUNoZWNrTm9kZS5zZXRGb2N1cygpXG4gICAgICAgICAgICAgICAgICAgIDogdGhpcy5vdGhlclRleHROb2RlLmZvY3VzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMuYWN0aW9uc1BvcG92ZXJOb2RlKTtcbiAgICB9XG4gICAgYWZ0ZXJDcmVhdGVWYWx1ZVN5bWJvbChncm91cElkeCwgY2xhc3NJZHgsIG5vZGUpIHtcbiAgICAgICAgdmFyIF9hO1xuICAgICAgICBjb25zdCB7IGxheWVyLCBsYXN0RGVmYXVsdCwgbW9kdWxlcyB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgICAgIGNvbnN0IHJlbmRlcmVyID0gZ2V0UmVuZGVyZXIobGF5ZXIpO1xuICAgICAgICBsZXQgc3ltYm9sO1xuICAgICAgICBpZiAoZ3JvdXBJZHggPT09IC0xKSB7XG4gICAgICAgICAgICBzeW1ib2wgPSByZW5kZXJlci5kZWZhdWx0U3ltYm9sIHx8IGxhc3REZWZhdWx0LmRlZmF1bHRTeW1ib2w7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBzeW1ib2wgPSByZW5kZXJlci51bmlxdWVWYWx1ZUdyb3Vwc1tncm91cElkeF0uY2xhc3Nlc1tjbGFzc0lkeF0uc3ltYm9sLmNsb25lKCk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gcmVtb3ZlIG9sZCBzeW1ib2wgaWYgdGhlcmUgaXMgb25lXG4gICAgICAgIHdoaWxlICgoX2EgPSBub2RlID09PSBudWxsIHx8IG5vZGUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG5vZGUuY2hpbGROb2RlcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkge1xuICAgICAgICAgICAgbm9kZS5yZW1vdmVDaGlsZChub2RlLmNoaWxkTm9kZXNbMF0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzeW1ib2wpIHtcbiAgICAgICAgICAgIC8vIGFkZCBuZXcgc3ltYm9sXG4gICAgICAgICAgICBtb2R1bGVzLnN5bWJvbFV0aWxzXG4gICAgICAgICAgICAgICAgLnJlbmRlclByZXZpZXdIVE1MKHN5bWJvbCwge1xuICAgICAgICAgICAgICAgIHNpemU6IGdldFJlbmRlclByZXZpZXdTaXplKHN5bWJvbCksXG4gICAgICAgICAgICAgICAgc3ltYm9sQ29uZmlnOiBcbiAgICAgICAgICAgICAgICAvL3N5bWJvbC50eXBlID09PSBcInNpbXBsZS1maWxsXCIgfHwgLi4uIHdoaWxlIENJTXMgaGF2ZSB0aGF0IHNoYXBlXG4gICAgICAgICAgICAgICAgc3ltYm9sLnR5cGUgPT09IFwiY2ltXCIgJiYgc3ltYm9sLmRhdGEuc3ltYm9sLnR5cGUgPT09IFwiQ0lNUG9seWdvblN5bWJvbFwiXG4gICAgICAgICAgICAgICAgICAgID8geyBpc1NxdWFyZUZpbGw6IHRydWUgfVxuICAgICAgICAgICAgICAgICAgICA6IHVuZGVmaW5lZFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAudGhlbigoc3ltYm9sTm9kZSkgPT4gbm9kZS5hcHBlbmRDaGlsZChzeW1ib2xOb2RlKSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgY2hlY2tDbHVzdGVyKCkge1xuICAgICAgICBjb25zdCB7IGxheWVyIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgXCJmZWF0dXJlUmVkdWN0aW9uXCIgaW4gbGF5ZXIgJiZcbiAgICAgICAgICAgIGxheWVyLmZlYXR1cmVSZWR1Y3Rpb24gJiZcbiAgICAgICAgICAgIHRoaXMuYXJjZ2lzU21hcnRNYXBwaW5nUGFuZWxzVHlwZUNsdXN0ZXJSZXF1aXJlc1VwZGF0ZS5lbWl0KCk7XG4gICAgfVxuICAgIGNsb3NlUG9wb3ZlcnMoKSB7XG4gICAgICAgIHRoaXMucmVtb3ZlQWN0aW9uc1BvcG92ZXIoKTtcbiAgICAgICAgY2xvc2VQb3BvdmVycygpO1xuICAgIH1cbiAgICBnZXRPdGhlckNvdW50KG90aGVySW5mb3MpIHtcbiAgICAgICAgbGV0IHRvdGFsQ291bnQgPSAwO1xuICAgICAgICBvdGhlckluZm9zLm1hcCgoaW5mbykgPT4gKHRvdGFsQ291bnQgKz0gaW5mby5jb3VudCkpO1xuICAgICAgICByZXR1cm4gb3RoZXJJbmZvcy5sZW5ndGggPyB0b3RhbENvdW50IDogLTE7XG4gICAgfVxuICAgIGdldFVuaXF1ZVZhbHVlKHZhbHVlKSB7XG4gICAgICAgIGNvbnN0IHsgYWxsVW5pcXVlVmFsdWVzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgaWYgKCFhbGxVbmlxdWVWYWx1ZXMpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIC8vIG5vIGV4YWN0IG1hdGNoIVxuICAgICAgICBjb25zdCBpbmZvcyA9IGFsbFVuaXF1ZVZhbHVlcy5maWx0ZXIoKGluZm8pID0+IGluZm8udmFsdWUgPT0gdmFsdWUpO1xuICAgICAgICByZXR1cm4gaW5mb3MubGVuZ3RoID8gaW5mb3NbMF0gOiBudWxsO1xuICAgIH1cbiAgICBoYW5kbGVBZGRWYWx1ZShncm91cElkeCkge1xuICAgICAgICBjb25zdCBhZGRWYWx1ZVBvcG92ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLXNtYXJ0LW1hcHBpbmctdHlwZS1hZGQtdmFsdWVcIik7XG4gICAgICAgIGFkZFZhbHVlUG9wb3Zlci5ncm91cElkeCA9IGdyb3VwSWR4O1xuICAgICAgICBhZGRWYWx1ZVBvcG92ZXIuZmxvd0l0ZW1Ob2RlID0gdGhpcy5mbG93SXRlbU5vZGU7XG4gICAgICAgIGFkZFZhbHVlUG9wb3Zlci5yZWZlcmVuY2VOb2RlID0gdGhpcy5ncm91cE1lbnVOb2Rlc1tncm91cElkeF07XG4gICAgICAgIGFkZFZhbHVlUG9wb3Zlci5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzU21hcnRNYXBwaW5nVHlwZUFkZFZhbHVlUG9wb3ZlckNsb3NlXCIsICgpID0+IHtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5ncm91cE1lbnVOb2Rlc1tncm91cElkeF0uc2V0Rm9jdXMoKSwgMzAwKTtcbiAgICAgICAgICAgIGFkZFZhbHVlUG9wb3ZlciA9PT0gbnVsbCB8fCBhZGRWYWx1ZVBvcG92ZXIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFkZFZhbHVlUG9wb3Zlci5wYXJlbnRFbGVtZW50LnJlbW92ZUNoaWxkKGFkZFZhbHVlUG9wb3Zlcik7XG4gICAgICAgIH0pO1xuICAgICAgICBhZGRWYWx1ZVBvcG92ZXIuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc1NtYXJ0TWFwcGluZ1R5cGVBZGRWYWx1ZVBvcG92ZXJOZXdWYWx1ZVwiLCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVJlbmRlcmVyQW5kVUkoKTtcbiAgICAgICAgICAgIHRoaXMuY2hlY2tDbHVzdGVyKCk7XG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuZ3JvdXBNZW51Tm9kZXNbZ3JvdXBJZHhdLnNldEZvY3VzKCksIDMwMCk7XG4gICAgICAgICAgICBhZGRWYWx1ZVBvcG92ZXIgPT09IG51bGwgfHwgYWRkVmFsdWVQb3BvdmVyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhZGRWYWx1ZVBvcG92ZXIucGFyZW50RWxlbWVudC5yZW1vdmVDaGlsZChhZGRWYWx1ZVBvcG92ZXIpO1xuICAgICAgICB9KTtcbiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChhZGRWYWx1ZVBvcG92ZXIpO1xuICAgIH1cbiAgICBoYW5kbGVDaGVjayhncm91cElkeCwgY2xhc3NJZHgsIG5vZGUpIHtcbiAgICAgICAgY29uc3QgaWR4ID0gdGhpcy5jaGVja2VkQ2xhc3Nlcy5maW5kSW5kZXgoKGluZm8pID0+IGluZm8uZ3JvdXBJZHggPT09IGdyb3VwSWR4ICYmIGluZm8uY2xhc3NJZHggPT09IGNsYXNzSWR4KTtcbiAgICAgICAgaWYgKGlkeCA+IC0xKSB7XG4gICAgICAgICAgICAvLyBpdGVtIGlzIGFscmVhZHkgY2hlY2tlZCwgdXNlciBjbGlja3MgYWdhaW4gdG8gdW5jaGVja1xuICAgICAgICAgICAgdGhpcy5jaGVja2VkQ2xhc3Nlcy5zcGxpY2UoaWR4LCAxKTtcbiAgICAgICAgICAgIG5vZGUuaWNvbiA9IFwic3F1YXJlXCI7XG4gICAgICAgICAgICB0aGlzLmFjdGlvbnNQb3BvdmVyTm9kZS5jaGVja2VkQ2xhc3NlcyA9IHRoaXMuY2hlY2tlZENsYXNzZXM7XG4gICAgICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmFjdGlvbnNQb3BvdmVyTm9kZSk7XG4gICAgICAgICAgICBpZiAoIXRoaXMuY2hlY2tlZENsYXNzZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVBY3Rpb25zUG9wb3ZlcigpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5jaGVja2VkQ2xhc3NlcyA9IFsuLi50aGlzLmNoZWNrZWRDbGFzc2VzLCB7IGdyb3VwSWR4OiBncm91cElkeCwgY2xhc3NJZHg6IGNsYXNzSWR4IH1dO1xuICAgICAgICAgICAgbm9kZS5pY29uID0gXCJjaGVjay1zcXVhcmVcIjtcbiAgICAgICAgICAgIGlmICh0aGlzLmFjdGlvbnNQb3BvdmVyTm9kZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuYWN0aW9uc1BvcG92ZXJOb2RlLmNoZWNrZWRDbGFzc2VzID0gdGhpcy5jaGVja2VkQ2xhc3NlcztcbiAgICAgICAgICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmFjdGlvbnNQb3BvdmVyTm9kZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFkZEFjdGlvbnNQb3BvdmVyKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgaGFuZGxlRGVmYXVsdENoZWNrQ2hhbmdlKCkge1xuICAgICAgICBjb25zdCB7IGxheWVyIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcik7XG4gICAgICAgIGlmIChyZW5kZXJlci5kZWZhdWx0U3ltYm9sKSB7XG4gICAgICAgICAgICByZW5kZXJlci5kZWZhdWx0U3ltYm9sID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgcmVuZGVyZXIuZGVmYXVsdExhYmVsID0gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgeyBsYXN0RGVmYXVsdCB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgICAgICAgICByZW5kZXJlci5kZWZhdWx0U3ltYm9sID0gbGFzdERlZmF1bHQuZGVmYXVsdFN5bWJvbDtcbiAgICAgICAgICAgIHJlbmRlcmVyLmRlZmF1bHRMYWJlbCA9IGxhc3REZWZhdWx0LmRlZmF1bHRMYWJlbDtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnVwZGF0ZVJlbmRlcmVyQW5kVUkoKTtcbiAgICB9XG4gICAgaGFuZGxlRHJhd2luZ09yZGVyVG9nZ2xlKGNoZWNrZWQpIHtcbiAgICAgICAgY29uc3QgeyBsYXllcjogc21MYXllciB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgICAgIGNvbnN0IGxheWVyID0gc21MYXllcjtcbiAgICAgICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcik7XG4gICAgICAgIGNsb3NlUG9wb3ZlcnMoKTtcbiAgICAgICAgcmVuZGVyZXIub3JkZXJCeUNsYXNzZXNFbmFibGVkID0gY2hlY2tlZDtcbiAgICAgICAgaWYgKGNoZWNrZWQpIHtcbiAgICAgICAgICAgIGxheWVyLm9yZGVyQnkgPSBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgbGF5ZXIub3JkZXJCeSA9IHRoaXMub3JpZ2luYWxPcmRlckJ5O1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudXBkYXRlUmVuZGVyZXJBbmRVSSgpO1xuICAgIH1cbiAgICBoYW5kbGVHcm91cE1vdmVVcChncm91cElkeCkge1xuICAgICAgICB0aGlzLmNsb3NlUG9wb3ZlcnMoKTtcbiAgICAgICAgY29uc3QgeyBsYXllciB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgICAgIGNvbnN0IHJlbmRlcmVyID0gZ2V0UmVuZGVyZXIobGF5ZXIpO1xuICAgICAgICBpZiAoZ3JvdXBJZHggPiAwKSB7XG4gICAgICAgICAgICBjb25zdCB1dlJlbmRlcmVyID0gcmVuZGVyZXI7XG4gICAgICAgICAgICBjb25zdCBncm91cHMgPSB1dlJlbmRlcmVyLnVuaXF1ZVZhbHVlR3JvdXBzO1xuICAgICAgICAgICAgY29uc3QgZ3JvdXAgPSBncm91cHMuc3BsaWNlKGdyb3VwSWR4LCAxKVswXTtcbiAgICAgICAgICAgIGdyb3Vwcy5zcGxpY2UoZ3JvdXBJZHggLSAxLCAwLCBncm91cCk7XG4gICAgICAgICAgICB1dlJlbmRlcmVyLnVuaXF1ZVZhbHVlR3JvdXBzID0gZ3JvdXBzO1xuICAgICAgICAgICAgdGhpcy5jaGVja2VkQ2xhc3NlcyA9IFtdO1xuICAgICAgICAgICAgdGhpcy51cGRhdGVSZW5kZXJlckFuZFVJKCk7XG4gICAgICAgICAgICB0aGlzLmNoZWNrQ2x1c3RlcigpO1xuICAgICAgICAgICAgLy8gaWYgd2UgZG8gdGhpcyB0b28gZWFybHkgdGhlIGVudGVyIGtleSBleGVjdXRlcyBvbiB0aGUgZm9jdXNlZCBkaXZcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4geyB2YXIgX2E7IHJldHVybiAoX2EgPSB0aGlzLmdyb3VwTWVudU5vZGVzW2dyb3VwSWR4IC0gMV0pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zZXRGb2N1cygpOyB9LCAzMDApO1xuICAgICAgICB9XG4gICAgfVxuICAgIGhhbmRsZUdyb3VwTW92ZURvd24oZ3JvdXBJZHgpIHtcbiAgICAgICAgdGhpcy5jbG9zZVBvcG92ZXJzKCk7XG4gICAgICAgIGNvbnN0IHsgbGF5ZXIgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgICAgICBjb25zdCByZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKTtcbiAgICAgICAgY29uc3QgZ3JvdXBzID0gcmVuZGVyZXIudW5pcXVlVmFsdWVHcm91cHM7XG4gICAgICAgIGlmIChncm91cElkeCA8IGdyb3Vwcy5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICBjb25zdCB1dlJlbmRlcmVyID0gcmVuZGVyZXI7XG4gICAgICAgICAgICBjb25zdCBncm91cHMgPSB1dlJlbmRlcmVyLnVuaXF1ZVZhbHVlR3JvdXBzO1xuICAgICAgICAgICAgY29uc3QgZ3JvdXAgPSBncm91cHMuc3BsaWNlKGdyb3VwSWR4LCAxKVswXTtcbiAgICAgICAgICAgIGdyb3Vwcy5zcGxpY2UoZ3JvdXBJZHggKyAxLCAwLCBncm91cCk7XG4gICAgICAgICAgICB1dlJlbmRlcmVyLnVuaXF1ZVZhbHVlR3JvdXBzID0gZ3JvdXBzO1xuICAgICAgICAgICAgdGhpcy5jaGVja2VkQ2xhc3NlcyA9IFtdO1xuICAgICAgICAgICAgdGhpcy51cGRhdGVSZW5kZXJlckFuZFVJKCk7XG4gICAgICAgICAgICB0aGlzLmNoZWNrQ2x1c3RlcigpO1xuICAgICAgICAgICAgLy8gaWYgd2UgZG8gdGhpcyB0b28gZWFybHkgdGhlIGVudGVyIGtleSBleGVjdXRlcyBvbiB0aGUgZm9jdXNlZCBkaXZcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4geyB2YXIgX2E7IHJldHVybiAoX2EgPSB0aGlzLmdyb3VwTWVudU5vZGVzW2dyb3VwSWR4ICsgMV0pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zZXRGb2N1cygpOyB9LCAzMDApO1xuICAgICAgICB9XG4gICAgfVxuICAgIGhhbmRsZUdyb3VwVGV4dENoYW5nZShncm91cElkeCwgbGFiZWwpIHtcbiAgICAgICAgdmFyIF9hO1xuICAgICAgICBjb25zdCB7IGxheWVyIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcik7XG4gICAgICAgIGNvbnN0IGdyb3VwcyA9IHJlbmRlcmVyLnVuaXF1ZVZhbHVlR3JvdXBzO1xuICAgICAgICB0aGlzLmdyb3VwSW5wdXROb2Rlc1tncm91cElkeF0uY2xhc3NMaXN0LmFkZChcImhpZGRlblwiKTtcbiAgICAgICAgaWYgKCEobGFiZWwgPT09IG51bGwgfHwgbGFiZWwgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGxhYmVsLmxlbmd0aCkpIHtcbiAgICAgICAgICAgIGlmICgoX2EgPSByZW5kZXJlci51bmlxdWVWYWx1ZUdyb3Vwc1tncm91cElkeF0uaGVhZGluZykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGxhYmVsID0gcmVuZGVyZXIudW5pcXVlVmFsdWVHcm91cHNbZ3JvdXBJZHhdLmhlYWRpbmc7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZ3JvdXBzW2dyb3VwSWR4XS5oZWFkaW5nID0gbGFiZWw7XG4gICAgICAgIHJlbmRlcmVyLnVuaXF1ZVZhbHVlR3JvdXBzID0gZ3JvdXBzO1xuICAgICAgICB0aGlzLnNlbGVjdGVkVmFsdWVUZXh0ID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLnVwZGF0ZVJlbmRlcmVyQW5kVUkoKTtcbiAgICAgICAgdGhpcy5ncm91cFRleHROb2Rlc1tncm91cElkeF0uY2xhc3NMaXN0LnJlbW92ZShcImhpZGRlblwiKTtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLmdyb3VwVGV4dE5vZGVzW2dyb3VwSWR4XS5mb2N1cygpLCAzMDApO1xuICAgIH1cbiAgICBoYW5kbGVHcm91cFRleHRDbGljayhncm91cElkeCkge1xuICAgICAgICB0aGlzLnNlbGVjdGVkVmFsdWVUZXh0ID0gYCR7Z3JvdXBJZHh9YDtcbiAgICAgICAgdGhpcy5ncm91cFRleHROb2Rlc1tncm91cElkeF0uY2xhc3NMaXN0LmFkZChcImhpZGRlblwiKTtcbiAgICAgICAgdGhpcy5ncm91cElucHV0Tm9kZXNbZ3JvdXBJZHhdLmNsYXNzTGlzdC5yZW1vdmUoXCJoaWRkZW5cIik7XG4gICAgICAgIHRoaXMuZ3JvdXBJbnB1dE5vZGVzW2dyb3VwSWR4XS5zZXRGb2N1cygpO1xuICAgIH1cbiAgICBoYW5kbGVNb3ZlVXBBbGwodW5pcXVlVmFsdWVDbGFzc2VzKSB7XG4gICAgICAgIHVuaXF1ZVZhbHVlQ2xhc3NlcyA9IHVuaXF1ZVZhbHVlQ2xhc3Nlcy5maWx0ZXIoKHV2Q2xhc3MpID0+IHV2Q2xhc3MudmFsdWVzWzBdLnZhbHVlICE9PSBudWxsKTtcbiAgICAgICAgY29uc3QgeyBsYXllciwgbW9kdWxlcyB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWRWYWx1ZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5zZWxlY3RlZFZhbHVlVGV4dCA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5jbG9zZVBvcG92ZXJzKCk7XG4gICAgICAgIGNvbnN0IHJlbmRlcmVyID0gZ2V0UmVuZGVyZXIobGF5ZXIpO1xuICAgICAgICBjb25zdCBncm91cHMgPSByZW5kZXJlci51bmlxdWVWYWx1ZUdyb3VwcztcbiAgICAgICAgLy8gZG9uJ3Qgc2hvdyBtb3JlIHRoYW4gMjAwIHZhbHVlcyB0b3RhbFxuICAgICAgICBsZXQgY3VycmVudExlbmd0aCA9IDA7XG4gICAgICAgIGdyb3Vwcy5mb3JFYWNoKCh1bmlxdWVWYWx1ZUdyb3VwKSA9PiB7IHZhciBfYSwgX2I7IHJldHVybiAoY3VycmVudExlbmd0aCArPSAoX2IgPSAoX2EgPSB1bmlxdWVWYWx1ZUdyb3VwLmNsYXNzZXMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpICE9PSBudWxsICYmIF9iICE9PSB2b2lkIDAgPyBfYiA6IDApOyB9KTtcbiAgICAgICAgaWYgKGN1cnJlbnRMZW5ndGggKyB1bmlxdWVWYWx1ZUNsYXNzZXMubGVuZ3RoID4gMjAwKSB7XG4gICAgICAgICAgICAvLyBkb24ndCBhZGQgYWxsIGNsYXNzZXNcbiAgICAgICAgICAgIHVuaXF1ZVZhbHVlQ2xhc3Nlcy5sZW5ndGggPSAyMDAgLSBjdXJyZW50TGVuZ3RoO1xuICAgICAgICB9XG4gICAgICAgIGlmIChncm91cHMubGVuZ3RoID09PSAxICYmICFncm91cHNbMF0uaGVhZGluZykge1xuICAgICAgICAgICAgLy8gYWRkIHRvIGV4aXN0aW5nIGdyb3VwXG4gICAgICAgICAgICBncm91cHNbMF0uY2xhc3NlcyA9IGdyb3Vwc1swXS5jbGFzc2VzLmNvbmNhdCh1bmlxdWVWYWx1ZUNsYXNzZXMpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgLy8gYWRkIGFsbCB0byBhIG5ldyBncm91cFxuICAgICAgICAgICAgY29uc3QgbmV3R3JvdXAgPSBuZXcgbW9kdWxlcy5VbmlxdWVWYWx1ZUdyb3VwKHtcbiAgICAgICAgICAgICAgICBoZWFkaW5nOiBnZXRVbmlxdWVHcm91cE5hbWUoZ3JvdXBzKSxcbiAgICAgICAgICAgICAgICBjbGFzc2VzOiB1bmlxdWVWYWx1ZUNsYXNzZXNcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgZ3JvdXBzLnB1c2gobmV3R3JvdXApO1xuICAgICAgICB9XG4gICAgICAgIHJlbmRlcmVyLnVuaXF1ZVZhbHVlR3JvdXBzID0gZ3JvdXBzO1xuICAgICAgICB0aGlzLnVwZGF0ZVJlbmRlcmVyQW5kVUkoKTtcbiAgICAgICAgdGhpcy5jaGVja0NsdXN0ZXIoKTtcbiAgICB9XG4gICAgaGFuZGxlU2VsZWN0QWxsVmFsdWVzKGdyb3VwSWR4KSB7XG4gICAgICAgIGNsb3NlUG9wb3ZlcnMoKTtcbiAgICAgICAgY29uc3QgeyBsYXllciB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgICAgIGNvbnN0IHV2UmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcik7XG4gICAgICAgIGNvbnN0IGdyb3VwcyA9IHV2UmVuZGVyZXIudW5pcXVlVmFsdWVHcm91cHM7XG4gICAgICAgIGdyb3Vwc1tncm91cElkeF0uY2xhc3Nlcy5mb3JFYWNoKChfLCBpZHgpID0+IHtcbiAgICAgICAgICAgIGlmICghdGhpcy5jaGVja2VkQ2xhc3Nlcy5maW5kKChpbmZvKSA9PiBpbmZvLmdyb3VwSWR4ID09PSBncm91cElkeCAmJiBpbmZvLmNsYXNzSWR4ID09PSBpZHgpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jaGVja2VkQ2xhc3Nlcy5wdXNoKHsgZ3JvdXBJZHgsIGNsYXNzSWR4OiBpZHggfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgICAgaWYgKHRoaXMuYWN0aW9uc1BvcG92ZXJOb2RlKSB7XG4gICAgICAgICAgICB0aGlzLmFjdGlvbnNQb3BvdmVyTm9kZS5jaGVja2VkQ2xhc3NlcyA9IHRoaXMuY2hlY2tlZENsYXNzZXM7XG4gICAgICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmFjdGlvbnNQb3BvdmVyTm9kZSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmFkZEFjdGlvbnNQb3BvdmVyKCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaGFuZGxlU2VwYXJhdGVWYWx1ZXMoZ3JvdXBJZHgpIHtcbiAgICAgICAgdGhpcy5jbG9zZVBvcG92ZXJzKCk7XG4gICAgICAgIHRoaXMuc2VwYXJhdGVHcm91cFZhbHVlcyhncm91cElkeCk7XG4gICAgICAgIHRoaXMudXBkYXRlUmVuZGVyZXJBbmRVSSgpO1xuICAgICAgICB0aGlzLmNoZWNrQ2x1c3RlcigpO1xuICAgIH1cbiAgICBoYW5kbGVTb3J0Q2xhc3Nlcyhncm91cElkeCkge1xuICAgICAgICB2YXIgX2E7XG4gICAgICAgIGNvbnN0IGdyb3VwSWR4Q2xhc3NJZHMgPSAoKF9hID0gdGhpcy5jbGFzc1NvcnRhYmxlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2FbZ3JvdXBJZHhdLnRvQXJyYXkoKSkgfHwgW107XG4gICAgICAgIGNvbnN0IHsgbGF5ZXIsIG1vZHVsZXMgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgICAgICBjb25zdCByZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKTtcbiAgICAgICAgdGhpcy5jbG9zZVBvcG92ZXJzKCk7XG4gICAgICAgIGNvbnN0IGJlZm9yZU90aGVyVmFsdWVzTGVuZ3RoID0gZ2V0T3RoZXJVbmlxdWVWYWx1ZUNsYXNzZXMoKS5sZW5ndGg7XG4gICAgICAgIGxldCBiZWZvcmVMZW5ndGggPSAwO1xuICAgICAgICByZW5kZXJlci51bmlxdWVWYWx1ZUdyb3Vwcy5mb3JFYWNoKCh1bmlxdWVWYWx1ZUdyb3VwKSA9PiB7IHZhciBfYSwgX2I7IHJldHVybiAoYmVmb3JlTGVuZ3RoICs9IChfYiA9IChfYSA9IHVuaXF1ZVZhbHVlR3JvdXAuY2xhc3NlcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkgIT09IG51bGwgJiYgX2IgIT09IHZvaWQgMCA/IF9iIDogMCk7IH0pO1xuICAgICAgICBjb25zdCB1dlJlbmRlcmVyID0gcmVuZGVyZXI7XG4gICAgICAgIGNvbnN0IG9sZEdyb3VwcyA9IHV2UmVuZGVyZXIuY2xvbmUoKS51bmlxdWVWYWx1ZUdyb3VwcztcbiAgICAgICAgY29uc3QgbmV3R3JvdXBzID0gW107XG4gICAgICAgIG9sZEdyb3Vwcy5mb3JFYWNoKChncm91cCwgaWR4KSA9PiB7XG4gICAgICAgICAgICBpZiAoaWR4ID09PSBncm91cElkeCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG5ld0dyb3VwID0gbmV3IG1vZHVsZXMuVW5pcXVlVmFsdWVHcm91cCh7IGhlYWRpbmc6IGdyb3VwLmhlYWRpbmcsIGNsYXNzZXM6IFtdIH0pO1xuICAgICAgICAgICAgICAgIGdyb3VwSWR4Q2xhc3NJZHMuZm9yRWFjaCgoZ3JvdXBJZHhDbGFzc0lkcykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBbZ3JvdXBJZHgsIGNsYXNzSWR4XSA9IGdyb3VwSWR4Q2xhc3NJZHNcbiAgICAgICAgICAgICAgICAgICAgICAgIC5zcGxpdChcIi9cIilcbiAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoKHZhbHVlKSA9PiBwYXJzZUludCh2YWx1ZSkpO1xuICAgICAgICAgICAgICAgICAgICBuZXdHcm91cC5jbGFzc2VzLnB1c2gob2xkR3JvdXBzW2dyb3VwSWR4XS5jbGFzc2VzW2NsYXNzSWR4XSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgbmV3R3JvdXBzLnB1c2gobmV3R3JvdXApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgbmV3R3JvdXBzLnB1c2gob2xkR3JvdXBzW2lkeF0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgLy8gcmVtb3ZlIGdyb3VwcyB3aXRoIG5vIGNsYXNzZXNcbiAgICAgICAgcmVuZGVyZXIudW5pcXVlVmFsdWVHcm91cHMgPSBuZXdHcm91cHMuZmlsdGVyKChncm91cCkgPT4gISFncm91cC5jbGFzc2VzLmxlbmd0aCk7XG4gICAgICAgIGNvbnN0IGFmdGVyT3RoZXJWYWx1ZXNMZW5ndGggPSBnZXRPdGhlclVuaXF1ZVZhbHVlQ2xhc3NlcygpLmxlbmd0aDtcbiAgICAgICAgdGhpcy5zZWxlY3RlZFZhbHVlID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLnNlbGVjdGVkVmFsdWVUZXh0ID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLmNoZWNrZWRDbGFzc2VzID0gW107XG4gICAgICAgIGlmIChiZWZvcmVPdGhlclZhbHVlc0xlbmd0aCA9PT0gYWZ0ZXJPdGhlclZhbHVlc0xlbmd0aCkge1xuICAgICAgICAgICAgLy8gdXBkYXRlIGRyYWdSZW5kZXJUb2dnbGUgZmxhZyB0byBmb3JjZSByZXJlbmRlciBpZiBhIG5ld2x5IGNyZWF0ZWQgdmFsdWUgd2FzIGRyYWdnZWQgaW50byB0aGUgJ090aGVyJyBncm91cFxuICAgICAgICAgICAgdGhpcy5kcmFnUmVuZGVyVG9nZ2xlID0gIXRoaXMuZHJhZ1JlbmRlclRvZ2dsZTtcbiAgICAgICAgfVxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMudXBkYXRlUmVuZGVyZXJBbmRVSSgpLCAzMDApO1xuICAgICAgICB0aGlzLmNoZWNrQ2x1c3RlcigpO1xuICAgICAgICBsZXQgYWZ0ZXJMZW5ndGggPSAwO1xuICAgICAgICByZW5kZXJlci51bmlxdWVWYWx1ZUdyb3Vwcy5mb3JFYWNoKCh1bmlxdWVWYWx1ZUdyb3VwKSA9PiB7IHZhciBfYSwgX2I7IHJldHVybiAoYWZ0ZXJMZW5ndGggKz0gKF9iID0gKF9hID0gdW5pcXVlVmFsdWVHcm91cC5jbGFzc2VzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKSAhPT0gbnVsbCAmJiBfYiAhPT0gdm9pZCAwID8gX2IgOiAwKTsgfSk7XG4gICAgICAgIGJlZm9yZUxlbmd0aCAhPT0gYWZ0ZXJMZW5ndGggPyB0aGlzLmNoZWNrQ2x1c3RlcigpIDogbnVsbDtcbiAgICB9XG4gICAgaGFuZGxlU29ydEdyb3VwcygpIHtcbiAgICAgICAgY29uc3QgZ3JvdXBJZHhzID0gdGhpcy5ncm91cFNvcnRhYmxlID8gdGhpcy5ncm91cFNvcnRhYmxlLnRvQXJyYXkoKSA6IFtdO1xuICAgICAgICBjb25zdCB7IGxheWVyIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcik7XG4gICAgICAgIHRoaXMuY2xvc2VQb3BvdmVycygpO1xuICAgICAgICBjb25zdCBvbGRHcm91cHMgPSByZW5kZXJlci51bmlxdWVWYWx1ZUdyb3VwcztcbiAgICAgICAgY29uc3QgbmV3R3JvdXBzID0gW107XG4gICAgICAgIGdyb3VwSWR4cy5mb3JFYWNoKChncm91cElkeCkgPT4ge1xuICAgICAgICAgICAgbmV3R3JvdXBzLnB1c2gob2xkR3JvdXBzW3BhcnNlSW50KGdyb3VwSWR4KV0pO1xuICAgICAgICB9KTtcbiAgICAgICAgcmVuZGVyZXIudW5pcXVlVmFsdWVHcm91cHMgPSBuZXdHcm91cHM7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWRWYWx1ZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5zZWxlY3RlZFZhbHVlVGV4dCA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5jaGVja2VkQ2xhc3NlcyA9IFtdO1xuICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICB9XG4gICAgaGFuZGxlVmFsdWVTeW1ib2xDbGljayhncm91cElkeCwgY2xhc3NJZHgpIHtcbiAgICAgICAgdGhpcy5zeW1ib2xOb2Rlc1tncm91cElkeF1bY2xhc3NJZHhdLmNsYXNzTGlzdC5yZW1vdmUoXCJzeW1ib2wtc2VsZWN0b3ItLXNlbGVjdGVkXCIpO1xuICAgICAgICBpZiAodGhpcy5zeW1ib2xTdHlsZXJPcGVuKSB7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkVmFsdWUgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkVmFsdWVUZXh0ID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgY2xvc2VQb3BvdmVycygpO1xuICAgICAgICAgICAgdGhpcy5zeW1ib2xTdHlsZXJPcGVuID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBzZWxlY3RlZFZhbHVlID0gYCR7Z3JvdXBJZHh9LyR7Y2xhc3NJZHh9YDtcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRWYWx1ZSA9IHRoaXMuc2VsZWN0ZWRWYWx1ZSAhPT0gc2VsZWN0ZWRWYWx1ZSA/IHNlbGVjdGVkVmFsdWUgOiB1bmRlZmluZWQ7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkVmFsdWVUZXh0ID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCh0aGlzLnNlbGVjdGVkVmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5vcGVuU3ltYm9sU3R5bGVyRm9yVmFsdWUoZ3JvdXBJZHgsIGNsYXNzSWR4KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuc3ltYm9sTm9kZXNbZ3JvdXBJZHhdW2NsYXNzSWR4XS5jbGFzc0xpc3QucmVtb3ZlKFwic3ltYm9sLXNlbGVjdG9yLS1zZWxlY3RlZFwiKTtcbiAgICAgICAgICAgICAgICBjbG9zZVBvcG92ZXJzKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5zeW1ib2xTdHlsZXJPcGVuID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgaGFuZGxlVmFsdWVUZXh0Q2hhbmdlKGdyb3VwSWR4LCBjbGFzc0lkeCwgbGFiZWwpIHtcbiAgICAgICAgdmFyIF9hO1xuICAgICAgICBjb25zdCB7IGFsbFVuaXF1ZVZhbHVlcywgbGFzdERlZmF1bHQsIGxheWVyOiBzbUxheWVyLCBtb2R1bGVzLCBzdHJpbmdzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgY29uc3QgbGF5ZXIgPSBzbUxheWVyO1xuICAgICAgICBjb25zdCByZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKTtcbiAgICAgICAgY29uc3QgZ3JvdXBzID0gcmVuZGVyZXIudW5pcXVlVmFsdWVHcm91cHM7XG4gICAgICAgIHRoaXMudmFsdWVJbnB1dE5vZGVzW2dyb3VwSWR4XVtjbGFzc0lkeF0uY2xhc3NMaXN0LmFkZChcImhpZGRlblwiKTtcbiAgICAgICAgLy8gb25seSB1cGRhdGUgaWYgbmV3IHZhbHVlIGlzIGRpZmZlcmVudFxuICAgICAgICBpZiAoKChfYSA9IGdyb3Vwc1tncm91cElkeF0pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5jbGFzc2VzW2NsYXNzSWR4XS5sYWJlbCkgIT09IGxhYmVsKSB7XG4gICAgICAgICAgICAvLyBpZiB1c2VyIGNsZWFyZWQgb3V0IGxhYmVsIGVudGlyZWx5LCBzZXQgYmFjayB0byBkZWZhdWx0XG4gICAgICAgICAgICBpZiAoIShsYWJlbCA9PT0gbnVsbCB8fCBsYWJlbCA9PT0gdm9pZCAwID8gdm9pZCAwIDogbGFiZWwubGVuZ3RoKSkge1xuICAgICAgICAgICAgICAgIGlmIChncm91cElkeCA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgbGFiZWwgPSB0aGlzLm9yaWdpbmFsUmVuZGVyZXJKU09OLmRlZmF1bHRMYWJlbCB8fCBzdHJpbmdzLnBhbmVscy50eXBlLm90aGVyO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG1hdGNoaW5nSW5mbyA9IGFsbFVuaXF1ZVZhbHVlcy5maW5kKCh2YWx1ZSkgPT4gdmFsdWUudmFsdWUgPT09IHJlbmRlcmVyLnVuaXF1ZVZhbHVlR3JvdXBzW2dyb3VwSWR4XS5jbGFzc2VzW2NsYXNzSWR4XS52YWx1ZXNbMF0udmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICBsYWJlbCA9XG4gICAgICAgICAgICAgICAgICAgICAgICAobWF0Y2hpbmdJbmZvID09PSBudWxsIHx8IG1hdGNoaW5nSW5mbyA9PT0gdm9pZCAwID8gdm9pZCAwIDogbWF0Y2hpbmdJbmZvLmxhYmVsKSB8fCByZW5kZXJlci51bmlxdWVWYWx1ZUdyb3Vwc1tncm91cElkeF0uY2xhc3Nlc1tjbGFzc0lkeF0ubGFiZWw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGdyb3VwSWR4ID09PSAtMSAmJiAhcmVuZGVyZXIuZGVmYXVsdFN5bWJvbCkge1xuICAgICAgICAgICAgICAgIGxhc3REZWZhdWx0LmRlZmF1bHRMYWJlbCA9IGxhYmVsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGdyb3VwSWR4ID09PSAtMSkge1xuICAgICAgICAgICAgICAgIGlmIChyZW5kZXJlci5kZWZhdWx0U3ltYm9sKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlbmRlcmVyLmRlZmF1bHRMYWJlbCA9IGxhYmVsIHx8IGxhc3REZWZhdWx0LmRlZmF1bHRMYWJlbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBncm91cHMgPSByZW5kZXJlci51bmlxdWVWYWx1ZUdyb3VwcztcbiAgICAgICAgICAgICAgICBjb25zdCBmaWVsZCA9IGdldEZpZWxkKHJlbmRlcmVyLmZpZWxkKTtcbiAgICAgICAgICAgICAgICBpZiAobGFiZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgZ3JvdXBzW2dyb3VwSWR4XS5jbGFzc2VzW2NsYXNzSWR4XS5sYWJlbCA9IGxhYmVsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gcmUtY3JlYXRlIGRlZmF1bHQgbGFiZWxcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGVmYXVsdExhYmVscyA9IGdyb3Vwc1tncm91cElkeF0uY2xhc3Nlc1tjbGFzc0lkeF0udmFsdWVzLm1hcCgodW5pcXVlVmFsdWUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfYTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gdW5pcXVlVmFsdWUudmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkZWZhdWx0TGFiZWwgPSAoX2EgPSBhbGxVbmlxdWVWYWx1ZXMgPT09IG51bGwgfHwgYWxsVW5pcXVlVmFsdWVzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhbGxVbmlxdWVWYWx1ZXMuZmluZCgodXYpID0+IHV2LnZhbHVlID09PSB2YWx1ZSkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sYWJlbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWZhdWx0TGFiZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVmYXVsdExhYmVsO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoKGZpZWxkID09PSBudWxsIHx8IGZpZWxkID09PSB2b2lkIDAgPyB2b2lkIDAgOiBmaWVsZC5zaW1wbGVGaWVsZFR5cGUpID09PSBzaW1wbGVGaWVsZFR5cGVzLkRBVEUgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXRGaWVsZFR5cGUoZmllbGQgPT09IG51bGwgfHwgZmllbGQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGZpZWxkLmxheWVyRmllbGQpID09PSBcImRhdGUtb25seVwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldERhdGVMYWJlbCh2YWx1ZSwgZmllbGQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoKGZpZWxkID09PSBudWxsIHx8IGZpZWxkID09PSB2b2lkIDAgPyB2b2lkIDAgOiBmaWVsZC5zaW1wbGVGaWVsZFR5cGUpID09PSBzaW1wbGVGaWVsZFR5cGVzLk5VTUJFUikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtb2R1bGVzLmludGwuZm9ybWF0TnVtYmVyKHZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0cmluZ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIGdyb3Vwc1tncm91cElkeF0uY2xhc3Nlc1tjbGFzc0lkeF0ubGFiZWwgPSBkZWZhdWx0TGFiZWxzLmpvaW4oXCIsIFwiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmVuZGVyZXIudW5pcXVlVmFsdWVHcm91cHMgPSBncm91cHM7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZWxlY3RlZFZhbHVlVGV4dCA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy51cGRhdGVSZW5kZXJlckFuZFVJKCk7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdGV4dE5vZGUgPSBncm91cElkeCA9PT0gLTEgJiYgY2xhc3NJZHggPT09IC0xXG4gICAgICAgICAgICAgICAgPyB0aGlzLm90aGVyVGV4dE5vZGVcbiAgICAgICAgICAgICAgICA6IHRoaXMudmFsdWVUZXh0Tm9kZXNbZ3JvdXBJZHhdW2NsYXNzSWR4XTtcbiAgICAgICAgICAgIHRleHROb2RlLmNsYXNzTGlzdC5yZW1vdmUoXCJoaWRkZW5cIik7XG4gICAgICAgICAgICB0ZXh0Tm9kZS5mb2N1cygpLCAzMDA7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBoYW5kbGVWYWx1ZVRleHRDbGljayhncm91cElkeCwgY2xhc3NJZHgpIHtcbiAgICAgICAgdmFyIF9hLCBfYjtcbiAgICAgICAgdGhpcy5zZWxlY3RlZFZhbHVlVGV4dCA9IGAke2dyb3VwSWR4fS8ke2NsYXNzSWR4fWA7XG4gICAgICAgIGNvbnN0IHRleHROb2RlID0gZ3JvdXBJZHggPT09IC0xICYmIGNsYXNzSWR4ID09PSAtMVxuICAgICAgICAgICAgPyB0aGlzLm90aGVyVGV4dE5vZGVcbiAgICAgICAgICAgIDogdGhpcy52YWx1ZVRleHROb2Rlc1tncm91cElkeF1bY2xhc3NJZHhdO1xuICAgICAgICB0ZXh0Tm9kZS5jbGFzc0xpc3QuYWRkKFwiaGlkZGVuXCIpO1xuICAgICAgICAoX2EgPSB0aGlzLnZhbHVlSW5wdXROb2Rlc1tncm91cElkeF1bY2xhc3NJZHhdKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY2xhc3NMaXN0LnJlbW92ZShcImhpZGRlblwiKTtcbiAgICAgICAgKF9iID0gdGhpcy52YWx1ZUlucHV0Tm9kZXNbZ3JvdXBJZHhdW2NsYXNzSWR4XSkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnNldEZvY3VzKCk7XG4gICAgfVxuICAgIG9uTW91c2VPdmVyKGlkLCByZWZlcmVuY2VOb2RlLCBsYWJlbCkge1xuICAgICAgICByZW1vdmVTbWFydE1hcHBpbmdUb29sdGlwKCk7XG4gICAgICAgIGFkZFNtYXJ0TWFwcGluZ1Rvb2x0aXBXaXRoSWQocmVmZXJlbmNlTm9kZSwgbGFiZWwsIGlkKTtcbiAgICB9XG4gICAgb25Nb3VzZU91dChpZCkge1xuICAgICAgICByZW1vdmVTbWFydE1hcHBpbmdUb29sdGlwQnlJZChpZCk7XG4gICAgfVxuICAgIG9wZW5TeW1ib2xTdHlsZXJGb3JHcm91cChncm91cElkeCkge1xuICAgICAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgICAgICBjbG9zZVBvcG92ZXJzKCk7XG4gICAgICAgIGNvbnN0IHBvcG92ZXJOb2RlID0gY3JlYXRlU3ltYm9sU3R5bGVyUG9wb3Zlcih7XG4gICAgICAgICAgICByZWZlcmVuY2VFbGVtZW50OiB0aGlzLmZsb3dJdGVtTm9kZSxcbiAgICAgICAgICAgIGhlYWRpbmc6IHN0cmluZ3MucGFuZWxzLnR5cGUuc3ltYm9sU3R5bGVcbiAgICAgICAgfSk7XG4gICAgICAgIHBvcG92ZXJOb2RlLmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNTbWFydE1hcHBpbmdTdHlsZXJQb3BvdmVyQ2xvc2VcIiwgKCkgPT4ge1xuICAgICAgICAgICAgcmVtb3ZlU3ltYm9sU3R5bGVyUG9wb3Zlcihwb3BvdmVyTm9kZSk7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkVmFsdWUgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkVmFsdWVUZXh0ID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgLy8gaWYgd2UgZG8gdGhpcyB0b28gZWFybHkgdGhlIGVudGVyIGtleSBleGVjdXRlcyBvbiB0aGUgZm9jdXNlZCBkaXZcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4geyB2YXIgX2E7IHJldHVybiAoX2EgPSB0aGlzLmdyb3VwTWVudU5vZGVzW2dyb3VwSWR4XSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNldEZvY3VzKCk7IH0sIDMwMCk7XG4gICAgICAgIH0pO1xuICAgICAgICBwb3BvdmVyTm9kZS5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzU21hcnRNYXBwaW5nU3R5bGVyUG9wb3ZlckRpc2Nvbm5lY3RlZFwiLCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkVmFsdWUgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkVmFsdWVUZXh0ID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgcmVtb3ZlU3ltYm9sU3R5bGVyUG9wb3Zlcihwb3BvdmVyTm9kZSk7XG4gICAgICAgICAgICAvLyBpZiB3ZSBkbyB0aGlzIHRvbyBlYXJseSB0aGUgZW50ZXIga2V5IGV4ZWN1dGVzIG9uIHRoZSBmb2N1c2VkIGRpdlxuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IHZhciBfYTsgcmV0dXJuIChfYSA9IHRoaXMuZ3JvdXBNZW51Tm9kZXNbZ3JvdXBJZHhdKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2V0Rm9jdXMoKTsgfSwgMzAwKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGJ1aWxkU3ltYm9sU3R5bGVyRm9yVHlwZUdyb3VwKHtcbiAgICAgICAgICAgIGdyb3VwSWR4LFxuICAgICAgICAgICAgcG9wb3Zlck5vZGUsXG4gICAgICAgICAgICBvbkNoYW5nZTogKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlUmVuZGVyZXJBbmRVSSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgb3BlblN5bWJvbFN0eWxlckZvclZhbHVlKGdyb3VwSWR4LCBjbGFzc0lkeCkge1xuICAgICAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgICAgICBjbG9zZVBvcG92ZXJzKCk7XG4gICAgICAgIGNvbnN0IHBvcG92ZXJOb2RlID0gY3JlYXRlU3ltYm9sU3R5bGVyUG9wb3Zlcih7XG4gICAgICAgICAgICByZWZlcmVuY2VFbGVtZW50OiB0aGlzLmZsb3dJdGVtTm9kZSxcbiAgICAgICAgICAgIGhlYWRpbmc6IHN0cmluZ3MucGFuZWxzLnR5cGUuc3ltYm9sU3R5bGVcbiAgICAgICAgfSk7XG4gICAgICAgIHBvcG92ZXJOb2RlLmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNTbWFydE1hcHBpbmdTdHlsZXJQb3BvdmVyQ2xvc2VcIiwgKCkgPT4ge1xuICAgICAgICAgICAgbGV0IHN5bWJvbE5vZGUgPSB0aGlzLnN5bWJvbE5vZGVzW2dyb3VwSWR4XVtjbGFzc0lkeF07XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkVmFsdWUgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkVmFsdWVUZXh0ID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgcmVtb3ZlU3ltYm9sU3R5bGVyUG9wb3Zlcihwb3BvdmVyTm9kZSk7XG4gICAgICAgICAgICAvLyBpZiB3ZSBkbyB0aGlzIHRvbyBlYXJseSB0aGUgZW50ZXIga2V5IGV4ZWN1dGVzIG9uIHRoZSBmb2N1c2VkIGRpdlxuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgc3ltYm9sTm9kZS5jbGFzc0xpc3QucmVtb3ZlKFwic3ltYm9sLXNlbGVjdG9yLS1zZWxlY3RlZFwiKTtcbiAgICAgICAgICAgICAgICB0aGlzLnN5bWJvbFN0eWxlck9wZW4gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBzeW1ib2xOb2RlLmZvY3VzKCk7XG4gICAgICAgICAgICB9LCAzMDApO1xuICAgICAgICB9KTtcbiAgICAgICAgcG9wb3Zlck5vZGUuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc1NtYXJ0TWFwcGluZ1N0eWxlclBvcG92ZXJEaXNjb25uZWN0ZWRcIiwgKCkgPT4ge1xuICAgICAgICAgICAgbGV0IHN5bWJvbE5vZGUgPSB0aGlzLnN5bWJvbE5vZGVzW2dyb3VwSWR4XVtjbGFzc0lkeF07XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkVmFsdWUgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkVmFsdWVUZXh0ID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgcmVtb3ZlU3ltYm9sU3R5bGVyUG9wb3Zlcihwb3BvdmVyTm9kZSk7XG4gICAgICAgICAgICAvLyBpZiB3ZSBkbyB0aGlzIHRvbyBlYXJseSB0aGUgZW50ZXIga2V5IGV4ZWN1dGVzIG9uIHRoZSBmb2N1c2VkIGRpdlxuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgc3ltYm9sTm9kZS5jbGFzc0xpc3QucmVtb3ZlKFwic3ltYm9sLXNlbGVjdG9yLS1zZWxlY3RlZFwiKTtcbiAgICAgICAgICAgICAgICB0aGlzLnN5bWJvbFN0eWxlck9wZW4gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBzeW1ib2xOb2RlLmZvY3VzKCk7XG4gICAgICAgICAgICB9LCAzMDApO1xuICAgICAgICB9KTtcbiAgICAgICAgYnVpbGRTeW1ib2xTdHlsZXJGb3JUeXBlVmFsdWUoe1xuICAgICAgICAgICAgc2VsZWN0ZWRWYWx1ZTogdGhpcy5zZWxlY3RlZFZhbHVlLFxuICAgICAgICAgICAgcG9wb3Zlck5vZGUsXG4gICAgICAgICAgICBvbkNoYW5nZTogKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlUmVuZGVyZXJBbmRVSSgpO1xuICAgICAgICAgICAgICAgIHRoaXMucm90YXRpb25Ob2RlICYmIGZvcmNlVXBkYXRlKHRoaXMucm90YXRpb25Ob2RlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuc3ltYm9sU3R5bGVyT3BlbiA9IHRydWU7XG4gICAgICAgIHRoaXMuc3ltYm9sTm9kZXNbZ3JvdXBJZHhdW2NsYXNzSWR4XS5jbGFzc0xpc3QuYWRkKFwic3ltYm9sLXNlbGVjdG9yLS1zZWxlY3RlZFwiKTtcbiAgICB9XG4gICAgcmVtb3ZlQWN0aW9uc1BvcG92ZXIoKSB7XG4gICAgICAgIHZhciBfYSwgX2I7XG4gICAgICAgIChfYiA9IChfYSA9IHRoaXMuYWN0aW9uc1BvcG92ZXJOb2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucGFyZW50RWxlbWVudCkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnJlbW92ZUNoaWxkKHRoaXMuYWN0aW9uc1BvcG92ZXJOb2RlKTtcbiAgICAgICAgdGhpcy5hY3Rpb25zUG9wb3Zlck5vZGUgPSBudWxsO1xuICAgIH1cbiAgICBzZXBhcmF0ZUdyb3VwVmFsdWVzKGdyb3VwSWR4KSB7XG4gICAgICAgIGNvbnN0IHsgbGF5ZXIgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgICAgICBjb25zdCByZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKTtcbiAgICAgICAgY29uc3QgZ3JvdXBzID0gcmVuZGVyZXIudW5pcXVlVmFsdWVHcm91cHM7XG4gICAgICAgIHNlcGFyYXRlTWVyZ2VkQ2xhc3Nlcyhncm91cHNbZ3JvdXBJZHhdKTtcbiAgICAgICAgdGhpcy5jaGVja2VkQ2xhc3NlcyA9IFtdO1xuICAgIH1cbiAgICB1cGRhdGVSZW5kZXJlckFuZFVJKCkge1xuICAgICAgICB1cGRhdGVSZW5kZXJlcigpO1xuICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICB9XG4gICAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcbkFyY2dpc1NtYXJ0TWFwcGluZ1BhbmVsc1R5cGUuc3R5bGUgPSBhcmNnaXNTbWFydE1hcHBpbmdQYW5lbHNUeXBlQ3NzO1xuXG5jb25zdCBBcmNnaXNTbWFydE1hcHBpbmdUeXBlQWN0aW9uc1BvcG92ZXIgPSBjbGFzcyB7XG4gICAgY29uc3RydWN0b3IoaG9zdFJlZikge1xuICAgICAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgICAgICB0aGlzLmFyY2dpc1NtYXJ0TWFwcGluZ1R5cGVBY3Rpb25zUG9wb3ZlckNoYW5nZSA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzU21hcnRNYXBwaW5nVHlwZUFjdGlvbnNQb3BvdmVyQ2hhbmdlXCIsIDcpO1xuICAgICAgICB0aGlzLmFyY2dpc1NtYXJ0TWFwcGluZ1R5cGVBY3Rpb25zUG9wb3ZlckZvY3VzRXhpdCA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzU21hcnRNYXBwaW5nVHlwZUFjdGlvbnNQb3BvdmVyRm9jdXNFeGl0XCIsIDcpO1xuICAgICAgICB0aGlzLmNoZWNrZWRDbGFzc2VzID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLmdyb3VwTWVudU5vZGVzID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLnJlZmVyZW5jZU5vZGUgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuc2hvd01vdmVUb0dyb3VwID0gZmFsc2U7XG4gICAgfVxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvL1xuICAgIC8vICBMaWZlY3ljbGVcbiAgICAvL1xuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICBjb21wb25lbnRXaWxsTG9hZCgpIHtcbiAgICAgICAgdGhpcy50b3BBY3Rpb25IYW5kbGVyID0gKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAvLyBzZW5kIGZvY3VzIGJhY2sgdG8gdGhlIHBhbmVsXG4gICAgICAgICAgICBpZiAoZXZlbnQuc2hpZnRLZXkgJiYgZXZlbnQua2V5ID09PSBcIlRhYlwiKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcmNnaXNTbWFydE1hcHBpbmdUeXBlQWN0aW9uc1BvcG92ZXJGb2N1c0V4aXQuZW1pdChcInRvcFwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9XG4gICAgY29tcG9uZW50RGlkUmVuZGVyKCkge1xuICAgICAgICB2YXIgX2EsIF9iO1xuICAgICAgICBjb25zdCB0b3BBY3Rpb24gPSAoISgoX2EgPSB0aGlzLm1vdmVVcE5vZGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5kaXNhYmxlZCkgPyB0aGlzLm1vdmVVcE5vZGUgOiB1bmRlZmluZWQpIHx8XG4gICAgICAgICAgICAoISgoX2IgPSB0aGlzLm1vdmVEb3duTm9kZSkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmRpc2FibGVkKSA/IHRoaXMubW92ZURvd25Ob2RlIDogdW5kZWZpbmVkKSB8fFxuICAgICAgICAgICAgdGhpcy5tZXJnZU5vZGUgfHxcbiAgICAgICAgICAgIHRoaXMuc2VwYXJhdGVOb2RlIHx8XG4gICAgICAgICAgICB0aGlzLm1vdmVUb0dyb3VwTm9kZTtcbiAgICAgICAgdG9wQWN0aW9uID09PSBudWxsIHx8IHRvcEFjdGlvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogdG9wQWN0aW9uLnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJrZXlkb3duXCIsIHRoaXMudG9wQWN0aW9uSGFuZGxlcik7XG4gICAgICAgIHRvcEFjdGlvbi5hZGRFdmVudExpc3RlbmVyKFwia2V5ZG93blwiLCB0aGlzLnRvcEFjdGlvbkhhbmRsZXIpO1xuICAgIH1cbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy9cbiAgICAvLyAgUHVibGljIG1ldGhvZHNcbiAgICAvL1xuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICBhc3luYyBmb2N1c0FjdGlvblBhZCgpIHtcbiAgICAgICAgdmFyIF9hO1xuICAgICAgICAoX2EgPSB0aGlzLmFjdGlvblBhZE5vZGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zZXRGb2N1cygpO1xuICAgIH1cbiAgICBhc3luYyBmb2N1c0xhc3RBY3Rpb24oKSB7XG4gICAgICAgIGlmICh0aGlzLmFjdGlvblBhZE5vZGUpIHtcbiAgICAgICAgICAgIGxldCBhY3Rpb25Ob2RlcyA9IEFycmF5LmZyb20odGhpcy5hY3Rpb25QYWROb2RlLnF1ZXJ5U2VsZWN0b3JBbGwoXCJjYWxjaXRlLWFjdGlvblwiKSk7XG4gICAgICAgICAgICBsZXQgZW5hYmxlZEFjdGlvbk5vZGVzID0gYWN0aW9uTm9kZXMuZmlsdGVyKChub2RlKSA9PiBub2RlLmRpc2FibGVkID09PSBmYWxzZSk7XG4gICAgICAgICAgICBlbmFibGVkQWN0aW9uTm9kZXNbZW5hYmxlZEFjdGlvbk5vZGVzLmxlbmd0aCAtIDFdLnNldEZvY3VzKCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vXG4gICAgLy8gIFJlbmRlciBNZXRob2RzXG4gICAgLy9cbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgcmVuZGVyKCkge1xuICAgICAgICB2YXIgX2EsIF9iO1xuICAgICAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgICAgICBpZiAoISgoX2EgPSB0aGlzLmNoZWNrZWRDbGFzc2VzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcmVjdCA9IChfYiA9IHRoaXMucmVmZXJlbmNlTm9kZSkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgICAgICByZXR1cm4gKGgoSG9zdCwgbnVsbCwgaChcImNhbGNpdGUtcG9wb3ZlclwiLCB7IGNsYXNzOiBcImpzLWFwcC1mbHlvdXRcIiwgcGxhY2VtZW50OiBcImxlYWRpbmctc3RhcnRcIiwgb2Zmc2V0RGlzdGFuY2U6IDEwLCBvZmZzZXRTa2lkZGluZzogKHJlY3QuaGVpZ2h0IC0gMTIwKSAvIDQgKyA3MCwgcG9pbnRlckRpc2FibGVkOiB0cnVlLCBsYWJlbDogc3RyaW5ncy5wYW5lbHMudHlwZS50eXBlQWN0aW9ucywgdHJpZ2dlckRpc2FibGVkOiB0cnVlLCByZWZlcmVuY2VFbGVtZW50OiB0aGlzLnJlZmVyZW5jZU5vZGUsIG9wZW46IHRydWUsIHJlZjogKG5vZGUpID0+ICh0aGlzLnBvcG92ZXJOb2RlID0gbm9kZSkgfSwgdGhpcy5zaG93TW92ZVRvR3JvdXAgPyB0aGlzLnJlbmRlck1vdmVUb0dyb3VwKCkgOiB0aGlzLnJlbmRlckFjdGlvbnMoKSkpKTtcbiAgICB9XG4gICAgcmVuZGVyQWN0aW9ucygpIHtcbiAgICAgICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1hY3Rpb24tcGFkXCIsIHsgbGF5b3V0OiBcInZlcnRpY2FsXCIsIHBvc2l0aW9uOiBcInN0YXJ0XCIsIGV4cGFuZGVkOiB0cnVlLCBleHBhbmREaXNhYmxlZDogdHJ1ZSwgcmVmOiAobm9kZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChub2RlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYWN0aW9uUGFkTm9kZSA9IG5vZGU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSB9LCB0aGlzLnJlbmRlckdyb3VwMSgpLCB0aGlzLnJlbmRlckdyb3VwMigpLCB0aGlzLnJlbmRlckdyb3VwMygpKSk7XG4gICAgfVxuICAgIHJlbmRlck1vdmVUb0dyb3VwKCkge1xuICAgICAgICBpZiAoIXRoaXMuc2hvd01vdmVUb0dyb3VwKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB7IGxheWVyLCBzdHJpbmdzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcik7XG4gICAgICAgIGNvbnN0IGdyb3VwcyA9IHJlbmRlcmVyLnVuaXF1ZVZhbHVlR3JvdXBzO1xuICAgICAgICBjb25zdCBtdWx0aXBsZUdyb3VwcyA9ICEhdGhpcy5jaGVja2VkQ2xhc3Nlcy5maW5kKChjaGVja2VkQ2xhc3MpID0+IGNoZWNrZWRDbGFzcy5ncm91cElkeCAhPT0gdGhpcy5jaGVja2VkQ2xhc3Nlc1swXS5ncm91cElkeCk7XG4gICAgICAgIGNvbnN0IGRpc2FibGVHcm91cElkeCA9ICFtdWx0aXBsZUdyb3VwcyAmJiB0aGlzLmNoZWNrZWRDbGFzc2VzWzBdLmdyb3VwSWR4O1xuICAgICAgICBjb25zdCBsaXN0SXRlbXMgPSBncm91cHMubWFwKChncm91cCwgaWR4KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZW5kZXJNb3ZlVG9Hcm91cExpc3RJdGVtKGdyb3VwLCBpZHgpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1wYW5lbFwiLCB7IGhlYWRpbmc6IHN0cmluZ3MucGFuZWxzLnR5cGUubW92ZVRvR3JvdXAsIGNsb3NhYmxlOiB0cnVlLCBvbkNhbGNpdGVQYW5lbENsb3NlOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5zaG93TW92ZVRvR3JvdXAgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMubW92ZVRvR3JvdXBOb2RlLnNldEZvY3VzKCksIDMwMCk7XG4gICAgICAgICAgICB9LCByZWY6IChub2RlKSA9PiBub2RlID09PSBudWxsIHx8IG5vZGUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG5vZGUuc2V0Rm9jdXMoKSB9LCBoKFwiY2FsY2l0ZS1saXN0XCIsIHsgZmlsdGVyRW5hYmxlZDogZ3JvdXBzLmxlbmd0aCA+PSAxMCwgZmlsdGVyUGxhY2Vob2xkZXI6IHN0cmluZ3MucGFuZWxzLnR5cGUuc2VhcmNoR3JvdXBzLCBsYWJlbDogc3RyaW5ncy5wYW5lbHMudHlwZS5zZWxlY3RHcm91cCwgc2VsZWN0aW9uTW9kZTogXCJzaW5nbGVcIiB9LCBsaXN0SXRlbXMsICFyZW5kZXJlci51bmlxdWVWYWx1ZUdyb3Vwcy5sZW5ndGggJiYgKGgoXCJjYWxjaXRlLWxpc3QtaXRlbVwiLCB7IGxhYmVsOiBzdHJpbmdzLnBhbmVscy50eXBlLnVudGl0bGVkR3JvdXAsIG9uQ2FsY2l0ZUxpc3RJdGVtU2VsZWN0OiAoKSA9PiB0aGlzLm1vdmVUb05ld0dyb3VwKHRydWUpIH0pKSwgaChcImNhbGNpdGUtbGlzdC1pdGVtXCIsIHsgbGFiZWw6IHJlbmRlcmVyLmRlZmF1bHRMYWJlbCB8fCBzdHJpbmdzLnBhbmVscy50eXBlLm90aGVyLCB2YWx1ZTogLTEsIGRpc2FibGVkOiBkaXNhYmxlR3JvdXBJZHggPT09IC0xLCBvbkNhbGNpdGVMaXN0SXRlbVNlbGVjdDogKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tlZENsYXNzZXMuc29ydCgoYSwgYikgPT4gYi5ncm91cElkeCAtIGEuZ3JvdXBJZHggPT09IDAgPyBiLmNsYXNzSWR4IC0gYS5jbGFzc0lkeCA6IGIuZ3JvdXBJZHggLSBhLmdyb3VwSWR4KTtcbiAgICAgICAgICAgICAgICB0aGlzLmNoZWNrZWRDbGFzc2VzLmZvckVhY2goKGNoZWNrZWRDbGFzcykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2hlY2tlZENsYXNzLmdyb3VwSWR4ICE9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBzW2NoZWNrZWRDbGFzcy5ncm91cElkeF0uY2xhc3Nlcy5zcGxpY2UoY2hlY2tlZENsYXNzLmNsYXNzSWR4LCAxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZ3JvdXBzW2NoZWNrZWRDbGFzcy5ncm91cElkeF0uY2xhc3Nlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cHMuc3BsaWNlKGNoZWNrZWRDbGFzcy5ncm91cElkeCwgMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB0aGlzLmNoZWNrZWRDbGFzc2VzID0gW107XG4gICAgICAgICAgICAgICAgcmVuZGVyZXIudW5pcXVlVmFsdWVHcm91cHMgPSBncm91cHM7XG4gICAgICAgICAgICAgICAgdXBkYXRlUmVuZGVyZXIoKTtcbiAgICAgICAgICAgICAgICB0aGlzLnBvcG92ZXJOb2RlLm9wZW4gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB0aGlzLmFyY2dpc1NtYXJ0TWFwcGluZ1R5cGVBY3Rpb25zUG9wb3ZlckNoYW5nZS5lbWl0KHtcbiAgICAgICAgICAgICAgICAgICAgY2hlY2tlZENsYXNzZXM6IHRoaXMuY2hlY2tlZENsYXNzZXNcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAvLyBpZiB3ZSBkbyB0aGlzIHRvbyBlYXJseSB0aGUgZW50ZXIga2V5IGV4ZWN1dGVzIG9uIHRoZSBmb2N1c2VkIGRpdlxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4geyB2YXIgX2E7IHJldHVybiAoX2EgPSB0aGlzLmdyb3VwTWVudU5vZGVzWy0xXSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNldEZvY3VzKCk7IH0sIDMwMCk7XG4gICAgICAgICAgICB9IH0pKSwgaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgYXBwZWFyYW5jZTogXCJvdXRsaW5lXCIsIGxhYmVsOiBzdHJpbmdzLmNhbmNlbCwgaW5uZXJIVE1MOiBzdHJpbmdzLmNhbmNlbCwgd2lkdGg6IFwiZnVsbFwiLCBzbG90OiBcImZvb3RlclwiLCBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5zaG93TW92ZVRvR3JvdXAgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMubW92ZVRvR3JvdXBOb2RlLnNldEZvY3VzKCksIDMwMCk7XG4gICAgICAgICAgICB9IH0pKSk7XG4gICAgfVxuICAgIHJlbmRlck1vdmVUb0dyb3VwTGlzdEl0ZW0oZ3JvdXAsIGlkeCkge1xuICAgICAgICBjb25zdCB7IGxheWVyLCBzdHJpbmdzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcik7XG4gICAgICAgIGNvbnN0IGdyb3VwcyA9IHJlbmRlcmVyLnVuaXF1ZVZhbHVlR3JvdXBzO1xuICAgICAgICBjb25zdCBtdWx0aXBsZUdyb3VwcyA9ICEhdGhpcy5jaGVja2VkQ2xhc3Nlcy5maW5kKChjaGVja2VkQ2xhc3MpID0+IGNoZWNrZWRDbGFzcy5ncm91cElkeCAhPT0gdGhpcy5jaGVja2VkQ2xhc3Nlc1swXS5ncm91cElkeCk7XG4gICAgICAgIGNvbnN0IGRpc2FibGVHcm91cElkeCA9ICFtdWx0aXBsZUdyb3VwcyAmJiB0aGlzLmNoZWNrZWRDbGFzc2VzWzBdLmdyb3VwSWR4O1xuICAgICAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWxpc3QtaXRlbVwiLCB7IGxhYmVsOiBncm91cC5oZWFkaW5nIHx8IHN0cmluZ3MucGFuZWxzLnR5cGUudW50aXRsZWRHcm91cCwgdmFsdWU6IGlkeCwgZGlzYWJsZWQ6IGRpc2FibGVHcm91cElkeCA9PT0gaWR4LCBvbkNhbGNpdGVMaXN0SXRlbVNlbGVjdDogKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3Qgbm9kZSA9IGV2ZW50LnRhcmdldDtcbiAgICAgICAgICAgICAgICBjb25zdCBpZHggPSBub2RlLnZhbHVlO1xuICAgICAgICAgICAgICAgIGxldCB1bmlxdWVWYWx1ZUNsYXNzZXMgPSB0aGlzLmNoZWNrZWRDbGFzc2VzXG4gICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoKGNoZWNrZWRDbGFzcykgPT4gY2hlY2tlZENsYXNzLmdyb3VwSWR4ICE9PSAtMSlcbiAgICAgICAgICAgICAgICAgICAgLm1hcCgoY2hlY2tlZENsYXNzKSA9PiBncm91cHNbY2hlY2tlZENsYXNzLmdyb3VwSWR4XS5jbGFzc2VzW2NoZWNrZWRDbGFzcy5jbGFzc0lkeF0pO1xuICAgICAgICAgICAgICAgIGNvbnN0IG90aGVyVW5pcXVlVmFsdWVDbGFzc2VzID0gZ2V0T3RoZXJVbmlxdWVWYWx1ZUNsYXNzZXMoKTtcbiAgICAgICAgICAgICAgICB1bmlxdWVWYWx1ZUNsYXNzZXMgPSB1bmlxdWVWYWx1ZUNsYXNzZXMuY29uY2F0KHRoaXMuY2hlY2tlZENsYXNzZXNcbiAgICAgICAgICAgICAgICAgICAgLmZpbHRlcigoY2hlY2tlZENsYXNzKSA9PiBjaGVja2VkQ2xhc3MuZ3JvdXBJZHggPT09IC0xKVxuICAgICAgICAgICAgICAgICAgICAubWFwKChjaGVja2VkQ2xhc3MpID0+IG90aGVyVW5pcXVlVmFsdWVDbGFzc2VzW2NoZWNrZWRDbGFzcy5jbGFzc0lkeF0pKTtcbiAgICAgICAgICAgICAgICBjb25zdCBncm91cCA9IGdyb3Vwc1tpZHhdO1xuICAgICAgICAgICAgICAgIGdyb3VwLmNsYXNzZXMgPSBncm91cC5jbGFzc2VzLmNvbmNhdCh1bmlxdWVWYWx1ZUNsYXNzZXMpO1xuICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBmcm9tIG9sZCBwb3NpdGlvblxuICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tlZENsYXNzZXMuc29ydCgoYSwgYikgPT4gYi5ncm91cElkeCAtIGEuZ3JvdXBJZHggPT09IDAgPyBiLmNsYXNzSWR4IC0gYS5jbGFzc0lkeCA6IGIuZ3JvdXBJZHggLSBhLmdyb3VwSWR4KTtcbiAgICAgICAgICAgICAgICB0aGlzLmNoZWNrZWRDbGFzc2VzLmZvckVhY2goKGNoZWNrZWRDbGFzcykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2hlY2tlZENsYXNzLmdyb3VwSWR4ICE9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBzW2NoZWNrZWRDbGFzcy5ncm91cElkeF0uY2xhc3Nlcy5zcGxpY2UoY2hlY2tlZENsYXNzLmNsYXNzSWR4LCAxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZ3JvdXBzW2NoZWNrZWRDbGFzcy5ncm91cElkeF0uY2xhc3Nlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cHMuc3BsaWNlKGNoZWNrZWRDbGFzcy5ncm91cElkeCwgMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB0aGlzLmNoZWNrZWRDbGFzc2VzID0gW107XG4gICAgICAgICAgICAgICAgcmVuZGVyZXIudW5pcXVlVmFsdWVHcm91cHMgPSBncm91cHM7XG4gICAgICAgICAgICAgICAgdXBkYXRlUmVuZGVyZXIoKTtcbiAgICAgICAgICAgICAgICB0aGlzLnBvcG92ZXJOb2RlLm9wZW4gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB0aGlzLmFyY2dpc1NtYXJ0TWFwcGluZ1R5cGVBY3Rpb25zUG9wb3ZlckNoYW5nZS5lbWl0KHtcbiAgICAgICAgICAgICAgICAgICAgY2hlY2tlZENsYXNzZXM6IHRoaXMuY2hlY2tlZENsYXNzZXNcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAvLyBpZiB3ZSBkbyB0aGlzIHRvbyBlYXJseSB0aGUgZW50ZXIga2V5IGV4ZWN1dGVzIG9uIHRoZSBmb2N1c2VkIGRpdlxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4geyB2YXIgX2E7IHJldHVybiAoX2EgPSB0aGlzLmdyb3VwTWVudU5vZGVzW2lkeF0pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zZXRGb2N1cygpOyB9LCAzMDApO1xuICAgICAgICAgICAgfSB9KSk7XG4gICAgfVxuICAgIHJlbmRlckdyb3VwMSgpIHtcbiAgICAgICAgdmFyIF9hO1xuICAgICAgICBjb25zdCB7IGxheWVyLCBzdHJpbmdzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcik7XG4gICAgICAgIGNvbnN0IGdyb3VwcyA9IHJlbmRlcmVyLnVuaXF1ZVZhbHVlR3JvdXBzO1xuICAgICAgICBjb25zdCBjbGFzc0lkeHMgPSB0aGlzLmNoZWNrZWRDbGFzc2VzLm1hcCgoY2hlY2tlZENsYXNzKSA9PiBjaGVja2VkQ2xhc3MuY2xhc3NJZHgpO1xuICAgICAgICBjb25zdCBsZW4gPSBjbGFzc0lkeHMubGVuZ3RoO1xuICAgICAgICBjb25zdCBncnBDbHNMZW4gPSAoX2EgPSBncm91cHNbdGhpcy5jaGVja2VkQ2xhc3Nlc1swXS5ncm91cElkeF0pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5jbGFzc2VzLmxlbmd0aDtcbiAgICAgICAgY2xhc3NJZHhzLnNvcnQoKGEsIGIpID0+IGEgLSBiKTtcbiAgICAgICAgY29uc3QgY2FuTW92ZVVwID0gY2xhc3NJZHhzWzBdID4gMCB8fFxuICAgICAgICAgICAgISFjbGFzc0lkeHMuZmluZCgoY2xhc3NJZHgsIGlkeCkgPT4gaWR4ID4gMCAmJiBjbGFzc0lkeCAtIDEgPiBjbGFzc0lkeHNbaWR4IC0gMV0pO1xuICAgICAgICBjb25zdCBjYW5Nb3ZlRG93biA9IGNsYXNzSWR4c1tsZW4gLSAxXSA8IGdycENsc0xlbiAtIDEgfHxcbiAgICAgICAgICAgICEhY2xhc3NJZHhzLmZpbmQoKGNsYXNzSWR4LCBpZHgpID0+IGlkeCA8IGxlbiAtIDEgJiYgY2xhc3NJZHggKyAxIDwgY2xhc3NJZHhzW2lkeCArIDFdKTtcbiAgICAgICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1hY3Rpb24tZ3JvdXBcIiwgbnVsbCwgaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgdGV4dDogc3RyaW5ncy5wYW5lbHMudHlwZS5tb3ZlVXAsIHRleHRFbmFibGVkOiB0cnVlLCBkaXNhYmxlZDogIWNhbk1vdmVVcCwgaWNvbjogXCJhcnJvdy1ib2xkLXVwXCIsIG9uQ2xpY2s6ICgpID0+IHRoaXMubW92ZVVwKCksIHJlZjogKG5vZGUpID0+ICh0aGlzLm1vdmVVcE5vZGUgPSBub2RlKSB9KSwgaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgdGV4dDogc3RyaW5ncy5wYW5lbHMudHlwZS5tb3ZlRG93biwgdGV4dEVuYWJsZWQ6IHRydWUsIGRpc2FibGVkOiAhY2FuTW92ZURvd24sIGljb246IFwiYXJyb3ctYm9sZC1kb3duXCIsIG9uQ2xpY2s6ICgpID0+IHRoaXMubW92ZURvd24oKSwgcmVmOiAobm9kZSkgPT4gKHRoaXMubW92ZURvd25Ob2RlID0gbm9kZSkgfSkpKTtcbiAgICB9XG4gICAgcmVuZGVyR3JvdXAyKCkge1xuICAgICAgICBjb25zdCB7IGxheWVyLCBzdHJpbmdzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcik7XG4gICAgICAgIGNvbnN0IGdyb3VwcyA9IHJlbmRlcmVyLnVuaXF1ZVZhbHVlR3JvdXBzO1xuICAgICAgICBjb25zdCBtdWx0aXBsZUdyb3VwcyA9ICEhdGhpcy5jaGVja2VkQ2xhc3Nlcy5maW5kKChjaGVja2VkQ2xhc3MpID0+IGNoZWNrZWRDbGFzcy5ncm91cElkeCAhPT0gdGhpcy5jaGVja2VkQ2xhc3Nlc1swXS5ncm91cElkeCk7XG4gICAgICAgIGNvbnN0IGNhbk1lcmdlID0gISF0aGlzLmNoZWNrZWRDbGFzc2VzLmZpbmQoKGluZm8pID0+IGluZm8uZ3JvdXBJZHggIT09IC0xKSAmJlxuICAgICAgICAgICAgdGhpcy5jaGVja2VkQ2xhc3Nlcy5sZW5ndGggPiAxO1xuICAgICAgICBjb25zdCBjYW5TZXBhcmF0ZSA9ICEhdGhpcy5jaGVja2VkQ2xhc3Nlcy5maW5kKChpbmZvKSA9PiBpbmZvLmdyb3VwSWR4ICE9PSAtMSAmJiBncm91cHNbaW5mby5ncm91cElkeF0uY2xhc3Nlc1tpbmZvLmNsYXNzSWR4XS52YWx1ZXMubGVuZ3RoID4gMSk7XG4gICAgICAgIGNvbnN0IGRpc2FibGVkID0gIW11bHRpcGxlR3JvdXBzICYmXG4gICAgICAgICAgICB0aGlzLmNoZWNrZWRDbGFzc2VzWzBdLmdyb3VwSWR4ICE9PSAtMSAmJlxuICAgICAgICAgICAgdGhpcy5jaGVja2VkQ2xhc3Nlcy5sZW5ndGggPT09IGdyb3Vwc1t0aGlzLmNoZWNrZWRDbGFzc2VzWzBdLmdyb3VwSWR4XS5jbGFzc2VzLmxlbmd0aDtcbiAgICAgICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1hY3Rpb24tZ3JvdXBcIiwgbnVsbCwgY2FuTWVyZ2UgJiYgKGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IHRleHQ6IHN0cmluZ3MucGFuZWxzLnR5cGUubWVyZ2VWYWx1ZXMsIHRleHRFbmFibGVkOiB0cnVlLCBvbkNsaWNrOiAoKSA9PiB0aGlzLm1lcmdlVmFsdWVzKCksIHJlZjogKG5vZGUpID0+ICh0aGlzLm1lcmdlTm9kZSA9IG5vZGUpIH0pKSwgY2FuU2VwYXJhdGUgJiYgKGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IHRleHQ6IHN0cmluZ3MucGFuZWxzLnR5cGUuc2VwYXJhdGVWYWx1ZXMsIHRleHRFbmFibGVkOiB0cnVlLCBvbkNsaWNrOiAoKSA9PiB0aGlzLnNlcGFyYXRlU2VsZWN0ZWRWYWx1ZXMoKSwgcmVmOiAobm9kZSkgPT4gKHRoaXMuc2VwYXJhdGVOb2RlID0gbm9kZSkgfSkpLCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyB0ZXh0OiBzdHJpbmdzLnBhbmVscy50eXBlLm1vdmVUb0dyb3VwLCB0ZXh0RW5hYmxlZDogdHJ1ZSwgb25DbGljazogKCkgPT4gdGhpcy5tb3ZlVG9Hcm91cCgpLCByZWY6IChub2RlKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKG5vZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb3ZlVG9Hcm91cE5vZGUgPSBub2RlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gfSksIGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IHRleHQ6IHN0cmluZ3MucGFuZWxzLnR5cGUubmV3R3JvdXAsIHRleHRFbmFibGVkOiB0cnVlLCBkaXNhYmxlZDogZGlzYWJsZWQsIG9uQ2xpY2s6ICgpID0+IHRoaXMubW92ZVRvTmV3R3JvdXAoKSwgcmVmOiAobm9kZSkgPT4gKHRoaXMubW92ZVRvTmV3R3JvdXBOb2RlID0gbm9kZSkgfSkpKTtcbiAgICB9XG4gICAgcmVuZGVyR3JvdXAzKCkge1xuICAgICAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgICAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWFjdGlvbi1ncm91cFwiLCBudWxsLCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyB0ZXh0OiBzdHJpbmdzLnBhbmVscy50eXBlLmNsZWFyU2VsZWN0aW9uLCB0ZXh0RW5hYmxlZDogdHJ1ZSwgb25DbGljazogKCkgPT4gdGhpcy5jbGVhclNlbGVjdGlvbigpLCBvbktleURvd246IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghZXZlbnQuc2hpZnRLZXkgJiYgZXZlbnQua2V5ID09PSBcIlRhYlwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXJjZ2lzU21hcnRNYXBwaW5nVHlwZUFjdGlvbnNQb3BvdmVyRm9jdXNFeGl0LmVtaXQoXCJib3R0b21cIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSB9KSkpO1xuICAgIH1cbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy9cbiAgICAvLyAgUHJpdmF0ZSBNZXRob2RzXG4gICAgLy9cbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgY2xlYXJTZWxlY3Rpb24oKSB7XG4gICAgICAgIGxldCBtaW5Hcm91cCA9IC0xO1xuICAgICAgICB0aGlzLmNoZWNrZWRDbGFzc2VzLmZvckVhY2goKGNoZWNrZWRDbGFzcykgPT4gKG1pbkdyb3VwID1cbiAgICAgICAgICAgIGNoZWNrZWRDbGFzcy5ncm91cElkeCA9PT0gLTFcbiAgICAgICAgICAgICAgICA/IG1pbkdyb3VwXG4gICAgICAgICAgICAgICAgOiBtaW5Hcm91cCA9PT0gLTFcbiAgICAgICAgICAgICAgICAgICAgPyBjaGVja2VkQ2xhc3MuZ3JvdXBJZHhcbiAgICAgICAgICAgICAgICAgICAgOiBNYXRoLm1pbihtaW5Hcm91cCwgY2hlY2tlZENsYXNzLmdyb3VwSWR4KSkpO1xuICAgICAgICB0aGlzLmNoZWNrZWRDbGFzc2VzID0gW107XG4gICAgICAgIHRoaXMucG9wb3Zlck5vZGUub3BlbiA9IGZhbHNlO1xuICAgICAgICB0aGlzLmFyY2dpc1NtYXJ0TWFwcGluZ1R5cGVBY3Rpb25zUG9wb3ZlckNoYW5nZS5lbWl0KHsgY2hlY2tlZENsYXNzZXM6IHRoaXMuY2hlY2tlZENsYXNzZXMgfSk7XG4gICAgICAgIC8vIGlmIHdlIGRvIHRoaXMgdG9vIGVhcmx5IHRoZSBlbnRlciBrZXkgZXhlY3V0ZXMgb24gdGhlIGZvY3VzZWQgZGl2XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4geyB2YXIgX2E7IHJldHVybiAoX2EgPSB0aGlzLmdyb3VwTWVudU5vZGVzW21pbkdyb3VwXSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNldEZvY3VzKCk7IH0sIDMwMCk7XG4gICAgfVxuICAgIG1lcmdlVmFsdWVzKCkge1xuICAgICAgICBjb25zdCB7IGxheWVyIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcik7XG4gICAgICAgIGNvbnN0IGdyb3VwcyA9IHJlbmRlcmVyLnVuaXF1ZVZhbHVlR3JvdXBzO1xuICAgICAgICB0aGlzLmNoZWNrZWRDbGFzc2VzLnNvcnQoKGEsIGIpID0+IGEuZ3JvdXBJZHggLSBiLmdyb3VwSWR4ID09PSAwXG4gICAgICAgICAgICA/IGEuY2xhc3NJZHggLSBiLmNsYXNzSWR4XG4gICAgICAgICAgICA6IGEuZ3JvdXBJZHggPT09IC0xIHx8IGIuZ3JvdXBJZHggPT09IC0xXG4gICAgICAgICAgICAgICAgPyBiLmdyb3VwSWR4IC0gYS5ncm91cElkeFxuICAgICAgICAgICAgICAgIDogYS5ncm91cElkeCAtIGIuZ3JvdXBJZHgpO1xuICAgICAgICBjb25zdCBtZXJnZWRDbGFzcyA9IGdyb3Vwc1t0aGlzLmNoZWNrZWRDbGFzc2VzWzBdLmdyb3VwSWR4XS5jbGFzc2VzW3RoaXMuY2hlY2tlZENsYXNzZXNbMF0uY2xhc3NJZHhdO1xuICAgICAgICBjb25zdCBvdGhlclVuaXF1ZVZhbHVlQ2xhc3NlcyA9IGdldE90aGVyVW5pcXVlVmFsdWVDbGFzc2VzKCk7XG4gICAgICAgIHRoaXMuY2hlY2tlZENsYXNzZXMuZm9yRWFjaCgoaW5mbywgaWR4KSA9PiB7XG4gICAgICAgICAgICAvLyBtZXJnZSBhbGwgdmFsdWVzIHRvIHRoaXMuY2hlY2tlZENsYXNzZXNbMF1cbiAgICAgICAgICAgIGlmIChpZHggPiAwKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdXZDbGFzcyA9IGluZm8uZ3JvdXBJZHggPT09IC0xXG4gICAgICAgICAgICAgICAgICAgID8gb3RoZXJVbmlxdWVWYWx1ZUNsYXNzZXNbaW5mby5jbGFzc0lkeF1cbiAgICAgICAgICAgICAgICAgICAgOiBncm91cHNbaW5mby5ncm91cElkeF0uY2xhc3Nlc1tpbmZvLmNsYXNzSWR4XTtcbiAgICAgICAgICAgICAgICBtZXJnZWRDbGFzcy52YWx1ZXMgPSBtZXJnZWRDbGFzcy52YWx1ZXMuY29uY2F0KHV2Q2xhc3MudmFsdWVzKTtcbiAgICAgICAgICAgICAgICBtZXJnZWRDbGFzcy5sYWJlbCArPSBgLCAke3V2Q2xhc3MubGFiZWx9YDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IG5ld0dyb3VwcyA9IFtdO1xuICAgICAgICBncm91cHMuZm9yRWFjaCgoZ3JvdXAsIGdyb3VwSWR4KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBuZXdDbGFzc2VzID0gW107XG4gICAgICAgICAgICBncm91cC5jbGFzc2VzLmZvckVhY2goKHV2Q2xhc3MsIGNsYXNzSWR4KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuY2hlY2tlZENsYXNzZXNbMF0uZ3JvdXBJZHggPT09IGdyb3VwSWR4ICYmXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tlZENsYXNzZXNbMF0uY2xhc3NJZHggPT09IGNsYXNzSWR4KSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIHJlcGxhY2Ugd2l0aCB0aGUgbWVyZ2VkIGNsYXNzXG4gICAgICAgICAgICAgICAgICAgIG5ld0NsYXNzZXMucHVzaChtZXJnZWRDbGFzcyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKCF0aGlzLmNoZWNrZWRDbGFzc2VzLmZpbmQoKGluZm8pID0+IGluZm8uZ3JvdXBJZHggPT09IGdyb3VwSWR4ICYmIGluZm8uY2xhc3NJZHggPT09IGNsYXNzSWR4KSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBrZWVwIGFzIGlzXG4gICAgICAgICAgICAgICAgICAgIG5ld0NsYXNzZXMucHVzaCh1dkNsYXNzKTtcbiAgICAgICAgICAgICAgICB9IC8vIGVsc2UgcmVtb3ZlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGlmIChuZXdDbGFzc2VzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGdyb3VwLmNsYXNzZXMgPSBuZXdDbGFzc2VzO1xuICAgICAgICAgICAgICAgIG5ld0dyb3Vwcy5wdXNoKGdyb3VwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJlbmRlcmVyLnVuaXF1ZVZhbHVlR3JvdXBzID0gbmV3R3JvdXBzO1xuICAgICAgICB0aGlzLmNoZWNrZWRDbGFzc2VzID0gW107XG4gICAgICAgIHVwZGF0ZVJlbmRlcmVyKCk7XG4gICAgICAgIHRoaXMucG9wb3Zlck5vZGUub3BlbiA9IGZhbHNlO1xuICAgICAgICB0aGlzLmFyY2dpc1NtYXJ0TWFwcGluZ1R5cGVBY3Rpb25zUG9wb3ZlckNoYW5nZS5lbWl0KHsgY2hlY2tlZENsYXNzZXM6IHRoaXMuY2hlY2tlZENsYXNzZXMgfSk7XG4gICAgfVxuICAgIG1vdmVEb3duKCkge1xuICAgICAgICBjb25zdCB7IGxheWVyLCBtb2R1bGVzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgY29uc3QgdXZSZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKTtcbiAgICAgICAgY29uc3QgZ3JvdXBzID0gdXZSZW5kZXJlci51bmlxdWVWYWx1ZUdyb3VwcztcbiAgICAgICAgY29uc3QgZ3JvdXAgPSBncm91cHNbdGhpcy5jaGVja2VkQ2xhc3Nlc1swXS5ncm91cElkeF07XG4gICAgICAgIHRoaXMuY2hlY2tlZENsYXNzZXMuc29ydCgoYSwgYikgPT4gYi5ncm91cElkeCAtIGEuZ3JvdXBJZHggPT09IDAgPyBiLmNsYXNzSWR4IC0gYS5jbGFzc0lkeCA6IGIuZ3JvdXBJZHggLSBhLmdyb3VwSWR4KTtcbiAgICAgICAgY29uc3QgbmV3Q2hlY2tlZENsYXNzZXMgPSBtb2R1bGVzLmVzcmlMYW5nLmNsb25lKHRoaXMuY2hlY2tlZENsYXNzZXMpO1xuICAgICAgICB0aGlzLmNoZWNrZWRDbGFzc2VzLmZvckVhY2goKGNoZWNrZWRDbGFzcywgaWR4KSA9PiB7XG4gICAgICAgICAgICBpZiAoY2hlY2tlZENsYXNzLmNsYXNzSWR4IDwgZ3JvdXAuY2xhc3Nlcy5sZW5ndGggLSAxICYmXG4gICAgICAgICAgICAgICAgKGlkeCA9PT0gMCB8fFxuICAgICAgICAgICAgICAgICAgICAoaWR4ID4gMCAmJiBuZXdDaGVja2VkQ2xhc3Nlc1tpZHggLSAxXS5jbGFzc0lkeCAhPT0gY2hlY2tlZENsYXNzLmNsYXNzSWR4ICsgMSkpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdW5pcXVlQ2xhc3MgPSBncm91cC5jbGFzc2VzLnNwbGljZShjaGVja2VkQ2xhc3MuY2xhc3NJZHgsIDEpWzBdO1xuICAgICAgICAgICAgICAgIGdyb3VwLmNsYXNzZXMuc3BsaWNlKGNoZWNrZWRDbGFzcy5jbGFzc0lkeCArIDEsIDAsIHVuaXF1ZUNsYXNzKTtcbiAgICAgICAgICAgICAgICBuZXdDaGVja2VkQ2xhc3Nlc1tpZHhdLmNsYXNzSWR4ID0gY2hlY2tlZENsYXNzLmNsYXNzSWR4ICsgMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuY2hlY2tlZENsYXNzZXMgPSBuZXdDaGVja2VkQ2xhc3NlcztcbiAgICAgICAgdXZSZW5kZXJlci51bmlxdWVWYWx1ZUdyb3VwcyA9IGdyb3VwcztcbiAgICAgICAgdXBkYXRlUmVuZGVyZXIoKTtcbiAgICAgICAgdGhpcy5hcmNnaXNTbWFydE1hcHBpbmdUeXBlQWN0aW9uc1BvcG92ZXJDaGFuZ2UuZW1pdCh7IGNoZWNrZWRDbGFzc2VzOiB0aGlzLmNoZWNrZWRDbGFzc2VzIH0pO1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMubW92ZURvd25Ob2RlLmRpc2FibGVkID8gdGhpcy5tb3ZlVXBOb2RlLnNldEZvY3VzKCkgOiB0aGlzLm1vdmVEb3duTm9kZS5zZXRGb2N1cygpO1xuICAgICAgICB9LCAzMDApO1xuICAgIH1cbiAgICBtb3ZlVG9Hcm91cCgpIHtcbiAgICAgICAgdGhpcy5zaG93TW92ZVRvR3JvdXAgPSB0cnVlO1xuICAgIH1cbiAgICBtb3ZlVG9OZXdHcm91cCh1bnRpdGxlZCA9IGZhbHNlKSB7XG4gICAgICAgIGNvbnN0IHsgbGF5ZXIsIG1vZHVsZXMgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgICAgICBjb25zdCByZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKTtcbiAgICAgICAgY29uc3QgZ3JvdXBzID0gcmVuZGVyZXIudW5pcXVlVmFsdWVHcm91cHM7XG4gICAgICAgIGxldCB1bmlxdWVWYWx1ZUNsYXNzZXMgPSB0aGlzLmNoZWNrZWRDbGFzc2VzXG4gICAgICAgICAgICAuZmlsdGVyKChjaGVja2VkQ2xhc3MpID0+IGNoZWNrZWRDbGFzcy5ncm91cElkeCAhPT0gLTEpXG4gICAgICAgICAgICAubWFwKChjaGVja2VkQ2xhc3MpID0+IGdyb3Vwc1tjaGVja2VkQ2xhc3MuZ3JvdXBJZHhdLmNsYXNzZXNbY2hlY2tlZENsYXNzLmNsYXNzSWR4XSk7XG4gICAgICAgIGNvbnN0IG90aGVyVW5pcXVlVmFsdWVDbGFzc2VzID0gZ2V0T3RoZXJVbmlxdWVWYWx1ZUNsYXNzZXMoKTtcbiAgICAgICAgdW5pcXVlVmFsdWVDbGFzc2VzID0gdW5pcXVlVmFsdWVDbGFzc2VzLmNvbmNhdCh0aGlzLmNoZWNrZWRDbGFzc2VzXG4gICAgICAgICAgICAuZmlsdGVyKChjaGVja2VkQ2xhc3MpID0+IGNoZWNrZWRDbGFzcy5ncm91cElkeCA9PT0gLTEpXG4gICAgICAgICAgICAubWFwKChjaGVja2VkQ2xhc3MpID0+IG90aGVyVW5pcXVlVmFsdWVDbGFzc2VzW2NoZWNrZWRDbGFzcy5jbGFzc0lkeF0pKTtcbiAgICAgICAgY29uc3QgbmV3R3JvdXAgPSBuZXcgbW9kdWxlcy5VbmlxdWVWYWx1ZUdyb3VwKHtcbiAgICAgICAgICAgIGhlYWRpbmc6IHVudGl0bGVkID8gbnVsbCA6IGdldFVuaXF1ZUdyb3VwTmFtZShncm91cHMpLFxuICAgICAgICAgICAgY2xhc3NlczogdW5pcXVlVmFsdWVDbGFzc2VzXG4gICAgICAgIH0pO1xuICAgICAgICBncm91cHMucHVzaChuZXdHcm91cCk7XG4gICAgICAgIHRoaXMuY2hlY2tlZENsYXNzZXMuc29ydCgoYSwgYikgPT4gYi5ncm91cElkeCAtIGEuZ3JvdXBJZHggPT09IDAgPyBiLmNsYXNzSWR4IC0gYS5jbGFzc0lkeCA6IGIuZ3JvdXBJZHggLSBhLmdyb3VwSWR4KTtcbiAgICAgICAgdGhpcy5jaGVja2VkQ2xhc3Nlcy5mb3JFYWNoKChjaGVja2VkQ2xhc3MpID0+IHtcbiAgICAgICAgICAgIGlmIChjaGVja2VkQ2xhc3MuZ3JvdXBJZHggIT09IC0xKSB7XG4gICAgICAgICAgICAgICAgZ3JvdXBzW2NoZWNrZWRDbGFzcy5ncm91cElkeF0uY2xhc3Nlcy5zcGxpY2UoY2hlY2tlZENsYXNzLmNsYXNzSWR4LCAxKTtcbiAgICAgICAgICAgICAgICBpZiAoIWdyb3Vwc1tjaGVja2VkQ2xhc3MuZ3JvdXBJZHhdLmNsYXNzZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIGdyb3Vwcy5zcGxpY2UoY2hlY2tlZENsYXNzLmdyb3VwSWR4LCAxKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmNoZWNrZWRDbGFzc2VzID0gW107XG4gICAgICAgIHJlbmRlcmVyLnVuaXF1ZVZhbHVlR3JvdXBzID0gZ3JvdXBzO1xuICAgICAgICB1cGRhdGVSZW5kZXJlcigpO1xuICAgICAgICB0aGlzLnBvcG92ZXJOb2RlLm9wZW4gPSBmYWxzZTtcbiAgICAgICAgdGhpcy5hcmNnaXNTbWFydE1hcHBpbmdUeXBlQWN0aW9uc1BvcG92ZXJDaGFuZ2UuZW1pdCh7IGNoZWNrZWRDbGFzc2VzOiB0aGlzLmNoZWNrZWRDbGFzc2VzIH0pO1xuICAgICAgICAvLyBpZiB3ZSBkbyB0aGlzIHRvbyBlYXJseSB0aGUgZW50ZXIga2V5IGV4ZWN1dGVzIG9uIHRoZSBmb2N1c2VkIGRpdlxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgdmFyIF9hOyByZXR1cm4gKF9hID0gdGhpcy5ncm91cE1lbnVOb2Rlc1tncm91cHMubGVuZ3RoIC0gMV0pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zZXRGb2N1cygpOyB9LCAzMDApO1xuICAgIH1cbiAgICBtb3ZlVXAoKSB7XG4gICAgICAgIGNvbnN0IHsgbGF5ZXIsIG1vZHVsZXMgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgICAgICBjb25zdCB1dlJlbmRlcmVyID0gZ2V0UmVuZGVyZXIobGF5ZXIpO1xuICAgICAgICBjb25zdCBncm91cHMgPSB1dlJlbmRlcmVyLnVuaXF1ZVZhbHVlR3JvdXBzO1xuICAgICAgICBjb25zdCBncm91cCA9IGdyb3Vwc1t0aGlzLmNoZWNrZWRDbGFzc2VzWzBdLmdyb3VwSWR4XTtcbiAgICAgICAgdGhpcy5jaGVja2VkQ2xhc3Nlcy5zb3J0KChhLCBiKSA9PiBhLmdyb3VwSWR4IC0gYi5ncm91cElkeCA9PT0gMCA/IGEuY2xhc3NJZHggLSBiLmNsYXNzSWR4IDogYS5ncm91cElkeCAtIGIuZ3JvdXBJZHgpO1xuICAgICAgICBjb25zdCBuZXdDaGVja2VkQ2xhc3NlcyA9IG1vZHVsZXMuZXNyaUxhbmcuY2xvbmUodGhpcy5jaGVja2VkQ2xhc3Nlcyk7XG4gICAgICAgIHRoaXMuY2hlY2tlZENsYXNzZXMuZm9yRWFjaCgoY2hlY2tlZENsYXNzLCBpZHgpID0+IHtcbiAgICAgICAgICAgIGlmIChjaGVja2VkQ2xhc3MuY2xhc3NJZHggPiAwICYmXG4gICAgICAgICAgICAgICAgKGlkeCA9PT0gMCB8fFxuICAgICAgICAgICAgICAgICAgICAoaWR4ID4gMCAmJiBuZXdDaGVja2VkQ2xhc3Nlc1tpZHggLSAxXS5jbGFzc0lkeCAhPT0gY2hlY2tlZENsYXNzLmNsYXNzSWR4IC0gMSkpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdW5pcXVlQ2xhc3MgPSBncm91cC5jbGFzc2VzLnNwbGljZShjaGVja2VkQ2xhc3MuY2xhc3NJZHgsIDEpWzBdO1xuICAgICAgICAgICAgICAgIGdyb3VwLmNsYXNzZXMuc3BsaWNlKGNoZWNrZWRDbGFzcy5jbGFzc0lkeCAtIDEsIDAsIHVuaXF1ZUNsYXNzKTtcbiAgICAgICAgICAgICAgICBuZXdDaGVja2VkQ2xhc3Nlc1tpZHhdLmNsYXNzSWR4ID0gY2hlY2tlZENsYXNzLmNsYXNzSWR4IC0gMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuY2hlY2tlZENsYXNzZXMgPSBuZXdDaGVja2VkQ2xhc3NlcztcbiAgICAgICAgdXZSZW5kZXJlci51bmlxdWVWYWx1ZUdyb3VwcyA9IGdyb3VwcztcbiAgICAgICAgdXBkYXRlUmVuZGVyZXIoKTtcbiAgICAgICAgdGhpcy5hcmNnaXNTbWFydE1hcHBpbmdUeXBlQWN0aW9uc1BvcG92ZXJDaGFuZ2UuZW1pdCh7IGNoZWNrZWRDbGFzc2VzOiB0aGlzLmNoZWNrZWRDbGFzc2VzIH0pO1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMubW92ZVVwTm9kZS5kaXNhYmxlZCA/IHRoaXMubW92ZURvd25Ob2RlLnNldEZvY3VzKCkgOiB0aGlzLm1vdmVVcE5vZGUuc2V0Rm9jdXMoKTtcbiAgICAgICAgfSwgMzAwKTtcbiAgICB9XG4gICAgc2VwYXJhdGVTZWxlY3RlZFZhbHVlcygpIHtcbiAgICAgICAgY29uc3QgeyBsYXllciB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgICAgIGNvbnN0IHJlbmRlcmVyID0gZ2V0UmVuZGVyZXIobGF5ZXIpO1xuICAgICAgICBjb25zdCBncm91cHMgPSByZW5kZXJlci51bmlxdWVWYWx1ZUdyb3VwcztcbiAgICAgICAgdGhpcy5jaGVja2VkQ2xhc3Nlcy5zb3J0KChhLCBiKSA9PiBhLmdyb3VwSWR4IC0gYi5ncm91cElkeCA9PT0gMCA/IGEuY2xhc3NJZHggLSBiLmNsYXNzSWR4IDogYS5ncm91cElkeCAtIGIuZ3JvdXBJZHgpO1xuICAgICAgICBjb25zdCBncm91cEluZm9zID0gW107XG4gICAgICAgIGxldCBsYXN0R3JvdXBJZHggPSAtMjtcbiAgICAgICAgbGV0IGNsYXNzSWR4cyA9IFtdO1xuICAgICAgICB0aGlzLmNoZWNrZWRDbGFzc2VzLmZvckVhY2goKGluZm8pID0+IHtcbiAgICAgICAgICAgIGlmIChpbmZvLmdyb3VwSWR4ICE9PSAtMSkge1xuICAgICAgICAgICAgICAgIGlmIChsYXN0R3JvdXBJZHggIT09IGluZm8uZ3JvdXBJZHgpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGxhc3RHcm91cElkeCAhPT0gLTIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwSW5mb3MucHVzaCh7IGdyb3VwSWR4OiBsYXN0R3JvdXBJZHgsIGNsYXNzSWR4cyB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBsYXN0R3JvdXBJZHggPSBpbmZvLmdyb3VwSWR4O1xuICAgICAgICAgICAgICAgICAgICBjbGFzc0lkeHMgPSBbaW5mby5jbGFzc0lkeF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjbGFzc0lkeHMucHVzaChpbmZvLmNsYXNzSWR4KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAobGFzdEdyb3VwSWR4ICE9PSAtMikge1xuICAgICAgICAgICAgZ3JvdXBJbmZvcy5wdXNoKHsgZ3JvdXBJZHg6IGxhc3RHcm91cElkeCwgY2xhc3NJZHhzIH0pO1xuICAgICAgICB9XG4gICAgICAgIGdyb3VwSW5mb3MuZm9yRWFjaCgoaW5mbykgPT4gc2VwYXJhdGVNZXJnZWRDbGFzc2VzKGdyb3Vwc1tpbmZvLmdyb3VwSWR4XSwgaW5mby5jbGFzc0lkeHMpKTtcbiAgICAgICAgdGhpcy5jaGVja2VkQ2xhc3NlcyA9IFtdO1xuICAgICAgICB1cGRhdGVSZW5kZXJlcigpO1xuICAgICAgICB0aGlzLnBvcG92ZXJOb2RlLm9wZW4gPSBmYWxzZTtcbiAgICAgICAgdGhpcy5hcmNnaXNTbWFydE1hcHBpbmdUeXBlQWN0aW9uc1BvcG92ZXJDaGFuZ2UuZW1pdCh7IGNoZWNrZWRDbGFzc2VzOiB0aGlzLmNoZWNrZWRDbGFzc2VzIH0pO1xuICAgIH1cbiAgICBnZXQgaG9zdEVsZW1lbnQoKSB7IHJldHVybiBnZXRFbGVtZW50KHRoaXMpOyB9XG59O1xuXG5jb25zdCBBcmNnaXNTbWFydE1hcHBpbmdUeXBlQWRkVmFsdWUgPSBjbGFzcyB7XG4gICAgY29uc3RydWN0b3IoaG9zdFJlZikge1xuICAgICAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgICAgICB0aGlzLmFyY2dpc1NtYXJ0TWFwcGluZ1R5cGVBZGRWYWx1ZVBvcG92ZXJDbG9zZSA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzU21hcnRNYXBwaW5nVHlwZUFkZFZhbHVlUG9wb3ZlckNsb3NlXCIsIDcpO1xuICAgICAgICB0aGlzLmFyY2dpc1NtYXJ0TWFwcGluZ1R5cGVBZGRWYWx1ZVBvcG92ZXJOZXdWYWx1ZSA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzU21hcnRNYXBwaW5nVHlwZUFkZFZhbHVlUG9wb3Zlck5ld1ZhbHVlXCIsIDcpO1xuICAgICAgICB0aGlzLnVzZXJUb3VjaGVkTGFiZWwgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5mbG93SXRlbU5vZGUgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMucmVmZXJlbmNlTm9kZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5ncm91cElkeCA9IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vXG4gICAgLy8gIExpZmVjeWNsZVxuICAgIC8vXG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIGNvbXBvbmVudFdpbGxMb2FkKCkge1xuICAgICAgICB2YXIgX2EsIF9iO1xuICAgICAgICBjb25zdCB7IGFsbFVuaXF1ZVZhbHVlcywgbGF5ZXIgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgICAgICBjb25zdCByZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKTtcbiAgICAgICAgLy8gZ2F0aGVyIGFsbCB1bmlxdWUgdmFsdWVzIG9mIGxheWVyXG4gICAgICAgIHRoaXMuYWxsVmFsdWVzID0gYWxsVW5pcXVlVmFsdWVzID09PSBudWxsIHx8IGFsbFVuaXF1ZVZhbHVlcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYWxsVW5pcXVlVmFsdWVzLm1hcCgodW5pcXVlVmFsdWVJbmZvKSA9PiBcIlwiICsgdW5pcXVlVmFsdWVJbmZvLnZhbHVlKTtcbiAgICAgICAgLy8gYWRkIHRoZSBjdXN0b20gYWRkZWQgdmFsdWVzIHRvIHRoZSBsaXN0XG4gICAgICAgIHJlbmRlcmVyLnVuaXF1ZVZhbHVlR3JvdXBzLmZvckVhY2goKHVuaXF1ZVZhbHVlR3JvdXApID0+IHtcbiAgICAgICAgICAgIHVuaXF1ZVZhbHVlR3JvdXAuY2xhc3Nlcy5mb3JFYWNoKCh1bmlxdWVWYWx1ZUNsYXNzKSA9PiB7XG4gICAgICAgICAgICAgICAgdmFyIF9hO1xuICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gKF9hID0gdW5pcXVlVmFsdWVDbGFzcy52YWx1ZXMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYVswXS52YWx1ZTtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5hbGxWYWx1ZXMuaW5kZXhPZihcIlwiICsgdmFsdWUpID09PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFsbFZhbHVlcy5wdXNoKFwiXCIgKyB2YWx1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmZpZWxkID0gZ2V0RmllbGQocmVuZGVyZXIuZmllbGQpO1xuICAgICAgICB0aGlzLmlzRGF0ZSA9ICgoX2EgPSB0aGlzLmZpZWxkKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2ltcGxlRmllbGRUeXBlKSA9PT0gc2ltcGxlRmllbGRUeXBlcy5EQVRFO1xuICAgICAgICB0aGlzLmlzTnVtYmVyID0gKChfYiA9IHRoaXMuZmllbGQpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5zaW1wbGVGaWVsZFR5cGUpID09PSBzaW1wbGVGaWVsZFR5cGVzLk5VTUJFUjtcbiAgICAgICAgdGhpcy5pc0ludCA9XG4gICAgICAgICAgICB0aGlzLmZpZWxkICYmXG4gICAgICAgICAgICAgICAgW1wic21hbGwtaW50ZWdlclwiLCBcImludGVnZXJcIiwgXCJsb25nXCJdLmluZGV4T2YoZ2V0RmllbGRUeXBlKHRoaXMuZmllbGQubGF5ZXJGaWVsZCkpID4gLTE7XG4gICAgfVxuICAgIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgKF9hID0gdGhpcy5wYW5lbE5vZGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zZXRGb2N1cygpO1xuICAgIH1cbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy9cbiAgICAvLyAgUmVuZGVyIE1ldGhvZHNcbiAgICAvL1xuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgICAgIHJldHVybiAoaChIb3N0LCBudWxsLCBoKFwiY2FsY2l0ZS1wb3BvdmVyXCIsIHsgcmVmZXJlbmNlRWxlbWVudDogdGhpcy5yZWZlcmVuY2VOb2RlLCBwbGFjZW1lbnQ6IFwiYm90dG9tLWVuZFwiLCBvZmZzZXREaXN0YW5jZTogMCwgb2Zmc2V0U2tpZGRpbmc6IDAsIGxhYmVsOiBzdHJpbmdzLnBhbmVscy50eXBlLmFkZFZhbHVlLCBvcGVuOiB0cnVlLCByZWY6IChub2RlKSA9PiAodGhpcy5wb3BvdmVyTm9kZSA9IG5vZGUpIH0sIHRoaXMucmVuZGVyQ29udGVudCgpKSkpO1xuICAgIH1cbiAgICByZW5kZXJDb250ZW50KCkge1xuICAgICAgICB2YXIgX2E7XG4gICAgICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgICAgIGNvbnN0IG5vZGVXaWR0aCA9IChfYSA9IHRoaXMuZmxvd0l0ZW1Ob2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGg7XG4gICAgICAgIHJldHVybiAoaChcImNhbGNpdGUtcGFuZWxcIiwgeyBoZWFkaW5nOiBzdHJpbmdzLnBhbmVscy50eXBlLmFkZFZhbHVlLCBjbG9zYWJsZTogdHJ1ZSwgb25DYWxjaXRlUGFuZWxDbG9zZTogKCkgPT4gdGhpcy5hcmNnaXNTbWFydE1hcHBpbmdUeXBlQWRkVmFsdWVQb3BvdmVyQ2xvc2UuZW1pdCgpLCByZWY6IChub2RlKSA9PiAodGhpcy5wYW5lbE5vZGUgPSBub2RlKSB9LCBoKFwiZGl2XCIsIHsgcmVmOiAobm9kZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChub2RlKSB7XG4gICAgICAgICAgICAgICAgICAgIG5vZGUuc3R5bGUucGFkZGluZyA9IFwiMTVweFwiO1xuICAgICAgICAgICAgICAgICAgICBub2RlLnN0eWxlLndpZHRoID0gYCR7bm9kZVdpZHRoID8gbm9kZVdpZHRoICsgMjAgOiAyODB9cHhgO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gfSwgdGhpcy5yZW5kZXJWYWx1ZUlucHV0KCksIHRoaXMucmVuZGVyTGFiZWxJbnB1dCgpKSwgdGhpcy5yZW5kZXJEb25lQnV0dG9uKCkpKTtcbiAgICB9XG4gICAgcmVuZGVyVmFsdWVJbnB1dCgpIHtcbiAgICAgICAgY29uc3QgeyBzdHJpbmdzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgY29uc3QgeyBpc0RhdGUsIGlzSW50LCBpc051bWJlciB9ID0gdGhpcztcbiAgICAgICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1sYWJlbFwiLCB7IHNjYWxlOiBcInNcIiB9LCBzdHJpbmdzLnBhbmVscy50eXBlLnZhbHVlLCBcbiAgICAgICAgLy8gZGF0ZVxuICAgICAgICBpc0RhdGUgPyAoaChcImNhbGNpdGUtaW5wdXQtZGF0ZS1waWNrZXJcIiwgeyBzY2FsZTogXCJzXCIsIG92ZXJsYXlQb3NpdGlvbmluZzogXCJmaXhlZFwiLCBvbkNhbGNpdGVJbnB1dERhdGVQaWNrZXJDaGFuZ2U6IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IG5vZGUgPSBldmVudC50YXJnZXQ7XG4gICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVBZGREYXRlKG5vZGUudmFsdWUpO1xuICAgICAgICAgICAgfSB9KSkgOiAvLyBudW1iZXJcbiAgICAgICAgICAgIGlzTnVtYmVyID8gKGgoXCJjYWxjaXRlLWlucHV0LW51bWJlclwiLCB7IHN0ZXA6IGlzSW50ID8gMSA6IFwiYW55XCIsIHNjYWxlOiBcInNcIiwgbGFiZWw6IHN0cmluZ3MucGFuZWxzLnR5cGUudmFsdWUsIHBsYWNlaG9sZGVyOiBzdHJpbmdzLnBhbmVscy50eXBlLnN0b3JlZFZhbHVlLCBvbkNhbGNpdGVJbnB1dE51bWJlcklucHV0OiAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgbm9kZSA9IGV2ZW50LnRhcmdldDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVBZGROdW1iZXIobm9kZS52YWx1ZSk7XG4gICAgICAgICAgICAgICAgfSB9KSkgOiAoXG4gICAgICAgICAgICAvLyBzdHJpbmdcbiAgICAgICAgICAgIGgoXCJjYWxjaXRlLWlucHV0XCIsIHsgc2NhbGU6IFwic1wiLCBsYWJlbDogc3RyaW5ncy5wYW5lbHMudHlwZS52YWx1ZSwgcGxhY2Vob2xkZXI6IHN0cmluZ3MucGFuZWxzLnR5cGUuc3RvcmVkVmFsdWUsIG9uQ2FsY2l0ZUlucHV0SW5wdXQ6ICgpID0+IHRoaXMuaGFuZGxlQWRkU3RyaW5nKHRoaXMudmFsdWVJbnB1dE5vZGUudmFsdWUpLCByZWY6IChub2RlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChub2RlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZhbHVlSW5wdXROb2RlID0gbm9kZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gfSkpLCBoKFwiY2FsY2l0ZS1pbnB1dC1tZXNzYWdlXCIsIHsgaGlkZGVuOiB0cnVlLCBpY29uOiBcImV4Y2xhbWF0aW9uLW1hcmstdHJpYW5nbGVcIiwgc3RhdHVzOiBcImludmFsaWRcIiwgcmVmOiAobm9kZSkgPT4gKHRoaXMudmFsdWVJbnB1dE1lc3NhZ2VOb2RlID0gbm9kZSkgfSwgc3RyaW5ncy5wYW5lbHMudHlwZS52YWx1ZU5vdFVuaXF1ZSkpKTtcbiAgICB9XG4gICAgcmVuZGVyTGFiZWxJbnB1dCgpIHtcbiAgICAgICAgY29uc3QgeyBzdHJpbmdzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1sYWJlbFwiLCB7IHNjYWxlOiBcInNcIiB9LCBzdHJpbmdzLnBhbmVscy50eXBlLmxhYmVsLCBoKFwiY2FsY2l0ZS1pbnB1dFwiLCB7IHR5cGU6IFwidGV4dFwiLCB2YWx1ZTogXCJcIiwgc2NhbGU6IFwic1wiLCBwbGFjZWhvbGRlcjogc3RyaW5ncy5wYW5lbHMudHlwZS5kaXNwbGF5ZWRWYWx1ZSwgbGFiZWw6IHN0cmluZ3MucGFuZWxzLnR5cGUubGFiZWwsIG9uQ2FsY2l0ZUlucHV0SW5wdXQ6ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnVzZXJUb3VjaGVkTGFiZWwgPSB0cnVlO1xuICAgICAgICAgICAgfSwgcmVmOiAobm9kZSkgPT4gKHRoaXMubGFiZWxJbnB1dE5vZGUgPSBub2RlKSB9KSkpO1xuICAgIH1cbiAgICByZW5kZXJEb25lQnV0dG9uKCkge1xuICAgICAgICBjb25zdCB7IGxvY2FsZSwgbWFwVmlldywgbW9kdWxlcywgc3RyaW5ncyB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgICAgIGNvbnN0IHsgZmllbGQsIGlzRGF0ZSwgaXNJbnQsIGlzTnVtYmVyIH0gPSB0aGlzO1xuICAgICAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IGFwcGVhcmFuY2U6IFwic29saWRcIiwgbGFiZWw6IHN0cmluZ3MuZG9uZSwgd2lkdGg6IFwiZnVsbFwiLCBzbG90OiBcImZvb3RlclwiLCBkaXNhYmxlZDogdHJ1ZSwgb25DbGljazogKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMucG9wb3Zlck5vZGUub3BlbiA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy52YWx1ZUlucHV0Tm9kZS52YWx1ZTtcbiAgICAgICAgICAgICAgICBsZXQgbmV3TGFiZWw7XG4gICAgICAgICAgICAgICAgbGV0IG5ld1ZhbHVlO1xuICAgICAgICAgICAgICAgIGlmIChpc0RhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gdmFsdWUgZm9yIGRhdGUgcmV0dXJucyBhIHN0cmluZyBsaWtlIHRoaXMgMjAyMi0wOC0wMSwgd2hpY2ggaXMgVVRDIHRpbWVcbiAgICAgICAgICAgICAgICAgICAgLy8gdGhlIGRhdGUgdmFsdWUgbXVzdCBiZSBVVEMsIGJ1dCB0aGUgbGFiZWwgbXVzdCBiZSBsb2NhbCB0aW1lXG4gICAgICAgICAgICAgICAgICAgIG5ld1ZhbHVlID0gZGF0ZVBpY2tlclRvVVRDKHZhbHVlLCBtYXBWaWV3LnRpbWVab25lKTtcbiAgICAgICAgICAgICAgICAgICAgbW9kdWxlcy5pbnRsLnNldExvY2FsZShsb2NhbGUpO1xuICAgICAgICAgICAgICAgICAgICBuZXdMYWJlbCA9IHRoaXMubGFiZWxJbnB1dE5vZGUudmFsdWUgfHwgZ2V0RGF0ZUxhYmVsKG5ld1ZhbHVlLCBmaWVsZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKGlzTnVtYmVyKSB7XG4gICAgICAgICAgICAgICAgICAgIG5ld1ZhbHVlID0gaXNJbnQgPyBwYXJzZUludCh2YWx1ZSkgOiBwYXJzZUZsb2F0KHZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgbmV3TGFiZWwgPSB0aGlzLmxhYmVsSW5wdXROb2RlLnZhbHVlIHx8IG1vZHVsZXMuaW50bC5mb3JtYXROdW1iZXIobmV3VmFsdWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gc3RyaW5nXG4gICAgICAgICAgICAgICAgICAgIG5ld0xhYmVsID0gdGhpcy5sYWJlbElucHV0Tm9kZS52YWx1ZSB8fCB2YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgbmV3VmFsdWUgPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5hZGRWYWx1ZShuZXdMYWJlbCwgbmV3VmFsdWUpO1xuICAgICAgICAgICAgfSwgcmVmOiAobm9kZSkgPT4gKHRoaXMuZG9uZUJ1dHRvbk5vZGUgPSBub2RlKSB9LCBzdHJpbmdzLmRvbmUpKTtcbiAgICB9XG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vXG4gICAgLy8gIFByaXZhdGUgTWV0aG9kc1xuICAgIC8vXG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIGFkZFZhbHVlKGxhYmVsLCB2YWx1ZSkge1xuICAgICAgICB2YXIgX2E7XG4gICAgICAgIGNvbnN0IHsgbGF5ZXIsIG1hcFZpZXcsIG1vZHVsZXMgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgICAgICBjb25zdCByZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKTtcbiAgICAgICAgY29uc3Qgc3ltYm9sID0gbW9kdWxlcy5lc3JpTGFuZy5jbG9uZSgoKF9hID0gcmVuZGVyZXIudW5pcXVlVmFsdWVJbmZvcy5maW5kKCh1bmlxdWVWYWx1ZUluZm8pID0+IHtcbiAgICAgICAgICAgIHZhciBfYTtcbiAgICAgICAgICAgIHJldHVybiBbXCJzaW1wbGUtbWFya2VyXCIsIFwic2ltcGxlLWxpbmVcIiwgXCJzaW1wbGUtZmlsbFwiLCBcImNpbVwiXS5pbmRleE9mKChfYSA9IHVuaXF1ZVZhbHVlSW5mby5zeW1ib2wpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS50eXBlKSA+IC0xO1xuICAgICAgICB9KSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnN5bWJvbCkgfHwgZ2V0RGVmYXVsdFN5bWJvbChsYXllciwgbWFwVmlldywgZ2V0UmVuZGVyZXJUeXBlKCkpKTtcbiAgICAgICAgY29uc3Qgc2NoZW1lID0gZmluZFR5cGVTY2hlbWUoKTtcbiAgICAgICAgaWYgKHNjaGVtZSkge1xuICAgICAgICAgICAgY29uc3QgY29sb3IgPSBzY2hlbWUuY29sb3JzW3JlbmRlcmVyLnVuaXF1ZVZhbHVlSW5mb3MubGVuZ3RoICUgc2NoZW1lLmNvbG9ycy5sZW5ndGhdO1xuICAgICAgICAgICAgY29sb3IgJiYgYXBwbHlTeW1ib2xDb2xvcihzeW1ib2wsIGNvbG9yKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIC8vIGp1c3QgcGljayBzb21lIGNvbG9ycyBmcm9tIHRoZSBwcmltYXJ5IHNjaGVtZVxuICAgICAgICAgICAgY29uc3QgcHJpbWFyeVJhbXBDb2xvcnMgPSBnZXRQcmltYXJ5VHlwZVNjaGVtZSgpLmNvbG9ycztcbiAgICAgICAgICAgIGNvbnN0IGNvbG9yID0gbmV3IG1vZHVsZXMuZXNyaUNvbG9yKHByaW1hcnlSYW1wQ29sb3JzW3JlbmRlcmVyLnVuaXF1ZVZhbHVlSW5mb3MubGVuZ3RoICUgMTBdKTtcbiAgICAgICAgICAgIGNvbG9yICYmIGFwcGx5U3ltYm9sQ29sb3Ioc3ltYm9sLCBjb2xvcik7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGdyb3VwcyA9IHJlbmRlcmVyLnVuaXF1ZVZhbHVlR3JvdXBzO1xuICAgICAgICBpZiAodGhpcy5ncm91cElkeCA9PT0gLTIpIHtcbiAgICAgICAgICAgIC8vIHRoZXJlIGFyZSBubyBncm91cHMgeWV0XG4gICAgICAgICAgICBncm91cHMgPSBbbmV3IG1vZHVsZXMuVW5pcXVlVmFsdWVHcm91cCh7IGhlYWRpbmc6IHVuZGVmaW5lZCwgY2xhc3NlczogW10gfSldO1xuICAgICAgICAgICAgdGhpcy5ncm91cElkeCA9IDA7XG4gICAgICAgIH1cbiAgICAgICAgZ3JvdXBzW3RoaXMuZ3JvdXBJZHhdLmNsYXNzZXMucHVzaChuZXcgbW9kdWxlcy5VbmlxdWVWYWx1ZUNsYXNzKHtcbiAgICAgICAgICAgIHZhbHVlczogW25ldyBtb2R1bGVzLlVuaXF1ZVZhbHVlKHsgdmFsdWUgfSldLFxuICAgICAgICAgICAgbGFiZWw6IGxhYmVsLFxuICAgICAgICAgICAgc3ltYm9sXG4gICAgICAgIH0pKTtcbiAgICAgICAgcmVuZGVyZXIudW5pcXVlVmFsdWVHcm91cHMgPSBncm91cHM7XG4gICAgICAgIHRoaXMuYXJjZ2lzU21hcnRNYXBwaW5nVHlwZUFkZFZhbHVlUG9wb3Zlck5ld1ZhbHVlLmVtaXQoKTtcbiAgICB9XG4gICAgaGFuZGxlQWRkRGF0ZSh2YWx1ZSkge1xuICAgICAgICBjb25zdCB7IGFsbFVuaXF1ZVZhbHVlcywgbWFwVmlldywgbGF5ZXIgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgICAgICBjb25zdCByZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKTtcbiAgICAgICAgLy8gZ2F0aGVyIGFsbCB1bmlxdWUgdmFsdWVzIG9mIGxheWVyXG4gICAgICAgIGNvbnN0IGFsbFZhbHVlcyA9IGFsbFVuaXF1ZVZhbHVlcyA9PT0gbnVsbCB8fCBhbGxVbmlxdWVWYWx1ZXMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFsbFVuaXF1ZVZhbHVlcy5tYXAoKHVuaXF1ZVZhbHVlSW5mbykgPT4gXCJcIiArIHVuaXF1ZVZhbHVlSW5mby52YWx1ZSk7XG4gICAgICAgIC8vIGFkZCB0aGUgY3VzdG9tIGFkZGVkIHZhbHVlcyB0byB0aGUgbGlzdFxuICAgICAgICByZW5kZXJlci51bmlxdWVWYWx1ZUdyb3Vwcy5mb3JFYWNoKCh1bmlxdWVWYWx1ZUdyb3VwKSA9PiB7XG4gICAgICAgICAgICB1bmlxdWVWYWx1ZUdyb3VwLmNsYXNzZXMuZm9yRWFjaCgodW5pcXVlVmFsdWVDbGFzcykgPT4ge1xuICAgICAgICAgICAgICAgIHZhciBfYTtcbiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IChfYSA9IHVuaXF1ZVZhbHVlQ2xhc3MudmFsdWVzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2FbMF0udmFsdWU7XG4gICAgICAgICAgICAgICAgaWYgKGFsbFZhbHVlcy5pbmRleE9mKFwiXCIgKyB2YWx1ZSkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIGFsbFZhbHVlcy5wdXNoKFwiXCIgKyB2YWx1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCBmaWVsZCA9IGdldEZpZWxkKHJlbmRlcmVyLmZpZWxkKTtcbiAgICAgICAgaWYgKCF0aGlzLnVzZXJUb3VjaGVkTGFiZWwpIHtcbiAgICAgICAgICAgIC8vIHZhbHVlIGZvciBkYXRlIHJldHVybnMgYSBzdHJpbmcgbGlrZSB0aGlzIDIwMjItMDgtMDFcbiAgICAgICAgICAgIC8vIHRoZSBkYXRlIHZhbHVlIG11c3QgYmUgc3RvcmVkIGluIFVUQ1xuICAgICAgICAgICAgY29uc3QgbmV3VmFsdWUgPSBkYXRlUGlja2VyVG9VVEModmFsdWUsIG1hcFZpZXcudGltZVpvbmUpO1xuICAgICAgICAgICAgdGhpcy5sYWJlbElucHV0Tm9kZS52YWx1ZSA9IGdldERhdGVMYWJlbChuZXdWYWx1ZSwgZmllbGQpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudmFsdWVJbnB1dE1lc3NhZ2VOb2RlLmhpZGRlbiA9IGFsbFZhbHVlcy5pbmRleE9mKHZhbHVlKSA9PT0gLTE7XG4gICAgICAgIHRoaXMuZG9uZUJ1dHRvbk5vZGUuZGlzYWJsZWQgPSAhdmFsdWUubGVuZ3RoIHx8IGFsbFZhbHVlcy5pbmRleE9mKHZhbHVlKSA+IC0xO1xuICAgIH1cbiAgICBoYW5kbGVBZGROdW1iZXIodmFsdWUpIHtcbiAgICAgICAgY29uc3QgeyBtb2R1bGVzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICAgICAgaWYgKHZhbHVlLmxlbmd0aCAmJiB0aGlzLmlzSW50KSB7XG4gICAgICAgICAgICBsZXQgc3RyVmFsdWUgPSBcIlwiICsgTWF0aC5yb3VuZChwYXJzZUZsb2F0KHZhbHVlKSk7XG4gICAgICAgICAgICBpZiAoc3RyVmFsdWUuaW5kZXhPZihcIi5cIikgPiAtMSkge1xuICAgICAgICAgICAgICAgIHN0clZhbHVlID0gc3RyVmFsdWUuc3Vic3RyaW5nKDAsIHN0clZhbHVlLmluZGV4T2YoXCIuXCIpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzdHJWYWx1ZSAhPT0gdmFsdWUpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHN0clZhbHVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICghdGhpcy51c2VyVG91Y2hlZExhYmVsKSB7XG4gICAgICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IHRoaXMuaXNJbnQgPyBwYXJzZUludCh2YWx1ZSkgOiBwYXJzZUZsb2F0KHZhbHVlKTtcbiAgICAgICAgICAgIHRoaXMubGFiZWxJbnB1dE5vZGUudmFsdWUgPSBtb2R1bGVzLmludGwuZm9ybWF0TnVtYmVyKG5ld1ZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnZhbHVlSW5wdXRNZXNzYWdlTm9kZS5oaWRkZW4gPSB0aGlzLmFsbFZhbHVlcy5pbmRleE9mKHZhbHVlKSA9PT0gLTE7XG4gICAgICAgIHRoaXMuZG9uZUJ1dHRvbk5vZGUuZGlzYWJsZWQgPSAhdmFsdWUubGVuZ3RoIHx8IHRoaXMuYWxsVmFsdWVzLmluZGV4T2YodmFsdWUpID4gLTE7XG4gICAgfVxuICAgIGhhbmRsZUFkZFN0cmluZyh2YWx1ZSkge1xuICAgICAgICBpZiAoIXRoaXMudXNlclRvdWNoZWRMYWJlbCkge1xuICAgICAgICAgICAgdGhpcy5sYWJlbElucHV0Tm9kZS52YWx1ZSA9IHZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudmFsdWVJbnB1dE1lc3NhZ2VOb2RlLmhpZGRlbiA9IHRoaXMuYWxsVmFsdWVzLmluZGV4T2YodmFsdWUpID09PSAtMTtcbiAgICAgICAgdGhpcy5kb25lQnV0dG9uTm9kZS5kaXNhYmxlZCA9ICF2YWx1ZS5sZW5ndGggfHwgdGhpcy5hbGxWYWx1ZXMuaW5kZXhPZih2YWx1ZSkgPiAtMTtcbiAgICB9XG4gICAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcblxuZXhwb3J0IHsgQXJjZ2lzU21hcnRNYXBwaW5nUGFuZWxzVHlwZSBhcyBhcmNnaXNfc21hcnRfbWFwcGluZ19wYW5lbHNfdHlwZSwgQXJjZ2lzU21hcnRNYXBwaW5nVHlwZUFjdGlvbnNQb3BvdmVyIGFzIGFyY2dpc19zbWFydF9tYXBwaW5nX3R5cGVfYWN0aW9uc19wb3BvdmVyLCBBcmNnaXNTbWFydE1hcHBpbmdUeXBlQWRkVmFsdWUgYXMgYXJjZ2lzX3NtYXJ0X21hcHBpbmdfdHlwZV9hZGRfdmFsdWUgfTtcblxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9YXJjZ2lzLXNtYXJ0LW1hcHBpbmctcGFuZWxzLXR5cGVfMy5lbnRyeS5qcy5tYXAiLCIvKiFcbiAqIEFsbCBtYXRlcmlhbCBjb3B5cmlnaHQgRVNSSSwgQWxsIFJpZ2h0cyBSZXNlcnZlZCwgdW5sZXNzIG90aGVyd2lzZSBzcGVjaWZpZWQuXG4gKiB2NC4wLjU4XG4gKi9cbmltcG9ydCB7IHMgYXMgc21hcnRNYXBwaW5nU3RhdGUgfSBmcm9tICcuL3Jhc3Rlci11bmlxdWUtdmFsdWUtMDk3NmVjN2YuanMnO1xuaW1wb3J0ICcuL2xvYWRNb2R1bGVzLWI0YWMxMjQ3LmpzJztcbmltcG9ydCAnLi9jb21tb25FbnVtcy1mY2YxMzY2MS5qcyc7XG5cbmZ1bmN0aW9uIGFkZERhdGVGb3JtYXRGdW5jdGlvbnMoY29uZmlnLCB0aW1lWm9uZSkge1xuICAgIGNvbmZpZy5sYWJlbEZvcm1hdEZ1bmN0aW9uID0gKHZhbHVlKSA9PiB7XG4gICAgICAgIHJldHVybiBnZXREYXRlRGlzcGxheVN0cmluZyh2YWx1ZSwgdGltZVpvbmUsIFwic2hvcnQtZGF0ZVwiKTtcbiAgICB9O1xuICAgIGNvbmZpZy5pbnB1dEZvcm1hdEZ1bmN0aW9uID0gKHZhbHVlKSA9PiB7XG4gICAgICAgIHJldHVybiBnZXREYXRlRGlzcGxheVN0cmluZyh2YWx1ZSwgdGltZVpvbmUsIFwic2hvcnQtZGF0ZVwiKTtcbiAgICB9O1xuICAgIGNvbmZpZy5pbnB1dFBhcnNlRnVuY3Rpb24gPSAodmFsdWUpID0+IHtcbiAgICAgICAgcmV0dXJuIG1hcFRaVG9VVEMoRGF0ZS5wYXJzZSh2YWx1ZSksIHRpbWVab25lKTtcbiAgICB9O1xufVxuZnVuY3Rpb24gdXRjVG9EYXRlUGlja2VyKHZhbHVlLCB0aW1lWm9uZSkge1xuICAgIC8vIGRhdGUgaXMgaW4gVVRDXG4gICAgLy8gd2UgbmVlZCBhIG1hcCB0aW1lem9uZVxuICAgIGxldCBzdHI7XG4gICAgaWYgKCF0aW1lWm9uZSB8fCB0aW1lWm9uZSA9PT0gXCJzeXN0ZW1cIikge1xuICAgICAgICBjb25zdCBkaWZmID0gbmV3IERhdGUoKS5nZXRUaW1lem9uZU9mZnNldCgpO1xuICAgICAgICBzdHIgPSBuZXcgRGF0ZSh2YWx1ZSAtIGRpZmYgKiA2MDAwMCkudG9JU09TdHJpbmcoKTtcbiAgICB9XG4gICAgZWxzZSBpZiAodGltZVpvbmUgPT09IFwidW5rbm93blwiKSB7XG4gICAgICAgIHN0ciA9IG5ldyBEYXRlKHZhbHVlKS50b0lTT1N0cmluZygpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgY29uc3QgZGlmZiA9IG5ldyBEYXRlKCkuZ2V0VGltZXpvbmVPZmZzZXQoKTtcbiAgICAgICAgY29uc3QgbWFwRGF0ZVN0ciA9IG5ldyBEYXRlKHZhbHVlKS50b0xvY2FsZVN0cmluZyhcImVuLVVTXCIsIHsgdGltZVpvbmUgfSk7XG4gICAgICAgIHN0ciA9IG5ldyBEYXRlKG5ldyBEYXRlKG1hcERhdGVTdHIpLmdldFRpbWUoKSAtIGRpZmYgKiA2MDAwMCkudG9JU09TdHJpbmcoKTtcbiAgICB9XG4gICAgLy8gY29uc29sZS5sb2coXCJ1dGNUb0RhdGVQaWNrZXJcIiwgdmFsdWUsIFwiIC0gXCIsIG5ldyBEYXRlKHZhbHVlKS50b0lTT1N0cmluZygpLCBcIiAtPiBcIiwgc3RyKTtcbiAgICByZXR1cm4gc3RyO1xufVxuZnVuY3Rpb24gdXRjVG9UaW1lUGlja2VyKHZhbHVlLCB0aW1lWm9uZSwgYWRkU2Vjb25kcykge1xuICAgIC8vIGRhdGUgaXMgaW4gVVRDXG4gICAgLy8gd2UgbmVlZCBhIG1hcCB0aW1lem9uZVxuICAgIGxldCBzdHI7XG4gICAgaWYgKCF0aW1lWm9uZSB8fCB0aW1lWm9uZSA9PT0gXCJzeXN0ZW1cIikge1xuICAgICAgICBjb25zdCBkaWZmID0gbmV3IERhdGUoKS5nZXRUaW1lem9uZU9mZnNldCgpO1xuICAgICAgICBzdHIgPSBuZXcgRGF0ZSh2YWx1ZSAtIGRpZmYgKiA2MDAwMCkudG9JU09TdHJpbmcoKTtcbiAgICB9XG4gICAgZWxzZSBpZiAodGltZVpvbmUgPT09IFwidW5rbm93blwiKSB7XG4gICAgICAgIHN0ciA9IG5ldyBEYXRlKHZhbHVlKS50b0lTT1N0cmluZygpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgY29uc3QgZGlmZiA9IG5ldyBEYXRlKCkuZ2V0VGltZXpvbmVPZmZzZXQoKTtcbiAgICAgICAgY29uc3QgbWFwRGF0ZVN0ciA9IG5ldyBEYXRlKHZhbHVlKS50b0xvY2FsZVN0cmluZyhcImVuLVVTXCIsIHsgdGltZVpvbmUgfSk7XG4gICAgICAgIHN0ciA9IG5ldyBEYXRlKG5ldyBEYXRlKG1hcERhdGVTdHIpLmdldFRpbWUoKSAtIGRpZmYgKiA2MDAwMCkudG9JU09TdHJpbmcoKTtcbiAgICB9XG4gICAgLy8gc3RyID0gXCIyMDIzLTA5LTIwVDEzOjA2OjAwLjAwMFpcIlxuICAgIHN0ciA9IGFkZFNlY29uZHMgPyBzdHIuc3Vic3RyaW5nKDExLCAxOSkgOiBzdHIuc3Vic3RyaW5nKDExLCAxNik7XG4gICAgLy8gY29uc29sZS5sb2coXCJ1dGNUb1RpbWVQaWNrZXJcIiwgdmFsdWUsIFwiIC0gXCIsIG5ldyBEYXRlKHZhbHVlKS50b0lTT1N0cmluZygpLCBcIiAtPiBcIiwgc3RyKTtcbiAgICByZXR1cm4gc3RyO1xufVxuZnVuY3Rpb24gZGF0ZVBpY2tlclRvVVRDKGRhdGVTdHJpbmcsIHRpbWVab25lKSB7XG4gICAgLy8gZGF0ZSBpcyBpbiBtYXAgdGltZXpvbmVcbiAgICAvLyB3ZSBuZWVkIGEgVVRDIFVOSVggdGltZXN0YW1wXG4gICAgbGV0IGRhdGUgPSBuZXcgRGF0ZShkYXRlU3RyaW5nKTtcbiAgICAvLyB0aGlzIGlzIHJlYWQgYXMgY3VycmVudCB0aW1lOyB0b0lTT1N0cmluZygpIHdvdWxkIHJlYXR1cm4gVVRDIHRpbWUgKGUuZy4gKzcgaG91cnMgZnJvbSBwYWNpZmljKVxuICAgIC8vIGZpeCB0aGUgb2Zmc2V0XG4gICAgZGF0ZSA9IG5ldyBEYXRlKGRhdGUuZ2V0VGltZSgpIC0gZGF0ZS5nZXRUaW1lem9uZU9mZnNldCgpICogNjAwMDApO1xuICAgIC8vIGRhdGUgbm93IGNvbnRhaW5zIHRoZSB1c2VyJ3MgZW50ZXJlZCB0aW1lXG4gICAgbGV0IHZhbHVlO1xuICAgIGlmICghdGltZVpvbmUgfHwgdGltZVpvbmUgPT09IFwic3lzdGVtXCIpIHtcbiAgICAgICAgLy8gYWRkIGRpZmZlcmVuY2UgYmV0d2VlbiBsb2NhbCB0aW1lIGFuZCBVVENcbiAgICAgICAgdmFsdWUgPSBkYXRlLmdldFRpbWUoKSArIGRhdGUuZ2V0VGltZXpvbmVPZmZzZXQoKSAqIDYwMDAwO1xuICAgIH1cbiAgICBlbHNlIGlmICh0aW1lWm9uZSA9PT0gXCJ1bmtub3duXCIpIHtcbiAgICAgICAgLy8gdGFrZSB3aGF0IHlvdSBnZXRcbiAgICAgICAgdmFsdWUgPSBkYXRlLmdldFRpbWUoKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIC8vIGFkZCBkaWZmZXJlbmNlIGJldHdlZW4gbWFwIHRpbWUgYW5kIFVUQ1xuICAgICAgICBjb25zdCBkaWZmID0gbmV3IERhdGUoZGF0ZS50b0xvY2FsZVN0cmluZyhcImVuLVVTXCIsIHsgdGltZVpvbmU6IFwidXRjXCIgfSkpLmdldFRpbWUoKSAtXG4gICAgICAgICAgICBuZXcgRGF0ZShkYXRlLnRvTG9jYWxlU3RyaW5nKFwiZW4tVVNcIiwgeyB0aW1lWm9uZSB9KSkuZ2V0VGltZSgpO1xuICAgICAgICB2YWx1ZSA9IGRhdGUuZ2V0VGltZSgpICsgZGlmZjtcbiAgICB9XG4gICAgLy8gY29uc29sZS5sb2coXCJkYXRlUGlja2VyVG9VVENcIiwgZGF0ZS50b0lTT1N0cmluZygpLCBcIiAtPiBcIiwgbmV3IERhdGUodmFsdWUpLnRvSVNPU3RyaW5nKCkpO1xuICAgIHJldHVybiB2YWx1ZTtcbn1cbmZ1bmN0aW9uIG1hcFRaVG9VVEModmFsdWUsIHRpbWVab25lKSB7XG4gICAgaWYgKCF2YWx1ZSkge1xuICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuICAgIC8vIHZhbHVlIGlzIGluIG1hcCB0aW1lem9uZVxuICAgIC8vIHdlIG5lZWQgYSBVVEMgdGltZXN0YW1wXG4gICAgbGV0IG5ld1ZhbHVlO1xuICAgIGlmICghdGltZVpvbmUgfHwgdGltZVpvbmUgPT09IFwic3lzdGVtXCIpIHtcbiAgICAgICAgLy8gYWRkIGRpZmZlcmVuY2UgYmV0d2VlbiBsb2NhbCB0aW1lIGFuZCBVVENcbiAgICAgICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKCk7XG4gICAgICAgIG5ld1ZhbHVlID0gdmFsdWUgKyBkYXRlLmdldFRpbWV6b25lT2Zmc2V0KCkgKiA2MDAwMDtcbiAgICB9XG4gICAgZWxzZSBpZiAodGltZVpvbmUgPT09IFwidW5rbm93blwiKSB7XG4gICAgICAgIC8vIHRha2Ugd2hhdCB5b3UgZ2V0XG4gICAgICAgIG5ld1ZhbHVlID0gdmFsdWU7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICAvLyBhZGQgZGlmZmVyZW5jZSBiZXR3ZWVuIG1hcCB0aW1lIGFuZCBVVENcbiAgICAgICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKCk7XG4gICAgICAgIGNvbnN0IGRpZmYgPSBuZXcgRGF0ZShkYXRlLnRvTG9jYWxlU3RyaW5nKFwiZW4tVVNcIiwgeyB0aW1lWm9uZTogXCJ1dGNcIiB9KSkuZ2V0VGltZSgpIC1cbiAgICAgICAgICAgIG5ldyBEYXRlKGRhdGUudG9Mb2NhbGVTdHJpbmcoXCJlbi1VU1wiLCB7IHRpbWVab25lIH0pKS5nZXRUaW1lKCk7XG4gICAgICAgIG5ld1ZhbHVlID0gdmFsdWUgKyBkaWZmO1xuICAgIH1cbiAgICBjb25zb2xlLmxvZyhcIm1hcFRaVG9VVENcIiwgdmFsdWUsIFwiIC0gXCIsIG5ldyBEYXRlKHZhbHVlKS50b0lTT1N0cmluZygpLCBcIiAtIFwiLCBuZXcgRGF0ZShuZXdWYWx1ZSkudG9JU09TdHJpbmcoKSk7XG4gICAgcmV0dXJuIG5ld1ZhbHVlO1xufVxuZnVuY3Rpb24gZ2V0RGF0ZURpc3BsYXlTdHJpbmcodmFsdWUsIHRpbWVab25lLCBkYXRlRm9ybWF0KSB7XG4gICAgY29uc3QgeyBtb2R1bGVzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICBsZXQgc3RyO1xuICAgIGlmICh0aW1lWm9uZSA9PT0gXCJ1bmtub3duXCIpIHtcbiAgICAgICAgc3RyID0gbW9kdWxlcy5pbnRsLmZvcm1hdERhdGUodmFsdWUsIE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgbW9kdWxlcy5pbnRsLmNvbnZlcnREYXRlRm9ybWF0VG9JbnRsT3B0aW9ucyhkYXRlRm9ybWF0IHx8IFwic2hvcnQtZGF0ZS1zaG9ydC10aW1lXCIpKSwgeyB0aW1lWm9uZTogXCJ1dGNcIiwgdGltZVpvbmVOYW1lOiBcInNob3J0T2Zmc2V0XCIgfSkpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgLy8ga25vd24gaXNzdWVzIHdpdGggZm9ybWF0dGluZyBpdC1DSFxuICAgICAgICBzdHIgPSBtb2R1bGVzLmludGwuZm9ybWF0RGF0ZSh2YWx1ZSwgT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBtb2R1bGVzLmludGwuY29udmVydERhdGVGb3JtYXRUb0ludGxPcHRpb25zKGRhdGVGb3JtYXQgfHwgXCJzaG9ydC1kYXRlLXNob3J0LXRpbWVcIikpLCB7IHRpbWVab25lIH0pKTtcbiAgICB9XG4gICAgLy8gY29uc29sZS5sb2coXCJnZXREYXRlRGlzcGxheVN0cmluZ1wiLCB2YWx1ZSwgXCIgLSBcIiwgbmV3IERhdGUodmFsdWUpLnRvSVNPU3RyaW5nKCksIFwiIC0+IFwiLCBzdHIpO1xuICAgIHJldHVybiBzdHI7XG59XG5cbmV4cG9ydCB7IGFkZERhdGVGb3JtYXRGdW5jdGlvbnMgYXMgYSwgdXRjVG9UaW1lUGlja2VyIGFzIGIsIGRhdGVQaWNrZXJUb1VUQyBhcyBkLCB1dGNUb0RhdGVQaWNrZXIgYXMgdSB9O1xuXG4vLyMgc291cmNlTWFwcGluZ1VSTD1kYXRlLTc5YzdkOTNjLmpzLm1hcCJdLCJuYW1lcyI6W10sInNvdXJjZVJvb3QiOiIifQ==