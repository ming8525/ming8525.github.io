"use strict";
(self["webpackChunkexb_client"] = self["webpackChunkexb_client"] || []).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_data-s-0c8dec"],{

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/data-store-8e83fb7a.js":
/*!****************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/data-store-8e83fb7a.js ***!
  \****************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   a: () => (/* binding */ createHdfsProviderDataObject),
/* harmony export */   b: () => (/* binding */ createHiveProviderDataObject),
/* harmony export */   c: () => (/* binding */ createFileShareProviderDataObject),
/* harmony export */   d: () => (/* binding */ createCloudProviderDataObject),
/* harmony export */   e: () => (/* binding */ createFolderDataObject),
/* harmony export */   f: () => (/* binding */ createDatabaseDataObject),
/* harmony export */   g: () => (/* binding */ getConnectionString),
/* harmony export */   h: () => (/* binding */ createNoSqlDataObject),
/* harmony export */   i: () => (/* binding */ isArcGISEnterpriseOnKubernetes),
/* harmony export */   j: () => (/* binding */ getBdfsParameterItem),
/* harmony export */   k: () => (/* binding */ getPublishingToolsUrl),
/* harmony export */   l: () => (/* binding */ createBigQueryDataObject),
/* harmony export */   m: () => (/* binding */ createSnowflakeDataObject)
/* harmony export */ });
/* harmony import */ var _portal_d518b571_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./portal-d518b571.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/portal-d518b571.js");
/* harmony import */ var _config_75adf962_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./config-75adf962.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/config-75adf962.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v4.0.58
 */



function createFolderDataObject(item, title) {
    const datastorePayload = {
        type: "folder",
        path: `/fileShares/${title}`,
        info: {
            datastoreConnectionType: "shared",
            path: item.publisherFolderPath,
            hostName: item.publisherFolderPathHostname
        }
    };
    if (item.serverFolderPath === "newPath") {
        datastorePayload.clientPath = item.publisherFolderPath;
        datastorePayload.info.path = item.newServerFolderPath;
        datastorePayload.info.datastoreConnectionType = "replicated";
    }
    else if (item.serverFolderPath === "nfsHostAndPath") {
        datastorePayload.clientPath = item.publisherFolderPath;
        datastorePayload.provider = "UserManaged";
        datastorePayload.info.datastoreConnectionType = "replicated";
        datastorePayload.info.fileServerPath = item.nfsSharePath;
        datastorePayload.info.fileServerHost = item.nfsHostName;
        datastorePayload.info.fileServerType = "nfs";
    }
    return datastorePayload;
}
function createDatabaseDataObject(item, title) {
    const datastorePayload = {
        type: "egdb",
        path: "/enterpriseDatabases/" + title,
        info: {
            dataStoreConnectionType: "shared"
        }
    };
    if (item.serverDatabaseOption === "newConnection") {
        datastorePayload.info.connectionString = item.serverConnectionString;
        datastorePayload.info.clientConnectionString = item.publisherConnectionString;
        datastorePayload.info.dataStoreConnectionType = "replicated";
    }
    else if (item.databaseProvider === "bigQuery" || item.databaseProvider === "snowflake") {
        datastorePayload.info.JDBCConnection = item.jdbcConnection;
    }
    else {
        datastorePayload.info.connectionString = item.publisherConnectionString;
    }
    return datastorePayload;
}
const createBigQueryDataObject = async (projectId, defaultDataset, keyFileContents, refreshToken) => {
    let jdbcConnection, keyFileFormatted;
    if ((keyFileContents === null || keyFileContents === void 0 ? void 0 : keyFileContents.length) > 0) {
        try {
            keyFileFormatted = JSON.parse(keyFileContents);
        }
        catch (_a) {
            return { error: { code: "invalidJSON" } };
        }
        jdbcConnection = createBigQueryDataObjectForServiceAuthentication(projectId, keyFileFormatted);
    }
    else if ((refreshToken === null || refreshToken === void 0 ? void 0 : refreshToken.length) > 0) {
        jdbcConnection = createBigQueryDataObjectForUserAuthentication(projectId, defaultDataset, refreshToken);
    }
    const dataStorePayload = {
        type: "egdb",
        path: "/enterpriseDatabases/bigQuerySvrDevDataJdbc",
        id: null,
        clientPath: null,
        info: {
            JDBCConnection: jdbcConnection
        }
    };
    return { result: dataStorePayload };
};
function createBigQueryDataObjectForUserAuthentication(projectId, defaultDataset, refreshToken) {
    const JDBCConnectionObject = {
        name: "BigqueryArcgisPlatform_RefreshToken",
        className: "com.esri.sds.bigquery.jdbc.GBQDataSource",
        oAuthType: 2,
        projectId,
        defaultDataset,
        url: "jdbc:bigquery://https://www.googleapis.com/bigquery/v2:443",
        oAuthRefreshToken: refreshToken
    };
    return JDBCConnectionObject;
}
function createBigQueryDataObjectForServiceAuthentication(projectId, keyFileContents) {
    const { type, project_id, private_key_id, private_key, client_email, client_id, auth_uri, token_uri, auth_provider_x509_cert_url, client_x509_cert_url } = keyFileContents;
    const JDBCConnectionObject = {
        oAuthType: 0,
        projectId,
        url: "jdbc:bigquery://https://www.googleapis.com/bigquery/v2:443",
        oAuthPvtKeyFile: {
            type,
            project_id,
            private_key_id,
            private_key,
            client_email,
            client_id,
            auth_uri,
            token_uri,
            auth_provider_x509_cert_url,
            client_x509_cert_url
        }
    };
    return JDBCConnectionObject;
}
function createSnowflakeDataObject(args) {
    const { user, password, database, role, server, warehouse, schema } = args;
    const dataStorePayload = {
        path: "/enterpriseDatabases/snowflakeJdbc",
        type: "egdb",
        info: {
            JDBCConnection: {
                user,
                password,
                database,
                role,
                connectionUrl: `jdbc:snowflake://${server}`,
                warehouse,
                schema
            }
        }
    };
    return dataStorePayload;
}
function createNoSqlDataObject(item, title) {
    if (item.noSqlProvider === "Arango") {
        const data = {
            type: "nosql",
            path: "/nosqlDatabases/Arango_enterprise",
            info: {
                systemManaged: false,
                dsFeature: "graphStore",
                isManagedData: false,
                category: "database",
                factory: "nosql",
                provider: "ArangoDB",
                implementation: "ArangoDB",
                purposes: ["knowledge-graph"],
                connectionProperties: {
                    hosts: [],
                    useSsl: item.useSsl,
                    username: item.username,
                    password: item.password,
                    database: item.database
                }
            }
        };
        if (item.hosts !== "") {
            data.info.connectionProperties.hosts = item.hosts.split(",");
        }
        else {
            delete data.info.connectionProperties.hosts;
        }
        return data;
    }
    const data = {
        type: "nosql",
        path: `/nosqlDatabases/${title}`,
        info: {
            provider: "Neo4J",
            isManaged: false,
            dsFeature: "graphStore",
            factory: "nosql",
            implementation: "Neo4j",
            category: "database",
            systemManaged: false,
            isManagedData: false,
            purposes: ["knowledge-graph"],
            connectionProperties: {
                connectionUri: item.connectionUri,
                username: item.username,
                password: item.password,
                database: item.database,
                fallbackServerAddresses: []
            }
        }
    };
    if (item.fallBackServers !== "") {
        data.info.connectionProperties.fallbackServerAddresses.push(item.fallBackServers.split(","));
    }
    else {
        delete data.info.connectionProperties.fallbackServerAddresses;
    }
    return data;
}
function createCloudProviderDataObject(item, title) {
    const provider = item.addDataStoreType === "bdfs" ? item.bdfsCloudProvider : item.provider;
    const datastorePayload = {
        info: {}
    };
    const datastoreConnection = {};
    datastoreConnection.credentialType = "accesskey";
    if (provider === "amazon") {
        if (item.credentialType === "accessKey") {
            datastoreConnection.accessKeyId = item.accessKey;
            datastoreConnection.secretAccessKey = item.secretKey;
        }
        else {
            datastoreConnection.credentialType = item.credentialType;
        }
        if (item.selectedRegion.id === "custom") {
            datastoreConnection.regionEndpointUrl = item.storageURL;
        }
        else {
            datastoreConnection.regionEndpointUrl = getRegionEndpointURL(item.regions, item.selectedRegion);
            datastoreConnection.region = item.selectedRegion.id;
        }
        datastorePayload.info.objectStore = item.bucketName;
        datastorePayload.provider = "amazon";
    }
    if (provider === "google") {
        datastoreConnection.accessKeyId = item.accessKey;
        datastoreConnection.secretAccessKey = item.secretKey;
        datastoreConnection.regionEndpointUrl = "https://storage.googleapis.com";
        datastorePayload.info.objectStore = item.bucketName;
        datastorePayload.provider = "Google";
    }
    if (provider === "azure") {
        if (item.azureAuthenticationType === "sharedKey") {
            datastoreConnection.credentialType = "accessKey";
            datastoreConnection.accountKey = item.accountKey;
        }
        else if (item.azureAuthenticationType === "activeDirectory") {
            datastoreConnection.credentialType = item.azureIdentityType;
            if (item.azureIdentityType === "servicePrincipal") {
                datastoreConnection.tenantId = item.tenantId;
                datastoreConnection.clientId = item.clientId;
                datastoreConnection.clientSecret = item.clientSecret;
            }
            else if (item.azureIdentityType === "userAssignedIdentity") {
                datastoreConnection.managedIdentityClientId = item.clientId;
            }
        }
        else if (item.azureAuthenticationType === "sasToken") {
            datastoreConnection.credentialType = item.azureAuthenticationType;
            datastoreConnection.sasToken = item.token;
        }
        else if (item.azureAuthenticationType === "anonymous") {
            datastoreConnection.credentialType = item.azureAuthenticationType;
        }
        if (item.environment.id === "other" || item.azureAuthenticationType === "anonymous") {
            datastoreConnection.regionEndpointUrl = item.endpoint;
        }
        else {
            datastoreConnection.accountEndpoint = getRegionEndpointURL(item.regions, item.environment);
        }
        datastoreConnection.accountName = item.accountName;
        datastorePayload.info.objectStore = item.containerName;
        datastorePayload.provider = "azure";
    }
    if (provider === "azuredatalakegen2store") {
        if (item.environment.id === "other") {
            datastoreConnection.regionEndpointUrl = item.endpoint;
        }
        else {
            datastoreConnection.accountEndpoint = getRegionEndpointURL(item.regions, item.environment);
        }
        datastoreConnection.credentialType = "accessKey";
        datastoreConnection.accountKey = item.accountKey;
        datastorePayload.info.folder = item.cloudFolder ? `${item.containerName}/${item.cloudFolder}` : item.containerName;
        datastoreConnection.accountName = item.accountName;
        datastorePayload.provider = "azureDataLakeStore";
    }
    if (provider === "alibaba") {
        datastoreConnection.accessKeyId = item.accessKey;
        datastoreConnection.secretAccessKey = item.secretKey;
        datastorePayload.info.objectStore = item.bucketName;
        datastorePayload.provider = "Alibaba";
        datastoreConnection.regionEndpointUrl =
            item.selectedRegion.id === "custom" ? item.storageURL : getRegionEndpointURL(item.regions, item.selectedRegion);
    }
    datastoreConnection.defaultEndpointsProtocol = "https";
    if (item.cloudFolder && provider !== "azuredatalakegen2store") {
        datastorePayload.info.objectStore = datastorePayload.info.objectStore + "/" + item.cloudFolder;
    }
    datastorePayload.type = "cloudStore";
    datastorePayload.path = "/cloudStores/" + title;
    datastorePayload.info.connectionString = JSON.stringify(datastoreConnection);
    return datastorePayload;
}
function createFileShareProviderDataObject(item, title) {
    return {
        type: "bigDataFileShare",
        path: `/bigDataFileShares/${title}`,
        info: {
            connectionString: JSON.stringify({ path: item.bdfsFilesharePath }),
            connectionType: "fileShare"
        }
    };
}
function createHdfsProviderDataObject(item, title) {
    return {
        type: "bigDataFileShare",
        path: `/bigDataFileShares/${title}`,
        info: {
            connectionString: JSON.stringify({ path: item.bdfsHdfsPath, username: item.bdfsHdfsUsername }),
            connectionType: "hdfs"
        }
    };
}
function createHiveProviderDataObject(item, title) {
    const datastorePayload = {
        type: "bigDataFileShare",
        path: "/bigDataFileShares/" + title,
        info: {
            connectionString: "",
            connectionType: "hive"
        }
    };
    const useNonDefaultDatabase = item.useNonDefaultDatabase;
    datastorePayload.info.connectionString = JSON.stringify({
        metaStoreUris: item.metastoreUris,
        database: useNonDefaultDatabase ? item.nonDefaultDatabaseName || "default" : "default"
    });
    return datastorePayload;
}
function getBdfsParameterItem(title, path) {
    return JSON.stringify({
        info: {
            connectionString: JSON.stringify({ path: path }),
            connectionType: "dataStore"
        },
        path: `/bigDataFileShares/${title}`,
        type: "bigDataFileShare"
    });
}
function getRegionEndpointURL(regionOptions, regionValue) {
    let resultRegionURL;
    regionOptions.forEach(function (regionItem) {
        if (regionItem.id === regionValue.id) {
            resultRegionURL = regionItem.blobStoreEndpoint || regionItem.storageEndpointSuffix;
        }
    });
    return resultRegionURL;
}
const getConnectionString = async (jobResults, publishingToolsUrl) => {
    const paramUrl = jobResults.results.out_connectionString.paramUrl;
    const jobId = jobResults.jobId;
    const url = `${publishingToolsUrl}/Get%20Database%20Connection%20String/jobs/${jobId}/${paramUrl}`;
    const response = await (0,_portal_d518b571_js__WEBPACK_IMPORTED_MODULE_0__.r)(url);
    return processConnectionString(response);
};
const processConnectionString = (result) => {
    const string = result.value;
    const connectionStringProps = parseConnectionString(string);
    return { connectionStringProps: connectionStringProps, connectionString: string };
};
const parseConnectionString = (connectionString) => {
    let connectionStringArray = [];
    if (connectionString) {
        connectionString.split(";").forEach((propString) => {
            const pair = propString.split("=");
            if (pair.length === 2 && !doesKeyExist(connectionStringArray, pair[0])) {
                connectionStringArray.push({ key: pair[0], value: pair[1] });
            }
        });
    }
    return connectionStringArray;
};
const doesKeyExist = (connectionStringArray, key) => {
    return connectionStringArray.some((prop) => {
        return prop.key === key;
    });
};
const isArcGISEnterpriseOnKubernetes = () => {
    var _a;
    const portal = _config_75adf962_js__WEBPACK_IMPORTED_MODULE_1__.c.portal;
    const deploymentType = portal.portalDeploymentType || ((_a = portal.sourceJSON) === null || _a === void 0 ? void 0 : _a.portalDeploymentType);
    return portal.isPortal && deploymentType === "ArcGISEnterpriseOnKubernetes";
};
const getPublishingToolsUrl = (hostingServerUrl) => {
    if (!hostingServerUrl) {
        return "";
    }
    const publishingToolsEndpoint = "PublishingTools";
    return `${hostingServerUrl}/rest/services/System/${publishingToolsEndpoint}/GPServer`;
};



//# sourceMappingURL=data-store-8e83fb7a.js.map

/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0cy9jaHVua3MvYXJjZ2lzX2FuYWx5c2lzX25vZGVfbW9kdWxlc19hcmNnaXNfYXBwLWNvbXBvbmVudHNfZGlzdF9lc21fZGF0YS1zLTBjOGRlYy5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNvRDtBQUNJOztBQUV4RDtBQUNBO0FBQ0E7QUFDQSw2QkFBNkIsTUFBTTtBQUNuQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQixTQUFTO0FBQzlCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsWUFBWSxpSkFBaUo7QUFDN0o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFlBQVksNERBQTREO0FBQ3hFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1EQUFtRCxPQUFPO0FBQzFEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUNBQWlDLE1BQU07QUFDdkM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDZEQUE2RCxtQkFBbUIsR0FBRyxpQkFBaUI7QUFDcEc7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG9DQUFvQyxNQUFNO0FBQzFDO0FBQ0EsK0NBQStDLDhCQUE4QjtBQUM3RTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG9DQUFvQyxNQUFNO0FBQzFDO0FBQ0EsK0NBQStDLDBEQUEwRDtBQUN6RztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwrQ0FBK0MsWUFBWTtBQUMzRDtBQUNBLFNBQVM7QUFDVCxvQ0FBb0MsTUFBTTtBQUMxQztBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsbUJBQW1CLG1CQUFtQiw2Q0FBNkMsTUFBTSxHQUFHLFNBQVM7QUFDckcsMkJBQTJCLHNEQUFPO0FBQ2xDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQ0FBaUM7QUFDakM7QUFDQTtBQUNBLDZDQUE2Qyw4QkFBOEI7QUFDM0U7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQixrREFBVztBQUM5QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsY0FBYyxpQkFBaUIsd0JBQXdCLHdCQUF3QjtBQUMvRTs7QUFFeWE7O0FBRXphIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vZXhiLWNsaWVudC8uL2V4dGVuc2lvbnMvd2lkZ2V0cy9hcmNnaXMvYW5hbHlzaXMvbm9kZV9tb2R1bGVzL0BhcmNnaXMvYXBwLWNvbXBvbmVudHMvZGlzdC9lc20vZGF0YS1zdG9yZS04ZTgzZmI3YS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEFsbCBtYXRlcmlhbCBjb3B5cmlnaHQgRVNSSSwgQWxsIFJpZ2h0cyBSZXNlcnZlZCwgdW5sZXNzIG90aGVyd2lzZSBzcGVjaWZpZWQuXG4gKiB2NC4wLjU4XG4gKi9cbmltcG9ydCB7IHIgYXMgcmVxdWVzdCB9IGZyb20gJy4vcG9ydGFsLWQ1MThiNTcxLmpzJztcbmltcG9ydCB7IGMgYXMgY29uZmlnU3RhdGUgfSBmcm9tICcuL2NvbmZpZy03NWFkZjk2Mi5qcyc7XG5cbmZ1bmN0aW9uIGNyZWF0ZUZvbGRlckRhdGFPYmplY3QoaXRlbSwgdGl0bGUpIHtcbiAgICBjb25zdCBkYXRhc3RvcmVQYXlsb2FkID0ge1xuICAgICAgICB0eXBlOiBcImZvbGRlclwiLFxuICAgICAgICBwYXRoOiBgL2ZpbGVTaGFyZXMvJHt0aXRsZX1gLFxuICAgICAgICBpbmZvOiB7XG4gICAgICAgICAgICBkYXRhc3RvcmVDb25uZWN0aW9uVHlwZTogXCJzaGFyZWRcIixcbiAgICAgICAgICAgIHBhdGg6IGl0ZW0ucHVibGlzaGVyRm9sZGVyUGF0aCxcbiAgICAgICAgICAgIGhvc3ROYW1lOiBpdGVtLnB1Ymxpc2hlckZvbGRlclBhdGhIb3N0bmFtZVxuICAgICAgICB9XG4gICAgfTtcbiAgICBpZiAoaXRlbS5zZXJ2ZXJGb2xkZXJQYXRoID09PSBcIm5ld1BhdGhcIikge1xuICAgICAgICBkYXRhc3RvcmVQYXlsb2FkLmNsaWVudFBhdGggPSBpdGVtLnB1Ymxpc2hlckZvbGRlclBhdGg7XG4gICAgICAgIGRhdGFzdG9yZVBheWxvYWQuaW5mby5wYXRoID0gaXRlbS5uZXdTZXJ2ZXJGb2xkZXJQYXRoO1xuICAgICAgICBkYXRhc3RvcmVQYXlsb2FkLmluZm8uZGF0YXN0b3JlQ29ubmVjdGlvblR5cGUgPSBcInJlcGxpY2F0ZWRcIjtcbiAgICB9XG4gICAgZWxzZSBpZiAoaXRlbS5zZXJ2ZXJGb2xkZXJQYXRoID09PSBcIm5mc0hvc3RBbmRQYXRoXCIpIHtcbiAgICAgICAgZGF0YXN0b3JlUGF5bG9hZC5jbGllbnRQYXRoID0gaXRlbS5wdWJsaXNoZXJGb2xkZXJQYXRoO1xuICAgICAgICBkYXRhc3RvcmVQYXlsb2FkLnByb3ZpZGVyID0gXCJVc2VyTWFuYWdlZFwiO1xuICAgICAgICBkYXRhc3RvcmVQYXlsb2FkLmluZm8uZGF0YXN0b3JlQ29ubmVjdGlvblR5cGUgPSBcInJlcGxpY2F0ZWRcIjtcbiAgICAgICAgZGF0YXN0b3JlUGF5bG9hZC5pbmZvLmZpbGVTZXJ2ZXJQYXRoID0gaXRlbS5uZnNTaGFyZVBhdGg7XG4gICAgICAgIGRhdGFzdG9yZVBheWxvYWQuaW5mby5maWxlU2VydmVySG9zdCA9IGl0ZW0ubmZzSG9zdE5hbWU7XG4gICAgICAgIGRhdGFzdG9yZVBheWxvYWQuaW5mby5maWxlU2VydmVyVHlwZSA9IFwibmZzXCI7XG4gICAgfVxuICAgIHJldHVybiBkYXRhc3RvcmVQYXlsb2FkO1xufVxuZnVuY3Rpb24gY3JlYXRlRGF0YWJhc2VEYXRhT2JqZWN0KGl0ZW0sIHRpdGxlKSB7XG4gICAgY29uc3QgZGF0YXN0b3JlUGF5bG9hZCA9IHtcbiAgICAgICAgdHlwZTogXCJlZ2RiXCIsXG4gICAgICAgIHBhdGg6IFwiL2VudGVycHJpc2VEYXRhYmFzZXMvXCIgKyB0aXRsZSxcbiAgICAgICAgaW5mbzoge1xuICAgICAgICAgICAgZGF0YVN0b3JlQ29ubmVjdGlvblR5cGU6IFwic2hhcmVkXCJcbiAgICAgICAgfVxuICAgIH07XG4gICAgaWYgKGl0ZW0uc2VydmVyRGF0YWJhc2VPcHRpb24gPT09IFwibmV3Q29ubmVjdGlvblwiKSB7XG4gICAgICAgIGRhdGFzdG9yZVBheWxvYWQuaW5mby5jb25uZWN0aW9uU3RyaW5nID0gaXRlbS5zZXJ2ZXJDb25uZWN0aW9uU3RyaW5nO1xuICAgICAgICBkYXRhc3RvcmVQYXlsb2FkLmluZm8uY2xpZW50Q29ubmVjdGlvblN0cmluZyA9IGl0ZW0ucHVibGlzaGVyQ29ubmVjdGlvblN0cmluZztcbiAgICAgICAgZGF0YXN0b3JlUGF5bG9hZC5pbmZvLmRhdGFTdG9yZUNvbm5lY3Rpb25UeXBlID0gXCJyZXBsaWNhdGVkXCI7XG4gICAgfVxuICAgIGVsc2UgaWYgKGl0ZW0uZGF0YWJhc2VQcm92aWRlciA9PT0gXCJiaWdRdWVyeVwiIHx8IGl0ZW0uZGF0YWJhc2VQcm92aWRlciA9PT0gXCJzbm93Zmxha2VcIikge1xuICAgICAgICBkYXRhc3RvcmVQYXlsb2FkLmluZm8uSkRCQ0Nvbm5lY3Rpb24gPSBpdGVtLmpkYmNDb25uZWN0aW9uO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgZGF0YXN0b3JlUGF5bG9hZC5pbmZvLmNvbm5lY3Rpb25TdHJpbmcgPSBpdGVtLnB1Ymxpc2hlckNvbm5lY3Rpb25TdHJpbmc7XG4gICAgfVxuICAgIHJldHVybiBkYXRhc3RvcmVQYXlsb2FkO1xufVxuY29uc3QgY3JlYXRlQmlnUXVlcnlEYXRhT2JqZWN0ID0gYXN5bmMgKHByb2plY3RJZCwgZGVmYXVsdERhdGFzZXQsIGtleUZpbGVDb250ZW50cywgcmVmcmVzaFRva2VuKSA9PiB7XG4gICAgbGV0IGpkYmNDb25uZWN0aW9uLCBrZXlGaWxlRm9ybWF0dGVkO1xuICAgIGlmICgoa2V5RmlsZUNvbnRlbnRzID09PSBudWxsIHx8IGtleUZpbGVDb250ZW50cyA9PT0gdm9pZCAwID8gdm9pZCAwIDoga2V5RmlsZUNvbnRlbnRzLmxlbmd0aCkgPiAwKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBrZXlGaWxlRm9ybWF0dGVkID0gSlNPTi5wYXJzZShrZXlGaWxlQ29udGVudHMpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChfYSkge1xuICAgICAgICAgICAgcmV0dXJuIHsgZXJyb3I6IHsgY29kZTogXCJpbnZhbGlkSlNPTlwiIH0gfTtcbiAgICAgICAgfVxuICAgICAgICBqZGJjQ29ubmVjdGlvbiA9IGNyZWF0ZUJpZ1F1ZXJ5RGF0YU9iamVjdEZvclNlcnZpY2VBdXRoZW50aWNhdGlvbihwcm9qZWN0SWQsIGtleUZpbGVGb3JtYXR0ZWQpO1xuICAgIH1cbiAgICBlbHNlIGlmICgocmVmcmVzaFRva2VuID09PSBudWxsIHx8IHJlZnJlc2hUb2tlbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogcmVmcmVzaFRva2VuLmxlbmd0aCkgPiAwKSB7XG4gICAgICAgIGpkYmNDb25uZWN0aW9uID0gY3JlYXRlQmlnUXVlcnlEYXRhT2JqZWN0Rm9yVXNlckF1dGhlbnRpY2F0aW9uKHByb2plY3RJZCwgZGVmYXVsdERhdGFzZXQsIHJlZnJlc2hUb2tlbik7XG4gICAgfVxuICAgIGNvbnN0IGRhdGFTdG9yZVBheWxvYWQgPSB7XG4gICAgICAgIHR5cGU6IFwiZWdkYlwiLFxuICAgICAgICBwYXRoOiBcIi9lbnRlcnByaXNlRGF0YWJhc2VzL2JpZ1F1ZXJ5U3ZyRGV2RGF0YUpkYmNcIixcbiAgICAgICAgaWQ6IG51bGwsXG4gICAgICAgIGNsaWVudFBhdGg6IG51bGwsXG4gICAgICAgIGluZm86IHtcbiAgICAgICAgICAgIEpEQkNDb25uZWN0aW9uOiBqZGJjQ29ubmVjdGlvblxuICAgICAgICB9XG4gICAgfTtcbiAgICByZXR1cm4geyByZXN1bHQ6IGRhdGFTdG9yZVBheWxvYWQgfTtcbn07XG5mdW5jdGlvbiBjcmVhdGVCaWdRdWVyeURhdGFPYmplY3RGb3JVc2VyQXV0aGVudGljYXRpb24ocHJvamVjdElkLCBkZWZhdWx0RGF0YXNldCwgcmVmcmVzaFRva2VuKSB7XG4gICAgY29uc3QgSkRCQ0Nvbm5lY3Rpb25PYmplY3QgPSB7XG4gICAgICAgIG5hbWU6IFwiQmlncXVlcnlBcmNnaXNQbGF0Zm9ybV9SZWZyZXNoVG9rZW5cIixcbiAgICAgICAgY2xhc3NOYW1lOiBcImNvbS5lc3JpLnNkcy5iaWdxdWVyeS5qZGJjLkdCUURhdGFTb3VyY2VcIixcbiAgICAgICAgb0F1dGhUeXBlOiAyLFxuICAgICAgICBwcm9qZWN0SWQsXG4gICAgICAgIGRlZmF1bHREYXRhc2V0LFxuICAgICAgICB1cmw6IFwiamRiYzpiaWdxdWVyeTovL2h0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL2JpZ3F1ZXJ5L3YyOjQ0M1wiLFxuICAgICAgICBvQXV0aFJlZnJlc2hUb2tlbjogcmVmcmVzaFRva2VuXG4gICAgfTtcbiAgICByZXR1cm4gSkRCQ0Nvbm5lY3Rpb25PYmplY3Q7XG59XG5mdW5jdGlvbiBjcmVhdGVCaWdRdWVyeURhdGFPYmplY3RGb3JTZXJ2aWNlQXV0aGVudGljYXRpb24ocHJvamVjdElkLCBrZXlGaWxlQ29udGVudHMpIHtcbiAgICBjb25zdCB7IHR5cGUsIHByb2plY3RfaWQsIHByaXZhdGVfa2V5X2lkLCBwcml2YXRlX2tleSwgY2xpZW50X2VtYWlsLCBjbGllbnRfaWQsIGF1dGhfdXJpLCB0b2tlbl91cmksIGF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCwgY2xpZW50X3g1MDlfY2VydF91cmwgfSA9IGtleUZpbGVDb250ZW50cztcbiAgICBjb25zdCBKREJDQ29ubmVjdGlvbk9iamVjdCA9IHtcbiAgICAgICAgb0F1dGhUeXBlOiAwLFxuICAgICAgICBwcm9qZWN0SWQsXG4gICAgICAgIHVybDogXCJqZGJjOmJpZ3F1ZXJ5Oi8vaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vYmlncXVlcnkvdjI6NDQzXCIsXG4gICAgICAgIG9BdXRoUHZ0S2V5RmlsZToge1xuICAgICAgICAgICAgdHlwZSxcbiAgICAgICAgICAgIHByb2plY3RfaWQsXG4gICAgICAgICAgICBwcml2YXRlX2tleV9pZCxcbiAgICAgICAgICAgIHByaXZhdGVfa2V5LFxuICAgICAgICAgICAgY2xpZW50X2VtYWlsLFxuICAgICAgICAgICAgY2xpZW50X2lkLFxuICAgICAgICAgICAgYXV0aF91cmksXG4gICAgICAgICAgICB0b2tlbl91cmksXG4gICAgICAgICAgICBhdXRoX3Byb3ZpZGVyX3g1MDlfY2VydF91cmwsXG4gICAgICAgICAgICBjbGllbnRfeDUwOV9jZXJ0X3VybFxuICAgICAgICB9XG4gICAgfTtcbiAgICByZXR1cm4gSkRCQ0Nvbm5lY3Rpb25PYmplY3Q7XG59XG5mdW5jdGlvbiBjcmVhdGVTbm93Zmxha2VEYXRhT2JqZWN0KGFyZ3MpIHtcbiAgICBjb25zdCB7IHVzZXIsIHBhc3N3b3JkLCBkYXRhYmFzZSwgcm9sZSwgc2VydmVyLCB3YXJlaG91c2UsIHNjaGVtYSB9ID0gYXJncztcbiAgICBjb25zdCBkYXRhU3RvcmVQYXlsb2FkID0ge1xuICAgICAgICBwYXRoOiBcIi9lbnRlcnByaXNlRGF0YWJhc2VzL3Nub3dmbGFrZUpkYmNcIixcbiAgICAgICAgdHlwZTogXCJlZ2RiXCIsXG4gICAgICAgIGluZm86IHtcbiAgICAgICAgICAgIEpEQkNDb25uZWN0aW9uOiB7XG4gICAgICAgICAgICAgICAgdXNlcixcbiAgICAgICAgICAgICAgICBwYXNzd29yZCxcbiAgICAgICAgICAgICAgICBkYXRhYmFzZSxcbiAgICAgICAgICAgICAgICByb2xlLFxuICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25Vcmw6IGBqZGJjOnNub3dmbGFrZTovLyR7c2VydmVyfWAsXG4gICAgICAgICAgICAgICAgd2FyZWhvdXNlLFxuICAgICAgICAgICAgICAgIHNjaGVtYVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfTtcbiAgICByZXR1cm4gZGF0YVN0b3JlUGF5bG9hZDtcbn1cbmZ1bmN0aW9uIGNyZWF0ZU5vU3FsRGF0YU9iamVjdChpdGVtLCB0aXRsZSkge1xuICAgIGlmIChpdGVtLm5vU3FsUHJvdmlkZXIgPT09IFwiQXJhbmdvXCIpIHtcbiAgICAgICAgY29uc3QgZGF0YSA9IHtcbiAgICAgICAgICAgIHR5cGU6IFwibm9zcWxcIixcbiAgICAgICAgICAgIHBhdGg6IFwiL25vc3FsRGF0YWJhc2VzL0FyYW5nb19lbnRlcnByaXNlXCIsXG4gICAgICAgICAgICBpbmZvOiB7XG4gICAgICAgICAgICAgICAgc3lzdGVtTWFuYWdlZDogZmFsc2UsXG4gICAgICAgICAgICAgICAgZHNGZWF0dXJlOiBcImdyYXBoU3RvcmVcIixcbiAgICAgICAgICAgICAgICBpc01hbmFnZWREYXRhOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBjYXRlZ29yeTogXCJkYXRhYmFzZVwiLFxuICAgICAgICAgICAgICAgIGZhY3Rvcnk6IFwibm9zcWxcIixcbiAgICAgICAgICAgICAgICBwcm92aWRlcjogXCJBcmFuZ29EQlwiLFxuICAgICAgICAgICAgICAgIGltcGxlbWVudGF0aW9uOiBcIkFyYW5nb0RCXCIsXG4gICAgICAgICAgICAgICAgcHVycG9zZXM6IFtcImtub3dsZWRnZS1ncmFwaFwiXSxcbiAgICAgICAgICAgICAgICBjb25uZWN0aW9uUHJvcGVydGllczoge1xuICAgICAgICAgICAgICAgICAgICBob3N0czogW10sXG4gICAgICAgICAgICAgICAgICAgIHVzZVNzbDogaXRlbS51c2VTc2wsXG4gICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiBpdGVtLnVzZXJuYW1lLFxuICAgICAgICAgICAgICAgICAgICBwYXNzd29yZDogaXRlbS5wYXNzd29yZCxcbiAgICAgICAgICAgICAgICAgICAgZGF0YWJhc2U6IGl0ZW0uZGF0YWJhc2VcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIGlmIChpdGVtLmhvc3RzICE9PSBcIlwiKSB7XG4gICAgICAgICAgICBkYXRhLmluZm8uY29ubmVjdGlvblByb3BlcnRpZXMuaG9zdHMgPSBpdGVtLmhvc3RzLnNwbGl0KFwiLFwiKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGRlbGV0ZSBkYXRhLmluZm8uY29ubmVjdGlvblByb3BlcnRpZXMuaG9zdHM7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxuICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICAgIHR5cGU6IFwibm9zcWxcIixcbiAgICAgICAgcGF0aDogYC9ub3NxbERhdGFiYXNlcy8ke3RpdGxlfWAsXG4gICAgICAgIGluZm86IHtcbiAgICAgICAgICAgIHByb3ZpZGVyOiBcIk5lbzRKXCIsXG4gICAgICAgICAgICBpc01hbmFnZWQ6IGZhbHNlLFxuICAgICAgICAgICAgZHNGZWF0dXJlOiBcImdyYXBoU3RvcmVcIixcbiAgICAgICAgICAgIGZhY3Rvcnk6IFwibm9zcWxcIixcbiAgICAgICAgICAgIGltcGxlbWVudGF0aW9uOiBcIk5lbzRqXCIsXG4gICAgICAgICAgICBjYXRlZ29yeTogXCJkYXRhYmFzZVwiLFxuICAgICAgICAgICAgc3lzdGVtTWFuYWdlZDogZmFsc2UsXG4gICAgICAgICAgICBpc01hbmFnZWREYXRhOiBmYWxzZSxcbiAgICAgICAgICAgIHB1cnBvc2VzOiBbXCJrbm93bGVkZ2UtZ3JhcGhcIl0sXG4gICAgICAgICAgICBjb25uZWN0aW9uUHJvcGVydGllczoge1xuICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25Vcmk6IGl0ZW0uY29ubmVjdGlvblVyaSxcbiAgICAgICAgICAgICAgICB1c2VybmFtZTogaXRlbS51c2VybmFtZSxcbiAgICAgICAgICAgICAgICBwYXNzd29yZDogaXRlbS5wYXNzd29yZCxcbiAgICAgICAgICAgICAgICBkYXRhYmFzZTogaXRlbS5kYXRhYmFzZSxcbiAgICAgICAgICAgICAgICBmYWxsYmFja1NlcnZlckFkZHJlc3NlczogW11cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG4gICAgaWYgKGl0ZW0uZmFsbEJhY2tTZXJ2ZXJzICE9PSBcIlwiKSB7XG4gICAgICAgIGRhdGEuaW5mby5jb25uZWN0aW9uUHJvcGVydGllcy5mYWxsYmFja1NlcnZlckFkZHJlc3Nlcy5wdXNoKGl0ZW0uZmFsbEJhY2tTZXJ2ZXJzLnNwbGl0KFwiLFwiKSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBkZWxldGUgZGF0YS5pbmZvLmNvbm5lY3Rpb25Qcm9wZXJ0aWVzLmZhbGxiYWNrU2VydmVyQWRkcmVzc2VzO1xuICAgIH1cbiAgICByZXR1cm4gZGF0YTtcbn1cbmZ1bmN0aW9uIGNyZWF0ZUNsb3VkUHJvdmlkZXJEYXRhT2JqZWN0KGl0ZW0sIHRpdGxlKSB7XG4gICAgY29uc3QgcHJvdmlkZXIgPSBpdGVtLmFkZERhdGFTdG9yZVR5cGUgPT09IFwiYmRmc1wiID8gaXRlbS5iZGZzQ2xvdWRQcm92aWRlciA6IGl0ZW0ucHJvdmlkZXI7XG4gICAgY29uc3QgZGF0YXN0b3JlUGF5bG9hZCA9IHtcbiAgICAgICAgaW5mbzoge31cbiAgICB9O1xuICAgIGNvbnN0IGRhdGFzdG9yZUNvbm5lY3Rpb24gPSB7fTtcbiAgICBkYXRhc3RvcmVDb25uZWN0aW9uLmNyZWRlbnRpYWxUeXBlID0gXCJhY2Nlc3NrZXlcIjtcbiAgICBpZiAocHJvdmlkZXIgPT09IFwiYW1hem9uXCIpIHtcbiAgICAgICAgaWYgKGl0ZW0uY3JlZGVudGlhbFR5cGUgPT09IFwiYWNjZXNzS2V5XCIpIHtcbiAgICAgICAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24uYWNjZXNzS2V5SWQgPSBpdGVtLmFjY2Vzc0tleTtcbiAgICAgICAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24uc2VjcmV0QWNjZXNzS2V5ID0gaXRlbS5zZWNyZXRLZXk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBkYXRhc3RvcmVDb25uZWN0aW9uLmNyZWRlbnRpYWxUeXBlID0gaXRlbS5jcmVkZW50aWFsVHlwZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoaXRlbS5zZWxlY3RlZFJlZ2lvbi5pZCA9PT0gXCJjdXN0b21cIikge1xuICAgICAgICAgICAgZGF0YXN0b3JlQ29ubmVjdGlvbi5yZWdpb25FbmRwb2ludFVybCA9IGl0ZW0uc3RvcmFnZVVSTDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24ucmVnaW9uRW5kcG9pbnRVcmwgPSBnZXRSZWdpb25FbmRwb2ludFVSTChpdGVtLnJlZ2lvbnMsIGl0ZW0uc2VsZWN0ZWRSZWdpb24pO1xuICAgICAgICAgICAgZGF0YXN0b3JlQ29ubmVjdGlvbi5yZWdpb24gPSBpdGVtLnNlbGVjdGVkUmVnaW9uLmlkO1xuICAgICAgICB9XG4gICAgICAgIGRhdGFzdG9yZVBheWxvYWQuaW5mby5vYmplY3RTdG9yZSA9IGl0ZW0uYnVja2V0TmFtZTtcbiAgICAgICAgZGF0YXN0b3JlUGF5bG9hZC5wcm92aWRlciA9IFwiYW1hem9uXCI7XG4gICAgfVxuICAgIGlmIChwcm92aWRlciA9PT0gXCJnb29nbGVcIikge1xuICAgICAgICBkYXRhc3RvcmVDb25uZWN0aW9uLmFjY2Vzc0tleUlkID0gaXRlbS5hY2Nlc3NLZXk7XG4gICAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24uc2VjcmV0QWNjZXNzS2V5ID0gaXRlbS5zZWNyZXRLZXk7XG4gICAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24ucmVnaW9uRW5kcG9pbnRVcmwgPSBcImh0dHBzOi8vc3RvcmFnZS5nb29nbGVhcGlzLmNvbVwiO1xuICAgICAgICBkYXRhc3RvcmVQYXlsb2FkLmluZm8ub2JqZWN0U3RvcmUgPSBpdGVtLmJ1Y2tldE5hbWU7XG4gICAgICAgIGRhdGFzdG9yZVBheWxvYWQucHJvdmlkZXIgPSBcIkdvb2dsZVwiO1xuICAgIH1cbiAgICBpZiAocHJvdmlkZXIgPT09IFwiYXp1cmVcIikge1xuICAgICAgICBpZiAoaXRlbS5henVyZUF1dGhlbnRpY2F0aW9uVHlwZSA9PT0gXCJzaGFyZWRLZXlcIikge1xuICAgICAgICAgICAgZGF0YXN0b3JlQ29ubmVjdGlvbi5jcmVkZW50aWFsVHlwZSA9IFwiYWNjZXNzS2V5XCI7XG4gICAgICAgICAgICBkYXRhc3RvcmVDb25uZWN0aW9uLmFjY291bnRLZXkgPSBpdGVtLmFjY291bnRLZXk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoaXRlbS5henVyZUF1dGhlbnRpY2F0aW9uVHlwZSA9PT0gXCJhY3RpdmVEaXJlY3RvcnlcIikge1xuICAgICAgICAgICAgZGF0YXN0b3JlQ29ubmVjdGlvbi5jcmVkZW50aWFsVHlwZSA9IGl0ZW0uYXp1cmVJZGVudGl0eVR5cGU7XG4gICAgICAgICAgICBpZiAoaXRlbS5henVyZUlkZW50aXR5VHlwZSA9PT0gXCJzZXJ2aWNlUHJpbmNpcGFsXCIpIHtcbiAgICAgICAgICAgICAgICBkYXRhc3RvcmVDb25uZWN0aW9uLnRlbmFudElkID0gaXRlbS50ZW5hbnRJZDtcbiAgICAgICAgICAgICAgICBkYXRhc3RvcmVDb25uZWN0aW9uLmNsaWVudElkID0gaXRlbS5jbGllbnRJZDtcbiAgICAgICAgICAgICAgICBkYXRhc3RvcmVDb25uZWN0aW9uLmNsaWVudFNlY3JldCA9IGl0ZW0uY2xpZW50U2VjcmV0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoaXRlbS5henVyZUlkZW50aXR5VHlwZSA9PT0gXCJ1c2VyQXNzaWduZWRJZGVudGl0eVwiKSB7XG4gICAgICAgICAgICAgICAgZGF0YXN0b3JlQ29ubmVjdGlvbi5tYW5hZ2VkSWRlbnRpdHlDbGllbnRJZCA9IGl0ZW0uY2xpZW50SWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoaXRlbS5henVyZUF1dGhlbnRpY2F0aW9uVHlwZSA9PT0gXCJzYXNUb2tlblwiKSB7XG4gICAgICAgICAgICBkYXRhc3RvcmVDb25uZWN0aW9uLmNyZWRlbnRpYWxUeXBlID0gaXRlbS5henVyZUF1dGhlbnRpY2F0aW9uVHlwZTtcbiAgICAgICAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24uc2FzVG9rZW4gPSBpdGVtLnRva2VuO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGl0ZW0uYXp1cmVBdXRoZW50aWNhdGlvblR5cGUgPT09IFwiYW5vbnltb3VzXCIpIHtcbiAgICAgICAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24uY3JlZGVudGlhbFR5cGUgPSBpdGVtLmF6dXJlQXV0aGVudGljYXRpb25UeXBlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChpdGVtLmVudmlyb25tZW50LmlkID09PSBcIm90aGVyXCIgfHwgaXRlbS5henVyZUF1dGhlbnRpY2F0aW9uVHlwZSA9PT0gXCJhbm9ueW1vdXNcIikge1xuICAgICAgICAgICAgZGF0YXN0b3JlQ29ubmVjdGlvbi5yZWdpb25FbmRwb2ludFVybCA9IGl0ZW0uZW5kcG9pbnQ7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBkYXRhc3RvcmVDb25uZWN0aW9uLmFjY291bnRFbmRwb2ludCA9IGdldFJlZ2lvbkVuZHBvaW50VVJMKGl0ZW0ucmVnaW9ucywgaXRlbS5lbnZpcm9ubWVudCk7XG4gICAgICAgIH1cbiAgICAgICAgZGF0YXN0b3JlQ29ubmVjdGlvbi5hY2NvdW50TmFtZSA9IGl0ZW0uYWNjb3VudE5hbWU7XG4gICAgICAgIGRhdGFzdG9yZVBheWxvYWQuaW5mby5vYmplY3RTdG9yZSA9IGl0ZW0uY29udGFpbmVyTmFtZTtcbiAgICAgICAgZGF0YXN0b3JlUGF5bG9hZC5wcm92aWRlciA9IFwiYXp1cmVcIjtcbiAgICB9XG4gICAgaWYgKHByb3ZpZGVyID09PSBcImF6dXJlZGF0YWxha2VnZW4yc3RvcmVcIikge1xuICAgICAgICBpZiAoaXRlbS5lbnZpcm9ubWVudC5pZCA9PT0gXCJvdGhlclwiKSB7XG4gICAgICAgICAgICBkYXRhc3RvcmVDb25uZWN0aW9uLnJlZ2lvbkVuZHBvaW50VXJsID0gaXRlbS5lbmRwb2ludDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24uYWNjb3VudEVuZHBvaW50ID0gZ2V0UmVnaW9uRW5kcG9pbnRVUkwoaXRlbS5yZWdpb25zLCBpdGVtLmVudmlyb25tZW50KTtcbiAgICAgICAgfVxuICAgICAgICBkYXRhc3RvcmVDb25uZWN0aW9uLmNyZWRlbnRpYWxUeXBlID0gXCJhY2Nlc3NLZXlcIjtcbiAgICAgICAgZGF0YXN0b3JlQ29ubmVjdGlvbi5hY2NvdW50S2V5ID0gaXRlbS5hY2NvdW50S2V5O1xuICAgICAgICBkYXRhc3RvcmVQYXlsb2FkLmluZm8uZm9sZGVyID0gaXRlbS5jbG91ZEZvbGRlciA/IGAke2l0ZW0uY29udGFpbmVyTmFtZX0vJHtpdGVtLmNsb3VkRm9sZGVyfWAgOiBpdGVtLmNvbnRhaW5lck5hbWU7XG4gICAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24uYWNjb3VudE5hbWUgPSBpdGVtLmFjY291bnROYW1lO1xuICAgICAgICBkYXRhc3RvcmVQYXlsb2FkLnByb3ZpZGVyID0gXCJhenVyZURhdGFMYWtlU3RvcmVcIjtcbiAgICB9XG4gICAgaWYgKHByb3ZpZGVyID09PSBcImFsaWJhYmFcIikge1xuICAgICAgICBkYXRhc3RvcmVDb25uZWN0aW9uLmFjY2Vzc0tleUlkID0gaXRlbS5hY2Nlc3NLZXk7XG4gICAgICAgIGRhdGFzdG9yZUNvbm5lY3Rpb24uc2VjcmV0QWNjZXNzS2V5ID0gaXRlbS5zZWNyZXRLZXk7XG4gICAgICAgIGRhdGFzdG9yZVBheWxvYWQuaW5mby5vYmplY3RTdG9yZSA9IGl0ZW0uYnVja2V0TmFtZTtcbiAgICAgICAgZGF0YXN0b3JlUGF5bG9hZC5wcm92aWRlciA9IFwiQWxpYmFiYVwiO1xuICAgICAgICBkYXRhc3RvcmVDb25uZWN0aW9uLnJlZ2lvbkVuZHBvaW50VXJsID1cbiAgICAgICAgICAgIGl0ZW0uc2VsZWN0ZWRSZWdpb24uaWQgPT09IFwiY3VzdG9tXCIgPyBpdGVtLnN0b3JhZ2VVUkwgOiBnZXRSZWdpb25FbmRwb2ludFVSTChpdGVtLnJlZ2lvbnMsIGl0ZW0uc2VsZWN0ZWRSZWdpb24pO1xuICAgIH1cbiAgICBkYXRhc3RvcmVDb25uZWN0aW9uLmRlZmF1bHRFbmRwb2ludHNQcm90b2NvbCA9IFwiaHR0cHNcIjtcbiAgICBpZiAoaXRlbS5jbG91ZEZvbGRlciAmJiBwcm92aWRlciAhPT0gXCJhenVyZWRhdGFsYWtlZ2VuMnN0b3JlXCIpIHtcbiAgICAgICAgZGF0YXN0b3JlUGF5bG9hZC5pbmZvLm9iamVjdFN0b3JlID0gZGF0YXN0b3JlUGF5bG9hZC5pbmZvLm9iamVjdFN0b3JlICsgXCIvXCIgKyBpdGVtLmNsb3VkRm9sZGVyO1xuICAgIH1cbiAgICBkYXRhc3RvcmVQYXlsb2FkLnR5cGUgPSBcImNsb3VkU3RvcmVcIjtcbiAgICBkYXRhc3RvcmVQYXlsb2FkLnBhdGggPSBcIi9jbG91ZFN0b3Jlcy9cIiArIHRpdGxlO1xuICAgIGRhdGFzdG9yZVBheWxvYWQuaW5mby5jb25uZWN0aW9uU3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoZGF0YXN0b3JlQ29ubmVjdGlvbik7XG4gICAgcmV0dXJuIGRhdGFzdG9yZVBheWxvYWQ7XG59XG5mdW5jdGlvbiBjcmVhdGVGaWxlU2hhcmVQcm92aWRlckRhdGFPYmplY3QoaXRlbSwgdGl0bGUpIHtcbiAgICByZXR1cm4ge1xuICAgICAgICB0eXBlOiBcImJpZ0RhdGFGaWxlU2hhcmVcIixcbiAgICAgICAgcGF0aDogYC9iaWdEYXRhRmlsZVNoYXJlcy8ke3RpdGxlfWAsXG4gICAgICAgIGluZm86IHtcbiAgICAgICAgICAgIGNvbm5lY3Rpb25TdHJpbmc6IEpTT04uc3RyaW5naWZ5KHsgcGF0aDogaXRlbS5iZGZzRmlsZXNoYXJlUGF0aCB9KSxcbiAgICAgICAgICAgIGNvbm5lY3Rpb25UeXBlOiBcImZpbGVTaGFyZVwiXG4gICAgICAgIH1cbiAgICB9O1xufVxuZnVuY3Rpb24gY3JlYXRlSGRmc1Byb3ZpZGVyRGF0YU9iamVjdChpdGVtLCB0aXRsZSkge1xuICAgIHJldHVybiB7XG4gICAgICAgIHR5cGU6IFwiYmlnRGF0YUZpbGVTaGFyZVwiLFxuICAgICAgICBwYXRoOiBgL2JpZ0RhdGFGaWxlU2hhcmVzLyR7dGl0bGV9YCxcbiAgICAgICAgaW5mbzoge1xuICAgICAgICAgICAgY29ubmVjdGlvblN0cmluZzogSlNPTi5zdHJpbmdpZnkoeyBwYXRoOiBpdGVtLmJkZnNIZGZzUGF0aCwgdXNlcm5hbWU6IGl0ZW0uYmRmc0hkZnNVc2VybmFtZSB9KSxcbiAgICAgICAgICAgIGNvbm5lY3Rpb25UeXBlOiBcImhkZnNcIlxuICAgICAgICB9XG4gICAgfTtcbn1cbmZ1bmN0aW9uIGNyZWF0ZUhpdmVQcm92aWRlckRhdGFPYmplY3QoaXRlbSwgdGl0bGUpIHtcbiAgICBjb25zdCBkYXRhc3RvcmVQYXlsb2FkID0ge1xuICAgICAgICB0eXBlOiBcImJpZ0RhdGFGaWxlU2hhcmVcIixcbiAgICAgICAgcGF0aDogXCIvYmlnRGF0YUZpbGVTaGFyZXMvXCIgKyB0aXRsZSxcbiAgICAgICAgaW5mbzoge1xuICAgICAgICAgICAgY29ubmVjdGlvblN0cmluZzogXCJcIixcbiAgICAgICAgICAgIGNvbm5lY3Rpb25UeXBlOiBcImhpdmVcIlxuICAgICAgICB9XG4gICAgfTtcbiAgICBjb25zdCB1c2VOb25EZWZhdWx0RGF0YWJhc2UgPSBpdGVtLnVzZU5vbkRlZmF1bHREYXRhYmFzZTtcbiAgICBkYXRhc3RvcmVQYXlsb2FkLmluZm8uY29ubmVjdGlvblN0cmluZyA9IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgbWV0YVN0b3JlVXJpczogaXRlbS5tZXRhc3RvcmVVcmlzLFxuICAgICAgICBkYXRhYmFzZTogdXNlTm9uRGVmYXVsdERhdGFiYXNlID8gaXRlbS5ub25EZWZhdWx0RGF0YWJhc2VOYW1lIHx8IFwiZGVmYXVsdFwiIDogXCJkZWZhdWx0XCJcbiAgICB9KTtcbiAgICByZXR1cm4gZGF0YXN0b3JlUGF5bG9hZDtcbn1cbmZ1bmN0aW9uIGdldEJkZnNQYXJhbWV0ZXJJdGVtKHRpdGxlLCBwYXRoKSB7XG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgaW5mbzoge1xuICAgICAgICAgICAgY29ubmVjdGlvblN0cmluZzogSlNPTi5zdHJpbmdpZnkoeyBwYXRoOiBwYXRoIH0pLFxuICAgICAgICAgICAgY29ubmVjdGlvblR5cGU6IFwiZGF0YVN0b3JlXCJcbiAgICAgICAgfSxcbiAgICAgICAgcGF0aDogYC9iaWdEYXRhRmlsZVNoYXJlcy8ke3RpdGxlfWAsXG4gICAgICAgIHR5cGU6IFwiYmlnRGF0YUZpbGVTaGFyZVwiXG4gICAgfSk7XG59XG5mdW5jdGlvbiBnZXRSZWdpb25FbmRwb2ludFVSTChyZWdpb25PcHRpb25zLCByZWdpb25WYWx1ZSkge1xuICAgIGxldCByZXN1bHRSZWdpb25VUkw7XG4gICAgcmVnaW9uT3B0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uIChyZWdpb25JdGVtKSB7XG4gICAgICAgIGlmIChyZWdpb25JdGVtLmlkID09PSByZWdpb25WYWx1ZS5pZCkge1xuICAgICAgICAgICAgcmVzdWx0UmVnaW9uVVJMID0gcmVnaW9uSXRlbS5ibG9iU3RvcmVFbmRwb2ludCB8fCByZWdpb25JdGVtLnN0b3JhZ2VFbmRwb2ludFN1ZmZpeDtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiByZXN1bHRSZWdpb25VUkw7XG59XG5jb25zdCBnZXRDb25uZWN0aW9uU3RyaW5nID0gYXN5bmMgKGpvYlJlc3VsdHMsIHB1Ymxpc2hpbmdUb29sc1VybCkgPT4ge1xuICAgIGNvbnN0IHBhcmFtVXJsID0gam9iUmVzdWx0cy5yZXN1bHRzLm91dF9jb25uZWN0aW9uU3RyaW5nLnBhcmFtVXJsO1xuICAgIGNvbnN0IGpvYklkID0gam9iUmVzdWx0cy5qb2JJZDtcbiAgICBjb25zdCB1cmwgPSBgJHtwdWJsaXNoaW5nVG9vbHNVcmx9L0dldCUyMERhdGFiYXNlJTIwQ29ubmVjdGlvbiUyMFN0cmluZy9qb2JzLyR7am9iSWR9LyR7cGFyYW1Vcmx9YDtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QodXJsKTtcbiAgICByZXR1cm4gcHJvY2Vzc0Nvbm5lY3Rpb25TdHJpbmcocmVzcG9uc2UpO1xufTtcbmNvbnN0IHByb2Nlc3NDb25uZWN0aW9uU3RyaW5nID0gKHJlc3VsdCkgPT4ge1xuICAgIGNvbnN0IHN0cmluZyA9IHJlc3VsdC52YWx1ZTtcbiAgICBjb25zdCBjb25uZWN0aW9uU3RyaW5nUHJvcHMgPSBwYXJzZUNvbm5lY3Rpb25TdHJpbmcoc3RyaW5nKTtcbiAgICByZXR1cm4geyBjb25uZWN0aW9uU3RyaW5nUHJvcHM6IGNvbm5lY3Rpb25TdHJpbmdQcm9wcywgY29ubmVjdGlvblN0cmluZzogc3RyaW5nIH07XG59O1xuY29uc3QgcGFyc2VDb25uZWN0aW9uU3RyaW5nID0gKGNvbm5lY3Rpb25TdHJpbmcpID0+IHtcbiAgICBsZXQgY29ubmVjdGlvblN0cmluZ0FycmF5ID0gW107XG4gICAgaWYgKGNvbm5lY3Rpb25TdHJpbmcpIHtcbiAgICAgICAgY29ubmVjdGlvblN0cmluZy5zcGxpdChcIjtcIikuZm9yRWFjaCgocHJvcFN0cmluZykgPT4ge1xuICAgICAgICAgICAgY29uc3QgcGFpciA9IHByb3BTdHJpbmcuc3BsaXQoXCI9XCIpO1xuICAgICAgICAgICAgaWYgKHBhaXIubGVuZ3RoID09PSAyICYmICFkb2VzS2V5RXhpc3QoY29ubmVjdGlvblN0cmluZ0FycmF5LCBwYWlyWzBdKSkge1xuICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25TdHJpbmdBcnJheS5wdXNoKHsga2V5OiBwYWlyWzBdLCB2YWx1ZTogcGFpclsxXSB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBjb25uZWN0aW9uU3RyaW5nQXJyYXk7XG59O1xuY29uc3QgZG9lc0tleUV4aXN0ID0gKGNvbm5lY3Rpb25TdHJpbmdBcnJheSwga2V5KSA9PiB7XG4gICAgcmV0dXJuIGNvbm5lY3Rpb25TdHJpbmdBcnJheS5zb21lKChwcm9wKSA9PiB7XG4gICAgICAgIHJldHVybiBwcm9wLmtleSA9PT0ga2V5O1xuICAgIH0pO1xufTtcbmNvbnN0IGlzQXJjR0lTRW50ZXJwcmlzZU9uS3ViZXJuZXRlcyA9ICgpID0+IHtcbiAgICB2YXIgX2E7XG4gICAgY29uc3QgcG9ydGFsID0gY29uZmlnU3RhdGUucG9ydGFsO1xuICAgIGNvbnN0IGRlcGxveW1lbnRUeXBlID0gcG9ydGFsLnBvcnRhbERlcGxveW1lbnRUeXBlIHx8ICgoX2EgPSBwb3J0YWwuc291cmNlSlNPTikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnBvcnRhbERlcGxveW1lbnRUeXBlKTtcbiAgICByZXR1cm4gcG9ydGFsLmlzUG9ydGFsICYmIGRlcGxveW1lbnRUeXBlID09PSBcIkFyY0dJU0VudGVycHJpc2VPbkt1YmVybmV0ZXNcIjtcbn07XG5jb25zdCBnZXRQdWJsaXNoaW5nVG9vbHNVcmwgPSAoaG9zdGluZ1NlcnZlclVybCkgPT4ge1xuICAgIGlmICghaG9zdGluZ1NlcnZlclVybCkge1xuICAgICAgICByZXR1cm4gXCJcIjtcbiAgICB9XG4gICAgY29uc3QgcHVibGlzaGluZ1Rvb2xzRW5kcG9pbnQgPSBcIlB1Ymxpc2hpbmdUb29sc1wiO1xuICAgIHJldHVybiBgJHtob3N0aW5nU2VydmVyVXJsfS9yZXN0L3NlcnZpY2VzL1N5c3RlbS8ke3B1Ymxpc2hpbmdUb29sc0VuZHBvaW50fS9HUFNlcnZlcmA7XG59O1xuXG5leHBvcnQgeyBjcmVhdGVIZGZzUHJvdmlkZXJEYXRhT2JqZWN0IGFzIGEsIGNyZWF0ZUhpdmVQcm92aWRlckRhdGFPYmplY3QgYXMgYiwgY3JlYXRlRmlsZVNoYXJlUHJvdmlkZXJEYXRhT2JqZWN0IGFzIGMsIGNyZWF0ZUNsb3VkUHJvdmlkZXJEYXRhT2JqZWN0IGFzIGQsIGNyZWF0ZUZvbGRlckRhdGFPYmplY3QgYXMgZSwgY3JlYXRlRGF0YWJhc2VEYXRhT2JqZWN0IGFzIGYsIGdldENvbm5lY3Rpb25TdHJpbmcgYXMgZywgY3JlYXRlTm9TcWxEYXRhT2JqZWN0IGFzIGgsIGlzQXJjR0lTRW50ZXJwcmlzZU9uS3ViZXJuZXRlcyBhcyBpLCBnZXRCZGZzUGFyYW1ldGVySXRlbSBhcyBqLCBnZXRQdWJsaXNoaW5nVG9vbHNVcmwgYXMgaywgY3JlYXRlQmlnUXVlcnlEYXRhT2JqZWN0IGFzIGwsIGNyZWF0ZVNub3dmbGFrZURhdGFPYmplY3QgYXMgbSB9O1xuXG4vLyMgc291cmNlTWFwcGluZ1VSTD1kYXRhLXN0b3JlLThlODNmYjdhLmpzLm1hcCJdLCJuYW1lcyI6W10sInNvdXJjZVJvb3QiOiIifQ==