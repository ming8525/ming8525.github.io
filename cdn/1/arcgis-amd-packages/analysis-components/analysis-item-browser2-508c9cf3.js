define(["exports","./index-ef555910","./index2-588b02d9","./utils-793221d4"],(function(exports,index,index2,utils){"use strict";const HTMLClasses={modalVariables:"modal-variables",modalAlert:"modal-alert"};const analysisItemBrowserCss=":root{--analysis-quarter-spacing:0.25rem;--analysis-half-spacing:0.5rem;--analysis-three-quarter-spacing:0.75rem;--analysis-full-spacing:1rem;--analysis-component-default-width:100%;--analysis-ui-border-input:#d4d4d4;--analysis-label-font-size:var(--calcite-font-size--2);--analysis-popover-content-min-height-s:7.5rem;--analysis-popover-content-min-height-m:8.75rem;--analysis-popover-content-max-height:60vh;--analysis-popover-content-height:45vh}.modal-content{height:100%}.modal-variables{--calcite-modal-height:min(900px, calc(80vh + 100px));--calcite-modal-width:1080px;--calcite-modal-content-padding:0px}.modal-alert{pointer-events:none;position:absolute;left:0px;bottom:0px;width:100%;display:block;z-index:50;transform:translate(0px, -0.5rem);height:calc(100% - 4rem)}";const MAX_ITEMS_PER_PAGE=20;const AnalysisItemBrowser=index.proxyCustomElement(class AnalysisItemBrowser extends index.H{constructor(){super();this.__registerHost();this.analysisItemBrowserSelection=index.createEvent(this,"analysisItemBrowserSelection",7);this.analysisItemBrowserAddToMap=index.createEvent(this,"analysisItemBrowserAddToMap",7);this.analysisItemBrowserClose=index.createEvent(this,"analysisItemBrowserClose",7);this.webToolTaskMap={};this.buildDropdownItem=taskName=>index.h("calcite-dropdown-item",{key:taskName,onClick:()=>{const taskDetails={...this.currentPreviewItem,...{toolName:taskName}};this.selectedItems=[this.currentPreviewItem];this.analysisItemBrowserSelection.emit(taskDetails);this.close()}},taskName);this.getAllowedItemTypes=()=>{const baseAllowedTypes=["layers","layers-weblayers-features","layers-weblayers-imagery","layers-weblayers-mapimage","layers-weblayers-tiledimagelayers","layers-weblayers-tables"];return baseAllowedTypes};this.formatSublayerUrl=selectedItem=>{const baseUrl=`${"item"in selectedItem?selectedItem.item.url:selectedItem.url}`;const sublayerIndex=`${"sublayer"in selectedItem?selectedItem.sublayer?.id??0:""}`;return`${baseUrl}/${sublayerIndex}`};this.formatErrorMessage=()=>{let message="";if(this.layerLoadingFailed===true){message=this.errorStrings.layerLoadFailure}else{message=index2.formatMessage(this.strings.unsupportedLayer,{layerName:this.invalidBrowsedLayers.join(", ")})}return message};this.getItemDetailsUrl=item=>{let url="";if(!index2.isEmptyDataItem(item)){const{id}=item;url=`${utils.getBaseUrl(this.portal)}/home/item.html?id=${id}`}return url};this.close=()=>{if(this.containerRef!==undefined){this.containerRef.open=false}};this.onSelectButtonClick=async(e,addToMap)=>{const analysisItemBrowserEvent=addToMap===true?this.analysisItemBrowserAddToMap:this.analysisItemBrowserSelection;switch(this.selectionMode){case"single":analysisItemBrowserEvent.emit(this.selectedItems[0]);this.close();break;case"multiple":analysisItemBrowserEvent.emit(this.selectedItems);this.close();break;case"single-sublayer":case"multiple-sublayer":const buttonElement=e.target;buttonElement.loading=true;this.browsedLayerCreating=true;let browsedLayers=[];try{const browsedItems=this.selectedItems.map((item=>index2.getLayerObject({url:this.formatSublayerUrl(item)})));browsedLayers=(await Promise.all(browsedItems)).filter((layer=>layer!==undefined));this.invalidBrowsedLayers=await this.filterUnsupportedLayers(browsedLayers);this.layerLoadingFailed=false}catch{this.layerLoadingFailed=true}this.browsedLayerCreating=false;buttonElement.loading=false;if(this.invalidBrowsedLayers.length===0&&this.layerLoadingFailed===false){analysisItemBrowserEvent.emit(browsedLayers);this.close()}break;default:analysisItemBrowserEvent.emit(this.selectedItems);this.close();break}};this.onClose=()=>{this.analysisItemBrowserClose.emit()};this.onItemBrowserUpdate=event=>{this.items=event.detail.results;this.totalItems=event.detail.total};this.onItemBrowserSelect=event=>{this.selectedItems=event.detail};this.onItemBrowserLoading=()=>{this.items=[];this.totalItems=undefined};this.onItemBrowserPreview=async event=>{const previewItem=event.detail;if(this.showWebToolSelect===true){this.tasksLoading=true;const tasks=await this.fetchTasks(previewItem);this.webToolTaskMap[previewItem.id]=tasks}this.currentPreviewItem=previewItem;if(this.tasksLoading===true){this.tasksLoading=false}};this.fetchTasks=async item=>{const gpServerRes=await index2.request(`${item.url}?f=json`,{responseType:"json",authMode:"no-prompt"});return gpServerRes.data.tasks};this.items=[];this.selectedItems=[];this.totalItems=undefined;this.browsedLayerCreating=false;this.invalidBrowsedLayers=[];this.currentPreviewItem=undefined;this.layerLoadingFailed=false;this.tasksLoading=false;this.allowedGeometries=undefined;this.layerFilterType=undefined;this.displayMode="modal";this.filter="";this.bucketOptions=undefined;this.hidePreview=false;this.hideFilters=false;this.hideAddToMap=false;this.header=undefined;this.user=undefined;this.portal=undefined;this.selectionMode=undefined;this.showWebToolSelect=false;this.q=""}async componentWillLoad(){let locale="";({strings:this.strings,locale}=await index2.fetchComponentLocaleStrings(this.hostElement,index.getAssetPath(`.`)));this.errorStrings=await index2.fetchErrorsStrings(locale)}render(){return this.renderModal()}renderModal(){return index.h("calcite-modal",{class:HTMLClasses.modalVariables,scale:"s",open:true,escapeDisabled:true,outsideCloseDisabled:true,focusTrapDisabled:true,onCalciteModalClose:this.onClose,ref:el=>this.containerRef=el},index.h("div",{slot:"header"},this.header??this.strings.header),index.h("div",{slot:"content",class:"modal-content"},this.renderItemBrowser(),(this.invalidBrowsedLayers.length!==0||this.layerLoadingFailed===true)&&index.h("div",{class:HTMLClasses.modalAlert},index.h("calcite-alert",{open:true,kind:"danger",label:this.formatErrorMessage(),onCalciteAlertClose:()=>{this.invalidBrowsedLayers=[];this.layerLoadingFailed=false}},index.h("div",{slot:"title"},this.formatErrorMessage())))),index.h("calcite-button",{slot:"back",width:"full",appearance:"solid",kind:"neutral",onClick:this.close},this.strings.cancel),this.hideAddToMap===false&&index.h("calcite-button",{slot:"primary",width:"full",appearance:"solid",disabled:this.browsedLayerCreating===true||this.selectedItems?.length===0,onClick:e=>this.onSelectButtonClick(e,true)},this.strings.addToMap),index.h("calcite-button",{slot:this.hideAddToMap?"primary":"secondary",appearance:this.hideAddToMap?"solid":"outline",width:"full",disabled:this.browsedLayerCreating===true||this.selectedItems?.length===0,onClick:e=>this.onSelectButtonClick(e,false)},this.strings.confirm))}renderItemBrowser(){const isSublayerMode=this.selectionMode==="single-sublayer"||this.selectionMode==="multiple-sublayer";const previewMode=isSublayerMode||this.selectionMode==="none"?"top":"action";return index.h("arcgis-item-browser",{api:4,allowedGeometries:this.allowedGeometries,q:this.q,filter:this.filter,num:MAX_ITEMS_PER_PAGE,config:{baseUrl:utils.getBaseUrl(this.portal)},portal:this.portal,user:this.user,selection:this.selectionMode??"single",onArcgisItemBrowserLoading:this.onItemBrowserLoading,onArcgisItemBrowserUpdate:this.onItemBrowserUpdate,onArcgisItemBrowserSelect:this.onItemBrowserSelect,onArcgisItemBrowserPreview:this.onItemBrowserPreview},index.h("arcgis-item-browser-top-bar",{slot:"top-bar","filter-toggle":true},index.h("arcgis-item-browser-bucket-select",{slot:"bucket",options:this.bucketOptions}),index.h("arcgis-item-browser-search",{slot:"search",term:""})),index.h("arcgis-item-browser-sort",{slot:"sort",field:"modified"}),this.hideFilters===false&&index.h("arcgis-item-browser-filters",{slot:"filters"},index.h("arcgis-item-browser-filter-folder",null),index.h("arcgis-item-browser-filter-categories",null),index.h("arcgis-item-browser-filter-date",{property:"modified"}),index.h("arcgis-item-browser-filter-date",{property:"created"}),index.h("arcgis-item-browser-filter-item-type",{allowedItemTypes:this.getAllowedItemTypes()}),index.h("arcgis-item-browser-filter-tags",null),index.h("arcgis-item-browser-filter-sharing",null),index.h("arcgis-item-browser-filter-content-status",null),index.h("arcgis-item-browser-filter-collaborations",null)),index.h("arcgis-item-browser-content",{slot:"content"},this.items.map((item=>index.h("arcgis-item-browser-card",{key:item.id,item,portal:this.portal,user:this.user,name:"item-browser",preview:this.hidePreview?undefined:previewMode,showThumbnail:false})))),index.h("div",{slot:"preview-footer"},this.showWebToolSelect===true&&index.h("calcite-dropdown",{placement:"top",style:{width:"100%"}},index.h("calcite-button",{loading:this.tasksLoading,slot:"trigger",appearance:"solid",kind:"neutral",iconEnd:"chevron-down",width:"full"},this.strings.selectTask),index.h("calcite-dropdown-group",null,this.currentPreviewItem?.id!==undefined?this.webToolTaskMap[this.currentPreviewItem.id].map(this.buildDropdownItem):null)),index.h("calcite-button",{href:this.getItemDetailsUrl(this.currentPreviewItem),target:"_blank",appearance:"outline-fill",kind:"neutral",width:"full"},this.strings.viewDetails)),index.h("arcgis-item-browser-pagination",{slot:"pagination",start:1,num:MAX_ITEMS_PER_PAGE,total:this.totalItems}))}async filterUnsupportedLayers(layers){const{filteredLayers}=await utils.filterLayersByType({layers,layerFilterTypes:this.layerFilterType,user:this.user});const allowAnalysisFilteredLayers=layers.filter((layer=>!index2.checkLayerAllowAnalysis(layer)));return[...filteredLayers,...allowAnalysisFilteredLayers].map((layer=>layer.title))}static get assetsDirs(){return["t9n"]}get hostElement(){return this}static get style(){return analysisItemBrowserCss}},[0,"analysis-item-browser",{allowedGeometries:[16],layerFilterType:[1,"layer-filter-type"],displayMode:[513,"display-mode"],filter:[513],bucketOptions:[16],hidePreview:[4,"hide-preview"],hideFilters:[4,"hide-filters"],hideAddToMap:[4,"hide-add-to-map"],header:[513],user:[16],portal:[16],selectionMode:[1,"selection-mode"],showWebToolSelect:[4,"show-web-tool-select"],q:[513],items:[32],selectedItems:[32],totalItems:[32],browsedLayerCreating:[32],invalidBrowsedLayers:[32],currentPreviewItem:[32],layerLoadingFailed:[32],tasksLoading:[32]}]);function defineCustomElement(){if(typeof customElements==="undefined"){return}const components=["analysis-item-browser"];components.forEach((tagName=>{switch(tagName){case"analysis-item-browser":if(!customElements.get(tagName)){customElements.define(tagName,AnalysisItemBrowser)}break}}))}defineCustomElement();exports.AnalysisItemBrowser=AnalysisItemBrowser;exports.defineCustomElement=defineCustomElement}));
