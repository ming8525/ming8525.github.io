define(["exports","./index2-588b02d9"],(function(exports,index2){"use strict";const LayerFilterType={Feature_All:"feature",Feature_Extract:"extract",Feature_Point:"feature_point",Feature_MultiPoint:"feature_multiPoint",Feature_Line:"feature_line",Feature_Polygon:"feature_polygon",Feature_Table:"table",Imagery_All:"imagery",Imagery_SingleBand:"imagery_singleBand",Imagery_MultiBand:"imagery_multiBand",Imagery_Integer:"imagery_integer",Imagery_Float:"imagery_float",Imagery_Multidimension:"imagery_multidimension",Imagery_Trend:"imagery_trend",Tile:"tile",Imagery_Change:"imagery_change"};const StatisticType={Any:"any",Count:"count",First:"first",Last:"last",Maximum:"max",Mean:"mean",Minimum:"min",Range:"range",StdDev:"stddev",Sum:"sum",Variance:"variance"};const UIDefaults={DebounceTimer:400,HelpDebounceTimer:1500,PopoverTimer:60,Scale:"s",MediumScale:"m"};const LayerInputActions={Select:"select",Filter:"filter",Reset:"reset",Remove:"remove"};const NumberValidationMessages={InvalidInteger:"invalidIntegerMessage",InvalidDouble:"invalidDoubleMessage",RequiredInput:"requiredInputMessage",BelowMin:"belowMinimumMessage",AboveMax:"aboveMaximumMessage",StrictlyMin:"strictlyMinimumMessage",StrictlyMax:"strictlyMaximumMessage"};function removeOpenableDomElement(element){if(element!==undefined){element.open=false;element.remove()}}function addOpenableDomElement(document,element){if(document.body.contains(element)===false){document.body.appendChild(element);element.open=true}}async function getKeyProperties(url,property){let hasProperty=false;try{const properties=await index2.request(`${url}/keyProperties?f=json`,{responseType:"json"});hasProperty=properties.data!==undefined&&properties.data[property]!==undefined&&properties.data[property].DimensionName!==undefined}catch(e){await index2.throwError(index2.ErrorKeywords.KeyPropertiesError)}return hasProperty}async function getFilterByType(params){const{layer,layerFilterType,user}=params;let isType=false;switch(layerFilterType){case LayerFilterType.Imagery_All:isType=index2.isImageryLayer(layer)||index2.isImageryTileLayer(layer);break;case LayerFilterType.Imagery_SingleBand:isType=index2.isImageryLayer(layer)?layer.serviceRasterInfo.bandCount===1:index2.isImageryTileLayer(layer)?layer.rasterInfo.bandCount===1:false;break;case LayerFilterType.Imagery_MultiBand:isType=index2.isImageryLayer(layer)?layer.serviceRasterInfo.bandCount>1:index2.isImageryTileLayer(layer)?layer.rasterInfo.bandCount>1:false;break;case LayerFilterType.Imagery_Integer:const pixelTypeInt=index2.isImageryLayer(layer)?layer.pixelType:index2.isImageryTileLayer(layer)?layer.rasterInfo.pixelType:"";isType=pixelTypeInt.startsWith("u")||pixelTypeInt.startsWith("s");break;case LayerFilterType.Imagery_Float:const pixelType=index2.isImageryLayer(layer)?layer.pixelType:index2.isImageryTileLayer(layer)?layer.rasterInfo.pixelType:"";isType=pixelType.startsWith("f");break;case LayerFilterType.Imagery_Multidimension:isType=index2.isImageryLayer(layer)&&layer.hasMultidimensions||index2.isImageryTileLayer(layer)&&layer.multidimensionalDefinition?.length>0;break;case LayerFilterType.Imagery_Trend:if(index2.isImageryLayer(layer)||index2.isImageryTileLayer(layer)){isType=await getKeyProperties(layer.url,"TrendParameters")}break;case LayerFilterType.Imagery_Change:if(index2.isImageryLayer(layer)||index2.isImageryTileLayer(layer)){isType=await getKeyProperties(layer.url,"ChangeAnalysisParameters")}break;case LayerFilterType.Tile:isType=index2.isTileLayer(layer);break;case LayerFilterType.Feature_All:isType=index2.isFeatureLayer(layer)&&!index2.isTableLayer(layer);break;case LayerFilterType.Feature_Point:isType=index2.isFeatureLayer(layer)&&!index2.isTableLayer(layer)&&layer.geometryType==="point";break;case LayerFilterType.Feature_MultiPoint:isType=index2.isFeatureLayer(layer)&&!index2.isTableLayer(layer)&&layer.geometryType==="multipoint";break;case LayerFilterType.Feature_Line:isType=index2.isFeatureLayer(layer)&&!index2.isTableLayer(layer)&&layer.geometryType==="polyline";break;case LayerFilterType.Feature_Polygon:isType=index2.isFeatureLayer(layer)&&!index2.isTableLayer(layer)&&layer.geometryType==="polygon";break;case LayerFilterType.Feature_Table:isType=index2.isTableLayer(layer);break;case LayerFilterType.Feature_Extract:isType=await index2.canExtractLayer(layer,user)}return isType}async function filterLayersByType(params){const{layers,layerFilterTypes,user}=params;let validLayers=layers;let filteredLayers=[];if(layerFilterTypes!==undefined){let promises;if(Array.isArray(layerFilterTypes)){promises=layers.map((layer=>{const filterSome=async()=>{for(const layerFilterType of layerFilterTypes){if(await getFilterByType({layer,layerFilterType,user}))return true}return false};return filterSome()}))}else{promises=layers.map((layer=>getFilterByType({layer,layerFilterType:layerFilterTypes,user})))}const results=await Promise.all(promises);validLayers=layers.filter(((_v,index)=>results[index]));filteredLayers=layers.filter(((_v,index)=>!results[index]))}return{validLayers,filteredLayers}}const validateNumber=(value,options)=>{const{required,isFloatType,excludeMinValue,excludeMaxValue,min,max}=options;let errorMessage;if(!index2.isValidNumber(value)){if(typeof value!=="undefined"){errorMessage=isFloatType===true?NumberValidationMessages.InvalidDouble:NumberValidationMessages.InvalidInteger}else if(required===true){errorMessage=NumberValidationMessages.RequiredInput}}else if(isFloatType===false&&!Number.isInteger(value)){errorMessage=NumberValidationMessages.InvalidInteger}else if(typeof min!=="undefined"&&typeof value!=="undefined"&&(value<min||excludeMinValue===true&&value<=min)){errorMessage=excludeMinValue===true?NumberValidationMessages.StrictlyMin:NumberValidationMessages.BelowMin}else if(typeof max!=="undefined"&&typeof value!=="undefined"&&(value>max||excludeMaxValue===true&&value>=max)){errorMessage=excludeMaxValue===true?NumberValidationMessages.StrictlyMax:NumberValidationMessages.AboveMax}return errorMessage};function makePortalSearchFilter(itemTypes,baseFilter){const clauses=itemTypes.map((type=>`type:"${type}"`)).join(" OR ");return baseFilter!==undefined?`${baseFilter} (${clauses})`:`(${clauses})`}function makePortalSearchFilterByType(layerFilterType){const layerFilterTypes=Array.isArray(layerFilterType)?layerFilterType:[layerFilterType];const itemTypes=new Set;layerFilterTypes.forEach((filterType=>{switch(filterType){case LayerFilterType.Feature_Extract:case LayerFilterType.Feature_All:case LayerFilterType.Feature_Point:case LayerFilterType.Feature_MultiPoint:case LayerFilterType.Feature_Line:case LayerFilterType.Feature_Polygon:case LayerFilterType.Feature_Table:itemTypes.add("Feature Service");itemTypes.add("Map Service");break;case LayerFilterType.Imagery_All:case LayerFilterType.Imagery_SingleBand:case LayerFilterType.Imagery_MultiBand:case LayerFilterType.Imagery_Integer:case LayerFilterType.Imagery_Float:case LayerFilterType.Imagery_Multidimension:case LayerFilterType.Imagery_Trend:case LayerFilterType.Imagery_Change:itemTypes.add("Image Service");break;default:itemTypes.add("Feature Service");itemTypes.add("Image Service");itemTypes.add("Map Service");break}}));return makePortalSearchFilter(Array.from(itemTypes))}function makeAllowedGeometriesByType(layerFilterType){const layerFilterTypes=Array.isArray(layerFilterType)?layerFilterType:[layerFilterType];const geometries=new Set;layerFilterTypes.forEach((filterType=>{switch(filterType){case LayerFilterType.Feature_All:geometries.add("point");geometries.add("multipoint");geometries.add("polyline");geometries.add("polygon");break;case LayerFilterType.Feature_Point:geometries.add("point");break;case LayerFilterType.Feature_MultiPoint:geometries.add("multipoint");break;case LayerFilterType.Feature_Line:geometries.add("polyline");break;case LayerFilterType.Feature_Polygon:geometries.add("polygon");break;case LayerFilterType.Feature_Table:geometries.add("nonspatial");break;case LayerFilterType.Feature_Extract:geometries.add("point");geometries.add("multipoint");geometries.add("polyline");geometries.add("polygon");geometries.add("nonspatial");break}}));return geometries.size===0?undefined:Array.from(geometries)}function makePortalSearchQByType(layerFilterType,orgId){const layerFilterTypes=Array.isArray(layerFilterType)?layerFilterType:[layerFilterType];const allowAnalysis=orgId===undefined?`(-typekeywords: "Hosted Service" AND type: "Image Service") OR (servicetags: "allowAnalysis"`:`(-typekeywords: "Hosted Service" AND type: "Image Service") OR ((servicetags: "allowAnalysis" OR orgid: ${orgId}) AND type: "Image Service"`;let q="";const filters=[];layerFilterTypes.forEach((filterType=>{switch(filterType){case LayerFilterType.Imagery_SingleBand:filters.push(`(bandcount: 1)`);break;case LayerFilterType.Imagery_MultiBand:filters.push(`(bandcount: [2 TO 65536])`);break;case LayerFilterType.Imagery_Integer:filters.push(`(NOT (servicetags: "PixelTypeF32" OR servicetags: "PixelTypeF64"))`);break;case LayerFilterType.Imagery_Float:filters.push(`(servicetags: "PixelTypeF32" OR servicetags: "PixelTypeF64")`);break;case LayerFilterType.Imagery_Multidimension:filters.push(`(servicetags: "hasMultidimensions")`);break;case LayerFilterType.Imagery_All:case LayerFilterType.Imagery_Trend:case LayerFilterType.Imagery_Change:filters.push("i");break;case LayerFilterType.Feature_All:case LayerFilterType.Feature_Point:case LayerFilterType.Feature_MultiPoint:case LayerFilterType.Feature_Line:case LayerFilterType.Feature_Polygon:case LayerFilterType.Feature_Table:case LayerFilterType.Feature_Extract:filters.push("f");break}}));if(filters.length>0&&!filters.every((f=>f==="f"))){const newFilters=filters.filter((f=>f.length>1));if(newFilters.length>0){const filterString=newFilters.join(" OR ");q=`${allowAnalysis} AND (${filterString}))`}else{q=`${allowAnalysis})`}q=filters.indexOf("f")>-1?`(${q} OR (type: "Feature Service"))`:`(${q})`}return q}function formatLayerUrlAndId(layer){return`${layer.url}/${layer.layerId}`}function getBaseUrl(portal){const{customBaseUrl,portalHostname,urlKey}=portal;const{protocol}=window.location;const url=urlKey?`${urlKey}.${customBaseUrl}`:portalHostname;return`${protocol}//${url}`}const geometryLayerFilterTypeLookup={esriGeometryPoint:LayerFilterType.Feature_Point,esriGeometryPolyline:LayerFilterType.Feature_Line,esriGeometryPolygon:LayerFilterType.Feature_Polygon,esriGeometryMultipoint:LayerFilterType.Feature_MultiPoint};function getMatchingFieldTypes(type){switch(type){case"esriFieldTypeSingle":return"single";case"esriFieldTypeDouble":return"double";case"esriFieldTypeGeometry":return"geometry";case"esriFieldTypeInteger":return["long","integer","big-integer"];case"esriFieldTypeSmallInteger":return"small-integer";case"esriFieldTypeString":return"string";case"esriFieldTypeDate":return"date";default:return undefined}}function convertParameterFilter(filter){const convertedFilter={};switch(filter?.type){case"range":convertedFilter.min=filter.minimum;convertedFilter.max=filter.maximum;break;case"featureClass":if(filter.list!==undefined){convertedFilter.layerFilterType=filter.list.map((geometry=>geometryLayerFilterTypeLookup[geometry])).filter((layerFilterType=>layerFilterType!==undefined))}break;case"field":if(filter.list!==undefined){convertedFilter.fieldTypes=filter.list.flatMap(getMatchingFieldTypes).filter((type=>type!==undefined))}break;case"file":convertedFilter.accept=filter.list?.filter((fileExtension=>fileExtension!==undefined))}return convertedFilter}function isValidProtocol(url){return new RegExp(/^(http|https|ftp):\/\//i).test(url)}function isValidFileExtension(url,accept){if(accept===undefined||accept.length===0)return true;const fileExtension=url.split(".").pop();return fileExtension!==undefined&&accept.includes(fileExtension)}exports.LayerFilterType=LayerFilterType;exports.LayerInputActions=LayerInputActions;exports.StatisticType=StatisticType;exports.UIDefaults=UIDefaults;exports.addOpenableDomElement=addOpenableDomElement;exports.convertParameterFilter=convertParameterFilter;exports.filterLayersByType=filterLayersByType;exports.formatLayerUrlAndId=formatLayerUrlAndId;exports.getBaseUrl=getBaseUrl;exports.isValidFileExtension=isValidFileExtension;exports.isValidProtocol=isValidProtocol;exports.makeAllowedGeometriesByType=makeAllowedGeometriesByType;exports.makePortalSearchFilter=makePortalSearchFilter;exports.makePortalSearchFilterByType=makePortalSearchFilterByType;exports.makePortalSearchQByType=makePortalSearchQByType;exports.removeOpenableDomElement=removeOpenableDomElement;exports.validateNumber=validateNumber}));
