define(["exports","./index-ef555910","./expressions-18db914f","./index2-588b02d9","./_baseGet-9bd467fe","./_Uint8Array-190b1a5d","./_MapCache-84d65af1","./isObject-072a0200","./identity-47e9f05a","./t9n-24f5c39b","./utils-793221d4","./analysis-attribute-expression2-a90d2a8c","./analysis-query-entry2-a97f8d18","./analysis-spatial-expression2-5e7137a9"],(function(exports,index,expressions,index2,_baseGet,_Uint8Array,_MapCache,isObject,identity,t9n,utils,analysisAttributeExpression2,analysisQueryEntry2,analysisSpatialExpression2){"use strict";var objectCreate=Object.create;var baseCreate=function(){function object(){}return function(proto){if(!isObject.isObject(proto)){return{}}if(objectCreate){return objectCreate(proto)}object.prototype=proto;var result=new object;object.prototype=undefined;return result}}();function apply(func,thisArg,args){switch(args.length){case 0:return func.call(thisArg);case 1:return func.call(thisArg,args[0]);case 2:return func.call(thisArg,args[0],args[1]);case 3:return func.call(thisArg,args[0],args[1],args[2])}return func.apply(thisArg,args)}function copyArray(source,array){var index=-1,length=source.length;array||(array=Array(length));while(++index<length){array[index]=source[index]}return array}var HOT_COUNT=800,HOT_SPAN=16;var nativeNow=Date.now;function shortOut(func){var count=0,lastCalled=0;return function(){var stamp=nativeNow(),remaining=HOT_SPAN-(stamp-lastCalled);lastCalled=stamp;if(remaining>0){if(++count>=HOT_COUNT){return arguments[0]}}else{count=0}return func.apply(undefined,arguments)}}function constant(value){return function(){return value}}var defineProperty=function(){try{var func=_MapCache.getNative(Object,"defineProperty");func({},"",{});return func}catch(e){}}();var baseSetToString=!defineProperty?identity.identity:function(func,string){return defineProperty(func,"toString",{configurable:true,enumerable:false,value:constant(string),writable:true})};var setToString=shortOut(baseSetToString);function arrayEach(array,iteratee){var index=-1,length=array==null?0:array.length;while(++index<length){if(iteratee(array[index],index,array)===false){break}}return array}function baseAssignValue(object,key,value){if(key=="__proto__"&&defineProperty){defineProperty(object,key,{configurable:true,enumerable:true,value,writable:true})}else{object[key]=value}}var objectProto$3=Object.prototype;var hasOwnProperty$3=objectProto$3.hasOwnProperty;function assignValue(object,key,value){var objValue=object[key];if(!(hasOwnProperty$3.call(object,key)&&_MapCache.eq(objValue,value))||value===undefined&&!(key in object)){baseAssignValue(object,key,value)}}function copyObject(source,props,object,customizer){var isNew=!object;object||(object={});var index=-1,length=props.length;while(++index<length){var key=props[index];var newValue=customizer?customizer(object[key],source[key],key,object,source):undefined;if(newValue===undefined){newValue=source[key]}if(isNew){baseAssignValue(object,key,newValue)}else{assignValue(object,key,newValue)}}return object}var nativeMax=Math.max;function overRest(func,start,transform){start=nativeMax(start===undefined?func.length-1:start,0);return function(){var args=arguments,index=-1,length=nativeMax(args.length-start,0),array=Array(length);while(++index<length){array[index]=args[start+index]}index=-1;var otherArgs=Array(start+1);while(++index<start){otherArgs[index]=args[index]}otherArgs[start]=transform(array);return apply(func,this,otherArgs)}}function nativeKeysIn(object){var result=[];if(object!=null){for(var key in Object(object)){result.push(key)}}return result}var objectProto$2=Object.prototype;var hasOwnProperty$2=objectProto$2.hasOwnProperty;function baseKeysIn(object){if(!isObject.isObject(object)){return nativeKeysIn(object)}var isProto=_Uint8Array.isPrototype(object),result=[];for(var key in object){if(!(key=="constructor"&&(isProto||!hasOwnProperty$2.call(object,key)))){result.push(key)}}return result}function keysIn(object){return _Uint8Array.isArrayLike(object)?_Uint8Array.arrayLikeKeys(object,true):baseKeysIn(object)}var spreadableSymbol=isObject.Symbol?isObject.Symbol.isConcatSpreadable:undefined;function isFlattenable(value){return _MapCache.isArray(value)||_Uint8Array.isArguments(value)||!!(spreadableSymbol&&value&&value[spreadableSymbol])}function baseFlatten(array,depth,predicate,isStrict,result){var index=-1,length=array.length;predicate||(predicate=isFlattenable);result||(result=[]);while(++index<length){var value=array[index];if(depth>0&&predicate(value)){if(depth>1){baseFlatten(value,depth-1,predicate,isStrict,result)}else{_Uint8Array.arrayPush(result,value)}}else if(!isStrict){result[result.length]=value}}return result}function flatten(array){var length=array==null?0:array.length;return length?baseFlatten(array,1):[]}function flatRest(func){return setToString(overRest(func,undefined,flatten),func+"")}var getPrototype=_Uint8Array.overArg(Object.getPrototypeOf,Object);var objectTag$1="[object Object]";var funcProto=Function.prototype,objectProto$1=Object.prototype;var funcToString=funcProto.toString;var hasOwnProperty$1=objectProto$1.hasOwnProperty;var objectCtorString=funcToString.call(Object);function isPlainObject(value){if(!isObject.isObjectLike(value)||isObject.baseGetTag(value)!=objectTag$1){return false}var proto=getPrototype(value);if(proto===null){return true}var Ctor=hasOwnProperty$1.call(proto,"constructor")&&proto.constructor;return typeof Ctor=="function"&&Ctor instanceof Ctor&&funcToString.call(Ctor)==objectCtorString}function baseSlice(array,start,end){var index=-1,length=array.length;if(start<0){start=-start>length?0:length+start}end=end>length?length:end;if(end<0){end+=length}length=start>end?0:end-start>>>0;start>>>=0;var result=Array(length);while(++index<length){result[index]=array[index+start]}return result}function baseAssign(object,source){return object&&copyObject(source,_Uint8Array.keys(source),object)}function baseAssignIn(object,source){return object&&copyObject(source,keysIn(source),object)}var freeExports=typeof exports=="object"&&exports&&!exports.nodeType&&exports;var freeModule=freeExports&&typeof module=="object"&&module&&!module.nodeType&&module;var moduleExports=freeModule&&freeModule.exports===freeExports;var Buffer=moduleExports?isObject.root.Buffer:undefined,allocUnsafe=Buffer?Buffer.allocUnsafe:undefined;function cloneBuffer(buffer,isDeep){if(isDeep){return buffer.slice()}var length=buffer.length,result=allocUnsafe?allocUnsafe(length):new buffer.constructor(length);buffer.copy(result);return result}function copySymbols(source,object){return copyObject(source,_Uint8Array.getSymbols(source),object)}var nativeGetSymbols=Object.getOwnPropertySymbols;var getSymbolsIn=!nativeGetSymbols?_Uint8Array.stubArray:function(object){var result=[];while(object){_Uint8Array.arrayPush(result,_Uint8Array.getSymbols(object));object=getPrototype(object)}return result};function copySymbolsIn(source,object){return copyObject(source,getSymbolsIn(source),object)}function getAllKeysIn(object){return _Uint8Array.baseGetAllKeys(object,keysIn,getSymbolsIn)}var objectProto=Object.prototype;var hasOwnProperty=objectProto.hasOwnProperty;function initCloneArray(array){var length=array.length,result=new array.constructor(length);if(length&&typeof array[0]=="string"&&hasOwnProperty.call(array,"index")){result.index=array.index;result.input=array.input}return result}function cloneArrayBuffer(arrayBuffer){var result=new arrayBuffer.constructor(arrayBuffer.byteLength);new _Uint8Array.Uint8Array(result).set(new _Uint8Array.Uint8Array(arrayBuffer));return result}function cloneDataView(dataView,isDeep){var buffer=isDeep?cloneArrayBuffer(dataView.buffer):dataView.buffer;return new dataView.constructor(buffer,dataView.byteOffset,dataView.byteLength)}var reFlags=/\w*$/;function cloneRegExp(regexp){var result=new regexp.constructor(regexp.source,reFlags.exec(regexp));result.lastIndex=regexp.lastIndex;return result}var symbolProto=isObject.Symbol?isObject.Symbol.prototype:undefined,symbolValueOf=symbolProto?symbolProto.valueOf:undefined;function cloneSymbol(symbol){return symbolValueOf?Object(symbolValueOf.call(symbol)):{}}function cloneTypedArray(typedArray,isDeep){var buffer=isDeep?cloneArrayBuffer(typedArray.buffer):typedArray.buffer;return new typedArray.constructor(buffer,typedArray.byteOffset,typedArray.length)}var boolTag$1="[object Boolean]",dateTag$1="[object Date]",mapTag$2="[object Map]",numberTag$1="[object Number]",regexpTag$1="[object RegExp]",setTag$2="[object Set]",stringTag$1="[object String]",symbolTag$1="[object Symbol]";var arrayBufferTag$1="[object ArrayBuffer]",dataViewTag$1="[object DataView]",float32Tag$1="[object Float32Array]",float64Tag$1="[object Float64Array]",int8Tag$1="[object Int8Array]",int16Tag$1="[object Int16Array]",int32Tag$1="[object Int32Array]",uint8Tag$1="[object Uint8Array]",uint8ClampedTag$1="[object Uint8ClampedArray]",uint16Tag$1="[object Uint16Array]",uint32Tag$1="[object Uint32Array]";function initCloneByTag(object,tag,isDeep){var Ctor=object.constructor;switch(tag){case arrayBufferTag$1:return cloneArrayBuffer(object);case boolTag$1:case dateTag$1:return new Ctor(+object);case dataViewTag$1:return cloneDataView(object,isDeep);case float32Tag$1:case float64Tag$1:case int8Tag$1:case int16Tag$1:case int32Tag$1:case uint8Tag$1:case uint8ClampedTag$1:case uint16Tag$1:case uint32Tag$1:return cloneTypedArray(object,isDeep);case mapTag$2:return new Ctor;case numberTag$1:case stringTag$1:return new Ctor(object);case regexpTag$1:return cloneRegExp(object);case setTag$2:return new Ctor;case symbolTag$1:return cloneSymbol(object)}}function initCloneObject(object){return typeof object.constructor=="function"&&!_Uint8Array.isPrototype(object)?baseCreate(getPrototype(object)):{}}var mapTag$1="[object Map]";function baseIsMap(value){return isObject.isObjectLike(value)&&_Uint8Array.getTag$1(value)==mapTag$1}var nodeIsMap=_Uint8Array.nodeUtil&&_Uint8Array.nodeUtil.isMap;var isMap=nodeIsMap?_Uint8Array.baseUnary(nodeIsMap):baseIsMap;var setTag$1="[object Set]";function baseIsSet(value){return isObject.isObjectLike(value)&&_Uint8Array.getTag$1(value)==setTag$1}var nodeIsSet=_Uint8Array.nodeUtil&&_Uint8Array.nodeUtil.isSet;var isSet=nodeIsSet?_Uint8Array.baseUnary(nodeIsSet):baseIsSet;var CLONE_DEEP_FLAG$2=1,CLONE_FLAT_FLAG$1=2,CLONE_SYMBOLS_FLAG$2=4;var argsTag="[object Arguments]",arrayTag="[object Array]",boolTag="[object Boolean]",dateTag="[object Date]",errorTag="[object Error]",funcTag="[object Function]",genTag="[object GeneratorFunction]",mapTag="[object Map]",numberTag="[object Number]",objectTag="[object Object]",regexpTag="[object RegExp]",setTag="[object Set]",stringTag="[object String]",symbolTag="[object Symbol]",weakMapTag="[object WeakMap]";var arrayBufferTag="[object ArrayBuffer]",dataViewTag="[object DataView]",float32Tag="[object Float32Array]",float64Tag="[object Float64Array]",int8Tag="[object Int8Array]",int16Tag="[object Int16Array]",int32Tag="[object Int32Array]",uint8Tag="[object Uint8Array]",uint8ClampedTag="[object Uint8ClampedArray]",uint16Tag="[object Uint16Array]",uint32Tag="[object Uint32Array]";var cloneableTags={};cloneableTags[argsTag]=cloneableTags[arrayTag]=cloneableTags[arrayBufferTag]=cloneableTags[dataViewTag]=cloneableTags[boolTag]=cloneableTags[dateTag]=cloneableTags[float32Tag]=cloneableTags[float64Tag]=cloneableTags[int8Tag]=cloneableTags[int16Tag]=cloneableTags[int32Tag]=cloneableTags[mapTag]=cloneableTags[numberTag]=cloneableTags[objectTag]=cloneableTags[regexpTag]=cloneableTags[setTag]=cloneableTags[stringTag]=cloneableTags[symbolTag]=cloneableTags[uint8Tag]=cloneableTags[uint8ClampedTag]=cloneableTags[uint16Tag]=cloneableTags[uint32Tag]=true;cloneableTags[errorTag]=cloneableTags[funcTag]=cloneableTags[weakMapTag]=false;function baseClone(value,bitmask,customizer,key,object,stack){var result,isDeep=bitmask&CLONE_DEEP_FLAG$2,isFlat=bitmask&CLONE_FLAT_FLAG$1,isFull=bitmask&CLONE_SYMBOLS_FLAG$2;if(customizer){result=object?customizer(value,key,object,stack):customizer(value)}if(result!==undefined){return result}if(!isObject.isObject(value)){return value}var isArr=_MapCache.isArray(value);if(isArr){result=initCloneArray(value);if(!isDeep){return copyArray(value,result)}}else{var tag=_Uint8Array.getTag$1(value),isFunc=tag==funcTag||tag==genTag;if(_Uint8Array.isBuffer(value)){return cloneBuffer(value,isDeep)}if(tag==objectTag||tag==argsTag||isFunc&&!object){result=isFlat||isFunc?{}:initCloneObject(value);if(!isDeep){return isFlat?copySymbolsIn(value,baseAssignIn(result,value)):copySymbols(value,baseAssign(result,value))}}else{if(!cloneableTags[tag]){return object?value:{}}result=initCloneByTag(value,tag,isDeep)}}stack||(stack=new _Uint8Array.Stack);var stacked=stack.get(value);if(stacked){return stacked}stack.set(value,result);if(isSet(value)){value.forEach((function(subValue){result.add(baseClone(subValue,bitmask,customizer,subValue,value,stack))}))}else if(isMap(value)){value.forEach((function(subValue,key){result.set(key,baseClone(subValue,bitmask,customizer,key,value,stack))}))}var keysFunc=isFull?isFlat?getAllKeysIn:_Uint8Array.getAllKeys:isFlat?keysIn:_Uint8Array.keys;var props=isArr?undefined:keysFunc(value);arrayEach(props||value,(function(subValue,key){if(props){key=subValue;subValue=value[key]}assignValue(result,key,baseClone(subValue,bitmask,customizer,key,value,stack))}));return result}var CLONE_DEEP_FLAG$1=1,CLONE_SYMBOLS_FLAG$1=4;function cloneDeep(value){return baseClone(value,CLONE_DEEP_FLAG$1|CLONE_SYMBOLS_FLAG$1)}function last(array){var length=array==null?0:array.length;return length?array[length-1]:undefined}function parent(object,path){return path.length<2?object:_baseGet.baseGet(object,baseSlice(path,0,-1))}function baseUnset(object,path){path=_baseGet.castPath(path,object);object=parent(object,path);return object==null||delete object[_baseGet.toKey(last(path))]}function customOmitClone(value){return isPlainObject(value)?undefined:value}var CLONE_DEEP_FLAG=1,CLONE_FLAT_FLAG=2,CLONE_SYMBOLS_FLAG=4;var omit=flatRest((function(object,paths){var result={};if(object==null){return result}var isDeep=false;paths=_baseGet.arrayMap(paths,(function(path){path=_baseGet.castPath(path,object);isDeep||(isDeep=path.length>1);return path}));copyObject(object,getAllKeysIn(object),result);if(isDeep){result=baseClone(result,CLONE_DEEP_FLAG|CLONE_FLAT_FLAG|CLONE_SYMBOLS_FLAG,customOmitClone)}var length=paths.length;while(length--){baseUnset(result,paths[length])}return result}));const HTMLClasses$1={errorNotice:"error-notice"};const ErrorKeys={ParsingPreviousQuery:"parsingPreviousQueryError",QueryFields:"queryFieldsError"};const convertSpatialExpressionToJson=({expression,operator,layer,layerList})=>{const{spatialRelationship,spatialRelationshipParams}=expression;const selectingLayer=expression.selectingLayer;const layerIndex=layerList.findIndex((obj=>obj.id===layer.id));const selectingLayerIndex=layerList.findIndex((obj=>obj.id===selectingLayer.id));return{operator,layer:layerIndex,selectingLayer:selectingLayerIndex,spatialRel:spatialRelationship,distance:spatialRelationshipParams?.distance,units:spatialRelationshipParams?.units}};const convertAttributeExpressionToJson=({expression,operator,layer,layerList})=>{const layerIndex=layerList.findIndex((obj=>obj.id===layer.id));const json={operator,layer:layerIndex,where:expression.toSQL()};return json};class ExpressionGroup{constructor(layer,operator="",children=[],spatialExpression,id){this.toJSON=(featureLayers,mapView)=>{const usedLayers=this.getUsedLayers(featureLayers);const expressions=this.toGPQuery(usedLayers);const inputLayers=this.serializeLayers(usedLayers,mapView);return{expressions,inputLayers}};this.toGPQuery=(layerList,firstOperator="")=>{const result=[];this.children.forEach(((expressionOrGroup,index)=>{let operator=index===0?firstOperator:this.operator;if(expressionOrGroup instanceof ExpressionGroup){if(expressionOrGroup.spatialExpression?.validate()===true){const json=convertSpatialExpressionToJson({operator,expression:expressionOrGroup.spatialExpression,layer:this.layer,layerList});result.push(json);operator="and"}const newResult=expressionOrGroup.toGPQuery(layerList,operator);if(newResult.length>0){result.push(newResult)}}else{if(expressionOrGroup.validate()){const json=convertAttributeExpressionToJson({operator,expression:expressionOrGroup,layer:this.layer,layerList});result.push(json)}}}));return result};this.layer=layer;this.operator=operator;this.children=children;this.spatialExpression=spatialExpression;this.id=id??expressions.getIncrementalId()}static async fromSQL(whereClause,layer,options){let group;let errorKey;if(whereClause===""){group=new ExpressionGroup(layer)}else{try{const{parseTree}=await index2.parseWhereClause(whereClause,layer.fieldsIndex);const{group:expressionGroup,errorKey:error}=ExpressionGroup.fromSQLNode(parseTree,layer,options);group=expressionGroup;errorKey=error}catch(error){console.log(error);errorKey=ErrorKeys.ParsingPreviousQuery}}return{group,errorKey}}static fromSQLNode(parseTree,layer,options){let operator;const children=[];let errorKey;const stack=[parseTree];while(stack.length>0){try{const node=stack.pop();if(node.type==="binary-expression"&&(node.operator==="AND"||node.operator==="OR")){operator??(operator=node.operator);if(operator===node.operator){stack.push(node.right);stack.push(node.left)}else{const{group:subgroup,errorKey:subErrorKey}=ExpressionGroup.fromSQLNode(node,layer,options);errorKey??(errorKey=subErrorKey);children.push(subgroup)}}else{const expression=expressions.ExpressionController.fromSQLNode(node,layer.fieldsIndex,options);children.push(expression)}}catch(error){console.log(error);errorKey=ErrorKeys.QueryFields}}const lowercaseOperator=operator===undefined?"and":operator.toLowerCase();const group=new ExpressionGroup(layer,lowercaseOperator,children);return{group,errorKey}}toSQL(options){const uppercaseOperator=this.operator.toUpperCase();return this.children.map((child=>{let sql;if(child instanceof ExpressionGroup){const childSQL=child.toSQL(options);if(childSQL!==""){sql=`(${childSQL})`}}else if(child.validate()){sql=child.toSQL(options)}return sql})).filter((sql=>sql!==undefined)).join(` ${uppercaseOperator} `)}static async fromJSON(json,layerList){let group;let errorKey;if(json.length<1){group=new ExpressionGroup(layerList[0])}else{const{group:expressionGroup,errorKey:key}=await ExpressionGroup._fromJSON(json,layerList);group=expressionGroup;errorKey=key}return{group,errorKey}}static async _fromJSON(json,layerList){let groupLayer=undefined;let groupOperator=undefined;let firstOperator="";const children=[];const parsedSpatialChildrenIndices=new Set;let errorKey;for(let i=0;i<json.length;i++){if(parsedSpatialChildrenIndices.has(i)){continue}try{let childOperator;let childLayer;const expressionOrGroup=json[i];if(Array.isArray(expressionOrGroup)){const{group,combineOperator,errorKey:subErrorKey}=await ExpressionGroup._fromJSON(expressionOrGroup,layerList);errorKey??(errorKey=subErrorKey);children.push(group);childLayer=group.layer;childOperator=combineOperator}else if("spatialRel"in expressionOrGroup){const{layer,selectingLayer,units,distance,spatialRel,operator}=expressionOrGroup;const spatialExpression=new expressions.SpatialExpression(layerList[layer],layerList[selectingLayer],spatialRel,{units,distance});const nextChild=json[i+1];if(Array.isArray(nextChild)){const{group,errorKey:subErrorKey}=await ExpressionGroup._fromJSON(nextChild,layerList);errorKey??(errorKey=subErrorKey);if(spatialExpression.selectingLayer===group.layer){group.spatialExpression=spatialExpression;children.push(group);parsedSpatialChildrenIndices.add(i+1)}else{const currentSelectingLayer=spatialExpression.selectingLayer;const emptyGroup=new ExpressionGroup(currentSelectingLayer,operator,[],spatialExpression);children.push(emptyGroup)}}else{const child=new ExpressionGroup(layerList[selectingLayer],operator,[],spatialExpression);children.push(child)}childLayer=layerList[layer];childOperator=operator}else{const{where,layer,operator}=expressionOrGroup;const child=await expressions.ExpressionController.fromSQL(where,layerList[layer].fieldsIndex);children.push(child);childLayer=layerList[layer];childOperator=operator}if(i===0){firstOperator=childOperator}else{groupOperator??(groupOperator=childOperator);expressions.assert(groupOperator===childOperator,"Invalid expression group: the group uses more than one logical operator.")}groupLayer??(groupLayer=childLayer);expressions.assert(groupLayer===childLayer,"Invalid expression group: the group operators on multiple layers.")}catch(error){console.log(error);errorKey=ErrorKeys.ParsingPreviousQuery}}let group;if(groupLayer===undefined){group=new ExpressionGroup(layerList[0],"and",[])}else{group=new ExpressionGroup(groupLayer,groupOperator??"and",children)}return{group,combineOperator:firstOperator,errorKey}}getUsedLayersIds(uniqueLayers){uniqueLayers.add(this.layer.id);if(this.spatialExpression!==undefined){uniqueLayers.add(this.spatialExpression.selectingLayer.id)}this.children.forEach((child=>{if(child instanceof ExpressionGroup){child.getUsedLayersIds(uniqueLayers)}}));return uniqueLayers}getUsedLayers(layers){const layerUrlIds=[...this.getUsedLayersIds(new Set)];const mappedLayers=new Map;layers.forEach((layer=>mappedLayers.set(layer.id,layer)));const filteredLayers=layerUrlIds.map((layerUrlId=>mappedLayers.get(layerUrlId)));return filteredLayers}serializeLayers(layers,mapView){let serializedLayers=[];const gpFeatureRecordSetLayerValues=layers.map((layer=>index2.getGPFeatureRecordSetLayerValue(layer,mapView)));serializedLayers=gpFeatureRecordSetLayerValues.map((value=>omit(value,"itemId")));return serializedLayers}changeTarget(target){return new ExpressionGroup(target,this.operator,[],undefined,this.id)}addDefaultSpatialExpression(layer,selectingLayerOptions){const validSelectLayerOptions=expressions.SpatialExpression.getValidSelectingLayers(layer,selectingLayerOptions);const selectingLayer=validSelectLayerOptions[0]??layer;const newSpatialExpression=new expressions.SpatialExpression(layer,selectingLayer,expressions.SpatialRelationships.Intersects);const newExpressionGroup=new ExpressionGroup(selectingLayer,"and",[],newSpatialExpression);const expressions$1=[...this.children,newExpressionGroup];return new ExpressionGroup(this.layer,this.operator,expressions$1,this.spatialExpression,this.id)}addExpression(expression){const expressions=[...this.children,expression];return new ExpressionGroup(this.layer,this.operator,expressions,this.spatialExpression,this.id)}addDefaultExpression(options){const expression=expressions.ExpressionController.createDefaultForLayer(this.layer,options);return expression===undefined?this:this.addExpression(expression)}addGroup(group){const expressions=[...this.children,group];return new ExpressionGroup(this.layer,this.operator,expressions,this.spatialExpression,this.id)}addNewGroup(operator="and"){const group=new ExpressionGroup(this.layer,operator,[],undefined,this.id);return this.addGroup(group)}removeChild(index){this.children.splice(index,1);return new ExpressionGroup(this.layer,this.operator,this.children,this.spatialExpression,this.id)}changeSpatialExpression(spatialExpression){const{layer,children}=this;let updatedLayer=layer;let updatedChildren=children;const currentSelectingLayer=this.spatialExpression?.selectingLayer;const newSelectingLayer=spatialExpression.selectingLayer;if(currentSelectingLayer!==newSelectingLayer){updatedLayer=newSelectingLayer;updatedChildren=[]}return new ExpressionGroup(updatedLayer,this.operator,updatedChildren,spatialExpression,this.id)}clone(){const clonedChildren=[...this.cloneChildren(this.children)];return new ExpressionGroup(this.layer,this.operator,clonedChildren,this.spatialExpression,this.id)}cloneChildren(children){return children.map((child=>{if(child instanceof ExpressionGroup){const newChildren=this.cloneChildren(child.children);const newExpressionGroup=new ExpressionGroup(child.layer,child.operator,newChildren,child.spatialExpression,child.id);return newExpressionGroup}else{return cloneDeep(child)}}))}}const HTMLClasses={addButtonsContainer:"add-btns-container",errorMessage:"error-message",groupContentContainer:"group-content-container",operatorContainer:"operator-container"};const analysisExpressionGroupCss=":root{--analysis-quarter-spacing:0.25rem;--analysis-half-spacing:0.5rem;--analysis-three-quarter-spacing:0.75rem;--analysis-full-spacing:1rem;--analysis-component-default-width:100%;--analysis-ui-border-input:#d4d4d4;--analysis-label-font-size:var(--calcite-font-size--2);--analysis-popover-content-min-height-s:7.5rem;--analysis-popover-content-min-height-m:8.75rem;--analysis-popover-content-max-height:60vh;--analysis-popover-content-height:45vh}.operator-container{display:flex}.group-content-container{width:calc(100% - 2 * var(--analysis-half-spacing) - 2px);padding:var(--analysis-half-spacing);background-color:var(--calcite-color-background);border:1px solid var(--calcite-color-border-1)}.add-btns-container{display:flex;gap:var(--analysis-quarter-spacing)}.error-message{margin-top:var(--analysis-half-spacing)}";const MAX_DEPTH=2;const AnalysisExpressionGroup=index.proxyCustomElement(class AnalysisExpressionGroup extends index.H{constructor(){super();this.__registerHost();this.analysisExpressionGroupChange=index.createEvent(this,"analysisExpressionGroupChange",7);this.onAddSpatialExpressionClick=()=>{this.expressionGroup=this.expressionGroup.addDefaultSpatialExpression(this.expressionGroup.layer,this.layers);this.error=undefined;this.analysisExpressionGroupChange.emit()};this.onAddAttributeExpressionClick=()=>{this.error=undefined;this.expressionGroup=this.expressionGroup.addDefaultExpression(this.options);this.analysisExpressionGroupChange.emit()};this.onOperatorSelect=event=>{this.expressionGroup.operator=event.target.selectedOption.value;this.error=undefined;this.analysisExpressionGroupChange.emit()};this.onAddGroupClick=()=>{this.expressionGroup=this.expressionGroup.addNewGroup();this.error=undefined;this.analysisExpressionGroupChange.emit()};this.onRemoveChild=(index,event)=>{this.expressionGroup=this.expressionGroup.removeChild(index);this.error=undefined;this.analysisExpressionGroupChange.emit();event.stopPropagation()};this.onChildExpressionChange=(index,event)=>{this.expressionGroup.children[index]=event.target.expression;this.error=undefined;this.analysisExpressionGroupChange.emit()};this.onChildSpatialExpressionChange=event=>{const spatialExpression=event.target.spatialExpression;this.expressionGroup=this.expressionGroup.changeSpatialExpression(spatialExpression);this.analysisExpressionGroupChange.emit()};this.onChildGroupChange=(index,event)=>{this.expressionGroup.children[index]=event.target.expressionGroup;this.analysisExpressionGroupChange.emit();event.stopPropagation()};this.expressionGroup=undefined;this.mode=undefined;this.allowedExpressions=["attribute","group","spatial"];this.layers=undefined;this.recordsTerm="features";this.options=undefined;this.depth=0;this.error=undefined}componentDidRender(){if(this.spatialExpressionButtonTooltipRef!==undefined&&this.spatialExpressionButtonTooltipRef!==null&&this.addSpatialExpressionButtonRef!==undefined){this.spatialExpressionButtonTooltipRef.referenceElement=this.addSpatialExpressionButtonRef}}get hasError(){return this.error!==undefined}componentWillLoad(){this.strings=t9n.getStrings()}render(){const expressionGroup=this.expressionGroup;return index.h(index.Fragment,null,this.depth===0?index.h(index.Fragment,null,this.renderOperatorContainer(),expressionGroup.spatialExpression!==undefined&&this.renderSpatialExpression(),this.renderChildExpressions(),this.renderTopLevelButtons()):expressionGroup.spatialExpression===undefined?index.h(index.Fragment,null,index.h("div",{class:HTMLClasses.groupContentContainer},this.renderOperatorContainer(),this.renderChildExpressions(),this.renderExpressionDropdown())):index.h(index.Fragment,null,this.renderSpatialExpression(),this.depth<=MAX_DEPTH&&index.h("div",{class:HTMLClasses.groupContentContainer},expressionGroup.children.length>0&&this.renderOperatorContainer(),this.renderChildExpressions(),this.renderExpressionDropdown())),index.h("calcite-input-message",{status:"invalid",class:HTMLClasses.errorMessage,scale:utils.UIDefaults.Scale,hidden:!this.hasError,icon:"exclamationMarkTriangle"},this.error))}renderOperatorContainer(){return index.h("div",{class:HTMLClasses.operatorContainer},index.h("calcite-label",null,this.strings.where,index.h("calcite-select",{width:"auto",label:this.strings.groupOperatorSelect,onCalciteSelectChange:this.onOperatorSelect},index.h("calcite-option",{value:expressions.ExpressionGroupOperator.And,selected:this.expressionGroup.operator===expressions.ExpressionGroupOperator.And},this.strings.andOperatorLabel),index.h("calcite-option",{value:expressions.ExpressionGroupOperator.Or,selected:this.expressionGroup.operator===expressions.ExpressionGroupOperator.Or},this.strings.orOperatorLabel))))}renderSpatialExpression(){return index.h("analysis-spatial-expression",{layers:this.layers,spatialExpression:this.expressionGroup.spatialExpression,onAnalysisExpressionChange:event=>this.onChildSpatialExpressionChange(event)})}renderChildExpressions(){return this.expressionGroup.children.map(((child,i)=>{if(child instanceof ExpressionGroup){return index.h("analysis-query-entry",{kind:"group",appearance:"section",key:child.id,onAnalysisQueryEntryRemove:event=>this.onRemoveChild(i,event)},index.h("analysis-expression-group",{expressionGroup:child,layers:this.layers,depth:this.depth+1,mode:this.mode,allowedExpressions:this.allowedExpressions,options:this.options,onAnalysisExpressionGroupChange:event=>this.onChildGroupChange(i,event)}))}else{return index.h("analysis-attribute-expression",{expression:child,target:this.expressionGroup.layer,key:child.id,options:this.options,onAnalysisExpressionChange:event=>this.onChildExpressionChange(i,event),onAnalysisExpressionRemoveClick:event=>this.onRemoveChild(i,event)})}}))}renderTopLevelButtons(){const allowedExpressionSet=new Set(this.allowedExpressions);if(this.mode==="analysis"&&expressions.SpatialExpression.getValidSelectingLayers(this.expressionGroup.layer,this.layers).length<1||this.mode==="sql"){allowedExpressionSet.delete("spatial")}return index.h("div",{class:HTMLClasses.addButtonsContainer},index.h("calcite-button",{disabled:allowedExpressionSet.has("attribute")===false,appearance:"outline-fill",kind:"neutral",iconStart:"plus",onClick:this.onAddAttributeExpressionClick},this.recordsTerm==="features"?this.strings.attributeExpression:this.strings.expression),this.mode!=="sql"&&index.h(index.Fragment,null,index.h("calcite-button",{disabled:allowedExpressionSet.has("spatial")===false,ref:element=>{if(element){this.addSpatialExpressionButtonRef=element}},appearance:"outline-fill",kind:"neutral",iconStart:"plus",onClick:this.onAddSpatialExpressionClick},this.strings.spatialExpression),allowedExpressionSet.has("spatial")===false&&index.h("calcite-tooltip",{label:this.strings.spatialExpressionTwoLayers,referenceElement:this.addSpatialExpressionButtonRef,ref:element=>this.spatialExpressionButtonTooltipRef=element,overlayPositioning:"fixed",placement:"top"},this.strings.spatialExpressionTwoLayers)),index.h("calcite-button",{disabled:allowedExpressionSet.has("group")===false,appearance:"outline-fill",kind:"neutral",iconStart:"group-form-plus",onClick:this.onAddGroupClick},this.strings.expressionGroup))}renderExpressionDropdown(){const allowedExpressionSet=new Set(this.allowedExpressions);if(this.depth>=MAX_DEPTH){allowedExpressionSet.delete("group")}if(this.mode==="analysis"&&expressions.SpatialExpression.getValidSelectingLayers(this.expressionGroup.layer,this.layers).length<1){allowedExpressionSet.delete("spatial")}return index.h("calcite-dropdown",{widthScale:"m",overlayPositioning:"fixed"},index.h("calcite-button",{slot:"trigger",appearance:"outline-fill",kind:"neutral",iconStart:"plus",iconEnd:"chevron-down"},this.strings.expression),index.h("calcite-dropdown-group",null,allowedExpressionSet.has("attribute")&&index.h("calcite-dropdown-item",{onCalciteDropdownItemSelect:this.onAddAttributeExpressionClick},this.recordsTerm==="features"?this.strings.attributeExpression:this.strings.expression),allowedExpressionSet.has("spatial")&&index.h("calcite-dropdown-item",{onCalciteDropdownItemSelect:this.onAddSpatialExpressionClick},this.strings.spatialExpression),allowedExpressionSet.has("group")&&index.h("calcite-dropdown-item",{onCalciteDropdownItemSelect:this.onAddGroupClick},this.strings.expressionGroup)))}get hostElement(){return this}static get style(){return analysisExpressionGroupCss}},[0,"analysis-expression-group",{expressionGroup:[1040],mode:[513],allowedExpressions:[16],layers:[16],recordsTerm:[1,"records-term"],options:[16],depth:[2],error:[32]}]);function defineCustomElement(){if(typeof customElements==="undefined"){return}const components=["analysis-expression-group","analysis-attribute-expression","analysis-expression-group","analysis-query-entry","analysis-spatial-expression"];components.forEach((tagName=>{switch(tagName){case"analysis-expression-group":if(!customElements.get(tagName)){customElements.define(tagName,AnalysisExpressionGroup)}break;case"analysis-attribute-expression":if(!customElements.get(tagName)){analysisAttributeExpression2.defineCustomElement()}break;case"analysis-expression-group":if(!customElements.get(tagName)){defineCustomElement()}break;case"analysis-query-entry":if(!customElements.get(tagName)){analysisQueryEntry2.defineCustomElement()}break;case"analysis-spatial-expression":if(!customElements.get(tagName)){analysisSpatialExpression2.defineCustomElement()}break}}))}defineCustomElement();exports.AnalysisExpressionGroup=AnalysisExpressionGroup;exports.ExpressionGroup=ExpressionGroup;exports.HTMLClasses$1=HTMLClasses$1;exports.assignValue=assignValue;exports.defineCustomElement=defineCustomElement;exports.flatRest=flatRest;exports.omit=omit}));
