"use strict";
(self["webpackChunkexb_client"] = self["webpackChunkexb_client"] || []).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_color--711860"],{

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/color-d6da0a9a.js":
/*!***********************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/color-d6da0a9a.js ***!
  \***********************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   a: () => (/* binding */ createColorAgeRenderer),
/* harmony export */   b: () => (/* binding */ createColorRendererFromExisting),
/* harmony export */   c: () => (/* binding */ createColorRenderer),
/* harmony export */   d: () => (/* binding */ createColorAgeRendererFromExisting),
/* harmony export */   e: () => (/* binding */ createClassedColorRendererFromExisting),
/* harmony export */   g: () => (/* binding */ getClassBreaksColors),
/* harmony export */   s: () => (/* binding */ sameColorField)
/* harmony export */ });
/* harmony import */ var _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./raster-unique-value-0976ec7f.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/raster-unique-value-0976ec7f.js");
/* harmony import */ var _loadModules_b4ac1247_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./loadModules-b4ac1247.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/loadModules-b4ac1247.js");
/* harmony import */ var _commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./commonFunctions-b0830e9e.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/commonFunctions-b0830e9e.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v4.0.58
 */




/**
 * Creates a Color renderer with default settings
 * @param options: options
 */
function createColorRenderer(options) {
    var _a;
    const { layer: smLayer, mapImageSublayer, mapView, supportsArcade, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const layer = smLayer;
    if (mapImageSublayer && !supportsArcade) {
        return createClassedColorRenderer(options);
    }
    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer);
    const authInfo = renderer.authoringInfo;
    const authColorVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.p)(renderer, "color");
    options = options || {};
    const rendererType = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.g)();
    const extras = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.m)((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer));
    const fieldInfo = options.fieldInfos ? options.fieldInfos[0] : null;
    const theme = options.theme ? options.theme : "high-to-low";
    return modules.ColorCreator.createContinuousRenderer({
        layer,
        view: mapView,
        field: fieldInfo.field,
        valueExpression: fieldInfo.expression,
        valueExpressionTitle: fieldInfo.expressionTitle,
        theme,
        colorScheme: options.colorScheme || (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.P)(theme),
        normalizationField: options.normalizationField,
        minValue: options.min,
        maxValue: options.max,
        outlineOptimizationEnabled: mapImageSublayer
            ? false
            : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_2__.i)(options.outlineOptimizationEnabled)
                ? options.outlineOptimizationEnabled
                : true,
        sizeOptimizationEnabled: mapImageSublayer
            ? false
            : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_2__.i)(options.sizeOptimizationEnabled)
                ? options.sizeOptimizationEnabled
                : true,
        legendOptions: options.legendOptions,
        defaultSymbolEnabled: false,
        forBinning: ((_a = layer.featureReduction) === null || _a === void 0 ? void 0 : _a.type) === "binning"
    }).then((result) => {
        if (!options.noReuse &&
            ["color", "color-size", "color-size-age"].indexOf(rendererType) > -1 &&
            sameColorField(options) &&
            authInfo &&
            (authInfo === null || authInfo === void 0 ? void 0 : authInfo.univariateTheme) !== "above-and-below" &&
            ["centered-on", "extremes"].indexOf(authColorVisVar.theme) === -1) {
            // re-use color renderer
            const colorVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer), "color");
            const authColorVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.p)((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer), "color");
            result.renderer.visualVariables = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.n)(result.renderer, "color") || [];
            result.renderer.visualVariables.push(colorVisVar);
            if (extras.sizeOutlineVisVar) {
                result.renderer.visualVariables = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.n)(renderer, "size", "outline");
                result.renderer.visualVariables.push(extras.sizeOutlineVisVar);
            }
            result.renderer.authoringInfo.visualVariables = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.o)(result.renderer, "color") || [];
            result.renderer.authoringInfo.visualVariables.push(authColorVisVar);
            (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.Q)(result.renderer);
        }
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.l)(extras, result.renderer);
        return Promise.resolve(result);
    }, (error) => Promise.reject(error));
}
/**
 * Creates a Color Age renderer with default settings
 * @param options: options
 */
function createColorAgeRenderer(options) {
    const { layer: smLayer, mapImageSublayer, mapView, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const layer = smLayer;
    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer);
    const authInfo = renderer.authoringInfo;
    options = options || {};
    const rendererType = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.g)();
    const extras = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.m)((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer));
    const fieldInfo = options.fieldInfos ? options.fieldInfos[0] : null;
    const theme = options.theme ? options.theme : "high-to-low";
    return modules.ColorCreator.createAgeRenderer({
        layer,
        view: mapView,
        startTime: fieldInfo.field,
        endTime: new Date(),
        theme,
        colorScheme: options.colorScheme || (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.P)(theme),
        unit: undefined,
        outlineOptimizationEnabled: mapImageSublayer
            ? false
            : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_2__.i)(options.outlineOptimizationEnabled)
                ? options.outlineOptimizationEnabled
                : true,
        sizeOptimizationEnabled: mapImageSublayer
            ? false
            : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_2__.i)(options.sizeOptimizationEnabled)
                ? options.sizeOptimizationEnabled
                : true,
        legendOptions: options.legendOptions,
        defaultSymbolEnabled: false
    }).then((result) => {
        if (["color-age", "color-age-size"].indexOf(rendererType) > -1 &&
            sameColorField(options) &&
            authInfo &&
            (authInfo === null || authInfo === void 0 ? void 0 : authInfo.univariateTheme) !== "above-and-below") {
            // re-use color renderer
            const colorVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer), "color");
            const authColorVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.p)((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer), "color");
            result.renderer.visualVariables = [colorVisVar];
            if (extras.sizeOutlineVisVar) {
                result.renderer.visualVariables.push(extras.sizeOutlineVisVar);
            }
            result.renderer.authoringInfo.visualVariables = [authColorVisVar];
            (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.Q)(result.renderer);
        }
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.l)(extras, result.renderer);
        return Promise.resolve(result);
    }, (error) => Promise.reject(error));
}
/**
 * Creates a Color renderer with default settings
 * @param options: options
 */
function createClassedColorRenderer(options) {
    var _a;
    const { layer: smLayer, mapImageSublayer, mapView, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const layer = smLayer;
    options = options || {};
    const extras = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.m)((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer));
    const fieldInfo = options.fieldInfos ? options.fieldInfos[0] : null;
    return modules.ColorCreator.createClassBreaksRenderer({
        layer,
        view: mapView,
        field: fieldInfo.field,
        valueExpression: fieldInfo.expression,
        valueExpressionTitle: fieldInfo.expressionTitle,
        normalizationField: options.normalizationField,
        classificationMethod: options.classificationMethod ? options.classificationMethod : "natural-breaks",
        standardDeviationInterval: options.classificationMethod === "standard-deviation"
            ? options.standardDeviationInterval
                ? options.standardDeviationInterval
                : 1
            : undefined,
        numClasses: options.numClasses ? options.numClasses : 4,
        minValue: options.min,
        maxValue: options.max,
        colorScheme: options.colorScheme || (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.P)(),
        outlineOptimizationEnabled: mapImageSublayer
            ? false
            : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_2__.i)(options.outlineOptimizationEnabled)
                ? options.outlineOptimizationEnabled
                : true,
        legendOptions: options.legendOptions,
        defaultSymbolEnabled: false,
        forBinning: ((_a = layer.featureReduction) === null || _a === void 0 ? void 0 : _a.type) === "binning"
    }).then((result) => {
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.l)(extras, result.renderer);
        return Promise.resolve(result);
    }, (error) => Promise.reject(error));
}
/**
 * Creates a Color renderer with settings from current renderer
 */
function createColorRendererFromExisting(options) {
    var _a, _b, _c, _d;
    const { layer: smLayer, mapImageSublayer, mapView, supportsArcade, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const layer = smLayer;
    if (mapImageSublayer && !supportsArcade) {
        return createClassedColorRendererFromExisting(options);
    }
    options = options || {};
    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer);
    const authInfo = renderer.authoringInfo || {};
    const rendererType = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.g)();
    const colorVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(renderer, "color");
    if (colorVisVar &&
        options.fieldInfos &&
        options.fieldInfos[0] &&
        options.fieldInfos[0].field == colorVisVar.field &&
        options.fieldInfos[0].expression == colorVisVar.valueExpression &&
        options.normalizationField === colorVisVar.normalizationField) {
        // no changes to fields
        delete options.fieldInfos;
        if ((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.R)(options)) {
            // nothing really changes
            return Promise.resolve({ renderer: renderer.clone() });
        }
    }
    const extras = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.m)(renderer);
    const authColorVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.p)(renderer, "color");
    let fieldInfo = options.fieldInfos
        ? options.fieldInfos[0]
        : colorVisVar
            ? {
                field: colorVisVar.field,
                expression: colorVisVar.valueExpression,
                expressionTitle: colorVisVar.valueExpressionTitle,
                simpleFieldType: _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.w.NUMBER
            }
            : {
                field: renderer.field,
                expression: renderer.valueExpression,
                expressionTitle: renderer.valueExpressionTitle,
                simpleFieldType: _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.w.NUMBER
            };
    const normalizationField = options.normalizationField === null
        ? undefined
        : options.normalizationField
            ? options.normalizationField
            : colorVisVar
                ? colorVisVar.normalizationField
                : renderer.normalizationField;
    let symbol = renderer.classBreakInfos && renderer.classBreakInfos.length
        ? renderer.classBreakInfos[0].symbol
        : (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.S)(layer, mapView, rendererType);
    if (symbol.type === "picture-marker") {
        symbol = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.S)(layer, mapView, rendererType);
    }
    const defaultSymbol = renderer.defaultSymbol;
    const defaultLabel = renderer.defaultLabel;
    let needNewStatistics = false;
    if (options.normalizationField === null ||
        options.normalizationField ||
        options.fieldInfo ||
        (authInfo.classificationMethod === "manual" && !options.theme) ||
        authInfo.classificationMethod === "equal-interval") {
        needNewStatistics = true;
    }
    const minValue = options.discardMinMax
        ? undefined
        : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_2__.i)(options.min)
            ? options.min
            : needNewStatistics
                ? undefined
                : colorVisVar
                    ? authColorVisVar === null || authColorVisVar === void 0 ? void 0 : authColorVisVar.minSliderValue
                    : renderer.classBreakInfos[0].minValue;
    const maxValue = options.discardMinMax
        ? undefined
        : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_2__.i)(options.max)
            ? options.max
            : needNewStatistics
                ? undefined
                : colorVisVar
                    ? authColorVisVar === null || authColorVisVar === void 0 ? void 0 : authColorVisVar.maxSliderValue
                    : renderer.classBreakInfos[renderer.classBreakInfos.length - 1].maxValue;
    const theme = options.theme ? options.theme : authColorVisVar ? authColorVisVar.theme : "high-to-low";
    const wasBelow = (authColorVisVar === null || authColorVisVar === void 0 ? void 0 : authColorVisVar.theme) === "below";
    const isBelow = theme === "below";
    const belowSwitch = (isBelow && !wasBelow) || (!isBelow && wasBelow);
    let colorScheme = options.colorScheme || (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.P)(theme);
    const config = {
        layer,
        view: mapView,
        field: fieldInfo.field,
        valueExpression: fieldInfo.expression,
        valueExpressionTitle: fieldInfo.expressionTitle,
        theme,
        colorScheme,
        normalizationField,
        minValue,
        maxValue,
        outlineOptimizationEnabled: mapImageSublayer
            ? false
            : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_2__.i)(options.outlineOptimizationEnabled)
                ? options.outlineOptimizationEnabled
                : !!extras.sizeOutlineVisVar,
        sizeOptimizationEnabled: mapImageSublayer
            ? false
            : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_2__.i)(options.sizeOptimizationEnabled)
                ? options.sizeOptimizationEnabled
                : !!extras.sizeAutoVisVar,
        legendOptions: ((_a = options.legendOptions) === null || _a === void 0 ? void 0 : _a.toJSON()) ||
            ((_b = colorVisVar === null || colorVisVar === void 0 ? void 0 : colorVisVar.legendOptions) === null || _b === void 0 ? void 0 : _b.toJSON()) ||
            ((_c = renderer.legendOptions) === null || _c === void 0 ? void 0 : _c.toJSON()),
        defaultSymbolEnabled: (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_2__.i)(options.defaultSymbolEnabled)
            ? options.defaultSymbolEnabled
            : !!renderer.defaultSymbol,
        forBinning: ((_d = layer.featureReduction) === null || _d === void 0 ? void 0 : _d.type) === "binning"
    };
    return modules.ColorCreator.createContinuousRenderer(config).then(
    // console.log("ColorCreator.createContinuousRenderer", config);
    (result) => {
        // reset handles if necessary
        if (options.discardMinMax) {
            const colorVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(renderer, "color");
            const newColorVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(result.renderer, "color");
            colorVisVar.stops.forEach((stop, idx) => (stop.value = newColorVisVar.stops[idx].value));
        }
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.l)(extras, result.renderer);
        if (symbol && result.renderer.classBreakInfos && result.renderer.classBreakInfos.length) {
            result.renderer.classBreakInfos[0].symbol = symbol;
        }
        if (defaultSymbol) {
            result.renderer.defaultSymbol = defaultSymbol;
            result.renderer.defaultLabel = defaultLabel;
        }
        if (belowSwitch && colorScheme && colorVisVar) {
            // need to reverse color order
            const newColorVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(result.renderer, "color");
            const len = colorVisVar.stops.length - 1;
            newColorVisVar.stops.forEach((colorStop, idx) => (colorStop.color = colorVisVar.stops[len - idx].color));
        }
        return Promise.resolve(result);
    }, (error) => Promise.reject(error));
}
/**
 * Creates a Age-Color renderer with settings from current renderer
 */
function createColorAgeRendererFromExisting(options) {
    var _a, _b;
    const { layer: smLayer, mapImageSublayer, mapView /* , supportsArcade */, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const layer = smLayer;
    /* if (mapImageSublayer && !supportsArcade) {
      return createClassedColorRendererFromExisting(options);
    } */
    options = options || {};
    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer);
    const rendererType = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.g)();
    const colorVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(renderer, "color");
    if (colorVisVar && options.fieldInfos && options.fieldInfos[0] && options.fieldInfos[0].field == colorVisVar.field) {
        // no changes to field
        delete options.fieldInfos;
        if ((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.R)(options)) {
            // nothing really changes
            return Promise.resolve({ renderer: renderer.clone() });
        }
    }
    const extras = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.m)(renderer);
    const authColorVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.p)(renderer, "color");
    const startTime = options.startTime ? options.startTime : authColorVisVar.startTime;
    const endTime = options.endTime ? options.endTime : authColorVisVar.endTime;
    const symbol = renderer.classBreakInfos && renderer.classBreakInfos.length
        ? renderer.classBreakInfos[0].symbol
        : (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.S)(layer, mapView, rendererType);
    const defaultSymbol = renderer.defaultSymbol;
    const defaultLabel = renderer.defaultLabel;
    let rangeChanged = false;
    if (options.startTime || options.endTime || options.units || options.fieldInfo) {
        rangeChanged = true;
    }
    const minValue = options.discardMinMax
        ? undefined
        : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_2__.i)(options.min)
            ? options.min
            : rangeChanged
                ? undefined
                : authColorVisVar
                    ? authColorVisVar.minSliderValue
                    : renderer.classBreakInfos[0].minValue;
    const maxValue = options.discardMinMax
        ? undefined
        : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_2__.i)(options.max)
            ? options.max
            : rangeChanged
                ? undefined
                : authColorVisVar
                    ? authColorVisVar.maxSliderValue
                    : renderer.classBreakInfos[renderer.classBreakInfos.length - 1].maxValue;
    const theme = options.theme ? options.theme : authColorVisVar ? authColorVisVar.theme : "high-to-low";
    const config = {
        layer,
        view: mapView,
        startTime,
        endTime,
        unit: options.units ? options.units : authColorVisVar.units,
        theme,
        colorScheme: options.colorScheme || (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.P)(theme),
        minValue,
        maxValue,
        outlineOptimizationEnabled: mapImageSublayer
            ? false
            : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_2__.i)(options.outlineOptimizationEnabled)
                ? options.outlineOptimizationEnabled
                : !!extras.sizeOutlineVisVar,
        sizeOptimizationEnabled: mapImageSublayer
            ? false
            : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_2__.i)(options.sizeOptimizationEnabled)
                ? options.sizeOptimizationEnabled
                : !!extras.sizeAutoVisVar,
        legendOptions: options.legendOptions
            ? options.legendOptions.toJSON()
            : rangeChanged
                ? undefined
                : ((_a = colorVisVar === null || colorVisVar === void 0 ? void 0 : colorVisVar.legendOptions) === null || _a === void 0 ? void 0 : _a.toJSON()) || ((_b = renderer.legendOptions) === null || _b === void 0 ? void 0 : _b.toJSON()),
        defaultSymbolEnabled: (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_2__.i)(options.defaultSymbolEnabled)
            ? options.defaultSymbolEnabled
            : !!renderer.defaultSymbol
    };
    return modules.ColorCreator.createAgeRenderer(config).then(
    // console.log("ColorCreator.createAgeRenderer", config);
    (result) => {
        // reset handles if necessary
        if (options.discardMinMax) {
            const colorVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(renderer, "color");
            const newColorVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(result.renderer, "color");
            colorVisVar.stops.forEach((stop, idx) => (stop.value = newColorVisVar.stops[idx].value));
        }
        const newAuthColorVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.p)(result.renderer, "color");
        newAuthColorVisVar.field = authColorVisVar.field;
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.l)(extras, result.renderer);
        if (symbol && result.renderer.classBreakInfos && result.renderer.classBreakInfos.length) {
            result.renderer.classBreakInfos[0].symbol = symbol;
        }
        if (defaultSymbol) {
            result.renderer.defaultSymbol = defaultSymbol;
            result.renderer.defaultLabel = defaultLabel;
        }
        return Promise.resolve(result);
    }, (error) => Promise.reject(error));
}
/**
 * Creates a Color renderer with settings from current renderer
 */
function createClassedColorRendererFromExisting(options) {
    var _a;
    const { layer: smLayer, mapImageSublayer, mapView, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const layer = smLayer;
    options = options || {};
    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer);
    const authInfo = renderer.authoringInfo || {};
    const colorVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(renderer, "color");
    if (!colorVisVar &&
        options.fieldInfo &&
        options.fieldInfo.field == renderer.field &&
        options.fieldInfo.expression == renderer.valueExpression &&
        options.normalizationField === renderer.normalizationField) {
        // no changes to fields
        delete options.fieldInfo;
        if ((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.R)(options)) {
            // nothing really changes
            return Promise.resolve({ renderer: renderer.clone() });
        }
    }
    const authColorVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.p)(renderer, "color");
    const extras = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.m)(renderer);
    const rendererFieldInfo = {
        field: renderer.field,
        expression: renderer.valueExpression,
        expressionTitle: renderer.valueExpressionTitle,
        simpleFieldType: _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.w.NUMBER
    };
    let fieldInfo = options.fieldInfos
        ? options.fieldInfos[0]
        : colorVisVar
            ? {
                field: colorVisVar.field,
                expression: colorVisVar.valueExpression,
                expressionTitle: colorVisVar.valueExpressionTitle,
                simpleFieldType: _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.w.NUMBER
            }
            : rendererFieldInfo;
    // options.normalizationField = null means don't set the value
    const normalizationField = options.normalizationField !== undefined
        ? options.normalizationField
        : colorVisVar
            ? colorVisVar.normalizationField
            : renderer.normalizationField;
    let symbol;
    if (renderer.classBreakInfos && renderer.classBreakInfos.length) {
        const sym = renderer.classBreakInfos[0].symbol;
        if (["simple-fill", "simple-marker", "simple-line", "cim"].indexOf(sym.type) > -1) {
            symbol = sym;
        }
    }
    const defaultSymbol = renderer.defaultSymbol;
    const defaultLabel = renderer.defaultLabel;
    // TODO need to keep ramp
    const classificationMethod = options.classificationMethod
        ? options.classificationMethod
        : authInfo.classificationMethod && authInfo.classificationMethod !== "manual"
            ? authInfo.classificationMethod
            : "natural-breaks";
    const standardDeviationInterval = classificationMethod === "standard-deviation"
        ? options.standardDeviationInterval
            ? options.standardDeviationInterval
            : authInfo.standardDeviationInterval
                ? authInfo.standardDeviationInterval
                : 1
        : undefined;
    let keepNumClasses = true;
    if (options.classificationMethod &&
        options.classificationMethod !== authInfo.classificationMethod &&
        (options.classificationMethod === "standard-deviation" || authInfo.classificationMethod === "standard-deviation")) {
        keepNumClasses = false;
    }
    let needNewStatistics = false;
    if (options.normalizationField !== undefined ||
        !(0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.x)(fieldInfo, rendererFieldInfo) ||
        classificationMethod !== "equal-interval") {
        // creator returns error if classificationMethod not equal-interval
        // together with min/maxValue
        needNewStatistics = true;
    }
    const minValue = (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_2__.i)(options.min)
        ? options.min
        : needNewStatistics
            ? undefined
            : authColorVisVar
                ? authColorVisVar.minSliderValue
                : renderer.classBreakInfos[0].minValue;
    const maxValue = (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_2__.i)(options.max)
        ? options.max
        : needNewStatistics
            ? undefined
            : authColorVisVar
                ? authColorVisVar.maxSliderValue
                : renderer.classBreakInfos[renderer.classBreakInfos.length - 1].maxValue;
    let colorScheme = options.colorScheme || (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.P)();
    if (!colorScheme) {
        // we also use above-and-below colors for classed color renderer
        colorScheme = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.P)("above-and-below");
    }
    return modules.ColorCreator.createClassBreaksRenderer({
        layer,
        view: mapView,
        field: fieldInfo.field,
        valueExpression: fieldInfo.expression,
        valueExpressionTitle: fieldInfo.expressionTitle,
        normalizationField,
        classificationMethod,
        standardDeviationInterval,
        numClasses: (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_2__.i)(options.numClasses)
            ? options.numClasses
            : colorVisVar || !keepNumClasses
                ? 4
                : renderer.classBreakInfos.length,
        minValue,
        maxValue,
        colorScheme,
        outlineOptimizationEnabled: mapImageSublayer
            ? false
            : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_2__.i)(options.outlineOptimizationEnabled)
                ? options.outlineOptimizationEnabled
                : !!extras.sizeOutlineVisVar,
        /* sizeOptimizationEnabled: mapImageSublayer
          ? false
          : isDefined(options.sizeOptimizationEnabled)
          ? options.sizeOptimizationEnabled
          : !!extras.sizeAutoVisVar, TODO below ...*/
        legendOptions: options.legendOptions || renderer.legendOptions,
        defaultSymbolEnabled: (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_2__.i)(options.defaultSymbolEnabled)
            ? options.defaultSymbolEnabled
            : !!renderer.defaultSymbol,
        forBinning: ((_a = layer.featureReduction) === null || _a === void 0 ? void 0 : _a.type) === "binning"
    }).then((result) => {
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.l)(extras, result.renderer);
        if (extras.sizeAutoVisVar) {
            result.renderer.visualVariables = result.renderer.visualVariables || [];
            result.renderer.visualVariables.push(extras.sizeAutoVisVar);
        }
        if (symbol && result.renderer.classBreakInfos) {
            result.renderer.classBreakInfos.map((classBreakInfo) => {
                const sym = symbol.clone();
                (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.r)(sym, (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.t)(classBreakInfo.symbol));
                classBreakInfo.symbol = sym;
            });
        }
        if (defaultSymbol) {
            result.renderer.defaultSymbol = defaultSymbol;
            result.renderer.defaultLabel = defaultLabel;
        }
        return Promise.resolve(result);
    }, (error) => Promise.reject(error));
}
function getClassBreaksColors() {
    const { layer, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer);
    return renderer.classBreakInfos.map((classBreakInfo) => {
        return {
            min: classBreakInfo.minValue,
            max: classBreakInfo.maxValue,
            color: (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.t)(classBreakInfo.symbol)
                ? (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.t)(classBreakInfo.symbol).clone()
                : new modules.esriColor({ r: 255, g: 255, b: 255, a: 1 }) // white in slider for PMS
        };
    });
}
function sameColorField(options) {
    // not checking for normalizationField
    // we keep it if the renderer has it and it does not get overwritten
    const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer).clone();
    const rendererType = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.g)();
    if (["color", "color-size", "color-size-age", "color-age", "color-age-size"].indexOf(rendererType) > -1 &&
        options.normalizationField === undefined) {
        let renderFieldInfo;
        const colorVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(renderer, "color");
        if (colorVisVar) {
            // continuous
            if (["color-age", "color-age-size"].indexOf(rendererType) > -1) {
                const authColorVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.p)(renderer, "color");
                renderFieldInfo = {
                    field: authColorVisVar.field
                };
            }
            else {
                renderFieldInfo = {
                    field: colorVisVar.field,
                    expression: colorVisVar.valueExpression,
                    expressionTitle: colorVisVar.valueExpressionTitle
                };
            }
        }
        else {
            // classed
            renderFieldInfo = {
                field: renderer.field,
                expression: renderer.valueExpression,
                expressionTitle: renderer.valueExpressionTitle
            };
        }
        if ((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.x)(options.fieldInfos[0], renderFieldInfo)) {
            return true;
        }
    }
    return false;
}



//# sourceMappingURL=color-d6da0a9a.js.map

/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0cy9jaHVua3MvYXJjZ2lzX2FuYWx5c2lzX25vZGVfbW9kdWxlc19hcmNnaXNfYXBwLWNvbXBvbmVudHNfZGlzdF9lc21fY29sb3ItLTcxMTg2MC5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDd2E7QUFDclk7QUFDNEI7O0FBRS9EO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFlBQVkscUVBQXFFLEVBQUUsK0RBQWlCO0FBQ3BHO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUJBQXFCLG1FQUFXO0FBQ2hDO0FBQ0EsNEJBQTRCLG1FQUFhO0FBQ3pDO0FBQ0EseUJBQXlCLG1FQUFlO0FBQ3hDLG1CQUFtQixtRUFBZ0IsQ0FBQyxtRUFBVztBQUMvQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw0Q0FBNEMsbUVBQWU7QUFDM0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGNBQWMsK0RBQVM7QUFDdkI7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjLCtEQUFTO0FBQ3ZCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxnQ0FBZ0MsbUVBQVMsQ0FBQyxtRUFBVztBQUNyRCxvQ0FBb0MsbUVBQWEsQ0FBQyxtRUFBVztBQUM3RCw4Q0FBOEMsbUVBQWdCO0FBQzlEO0FBQ0E7QUFDQSxrREFBa0QsbUVBQWdCO0FBQ2xFO0FBQ0E7QUFDQSw0REFBNEQsbUVBQW9CO0FBQ2hGO0FBQ0EsWUFBWSxtRUFBcUI7QUFDakM7QUFDQSxRQUFRLG1FQUFpQjtBQUN6QjtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxZQUFZLHFEQUFxRCxFQUFFLCtEQUFpQjtBQUNwRjtBQUNBLHFCQUFxQixtRUFBVztBQUNoQztBQUNBO0FBQ0EseUJBQXlCLG1FQUFlO0FBQ3hDLG1C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RUFBRSwrREFBaUI7QUFDaEQscUJBQXFCLG1FQUFXO0FBQ2hDO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsbUJBQW1CLG1FQUFjO0FBQ2pDLGtCQUFrQixtRUFBYztBQUNoQywwQ0FBMEMsOEJBQThCO0FBQ3hFO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsWUFBWSxRQUFRLEVBQUUsK0RBQWlCO0FBQ3ZDLHFCQUFxQixtRUFBVztBQUNoQyx5QkFBeUIsbUVBQWU7QUFDeEM7QUFDQTtBQUNBO0FBQ0EsNEJBQTRCLG1FQUFTO0FBQ3JDO0FBQ0E7QUFDQTtBQUNBLHdDQUF3QyxtRUFBYTtBQUNyRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsWUFBWSxtRUFBZTtBQUMzQjtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUU2Tzs7QUFFN08iLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9leGItY2xpZW50Ly4vZXh0ZW5zaW9ucy93aWRnZXRzL2FyY2dpcy9hbmFseXNpcy9ub2RlX21vZHVsZXMvQGFyY2dpcy9hcHAtY29tcG9uZW50cy9kaXN0L2VzbS9jb2xvci1kNmRhMGE5YS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEFsbCBtYXRlcmlhbCBjb3B5cmlnaHQgRVNSSSwgQWxsIFJpZ2h0cyBSZXNlcnZlZCwgdW5sZXNzIG90aGVyd2lzZSBzcGVjaWZpZWQuXG4gKiB2NC4wLjU4XG4gKi9cbmltcG9ydCB7IHQgYXMgZ2V0U3ltYm9sQ29sb3IsIHMgYXMgc21hcnRNYXBwaW5nU3RhdGUsIGggYXMgZ2V0UmVuZGVyZXIsIFAgYXMgZmluZENvbG9yU2NoZW1lLCBhIGFzIGdldFZpc1ZhciwgcCBhcyBnZXRBdXRoVmlzVmFyLCBRIGFzIGZpeE5vcm1hbGl6YXRpb25GaWVsZCwgbCBhcyBhcHBseUV4dHJhVmlzVmFycywgZyBhcyBnZXRSZW5kZXJlclR5cGUsIG0gYXMgc2F2ZUV4dHJhVmlzVmFycywgbiBhcyBnZXRWaXNWYXJzRXhjZXB0LCBvIGFzIGdldEF1dGhWaXNWYXJzRXhjZXB0LCBSIGFzIGlzRW1wdHksIFMgYXMgZ2V0RGVmYXVsdFN5bWJvbCwgciBhcyBhcHBseVN5bWJvbENvbG9yLCB4IGFzIGlzU2FtZUZpZWxkSW5mbywgdyBhcyBzaW1wbGVGaWVsZFR5cGVzIH0gZnJvbSAnLi9yYXN0ZXItdW5pcXVlLXZhbHVlLTA5NzZlYzdmLmpzJztcbmltcG9ydCAnLi9sb2FkTW9kdWxlcy1iNGFjMTI0Ny5qcyc7XG5pbXBvcnQgeyBpIGFzIGlzRGVmaW5lZCB9IGZyb20gJy4vY29tbW9uRnVuY3Rpb25zLWIwODMwZTllLmpzJztcblxuLyoqXG4gKiBDcmVhdGVzIGEgQ29sb3IgcmVuZGVyZXIgd2l0aCBkZWZhdWx0IHNldHRpbmdzXG4gKiBAcGFyYW0gb3B0aW9uczogb3B0aW9uc1xuICovXG5mdW5jdGlvbiBjcmVhdGVDb2xvclJlbmRlcmVyKG9wdGlvbnMpIHtcbiAgICB2YXIgX2E7XG4gICAgY29uc3QgeyBsYXllcjogc21MYXllciwgbWFwSW1hZ2VTdWJsYXllciwgbWFwVmlldywgc3VwcG9ydHNBcmNhZGUsIG1vZHVsZXMgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgIGNvbnN0IGxheWVyID0gc21MYXllcjtcbiAgICBpZiAobWFwSW1hZ2VTdWJsYXllciAmJiAhc3VwcG9ydHNBcmNhZGUpIHtcbiAgICAgICAgcmV0dXJuIGNyZWF0ZUNsYXNzZWRDb2xvclJlbmRlcmVyKG9wdGlvbnMpO1xuICAgIH1cbiAgICBjb25zdCByZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKTtcbiAgICBjb25zdCBhdXRoSW5mbyA9IHJlbmRlcmVyLmF1dGhvcmluZ0luZm87XG4gICAgY29uc3QgYXV0aENvbG9yVmlzVmFyID0gZ2V0QXV0aFZpc1ZhcihyZW5kZXJlciwgXCJjb2xvclwiKTtcbiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcbiAgICBjb25zdCByZW5kZXJlclR5cGUgPSBnZXRSZW5kZXJlclR5cGUoKTtcbiAgICBjb25zdCBleHRyYXMgPSBzYXZlRXh0cmFWaXNWYXJzKGdldFJlbmRlcmVyKGxheWVyKSk7XG4gICAgY29uc3QgZmllbGRJbmZvID0gb3B0aW9ucy5maWVsZEluZm9zID8gb3B0aW9ucy5maWVsZEluZm9zWzBdIDogbnVsbDtcbiAgICBjb25zdCB0aGVtZSA9IG9wdGlvbnMudGhlbWUgPyBvcHRpb25zLnRoZW1lIDogXCJoaWdoLXRvLWxvd1wiO1xuICAgIHJldHVybiBtb2R1bGVzLkNvbG9yQ3JlYXRvci5jcmVhdGVDb250aW51b3VzUmVuZGVyZXIoe1xuICAgICAgICBsYXllcixcbiAgICAgICAgdmlldzogbWFwVmlldyxcbiAgICAgICAgZmllbGQ6IGZpZWxkSW5mby5maWVsZCxcbiAgICAgICAgdmFsdWVFeHByZXNzaW9uOiBmaWVsZEluZm8uZXhwcmVzc2lvbixcbiAgICAgICAgdmFsdWVFeHByZXNzaW9uVGl0bGU6IGZpZWxkSW5mby5leHByZXNzaW9uVGl0bGUsXG4gICAgICAgIHRoZW1lLFxuICAgICAgICBjb2xvclNjaGVtZTogb3B0aW9ucy5jb2xvclNjaGVtZSB8fCBmaW5kQ29sb3JTY2hlbWUodGhlbWUpLFxuICAgICAgICBub3JtYWxpemF0aW9uRmllbGQ6IG9wdGlvbnMubm9ybWFsaXphdGlvbkZpZWxkLFxuICAgICAgICBtaW5WYWx1ZTogb3B0aW9ucy5taW4sXG4gICAgICAgIG1heFZhbHVlOiBvcHRpb25zLm1heCxcbiAgICAgICAgb3V0bGluZU9wdGltaXphdGlvbkVuYWJsZWQ6IG1hcEltYWdlU3VibGF5ZXJcbiAgICAgICAgICAgID8gZmFsc2VcbiAgICAgICAgICAgIDogaXNEZWZpbmVkKG9wdGlvbnMub3V0bGluZU9wdGltaXphdGlvbkVuYWJsZWQpXG4gICAgICAgICAgICAgICAgPyBvcHRpb25zLm91dGxpbmVPcHRpbWl6YXRpb25FbmFibGVkXG4gICAgICAgICAgICAgICAgOiB0cnVlLFxuICAgICAgICBzaXplT3B0aW1pemF0aW9uRW5hYmxlZDogbWFwSW1hZ2VTdWJsYXllclxuICAgICAgICAgICAgPyBmYWxzZVxuICAgICAgICAgICAgOiBpc0RlZmluZWQob3B0aW9ucy5zaXplT3B0aW1pemF0aW9uRW5hYmxlZClcbiAgICAgICAgICAgICAgICA/IG9wdGlvbnMuc2l6ZU9wdGltaXphdGlvbkVuYWJsZWRcbiAgICAgICAgICAgICAgICA6IHRydWUsXG4gICAgICAgIGxlZ2VuZE9wdGlvbnM6IG9wdGlvbnMubGVnZW5kT3B0aW9ucyxcbiAgICAgICAgZGVmYXVsdFN5bWJvbEVuYWJsZWQ6IGZhbHNlLFxuICAgICAgICBmb3JCaW5uaW5nOiAoKF9hID0gbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnR5cGUpID09PSBcImJpbm5pbmdcIlxuICAgIH0pLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgICBpZiAoIW9wdGlvbnMubm9SZXVzZSAmJlxuICAgICAgICAgICAgW1wiY29sb3JcIiwgXCJjb2xvci1zaXplXCIsIFwiY29sb3Itc2l6ZS1hZ2VcIl0uaW5kZXhPZihyZW5kZXJlclR5cGUpID4gLTEgJiZcbiAgICAgICAgICAgIHNhbWVDb2xvckZpZWxkKG9wdGlvbnMpICYmXG4gICAgICAgICAgICBhdXRoSW5mbyAmJlxuICAgICAgICAgICAgKGF1dGhJbmZvID09PSBudWxsIHx8IGF1dGhJbmZvID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhdXRoSW5mby51bml2YXJpYXRlVGhlbWUpICE9PSBcImFib3ZlLWFuZC1iZWxvd1wiICYmXG4gICAgICAgICAgICBbXCJjZW50ZXJlZC1vblwiLCBcImV4dHJlbWVzXCJdLmluZGV4T2YoYXV0aENvbG9yVmlzVmFyLnRoZW1lKSA9PT0gLTEpIHtcbiAgICAgICAgICAgIC8vIHJlLXVzZSBjb2xvciByZW5kZXJlclxuICAgICAgICAgICAgY29uc3QgY29sb3JWaXNWYXIgPSBnZXRWaXNWYXIoZ2V0UmVuZGVyZXIobGF5ZXIpLCBcImNvbG9yXCIpO1xuICAgICAgICAgICAgY29uc3QgYXV0aENvbG9yVmlzVmFyID0gZ2V0QXV0aFZpc1ZhcihnZXRSZW5kZXJlcihsYXllciksIFwiY29sb3JcIik7XG4gICAgICAgICAgICByZXN1bHQucmVuZGVyZXIudmlzdWFsVmFyaWFibGVzID0gZ2V0VmlzVmFyc0V4Y2VwdChyZXN1bHQucmVuZGVyZXIsIFwiY29sb3JcIikgfHwgW107XG4gICAgICAgICAgICByZXN1bHQucmVuZGVyZXIudmlzdWFsVmFyaWFibGVzLnB1c2goY29sb3JWaXNWYXIpO1xuICAgICAgICAgICAgaWYgKGV4dHJhcy5zaXplT3V0bGluZVZpc1Zhcikge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5yZW5kZXJlci52aXN1YWxWYXJpYWJsZXMgPSBnZXRWaXNWYXJzRXhjZXB0KHJlbmRlcmVyLCBcInNpemVcIiwgXCJvdXRsaW5lXCIpO1xuICAgICAgICAgICAgICAgIHJlc3VsdC5yZW5kZXJlci52aXN1YWxWYXJpYWJsZXMucHVzaChleHRyYXMuc2l6ZU91dGxpbmVWaXNWYXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVzdWx0LnJlbmRlcmVyLmF1dGhvcmluZ0luZm8udmlzdWFsVmFyaWFibGVzID0gZ2V0QXV0aFZpc1ZhcnNFeGNlcHQocmVzdWx0LnJlbmRlcmVyLCBcImNvbG9yXCIpIHx8IFtdO1xuICAgICAgICAgICAgcmVzdWx0LnJlbmRlcmVyLmF1dGhvcmluZ0luZm8udmlzdWFsVmFyaWFibGVzLnB1c2goYXV0aENvbG9yVmlzVmFyKTtcbiAgICAgICAgICAgIGZpeE5vcm1hbGl6YXRpb25GaWVsZChyZXN1bHQucmVuZGVyZXIpO1xuICAgICAgICB9XG4gICAgICAgIGFwcGx5RXh0cmFWaXNWYXJzKGV4dHJhcywgcmVzdWx0LnJlbmRlcmVyKTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXN1bHQpO1xuICAgIH0sIChlcnJvcikgPT4gUHJvbWlzZS5yZWplY3QoZXJyb3IpKTtcbn1cbi8qKlxuICogQ3JlYXRlcyBhIENvbG9yIEFnZSByZW5kZXJlciB3aXRoIGRlZmF1bHQgc2V0dGluZ3NcbiAqIEBwYXJhbSBvcHRpb25zOiBvcHRpb25zXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZUNvbG9yQWdlUmVuZGVyZXIob3B0aW9ucykge1xuICAgIGNvbnN0IHsgbGF5ZXI6IHNtTGF5ZXIsIG1hcEltYWdlU3VibGF5ZXIsIG1hcFZpZXcsIG1vZHVsZXMgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgIGNvbnN0IGxheWVyID0gc21MYXllcjtcbiAgICBjb25zdCByZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKTtcbiAgICBjb25zdCBhdXRoSW5mbyA9IHJlbmRlcmVyLmF1dGhvcmluZ0luZm87XG4gICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgY29uc3QgcmVuZGVyZXJUeXBlID0gZ2V0UmVuZGVyZXJUeXBlKCk7XG4gICAgY29uc3QgZXh0cmFzID0gc2F2ZUV4dHJhVmlzVmFycyhnZXRSZW5kZXJlcihsYXllcikpO1xuICAgIGNvbnN0IGZpZWxkSW5mbyA9IG9wdGlvbnMuZmllbGRJbmZvcyA/IG9wdGlvbnMuZmllbGRJbmZvc1swXSA6IG51bGw7XG4gICAgY29uc3QgdGhlbWUgPSBvcHRpb25zLnRoZW1lID8gb3B0aW9ucy50aGVtZSA6IFwiaGlnaC10by1sb3dcIjtcbiAgICByZXR1cm4gbW9kdWxlcy5Db2xvckNyZWF0b3IuY3JlYXRlQWdlUmVuZGVyZXIoe1xuICAgICAgICBsYXllcixcbiAgICAgICAgdmlldzogbWFwVmlldyxcbiAgICAgICAgc3RhcnRUaW1lOiBmaWVsZEluZm8uZmllbGQsXG4gICAgICAgIGVuZFRpbWU6IG5ldyBEYXRlKCksXG4gICAgICAgIHRoZW1lLFxuICAgICAgICBjb2xvclNjaGVtZTogb3B0aW9ucy5jb2xvclNjaGVtZSB8fCBmaW5kQ29sb3JTY2hlbWUodGhlbWUpLFxuICAgICAgICB1bml0OiB1bmRlZmluZWQsXG4gICAgICAgIG91dGxpbmVPcHRpbWl6YXRpb25FbmFibGVkOiBtYXBJbWFnZVN1YmxheWVyXG4gICAgICAgICAgICA/IGZhbHNlXG4gICAgICAgICAgICA6IGlzRGVmaW5lZChvcHRpb25zLm91dGxpbmVPcHRpbWl6YXRpb25FbmFibGVkKVxuICAgICAgICAgICAgICAgID8gb3B0aW9ucy5vdXRsaW5lT3B0aW1pemF0aW9uRW5hYmxlZFxuICAgICAgICAgICAgICAgIDogdHJ1ZSxcbiAgICAgICAgc2l6ZU9wdGltaXphdGlvbkVuYWJsZWQ6IG1hcEltYWdlU3VibGF5ZXJcbiAgICAgICAgICAgID8gZmFsc2VcbiAgICAgICAgICAgIDogaXNEZWZpbmVkKG9wdGlvbnMuc2l6ZU9wdGltaXphdGlvbkVuYWJsZWQpXG4gICAgICAgICAgICAgICAgPyBvcHRpb25zLnNpemVPcHRpbWl6YXRpb25FbmFibGVkXG4gICAgICAgICAgICAgICAgOiB0cnVlLFxuICAgICAgICBsZWdlbmRPcHRpb25zOiBvcHRpb25zLmxlZ2VuZE9wdGlvbnMsXG4gICAgICAgIGRlZmF1bHRTeW1ib2xFbmFibGVkOiBmYWxzZVxuICAgIH0pLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgICBpZiAoW1wiY29sb3ItYWdlXCIsIFwiY29sb3ItYWdlLXNpemVcIl0uaW5kZXhPZihyZW5kZXJlclR5cGUpID4gLTEgJiZcbiAgICAgICAgICAgIHNhbWVDb2xvckZpZWxkKG9wdGlvbnMpICYmXG4gICAgICAgICAgICBhdXRoSW5mbyAmJlxuICAgICAgICAgICAgKGF1dGhJbmZvID09PSBudWxsIHx8IGF1dGhJbmZvID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhdXRoSW5mby51bml2YXJpYXRlVGhlbWUpICE9PSBcImFib3ZlLWFuZC1iZWxvd1wiKSB7XG4gICAgICAgICAgICAvLyByZS11c2UgY29sb3IgcmVuZGVyZXJcbiAgICAgICAgICAgIGNvbnN0IGNvbG9yVmlzVmFyID0gZ2V0VmlzVmFyKGdldFJlbmRlcmVyKGxheWVyKSwgXCJjb2xvclwiKTtcbiAgICAgICAgICAgIGNvbnN0IGF1dGhDb2xvclZpc1ZhciA9IGdldEF1dGhWaXNWYXIoZ2V0UmVuZGVyZXIobGF5ZXIpLCBcImNvbG9yXCIpO1xuICAgICAgICAgICAgcmVzdWx0LnJlbmRlcmVyLnZpc3VhbFZhcmlhYmxlcyA9IFtjb2xvclZpc1Zhcl07XG4gICAgICAgICAgICBpZiAoZXh0cmFzLnNpemVPdXRsaW5lVmlzVmFyKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnJlbmRlcmVyLnZpc3VhbFZhcmlhYmxlcy5wdXNoKGV4dHJhcy5zaXplT3V0bGluZVZpc1Zhcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXN1bHQucmVuZGVyZXIuYXV0aG9yaW5nSW5mby52aXN1YWxWYXJpYWJsZXMgPSBbYXV0aENvbG9yVmlzVmFyXTtcbiAgICAgICAgICAgIGZpeE5vcm1hbGl6YXRpb25GaWVsZChyZXN1bHQucmVuZGVyZXIpO1xuICAgICAgICB9XG4gICAgICAgIGFwcGx5RXh0cmFWaXNWYXJzKGV4dHJhcywgcmVzdWx0LnJlbmRlcmVyKTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXN1bHQpO1xuICAgIH0sIChlcnJvcikgPT4gUHJvbWlzZS5yZWplY3QoZXJyb3IpKTtcbn1cbi8qKlxuICogQ3JlYXRlcyBhIENvbG9yIHJlbmRlcmVyIHdpdGggZGVmYXVsdCBzZXR0aW5nc1xuICogQHBhcmFtIG9wdGlvbnM6IG9wdGlvbnNcbiAqL1xuZnVuY3Rpb24gY3JlYXRlQ2xhc3NlZENvbG9yUmVuZGVyZXIob3B0aW9ucykge1xuICAgIHZhciBfYTtcbiAgICBjb25zdCB7IGxheWVyOiBzbUxheWVyLCBtYXBJbWFnZVN1YmxheWVyLCBtYXBWaWV3LCBtb2R1bGVzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICBjb25zdCBsYXllciA9IHNtTGF5ZXI7XG4gICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgY29uc3QgZXh0cmFzID0gc2F2ZUV4dHJhVmlzVmFycyhnZXRSZW5kZXJlcihsYXllcikpO1xuICAgIGNvbnN0IGZpZWxkSW5mbyA9IG9wdGlvbnMuZmllbGRJbmZvcyA/IG9wdGlvbnMuZmllbGRJbmZvc1swXSA6IG51bGw7XG4gICAgcmV0dXJuIG1vZHVsZXMuQ29sb3JDcmVhdG9yLmNyZWF0ZUNsYXNzQnJlYWtzUmVuZGVyZXIoe1xuICAgICAgICBsYXllcixcbiAgICAgICAgdmlldzogbWFwVmlldyxcbiAgICAgICAgZmllbGQ6IGZpZWxkSW5mby5maWVsZCxcbiAgICAgICAgdmFsdWVFeHByZXNzaW9uOiBmaWVsZEluZm8uZXhwcmVzc2lvbixcbiAgICAgICAgdmFsdWVFeHByZXNzaW9uVGl0bGU6IGZpZWxkSW5mby5leHByZXNzaW9uVGl0bGUsXG4gICAgICAgIG5vcm1hbGl6YXRpb25GaWVsZDogb3B0aW9ucy5ub3JtYWxpemF0aW9uRmllbGQsXG4gICAgICAgIGNsYXNzaWZpY2F0aW9uTWV0aG9kOiBvcHRpb25zLmNsYXNzaWZpY2F0aW9uTWV0aG9kID8gb3B0aW9ucy5jbGFzc2lmaWNhdGlvbk1ldGhvZCA6IFwibmF0dXJhbC1icmVha3NcIixcbiAgICAgICAgc3RhbmRhcmREZXZpYXRpb25JbnRlcnZhbDogb3B0aW9ucy5jbGFzc2lmaWNhdGlvbk1ldGhvZCA9PT0gXCJzdGFuZGFyZC1kZXZpYXRpb25cIlxuICAgICAgICAgICAgPyBvcHRpb25zLnN0YW5kYXJkRGV2aWF0aW9uSW50ZXJ2YWxcbiAgICAgICAgICAgICAgICA/IG9wdGlvbnMuc3RhbmRhcmREZXZpYXRpb25JbnRlcnZhbFxuICAgICAgICAgICAgICAgIDogMVxuICAgICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgIG51bUNsYXNzZXM6IG9wdGlvbnMubnVtQ2xhc3NlcyA/IG9wdGlvbnMubnVtQ2xhc3NlcyA6IDQsXG4gICAgICAgIG1pblZhbHVlOiBvcHRpb25zLm1pbixcbiAgICAgICAgbWF4VmFsdWU6IG9wdGlvbnMubWF4LFxuICAgICAgICBjb2xvclNjaGVtZTogb3B0aW9ucy5jb2xvclNjaGVtZSB8fCBmaW5kQ29sb3JTY2hlbWUoKSxcbiAgICAgICAgb3V0bGluZU9wdGltaXphdGlvbkVuYWJsZWQ6IG1hcEltYWdlU3VibGF5ZXJcbiAgICAgICAgICAgID8gZmFsc2VcbiAgICAgICAgICAgIDogaXNEZWZpbmVkKG9wdGlvbnMub3V0bGluZU9wdGltaXphdGlvbkVuYWJsZWQpXG4gICAgICAgICAgICAgICAgPyBvcHRpb25zLm91dGxpbmVPcHRpbWl6YXRpb25FbmFibGVkXG4gICAgICAgICAgICAgICAgOiB0cnVlLFxuICAgICAgICBsZWdlbmRPcHRpb25zOiBvcHRpb25zLmxlZ2VuZE9wdGlvbnMsXG4gICAgICAgIGRlZmF1bHRTeW1ib2xFbmFibGVkOiBmYWxzZSxcbiAgICAgICAgZm9yQmlubmluZzogKChfYSA9IGxheWVyLmZlYXR1cmVSZWR1Y3Rpb24pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS50eXBlKSA9PT0gXCJiaW5uaW5nXCJcbiAgICB9KS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgYXBwbHlFeHRyYVZpc1ZhcnMoZXh0cmFzLCByZXN1bHQucmVuZGVyZXIpO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlc3VsdCk7XG4gICAgfSwgKGVycm9yKSA9PiBQcm9taXNlLnJlamVjdChlcnJvcikpO1xufVxuLyoqXG4gKiBDcmVhdGVzIGEgQ29sb3IgcmVuZGVyZXIgd2l0aCBzZXR0aW5ncyBmcm9tIGN1cnJlbnQgcmVuZGVyZXJcbiAqL1xuZnVuY3Rpb24gY3JlYXRlQ29sb3JSZW5kZXJlckZyb21FeGlzdGluZyhvcHRpb25zKSB7XG4gICAgdmFyIF9hLCBfYiwgX2MsIF9kO1xuICAgIGNvbnN0IHsgbGF5ZXI6IHNtTGF5ZXIsIG1hcEltYWdlU3VibGF5ZXIsIG1hcFZpZXcsIHN1cHBvcnRzQXJjYWRlLCBtb2R1bGVzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICBjb25zdCBsYXllciA9IHNtTGF5ZXI7XG4gICAgaWYgKG1hcEltYWdlU3VibGF5ZXIgJiYgIXN1cHBvcnRzQXJjYWRlKSB7XG4gICAgICAgIHJldHVybiBjcmVhdGVDbGFzc2VkQ29sb3JSZW5kZXJlckZyb21FeGlzdGluZyhvcHRpb25zKTtcbiAgICB9XG4gICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcik7XG4gICAgY29uc3QgYXV0aEluZm8gPSByZW5kZXJlci5hdXRob3JpbmdJbmZvIHx8IHt9O1xuICAgIGNvbnN0IHJlbmRlcmVyVHlwZSA9IGdldFJlbmRlcmVyVHlwZSgpO1xuICAgIGNvbnN0IGNvbG9yVmlzVmFyID0gZ2V0VmlzVmFyKHJlbmRlcmVyLCBcImNvbG9yXCIpO1xuICAgIGlmIChjb2xvclZpc1ZhciAmJlxuICAgICAgICBvcHRpb25zLmZpZWxkSW5mb3MgJiZcbiAgICAgICAgb3B0aW9ucy5maWVsZEluZm9zWzBdICYmXG4gICAgICAgIG9wdGlvbnMuZmllbGRJbmZvc1swXS5maWVsZCA9PSBjb2xvclZpc1Zhci5maWVsZCAmJlxuICAgICAgICBvcHRpb25zLmZpZWxkSW5mb3NbMF0uZXhwcmVzc2lvbiA9PSBjb2xvclZpc1Zhci52YWx1ZUV4cHJlc3Npb24gJiZcbiAgICAgICAgb3B0aW9ucy5ub3JtYWxpemF0aW9uRmllbGQgPT09IGNvbG9yVmlzVmFyLm5vcm1hbGl6YXRpb25GaWVsZCkge1xuICAgICAgICAvLyBubyBjaGFuZ2VzIHRvIGZpZWxkc1xuICAgICAgICBkZWxldGUgb3B0aW9ucy5maWVsZEluZm9zO1xuICAgICAgICBpZiAoaXNFbXB0eShvcHRpb25zKSkge1xuICAgICAgICAgICAgLy8gbm90aGluZyByZWFsbHkgY2hhbmdlc1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHJlbmRlcmVyOiByZW5kZXJlci5jbG9uZSgpIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGV4dHJhcyA9IHNhdmVFeHRyYVZpc1ZhcnMocmVuZGVyZXIpO1xuICAgIGNvbnN0IGF1dGhDb2xvclZpc1ZhciA9IGdldEF1dGhWaXNWYXIocmVuZGVyZXIsIFwiY29sb3JcIik7XG4gICAgbGV0IGZpZWxkSW5mbyA9IG9wdGlvbnMuZmllbGRJbmZvc1xuICAgICAgICA/IG9wdGlvbnMuZmllbGRJbmZvc1swXVxuICAgICAgICA6IGNvbG9yVmlzVmFyXG4gICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICBmaWVsZDogY29sb3JWaXNWYXIuZmllbGQsXG4gICAgICAgICAgICAgICAgZXhwcmVzc2lvbjogY29sb3JWaXNWYXIudmFsdWVFeHByZXNzaW9uLFxuICAgICAgICAgICAgICAgIGV4cHJlc3Npb25UaXRsZTogY29sb3JWaXNWYXIudmFsdWVFeHByZXNzaW9uVGl0bGUsXG4gICAgICAgICAgICAgICAgc2ltcGxlRmllbGRUeXBlOiBzaW1wbGVGaWVsZFR5cGVzLk5VTUJFUlxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgOiB7XG4gICAgICAgICAgICAgICAgZmllbGQ6IHJlbmRlcmVyLmZpZWxkLFxuICAgICAgICAgICAgICAgIGV4cHJlc3Npb246IHJlbmRlcmVyLnZhbHVlRXhwcmVzc2lvbixcbiAgICAgICAgICAgICAgICBleHByZXNzaW9uVGl0bGU6IHJlbmRlcmVyLnZhbHVlRXhwcmVzc2lvblRpdGxlLFxuICAgICAgICAgICAgICAgIHNpbXBsZUZpZWxkVHlwZTogc2ltcGxlRmllbGRUeXBlcy5OVU1CRVJcbiAgICAgICAgICAgIH07XG4gICAgY29uc3Qgbm9ybWFsaXphdGlvbkZpZWxkID0gb3B0aW9ucy5ub3JtYWxpemF0aW9uRmllbGQgPT09IG51bGxcbiAgICAgICAgPyB1bmRlZmluZWRcbiAgICAgICAgOiBvcHRpb25zLm5vcm1hbGl6YXRpb25GaWVsZFxuICAgICAgICAgICAgPyBvcHRpb25zLm5vcm1hbGl6YXRpb25GaWVsZFxuICAgICAgICAgICAgOiBjb2xvclZpc1ZhclxuICAgICAgICAgICAgICAgID8gY29sb3JWaXNWYXIubm9ybWFsaXphdGlvbkZpZWxkXG4gICAgICAgICAgICAgICAgOiByZW5kZXJlci5ub3JtYWxpemF0aW9uRmllbGQ7XG4gICAgbGV0IHN5bWJvbCA9IHJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvcyAmJiByZW5kZXJlci5jbGFzc0JyZWFrSW5mb3MubGVuZ3RoXG4gICAgICAgID8gcmVuZGVyZXIuY2xhc3NCcmVha0luZm9zWzBdLnN5bWJvbFxuICAgICAgICA6IGdldERlZmF1bHRTeW1ib2wobGF5ZXIsIG1hcFZpZXcsIHJlbmRlcmVyVHlwZSk7XG4gICAgaWYgKHN5bWJvbC50eXBlID09PSBcInBpY3R1cmUtbWFya2VyXCIpIHtcbiAgICAgICAgc3ltYm9sID0gZ2V0RGVmYXVsdFN5bWJvbChsYXllciwgbWFwVmlldywgcmVuZGVyZXJUeXBlKTtcbiAgICB9XG4gICAgY29uc3QgZGVmYXVsdFN5bWJvbCA9IHJlbmRlcmVyLmRlZmF1bHRTeW1ib2w7XG4gICAgY29uc3QgZGVmYXVsdExhYmVsID0gcmVuZGVyZXIuZGVmYXVsdExhYmVsO1xuICAgIGxldCBuZWVkTmV3U3RhdGlzdGljcyA9IGZhbHNlO1xuICAgIGlmIChvcHRpb25zLm5vcm1hbGl6YXRpb25GaWVsZCA9PT0gbnVsbCB8fFxuICAgICAgICBvcHRpb25zLm5vcm1hbGl6YXRpb25GaWVsZCB8fFxuICAgICAgICBvcHRpb25zLmZpZWxkSW5mbyB8fFxuICAgICAgICAoYXV0aEluZm8uY2xhc3NpZmljYXRpb25NZXRob2QgPT09IFwibWFudWFsXCIgJiYgIW9wdGlvbnMudGhlbWUpIHx8XG4gICAgICAgIGF1dGhJbmZvLmNsYXNzaWZpY2F0aW9uTWV0aG9kID09PSBcImVxdWFsLWludGVydmFsXCIpIHtcbiAgICAgICAgbmVlZE5ld1N0YXRpc3RpY3MgPSB0cnVlO1xuICAgIH1cbiAgICBjb25zdCBtaW5WYWx1ZSA9IG9wdGlvbnMuZGlzY2FyZE1pbk1heFxuICAgICAgICA/IHVuZGVmaW5lZFxuICAgICAgICA6IGlzRGVmaW5lZChvcHRpb25zLm1pbilcbiAgICAgICAgICAgID8gb3B0aW9ucy5taW5cbiAgICAgICAgICAgIDogbmVlZE5ld1N0YXRpc3RpY3NcbiAgICAgICAgICAgICAgICA/IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgIDogY29sb3JWaXNWYXJcbiAgICAgICAgICAgICAgICAgICAgPyBhdXRoQ29sb3JWaXNWYXIgPT09IG51bGwgfHwgYXV0aENvbG9yVmlzVmFyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhdXRoQ29sb3JWaXNWYXIubWluU2xpZGVyVmFsdWVcbiAgICAgICAgICAgICAgICAgICAgOiByZW5kZXJlci5jbGFzc0JyZWFrSW5mb3NbMF0ubWluVmFsdWU7XG4gICAgY29uc3QgbWF4VmFsdWUgPSBvcHRpb25zLmRpc2NhcmRNaW5NYXhcbiAgICAgICAgPyB1bmRlZmluZWRcbiAgICAgICAgOiBpc0RlZmluZWQob3B0aW9ucy5tYXgpXG4gICAgICAgICAgICA/IG9wdGlvbnMubWF4XG4gICAgICAgICAgICA6IG5lZWROZXdTdGF0aXN0aWNzXG4gICAgICAgICAgICAgICAgPyB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICA6IGNvbG9yVmlzVmFyXG4gICAgICAgICAgICAgICAgICAgID8gYXV0aENvbG9yVmlzVmFyID09PSBudWxsIHx8IGF1dGhDb2xvclZpc1ZhciA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXV0aENvbG9yVmlzVmFyLm1heFNsaWRlclZhbHVlXG4gICAgICAgICAgICAgICAgICAgIDogcmVuZGVyZXIuY2xhc3NCcmVha0luZm9zW3JlbmRlcmVyLmNsYXNzQnJlYWtJbmZvcy5sZW5ndGggLSAxXS5tYXhWYWx1ZTtcbiAgICBjb25zdCB0aGVtZSA9IG9wdGlvbnMudGhlbWUgPyBvcHRpb25zLnRoZW1lIDogYXV0aENvbG9yVmlzVmFyID8gYXV0aENvbG9yVmlzVmFyLnRoZW1lIDogXCJoaWdoLXRvLWxvd1wiO1xuICAgIGNvbnN0IHdhc0JlbG93ID0gKGF1dGhDb2xvclZpc1ZhciA9PT0gbnVsbCB8fCBhdXRoQ29sb3JWaXNWYXIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF1dGhDb2xvclZpc1Zhci50aGVtZSkgPT09IFwiYmVsb3dcIjtcbiAgICBjb25zdCBpc0JlbG93ID0gdGhlbWUgPT09IFwiYmVsb3dcIjtcbiAgICBjb25zdCBiZWxvd1N3aXRjaCA9IChpc0JlbG93ICYmICF3YXNCZWxvdykgfHwgKCFpc0JlbG93ICYmIHdhc0JlbG93KTtcbiAgICBsZXQgY29sb3JTY2hlbWUgPSBvcHRpb25zLmNvbG9yU2NoZW1lIHx8IGZpbmRDb2xvclNjaGVtZSh0aGVtZSk7XG4gICAgY29uc3QgY29uZmlnID0ge1xuICAgICAgICBsYXllcixcbiAgICAgICAgdmlldzogbWFwVmlldyxcbiAgICAgICAgZmllbGQ6IGZpZWxkSW5mby5maWVsZCxcbiAgICAgICAgdmFsdWVFeHByZXNzaW9uOiBmaWVsZEluZm8uZXhwcmVzc2lvbixcbiAgICAgICAgdmFsdWVFeHByZXNzaW9uVGl0bGU6IGZpZWxkSW5mby5leHByZXNzaW9uVGl0bGUsXG4gICAgICAgIHRoZW1lLFxuICAgICAgICBjb2xvclNjaGVtZSxcbiAgICAgICAgbm9ybWFsaXphdGlvbkZpZWxkLFxuICAgICAgICBtaW5WYWx1ZSxcbiAgICAgICAgbWF4VmFsdWUsXG4gICAgICAgIG91dGxpbmVPcHRpbWl6YXRpb25FbmFibGVkOiBtYXBJbWFnZVN1YmxheWVyXG4gICAgICAgICAgICA/IGZhbHNlXG4gICAgICAgICAgICA6IGlzRGVmaW5lZChvcHRpb25zLm91dGxpbmVPcHRpbWl6YXRpb25FbmFibGVkKVxuICAgICAgICAgICAgICAgID8gb3B0aW9ucy5vdXRsaW5lT3B0aW1pemF0aW9uRW5hYmxlZFxuICAgICAgICAgICAgICAgIDogISFleHRyYXMuc2l6ZU91dGxpbmVWaXNWYXIsXG4gICAgICAgIHNpemVPcHRpbWl6YXRpb25FbmFibGVkOiBtYXBJbWFnZVN1YmxheWVyXG4gICAgICAgICAgICA/IGZhbHNlXG4gICAgICAgICAgICA6IGlzRGVmaW5lZChvcHRpb25zLnNpemVPcHRpbWl6YXRpb25FbmFibGVkKVxuICAgICAgICAgICAgICAgID8gb3B0aW9ucy5zaXplT3B0aW1pemF0aW9uRW5hYmxlZFxuICAgICAgICAgICAgICAgIDogISFleHRyYXMuc2l6ZUF1dG9WaXNWYXIsXG4gICAgICAgIGxlZ2VuZE9wdGlvbnM6ICgoX2EgPSBvcHRpb25zLmxlZ2VuZE9wdGlvbnMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS50b0pTT04oKSkgfHxcbiAgICAgICAgICAgICgoX2IgPSBjb2xvclZpc1ZhciA9PT0gbnVsbCB8fCBjb2xvclZpc1ZhciA9PT0gdm9pZCAwID8gdm9pZCAwIDogY29sb3JWaXNWYXIubGVnZW5kT3B0aW9ucykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnRvSlNPTigpKSB8fFxuICAgICAgICAgICAgKChfYyA9IHJlbmRlcmVyLmxlZ2VuZE9wdGlvbnMpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy50b0pTT04oKSksXG4gICAgICAgIGRlZmF1bHRTeW1ib2xFbmFibGVkOiBpc0RlZmluZWQob3B0aW9ucy5kZWZhdWx0U3ltYm9sRW5hYmxlZClcbiAgICAgICAgICAgID8gb3B0aW9ucy5kZWZhdWx0U3ltYm9sRW5hYmxlZFxuICAgICAgICAgICAgOiAhIXJlbmRlcmVyLmRlZmF1bHRTeW1ib2wsXG4gICAgICAgIGZvckJpbm5pbmc6ICgoX2QgPSBsYXllci5mZWF0dXJlUmVkdWN0aW9uKSA9PT0gbnVsbCB8fCBfZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2QudHlwZSkgPT09IFwiYmlubmluZ1wiXG4gICAgfTtcbiAgICByZXR1cm4gbW9kdWxlcy5Db2xvckNyZWF0b3IuY3JlYXRlQ29udGludW91c1JlbmRlcmVyKGNvbmZpZykudGhlbihcbiAgICAvLyBjb25zb2xlLmxvZyhcIkNvbG9yQ3JlYXRvci5jcmVhdGVDb250aW51b3VzUmVuZGVyZXJcIiwgY29uZmlnKTtcbiAgICAocmVzdWx0KSA9PiB7XG4gICAgICAgIC8vIHJlc2V0IGhhbmRsZXMgaWYgbmVjZXNzYXJ5XG4gICAgICAgIGlmIChvcHRpb25zLmRpc2NhcmRNaW5NYXgpIHtcbiAgICAgICAgICAgIGNvbnN0IGNvbG9yVmlzVmFyID0gZ2V0VmlzVmFyKHJlbmRlcmVyLCBcImNvbG9yXCIpO1xuICAgICAgICAgICAgY29uc3QgbmV3Q29sb3JWaXNWYXIgPSBnZXRWaXNWYXIocmVzdWx0LnJlbmRlcmVyLCBcImNvbG9yXCIpO1xuICAgICAgICAgICAgY29sb3JWaXNWYXIuc3RvcHMuZm9yRWFjaCgoc3RvcCwgaWR4KSA9PiAoc3RvcC52YWx1ZSA9IG5ld0NvbG9yVmlzVmFyLnN0b3BzW2lkeF0udmFsdWUpKTtcbiAgICAgICAgfVxuICAgICAgICBhcHBseUV4dHJhVmlzVmFycyhleHRyYXMsIHJlc3VsdC5yZW5kZXJlcik7XG4gICAgICAgIGlmIChzeW1ib2wgJiYgcmVzdWx0LnJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvcyAmJiByZXN1bHQucmVuZGVyZXIuY2xhc3NCcmVha0luZm9zLmxlbmd0aCkge1xuICAgICAgICAgICAgcmVzdWx0LnJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvc1swXS5zeW1ib2wgPSBzeW1ib2w7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGRlZmF1bHRTeW1ib2wpIHtcbiAgICAgICAgICAgIHJlc3VsdC5yZW5kZXJlci5kZWZhdWx0U3ltYm9sID0gZGVmYXVsdFN5bWJvbDtcbiAgICAgICAgICAgIHJlc3VsdC5yZW5kZXJlci5kZWZhdWx0TGFiZWwgPSBkZWZhdWx0TGFiZWw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGJlbG93U3dpdGNoICYmIGNvbG9yU2NoZW1lICYmIGNvbG9yVmlzVmFyKSB7XG4gICAgICAgICAgICAvLyBuZWVkIHRvIHJldmVyc2UgY29sb3Igb3JkZXJcbiAgICAgICAgICAgIGNvbnN0IG5ld0NvbG9yVmlzVmFyID0gZ2V0VmlzVmFyKHJlc3VsdC5yZW5kZXJlciwgXCJjb2xvclwiKTtcbiAgICAgICAgICAgIGNvbnN0IGxlbiA9IGNvbG9yVmlzVmFyLnN0b3BzLmxlbmd0aCAtIDE7XG4gICAgICAgICAgICBuZXdDb2xvclZpc1Zhci5zdG9wcy5mb3JFYWNoKChjb2xvclN0b3AsIGlkeCkgPT4gKGNvbG9yU3RvcC5jb2xvciA9IGNvbG9yVmlzVmFyLnN0b3BzW2xlbiAtIGlkeF0uY29sb3IpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlc3VsdCk7XG4gICAgfSwgKGVycm9yKSA9PiBQcm9taXNlLnJlamVjdChlcnJvcikpO1xufVxuLyoqXG4gKiBDcmVhdGVzIGEgQWdlLUNvbG9yIHJlbmRlcmVyIHdpdGggc2V0dGluZ3MgZnJvbSBjdXJyZW50IHJlbmRlcmVyXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZUNvbG9yQWdlUmVuZGVyZXJGcm9tRXhpc3Rpbmcob3B0aW9ucykge1xuICAgIHZhciBfYSwgX2I7XG4gICAgY29uc3QgeyBsYXllcjogc21MYXllciwgbWFwSW1hZ2VTdWJsYXllciwgbWFwVmlldyAvKiAsIHN1cHBvcnRzQXJjYWRlICovLCBtb2R1bGVzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICBjb25zdCBsYXllciA9IHNtTGF5ZXI7XG4gICAgLyogaWYgKG1hcEltYWdlU3VibGF5ZXIgJiYgIXN1cHBvcnRzQXJjYWRlKSB7XG4gICAgICByZXR1cm4gY3JlYXRlQ2xhc3NlZENvbG9yUmVuZGVyZXJGcm9tRXhpc3Rpbmcob3B0aW9ucyk7XG4gICAgfSAqL1xuICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuICAgIGNvbnN0IHJlbmRlcmVyID0gZ2V0UmVuZGVyZXIobGF5ZXIpO1xuICAgIGNvbnN0IHJlbmRlcmVyVHlwZSA9IGdldFJlbmRlcmVyVHlwZSgpO1xuICAgIGNvbnN0IGNvbG9yVmlzVmFyID0gZ2V0VmlzVmFyKHJlbmRlcmVyLCBcImNvbG9yXCIpO1xuICAgIGlmIChjb2xvclZpc1ZhciAmJiBvcHRpb25zLmZpZWxkSW5mb3MgJiYgb3B0aW9ucy5maWVsZEluZm9zWzBdICYmIG9wdGlvbnMuZmllbGRJbmZvc1swXS5maWVsZCA9PSBjb2xvclZpc1Zhci5maWVsZCkge1xuICAgICAgICAvLyBubyBjaGFuZ2VzIHRvIGZpZWxkXG4gICAgICAgIGRlbGV0ZSBvcHRpb25zLmZpZWxkSW5mb3M7XG4gICAgICAgIGlmIChpc0VtcHR5KG9wdGlvbnMpKSB7XG4gICAgICAgICAgICAvLyBub3RoaW5nIHJlYWxseSBjaGFuZ2VzXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgcmVuZGVyZXI6IHJlbmRlcmVyLmNsb25lKCkgfSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgZXh0cmFzID0gc2F2ZUV4dHJhVmlzVmFycyhyZW5kZXJlcik7XG4gICAgY29uc3QgYXV0aENvbG9yVmlzVmFyID0gZ2V0QXV0aFZpc1ZhcihyZW5kZXJlciwgXCJjb2xvclwiKTtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBvcHRpb25zLnN0YXJ0VGltZSA/IG9wdGlvbnMuc3RhcnRUaW1lIDogYXV0aENvbG9yVmlzVmFyLnN0YXJ0VGltZTtcbiAgICBjb25zdCBlbmRUaW1lID0gb3B0aW9ucy5lbmRUaW1lID8gb3B0aW9ucy5lbmRUaW1lIDogYXV0aENvbG9yVmlzVmFyLmVuZFRpbWU7XG4gICAgY29uc3Qgc3ltYm9sID0gcmVuZGVyZXIuY2xhc3NCcmVha0luZm9zICYmIHJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvcy5sZW5ndGhcbiAgICAgICAgPyByZW5kZXJlci5jbGFzc0JyZWFrSW5mb3NbMF0uc3ltYm9sXG4gICAgICAgIDogZ2V0RGVmYXVsdFN5bWJvbChsYXllciwgbWFwVmlldywgcmVuZGVyZXJUeXBlKTtcbiAgICBjb25zdCBkZWZhdWx0U3ltYm9sID0gcmVuZGVyZXIuZGVmYXVsdFN5bWJvbDtcbiAgICBjb25zdCBkZWZhdWx0TGFiZWwgPSByZW5kZXJlci5kZWZhdWx0TGFiZWw7XG4gICAgbGV0IHJhbmdlQ2hhbmdlZCA9IGZhbHNlO1xuICAgIGlmIChvcHRpb25zLnN0YXJ0VGltZSB8fCBvcHRpb25zLmVuZFRpbWUgfHwgb3B0aW9ucy51bml0cyB8fCBvcHRpb25zLmZpZWxkSW5mbykge1xuICAgICAgICByYW5nZUNoYW5nZWQgPSB0cnVlO1xuICAgIH1cbiAgICBjb25zdCBtaW5WYWx1ZSA9IG9wdGlvbnMuZGlzY2FyZE1pbk1heFxuICAgICAgICA/IHVuZGVmaW5lZFxuICAgICAgICA6IGlzRGVmaW5lZChvcHRpb25zLm1pbilcbiAgICAgICAgICAgID8gb3B0aW9ucy5taW5cbiAgICAgICAgICAgIDogcmFuZ2VDaGFuZ2VkXG4gICAgICAgICAgICAgICAgPyB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICA6IGF1dGhDb2xvclZpc1ZhclxuICAgICAgICAgICAgICAgICAgICA/IGF1dGhDb2xvclZpc1Zhci5taW5TbGlkZXJWYWx1ZVxuICAgICAgICAgICAgICAgICAgICA6IHJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvc1swXS5taW5WYWx1ZTtcbiAgICBjb25zdCBtYXhWYWx1ZSA9IG9wdGlvbnMuZGlzY2FyZE1pbk1heFxuICAgICAgICA/IHVuZGVmaW5lZFxuICAgICAgICA6IGlzRGVmaW5lZChvcHRpb25zLm1heClcbiAgICAgICAgICAgID8gb3B0aW9ucy5tYXhcbiAgICAgICAgICAgIDogcmFuZ2VDaGFuZ2VkXG4gICAgICAgICAgICAgICAgPyB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICA6IGF1dGhDb2xvclZpc1ZhclxuICAgICAgICAgICAgICAgICAgICA/IGF1dGhDb2xvclZpc1Zhci5tYXhTbGlkZXJWYWx1ZVxuICAgICAgICAgICAgICAgICAgICA6IHJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvc1tyZW5kZXJlci5jbGFzc0JyZWFrSW5mb3MubGVuZ3RoIC0gMV0ubWF4VmFsdWU7XG4gICAgY29uc3QgdGhlbWUgPSBvcHRpb25zLnRoZW1lID8gb3B0aW9ucy50aGVtZSA6IGF1dGhDb2xvclZpc1ZhciA/IGF1dGhDb2xvclZpc1Zhci50aGVtZSA6IFwiaGlnaC10by1sb3dcIjtcbiAgICBjb25zdCBjb25maWcgPSB7XG4gICAgICAgIGxheWVyLFxuICAgICAgICB2aWV3OiBtYXBWaWV3LFxuICAgICAgICBzdGFydFRpbWUsXG4gICAgICAgIGVuZFRpbWUsXG4gICAgICAgIHVuaXQ6IG9wdGlvbnMudW5pdHMgPyBvcHRpb25zLnVuaXRzIDogYXV0aENvbG9yVmlzVmFyLnVuaXRzLFxuICAgICAgICB0aGVtZSxcbiAgICAgICAgY29sb3JTY2hlbWU6IG9wdGlvbnMuY29sb3JTY2hlbWUgfHwgZmluZENvbG9yU2NoZW1lKHRoZW1lKSxcbiAgICAgICAgbWluVmFsdWUsXG4gICAgICAgIG1heFZhbHVlLFxuICAgICAgICBvdXRsaW5lT3B0aW1pemF0aW9uRW5hYmxlZDogbWFwSW1hZ2VTdWJsYXllclxuICAgICAgICAgICAgPyBmYWxzZVxuICAgICAgICAgICAgOiBpc0RlZmluZWQob3B0aW9ucy5vdXRsaW5lT3B0aW1pemF0aW9uRW5hYmxlZClcbiAgICAgICAgICAgICAgICA/IG9wdGlvbnMub3V0bGluZU9wdGltaXphdGlvbkVuYWJsZWRcbiAgICAgICAgICAgICAgICA6ICEhZXh0cmFzLnNpemVPdXRsaW5lVmlzVmFyLFxuICAgICAgICBzaXplT3B0aW1pemF0aW9uRW5hYmxlZDogbWFwSW1hZ2VTdWJsYXllclxuICAgICAgICAgICAgPyBmYWxzZVxuICAgICAgICAgICAgOiBpc0RlZmluZWQob3B0aW9ucy5zaXplT3B0aW1pemF0aW9uRW5hYmxlZClcbiAgICAgICAgICAgICAgICA/IG9wdGlvbnMuc2l6ZU9wdGltaXphdGlvbkVuYWJsZWRcbiAgICAgICAgICAgICAgICA6ICEhZXh0cmFzLnNpemVBdXRvVmlzVmFyLFxuICAgICAgICBsZWdlbmRPcHRpb25zOiBvcHRpb25zLmxlZ2VuZE9wdGlvbnNcbiAgICAgICAgICAgID8gb3B0aW9ucy5sZWdlbmRPcHRpb25zLnRvSlNPTigpXG4gICAgICAgICAgICA6IHJhbmdlQ2hhbmdlZFxuICAgICAgICAgICAgICAgID8gdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgOiAoKF9hID0gY29sb3JWaXNWYXIgPT09IG51bGwgfHwgY29sb3JWaXNWYXIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNvbG9yVmlzVmFyLmxlZ2VuZE9wdGlvbnMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS50b0pTT04oKSkgfHwgKChfYiA9IHJlbmRlcmVyLmxlZ2VuZE9wdGlvbnMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi50b0pTT04oKSksXG4gICAgICAgIGRlZmF1bHRTeW1ib2xFbmFibGVkOiBpc0RlZmluZWQob3B0aW9ucy5kZWZhdWx0U3ltYm9sRW5hYmxlZClcbiAgICAgICAgICAgID8gb3B0aW9ucy5kZWZhdWx0U3ltYm9sRW5hYmxlZFxuICAgICAgICAgICAgOiAhIXJlbmRlcmVyLmRlZmF1bHRTeW1ib2xcbiAgICB9O1xuICAgIHJldHVybiBtb2R1bGVzLkNvbG9yQ3JlYXRvci5jcmVhdGVBZ2VSZW5kZXJlcihjb25maWcpLnRoZW4oXG4gICAgLy8gY29uc29sZS5sb2coXCJDb2xvckNyZWF0b3IuY3JlYXRlQWdlUmVuZGVyZXJcIiwgY29uZmlnKTtcbiAgICAocmVzdWx0KSA9PiB7XG4gICAgICAgIC8vIHJlc2V0IGhhbmRsZXMgaWYgbmVjZXNzYXJ5XG4gICAgICAgIGlmIChvcHRpb25zLmRpc2NhcmRNaW5NYXgpIHtcbiAgICAgICAgICAgIGNvbnN0IGNvbG9yVmlzVmFyID0gZ2V0VmlzVmFyKHJlbmRlcmVyLCBcImNvbG9yXCIpO1xuICAgICAgICAgICAgY29uc3QgbmV3Q29sb3JWaXNWYXIgPSBnZXRWaXNWYXIocmVzdWx0LnJlbmRlcmVyLCBcImNvbG9yXCIpO1xuICAgICAgICAgICAgY29sb3JWaXNWYXIuc3RvcHMuZm9yRWFjaCgoc3RvcCwgaWR4KSA9PiAoc3RvcC52YWx1ZSA9IG5ld0NvbG9yVmlzVmFyLnN0b3BzW2lkeF0udmFsdWUpKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBuZXdBdXRoQ29sb3JWaXNWYXIgPSBnZXRBdXRoVmlzVmFyKHJlc3VsdC5yZW5kZXJlciwgXCJjb2xvclwiKTtcbiAgICAgICAgbmV3QXV0aENvbG9yVmlzVmFyLmZpZWxkID0gYXV0aENvbG9yVmlzVmFyLmZpZWxkO1xuICAgICAgICBhcHBseUV4dHJhVmlzVmFycyhleHRyYXMsIHJlc3VsdC5yZW5kZXJlcik7XG4gICAgICAgIGlmIChzeW1ib2wgJiYgcmVzdWx0LnJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvcyAmJiByZXN1bHQucmVuZGVyZXIuY2xhc3NCcmVha0luZm9zLmxlbmd0aCkge1xuICAgICAgICAgICAgcmVzdWx0LnJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvc1swXS5zeW1ib2wgPSBzeW1ib2w7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGRlZmF1bHRTeW1ib2wpIHtcbiAgICAgICAgICAgIHJlc3VsdC5yZW5kZXJlci5kZWZhdWx0U3ltYm9sID0gZGVmYXVsdFN5bWJvbDtcbiAgICAgICAgICAgIHJlc3VsdC5yZW5kZXJlci5kZWZhdWx0TGFiZWwgPSBkZWZhdWx0TGFiZWw7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXN1bHQpO1xuICAgIH0sIChlcnJvcikgPT4gUHJvbWlzZS5yZWplY3QoZXJyb3IpKTtcbn1cbi8qKlxuICogQ3JlYXRlcyBhIENvbG9yIHJlbmRlcmVyIHdpdGggc2V0dGluZ3MgZnJvbSBjdXJyZW50IHJlbmRlcmVyXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZUNsYXNzZWRDb2xvclJlbmRlcmVyRnJvbUV4aXN0aW5nKG9wdGlvbnMpIHtcbiAgICB2YXIgX2E7XG4gICAgY29uc3QgeyBsYXllcjogc21MYXllciwgbWFwSW1hZ2VTdWJsYXllciwgbWFwVmlldywgbW9kdWxlcyB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgY29uc3QgbGF5ZXIgPSBzbUxheWVyO1xuICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuICAgIGNvbnN0IHJlbmRlcmVyID0gZ2V0UmVuZGVyZXIobGF5ZXIpO1xuICAgIGNvbnN0IGF1dGhJbmZvID0gcmVuZGVyZXIuYXV0aG9yaW5nSW5mbyB8fCB7fTtcbiAgICBjb25zdCBjb2xvclZpc1ZhciA9IGdldFZpc1ZhcihyZW5kZXJlciwgXCJjb2xvclwiKTtcbiAgICBpZiAoIWNvbG9yVmlzVmFyICYmXG4gICAgICAgIG9wdGlvbnMuZmllbGRJbmZvICYmXG4gICAgICAgIG9wdGlvbnMuZmllbGRJbmZvLmZpZWxkID09IHJlbmRlcmVyLmZpZWxkICYmXG4gICAgICAgIG9wdGlvbnMuZmllbGRJbmZvLmV4cHJlc3Npb24gPT0gcmVuZGVyZXIudmFsdWVFeHByZXNzaW9uICYmXG4gICAgICAgIG9wdGlvbnMubm9ybWFsaXphdGlvbkZpZWxkID09PSByZW5kZXJlci5ub3JtYWxpemF0aW9uRmllbGQpIHtcbiAgICAgICAgLy8gbm8gY2hhbmdlcyB0byBmaWVsZHNcbiAgICAgICAgZGVsZXRlIG9wdGlvbnMuZmllbGRJbmZvO1xuICAgICAgICBpZiAoaXNFbXB0eShvcHRpb25zKSkge1xuICAgICAgICAgICAgLy8gbm90aGluZyByZWFsbHkgY2hhbmdlc1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHJlbmRlcmVyOiByZW5kZXJlci5jbG9uZSgpIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGF1dGhDb2xvclZpc1ZhciA9IGdldEF1dGhWaXNWYXIocmVuZGVyZXIsIFwiY29sb3JcIik7XG4gICAgY29uc3QgZXh0cmFzID0gc2F2ZUV4dHJhVmlzVmFycyhyZW5kZXJlcik7XG4gICAgY29uc3QgcmVuZGVyZXJGaWVsZEluZm8gPSB7XG4gICAgICAgIGZpZWxkOiByZW5kZXJlci5maWVsZCxcbiAgICAgICAgZXhwcmVzc2lvbjogcmVuZGVyZXIudmFsdWVFeHByZXNzaW9uLFxuICAgICAgICBleHByZXNzaW9uVGl0bGU6IHJlbmRlcmVyLnZhbHVlRXhwcmVzc2lvblRpdGxlLFxuICAgICAgICBzaW1wbGVGaWVsZFR5cGU6IHNpbXBsZUZpZWxkVHlwZXMuTlVNQkVSXG4gICAgfTtcbiAgICBsZXQgZmllbGRJbmZvID0gb3B0aW9ucy5maWVsZEluZm9zXG4gICAgICAgID8gb3B0aW9ucy5maWVsZEluZm9zWzBdXG4gICAgICAgIDogY29sb3JWaXNWYXJcbiAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgIGZpZWxkOiBjb2xvclZpc1Zhci5maWVsZCxcbiAgICAgICAgICAgICAgICBleHByZXNzaW9uOiBjb2xvclZpc1Zhci52YWx1ZUV4cHJlc3Npb24sXG4gICAgICAgICAgICAgICAgZXhwcmVzc2lvblRpdGxlOiBjb2xvclZpc1Zhci52YWx1ZUV4cHJlc3Npb25UaXRsZSxcbiAgICAgICAgICAgICAgICBzaW1wbGVGaWVsZFR5cGU6IHNpbXBsZUZpZWxkVHlwZXMuTlVNQkVSXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICA6IHJlbmRlcmVyRmllbGRJbmZvO1xuICAgIC8vIG9wdGlvbnMubm9ybWFsaXphdGlvbkZpZWxkID0gbnVsbCBtZWFucyBkb24ndCBzZXQgdGhlIHZhbHVlXG4gICAgY29uc3Qgbm9ybWFsaXphdGlvbkZpZWxkID0gb3B0aW9ucy5ub3JtYWxpemF0aW9uRmllbGQgIT09IHVuZGVmaW5lZFxuICAgICAgICA/IG9wdGlvbnMubm9ybWFsaXphdGlvbkZpZWxkXG4gICAgICAgIDogY29sb3JWaXNWYXJcbiAgICAgICAgICAgID8gY29sb3JWaXNWYXIubm9ybWFsaXphdGlvbkZpZWxkXG4gICAgICAgICAgICA6IHJlbmRlcmVyLm5vcm1hbGl6YXRpb25GaWVsZDtcbiAgICBsZXQgc3ltYm9sO1xuICAgIGlmIChyZW5kZXJlci5jbGFzc0JyZWFrSW5mb3MgJiYgcmVuZGVyZXIuY2xhc3NCcmVha0luZm9zLmxlbmd0aCkge1xuICAgICAgICBjb25zdCBzeW0gPSByZW5kZXJlci5jbGFzc0JyZWFrSW5mb3NbMF0uc3ltYm9sO1xuICAgICAgICBpZiAoW1wic2ltcGxlLWZpbGxcIiwgXCJzaW1wbGUtbWFya2VyXCIsIFwic2ltcGxlLWxpbmVcIiwgXCJjaW1cIl0uaW5kZXhPZihzeW0udHlwZSkgPiAtMSkge1xuICAgICAgICAgICAgc3ltYm9sID0gc3ltO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGRlZmF1bHRTeW1ib2wgPSByZW5kZXJlci5kZWZhdWx0U3ltYm9sO1xuICAgIGNvbnN0IGRlZmF1bHRMYWJlbCA9IHJlbmRlcmVyLmRlZmF1bHRMYWJlbDtcbiAgICAvLyBUT0RPIG5lZWQgdG8ga2VlcCByYW1wXG4gICAgY29uc3QgY2xhc3NpZmljYXRpb25NZXRob2QgPSBvcHRpb25zLmNsYXNzaWZpY2F0aW9uTWV0aG9kXG4gICAgICAgID8gb3B0aW9ucy5jbGFzc2lmaWNhdGlvbk1ldGhvZFxuICAgICAgICA6IGF1dGhJbmZvLmNsYXNzaWZpY2F0aW9uTWV0aG9kICYmIGF1dGhJbmZvLmNsYXNzaWZpY2F0aW9uTWV0aG9kICE9PSBcIm1hbnVhbFwiXG4gICAgICAgICAgICA/IGF1dGhJbmZvLmNsYXNzaWZpY2F0aW9uTWV0aG9kXG4gICAgICAgICAgICA6IFwibmF0dXJhbC1icmVha3NcIjtcbiAgICBjb25zdCBzdGFuZGFyZERldmlhdGlvbkludGVydmFsID0gY2xhc3NpZmljYXRpb25NZXRob2QgPT09IFwic3RhbmRhcmQtZGV2aWF0aW9uXCJcbiAgICAgICAgPyBvcHRpb25zLnN0YW5kYXJkRGV2aWF0aW9uSW50ZXJ2YWxcbiAgICAgICAgICAgID8gb3B0aW9ucy5zdGFuZGFyZERldmlhdGlvbkludGVydmFsXG4gICAgICAgICAgICA6IGF1dGhJbmZvLnN0YW5kYXJkRGV2aWF0aW9uSW50ZXJ2YWxcbiAgICAgICAgICAgICAgICA/IGF1dGhJbmZvLnN0YW5kYXJkRGV2aWF0aW9uSW50ZXJ2YWxcbiAgICAgICAgICAgICAgICA6IDFcbiAgICAgICAgOiB1bmRlZmluZWQ7XG4gICAgbGV0IGtlZXBOdW1DbGFzc2VzID0gdHJ1ZTtcbiAgICBpZiAob3B0aW9ucy5jbGFzc2lmaWNhdGlvbk1ldGhvZCAmJlxuICAgICAgICBvcHRpb25zLmNsYXNzaWZpY2F0aW9uTWV0aG9kICE9PSBhdXRoSW5mby5jbGFzc2lmaWNhdGlvbk1ldGhvZCAmJlxuICAgICAgICAob3B0aW9ucy5jbGFzc2lmaWNhdGlvbk1ldGhvZCA9PT0gXCJzdGFuZGFyZC1kZXZpYXRpb25cIiB8fCBhdXRoSW5mby5jbGFzc2lmaWNhdGlvbk1ldGhvZCA9PT0gXCJzdGFuZGFyZC1kZXZpYXRpb25cIikpIHtcbiAgICAgICAga2VlcE51bUNsYXNzZXMgPSBmYWxzZTtcbiAgICB9XG4gICAgbGV0IG5lZWROZXdTdGF0aXN0aWNzID0gZmFsc2U7XG4gICAgaWYgKG9wdGlvbnMubm9ybWFsaXphdGlvbkZpZWxkICE9PSB1bmRlZmluZWQgfHxcbiAgICAgICAgIWlzU2FtZUZpZWxkSW5mbyhmaWVsZEluZm8sIHJlbmRlcmVyRmllbGRJbmZvKSB8fFxuICAgICAgICBjbGFzc2lmaWNhdGlvbk1ldGhvZCAhPT0gXCJlcXVhbC1pbnRlcnZhbFwiKSB7XG4gICAgICAgIC8vIGNyZWF0b3IgcmV0dXJucyBlcnJvciBpZiBjbGFzc2lmaWNhdGlvbk1ldGhvZCBub3QgZXF1YWwtaW50ZXJ2YWxcbiAgICAgICAgLy8gdG9nZXRoZXIgd2l0aCBtaW4vbWF4VmFsdWVcbiAgICAgICAgbmVlZE5ld1N0YXRpc3RpY3MgPSB0cnVlO1xuICAgIH1cbiAgICBjb25zdCBtaW5WYWx1ZSA9IGlzRGVmaW5lZChvcHRpb25zLm1pbilcbiAgICAgICAgPyBvcHRpb25zLm1pblxuICAgICAgICA6IG5lZWROZXdTdGF0aXN0aWNzXG4gICAgICAgICAgICA/IHVuZGVmaW5lZFxuICAgICAgICAgICAgOiBhdXRoQ29sb3JWaXNWYXJcbiAgICAgICAgICAgICAgICA/IGF1dGhDb2xvclZpc1Zhci5taW5TbGlkZXJWYWx1ZVxuICAgICAgICAgICAgICAgIDogcmVuZGVyZXIuY2xhc3NCcmVha0luZm9zWzBdLm1pblZhbHVlO1xuICAgIGNvbnN0IG1heFZhbHVlID0gaXNEZWZpbmVkKG9wdGlvbnMubWF4KVxuICAgICAgICA/IG9wdGlvbnMubWF4XG4gICAgICAgIDogbmVlZE5ld1N0YXRpc3RpY3NcbiAgICAgICAgICAgID8gdW5kZWZpbmVkXG4gICAgICAgICAgICA6IGF1dGhDb2xvclZpc1ZhclxuICAgICAgICAgICAgICAgID8gYXV0aENvbG9yVmlzVmFyLm1heFNsaWRlclZhbHVlXG4gICAgICAgICAgICAgICAgOiByZW5kZXJlci5jbGFzc0JyZWFrSW5mb3NbcmVuZGVyZXIuY2xhc3NCcmVha0luZm9zLmxlbmd0aCAtIDFdLm1heFZhbHVlO1xuICAgIGxldCBjb2xvclNjaGVtZSA9IG9wdGlvbnMuY29sb3JTY2hlbWUgfHwgZmluZENvbG9yU2NoZW1lKCk7XG4gICAgaWYgKCFjb2xvclNjaGVtZSkge1xuICAgICAgICAvLyB3ZSBhbHNvIHVzZSBhYm92ZS1hbmQtYmVsb3cgY29sb3JzIGZvciBjbGFzc2VkIGNvbG9yIHJlbmRlcmVyXG4gICAgICAgIGNvbG9yU2NoZW1lID0gZmluZENvbG9yU2NoZW1lKFwiYWJvdmUtYW5kLWJlbG93XCIpO1xuICAgIH1cbiAgICByZXR1cm4gbW9kdWxlcy5Db2xvckNyZWF0b3IuY3JlYXRlQ2xhc3NCcmVha3NSZW5kZXJlcih7XG4gICAgICAgIGxheWVyLFxuICAgICAgICB2aWV3OiBtYXBWaWV3LFxuICAgICAgICBmaWVsZDogZmllbGRJbmZvLmZpZWxkLFxuICAgICAgICB2YWx1ZUV4cHJlc3Npb246IGZpZWxkSW5mby5leHByZXNzaW9uLFxuICAgICAgICB2YWx1ZUV4cHJlc3Npb25UaXRsZTogZmllbGRJbmZvLmV4cHJlc3Npb25UaXRsZSxcbiAgICAgICAgbm9ybWFsaXphdGlvbkZpZWxkLFxuICAgICAgICBjbGFzc2lmaWNhdGlvbk1ldGhvZCxcbiAgICAgICAgc3RhbmRhcmREZXZpYXRpb25JbnRlcnZhbCxcbiAgICAgICAgbnVtQ2xhc3NlczogaXNEZWZpbmVkKG9wdGlvbnMubnVtQ2xhc3NlcylcbiAgICAgICAgICAgID8gb3B0aW9ucy5udW1DbGFzc2VzXG4gICAgICAgICAgICA6IGNvbG9yVmlzVmFyIHx8ICFrZWVwTnVtQ2xhc3Nlc1xuICAgICAgICAgICAgICAgID8gNFxuICAgICAgICAgICAgICAgIDogcmVuZGVyZXIuY2xhc3NCcmVha0luZm9zLmxlbmd0aCxcbiAgICAgICAgbWluVmFsdWUsXG4gICAgICAgIG1heFZhbHVlLFxuICAgICAgICBjb2xvclNjaGVtZSxcbiAgICAgICAgb3V0bGluZU9wdGltaXphdGlvbkVuYWJsZWQ6IG1hcEltYWdlU3VibGF5ZXJcbiAgICAgICAgICAgID8gZmFsc2VcbiAgICAgICAgICAgIDogaXNEZWZpbmVkKG9wdGlvbnMub3V0bGluZU9wdGltaXphdGlvbkVuYWJsZWQpXG4gICAgICAgICAgICAgICAgPyBvcHRpb25zLm91dGxpbmVPcHRpbWl6YXRpb25FbmFibGVkXG4gICAgICAgICAgICAgICAgOiAhIWV4dHJhcy5zaXplT3V0bGluZVZpc1ZhcixcbiAgICAgICAgLyogc2l6ZU9wdGltaXphdGlvbkVuYWJsZWQ6IG1hcEltYWdlU3VibGF5ZXJcbiAgICAgICAgICA/IGZhbHNlXG4gICAgICAgICAgOiBpc0RlZmluZWQob3B0aW9ucy5zaXplT3B0aW1pemF0aW9uRW5hYmxlZClcbiAgICAgICAgICA/IG9wdGlvbnMuc2l6ZU9wdGltaXphdGlvbkVuYWJsZWRcbiAgICAgICAgICA6ICEhZXh0cmFzLnNpemVBdXRvVmlzVmFyLCBUT0RPIGJlbG93IC4uLiovXG4gICAgICAgIGxlZ2VuZE9wdGlvbnM6IG9wdGlvbnMubGVnZW5kT3B0aW9ucyB8fCByZW5kZXJlci5sZWdlbmRPcHRpb25zLFxuICAgICAgICBkZWZhdWx0U3ltYm9sRW5hYmxlZDogaXNEZWZpbmVkKG9wdGlvbnMuZGVmYXVsdFN5bWJvbEVuYWJsZWQpXG4gICAgICAgICAgICA/IG9wdGlvbnMuZGVmYXVsdFN5bWJvbEVuYWJsZWRcbiAgICAgICAgICAgIDogISFyZW5kZXJlci5kZWZhdWx0U3ltYm9sLFxuICAgICAgICBmb3JCaW5uaW5nOiAoKF9hID0gbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnR5cGUpID09PSBcImJpbm5pbmdcIlxuICAgIH0pLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgICBhcHBseUV4dHJhVmlzVmFycyhleHRyYXMsIHJlc3VsdC5yZW5kZXJlcik7XG4gICAgICAgIGlmIChleHRyYXMuc2l6ZUF1dG9WaXNWYXIpIHtcbiAgICAgICAgICAgIHJlc3VsdC5yZW5kZXJlci52aXN1YWxWYXJpYWJsZXMgPSByZXN1bHQucmVuZGVyZXIudmlzdWFsVmFyaWFibGVzIHx8IFtdO1xuICAgICAgICAgICAgcmVzdWx0LnJlbmRlcmVyLnZpc3VhbFZhcmlhYmxlcy5wdXNoKGV4dHJhcy5zaXplQXV0b1Zpc1Zhcik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHN5bWJvbCAmJiByZXN1bHQucmVuZGVyZXIuY2xhc3NCcmVha0luZm9zKSB7XG4gICAgICAgICAgICByZXN1bHQucmVuZGVyZXIuY2xhc3NCcmVha0luZm9zLm1hcCgoY2xhc3NCcmVha0luZm8pID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBzeW0gPSBzeW1ib2wuY2xvbmUoKTtcbiAgICAgICAgICAgICAgICBhcHBseVN5bWJvbENvbG9yKHN5bSwgZ2V0U3ltYm9sQ29sb3IoY2xhc3NCcmVha0luZm8uc3ltYm9sKSk7XG4gICAgICAgICAgICAgICAgY2xhc3NCcmVha0luZm8uc3ltYm9sID0gc3ltO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGRlZmF1bHRTeW1ib2wpIHtcbiAgICAgICAgICAgIHJlc3VsdC5yZW5kZXJlci5kZWZhdWx0U3ltYm9sID0gZGVmYXVsdFN5bWJvbDtcbiAgICAgICAgICAgIHJlc3VsdC5yZW5kZXJlci5kZWZhdWx0TGFiZWwgPSBkZWZhdWx0TGFiZWw7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXN1bHQpO1xuICAgIH0sIChlcnJvcikgPT4gUHJvbWlzZS5yZWplY3QoZXJyb3IpKTtcbn1cbmZ1bmN0aW9uIGdldENsYXNzQnJlYWtzQ29sb3JzKCkge1xuICAgIGNvbnN0IHsgbGF5ZXIsIG1vZHVsZXMgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgIGNvbnN0IHJlbmRlcmVyID0gZ2V0UmVuZGVyZXIobGF5ZXIpO1xuICAgIHJldHVybiByZW5kZXJlci5jbGFzc0JyZWFrSW5mb3MubWFwKChjbGFzc0JyZWFrSW5mbykgPT4ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgbWluOiBjbGFzc0JyZWFrSW5mby5taW5WYWx1ZSxcbiAgICAgICAgICAgIG1heDogY2xhc3NCcmVha0luZm8ubWF4VmFsdWUsXG4gICAgICAgICAgICBjb2xvcjogZ2V0U3ltYm9sQ29sb3IoY2xhc3NCcmVha0luZm8uc3ltYm9sKVxuICAgICAgICAgICAgICAgID8gZ2V0U3ltYm9sQ29sb3IoY2xhc3NCcmVha0luZm8uc3ltYm9sKS5jbG9uZSgpXG4gICAgICAgICAgICAgICAgOiBuZXcgbW9kdWxlcy5lc3JpQ29sb3IoeyByOiAyNTUsIGc6IDI1NSwgYjogMjU1LCBhOiAxIH0pIC8vIHdoaXRlIGluIHNsaWRlciBmb3IgUE1TXG4gICAgICAgIH07XG4gICAgfSk7XG59XG5mdW5jdGlvbiBzYW1lQ29sb3JGaWVsZChvcHRpb25zKSB7XG4gICAgLy8gbm90IGNoZWNraW5nIGZvciBub3JtYWxpemF0aW9uRmllbGRcbiAgICAvLyB3ZSBrZWVwIGl0IGlmIHRoZSByZW5kZXJlciBoYXMgaXQgYW5kIGl0IGRvZXMgbm90IGdldCBvdmVyd3JpdHRlblxuICAgIGNvbnN0IHsgbGF5ZXIgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgIGNvbnN0IHJlbmRlcmVyID0gZ2V0UmVuZGVyZXIobGF5ZXIpLmNsb25lKCk7XG4gICAgY29uc3QgcmVuZGVyZXJUeXBlID0gZ2V0UmVuZGVyZXJUeXBlKCk7XG4gICAgaWYgKFtcImNvbG9yXCIsIFwiY29sb3Itc2l6ZVwiLCBcImNvbG9yLXNpemUtYWdlXCIsIFwiY29sb3ItYWdlXCIsIFwiY29sb3ItYWdlLXNpemVcIl0uaW5kZXhPZihyZW5kZXJlclR5cGUpID4gLTEgJiZcbiAgICAgICAgb3B0aW9ucy5ub3JtYWxpemF0aW9uRmllbGQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBsZXQgcmVuZGVyRmllbGRJbmZvO1xuICAgICAgICBjb25zdCBjb2xvclZpc1ZhciA9IGdldFZpc1ZhcihyZW5kZXJlciwgXCJjb2xvclwiKTtcbiAgICAgICAgaWYgKGNvbG9yVmlzVmFyKSB7XG4gICAgICAgICAgICAvLyBjb250aW51b3VzXG4gICAgICAgICAgICBpZiAoW1wiY29sb3ItYWdlXCIsIFwiY29sb3ItYWdlLXNpemVcIl0uaW5kZXhPZihyZW5kZXJlclR5cGUpID4gLTEpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBhdXRoQ29sb3JWaXNWYXIgPSBnZXRBdXRoVmlzVmFyKHJlbmRlcmVyLCBcImNvbG9yXCIpO1xuICAgICAgICAgICAgICAgIHJlbmRlckZpZWxkSW5mbyA9IHtcbiAgICAgICAgICAgICAgICAgICAgZmllbGQ6IGF1dGhDb2xvclZpc1Zhci5maWVsZFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICByZW5kZXJGaWVsZEluZm8gPSB7XG4gICAgICAgICAgICAgICAgICAgIGZpZWxkOiBjb2xvclZpc1Zhci5maWVsZCxcbiAgICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbjogY29sb3JWaXNWYXIudmFsdWVFeHByZXNzaW9uLFxuICAgICAgICAgICAgICAgICAgICBleHByZXNzaW9uVGl0bGU6IGNvbG9yVmlzVmFyLnZhbHVlRXhwcmVzc2lvblRpdGxlXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIC8vIGNsYXNzZWRcbiAgICAgICAgICAgIHJlbmRlckZpZWxkSW5mbyA9IHtcbiAgICAgICAgICAgICAgICBmaWVsZDogcmVuZGVyZXIuZmllbGQsXG4gICAgICAgICAgICAgICAgZXhwcmVzc2lvbjogcmVuZGVyZXIudmFsdWVFeHByZXNzaW9uLFxuICAgICAgICAgICAgICAgIGV4cHJlc3Npb25UaXRsZTogcmVuZGVyZXIudmFsdWVFeHByZXNzaW9uVGl0bGVcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGlzU2FtZUZpZWxkSW5mbyhvcHRpb25zLmZpZWxkSW5mb3NbMF0sIHJlbmRlckZpZWxkSW5mbykpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn1cblxuZXhwb3J0IHsgY3JlYXRlQ29sb3JBZ2VSZW5kZXJlciBhcyBhLCBjcmVhdGVDb2xvclJlbmRlcmVyRnJvbUV4aXN0aW5nIGFzIGIsIGNyZWF0ZUNvbG9yUmVuZGVyZXIgYXMgYywgY3JlYXRlQ29sb3JBZ2VSZW5kZXJlckZyb21FeGlzdGluZyBhcyBkLCBjcmVhdGVDbGFzc2VkQ29sb3JSZW5kZXJlckZyb21FeGlzdGluZyBhcyBlLCBnZXRDbGFzc0JyZWFrc0NvbG9ycyBhcyBnLCBzYW1lQ29sb3JGaWVsZCBhcyBzIH07XG5cbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWNvbG9yLWQ2ZGEwYTlhLmpzLm1hcCJdLCJuYW1lcyI6W10sInNvdXJjZVJvb3QiOiIifQ==