"use strict";
(self["webpackChunkexb_client"] = self["webpackChunkexb_client"] || []).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-ad0b4c"],{

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/arcgis-popup_13.entry.js":
/*!******************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/arcgis-popup_13.entry.js ***!
  \******************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   arcgis_popup: () => (/* binding */ ArcgisPopup),
/* harmony export */   arcgis_popup_arcade: () => (/* binding */ ArcgisPopupArcade),
/* harmony export */   arcgis_popup_attachments: () => (/* binding */ ArcgisPopupAttachments),
/* harmony export */   arcgis_popup_attributes: () => (/* binding */ ArcgisPopupAttributes),
/* harmony export */   arcgis_popup_chart: () => (/* binding */ ArcgisPopupChart),
/* harmony export */   arcgis_popup_expressions: () => (/* binding */ ArcgisPopupExpressions),
/* harmony export */   arcgis_popup_field_pick_list: () => (/* binding */ ArcgisPopupFieldPickList),
/* harmony export */   arcgis_popup_image: () => (/* binding */ ArcgisPopupImage),
/* harmony export */   arcgis_popup_main_contentpopover: () => (/* binding */ ArcgisPopupMainContentpopover),
/* harmony export */   arcgis_popup_multimedia: () => (/* binding */ ArcgisPopupMultimedia),
/* harmony export */   arcgis_popup_relationship: () => (/* binding */ ArcgisPopupRelationship),
/* harmony export */   arcgis_popup_richtext: () => (/* binding */ ArcgisPopupRichtext),
/* harmony export */   arcgis_popup_title: () => (/* binding */ ArcgisPopupTitle)
/* harmony export */ });
/* harmony import */ var _index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./index-e3bf7da7.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-e3bf7da7.js");
/* harmony import */ var _locale_050b6db9_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./locale-050b6db9.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/locale-050b6db9.js");
/* harmony import */ var _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./commonEnums-fcf13661.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/commonEnums-fcf13661.js");
/* harmony import */ var _commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./commonFunctions-b0830e9e.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/commonFunctions-b0830e9e.js");
/* harmony import */ var _loadModules_b4ac1247_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./loadModules-b4ac1247.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/loadModules-b4ac1247.js");
/* harmony import */ var _guid_aeaed84d_js__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./guid-aeaed84d.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/guid-aeaed84d.js");
/* harmony import */ var _previewPopup_2acb9488_js__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./previewPopup-2acb9488.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/previewPopup-2acb9488.js");
/* harmony import */ var _languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./languageUtil-ef0e54b2.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/languageUtil-ef0e54b2.js");
/* harmony import */ var _functional_44de8fcf_js__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./functional-44de8fcf.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/functional-44de8fcf.js");
/* harmony import */ var _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ./popupStore-85381453.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/popupStore-85381453.js");
/* harmony import */ var _dom_4d367677_js__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ./dom-4d367677.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/dom-4d367677.js");
/* harmony import */ var _index_05956cab_js__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! ./index-05956cab.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-05956cab.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v4.0.58
 */













const CSS$6 = {
    enablePopup: "enable-popup",
    componentDiv: "component-ul",
    summaryET: "summary-et",
    summaryETLabel: "summary-et-label",
    summaryETAction: "summary-et-action",
    imageryOptions: "imagery-options",
    notice: "notice"
};

// add field at cursor if position is available
const addSelectedFieldAtCursor = (inputElement, selectedFieldName) => {
    var _a, _b;
    const position = (_b = (_a = inputElement === null || inputElement === void 0 ? void 0 : inputElement.shadowRoot) === null || _a === void 0 ? void 0 : _a.querySelector("input")) === null || _b === void 0 ? void 0 : _b.selectionStart;
    if (isDefined(position)) {
        return [inputElement.value.slice(0, position), `{${selectedFieldName}}`, inputElement.value.slice(position)].join("");
    }
    else {
        return `${inputElement.value}{${selectedFieldName}}`;
    }
};
const isDefined = (value) => {
    return value !== undefined && value !== null;
};
const layerHasRelatedRecords = async (layer, view, serviceType) => {
    var _a, _b, _c, _d, _e;
    const supportsCount = (_b = (_a = layer.capabilities) === null || _a === void 0 ? void 0 : _a.queryRelated) === null || _b === void 0 ? void 0 : _b.supportsCount;
    const supportsPagination = (_d = (_c = layer.capabilities) === null || _c === void 0 ? void 0 : _c.queryRelated) === null || _d === void 0 ? void 0 : _d.supportsPagination;
    if ([_commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.feature, _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.scene].indexOf(serviceType) > -1 &&
        ((_e = layer === null || layer === void 0 ? void 0 : layer.relationships) === null || _e === void 0 ? void 0 : _e.length) &&
        supportsCount &&
        supportsPagination) {
        for (const relationship of layer.relationships) {
            // check table and layers, including group layers in map view
            // return true if any related layer/table is found in the map
            for (const currLayerOrTable of [...view.map.allLayers, ...view.map.allTables]) {
                const curr = currLayerOrTable;
                if (await relationshipExists(layer, curr, relationship)) {
                    await curr.load();
                    return Promise.resolve(true);
                }
            }
        }
    }
    return Promise.resolve(false);
};
const getDefaultRelationshipAndLayer = async (layer, view, serviceType) => {
    var _a;
    if ([_commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.feature, _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.scene].indexOf(serviceType) > -1 && ((_a = layer === null || layer === void 0 ? void 0 : layer.relationships) === null || _a === void 0 ? void 0 : _a.length)) {
        for (const relationship of layer.relationships) {
            // check table and layers, including group layers in map view
            for (const currLayerOrTable of [...view.map.allLayers, ...view.map.allTables]) {
                const curr = currLayerOrTable;
                // by default setup relationships based on the 1st layer/table found
                if (await relationshipExists(layer, curr, relationship)) {
                    await curr.load();
                    return { relationship: relationship, currLayer: curr };
                }
            }
        }
    }
};
function trimServerFromUrl(layer) {
    if (layer.type === "feature" && layer.url.toLocaleLowerCase().endsWith("/featureserver")) {
        return layer.url.substring(0, layer.url.length - 14);
    }
    else if (layer.type === "scene" && layer.url.toLocaleLowerCase().endsWith("/sceneserver")) {
        return layer.url.substring(0, layer.url.length - 12);
    }
    return layer.url;
}
async function relationshipExists(layer, relatedLayer, relationship) {
    var _a, _b, _c;
    const sameParent = relatedLayer.url
        ? relatedLayer.url === layer.url || trimServerFromUrl(relatedLayer) === trimServerFromUrl(layer)
        : "type" in relatedLayer.parent &&
            relatedLayer.parent.type === "group" &&
            ((_b = (_a = relatedLayer.parent) === null || _a === void 0 ? void 0 : _a.portalItem) === null || _b === void 0 ? void 0 : _b.id) === ((_c = layer.portalItem) === null || _c === void 0 ? void 0 : _c.id);
    if (["feature", "scene"].indexOf(relatedLayer.type) > -1 && sameParent && !isDefined(relatedLayer.layerId)) {
        // happens in SV
        await relatedLayer.load();
    }
    return Promise.resolve(["feature", "scene"].indexOf(relatedLayer.type) > -1 &&
        sameParent &&
        relatedLayer.layerId === relationship.relatedTableId);
}
function relationshipExistsCheckWithoutLoad(layer, relatedLayer, relationship) {
    var _a, _b, _c;
    const sameParent = relatedLayer.url
        ? relatedLayer.url === layer.url || trimServerFromUrl(relatedLayer) === trimServerFromUrl(layer)
        : "type" in relatedLayer.parent &&
            relatedLayer.parent.type === "group" &&
            ((_b = (_a = relatedLayer.parent) === null || _a === void 0 ? void 0 : _a.portalItem) === null || _b === void 0 ? void 0 : _b.id) === ((_c = layer.portalItem) === null || _c === void 0 ? void 0 : _c.id);
    return (["feature", "scene"].indexOf(relatedLayer.type) > -1 &&
        sameParent &&
        relatedLayer.layerId === relationship.relatedTableId);
}

var ContentSelection;
(function (ContentSelection) {
    ContentSelection["attributes"] = "attributes";
    ContentSelection["attachments"] = "attachments";
    ContentSelection["charts"] = "charts";
    ContentSelection["images"] = "images";
    ContentSelection["richText"] = "richText";
    ContentSelection["summaryET"] = "summaryET";
    ContentSelection["arcade"] = "arcade";
    ContentSelection["relationship"] = "relationship";
})(ContentSelection || (ContentSelection = {}));
var PopupMultiMediaType;
(function (PopupMultiMediaType) {
    PopupMultiMediaType["image"] = "image";
    PopupMultiMediaType["barChart"] = "bar-chart";
    PopupMultiMediaType["columnChart"] = "column-chart";
    PopupMultiMediaType["lineChart"] = "line-chart";
    PopupMultiMediaType["pieChart"] = "pie-chart";
})(PopupMultiMediaType || (PopupMultiMediaType = {}));
var AttachmentDisplayType;
(function (AttachmentDisplayType) {
    AttachmentDisplayType["preview"] = "preview";
    AttachmentDisplayType["list"] = "list";
    AttachmentDisplayType["auto"] = "auto";
})(AttachmentDisplayType || (AttachmentDisplayType = {}));

const getArcadeScript = (expression, layerDisplayType, strings) => {
    if (expression) {
        return expression;
    }
    if (layerDisplayType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster) {
        return defaultClusterPopupScript(strings);
    }
    return defaultPopupScript(strings);
};
const getArcadeProfile = async (layer, mapView, serviceType, popupTemplate, layerDisplayType) => {
    if (layerDisplayType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster) {
        return {
            id: "popup-feature-reduction",
            definitions: {
                $feature: { fields: (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.k)(popupTemplate, false) },
                $aggregatedFeatures: await getAggregatedFeatureSet(mapView, layer, popupTemplate)
            }
        };
    }
    return Object.assign(Object.assign({ id: "popup" }, ((serviceType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.csv ||
        serviceType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.geojson ||
        serviceType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.mapImage ||
        serviceType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.tile) && {
        disabledVariables: ["$layer", "$map", "$datastore"]
    })), { definitions: {
            $feature: layer,
            $layer: layer,
            $map: mapView.map,
            $datastore: layer
        } });
};
const getTestData = async (layer, mapView, layerDisplayType, popupTemplate) => {
    try {
        if (layerDisplayType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster) {
            return {
                profileVariableInstances: {
                    $feature: await (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.l)(mapView, layer, popupTemplate),
                    $aggregatedFeatures: await getAggregatedFeatureSet(mapView, layer, popupTemplate)
                },
                spatialReference: mapView.spatialReference,
                timeZone: mapView.timeZone
            };
        }
        return {
            profileVariableInstances: {
                $feature: (await (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.m)(layer, mapView)).features[0],
                $layer: layer,
                $map: mapView.map,
                $datastore: layer.url
            },
            spatialReference: mapView.spatialReference,
            timeZone: mapView.timeZone
        };
    }
    catch (error) {
        console.log(error);
    }
};
const getTemplates = (strings) => {
    return [
        {
            label: strings.templates,
            suggestions: [
                {
                    label: strings.chartTemplate,
                    code: chartTemplate()
                },
                {
                    label: strings.fieldsListTemplate,
                    code: fieldTemplate()
                },
                {
                    label: strings.richText,
                    code: richTextTemplate()
                }
            ]
        }
    ];
};
const getAggregatedFeatureSet = async (mapView, layer, popupTemplate) => {
    const layerView = await mapView.whenLayerView(layer);
    const q = layerView.createQuery();
    q.aggregateIds = [(await (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.l)(mapView, layer, popupTemplate)).getObjectId()];
    return layerView.queryFeatures(q);
};
const defaultPopupScript = (strings) => {
    return `// ${strings.arcadeScriptLine1} \n// ${strings.arcadeScriptLine2}\n// Average($feature.SalesQ1, $feature.SalesQ2, $feature.SalesQ3, $feature.SalesQ4)\n`;
};
const defaultClusterPopupScript = (strings) => {
    return `// ${strings.clusterArcadeScriptLine3} \nExpects($aggregatedFeatures, "field1", "field2")\n\n// ${strings.clusterArcadeScriptLine1} \n// ${strings.clusterArcadeScriptLine2}\n// Count(Filter($aggregatedFeatures, "field1 = 'value'"))\n`;
};
const defaultContentMessage = (layerDisplayType, strings) => {
    const clusterMessage = `// ${strings.arcadeContentClusterScriptLine} \nExpects($aggregatedFeatures, "field1", "field2")\n\n`;
    const defaultMessage = `/* \n${strings.arcadeContentScriptLine1} \n${strings.arcadeContentScriptLine2} \nhttps://developers.arcgis.com/arcade/guide/profiles/#popup-element \n*/\n\n${richTextTemplate()}`;
    return layerDisplayType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster ? clusterMessage + defaultMessage : defaultMessage;
};
const richTextTemplate = () => {
    return `return { \n\ttype : 'text', \n\ttext : 'place your text or html here' //this property supports html tags \n}`;
};
const fieldTemplate = () => {
    return `return {
    type: 'fields',
    //title: '',
    //description : '',
    fieldInfos:  [{
          fieldName: "att1"  // fieldName should match the key in the attributes dictionary
        },
        {
          fieldName: "att2"  // fieldName should match the key in the attributes dictionary
        },
        {
          fieldName: "att3"  // fieldName should match the key in the attributes dictionary
        }],
    attributes : {att1 : 2, att2 : 3, att3 : 4}  // replace this dictionary with your own key-value pairs
  }`;
};
const chartTemplate = () => {
    return `return {
    type: 'media',
    // title : 'The title for all media in the element',
    // description : '',
    attributes : {att1 : 2, att2 : 3, att3 : 4},  // replace this dictionary with your own key-value pairs,
    mediaInfos: [{
        type : 'piechart', //linechart | barchart | piechart | columnchart
        title : 'give your chart a title',
        // caption : '',
        altText : '', //altText will be read by screen readers
        value : {
          fields: ["att1", "att2", "att3"],  // choose what attributes to use in the chart
          /* colors: [  // values must be an array of [r, g, b, a] values (0-255)
            [122, 190, 229, 255],
            [179, 155, 213, 255],
            [248, 174, 131, 255]
          ], */
          //normalizeField : '',  // the name of the attribute to normalize by or value
        }
      }]
  }`;
};
const getClusterFieldInfos = (popupTemplate, FieldInfo) => {
    var _a;
    const clusterFieldInfos = [];
    // remove expressions
    popupTemplate.fieldInfos.forEach((fieldInfo) => {
        if (!fieldInfo.fieldName.includes(_commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.f.expression)) {
            clusterFieldInfos.push(fieldInfo);
        }
    });
    // add potential new and existing expressions
    (_a = popupTemplate.expressionInfos) === null || _a === void 0 ? void 0 : _a.forEach(async (expressionInfo) => {
        const tempFieldInfo = new FieldInfo();
        tempFieldInfo.fieldName = `${_commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.f.expression}${expressionInfo.name}`;
        tempFieldInfo.visible = false;
        clusterFieldInfos.push(tempFieldInfo);
    });
    return clusterFieldInfos;
};
const getExpressioName = (popupTemplate, arcadeFieldName) => {
    var _a;
    if (arcadeFieldName) {
        return arcadeFieldName;
    }
    else {
        if ((_a = popupTemplate.expressionInfos) === null || _a === void 0 ? void 0 : _a.length) {
            const tempExp = popupTemplate.expressionInfos[popupTemplate.expressionInfos.length - 1];
            const matches = tempExp.name.match(/\d+$/);
            if (matches === null || matches === void 0 ? void 0 : matches[0]) {
                return `expr${Number(matches[0]) + 1}`;
            }
            else {
                return `expr${popupTemplate.expressionInfos.length}`;
            }
        }
        else {
            return "expr0";
        }
    }
};
const setExpressionInfoInPopupTemplate = (objectArcadeEditor, currentArcadeFieldName, PopupExpressionInfo, popupTemplate) => {
    const tempCurrentArcadeFieldName = currentArcadeFieldName;
    const tempExp = new PopupExpressionInfo();
    tempExp.expression = objectArcadeEditor.script;
    tempExp.title = objectArcadeEditor.title;
    tempExp.name = getExpressioName(popupTemplate, tempCurrentArcadeFieldName);
    tempExp.returnType = objectArcadeEditor.predictOutputType === "number" ? "number" : "string";
    if (popupTemplate.expressionInfos) {
        if (tempCurrentArcadeFieldName) {
            popupTemplate.expressionInfos.find((exp, index) => {
                if (exp.name === tempCurrentArcadeFieldName) {
                    popupTemplate.expressionInfos[index] = tempExp;
                }
            });
        }
        else {
            popupTemplate.expressionInfos.push(tempExp);
        }
    }
    else {
        popupTemplate.expressionInfos = [tempExp];
    }
    return tempExp;
};
const setLayerExpressionAndFieldInfo = async (popupTemplate, layerDisplayType, layer, FieldInfo) => {
    if (layerDisplayType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster) {
        layer.featureReduction.popupTemplate.expressionInfos =
            [...popupTemplate.expressionInfos];
        popupTemplate.fieldInfos = getClusterFieldInfos(popupTemplate, FieldInfo);
    }
    else {
        layer.popupTemplate.expressionInfos = [...popupTemplate.expressionInfos];
        popupTemplate.fieldInfos = [...(await (0,_previewPopup_2acb9488_js__WEBPACK_IMPORTED_MODULE_6__.g)(layer, popupTemplate))];
    }
};

const arcgisPopupCss = ".enable-popup{background-color:var(--arcgis-app-background);display:flex;padding:var(--arcgis-app-cap-spacing) var(--arcgis-app-cap-spacing-half) var(--arcgis-app-cap-spacing-quarter);border-bottom:solid 1px var(--arcgis-app-border)}.component-ul{margin:0 0 var(--arcgis-app-cap-spacing);padding:0}.summary-et{display:flex;align-items:center;padding:0% var(--arcgis-app-cap-spacing-three-quarters)}.summary-et-label{display:flex;flex-flow:column nowrap;flex:1 0 0%;overflow:hidden;padding:0% var(--arcgis-app-cap-spacing-half);font-size:medium}.summary-et-action{margin:0;flex:0 0 0%;justify-self:flex-end}.notice{margin:0.5rem}.imagery-options{padding:0 var(--arcgis-app-cap-spacing-three-quarters)}.sortable-list{display:block}";

const ArcgisPopup = class {
    constructor(hostRef) {
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
        this.popupUpdated = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "popupUpdated", 7);
        this.arcgisPopupDismissedChange = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisPopupDismissedChange", 7);
        this.internalPopupUpdated = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "internalPopupUpdated", 7);
        this.closePopupPopovers = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
        this.resetMultiMediaIndex = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "resetMultiMediaIndex", 7);
        this.mainPopupReRender = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "mainPopupReRender", 7);
        this.disablePopupPanel = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "disablePopupPanel", 7);
        this.closeAttributePopovers = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closeAttributePopovers", 7);
        this.attributesChangeNotification = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "attributesChangeNotification", 7);
        this.arcadeChangeNotification = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcadeChangeNotification", 7);
        this.attributeData = [];
        this.fieldData = [];
        this.richTextElements = [];
        this.popupHasAttachment = false;
        this.layerHasAttributes = true;
        this.layerHasCharts = true;
        this.layerHasImages = true;
        this.layerHasText = true;
        this.isPopupOpenForCurrentLayer = false;
        this.relatedRecordsDefaultCount = 1;
        this.guidList = [];
        this.debouncedPopupUpdates = (0,_functional_44de8fcf_js__WEBPACK_IMPORTED_MODULE_8__.d)((detail) => {
            var _a;
            if (this.disableEditing) {
                return;
            }
            if (this.serviceType !== _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.wms) {
                // if event.detail is true, only update external
                if (!detail || !((_a = this.layer) === null || _a === void 0 ? void 0 : _a.popupTemplate)) {
                    if (this.layerDisplayType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.feature) {
                        this.layer.popupTemplate = this.popupTemplate.clone();
                    }
                    else if (this.layerDisplayType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster) {
                        this.layer.featureReduction.popupTemplate = this.popupTemplate.clone();
                    }
                }
            }
            this.popupUpdated.emit(this.layerDisplayType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.mapNotes && {
                mapNotesPopuptemplate: this.mapNotesPopupEnabled ? this.popupTemplate.clone() : null
            });
            this.disableEditing = false;
        }, 1000);
        this.manageExpressionBtnClick = (event) => {
            event.stopPropagation();
            this.closePopupPopovers.emit();
            const expressionComponent = document.createElement("arcgis-popup-expressions");
            if (this.calciteFlowProps) {
                this.calciteFlowProps.flow.appendChild(expressionComponent);
            }
            else {
                this.hostElement.shadowRoot.getElementById("popupFlow_Id").appendChild(expressionComponent);
            }
            setTimeout(() => requestAnimationFrame(() => expressionComponent.setFocus()), 200);
        };
        // rendor methods
        this.popupTitleComponent = () => ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-popup-title", { popupFlowItem: this.popupPanel }));
        this.fieldComponent = (uniqueGuid, content, blockOpen) => ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { key: uniqueGuid, id: uniqueGuid }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-popup-attributes", { guid: uniqueGuid, popupContent: content, popupFlowItem: this.popupPanel, blockOpen: blockOpen })));
        this.attachmentComponent = (uniqueGuid, content, blockOpen) => {
            var _a, _b, _c;
            return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { key: uniqueGuid, id: uniqueGuid }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-popup-attachments", { guid: uniqueGuid, attachmentContent: content, layerSupportsResizeAttachments: ((_c = (_b = (_a = this.layer) === null || _a === void 0 ? void 0 : _a.capabilities) === null || _b === void 0 ? void 0 : _b.operations) === null || _c === void 0 ? void 0 : _c.supportsResizeAttachments)
                    ? true
                    : false, popupFlowItem: this.popupPanel, blockOpen: blockOpen })));
        };
        this.richtextComponent = (uniqueGuid, content, blockOpen) => {
            // sketch/mapNotes layers have no fieldInfos
            var _a, _b;
            const popupData = this.popupTemplate.toJSON();
            const fieldData = (_a = popupData.fieldInfos) === null || _a === void 0 ? void 0 : _a.map(({ fieldName, label }) => {
                return {
                    name: fieldName,
                    alias: label || fieldName
                };
            });
            this.fieldData = fieldData || [];
            // the only way to see the current arcade expressions in the color picker plugin is if it is first
            // added in before the richtext editor component is mounted on initially
            const expressionInfos = (_b = this.popupTemplate) === null || _b === void 0 ? void 0 : _b.toJSON().expressionInfos;
            const newExpressionData = expressionInfos === null || expressionInfos === void 0 ? void 0 : expressionInfos.map(({ expression, name, returnType, title }) => {
                return {
                    name: `expression/${name}`,
                    alias: title === "New expression" ? " " : title,
                    type: returnType,
                    description: expression
                };
            });
            if (newExpressionData === null || newExpressionData === void 0 ? void 0 : newExpressionData.length) {
                this.fieldData = this.fieldData.filter((field) => !newExpressionData.some((expression) => expression.name === field.name));
            }
            this.attributeData = newExpressionData
                ? [...newExpressionData, ...this.fieldData]
                : this.fieldData;
            return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { key: uniqueGuid, id: uniqueGuid, ref: (el) => {
                    if (el) {
                        this.richTextElements = [...this.richTextElements, el];
                    }
                } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-popup-richtext", { fieldExpressionData: {
                    data: this.attributeData,
                    placeholderText: this.strings.searchFields,
                    heading: this.strings.selectField,
                    label: this.strings.fieldsListPluginName,
                    mapView: this.mapView,
                    layer: this.layer
                }, arcgisColorPickerData: {
                    data: this.attributeData,
                    filterPlaceholder: this.strings.searchAttributes,
                    label: this.strings.colorPicker,
                    doneText: this.strings.done,
                    customText: this.strings.customText,
                    attributeText: this.strings.attributeText
                }, guid: uniqueGuid, richtextContent: content, popupFlowItem: this.popupPanel, blockOpen: blockOpen })));
        };
        this.multimediaComponent = (uniqueGuid, content, blockOpen) => ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { key: uniqueGuid, id: uniqueGuid }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-popup-multimedia", { guid: uniqueGuid, multimediaContent: content, popupFlowItem: this.popupPanel, blockOpen: blockOpen })));
        this.arcadeComponent = (uniqueGuid, content, blockOpen) => ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { key: uniqueGuid, id: uniqueGuid }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-popup-arcade", { guid: uniqueGuid, arcadeContent: content, blockOpen: blockOpen })));
        this.relationshipComponent = (uniqueGuid, content, blockOpen) => ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { key: uniqueGuid, id: uniqueGuid }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-popup-relationship", { guid: uniqueGuid, relatedRecordsContent: content, popupFlowItem: this.popupPanel, blockOpen: blockOpen })));
        this.mapView = undefined;
        this.layer = undefined;
        this.portal = undefined;
        this.displayPopup = true;
        this.config = undefined;
        this.layerDisplayType = _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.feature;
        this.dismissible = false;
        this.backButton = false;
        this.hideLayerTitle = false;
        this.showConfigureFields = false;
        this.showManageExpressions = true;
        this.disableEditing = false;
        this.calciteFlowProps = null;
        this.mapNotesPopupTemplate = undefined;
        this.mapNotesGraphic = undefined;
        this.reRender = undefined;
        this.popupComponents = [];
        this.hasError = false;
    }
    // lifecycle methods
    async componentWillLoad() {
        var _a, _b, _c;
        // popupState here has the settings from the last
        // session of this component instead of a clean new one
        // because createStore gets called just once in a app session
        // so instead call a clear method, as a workaround
        (0,_popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.c)(_popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p);
        [this.strings, this.currentLanguage, this.currentLanguageIntl] =
            await (0,_locale_050b6db9_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement);
        this.serviceType = (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.c)(this.layer);
        await this.loadAllModules();
        // determine if to show manage expressions and also arcade content
        this.supportsArcade =
            this.showManageExpressions &&
                (this.layerDisplayType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.feature ||
                    this.layerDisplayType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster) &&
                this.serviceType !== _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.ogcFeature &&
                this.serviceType !== _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.wfs &&
                this.serviceType !== _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.imagery &&
                this.serviceType !== _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.imageryTile &&
                this.serviceType !== _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.subtype;
        if (this.serviceType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.tile &&
            "url" in this.layer &&
            !("type" in this.layer) &&
            this.layer.url.indexOf(this.layer.layer.url) > -1) {
            // JS-API does the check if a related FL exists
            this.hasError = true;
            console.error("popups not supported, no related feature service");
        }
        else if (this.serviceType !== _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.wms) {
            if (this.layerDisplayType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.feature) {
                const layerType = "type" in this.layer ? this.layer.type : "sublayer";
                const sourceLayer = this.mapView.popup.visible
                    ? (_a = this.mapView.popup.selectedFeature) === null || _a === void 0 ? void 0 : _a.sourceLayer
                    : undefined;
                this.isPopupOpenForCurrentLayer =
                    layerType === "subtype-sublayer"
                        ? (sourceLayer === null || sourceLayer === void 0 ? void 0 : sourceLayer.subtypeCode) === this.layer.subtypeCode &&
                            (sourceLayer === null || sourceLayer === void 0 ? void 0 : sourceLayer.parent.id) === this.layer.parent.id // TODO any + parent
                        : layerType === "sublayer"
                            ? (sourceLayer === null || sourceLayer === void 0 ? void 0 : sourceLayer.id) === this.layer.id &&
                                (sourceLayer === null || sourceLayer === void 0 ? void 0 : sourceLayer.layer.id) === this.layer.layer.id
                            : "id" in this.layer && (sourceLayer === null || sourceLayer === void 0 ? void 0 : sourceLayer.id) === this.layer.id;
                // does layer have attachment
                if (isDefined((_c = (_b = this.layer.capabilities) === null || _b === void 0 ? void 0 : _b.data) === null || _c === void 0 ? void 0 : _c.supportsAttachment)) {
                    this.layerHasAttachment = this.layer.capabilities.data.supportsAttachment;
                }
                this.layerHasET = this.layer.editFieldsInfo ? true : false;
                _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasRelatedRecords = await layerHasRelatedRecords(this.layer, this.mapView, this.serviceType);
                // temp, turn off popupEnabled for MIL
                if (this.serviceType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.mapImage &&
                    !this.layer.popupTemplate) {
                    this.layer.popupEnabled = false;
                }
                // generate default if template is empty
                this.popupTemplate = this.layer.popupTemplate
                    ? this.layer.popupTemplate.clone()
                    : this.layer.createPopupTemplate();
                // generate master field info
                this.popupTemplate.fieldInfos = [
                    ...(await (0,_previewPopup_2acb9488_js__WEBPACK_IMPORTED_MODULE_6__.g)(this.layer, this.popupTemplate))
                ];
            }
            else if (this.layerDisplayType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster) {
                this.layerHasAttachment = false;
                this.layerHasET = false;
                this.popupTemplate = this.layer.featureReduction.popupTemplate.clone();
            }
            else if (this.layerDisplayType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.mapNotes) {
                if (this.mapNotesPopupTemplate) {
                    this.mapNotesPopupEnabled = true;
                    this.popupTemplate = this.mapNotesPopupTemplate.clone();
                }
                else {
                    this.mapNotesPopupEnabled = false;
                    const [PopupTemplate] = await (0,_loadModules_b4ac1247_js__WEBPACK_IMPORTED_MODULE_4__.l)([
                        "esri/PopupTemplate"
                    ]);
                    this.popupTemplate = new PopupTemplate();
                }
                this.layerHasAttachment = false;
                this.layerHasET = false;
                this.layerHasAttributes = false;
                this.layerHasCharts = false;
            }
        }
        _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layer = this.layer;
        _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.mapView = this.mapView;
        _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.portal = this.portal;
        _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.config = this.config;
        _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.strings = this.strings;
        _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.currentLanguage = this.currentLanguage;
        _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.currentLanguageIntl = this.currentLanguageIntl;
        _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.serviceType = this.serviceType;
        _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate = this.popupTemplate;
        _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasAttachment = this.layerHasAttachment;
        _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasET = this.layerHasET;
        _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasAttributes = this.layerHasAttributes;
        _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasCharts = this.layerHasCharts;
        _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasImages = this.layerHasImages;
        _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasText = this.layerHasText;
        _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layerDisplayType = this.layerDisplayType;
        _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.supportsArcade = this.supportsArcade;
    }
    async componentDidLoad() {
        var _a;
        // load content only once popupFlowItem exists
        // popupTemplate.content can be [], string, function and promise
        // if string, convert to text content
        if (this.popupTemplate) {
            if (typeof this.popupTemplate.content === "string") {
                const textContent = await (0,_loadModules_b4ac1247_js__WEBPACK_IMPORTED_MODULE_4__.l)(["esri/popup/content/TextContent"]).then(([TextContent]) => {
                    return new TextContent({
                        text: this.popupTemplate.content
                    });
                });
                this.popupTemplate.content = [textContent];
            }
            if (Array.isArray(this.popupTemplate.content)) {
                this.popupTemplate.content.forEach((content, index) => {
                    // if layer has no attachment, remove it
                    if (content.type === "attachments" && !this.layerHasAttachment) {
                        this.popupTemplate.content.splice(index, 1);
                    }
                    else {
                        this.addToPopupComponents(content);
                    }
                });
            }
            else {
                console.error("content not supported");
            }
            this.reRender = !this.reRender;
        } // else WMS
        if (this.serviceType !== _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.wms) {
            // watch for changes to layers/tables to show/hide relationship
            if (this.layerDisplayType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.feature) {
                this.watchForChangesToLayersList();
            }
            this.sortableComponents = this.hostElement.shadowRoot.getElementById("SortableComponents_Id");
            this.calciteFab =
                ((_a = this.calciteFlowProps) === null || _a === void 0 ? void 0 : _a.calciteFab) ||
                    this.hostElement.shadowRoot.getElementById("addComponentBtn_Id");
            const tempPopupProp = this.getPopupEnabledProp();
            this.enableDisablePopup(tempPopupProp);
            //this.showPreviewPopup(tempPopupProp); - setupResizeObserver opens the popup already
            // MV workflow
            this.setupResizeObserver();
            // fab for content popover
            this.calciteFab.onclick = (event) => {
                event.stopPropagation();
                this.closePopupPopovers.emit();
                if (!this.contentPopover) {
                    this.contentPopover = document.createElement("arcgis-popup-main-contentpopover");
                    this.contentPopover.contentPopoverRefElement = this.calciteFab;
                    this.contentPopover.popupHasAttachment = this.popupHasAttachment;
                    this.contentPopover.popoverPanelWidth = this.hostElement.getBoundingClientRect().width;
                    document.body.appendChild(this.contentPopover);
                    this.calciteFab.disabled = true;
                    this.disablePopupPanel.emit(true);
                }
            };
        }
        requestAnimationFrame(() => this.popupPanel.setFocus());
    }
    componentDidUpdate() {
        this.internalPopupUpdated.emit();
    }
    disconnectedCallback() {
        var _a, _b;
        (_a = this.parentShellObserver) === null || _a === void 0 ? void 0 : _a.disconnect();
        (_b = this.watchLayersAndTables) === null || _b === void 0 ? void 0 : _b.remove();
        if (this.contentPopover) {
            document.body.removeChild(this.contentPopover);
        }
    }
    // Public Methods
    async done() {
        var _a;
        this.resetMultiMediaIndex.emit();
        this.closePopupPopovers.emit();
        (_a = this.attributesComponent) === null || _a === void 0 ? void 0 : _a.done();
        this.showPreviewPopup(false);
    }
    /**
     * @deprecated with 3.0.x
     * @param focusId
     **/
    async setFocus(focusId) {
        var _a;
        (_a = this.calciteFab) === null || _a === void 0 ? void 0 : _a.setFocus();
    }
    async update() {
        this.internalPopupUpdated.emit();
    }
    // Events
    calciteFlowItemBackHandler(event) {
        event.stopPropagation();
        this.closePopupPopovers.emit();
    }
    mainPopupReRenderHandler(event) {
        event.stopPropagation();
        this.reRender = this.reRender ? false : true;
    }
    // update popup
    internalPopupUpdatedHandler(event) {
        var _a, _b;
        event.stopPropagation();
        // refresh popup in case it's in a drill-in state
        if (this.singleFeature && ((_b = (_a = this.mapView.popup) === null || _a === void 0 ? void 0 : _a._flowItems) === null || _b === void 0 ? void 0 : _b.length)) {
            this.mapView.popup.features = undefined;
            // waiting here makes sure it doesn't refresh twice
            // a timeout of at least 0 is needed to reset the features list
            setTimeout(() => (this.mapView.popup.features = [this.singleFeature]), 1000);
        }
        this.debouncedPopupUpdates(event.detail);
    }
    deleteComponentHandler(event) {
        event.stopPropagation();
        this.closePopupPopovers.emit();
        // each div has id. Find id, and splice by index
        const allComponents = this.sortableComponents.getElementsByTagName("div");
        for (let x = 0; x < allComponents.length; x++) {
            if (allComponents[x].id === event.detail) {
                this.popupTemplate.content.splice(x, 1);
                this.popupComponents.splice(x, 1);
                this.guidList.splice(x, 1);
                break;
            }
        }
        // only allow 1 attachment
        this.popupHasAttachment = this.popupTemplate.content.some((content) => {
            if (content.type === "attachments") {
                return true;
            }
        });
        if (this.richTextElements) {
            // Remove the reference to the rich text editor if the rich text editor is being destroyed
            const newElements = this.richTextElements.filter((ref) => ref.id !== event.detail);
            this.richTextElements = newElements;
        }
        this.mainPopupReRender.emit();
        this.calciteFab.setFocus();
    }
    duplicateComponentHandler(event) {
        event.stopPropagation();
        this.closePopupPopovers.emit();
        // each div has id. Find id, and clone
        const allComponents = this.sortableComponents.getElementsByTagName("div");
        for (let x = 0; x < allComponents.length; x++) {
            if (allComponents[x].id === event.detail) {
                const tempContent = this.popupTemplate.content[x].clone();
                this.popupTemplate.content.push(tempContent);
                this.addToPopupComponents(tempContent, true);
                break;
            }
        }
    }
    closePopupPopoversHandler() {
        if (this.contentPopover) {
            document.body.removeChild(this.contentPopover);
            this.contentPopover = null;
            this.calciteFab.disabled = false;
            requestAnimationFrame(() => this.calciteFab.setFocus());
            this.disablePopupPanel.emit(false);
        }
    }
    notifyAddContentSelectionHandler(event) {
        event.stopPropagation();
        this.closePopupPopovers.emit();
        // editor tracking
        if (event.detail === ContentSelection.summaryET) {
            this.popupTemplate.lastEditInfoEnabled = true;
            this.mainPopupReRender.emit();
            this.summaryETDiv.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "start" });
            this.calciteFab.setFocus();
        }
        else {
            this.addPopupContents(event.detail);
        }
    }
    disablePopupPanelHandler(event) {
        var _a;
        event.stopPropagation();
        const panel = ((_a = this.calciteFlowProps) === null || _a === void 0 ? void 0 : _a.calciteFlowItem) || this.popupPanel;
        panel.disabled = event.detail;
    }
    //updates to attributes
    async attributesUpdatedHandler(event) {
        event.stopPropagation();
        this.popupTemplate.fieldInfos = [
            ...(await (0,_previewPopup_2acb9488_js__WEBPACK_IMPORTED_MODULE_6__.g)(this.layer, this.layer.popupTemplate || this.popupTemplate))
        ];
        if (this.layer.popupTemplate.expressionInfos) {
            this.popupTemplate.expressionInfos = [
                ...this.layer.popupTemplate.expressionInfos
            ];
            this.arcadeChangeNotification.emit();
        }
        this.attributesChangeNotification.emit();
        this.mainPopupReRender.emit();
    }
    // for arcade changes
    arcadeChangeNotificationHandler() {
        var _a;
        // if an arcade expression is added/removed, update the selection of expressions in the rich
        // text editor's color picker plugin
        if (this.richTextElements) {
            const newExpressionData = (_a = this.popupTemplate) === null || _a === void 0 ? void 0 : _a.toJSON().expressionInfos.map(({ expression, name, returnType, title }) => {
                return {
                    name: `expression/${name}`,
                    alias: title === "New expression" ? " " : title,
                    type: returnType,
                    description: expression
                };
            });
            this.attributeData = newExpressionData
                ? [...newExpressionData, ...this.fieldData]
                : this.fieldData;
            // updating the state here manually here since the rich text editor will not listen for changes in state
            // in initialization - we do not need to keep list of expressions in a state decorator either
            this.richTextElements.forEach((el) => {
                const richTextElement = el.firstChild;
                richTextElement.arcgisColorPickerData.data = this.attributeData;
                richTextElement.fieldExpressionData.data = this.attributeData;
            });
        }
        this.mainPopupReRender.emit();
    }
    // private methods and properties
    async loadAllModules() {
        [this.LayerOptions, this.reactiveUtils] = await (0,_loadModules_b4ac1247_js__WEBPACK_IMPORTED_MODULE_4__.l)([
            "esri/popup/LayerOptions",
            "esri/core/reactiveUtils"
        ]);
    }
    watchForChangesToLayersList() {
        var _a, _b;
        if (this.layerDisplayType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.feature &&
            this.serviceType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.feature &&
            ((_b = (_a = this.layer) === null || _a === void 0 ? void 0 : _a.relationships) === null || _b === void 0 ? void 0 : _b.length)) {
            this.watchLayersAndTables = this.reactiveUtils.watch(() => [this.mapView.map.allLayers.length, this.mapView.map.allTables.length], async () => {
                _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasRelatedRecords = await layerHasRelatedRecords(this.layer, this.mapView, this.serviceType);
            });
        }
    }
    enableDisablePopup(popupBool) {
        // hide rest of the component.
        if (this.serviceType !== _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.wms) {
            const popupDiv = this.hostElement.shadowRoot.getElementById("popupDiv_Id");
            popupDiv.style.display = popupBool ? "block" : "none";
            this.calciteFab.style.display = popupBool ? "block" : "none";
        }
        this.closePopupPopovers.emit();
    }
    getPopupEnabledProp() {
        switch (this.layerDisplayType) {
            case _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.feature: {
                if (this.serviceType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.wms) {
                    return this.layer.popupEnabled;
                }
                else {
                    return this.layer.popupTemplate
                        ? this.layer.popupEnabled
                        : false;
                }
            }
            case _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster: {
                return this.layer.featureReduction.popupEnabled;
            }
            case _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.mapNotes: {
                return this.mapNotesPopupEnabled;
            }
            default: {
                return this.layer.popupEnabled;
            }
        }
    }
    reorder(arr, oldIdxs, newIdxs) {
        const oldArr = [...arr];
        arr.length = 0;
        oldArr.forEach((item, idx) => {
            let newIdx;
            newIdxs.forEach((guid, idx2) => {
                if (oldIdxs[idx] === guid) {
                    newIdx = idx2;
                }
            });
            arr[newIdx] = item;
        });
    }
    addToPopupComponents(content, blockOpen = false) {
        const newGuid = (0,_guid_aeaed84d_js__WEBPACK_IMPORTED_MODULE_5__.g)();
        if (content.type === "fields") {
            this.popupComponents = [
                ...this.popupComponents,
                this.fieldComponent(newGuid, content, blockOpen)
            ];
            this.guidList = [...this.guidList, newGuid];
        }
        else if (content.type === "attachments") {
            this.popupComponents = [
                ...this.popupComponents,
                this.attachmentComponent(newGuid, content, blockOpen)
            ];
            this.popupHasAttachment = true;
            this.guidList = [...this.guidList, newGuid];
        }
        else if (content.type === "media") {
            this.popupComponents = [
                ...this.popupComponents,
                this.multimediaComponent(newGuid, content, blockOpen)
            ];
            this.guidList = [...this.guidList, newGuid];
        }
        else if (content.type === "text") {
            this.popupComponents = [
                ...this.popupComponents,
                this.richtextComponent(newGuid, content, blockOpen)
            ];
            this.guidList = [...this.guidList, newGuid];
        }
        else if (content.type === "expression") {
            this.popupComponents = [
                ...this.popupComponents,
                this.arcadeComponent(newGuid, content, blockOpen)
            ];
            this.guidList = [...this.guidList, newGuid];
        }
        else if (content.type === "relationship") {
            this.popupComponents = [
                ...this.popupComponents,
                this.relationshipComponent(newGuid, content, blockOpen)
            ];
            this.guidList = [...this.guidList, newGuid];
        }
    }
    async addPopupContents(popupContentType) {
        const [FieldsContent, AttachmentsContent, TextContent, MediaContent, ImageMediaInfo, ColumnChartMediaInfo, ImageMediaInfoValue, ChartMediaInfoValue, ExpressionContent, RelationshipContent] = await (0,_loadModules_b4ac1247_js__WEBPACK_IMPORTED_MODULE_4__.l)([
            "esri/popup/content/FieldsContent",
            "esri/popup/content/AttachmentsContent",
            "esri/popup/content/TextContent",
            "esri/popup/content/MediaContent",
            "esri/popup/content/ImageMediaInfo",
            "esri/popup/content/ColumnChartMediaInfo",
            "esri/popup/content/support/ImageMediaInfoValue",
            "esri/popup/content/support/ChartMediaInfoValue",
            "esri/popup/content/ExpressionContent",
            "esri/popup/content/RelationshipContent"
        ]);
        let content = null;
        if (popupContentType === ContentSelection.attributes) {
            content = new FieldsContent({
                fieldInfos: null
            });
        }
        else if (popupContentType === ContentSelection.attachments) {
            content = new AttachmentsContent({
                displayType: null
            });
        }
        else if (popupContentType === ContentSelection.richText) {
            content = new TextContent({
                text: null
            });
        }
        else if (popupContentType === ContentSelection.images) {
            const imageElement = new ImageMediaInfo({
                title: "",
                caption: "",
                altText: "",
                value: new ImageMediaInfoValue({
                    sourceURL: "",
                    linkURL: ""
                })
            });
            content = new MediaContent({
                mediaInfos: [imageElement]
            });
        }
        else if (popupContentType === ContentSelection.charts) {
            const chartElement = new ColumnChartMediaInfo({
                title: "",
                caption: "",
                altText: "",
                value: new ChartMediaInfoValue({
                    fields: []
                })
            });
            content = new MediaContent({
                mediaInfos: [chartElement]
            });
        }
        else if (popupContentType === ContentSelection.arcade) {
            content = new ExpressionContent({
                expressionInfo: {
                    expression: defaultContentMessage(this.layerDisplayType, this.strings)
                }
            });
        }
        else if (popupContentType === ContentSelection.relationship) {
            const relationshipAndLayer = await getDefaultRelationshipAndLayer(this.layer, this.mapView, this.serviceType);
            let defaultField = relationshipAndLayer.currLayer.fields.find((field) => field.visible && field.type === "date");
            if (!defaultField) {
                defaultField = relationshipAndLayer.currLayer.fields.find((field) => field.visible);
            }
            content = new RelationshipContent({
                displayCount: this.relatedRecordsDefaultCount,
                relationshipId: relationshipAndLayer.relationship.id,
                orderByFields: [{ field: defaultField.name, order: "asc" }]
            });
        }
        this.popupTemplate.content.push(content);
        this.addToPopupComponents(content, true);
    }
    async showPreviewPopup(show) {
        var _a, _b, _c;
        if (this.displayPopup &&
            this.layerDisplayType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.feature &&
            !this.isPopupOpenForCurrentLayer) {
            if (show &&
                this.layer.popupEnabled &&
                this.layer.popupTemplate) {
                if ((_b = (_a = this.mapView.popup) === null || _a === void 0 ? void 0 : _a.features) === null || _b === void 0 ? void 0 : _b.length) {
                    // if we have a popup, maybe from another layer
                    // make sure we don't stay in a drill-in state
                    // popup might not be visible at this moment
                    this.mapView.closePopup();
                    this.mapView.popup.features = undefined;
                }
                this.previewPopupController = new AbortController();
                this.singleFeature = await (0,_previewPopup_2acb9488_js__WEBPACK_IMPORTED_MODULE_6__.p)(this.mapView, this.layer, this.previewPopupController);
            }
            else {
                (_c = this.previewPopupController) === null || _c === void 0 ? void 0 : _c.abort();
                this.mapView.closePopup();
            }
        }
        else if (this.layerDisplayType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.mapNotes) {
            if (show && this.mapNotesGraphic) {
                this.mapView.openPopup({
                    features: [this.mapNotesGraphic],
                    location: (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.o)(this.mapNotesGraphic.geometry)
                });
            }
            else {
                this.mapView.closePopup();
            }
        }
    }
    // if parent is shell panel. MV workflow.
    setupResizeObserver() {
        var _a;
        const parentNode = (_a = this.hostElement) === null || _a === void 0 ? void 0 : _a.parentElement;
        if ((parentNode === null || parentNode === void 0 ? void 0 : parentNode.tagName) === "CALCITE-SHELL-PANEL") {
            const shellPanelNode = parentNode;
            if (isDefined(shellPanelNode.collapsed)) {
                this.parentShellObserver = new ResizeObserver(() => {
                    if (shellPanelNode.collapsed) {
                        this.done();
                    }
                    else {
                        this.showPreviewPopup(true);
                    }
                });
                this.parentShellObserver.observe(shellPanelNode);
            }
        }
        else {
            this.showPreviewPopup(true);
        }
    }
    createLayerOptions() {
        var _a, _b;
        const layerOptions = this.popupTemplate.layerOptions || new this.LayerOptions();
        // showNoDataRecords and returnTopmostRaster can be null when not set
        layerOptions.showNoDataRecords = (_a = layerOptions.showNoDataRecords) !== null && _a !== void 0 ? _a : false;
        layerOptions.returnTopmostRaster = (_b = layerOptions.returnTopmostRaster) !== null && _b !== void 0 ? _b : true;
        this.popupTemplate.layerOptions = layerOptions;
    }
    render() {
        var _a, _b, _c, _d, _e, _f;
        if (this.hasError) {
            return this.renderPopupError();
        }
        const enablePopup = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { class: CSS$6.enablePopup, alignment: "start", layout: "inline-space-between" }, this.strings.enablePopup, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-switch", { scale: "s", checked: this.getPopupEnabledProp(), onCalciteSwitchChange: (event) => {
                const checked = event.target.checked;
                switch (this.layerDisplayType) {
                    case _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.feature: {
                        this.layer.popupEnabled = checked;
                        break;
                    }
                    case _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster: {
                        this.layer
                            .featureReduction.popupEnabled = checked;
                        break;
                    }
                    case _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.mapNotes: {
                        this.mapNotesPopupEnabled = checked;
                        break;
                    }
                    default: {
                        this.layer.popupEnabled = checked;
                    }
                }
                this.enableDisablePopup(checked);
                this.internalPopupUpdated.emit(true);
                // layer.popupTemplate can be null, due to debouncedPopupUpdates, causing popup preview to not work
                if (this.layerDisplayType !== _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.mapNotes &&
                    checked &&
                    !this.layer.popupTemplate) {
                    this.layer.popupTemplate = this.popupTemplate;
                }
                this.showPreviewPopup(checked);
            } })));
        const manageExpressionBtn = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { alignment: "icon-end-space-between", appearance: "transparent", kind: "neutral", iconEnd: (0,_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement) === "rtl" ? "chevron-left" : "chevron-right", label: this.strings.manageExpressions, width: "full", onClick: this.manageExpressionBtnClick }, this.strings.manageExpressions));
        const ignoreNodata = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { alignment: "start", layout: "inline-space-between" }, this.strings.ignoreNoData, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-switch", { scale: "s", checked: !((_c = (_b = (_a = this.popupTemplate) === null || _a === void 0 ? void 0 : _a.layerOptions) === null || _b === void 0 ? void 0 : _b.showNoDataRecords) !== null && _c !== void 0 ? _c : false), onCalciteSwitchChange: (event) => {
                var _a;
                const checked = event.target.checked;
                if (!((_a = this.popupTemplate) === null || _a === void 0 ? void 0 : _a.layerOptions)) {
                    this.createLayerOptions();
                }
                this.popupTemplate.layerOptions.showNoDataRecords = !checked;
                this.internalPopupUpdated.emit();
            } })));
        const displayTopmost = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { alignment: "start", layout: "inline-space-between" }, this.strings.displayTopmost, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-switch", { scale: "s", checked: (_f = (_e = (_d = this.popupTemplate) === null || _d === void 0 ? void 0 : _d.layerOptions) === null || _e === void 0 ? void 0 : _e.returnTopmostRaster) !== null && _f !== void 0 ? _f : true, onCalciteSwitchChange: (event) => {
                var _a;
                const checked = event.target.checked;
                if (!((_a = this.popupTemplate) === null || _a === void 0 ? void 0 : _a.layerOptions)) {
                    this.createLayerOptions();
                }
                this.popupTemplate.layerOptions.returnTopmostRaster = checked;
                this.internalPopupUpdated.emit();
            } })));
        const summaryET = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("section", { class: CSS$6.summaryET }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "m", icon: "user" }), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("label", { class: CSS$6.summaryETLabel }, this.strings.summaryETHeading), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: this.strings.remove, appearance: "transparent", icon: "x", class: CSS$6.summaryETAction, onClick: (event) => {
                event.stopPropagation();
                this.closePopupPopovers.emit();
                this.popupTemplate.lastEditInfoEnabled = false;
                this.mainPopupReRender.emit();
                this.calciteFab.setFocus();
            } })));
        const calciteFab = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-fab", { id: "addComponentBtn_Id", icon: "plus", slot: "fab", scale: "s", appearance: "outline-fill", kind: "neutral", label: this.strings.addContent, text: this.strings.addContent, "text-enabled": true }));
        const manageFieldsBtn = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { alignment: "icon-end-space-between", appearance: "transparent", kind: "neutral", iconEnd: (0,_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement) === "rtl" ? "chevron-left" : "chevron-right", label: this.strings.configureFields, width: "full", onClick: (event) => {
                event.stopPropagation();
                this.closePopupPopovers.emit();
                const attributesFlowItem = document.createElement("calcite-flow-item");
                attributesFlowItem.heading = this.strings.attributes;
                attributesFlowItem.description = !this.hideLayerTitle ? this.layer.title : undefined;
                this.attributesComponent = document.createElement("arcgis-attributes");
                this.attributesComponent.lang = this.currentLanguage;
                this.attributesComponent.layer = this.layer;
                this.attributesComponent.mapView = this.mapView;
                this.attributesComponent.portal = this.portal;
                this.attributesComponent.layerDisplayType = this.layerDisplayType;
                this.attributesComponent.config = this.config;
                this.attributesComponent.calciteFlowProps = true;
                this.attributesComponent.displayPopup = false;
                attributesFlowItem.appendChild(this.attributesComponent);
                attributesFlowItem.beforeBack = async () => {
                    this.closeAttributePopovers.emit();
                };
                if (this.calciteFlowProps) {
                    this.calciteFlowProps.flow.appendChild(attributesFlowItem);
                }
                else {
                    this.hostElement.shadowRoot
                        .getElementById("popupFlow_Id")
                        .appendChild(attributesFlowItem);
                }
                setTimeout(() => requestAnimationFrame(() => attributesFlowItem.setFocus()), 200);
            } }, this.strings.configureFields));
        const popupOptions = () => {
            // show popup options if any of the following is true
            const configureFields = this.showConfigureFields;
            const isImagery = this.serviceType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.imagery;
            if (configureFields || this.supportsArcade || isImagery) {
                return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { heading: this.strings.options, open: true, collapsible: true }, isImagery && imageryOptions(), this.supportsArcade && manageExpressionBtn, configureFields && manageFieldsBtn));
            }
        };
        const imageryOptions = () => {
            var _a, _b, _c;
            //enable display topmost if service version is greater than 10.8 and if its mosaic dataset
            //or single raster dataset which is multidimensional
            const layer = this.layer;
            const isMosaicDatasetService = !!((_b = (_a = layer.capabilities) === null || _a === void 0 ? void 0 : _a.operations) === null || _b === void 0 ? void 0 : _b.supportsQuery) && ((_c = layer.fields) === null || _c === void 0 ? void 0 : _c.length);
            const isMultidimensional = layer.hasMultidimensions;
            return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$6.imageryOptions }, ignoreNodata, (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.p)(layer) >= 10.8 &&
                (isMosaicDatasetService || isMultidimensional) &&
                displayTopmost));
        };
        const popupMain = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", null, enablePopup, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { id: "popupDiv_Id" }, popupOptions(), this.popupTitleComponent(), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$6.componentDiv }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-sortable-list", { id: "SortableComponents_Id", class: "sortable-list", onCalciteListOrderChange: (event) => {
                event.stopPropagation();
                this.sortableComponents =
                    this.hostElement.shadowRoot.getElementById("SortableComponents_Id");
                const newGuidList = [];
                const allComponents = this.sortableComponents.getElementsByTagName("div");
                for (let x = 0; x < allComponents.length; x++) {
                    newGuidList.push(allComponents[x].id);
                }
                this.reorder(this.popupTemplate.content, this.guidList, newGuidList);
                this.reorder(this.popupComponents, this.guidList, newGuidList);
                this.guidList = newGuidList;
                this.internalPopupUpdated.emit();
            } }, this.popupComponents)), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { ref: (el) => (this.summaryETDiv = el) }, this.layerHasET && this.popupTemplate.lastEditInfoEnabled && summaryET))));
        const backButton = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: this.strings.back, scale: "s", slot: "header-actions-start", ref: (backButtonEl) => (this.backButtonEl = backButtonEl), onClick: (event) => {
                event.stopPropagation();
                this.done();
                this.arcgisPopupDismissedChange.emit();
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { icon: (0,_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement) === "rtl" ? "chevron-right" : "chevron-left" })));
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.H, { style: this.calciteFlowProps ? {} : { display: "flex", flex: "1 1 auto", overflow: "hidden" } }, this.calciteFlowProps ? ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { dir: (0,_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), ref: () => (this.popupPanel = this.calciteFlowProps.calciteFlowItem) }, this.serviceType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.wms ? enablePopup : popupMain)) : ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow", { id: "popupFlow_Id", dir: (0,_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement) }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { ref: (el) => (this.popupPanel = el), heading: this.strings.popupHeading, description: !this.hideLayerTitle ? this.layer.title : undefined, closable: this.dismissible, onCalciteFlowItemClose: (event) => {
                event.stopPropagation();
                this.done();
                this.arcgisPopupDismissedChange.emit();
            } }, this.serviceType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.wms ? enablePopup : popupMain, this.serviceType !== _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.s.wms && calciteFab, this.backButton && backButton)))));
    }
    renderPopupError() {
        const popupMain = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$6.notice }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-notice", { open: true, closable: false, icon: "exclamation-mark-triangle", scale: "s" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "message" }, " ", this.strings.popupTileError))));
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.H, { style: this.calciteFlowProps ? {} : { display: "flex", flex: "1 1 auto", overflow: "hidden" } }, this.calciteFlowProps ? ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { dir: (0,_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), ref: () => (this.popupPanel = this.calciteFlowProps.calciteFlowItem) }, popupMain)) : ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow", { id: "popupFlow_Id", dir: (0,_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement) }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { ref: (el) => (this.popupPanel = el), heading: this.strings.popupHeading, description: !this.hideLayerTitle ? this.layer.title : undefined, closable: this.dismissible, onCalciteFlowItemClose: (event) => {
                event.stopPropagation();
                this.done();
                this.arcgisPopupDismissedChange.emit();
            } }, popupMain)))));
    }
    get hostElement() { return (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisPopup.style = arcgisPopupCss;

const ArcgisPopupArcade = class {
    constructor(hostRef) {
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
        this.closePopupPopovers = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
        this.internalPopupUpdated = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "internalPopupUpdated", 7);
        this.disablePopupPanel = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "disablePopupPanel", 7);
        this.guid = undefined;
        this.arcadeContent = undefined;
        this.blockOpen = false;
        this.reRender = undefined;
    }
    // lifecycle methods
    async componentWillLoad() {
        this.layer = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layer;
        this.mapView = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.mapView;
        this.portal = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.portal;
        this.config = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.config;
        this.strings = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
        this.currentLanguage = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.currentLanguage;
        this.serviceType = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.serviceType;
        this.popupTemplate = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
        this.layerDisplayType = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layerDisplayType;
    }
    async componentDidLoad() {
        if (this.blockOpen) {
            this.blockOptions.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "start" });
            await this.launchArcade();
        }
    }
    // private methods and properties
    async launchArcade() {
        var _a, _b, _c;
        if (!this.arcadeEditor) {
            this.disablePopupPanel.emit(true);
            this.arcadeEditor = document.createElement("arcgis-modal-arcade");
            this.arcadeEditor.arcadeScript = getArcadeScript((_a = this.arcadeContent.expressionInfo) === null || _a === void 0 ? void 0 : _a.expression, this.layerDisplayType, this.strings);
            this.arcadeEditor.arcadeProfile = await getArcadeProfile(this.layer, this.mapView, this.serviceType, this.popupTemplate, this.layerDisplayType);
            this.arcadeEditor.testData = await getTestData(this.layer, this.mapView, this.layerDisplayType, this.popupTemplate);
            this.arcadeEditor.suggestions = getTemplates(this.strings);
            this.arcadeEditor.addExistingExpressions = true;
            this.arcadeEditor.layer = this.layer;
            this.arcadeEditor.arcadeTitle =
                ((_b = this.arcadeContent.expressionInfo) === null || _b === void 0 ? void 0 : _b.title) || this.strings.arcadeDefaultTitle;
            this.arcadeEditor.arcadeTitleEditable = true;
            this.arcadeEditor.returnPredictOutputType = false;
            this.arcadeEditor.arcadeTitleEditingEnabled = !((_c = this.arcadeContent.expressionInfo) === null || _c === void 0 ? void 0 : _c.title);
            document.body.appendChild(this.arcadeEditor);
            this.arcadeEditor.addEventListener("arcgisModalArcadeClose", (event) => this.arcadeSetup(event.detail));
        }
    }
    async arcadeSetup(arcadeObject) {
        if (arcadeObject) {
            this.arcadeContent.expressionInfo.expression = arcadeObject.script;
            this.arcadeContent.expressionInfo.title = arcadeObject.title;
            this.reRender = !this.reRender;
            this.internalPopupUpdated.emit();
        }
        this.disablePopupPanel.emit(false);
        document.body.removeChild(this.arcadeEditor);
        this.arcadeEditor = null;
    }
    render() {
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.H, null, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { dir: (0,_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), heading: this.strings.arcade, description: this.arcadeContent.expressionInfo.title, collapsible: true, open: this.blockOpen, dragHandle: true }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable", slot: "control" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-calcite-block-options", { ref: (el) => (this.blockOptions = el), guid: this.guid, intlOptions: this.strings.options, intlDelete: this.strings.delete, intlDuplicate: this.strings.duplicate, calciteBlockOptions: { hasDelete: true, hasDuplicate: true } })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "icon" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "m", icon: "code" })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "transparent", width: "full", onClick: async () => await this.launchArcade() }, this.strings.editExpression)))));
    }
    get hostElement() { return (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};

const CSS$5 = {
    listWarningDiv: "list-warning-div",
    listWarningIcon: "list-warning-icon",
    listWarningLabel: "list-warning-label",
    listWarningText: "list-warning-text",
    formInputButton: "form-input-button"
};

const arcgisPopupAttachmentsCss = ".list-warning-div{background-color:var(--arcgis-app-background)}.list-warning-label{align-items:stretch;background-color:var(--arcgis-app-background);border-radius:var(--arcgis-app-border-radius);border:1px solid var(--arcgis-app-border);display:flex;font-size:var(--arcgis-app-font-size--2)}.list-warning-icon{align-items:center;background-color:var(--arcgis-app-background-content);display:flex;padding:0 var(--arcgis-app-side-spacing-half)}.list-warning-text{padding:var(--arcgis-app-cap-spacing-quarter) var(--arcgis-app-side-spacing-half)}.form-input-button{display:flex}.form-input-button calcite-input[type=text]{display:flex;flex-flow:column nowrap;flex:1 0 0%;overflow:hidden}.form-input-button calcite-action{margin:0;flex:0 0 0%;justify-self:flex-end}";

const ArcgisPopupAttachments = class {
    constructor(hostRef) {
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
        this.closePopupPopovers = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
        this.internalPopupUpdated = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "internalPopupUpdated", 7);
        this.disablePopupPanel = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "disablePopupPanel", 7);
        this.formInput = (formType, formString, formInputElement, formValue, formPlaceholder
        // promptMessage: string
        ) => {
            var _a;
            return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { scale: "s" }, formString, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$5.formInputButton }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { type: "text", autofocus: true, ref: formInputElement, value: formValue, placeholder: formPlaceholder, onCalciteInputInput: (event) => {
                    event.stopPropagation();
                    const inputVal = event.target.value;
                    if (formType === "title") {
                        this.attachmentContent.title = inputVal;
                    }
                    else {
                        this.attachmentContent.description = inputVal;
                    }
                    this.reRender = !this.reRender;
                }, onClick: () => this.closePopupPopovers.emit() }), ((_a = this.popupTemplate.fieldInfos) === null || _a === void 0 ? void 0 : _a.length) > 0 && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: this.strings.attributes, onClick: () => {
                    this.closePopupPopovers.emit();
                    if (!this.popupFieldSelectionPickList) {
                        this.popupFieldSelectionPickList = document.createElement("arcgis-popup-field-pick-list");
                        this.popupFieldSelectionPickList.popoverProps = {
                            refElement: this.popupFlowItem
                        };
                        this.popupFieldSelectionPickList.multiple = false;
                        this.popupFieldSelectionPickList.heading = this.strings.addField;
                        this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListDismissed", () => {
                            this.closePopupPopovers.emit();
                        });
                        this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListChange", (event) => this.popupFieldSelectionPickListChanges(event, formType));
                        document.body.appendChild(this.popupFieldSelectionPickList);
                        this.disablePopupPanel.emit(true);
                    }
                }, scale: "s", icon: "brackets-curly" })))));
        };
        this.guid = undefined;
        this.attachmentContent = undefined;
        this.layerSupportsResizeAttachments = undefined;
        this.blockOpen = false;
        this.popupFlowItem = undefined;
        this.reRender = undefined;
    }
    // lifecycle methods
    componentWillLoad() {
        this.strings = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
        this.popupTemplate = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
        if (this.layerSupportsResizeAttachments) {
            if (!this.attachmentContent.displayType) {
                this.attachmentContent.displayType = AttachmentDisplayType.auto;
                // temp
                this.internalPopupUpdated.emit();
            }
        }
        else {
            this.attachmentContent.displayType = AttachmentDisplayType.list;
        }
        if (!this.attachmentContent.title) {
            this.attachmentContent.title = "";
        }
        if (!this.attachmentContent.description) {
            this.attachmentContent.description = "";
        }
    }
    componentDidLoad() {
        if (this.blockOpen) {
            this.blockOptions.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "start" });
            this.blockOptions.setFocus();
        }
    }
    componentDidUpdate() {
        this.internalPopupUpdated.emit();
    }
    disconnectedCallback() {
        if (this.popupFieldSelectionPickList) {
            document.body.removeChild(this.popupFieldSelectionPickList);
        }
    }
    // Events
    calciteBlockToggleHandler() {
        this.closePopupPopovers.emit();
    }
    closePopupPopoversHandler() {
        if (this.popupFieldSelectionPickList) {
            document.body.removeChild(this.popupFieldSelectionPickList);
            this.popupFieldSelectionPickList = null;
            this.disablePopupPanel.emit(false);
        }
    }
    // field selection for title and caption
    popupFieldSelectionPickListChanges(event, formType) {
        const selectedFieldName = event.detail.selectedFields[0];
        if (formType === "title") {
            this.contentTitle.value = addSelectedFieldAtCursor(this.contentTitle, selectedFieldName);
            this.contentTitle.setFocus();
            this.attachmentContent.title = this.contentTitle.value;
        }
        else if (formType === "description") {
            this.contentDescription.value = addSelectedFieldAtCursor(this.contentDescription, selectedFieldName);
            this.contentDescription.setFocus();
            this.attachmentContent.description = this.contentDescription.value;
        }
        this.closePopupPopovers.emit();
        this.reRender = !this.reRender;
    }
    // rendor methods
    render() {
        const attachmentDisplayType = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, this.strings.displayAttachmentsAs, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-segmented-control", { width: "full", scale: "s", disabled: !this.layerSupportsResizeAttachments, onCalciteSegmentedControlChange: (event) => {
                const node = event.target;
                const selectedItem = node.selectedItem;
                this.attachmentContent.displayType = selectedItem.value;
                this.reRender = !this.reRender;
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-segmented-control-item", { value: AttachmentDisplayType.auto, iconStart: "check", checked: this.attachmentContent.displayType === AttachmentDisplayType.auto }, this.strings.auto), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-segmented-control-item", { value: AttachmentDisplayType.list, iconStart: "list", checked: this.attachmentContent.displayType === AttachmentDisplayType.list }, this.strings.list), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-segmented-control-item", { value: AttachmentDisplayType.preview, iconStart: "image", checked: this.attachmentContent.displayType === AttachmentDisplayType.preview }, this.strings.gallery)), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { scale: "s" }, (() => {
            switch (this.attachmentContent.displayType) {
                case AttachmentDisplayType.auto:
                    return this.strings.autoDisplayMessage;
                case AttachmentDisplayType.list:
                    return this.strings.listDisplayMessage;
                case AttachmentDisplayType.preview:
                    return this.strings.previewDisplayMessage;
                default:
                    return this.strings.listDisplayMessage;
            }
        })())));
        const listWarningMessage = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$5.listWarningDiv }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("label", { class: CSS$5.listWarningLabel }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: CSS$5.listWarningIcon }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "exclamation-mark-triangle" })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: CSS$5.listWarningText }, this.strings.layerOnlySupportsListView))));
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.H, null, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { dir: (0,_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), heading: this.strings.attachments, description: (this.attachmentContent.title &&
                `${this.attachmentContent.title.substring(0, 25)}${this.attachmentContent.title.length > 25 ? "..." : ""}`) ||
                (() => {
                    switch (this.attachmentContent.displayType) {
                        case AttachmentDisplayType.auto:
                            return this.strings.auto;
                        case AttachmentDisplayType.list:
                            return this.strings.list;
                        case AttachmentDisplayType.preview:
                            return this.strings.gallery;
                        default:
                            return this.strings.list;
                    }
                })(), collapsible: true, open: this.blockOpen, dragHandle: true }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable", slot: "control" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-calcite-block-options", { ref: (el) => (this.blockOptions = el), guid: this.guid, intlOptions: this.strings.options, intlDelete: this.strings.delete, calciteBlockOptions: { hasDelete: true } })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "icon" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "m", icon: "attachment" })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable" }, this.formInput("title", this.strings.title, (element) => {
            return (this.contentTitle = element);
        }, this.attachmentContent.title, this.strings.enterTitle
        // this.strings.titleContext.replace("${titleContext}", this.strings.attachments_L)
        ), this.formInput("description", this.strings.desc, (element) => {
            return (this.contentDescription = element);
        }, this.attachmentContent.description, this.strings.enterDescription
        // this.strings.descriptionContext.replace(
        //   "${descriptionContext}",
        //   this.strings.attachments_L
        // )
        ), attachmentDisplayType, this.layerSupportsResizeAttachments ? null : listWarningMessage))));
    }
    get hostElement() { return (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisPopupAttachments.style = arcgisPopupAttachmentsCss;

const CSS$4 = {
    manageBtn: "manage-btn",
    formInputButton: "form-input-button"
};

const arcgisPopupAttributesCss = ".manage-btn{justify-content:flex-end;margin:4px 0}.form-input-button{display:flex}.form-input-button calcite-input[type=text]{display:flex;flex-flow:column nowrap;flex:1 0 0%;overflow:hidden}.form-input-button calcite-action{margin:0;flex:0 0 0%;justify-self:flex-end}";

const ArcgisPopupAttributes = class {
    constructor(hostRef) {
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
        this.closePopupPopovers = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
        this.internalPopupUpdated = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "internalPopupUpdated", 7);
        this.disablePopupPanel = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "disablePopupPanel", 7);
        this.pickList = [];
        this.arcadeExpMap = new Map();
        // open popover
        this.manageBtnClick = (event) => {
            event.stopPropagation();
            // close first since we can have multiple attributes open
            this.closePopupPopovers.emit();
            // lazy load attribute manager component
            if (!this.popupFieldManagePickList) {
                this.popupFieldManagePickList = document.createElement("arcgis-popup-field-pick-list");
                this.popupFieldManagePickList.popoverProps = {
                    refElement: this.popupFlowItem
                };
                this.popupFieldManagePickList.selectedFields = this.getSelectedFields();
                this.popupFieldManagePickList.showCancel = false;
                this.popupFieldManagePickList.multiple = true;
                this.popupFieldManagePickList.heading = this.strings.selectFields;
                this.popupFieldManagePickList.okBtnText = this.strings.done;
                this.popupFieldManagePickList.addEventListener("arcgisPopupPickListDismissed", () => {
                    this.closePopupPopovers.emit();
                });
                this.popupFieldManagePickList.addEventListener("arcgisPopupPickListChange", this.popupFieldManagePickListChanges);
                document.body.appendChild(this.popupFieldManagePickList);
                this.disablePopupPanel.emit(true);
            }
        };
        this.popupFieldManagePickListChanges = (event) => {
            var _a;
            event.stopPropagation();
            const selectedField = (_a = event.detail) === null || _a === void 0 ? void 0 : _a.selectedFields;
            const fieldInfos = [];
            this.setupFieldMapInfo();
            selectedField.forEach((fieldName) => {
                var _a;
                if (this.fieldInfoMap.has(fieldName)) {
                    const tempField = (_a = this.fieldInfoMap.get(fieldName)) === null || _a === void 0 ? void 0 : _a.clone();
                    tempField.visible = true;
                    fieldInfos.push(tempField);
                }
            });
            this.popupContent.fieldInfos = [...fieldInfos];
            this.reRender = !this.reRender;
        };
        this.calcitePickList = (field) => (
        // field.fieldName is always unique
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-value-list-item", { key: field.fieldName, label: (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.b)(field, this.arcadeExpMap), value: field.fieldName }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { slot: "actions-end", appearance: "transparent", text: this.strings.remove, onClick: () => this.removeBtnClick(field.fieldName) }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "x" }))));
        this.formInput = (formType, formString, formInputElement, formValue, formPlaceholder
        // promptMessage: string
        ) => {
            var _a;
            return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { scale: "s" }, formString, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$4.formInputButton }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { type: "text", autofocus: true, ref: formInputElement, value: formValue, placeholder: formPlaceholder, onCalciteInputInput: (event) => {
                    event.stopPropagation();
                    const inputVal = event.target.value;
                    if (formType === "title") {
                        this.popupContent.title = inputVal;
                    }
                    else {
                        this.popupContent.description = inputVal;
                    }
                    this.reRender = !this.reRender;
                }, onClick: () => this.closePopupPopovers.emit() }), ((_a = this.popupTemplate.fieldInfos) === null || _a === void 0 ? void 0 : _a.length) > 0 && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: this.strings.attributes, onClick: () => {
                    this.closePopupPopovers.emit();
                    if (!this.popupFieldSelectionPickList) {
                        this.popupFieldSelectionPickList = document.createElement("arcgis-popup-field-pick-list");
                        this.popupFieldSelectionPickList.popoverProps = {
                            refElement: this.popupFlowItem,
                            offsetSkidding: 50
                        };
                        this.popupFieldSelectionPickList.multiple = false;
                        this.popupFieldSelectionPickList.heading = this.strings.addField;
                        this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListDismissed", () => {
                            this.closePopupPopovers.emit();
                        });
                        this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListChange", (event) => this.popupFieldSelectionPickListChanges(event, formType));
                        document.body.appendChild(this.popupFieldSelectionPickList);
                        this.disablePopupPanel.emit(true);
                    }
                }, scale: "s", icon: "brackets-curly" })))));
        };
        this.guid = undefined;
        this.popupContent = undefined;
        this.blockOpen = false;
        this.popupFlowItem = undefined;
        this.reRender = undefined;
    }
    // lifecycle methods
    async componentWillLoad() {
        this.layer = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layer;
        this.strings = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
        this.popupTemplate = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
        this.layerDisplayType = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layerDisplayType;
        if (!this.popupContent.fieldInfos) {
            this.popupContent.fieldInfos = await this.getFieldsContent();
        }
        if (!this.popupContent.title) {
            this.popupContent.title = "";
        }
        if (!this.popupContent.description) {
            this.popupContent.description = "";
        }
    }
    componentDidLoad() {
        if (this.blockOpen) {
            this.blockOptions.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "start" });
            this.blockOptions.setFocus();
            this.internalPopupUpdated.emit();
        }
    }
    componentWillRender() {
        this.arcadeExpMap = (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.e)(this.popupTemplate);
        this.setupFieldMapInfo();
        this.pickList = [];
        this.popupContent.fieldInfos.forEach((field) => {
            this.pickList.push(this.calcitePickList(field));
        });
    }
    componentDidUpdate() {
        this.internalPopupUpdated.emit();
    }
    disconnectedCallback() {
        if (this.popupFieldManagePickList) {
            document.body.removeChild(this.popupFieldManagePickList);
        }
        if (this.popupFieldSelectionPickList) {
            document.body.removeChild(this.popupFieldSelectionPickList);
        }
    }
    // Events
    // for arcade changes
    arcadeChangeNotificationHandler() {
        this.reRender = this.reRender ? false : true;
    }
    // for attribute changes
    async attributesChangeNotificationHandler() {
        // update field infos
        this.popupContent.fieldInfos.forEach((field, index) => {
            if (this.fieldInfoMap.has(field.fieldName)) {
                this.popupContent.fieldInfos[index] = this.fieldInfoMap.get(field.fieldName).clone();
                this.popupContent.fieldInfos[index].visible = true;
            }
        });
        this.reRender = !this.reRender;
    }
    closePopupPopoversHandler() {
        if (this.popupFieldManagePickList) {
            document.body.removeChild(this.popupFieldManagePickList);
            this.popupFieldManagePickList = null;
            this.blockOptions.setFocus();
            this.disablePopupPanel.emit(false);
        }
        if (this.popupFieldSelectionPickList) {
            document.body.removeChild(this.popupFieldSelectionPickList);
            this.popupFieldSelectionPickList = null;
            this.disablePopupPanel.emit(false);
        }
    }
    calciteBlockToggleHandler() {
        this.closePopupPopovers.emit();
    }
    calciteListOrderChangeHandler(event) {
        const tempFields = event.detail;
        const tempFieldInfos = [];
        tempFields.forEach((fieldName) => {
            this.popupContent.fieldInfos.find((field) => {
                if (field.fieldName === fieldName) {
                    return tempFieldInfos.push(field);
                }
            });
        });
        this.popupContent.fieldInfos = tempFieldInfos;
        this.internalPopupUpdated.emit();
    }
    // private methods and properties
    async getFieldsContent() {
        var _a, _b;
        let fieldInfos = [];
        if (this.checkForCreateFieldsContent()) {
            const [popupUtils] = await (0,_loadModules_b4ac1247_js__WEBPACK_IMPORTED_MODULE_4__.l)(["esri/support/popupUtils"]);
            // get default from createFieldsContent
            const popupUtilsFieldInfo = (_b = popupUtils.createFieldsContent({
                fields: await (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.j)(this.layer),
                objectIdField: this.layer.objectIdField,
                editFieldsInfo: ((_a = this.layer) === null || _a === void 0 ? void 0 : _a.editFieldsInfo) || null
            })) === null || _b === void 0 ? void 0 : _b.fieldInfos;
            // popupUtilsFieldInfo should have a subset of fieldInfoMap
            // but with differences in format and visibility
            !this.fieldInfoMap && this.setupFieldMapInfo();
            popupUtilsFieldInfo.forEach((fieldInfo) => {
                if (this.fieldInfoMap.has(fieldInfo.fieldName)) {
                    const tempFieldInfo = this.fieldInfoMap.get(fieldInfo.fieldName);
                    fieldInfos.push(tempFieldInfo.clone());
                    fieldInfos[fieldInfos.length - 1].visible = true;
                }
            });
            // add expressions and relationship fields is visible = true
            this.popupTemplate.fieldInfos.forEach((fieldInfo) => {
                if ((fieldInfo.fieldName.includes(_commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.f.expression) ||
                    fieldInfo.fieldName.includes(_commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.f.relationship)) &&
                    fieldInfo.visible) {
                    fieldInfos.push(fieldInfo.clone());
                }
            });
        }
        else {
            // feature reduction, 3x and default case
            this.popupTemplate.fieldInfos.forEach((fieldInfo) => {
                fieldInfo.visible && fieldInfos.push(fieldInfo.clone());
            });
        }
        return fieldInfos;
    }
    checkForCreateFieldsContent() {
        var _a, _b, _c;
        // regular feature or feature reduction
        if (this.layerDisplayType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.feature) {
            // check 1st content for 3x and default use case
            if (((_b = (_a = this.popupTemplate) === null || _a === void 0 ? void 0 : _a.content[0]) === null || _b === void 0 ? void 0 : _b.type) === "fields") {
                if ((_c = this.popupTemplate.content[0]) === null || _c === void 0 ? void 0 : _c.fieldInfos) {
                    // use createFieldsContent
                    return true;
                }
                else {
                    // Default or coming from 3x.
                    // Dont use createFieldsContent, but depend on fieldInfos
                    return false;
                }
            }
            else {
                // 1st element is not field, use createFieldsContent
                return true;
            }
        }
        else {
            // feature reduction
            return false;
        }
    }
    removeBtnClick(fieldName) {
        this.closePopupPopovers.emit();
        this.popupContent.fieldInfos.find((fieldInContent, index) => {
            if (fieldInContent.fieldName === fieldName) {
                return this.popupContent.fieldInfos.splice(index, 1);
            }
        });
        this.reRender = !this.reRender;
    }
    getSelectedFields() {
        const selectedFields = [];
        this.popupContent.fieldInfos.forEach((field) => {
            selectedFields.push(field.fieldName);
        });
        return selectedFields;
    }
    // field selection for title and caption
    popupFieldSelectionPickListChanges(event, formType) {
        const selectedFieldName = event.detail.selectedFields[0];
        if (formType === "title") {
            this.contentTitle.value = addSelectedFieldAtCursor(this.contentTitle, selectedFieldName);
            this.contentTitle.setFocus();
            this.popupContent.title = this.contentTitle.value;
        }
        else if (formType === "description") {
            this.contentDescription.value = addSelectedFieldAtCursor(this.contentDescription, selectedFieldName);
            this.contentDescription.setFocus();
            this.popupContent.description = this.contentDescription.value;
        }
        this.closePopupPopovers.emit();
        this.reRender = !this.reRender;
    }
    setupFieldMapInfo() {
        this.fieldInfoMap = new Map(this.popupTemplate.fieldInfos.map((fieldInfo) => [
            fieldInfo.fieldName,
            fieldInfo
        ]));
    }
    // rendor methods
    render() {
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.H, null, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { dir: (0,_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), heading: this.strings.fieldsList, description: (this.popupContent.title &&
                `${this.popupContent.title.substring(0, 25)}${this.popupContent.title.length > 25 ? "..." : ""}`) ||
                `${this.popupContent.fieldInfos.length}/${this.popupTemplate.fieldInfos.length} ${this.strings.attributes_L}`, collapsible: true, open: this.blockOpen, dragHandle: true }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable", slot: "control" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-calcite-block-options", { ref: (el) => (this.blockOptions = el), guid: this.guid, intlOptions: this.strings.options, intlDelete: this.strings.delete, intlDuplicate: this.strings.duplicate, calciteBlockOptions: { hasDelete: true, hasDuplicate: true } })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "icon" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "m", icon: "feature-details" })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable" }, this.formInput("title", this.strings.title, (element) => {
            return (this.contentTitle = element);
        }, this.popupContent.title, this.strings.enterTitle
        // this.strings.titleContext.replace("${titleContext}", this.strings.attributes_L)
        ), this.formInput("description", this.strings.desc, (element) => {
            return (this.contentDescription = element);
        }, this.popupContent.description, this.strings.enterDescription
        // this.strings.descriptionContext.replace(
        //   "${descriptionContext}",
        //   this.strings.attributes_L
        // )
        ), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { class: CSS$4.manageBtn, appearance: "transparent", scale: "m", width: "full", id: "openManageAttributes_Id", onClick: this.manageBtnClick }, this.strings.selectAttributes), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-value-list", { "drag-enabled": true }, this.pickList)))));
    }
    get hostElement() { return (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisPopupAttributes.style = arcgisPopupAttributesCss;

const CSS$3 = {
    manageBtn: "manage-btn",
    enableColumn: "enable-column",
    enableColumnLabel: "enable-column-label",
    ColumnSwitch: "column-switch",
    normalizeBlock: "normalize-block",
    normalizeContentButtonSection: "normalize-content-btn-section",
    normalizeContentButton: "normalize-content-btn",
    normalizeContentButtonText: "normalize-content-btn-text",
    normalizeContentButtonIcon: "normalize-content-btn-icon",
    popoverChartDiv: "popover-chart-div",
    formInputButton: "form-input-button",
    chartGroup: "chart-group"
};

const arcgisPopupChartCss = ".manage-btn{justify-content:flex-end}.enable-column{background-color:var(--arcgis-app-background);display:flex;padding:var(--arcgis-app-cap-spacing-half) var(--arcgis-app-side-spacing-quarter)}.enable-column-label{display:flex;flex-flow:column nowrap;flex:1 0 0%;overflow:hidden}.column-switch{margin:0;flex:0 0 0%;justify-self:flex-end}.normalize-block{padding:0 var(--arcgis-app-side-spacing-quarter)}.normalize-content-btn-section{background-color:var(--arcgis-app-background);min-width:100%}.normalize-content-btn{background:var(--arcgis-app-background-clear);border:1px solid var(--arcgis-app-border);border-radius:var(--arcgis-app-border-radius);display:flex;align-items:center;justify-content:space-between;padding:var(--arcgis-app-cap-spacing-half) var(--arcgis-app-side-spacing-quarter);cursor:pointer;width:100%;text-align:unset;transition:background-color var(--arcgis-app-animation-time-fast) var(--arcgis-app-easing-function), border-color var(--arcgis-app-animation-time-fast) var(--arcgis-app-easing-function)}.normalize-content-btn:hover{background-color:var(--arcgis-app-background-hover);border-color:var(--arcgis-app-border-hover)}.normalize-content-btn-text{font-family:var(--arcgis-app-font-family);font-size:var(--arcgis-app-font-size-0);flex:0 1 auto;overflow:hidden;padding:0 var(--arcgis-app-side-spacing-eighth);text-overflow:ellipsis;white-space:nowrap}.normalize-content-btn-icon{flex:0 0 0%;padding:0 var(--arcgis-app-side-spacing-half)}.popover-chart-div{background-color:var(--arcgis-app-background);padding:var(--arcgis-app-cap-spacing) var(--arcgis-app-side-spacing-half);max-height:60vh}.form-input-button{display:flex}.form-input-button calcite-input[type=text]{display:flex;flex-flow:column nowrap;flex:1 0 0%;overflow:hidden}.form-input-button calcite-action{margin:0;flex:0 0 0%;justify-self:flex-end}.chart-group{margin-bottom:var(--arcgis-app-cap-spacing-half)}.color-icon{width:18px;height:18px;border-radius:90%}";

const MAX_RAMP_COLORS = 10;
const ArcgisPopupChart = class {
    constructor(hostRef) {
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
        this.closePopupPopovers = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
        this.chartChangedReRender = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "chartChangedReRender", 7);
        this.notifyMultiMediaChange = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "notifyMultiMediaChange", 7);
        this.lastColors = {};
        this.pickList = [];
        this.arcadeExpMap = new Map();
        this.colorNodes = [];
        this.popupFieldManagePickListChanges = (event) => {
            var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k;
            const { esriLang, esriColor, rendererColors } = this;
            event.stopPropagation();
            const oldFields = this.chartMediaInfo.value.fields;
            const newFields = event.detail.selectedFields;
            this.chartMediaInfo.value.fields = newFields;
            if (this.chartMediaInfo.type === PopupMultiMediaType.lineChart) {
                if (((_a = this.chartMediaInfo.value.fields) === null || _a === void 0 ? void 0 : _a.length) && !((_b = this.chartMediaInfo.value.colors) === null || _b === void 0 ? void 0 : _b.length)) {
                    const defaultScheme = this.getDefaultColorScheme();
                    this.colors = [defaultScheme.colors[0]];
                    this.chartMediaInfo.value.colors = esriLang.clone(this.colors);
                    (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
                }
                else if (!((_c = this.chartMediaInfo.value.fields) === null || _c === void 0 ? void 0 : _c.length) &&
                    ((_d = this.chartMediaInfo.value.colors) === null || _d === void 0 ? void 0 : _d.length)) {
                    this.colors = undefined;
                    this.chartMediaInfo.value.colors = undefined;
                    (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
                }
                if ((_e = this.lastColors.rampColors) === null || _e === void 0 ? void 0 : _e.length) {
                    const defaultScheme = this.getDefaultColorScheme();
                    this.lastColors.rampColors = (_f = this.chartMediaInfo) === null || _f === void 0 ? void 0 : _f.value.fields.map((field, idx) => {
                        var _a;
                        const oldIdx = oldFields.indexOf(field);
                        return ((oldIdx > -1 && ((_a = this.lastColors.rampColors) === null || _a === void 0 ? void 0 : _a[oldIdx])) ||
                            new esriColor(defaultScheme.colors[idx % MAX_RAMP_COLORS]) ||
                            new esriColor([0, 0, 0, 1]));
                    });
                }
            }
            else {
                if ((_g = this.chartMediaInfo.value.fields) === null || _g === void 0 ? void 0 : _g.length) {
                    const defaultScheme = this.getDefaultColorScheme();
                    this.colors = (_h = this.chartMediaInfo) === null || _h === void 0 ? void 0 : _h.value.fields.map((fieldName, idx) => {
                        var _a;
                        const oldIdx = oldFields.indexOf(fieldName);
                        return ((oldIdx > -1 && ((_a = this.colors) === null || _a === void 0 ? void 0 : _a[oldIdx])) ||
                            (rendererColors.get(fieldName)
                                ? esriLang.clone(rendererColors.get(fieldName)[0])
                                : new esriColor(defaultScheme.colors[idx % MAX_RAMP_COLORS]) ||
                                    new esriColor([0, 0, 0, 1])));
                    });
                    if ((_j = this.chartMediaInfo.value.colors) === null || _j === void 0 ? void 0 : _j.length) {
                        this.chartMediaInfo.value.colors = esriLang.clone(this.colors);
                    }
                    else {
                        // don't auto save colors on remove; update to make sure default colors still match
                        this.colors = [];
                        this.setColors();
                        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
                    }
                    if (oldFields === null || oldFields === void 0 ? void 0 : oldFields.length) {
                        this.colorButtonNode && (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.colorButtonNode);
                    }
                    else {
                        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
                    }
                }
                else {
                    this.colors = undefined;
                    this.chartMediaInfo.value.colors = undefined;
                    (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
                }
            }
            this.chartChangedReRender.emit();
            if (!(oldFields === null || oldFields === void 0 ? void 0 : oldFields.length) || !((_k = this.chartMediaInfo.value.fields) === null || _k === void 0 ? void 0 : _k.length)) {
                (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
            }
        };
        this.fieldPickListChanges = (event) => {
            var _a, _b;
            event.stopPropagation();
            const selectedField = (_b = (_a = event.detail) === null || _a === void 0 ? void 0 : _a.selectedFields) === null || _b === void 0 ? void 0 : _b[0];
            if (selectedField) {
                this.chartMediaInfo.value.normalizeField = selectedField;
                this.chartChangedReRender.emit();
            }
            this.closePopupPopovers.emit(this.guid);
            this.normalizeBtn.focus();
        };
        // field selection for title and caption
        this.popupFieldSelectionPickListChanges = (event, formType) => {
            const selectedFieldName = event.detail.selectedFields[0];
            if (formType === "title") {
                this.editChartTitle.value = addSelectedFieldAtCursor(this.editChartTitle, selectedFieldName);
                this.chartMediaInfo.title = this.editChartTitle.value;
                this.editChartTitle.setFocus();
            }
            else if (formType === "caption") {
                this.editChartCaption.value = addSelectedFieldAtCursor(this.editChartCaption, selectedFieldName);
                this.chartMediaInfo.caption = this.editChartCaption.value;
                this.editChartCaption.setFocus();
            }
            else if (formType === "altText") {
                this.editAltText.value = addSelectedFieldAtCursor(this.editAltText, selectedFieldName);
                this.chartMediaInfo.altText = this.editAltText.value;
                this.editAltText.setFocus();
            }
            this.closePopupPopovers.emit(this.guid);
            this.chartChangedReRender.emit();
        };
        this.chartFormInput = (chartFormInputType) => {
            var _a;
            return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { scale: "s" }, (() => {
                if (chartFormInputType === "title") {
                    return this.strings.title;
                }
                else if (chartFormInputType === "caption") {
                    return this.strings.caption;
                }
                else if (chartFormInputType === "altText") {
                    return this.strings.description;
                }
            })(), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$3.formInputButton }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { type: "text", autofocus: true, ref: (element) => {
                    element.addEventListener("calciteInputChange", (event) => {
                        event.stopPropagation();
                        const inputVal = event.target.value;
                        if (chartFormInputType === "title") {
                            this.chartMediaInfo.title = inputVal;
                        }
                        else if (chartFormInputType === "caption") {
                            this.chartMediaInfo.caption = inputVal;
                        }
                        else if (chartFormInputType === "altText") {
                            this.chartMediaInfo.altText = inputVal;
                        }
                        this.chartChangedReRender.emit();
                    });
                    if (chartFormInputType === "title") {
                        return (this.editChartTitle = element);
                    }
                    else if (chartFormInputType === "caption") {
                        return (this.editChartCaption = element);
                    }
                    else if (chartFormInputType === "altText") {
                        return (this.editAltText = element);
                    }
                }, value: (() => {
                    if (chartFormInputType === "title") {
                        return this.chartMediaInfo.title;
                    }
                    else if (chartFormInputType === "caption") {
                        return this.chartMediaInfo.caption;
                    }
                    else if (chartFormInputType === "altText") {
                        return this.chartMediaInfo.altText;
                    }
                })(), placeholder: (() => {
                    if (chartFormInputType === "title") {
                        return this.strings.imageTitlePlaceHolder;
                    }
                    else if (chartFormInputType === "caption") {
                        return this.strings.imageCaptionPlaceHolder;
                    }
                    else if (chartFormInputType === "altText") {
                        return this.strings.describeChart;
                    }
                })(), onClick: () => this.closePopupPopovers.emit(this.guid) }), ((_a = this.popupTemplate.fieldInfos) === null || _a === void 0 ? void 0 : _a.length) > 0 && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: this.strings.attributes, "text-display": "hidden", onClick: () => {
                    var _a;
                    this.closePopupPopovers.emit(this.guid);
                    (_a = this.colorButtonNode) === null || _a === void 0 ? void 0 : _a.closePopover();
                    this.closeColorPopover();
                    if (!this.popupFieldSelectionPickList) {
                        this.popupFieldSelectionPickList = document.createElement("arcgis-popup-field-pick-list");
                        this.popupFieldSelectionPickList.popoverProps = {
                            refElement: this.panelElement
                        };
                        this.popupFieldSelectionPickList.multiple = false;
                        this.popupFieldSelectionPickList.heading = this.strings.addField;
                        this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListDismissed", () => {
                            this.closePopupPopovers.emit(this.guid);
                        });
                        this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListChange", (event) => this.popupFieldSelectionPickListChanges(event, chartFormInputType));
                        document.body.appendChild(this.popupFieldSelectionPickList);
                        this.panelElement.disabled = true;
                    }
                }, scale: "s", icon: "brackets-curly" })))));
        };
        this.calcitePickList = (field, idx) => ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-list-item", { key: field.fieldName, label: (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.b)(field, this.arcadeExpMap), value: field.fieldName }, this.renderColorIcon(idx), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { slot: "actions-end", appearance: "transparent", text: this.strings.remove, onClick: () => {
                var _a, _b, _c;
                this.closePopupPopovers.emit(this.guid);
                (_a = this.colorButtonNode) === null || _a === void 0 ? void 0 : _a.closePopover();
                this.closeColorPopover();
                if ((_b = this.chartMediaInfo.value.colors) === null || _b === void 0 ? void 0 : _b.length) {
                    this.chartMediaInfo.value.fields.forEach((fieldName, idx) => {
                        var _a;
                        if (fieldName === field.fieldName) {
                            this.chartMediaInfo.value.fields.splice(idx, 1);
                            if (this.chartMediaInfo.type !== PopupMultiMediaType.lineChart) {
                                this.chartMediaInfo.value.colors.splice(idx, 1);
                                this.colors.splice(idx, 1);
                                this.colorButtonNode && (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.colorButtonNode);
                            }
                            if ((_a = this.lastColors.rampColors) === null || _a === void 0 ? void 0 : _a.length) {
                                this.lastColors.rampColors.splice(idx, 1);
                            }
                        }
                    });
                }
                else {
                    this.chartMediaInfo.value.fields.forEach((fieldName, idx) => {
                        if (fieldName === field.fieldName) {
                            this.chartMediaInfo.value.fields.splice(idx, 1);
                        }
                    });
                    // don't auto save colors on remove/add; update to make sure default colors still match
                    this.colors = [];
                    this.setColors();
                    (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
                }
                this.chartChangedReRender.emit();
                if (!((_c = this.chartMediaInfo.value.fields) === null || _c === void 0 ? void 0 : _c.length)) {
                    (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
                }
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "x" }))));
        this.guid = undefined;
        this.chartMediaInfo = undefined;
        this.mediaContent = undefined;
        this.mediaIndexPosition = undefined;
        this.refElement = undefined;
        this.isOpen = false;
        this.reRender = undefined;
    }
    // lifecycle methods
    async componentWillLoad() {
        var _a;
        this.layer = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layer;
        this.mapView = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.mapView;
        this.strings = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
        this.popupTemplate = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
        this.layerDisplayType = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layerDisplayType;
        this.chartMediaInfo.title = this.chartMediaInfo.title || "";
        this.chartMediaInfo.altText = this.chartMediaInfo.altText || "";
        this.chartMediaInfo.caption = this.chartMediaInfo.caption || "";
        const [esriLang, esriColor, pieChartSchemes, rendererUtils] = await (0,_loadModules_b4ac1247_js__WEBPACK_IMPORTED_MODULE_4__.l)([
            "esri/core/lang",
            "esri/Color",
            "esri/smartMapping/symbology/pieChart",
            "esri/renderers/support/utils"
        ]);
        this.esriLang = esriLang;
        this.esriColor = esriColor;
        this.pieChartSchemes = pieChartSchemes;
        this.rendererUtils = rendererUtils;
        if ("renderer" in this.layer) {
            let renderer;
            if (this.layerDisplayType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.cluster) {
                renderer = this.layer.featureReduction.renderer;
            }
            else {
                renderer = this.layer.renderer;
            }
            if (["class-breaks", "dot-density", "heatmap", "pie-chart", "simple", "unique-value"].indexOf(renderer.type) > -1) {
                this.rendererColors = await this.rendererUtils.getColorsFromRenderer(renderer);
            }
        }
        this.colors = esriLang.clone((_a = this.chartMediaInfo) === null || _a === void 0 ? void 0 : _a.value.colors) || [];
        this.setColors();
    }
    componentDidLoad() {
        this.isOpen = true;
        // need timeout because of re-render
        setTimeout(() => requestAnimationFrame(() => this.panelElement.setFocus()), 300);
    }
    async componentWillRender() {
        this.fieldInfoMap = new Map(this.popupTemplate.fieldInfos.map((fieldInfo) => [
            fieldInfo.fieldName,
            fieldInfo
        ]));
        this.layerFieldsMap = await (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.d)(this.layer);
        this.arcadeExpMap = (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.e)(this.popupTemplate);
        this.pickList = [];
        this.chartMediaInfo.value.fields.forEach((field, idx) => {
            var _a, _b;
            if (this.fieldInfoMap.has(field)) {
                const currentFieldInfo = this.fieldInfoMap.get(field);
                this.pickList.push(this.calcitePickList(currentFieldInfo, idx));
            }
            else {
                // field does not exist anymore, remove
                this.chartMediaInfo.value.fields.splice(idx, 1);
                if (this.chartMediaInfo.type !== PopupMultiMediaType.lineChart) {
                    if ((_a = this.chartMediaInfo.value.colors) === null || _a === void 0 ? void 0 : _a.length) {
                        this.chartMediaInfo.value.colors.splice(idx, 1);
                        this.colors.splice(idx, 1);
                    }
                    else {
                        const defaultScheme = this.getDefaultColorScheme();
                        this.colors = (_b = this.chartMediaInfo) === null || _b === void 0 ? void 0 : _b.value.fields.map((fieldName, idx) => {
                            var _a;
                            return this.rendererColors.get(fieldName)
                                ? this.esriLang.clone(this.rendererColors.get(fieldName)[0])
                                : ((_a = this.colors) === null || _a === void 0 ? void 0 : _a[idx]) ||
                                    new this.esriColor(defaultScheme.colors[idx % MAX_RAMP_COLORS]) ||
                                    new this.esriColor([0, 0, 0, 1]);
                        });
                    }
                }
            }
        });
    }
    componentDidUpdate() {
        this.notifyMultiMediaChange.emit({
            guid: this.guid,
            mediaIndexPosition: this.mediaIndexPosition
        });
        this.chartPopover.reposition();
    }
    disconnectedCallback() {
        var _a;
        if (this.popupFieldSelectionPickList) {
            document.body.removeChild(this.popupFieldSelectionPickList);
        }
        if (this.popupFieldManagePickList) {
            document.body.removeChild(this.popupFieldManagePickList);
        }
        if (this.arcgisFieldPickList) {
            document.body.removeChild(this.arcgisFieldPickList);
        }
        (_a = this.colorButtonNode) === null || _a === void 0 ? void 0 : _a.closePopover();
    }
    // Public Methods
    async reposition() {
        this.chartPopover.reposition();
    }
    // Events
    chartChangedReRenderHandler(event) {
        event.stopPropagation();
        this.reRender = this.reRender ? false : true;
    }
    closePopupPopoversHandler() {
        this.removeAttributesSelectionPopover();
    }
    closeMultiMediaPopoverHandler() {
        this.removeAttributesSelectionPopover();
    }
    // arcade changes
    arcadeChangeNotificationHandler() {
        this.chartChangedReRender.emit();
    }
    // private methods and properties
    removeAttributesSelectionPopover() {
        if (this.popupFieldSelectionPickList) {
            document.body.removeChild(this.popupFieldSelectionPickList);
            this.popupFieldSelectionPickList = null;
        }
        if (this.popupFieldManagePickList) {
            document.body.removeChild(this.popupFieldManagePickList);
            this.popupFieldManagePickList = null;
        }
        if (this.arcgisFieldPickList) {
            document.body.removeChild(this.arcgisFieldPickList);
            this.arcgisFieldPickList = null;
        }
        if (this.colorPopoverNode) {
            document.body.removeChild(this.colorPopoverNode);
            this.colorPopoverNode = null;
        }
        this.panelElement.disabled = false;
    }
    async chartSelection(chartType) {
        const [BarChartMediaInfo, ColumnChartMediaInfo, LineChartMediaInfo, PieChartMediaInfo] = await (0,_loadModules_b4ac1247_js__WEBPACK_IMPORTED_MODULE_4__.l)([
            "esri/popup/content/BarChartMediaInfo",
            "esri/popup/content/ColumnChartMediaInfo",
            "esri/popup/content/LineChartMediaInfo",
            "esri/popup/content/PieChartMediaInfo"
        ]);
        let chartElement = null;
        if (chartType === PopupMultiMediaType.barChart) {
            chartElement = new BarChartMediaInfo({
                title: this.chartMediaInfo.title,
                caption: this.chartMediaInfo.caption,
                value: this.chartMediaInfo.value,
                altText: this.chartMediaInfo.altText
            });
        }
        if (chartType === PopupMultiMediaType.columnChart) {
            chartElement = new ColumnChartMediaInfo({
                title: this.chartMediaInfo.title,
                caption: this.chartMediaInfo.caption,
                value: this.chartMediaInfo.value,
                altText: this.chartMediaInfo.altText
            });
        }
        if (chartType === PopupMultiMediaType.lineChart) {
            chartElement = new LineChartMediaInfo({
                title: this.chartMediaInfo.title,
                caption: this.chartMediaInfo.caption,
                value: this.chartMediaInfo.value,
                altText: this.chartMediaInfo.altText
            });
        }
        if (chartType === PopupMultiMediaType.pieChart) {
            chartElement = new PieChartMediaInfo({
                title: this.chartMediaInfo.title,
                caption: this.chartMediaInfo.caption,
                value: this.chartMediaInfo.value,
                altText: this.chartMediaInfo.altText
            });
        }
        this.chartMediaInfo = chartElement.clone();
        this.mediaContent.mediaInfos[this.mediaIndexPosition] = this.chartMediaInfo;
        this.chartChangedReRender.emit();
    }
    getSummaryString() {
        if (this.chartMediaInfo.type === PopupMultiMediaType.barChart) {
            return this.strings.bar;
        }
        if (this.chartMediaInfo.type === PopupMultiMediaType.columnChart) {
            return this.strings.column;
        }
        if (this.chartMediaInfo.type === PopupMultiMediaType.lineChart) {
            return this.strings.line;
        }
        if (this.chartMediaInfo.type === PopupMultiMediaType.pieChart) {
            return this.strings.pie;
        }
    }
    // rendor methods
    render() {
        var _a, _b;
        const hasFields = !!((_a = this.chartMediaInfo.value.fields) === null || _a === void 0 ? void 0 : _a.length);
        const chartGroup = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-segmented-control", { width: "full", scale: "s", class: CSS$3.chartGroup, onCalciteSegmentedControlChange: async (event) => {
                var _a;
                (_a = this.colorButtonNode) === null || _a === void 0 ? void 0 : _a.closePopover();
                this.closeColorPopover();
                const node = event.target;
                const selectedItem = node.selectedItem;
                if ((this.chartMediaInfo.type === PopupMultiMediaType.lineChart &&
                    selectedItem.value !== PopupMultiMediaType.lineChart) ||
                    (this.chartMediaInfo.type !== PopupMultiMediaType.lineChart &&
                        selectedItem.value === PopupMultiMediaType.lineChart)) {
                    const savedColors = this.chartMediaInfo.value.colors;
                    if (this.chartMediaInfo.type === PopupMultiMediaType.lineChart) {
                        this.lastColors.lineColors = savedColors && this.esriLang.clone(savedColors);
                        this.colors = undefined;
                        this.chartMediaInfo.value.colors = undefined;
                    }
                    else {
                        this.lastColors.rampColors = savedColors && this.esriLang.clone(savedColors);
                        if (selectedItem.value === PopupMultiMediaType.lineChart) {
                            this.colors = undefined;
                            this.chartMediaInfo.value.colors = undefined;
                        }
                    }
                }
                if (selectedItem.value !== this.chartMediaInfo.type) {
                    // bar and column are in same radio group
                    !(selectedItem.value === PopupMultiMediaType.columnChart &&
                        this.chartMediaInfo.type === PopupMultiMediaType.barChart) && (await this.chartSelection(selectedItem.value));
                }
                this.setColors();
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-segmented-control-item", { value: PopupMultiMediaType.columnChart, iconStart: "graph-bar", checked: this.chartMediaInfo.type === PopupMultiMediaType.columnChart ||
                this.chartMediaInfo.type === PopupMultiMediaType.barChart }, this.strings.bar), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-segmented-control-item", { value: PopupMultiMediaType.lineChart, iconStart: "graph-time-series", checked: this.chartMediaInfo.type === PopupMultiMediaType.lineChart }, this.strings.line), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-segmented-control-item", { value: PopupMultiMediaType.pieChart, iconStart: "pie-chart", checked: this.chartMediaInfo.type === PopupMultiMediaType.pieChart }, this.strings.pie)));
        const colorButton = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-popup-color-button", { chartMediaInfo: this.chartMediaInfo, colors: this.colors, popoverReferenceElement: this.panelElement, onArcgisPopupColorButtonChange: ({ detail: colors }) => {
                this.colors = colors;
                // once the user makes a change we save all colors
                this.chartMediaInfo.value.colors = this.esriLang.clone(colors);
                this.chartChangedReRender.emit();
            }, onArcgisPopupColorButtonBeforeOpen: () => this.closeColorPopover(), ref: (node) => (this.colorButtonNode = node) }));
        const resetButton = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { layout: "inline-space-between" }, this.strings.resetColors, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { appearance: "transparent", text: this.strings.resetColors, disabled: !((_b = this.chartMediaInfo.value.colors) === null || _b === void 0 ? void 0 : _b.length), onClick: () => {
                var _a;
                (_a = this.colorButtonNode) === null || _a === void 0 ? void 0 : _a.closePopover();
                this.closeColorPopover();
                this.chartMediaInfo.value.colors = null;
                this.colors = [];
                if (this.chartMediaInfo.type === PopupMultiMediaType.lineChart) {
                    this.lastColors.lineColors = undefined;
                }
                else {
                    this.lastColors.rampColors = undefined;
                }
                this.setColors();
                (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.hostElement);
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "reset" }))));
        // manage button and list of selected fields
        const fieldList = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", null, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { class: CSS$3.manageBtn, appearance: "transparent", scale: "m", width: "full", onClick: async (event) => {
                var _a, _b, _c;
                event.stopPropagation();
                this.closePopupPopovers.emit(this.guid);
                (_a = this.colorButtonNode) === null || _a === void 0 ? void 0 : _a.closePopover();
                this.closeColorPopover();
                if (!this.popupFieldManagePickList) {
                    this.popupFieldManagePickList = document.createElement("arcgis-popup-field-pick-list");
                    this.popupFieldManagePickList.popoverProps = {
                        refElement: this.panelElement
                    };
                    this.popupFieldManagePickList.selectedFields =
                        ((_c = (_b = this.chartMediaInfo) === null || _b === void 0 ? void 0 : _b.value) === null || _c === void 0 ? void 0 : _c.fields) || [];
                    this.popupFieldManagePickList.showCancel = false;
                    this.popupFieldManagePickList.multiple = true;
                    this.popupFieldManagePickList.heading = this.strings.selectFields;
                    this.popupFieldManagePickList.okBtnText = this.strings.done;
                    this.popupFieldManagePickList.numbersOnly = true;
                    this.popupFieldManagePickList.addEventListener("arcgisPopupPickListDismissed", () => {
                        this.closePopupPopovers.emit(this.guid);
                    });
                    this.popupFieldManagePickList.addEventListener("arcgisPopupPickListChange", this.popupFieldManagePickListChanges);
                    document.body.appendChild(this.popupFieldManagePickList);
                    this.panelElement.disabled = true;
                }
            } }, this.strings.selectAttributes), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-list", { "drag-enabled": true, onCalciteListOrderChange: async (event) => {
                var _a, _b;
                event.stopPropagation();
                const allItems = event.target.querySelectorAll("calcite-list-item");
                const newIndexOrder = [];
                allItems.forEach((item) => {
                    this.chartMediaInfo.value.fields.forEach((field, idx) => {
                        if (item.value === field) {
                            newIndexOrder.push(idx);
                        }
                    });
                });
                if (this.chartMediaInfo.type === PopupMultiMediaType.lineChart) {
                    this.chartMediaInfo.value.fields = Array.from(allItems).map((item) => item.value);
                }
                else {
                    if (!((_a = this.chartMediaInfo.value.colors) === null || _a === void 0 ? void 0 : _a.length)) {
                        // once the user makes a re-order change we save all colors
                        this.chartMediaInfo.value.colors = this.esriLang.clone(this.colors);
                    }
                    const newFields = [];
                    const newColors = [];
                    newIndexOrder.forEach((idx) => {
                        newFields.push(this.chartMediaInfo.value.fields[idx]);
                        newColors.push(this.esriLang.clone(this.chartMediaInfo.value.colors[idx]));
                    });
                    this.chartMediaInfo.value.fields = newFields;
                    this.colors = newColors;
                    // we save colors on re-order
                    this.chartMediaInfo.value.colors = this.esriLang.clone(newColors);
                }
                if ((_b = this.lastColors.rampColors) === null || _b === void 0 ? void 0 : _b.length) {
                    const rampColors = [];
                    newIndexOrder.forEach((idx) => {
                        rampColors.push(this.lastColors.rampColors[idx]);
                    });
                    this.lastColors.rampColors = rampColors;
                }
                this.chartChangedReRender.emit();
            } }, this.pickList)));
        // bar chart checkbox only under default column-chart
        const barChart = (this.chartMediaInfo.type === PopupMultiMediaType.barChart ||
            this.chartMediaInfo.type === PopupMultiMediaType.columnChart) && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("section", { class: CSS$3.enableColumn }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("label", { class: CSS$3.enableColumnLabel }, this.strings.horizontalOrientation), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-switch", { scale: "s", class: CSS$3.ColumnSwitch, checked: this.chartMediaInfo.type === PopupMultiMediaType.barChart ? true : false, onCalciteSwitchChange: async (event) => {
                var _a;
                await this.chartSelection(((_a = event.target) === null || _a === void 0 ? void 0 : _a.checked)
                    ? PopupMultiMediaType.barChart
                    : PopupMultiMediaType.columnChart);
            } })));
        const normalizeField = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block-section", { class: CSS$3.normalizeBlock, text: this.strings.normalize, toggleDisplay: "switch", open: this.chartMediaInfo.value.normalizeField ? true : false, onCalciteBlockSectionToggle: (event) => {
                if (event.target.open) {
                    this.chartMediaInfo.value.normalizeField = this.tempNormalizedField;
                }
                else {
                    this.tempNormalizedField = this.chartMediaInfo.value.normalizeField;
                    this.chartMediaInfo.value.normalizeField = "";
                }
                this.chartChangedReRender.emit();
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$3.normalizeContentButtonSection }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("button", { ref: (el) => (this.normalizeBtn = el), class: CSS$3.normalizeContentButton, title: this.strings.normalizeBy, onClick: (event) => {
                var _a;
                event.stopPropagation();
                this.closePopupPopovers.emit(this.guid);
                (_a = this.colorButtonNode) === null || _a === void 0 ? void 0 : _a.closePopover();
                this.closeColorPopover();
                // lazy load attribute selection component
                if (!this.arcgisFieldPickList) {
                    this.arcgisFieldPickList = document.createElement("arcgis-popup-field-pick-list");
                    this.arcgisFieldPickList.popoverProps = {
                        refElement: this.panelElement
                    };
                    this.arcgisFieldPickList.selectedFields = [
                        this.chartMediaInfo.value.normalizeField
                    ];
                    this.arcgisFieldPickList.numbersOnly = true;
                    this.arcgisFieldPickList.addEventListener("arcgisPopupPickListDismissed", this.fieldPickListChanges);
                    document.body.appendChild(this.arcgisFieldPickList);
                    this.panelElement.disabled = true;
                }
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: CSS$3.normalizeContentButtonText }, this.fieldInfoMap.has(this.chartMediaInfo.value.normalizeField)
            ? (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.b)(this.fieldInfoMap.get(this.chartMediaInfo.value.normalizeField), this.arcadeExpMap)
            : this.strings.normalizeBy), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("span", { class: CSS$3.normalizeContentButtonIcon }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "pencil" }))))));
        const doneBtn = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "outline-fill", scale: "m", slot: "footer", width: "full", onClick: () => this.closePopupPopovers.emit() }, this.strings.done));
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "js-app-flyout" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-popover", { dir: (0,_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), ref: (element) => (this.chartPopover = element), placement: "leading-start", open: this.isOpen, pointerDisabled: true, referenceElement: this.refElement, offsetDistance: -Math.round(this.refElement.getBoundingClientRect().width), offsetSkidding: 50, label: "", style: {
                zIndex: "100"
            }, triggerDisabled: true }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-panel", { ref: (element) => (this.panelElement = element), closable: true, style: {
                width: `${this.refElement.getBoundingClientRect().width}px`
            }, onCalcitePanelClose: () => this.closePopupPopovers.emit() }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "header-content" }, this.strings.configureChart), doneBtn, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$3.popoverChartDiv }, chartGroup, this.chartFormInput("title"), this.chartFormInput("caption"), this.chartFormInput("altText"), hasFields && colorButton, hasFields && resetButton, fieldList, barChart, normalizeField)))));
    }
    renderColorIcon(index) {
        const { strings, selectedFieldIdx, colors } = this;
        if (this.chartMediaInfo.type === PopupMultiMediaType.lineChart) {
            return;
        }
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "color-icon", style: { backgroundColor: colors[index].toHex() }, slot: "content-start", onClick: () => this.openColorPicker(index), role: "button", tabIndex: 0, "aria-label": strings.changeColor, "aria-haspopup": "true", "aria-expanded": selectedFieldIdx === index, onKeyUp: (event) => {
                if (event.key === " " || event.key === "Enter") {
                    this.openColorPicker(index);
                }
            }, ref: (node) => {
                this.colorNodes[index] = node;
            } }));
    }
    openColorPicker(index) {
        var _a;
        const { colors, strings, esriColor } = this;
        (_a = this.colorButtonNode) === null || _a === void 0 ? void 0 : _a.closePopover();
        this.closeColorPopover();
        this.selectedFieldIdx = index;
        const popover = document.createElement("arcgis-popup-color-popover");
        popover.heading = strings.selectColor;
        popover.intlDone = strings.done;
        popover.label = strings.selectColor;
        popover.hexColor = colors[index].toHex();
        popover.popoverProps = {
            placement: "leading-start",
            offsetDistance: 1,
            offsetSkidding: 52,
            pointerDisabled: "true",
            popoverWidth: 315,
            //overlayPositioning: "fixed", -- buggy, offset issue
            refElement: this.chartPopover
        };
        popover.addEventListener("arcgisPopupColorPopoverClose", () => {
            this.selectedFieldIdx = undefined;
            this.colorPopoverNode = null;
        });
        popover.addEventListener("arcgisPopupColorPopoverChange", ({ detail: hexColor }) => {
            colors[index] = new esriColor(hexColor);
            // once the user makes a change we save all colors
            this.chartMediaInfo.value.colors = this.esriLang.clone(colors);
            this.chartChangedReRender.emit();
            (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f)(this.colorButtonNode);
        });
        document.body.appendChild(popover);
        popover.setOpen(true);
        this.colorPopoverNode = popover;
        //popover.addEventListener("arcgisPopupColorPopoverOpen", () => {});
    }
    setColors() {
        var _a, _b, _c, _d, _e, _f;
        const { esriColor, lastColors, rendererColors } = this;
        if (this.chartMediaInfo.type === PopupMultiMediaType.lineChart) {
            if (!((_a = this.colors) === null || _a === void 0 ? void 0 : _a.length) && lastColors.lineColors) {
                this.colors = lastColors.lineColors;
                this.chartMediaInfo.value.colors = this.esriLang.clone(this.colors);
            }
            if (!((_b = this.colors) === null || _b === void 0 ? void 0 : _b.length)) {
                const defaultScheme = this.getDefaultColorScheme();
                this.colors = [defaultScheme.colors[0]];
            }
            else if (this.colors.length > 1) {
                this.colors = [this.colors[0]];
            }
        }
        else {
            if (!((_c = this.colors) === null || _c === void 0 ? void 0 : _c.length) && lastColors.rampColors) {
                this.colors = this.esriLang.clone(lastColors.rampColors);
                this.chartMediaInfo.value.colors = this.esriLang.clone(this.colors);
            }
            if (!((_d = this.colors) === null || _d === void 0 ? void 0 : _d.length) || this.colors.length !== ((_e = this.chartMediaInfo) === null || _e === void 0 ? void 0 : _e.value.fields.length)) {
                const defaultScheme = this.getDefaultColorScheme();
                this.colors = (_f = this.chartMediaInfo) === null || _f === void 0 ? void 0 : _f.value.fields.map((fieldName, idx) => {
                    var _a;
                    return rendererColors.get(fieldName)
                        ? this.esriLang.clone(rendererColors.get(fieldName)[0])
                        : ((_a = this.colors) === null || _a === void 0 ? void 0 : _a[idx]) ||
                            new esriColor(defaultScheme.colors[idx % MAX_RAMP_COLORS]) ||
                            new esriColor([0, 0, 0, 1]);
                });
            }
        }
    }
    getDefaultColorScheme() {
        const schemes = this.pieChartSchemes.getSchemes({
            basemap: this.mapView.map.basemap,
            geometryType: "polygon",
            numColors: Math.min(MAX_RAMP_COLORS, this.chartMediaInfo.value.fields.length)
        });
        return ([schemes.primaryScheme]
            .concat(schemes.secondarySchemes)
            .find((scheme) => scheme.name === "Olympic Sunset") ||
            schemes.primaryScheme);
    }
    closeColorPopover() {
        if (this.colorPopoverNode) {
            document.body.removeChild(this.colorPopoverNode);
            this.colorPopoverNode = null;
        }
    }
    get hostElement() { return (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisPopupChart.style = arcgisPopupChartCss;

const ArcgisPopupExpressions = class {
    constructor(hostRef) {
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
        this.arcadeChangeNotification = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcadeChangeNotification", 7);
        this.internalPopupUpdated = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "internalPopupUpdated", 7);
        this.valueList = [];
        this.filterLength = 5;
        // rendor methods
        this.calciteValueList = (arcadeField) => ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-value-list-item", { label: arcadeField.title, description: `{${_commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.f.expression}${arcadeField.name}}`, value: arcadeField.name, metadata: {
                title: arcadeField.title,
                name: `{${_commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.f.expression}${arcadeField.name}}`
            }, onClick: (event) => this.launchArcade(event, arcadeField) }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { slot: "actions-end", appearance: "transparent", text: this.strings.remove, onClick: (event) => this.removeBtnClick(event, arcadeField.name) }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "x" }))));
        this.reRender = undefined;
    }
    componentWillLoad() {
        this.layer = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layer;
        this.mapView = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.mapView;
        this.portal = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.portal;
        this.config = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.config;
        this.strings = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
        this.currentLanguage = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.currentLanguage;
        this.serviceType = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.serviceType;
        this.popupTemplate = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
        this.layerDisplayType = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layerDisplayType;
    }
    // lifecycle methods
    async componentDidLoad() {
        await this.loadAllModules();
    }
    componentWillRender() {
        var _a;
        this.valueList = [];
        if ((_a = this.popupTemplate.expressionInfos) === null || _a === void 0 ? void 0 : _a.length) {
            this.popupTemplate.expressionInfos.forEach((arcadeField) => {
                this.valueList.push(this.calciteValueList(arcadeField));
            });
        }
    }
    // Public Methods
    async setFocus() {
        this.expressionFlowItem.setFocus();
    }
    // private methods and properties
    async loadAllModules() {
        [this.FieldInfo, this.PopupExpressionInfo] = await (0,_loadModules_b4ac1247_js__WEBPACK_IMPORTED_MODULE_4__.l)([
            "esri/popup/FieldInfo",
            "esri/popup/ExpressionInfo"
        ]);
    }
    async launchArcade(event, currentExpression) {
        event.stopPropagation();
        if (!this.arcadeEditor) {
            this.expressionFlowItem.disabled = true;
            this.arcadeEditor = document.createElement("arcgis-modal-arcade");
            this.arcadeEditor.arcadeScript = getArcadeScript(currentExpression === null || currentExpression === void 0 ? void 0 : currentExpression.expression, this.layerDisplayType, this.strings);
            this.arcadeEditor.arcadeProfile = await getArcadeProfile(this.layer, this.mapView, this.serviceType, this.popupTemplate, this.layerDisplayType);
            this.arcadeEditor.testData = await getTestData(this.layer, this.mapView, this.layerDisplayType, this.popupTemplate);
            this.arcadeEditor.addExistingExpressions = true;
            this.arcadeEditor.layer = this.layer;
            this.arcadeEditor.arcadeTitle = (currentExpression === null || currentExpression === void 0 ? void 0 : currentExpression.title) || this.strings.arcadeDefaultTitle;
            this.arcadeEditor.arcadeTitleEditable = true;
            this.arcadeEditor.arcadeTitleEditingEnabled = !(currentExpression === null || currentExpression === void 0 ? void 0 : currentExpression.title);
            document.body.appendChild(this.arcadeEditor);
            this.arcadeEditor.addEventListener("arcgisModalArcadeClose", (event) => {
                this.arcadeSetup(event.detail, currentExpression);
                setTimeout(() => this.fabButtonNode.setFocus(), 300);
            });
        }
    }
    async arcadeSetup(arcadeObject, currentExpression) {
        if (arcadeObject) {
            setExpressionInfoInPopupTemplate(arcadeObject, currentExpression === null || currentExpression === void 0 ? void 0 : currentExpression.name, this.PopupExpressionInfo, this.popupTemplate);
            await this.popupExpressionSetup();
        }
        this.expressionFlowItem.disabled = false;
        document.body.removeChild(this.arcadeEditor);
        this.arcadeEditor = null;
    }
    // update master field info and emit for attributes re-render, self re-render and update popup
    async popupExpressionSetup() {
        await setLayerExpressionAndFieldInfo(this.popupTemplate, this.layerDisplayType, this.layer, this.FieldInfo);
        this.arcadeChangeNotification.emit();
        this.internalPopupUpdated.emit();
        this.reRender = !this.reRender;
    }
    removeBtnClick(event, fieldName) {
        event.stopPropagation();
        this.popupTemplate.expressionInfos.find((exp, index) => {
            if (exp.name === fieldName) {
                return this.popupTemplate.expressionInfos.splice(index, 1);
            }
        });
        this.popupExpressionSetup();
    }
    render() {
        var _a;
        const addExpressionBtn = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-fab", { slot: "fab", class: "fab", icon: "plus", scale: "s", appearance: "outline-fill", kind: "neutral", label: this.strings.addExpression, text: this.strings.addExpression, "text-enabled": true, onClick: (event) => this.launchArcade(event), ref: (node) => (this.fabButtonNode = node) }));
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "calcite-match-height" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { dir: (0,_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), heading: this.strings.manageExpressions, ref: (node) => (this.expressionFlowItem = node) }, ((_a = this.popupTemplate.expressionInfos) === null || _a === void 0 ? void 0 : _a.length) > 0 && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-value-list", { filterEnabled: this.valueList.length >= this.filterLength ? true : false }, this.valueList)), addExpressionBtn)));
    }
    get hostElement() { return (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};

const arcgisPopupFieldPickListCss = ".popover{z-index:100}.panel{min-height:300px}.content{max-height:calc(60vh - 142px);}.selection-button-div{padding:4px 10px}.footer{width:100%}.expression-actions{display:flex}.add-expression-button{margin:4px 0 8px}";

const ArcgisPopupFieldPickList = class {
    constructor(hostRef) {
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
        this.arcgisPopupPickListDismissed = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisPopupPickListDismissed", 7);
        this.arcgisPopupPickListChange = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisPopupPickListChange", 7);
        this.arcadeChangeNotification = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcadeChangeNotification", 7);
        this.arcadeExpMap = new Map();
        this.calciteFieldOnlyValueList = (field) => ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-pick-list-item", { key: field.name, label: field.alias || field.name, value: field.name, description: `{${field.name}}`, selected: (!this.multiple && field.name === this.selectedFields[0]) ||
                (this.multiple && this.selectedFields.indexOf(field.name) > -1), metadata: {
                label: field.alias,
                fieldName: field.name
            } }, this.layerDisplayType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.l.feature &&
            !field.name.includes(_commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.f.relationship) && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { slot: "actions-end", text: this.strings.info, title: this.strings.info, scale: "s", icon: "information", onClick: (event) => {
                var _a;
                event.stopPropagation();
                const action = event.target;
                const fieldInfoFlowItem = document.createElement("calcite-flow-item");
                fieldInfoFlowItem.heading = (_a = field.alias) !== null && _a !== void 0 ? _a : field.name;
                fieldInfoFlowItem.description = field.name;
                const fieldInfo = document.createElement("arcgis-field-info");
                fieldInfo.lang = this.currentLanguageIntl;
                fieldInfo.fieldName = field.name;
                fieldInfo.layer = this.layer;
                fieldInfo.view = this.mapView;
                fieldInfo.classList.add("content");
                fieldInfoFlowItem.addEventListener("calciteFlowItemBack", () => requestAnimationFrame(() => action.setFocus()));
                fieldInfoFlowItem.appendChild(fieldInfo);
                this.flowElement.appendChild(fieldInfoFlowItem);
                setTimeout(() => fieldInfoFlowItem.setFocus(), 200);
            } }))));
        this.calciteExpressionsOnlyValueList = (field) => ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-pick-list-item", { key: field.name, label: field.alias || field.name, value: field.name, description: `{${field.name}}`, selected: (!this.multiple && field.name === this.selectedFields[0]) ||
                (this.multiple && this.selectedFields.indexOf(field.name) > -1), metadata: {
                label: field.alias,
                fieldName: field.name
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "expression-actions", slot: "actions-end" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: this.strings.edit, title: this.strings.edit, scale: "s", icon: this.numbersOnly && field.type.toLowerCase() !== _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.a.number
                ? "exclamation-mark-triangle"
                : "pencil", onClick: () => {
                if (this.arcadeExpMap.has(field.name)) {
                    this.launchArcade(this.arcadeExpMap.get(field.name));
                }
            } }), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: this.strings.remove, title: this.strings.remove, scale: "s", icon: "trash", onClick: async () => {
                this.popupTemplate.expressionInfos.find((exp, index) => {
                    if (field.name.includes(`/${exp.name}`)) {
                        return this.popupTemplate.expressionInfos.splice(index, 1);
                    }
                });
                await setLayerExpressionAndFieldInfo(this.popupTemplate, this.layerDisplayType, this.layer, this.FieldInfo);
                this.fields = this.fields.filter((currField) => {
                    return currField.name !== field.name;
                });
                this.selectedFields = [...this.selectedFields].filter((fieldName) => {
                    return fieldName !== field.name;
                });
                this.multiple &&
                    this.arcgisPopupPickListChange.emit({
                        selectedFields: [...new Set(this.selectedFields)]
                    });
                this.arcadeChangeNotification.emit();
            } }))));
        this.selectedFields = [];
        this.popoverProps = undefined;
        this.showCancel = true;
        this.multiple = false;
        this.heading = undefined;
        this.okBtnText = undefined;
        this.showFilterLength = 5;
        this.numbersOnly = false;
        this.lastSortyBy = _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.L.default;
        this.filterFields = null;
        this.arcadeEditor = undefined;
    }
    // --------------------------------------------------------------------------
    //
    //  Lifecycle
    //
    // --------------------------------------------------------------------------
    async componentWillLoad() {
        this.layer = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layer;
        this.mapView = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.mapView;
        this.portal = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.portal;
        this.config = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.config;
        this.strings = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
        this.currentLanguage = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.currentLanguage;
        this.currentLanguageIntl = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.currentLanguageIntl;
        this.serviceType = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.serviceType;
        this.popupTemplate = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
        this.layerDisplayType = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layerDisplayType;
        this.supportsArcade = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.supportsArcade;
        this.layerFieldsMap = await (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.d)(this.layer);
        this.arcadeExpMap = (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.e)(this.popupTemplate);
        this.fields = await this.getFields();
        // in case more than 1 selected field and multiple is set to false
        if (!this.multiple && this.selectedFields.length > 1) {
            this.selectedFields = [this.selectedFields[0]];
        }
    }
    async componentDidLoad() {
        await this.loadAllModules();
        this.popoverNode.open = true;
        // need timeout because of re-render
        setTimeout(() => requestAnimationFrame(() => this.flowItemElement.setFocus()), 200);
    }
    componentWillRender() {
        this.arcadeExpMap = (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.e)(this.popupTemplate);
        this.fieldsOnly = [...this.getSortedList()].filter((field) => {
            return !field.name.includes(_commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.f.expression);
        });
        this.expressionsOnly = [...this.getSortedList()].filter((field) => {
            return field.name.includes(_commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.f.expression);
        });
    }
    // Public Methods
    async reposition() {
        var _a;
        (_a = this.popoverNode) === null || _a === void 0 ? void 0 : _a.reposition();
    }
    // temp: https://github.com/Esri/calcite-components/issues/4333
    calciteFilterChangeHandler(event) {
        var _a, _b;
        event.stopPropagation();
        const filterNode = (_a = event === null || event === void 0 ? void 0 : event.path) === null || _a === void 0 ? void 0 : _a.find((item) => item.nodeName === "CALCITE-FILTER");
        this.filterFields = (_b = filterNode === null || filterNode === void 0 ? void 0 : filterNode.filteredItems) === null || _b === void 0 ? void 0 : _b.map((item) => {
            return item.value;
        });
    }
    // --------------------------------------------------------------------------
    //
    // Private Methods
    //
    // --------------------------------------------------------------------------
    getSortedList() {
        const tempSorted = [...this.fields];
        if (this.lastSortyBy === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.L.display) {
            tempSorted.sort((a, b) => a.alias.localeCompare(b.alias));
        }
        else if (this.lastSortyBy === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.L.field) {
            tempSorted.sort((a, b) => a.name.localeCompare(b.name));
        }
        else if (this.lastSortyBy === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.L.type) {
            tempSorted.sort((a, b) => a.type.localeCompare(b.type));
        }
        return tempSorted;
    }
    // return true for deselect all, false for select all
    selectDeselect() {
        var _a;
        return ((_a = this.filterFields) === null || _a === void 0 ? void 0 : _a.length)
            ? this.filterContainsAll()
            : this.selectedFields.length === this.fields.length;
    }
    // check if filter has all current field info
    filterContainsAll() {
        return this.filterFields.every((filter) => {
            return this.selectedFields.some((curr) => {
                return curr === filter;
            });
        });
    }
    async loadAllModules() {
        [this.PopupExpressionInfo, this.FieldInfo] = await (0,_loadModules_b4ac1247_js__WEBPACK_IMPORTED_MODULE_4__.l)([
            "esri/popup/ExpressionInfo",
            "esri/popup/FieldInfo"
        ]);
    }
    async launchArcade(currentExpression) {
        if (!this.arcadeEditor) {
            this.flowItemElement.disabled = true;
            this.arcadeEditor = document.createElement("arcgis-modal-arcade");
            this.arcadeEditor.arcadeScript = getArcadeScript(currentExpression === null || currentExpression === void 0 ? void 0 : currentExpression.expression, this.layerDisplayType, this.strings);
            this.arcadeEditor.arcadeProfile = await getArcadeProfile(this.layer, this.mapView, this.serviceType, this.popupTemplate, this.layerDisplayType);
            this.arcadeEditor.testData = await getTestData(this.layer, this.mapView, this.layerDisplayType, this.popupTemplate);
            this.arcadeEditor.addExistingExpressions = true;
            this.arcadeEditor.layer = this.layer;
            this.arcadeEditor.arcadeTitle = (currentExpression === null || currentExpression === void 0 ? void 0 : currentExpression.title) || this.strings.arcadeDefaultTitle;
            this.arcadeEditor.arcadeTitleEditable = true;
            this.arcadeEditor.arcadeTitleEditingEnabled = !(currentExpression === null || currentExpression === void 0 ? void 0 : currentExpression.title);
            document.body.appendChild(this.arcadeEditor);
            this.arcadeEditor.addEventListener("arcgisModalArcadeClose", (event) => this.arcadeSetup(event.detail, currentExpression));
        }
    }
    async arcadeSetup(arcadeObject, currentExpression) {
        if (arcadeObject) {
            const popupExpression = setExpressionInfoInPopupTemplate(arcadeObject, currentExpression === null || currentExpression === void 0 ? void 0 : currentExpression.name, this.PopupExpressionInfo, this.popupTemplate);
            await setLayerExpressionAndFieldInfo(this.popupTemplate, this.layerDisplayType, this.layer, this.FieldInfo);
            const expName = `${_commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.f.expression}${popupExpression.name}`;
            this.fields.push({
                name: expName,
                alias: popupExpression.title,
                type: popupExpression.returnType
            });
            // remove duplicates
            this.fields = [
                ...new Map(this.fields.map((item) => [item.name, item])).values()
            ];
            if (this.multiple) {
                this.selectedFields.push(expName);
            }
            else {
                this.selectedFields = [expName];
            }
            this.arcgisPopupPickListChange.emit({ selectedFields: [...new Set(this.selectedFields)] });
            this.arcadeChangeNotification.emit();
        }
        this.flowItemElement.disabled = false;
        document.body.removeChild(this.arcadeEditor);
        this.arcadeEditor = null;
    }
    async getFields() {
        const tempFieldAndFieldInfo = [];
        let fieldsOrderInService = await (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.j)(this.layer);
        fieldsOrderInService = fieldsOrderInService.filter((field) => field.visible);
        // map fieldInfos for faster access
        const fieldInfoMap = new Map(this.popupTemplate.fieldInfos.map((fieldInfo) => [
            fieldInfo.fieldName,
            fieldInfo
        ]));
        // order based on order of fields in the service
        fieldsOrderInService.forEach((layerField) => {
            if (fieldInfoMap.has(layerField.name)) {
                const fieldInfo = fieldInfoMap.get(layerField.name);
                tempFieldAndFieldInfo.push({
                    name: fieldInfo.fieldName,
                    alias: (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.b)(fieldInfo, this.arcadeExpMap),
                    type: (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.a)(fieldInfo.fieldName, this.layerFieldsMap, this.arcadeExpMap)
                });
                // delete from map
                fieldInfoMap.delete(layerField.name);
            }
        });
        // add remaining fields in popuptemplate. e.g. arcade, related
        fieldInfoMap.forEach((fieldInfo) => {
            tempFieldAndFieldInfo.push({
                name: fieldInfo.fieldName,
                alias: (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.b)(fieldInfo, this.arcadeExpMap),
                type: (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.a)(fieldInfo.fieldName, this.layerFieldsMap, this.arcadeExpMap)
            });
        });
        if (this.numbersOnly) {
            // set for faster lookup
            const selectedFieldsSet = new Set(this.selectedFields);
            return tempFieldAndFieldInfo.filter((currFieldAndFieldInfo) => {
                const fieldType = currFieldAndFieldInfo.type.toLowerCase();
                if ((selectedFieldsSet.has(currFieldAndFieldInfo.name) ||
                    fieldType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.a.integer ||
                    fieldType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.a.smallInteger ||
                    fieldType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.a.bigInteger ||
                    fieldType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.a.single ||
                    fieldType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.a.double ||
                    fieldType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.a.long ||
                    fieldType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.a.number ||
                    fieldType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.a.oid) &&
                    !currFieldAndFieldInfo.name.includes(_commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.f.relationship)) {
                    return currFieldAndFieldInfo;
                }
            });
        }
        return tempFieldAndFieldInfo;
    }
    // --------------------------------------------------------------------------
    //
    // Rendor  Methods
    //
    // --------------------------------------------------------------------------
    render() {
        const addBtn = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: this.showCancel ? "solid" : "outline-fill", width: this.showCancel ? "half" : "full", scale: "m", onClick: () => {
                this.arcgisPopupPickListDismissed.emit({
                    selectedFields: [...new Set(this.selectedFields)]
                });
            } }, this.okBtnText || (this.multiple ? this.strings.done : this.strings.ok)));
        const cancelBtn = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "outline-fill", width: this.multiple ? "half" : "full", scale: "m", onClick: () => this.arcgisPopupPickListDismissed.emit() }, this.strings.cancel));
        const sort = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown", { slot: "menu-actions", placement: "bottom-end", overlayPositioning: "fixed" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { slot: "trigger", text: this.strings.sort, title: this.strings.sort }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "sortDescending" })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-group", null, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { selected: this.lastSortyBy === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.L.default, onClick: () => (this.lastSortyBy = _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.L.default) }, this.strings.default), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { selected: this.lastSortyBy === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.L.display, onClick: () => (this.lastSortyBy = _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.L.display) }, this.strings.displayName), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { selected: this.lastSortyBy === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.L.type, onClick: () => (this.lastSortyBy = _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.L.type) }, this.strings.type), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { selected: this.lastSortyBy === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.L.field, onClick: () => (this.lastSortyBy = _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.L.field) }, this.strings.fieldName))));
        const selectionBtn = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "selection-button-div" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "transparent", scale: "m", width: "full", class: "selection-button", onClick: () => {
                var _a, _b;
                if (this.selectDeselect()) {
                    //deselect all
                    this.selectedFields = ((_a = this.filterFields) === null || _a === void 0 ? void 0 : _a.length)
                        ? this.selectedFields.filter((item) => !this.filterFields.includes(item))
                        : [];
                }
                else {
                    //select all
                    this.selectedFields = ((_b = this.filterFields) === null || _b === void 0 ? void 0 : _b.length)
                        ? [...new Set([...this.selectedFields, ...this.filterFields])]
                        : this.fields.map((field) => {
                            return field.name;
                        });
                }
            } }, this.selectDeselect() ? this.strings.deselectAll : this.strings.selectAll)));
        const addExpressionsBtn = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "transparent", scale: "m", width: "full", iconStart: "plus", class: "add-expression-button", onClick: () => {
                this.launchArcade();
            } }, this.strings.addExpression));
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "js-app-flyout" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-popover", { dir: (0,_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), class: "popover", placement: this.popoverProps.placement || "leading-start", open: false, pointerDisabled: true, referenceElement: this.popoverProps.refElement, offsetDistance: this.popoverProps.offsetDistance ||
                -Math.round(this.popoverProps.refElement.getBoundingClientRect().width), offsetSkidding: this.popoverProps.offsetSkidding || 50, label: this.heading, triggerDisabled: true, ref: (node) => (this.popoverNode = node) }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow", { ref: (node) => {
                this.flowElement = node;
            }, style: {
                width: `${this.popoverProps.popoverWidth ||
                    this.popoverProps.refElement.getBoundingClientRect().width}px`
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { ref: (el) => (this.flowItemElement = el), class: "panel", heading: this.heading, closable: true, onCalciteFlowItemClose: () => this.arcgisPopupPickListDismissed.emit() }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "footer", slot: "footer" }, this.supportsArcade && addExpressionsBtn, this.multiple && addBtn, this.showCancel && cancelBtn), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-pick-list", { class: "content", multiple: this.multiple, ref: (node) => {
                this.pickListNode = node;
            }, filterEnabled: this.fields.length >= this.showFilterLength ? true : false, filterPlaceholder: this.strings.searchFields, onCalciteListChange: async () => {
                // keep original order. Add addional values at the end
                const tempSelectedFields = await this.pickListNode.getSelectedItems();
                this.selectedFields = [
                    ...new Set([
                        ...this.selectedFields.filter((item) => {
                            return tempSelectedFields.has(item);
                        }),
                        ...tempSelectedFields.keys()
                    ])
                ];
                this.arcgisPopupPickListChange.emit({
                    selectedFields: this.selectedFields
                });
                if (!this.multiple) {
                    this.arcgisPopupPickListDismissed.emit({ selectedFields: this.selectedFields });
                }
            } }, this.fields.length >= this.showFilterLength && sort, this.multiple && selectionBtn, this.supportsArcade && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-pick-list-group", { "group-title": this.strings.expressions }, this.expressionsOnly.length ? (this.expressionsOnly.map((field) => {
            return this.calciteExpressionsOnlyValueList(field);
        })) : ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { alignment: "center" }, this.strings.noExpressions)))), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-pick-list-group", { groupTitle: this.supportsArcade ? this.strings.attributes : null }, this.fieldsOnly.map((field) => {
            return this.calciteFieldOnlyValueList(field);
        }))))))));
    }
    get hostElement() { return (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisPopupFieldPickList.style = arcgisPopupFieldPickListCss;

const CSS$2 = {
    popoverImageDiv: "popover-image-div",
    formInputButton: "form-input-button",
    refreshImageInput: "refresh-image-input"
};

const arcgisPopupImageCss = ".popover-image-div{background-color:var(--arcgis-app-background);padding:var(--arcgis-app-cap-spacing) var(--arcgis-app-side-spacing-half);max-height:calc(60vh - 102px);}.refresh-label{margin-top:6px}.form-input-button{display:flex}.form-input-button calcite-input[type=text]{display:flex;flex-flow:column nowrap;flex:1 0 0%;overflow:hidden}.form-input-button calcite-action{margin:0;flex:0 0 0%;justify-self:flex-end}.refresh-image-input{width:5rem}";

const ArcgisPopupImage = class {
    constructor(hostRef) {
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
        this.closePopupPopovers = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
        this.imageChangedReRender = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "imageChangedReRender", 7);
        this.notifyMultiMediaChange = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "notifyMultiMediaChange", 7);
        this.changeImageProperties = (event) => {
            event === null || event === void 0 ? void 0 : event.stopPropagation();
            event === null || event === void 0 ? void 0 : event.preventDefault();
            // hide rest of the component.
            this.imageMediaInfo.value.sourceURL = this.editImageUrl.value;
            this.imageMediaInfo.title = this.editImageTitle.value;
            this.imageMediaInfo.refreshInterval = this.editRefreshImage.value || 0;
            this.imageMediaInfo.caption = this.editImageCaption.value;
            this.imageMediaInfo.altText = this.editAltText.value;
            this.imageMediaInfo.value.linkURL = this.editImageLinkUrl.value;
            this.imageChangedReRender.emit();
        };
        // open popover
        this.openAttributesList = (imageComponentInputType) => {
            // close first since we can have multiple attributes open
            this.closePopupPopovers.emit(this.guid);
            // lazy load attribute selection component
            if (!this.popupFieldSelectionPickList) {
                this.popupFieldSelectionPickList = document.createElement("arcgis-popup-field-pick-list");
                this.popupFieldSelectionPickList.popoverProps = {
                    refElement: this.panelElement
                };
                this.popupFieldSelectionPickList.multiple = false;
                this.popupFieldSelectionPickList.heading = this.strings.addField;
                this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListDismissed", () => {
                    this.closePopupPopovers.emit(this.guid);
                });
                this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListChange", (event) => this.popupFieldSelectionPickListChanges(event, imageComponentInputType));
                document.body.appendChild(this.popupFieldSelectionPickList);
                this.panelElement.disabled = true;
            }
        };
        this.imageFormInput = (imageInputType) => {
            var _a;
            const imageInputObject = this.getImageInputObject(imageInputType);
            return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { scale: "s" }, imageInputObject.inputLabel, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { id: imageInputObject.popoverId, class: CSS$2.formInputButton }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { type: "text", autofocus: true, ref: imageInputObject.referenceElement, value: imageInputObject.inputValue, placeholder: imageInputObject.placeHolder, onClick: () => this.closePopupPopovers.emit(this.guid) }), ((_a = this.popupTemplate.fieldInfos) === null || _a === void 0 ? void 0 : _a.length) > 0 && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: this.strings.attributes, "text-display": "hidden", onClick: () => this.openAttributesList(imageInputObject.imageInput), scale: "s", icon: "brackets-curly" })))));
        };
        this.getImageInputObject = (imageInputType) => {
            class ImageInputClass {
            }
            const imageInputObject = new ImageInputClass();
            imageInputObject.imageInput = imageInputType;
            imageInputObject.popoverId = `popoverId_${imageInputObject.imageInput}`;
            if (imageInputType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.i.sourceUrl) {
                imageInputObject.inputLabel = this.strings.url;
                imageInputObject.referenceElement = (element) => {
                    element.addEventListener("calciteInputChange", this.changeImageProperties);
                    this.editImageUrl = element;
                };
                imageInputObject.inputValue = this.imageMediaInfo.value.sourceURL;
                imageInputObject.placeHolder = this.strings.imageUrlPlaceHolder;
            }
            else if (imageInputType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.i.title) {
                imageInputObject.inputLabel = this.strings.title;
                imageInputObject.referenceElement = (element) => {
                    element.addEventListener("calciteInputChange", this.changeImageProperties);
                    this.editImageTitle = element;
                };
                imageInputObject.inputValue = this.imageMediaInfo.title;
                imageInputObject.placeHolder = this.strings.imageTitlePlaceHolder;
            }
            else if (imageInputType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.i.caption) {
                imageInputObject.inputLabel = this.strings.caption;
                imageInputObject.referenceElement = (element) => {
                    element.addEventListener("calciteInputChange", this.changeImageProperties);
                    this.editImageCaption = element;
                };
                imageInputObject.inputValue = this.imageMediaInfo.caption;
                imageInputObject.placeHolder = this.strings.imageCaptionPlaceHolder;
            }
            else if (imageInputType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.i.altText) {
                imageInputObject.inputLabel = this.strings.description;
                imageInputObject.referenceElement = (element) => {
                    element.addEventListener("calciteInputChange", this.changeImageProperties);
                    this.editAltText = element;
                };
                imageInputObject.inputValue = this.imageMediaInfo.altText;
                imageInputObject.placeHolder = this.strings.describeImage;
            }
            else if (imageInputType === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.i.linkUrl) {
                imageInputObject.inputLabel = this.strings.link;
                imageInputObject.referenceElement = (element) => {
                    element.addEventListener("calciteInputChange", this.changeImageProperties);
                    this.editImageLinkUrl = element;
                };
                imageInputObject.inputValue = this.imageMediaInfo.value.linkURL;
                imageInputObject.placeHolder = this.strings.imageLinkUrlPlaceHolder;
            }
            return imageInputObject;
        };
        this.guid = undefined;
        this.imageMediaInfo = undefined;
        this.refElement = undefined;
        this.mediaIndexPosition = undefined;
        this.isOpen = false;
        this.reRender = undefined;
    }
    // lifecycle methods
    componentWillLoad() {
        this.strings = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
        this.popupTemplate = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
        this.imageMediaInfo.title = this.imageMediaInfo.title || "";
        this.imageMediaInfo.altText = this.imageMediaInfo.altText || "";
        this.imageMediaInfo.caption = this.imageMediaInfo.caption || "";
        this.imageMediaInfo.value.sourceURL = this.imageMediaInfo.value.sourceURL || "";
        this.imageMediaInfo.value.linkURL = this.imageMediaInfo.value.linkURL || "";
    }
    componentDidLoad() {
        this.editImageUrl.value = this.imageMediaInfo.value.sourceURL;
        this.editImageTitle.value = this.imageMediaInfo.title;
        this.editRefreshImage.value = this.imageMediaInfo.refreshInterval || 0;
        this.editImageCaption.value = this.imageMediaInfo.caption;
        this.editImageLinkUrl.value = this.imageMediaInfo.value.linkURL;
        this.editAltText.value = this.imageMediaInfo.altText;
        this.isOpen = true;
        // need timeout because of re-render
        setTimeout(() => requestAnimationFrame(() => this.panelElement.setFocus()), 300);
    }
    componentDidUpdate() {
        this.notifyMultiMediaChange.emit({
            guid: this.guid,
            mediaIndexPosition: this.mediaIndexPosition
        });
    }
    disconnectedCallback() {
        if (this.popupFieldSelectionPickList) {
            document.body.removeChild(this.popupFieldSelectionPickList);
        }
    }
    // Public Methods
    async reposition() {
        var _a;
        (_a = this.popoverNode) === null || _a === void 0 ? void 0 : _a.reposition();
    }
    // Events
    imageChangedReRenderHandler(event) {
        event.stopPropagation();
        this.reRender = this.reRender ? false : true;
    }
    calciteBlockToggleHandler() {
        this.closePopupPopovers.emit();
    }
    closePopupPopoversHandler() {
        this.removeAttributesSelectionPopover();
    }
    closeMultiMediaPopoverHandler() {
        this.removeAttributesSelectionPopover();
    }
    calciteBlockSectionToggleHandler(event) {
        const composedPath = event.composedPath();
        if ((composedPath === null || composedPath === void 0 ? void 0 : composedPath[0].id) === "refreshImageBlockSection_id") {
            this.editRefreshImage.value = 0;
            this.changeImageProperties(event);
            this.hostElement.shadowRoot.getElementById("managePopover_Id")["reposition"]();
        }
        event.stopPropagation();
    }
    // private methods and properties
    removeAttributesSelectionPopover() {
        if (this.popupFieldSelectionPickList) {
            document.body.removeChild(this.popupFieldSelectionPickList);
            this.popupFieldSelectionPickList = null;
        }
        this.panelElement.disabled = false;
    }
    // field selection for title and caption
    popupFieldSelectionPickListChanges(event, currImageComponentInputTypes) {
        const selectedFieldName = event.detail.selectedFields[0];
        if (currImageComponentInputTypes === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.i.sourceUrl) {
            this.editImageUrl.value = addSelectedFieldAtCursor(this.editImageUrl, selectedFieldName);
            this.editImageUrl.setFocus();
        }
        else if (currImageComponentInputTypes === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.i.title) {
            this.editImageTitle.value = addSelectedFieldAtCursor(this.editImageTitle, selectedFieldName);
            this.editImageTitle.setFocus();
        }
        else if (currImageComponentInputTypes === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.i.caption) {
            this.editImageCaption.value = addSelectedFieldAtCursor(this.editImageCaption, selectedFieldName);
            this.editImageCaption.setFocus();
        }
        else if (currImageComponentInputTypes === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.i.linkUrl) {
            this.editImageLinkUrl.value = addSelectedFieldAtCursor(this.editImageLinkUrl, selectedFieldName);
            this.editImageLinkUrl.setFocus();
        }
        else if (currImageComponentInputTypes === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.i.altText) {
            this.editAltText.value = addSelectedFieldAtCursor(this.editAltText, selectedFieldName);
            this.editAltText.setFocus();
        }
        this.closePopupPopovers.emit(this.guid);
        this.changeImageProperties();
    }
    render() {
        const refreshImageInput = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block-section", { id: "refreshImageBlockSection_id", text: this.strings.refreshInterval, toggleDisplay: "switch", open: this.imageMediaInfo.refreshInterval ? true : false }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "refresh-label" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { scale: "s", layout: "inline" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { class: CSS$2.refreshImageInput, type: "number", min: 0, max: 1440, ref: (element) => {
                element.addEventListener("calciteInputChange", this.changeImageProperties);
                this.editRefreshImage = element;
            }, value: this.imageMediaInfo.refreshInterval
                ? this.imageMediaInfo.refreshInterval.toString()
                : "0", onClick: () => this.closePopupPopovers.emit(this.guid), onCalciteInputInput: () => {
                if (this.editRefreshImage.value) {
                    const value = parseInt(this.editRefreshImage.value);
                    if (value < 0) {
                        this.editRefreshImage.value = 0;
                    }
                    else if (value > 1440) {
                        this.editRefreshImage.value = 1440;
                    }
                }
            } }), this.strings.minutes))));
        const imageDiv = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable" }, this.imageFormInput(_commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.i.sourceUrl), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block-section", { open: true, text: this.strings.options }, this.imageFormInput(_commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.i.title), this.imageFormInput(_commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.i.caption), this.imageFormInput(_commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.i.altText), this.imageFormInput(_commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__.i.linkUrl), refreshImageInput)));
        const doneBtn = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "outline-fill", scale: "m", slot: "footer", width: "full", onClick: () => this.closePopupPopovers.emit() }, this.strings.done));
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "js-app-flyout" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-popover", { dir: (0,_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), id: "managePopover_Id", placement: "leading-start", open: this.isOpen, pointerDisabled: true, referenceElement: this.refElement, offsetDistance: -Math.round(this.refElement.getBoundingClientRect().width), offsetSkidding: 50, label: "", style: {
                zIndex: "100"
            }, triggerDisabled: true, ref: (node) => (this.popoverNode = node) }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-panel", { ref: (element) => (this.panelElement = element), closable: true, style: {
                width: `${this.refElement.getBoundingClientRect().width}px`
            }, onCalcitePanelClose: () => this.closePopupPopovers.emit() }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "header-content" }, this.strings.configureImage), doneBtn, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$2.popoverImageDiv }, imageDiv)))));
    }
    get hostElement() { return (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisPopupImage.style = arcgisPopupImageCss;

const ArcgisPopupMainContentpopover = class {
    constructor(hostRef) {
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
        this.closePopupPopovers = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
        this.notifyAddContentSelection = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "notifyAddContentSelection", 7);
        this.notifyAddMultiMediaContentSelection = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "notifyAddMultiMediaContentSelection", 7);
        this.contentPopoverRefElement = undefined;
        this.popupHasAttachment = undefined;
        this.popoverPanelWidth = undefined;
        this.isMultimediaContent = false;
        this.guid = undefined;
        this.isOpen = false;
    }
    async reposition() {
        var _a;
        (_a = this.popoverElement) === null || _a === void 0 ? void 0 : _a.reposition();
    }
    componentWillLoad() {
        this.strings = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
        this.layerHasAttachment = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasAttachment;
        this.layerHasET = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasET;
        this.layerHasAttributes = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasAttributes;
        this.layerHasCharts = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasCharts;
        this.layerHasImages = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasImages;
        this.layerHasText = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasText;
        this.popupTemplate = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
        this.supportsArcade = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.supportsArcade;
    }
    componentDidLoad() {
        this.hostElement.shadowRoot.getElementById("managePopover_Id")["reposition"]();
        this.isOpen = true;
        // need timeout because of re-render
        setTimeout(() => requestAnimationFrame(() => this.panelElement.setFocus()), 300);
    }
    contentSelection(content) {
        if (this.isMultimediaContent) {
            this.notifyAddMultiMediaContentSelection.emit({ guid: this.guid, content: content });
        }
        else {
            this.notifyAddContentSelection.emit(content);
        }
    }
    // rendor methods
    render() {
        const attributes = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { label: this.strings.fieldsList, text: this.strings.fieldsList, textEnabled: true, onClick: () => {
                this.contentSelection(ContentSelection.attributes);
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "feature-details" })));
        const attachments = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { label: this.strings.attachments, text: this.strings.attachments, textEnabled: true, onClick: () => {
                this.contentSelection(ContentSelection.attachments);
            }, disabled: this.popupHasAttachment ? true : false }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "attachment" })));
        const charts = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { label: this.strings.chart, text: this.strings.chart, textEnabled: true, onClick: () => {
                this.contentSelection(ContentSelection.charts);
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "graph-bar" })));
        const images = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { label: this.strings.image, text: this.strings.image, textEnabled: true, onClick: () => {
                this.contentSelection(ContentSelection.images);
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "image" })));
        const richText = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { label: this.strings.text, text: this.strings.text, textEnabled: true, onClick: () => {
                this.contentSelection(ContentSelection.richText);
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "text" })));
        const arcade = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { label: this.strings.arcade, text: this.strings.arcade, icon: "code", textEnabled: true, onClick: () => {
                this.contentSelection(ContentSelection.arcade);
            } }));
        const et = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { label: this.strings.summaryETHeading, text: this.strings.summaryETHeading, textEnabled: true, onClick: () => {
                this.contentSelection(ContentSelection.summaryET);
            }, disabled: this.popupTemplate.lastEditInfoEnabled ? true : false }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "user" })));
        const relatedRecords = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { label: this.strings.relatedRecords, text: this.strings.relatedRecords, textEnabled: true, onClick: () => {
                this.contentSelection(ContentSelection.relationship);
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "link" })));
        const panel = (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.q)(this.contentPopoverRefElement, "calcite-flow-item");
        const panelTop = (panel === null || panel === void 0 ? void 0 : panel.getBoundingClientRect().top) || 56;
        const buttonTop = this.contentPopoverRefElement.getBoundingClientRect().top;
        // 54: panel header; 10: panel arrow
        const popoverMaxHeight = buttonTop - panelTop - 54 - 10;
        const contentStyle = { maxHeight: popoverMaxHeight > 0 ? `${popoverMaxHeight}px` : "60vh" };
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "js-app-flyout" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-popover", { ref: (el) => (this.popoverElement = el), dir: (0,_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), id: "managePopover_Id", placement: "bottom", open: this.isOpen, referenceElement: this.contentPopoverRefElement, label: this.isMultimediaContent ? this.strings.addMedia : this.strings.addContent, style: {
                zIndex: "100"
            }, triggerDisabled: true }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-panel", { ref: (el) => (this.panelElement = el), closable: true, style: {
                width: `${this.popoverPanelWidth}px`
            }, onCalcitePanelClose: () => this.closePopupPopovers.emit() }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "header-content" }, this.isMultimediaContent ? this.strings.addMedia : this.strings.content), this.isMultimediaContent ? ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { style: contentStyle }, this.layerHasCharts && charts, this.layerHasImages && images)) : ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { style: contentStyle }, this.layerHasAttributes && attributes, this.layerHasAttachment && attachments, this.layerHasCharts && charts, this.layerHasImages && images, this.layerHasText && richText, this.supportsArcade && arcade, this.layerHasET && et, _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layerHasRelatedRecords && relatedRecords))))));
    }
    get hostElement() { return (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};

const CSS$1 = {
    addMediaButton: "add-media-button",
    formInputButton: "form-input-button",
    disableSpacing: "disable-spacing"
};

const arcgisPopupMultimediaCss = ".add-media-button{display:flex;justify-content:center;padding:var(--arcgis-app-cap-spacing-half) 0 0 0}.form-input-button{display:flex}.form-input-button calcite-input[type=text]{display:flex;flex-flow:column nowrap;flex:1 0 0%;overflow:hidden}.form-input-button calcite-action{margin:0;flex:0 0 0%;justify-self:flex-end}.disable-spacing{--calcite-label-margin-bottom:0}";

const ArcgisPopupMultimedia = class {
    constructor(hostRef) {
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
        this.closePopupPopovers = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
        this.closeMultiMediaPopover = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closeMultiMediaPopover", 7);
        this.internalPopupUpdated = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "internalPopupUpdated", 7);
        this.deleteComponent = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "deleteComponent", 7);
        this.disablePopupPanel = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "disablePopupPanel", 7);
        this.pickList = [];
        // to keep track of drag and drop
        this.mediaMap = new Map();
        this.calciteValueListItem = (mediaInfo, listItemGuid) => ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-value-list-item", { id: listItemGuid, label: (mediaInfo.title &&
                `${mediaInfo.title.substring(0, 25)}${mediaInfo.title.length > 25 ? "..." : ""}`) ||
                this.strings.noTitle, description: this.getMultiMediaText(mediaInfo.type), value: listItemGuid, onClick: (event) => {
                event.stopPropagation();
                this.closePopupPopovers.emit();
                this.openMediaPopover(mediaInfo, this.findChartIndexPosition(listItemGuid));
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { slot: "actions-end", appearance: "transparent", text: this.strings.remove, onClick: (event) => {
                event.stopPropagation();
                this.closePopupPopovers.emit();
                // each list-item has id. Find id, and splice by index
                const allListItems = this.hostElement.shadowRoot
                    .getElementById("valueList_Id")
                    .getElementsByTagName("calcite-value-list-item");
                for (let x = 0; x < allListItems.length; x++) {
                    if (allListItems[x].id === listItemGuid) {
                        this.multimediaContent.mediaInfos.splice(x, 1);
                        // delete component if empty, else re-render
                        if (this.multimediaContent.mediaInfos.length === 0) {
                            this.deleteComponent.emit(this.guid);
                        }
                        else {
                            // reset to 0 on delete
                            this.setActiveMediaInfoIndex(0);
                            this.reRender = this.reRender ? false : true;
                        }
                        break;
                    }
                }
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "x" }))));
        this.formInput = (formType, formString, formInputElement, formValue, formPlaceholder
        // promptMessage: string
        ) => {
            var _a;
            return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { scale: "s" }, formString, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$1.formInputButton }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { type: "text", autofocus: true, ref: formInputElement, value: formValue, placeholder: formPlaceholder, onCalciteInputInput: (event) => {
                    event.stopPropagation();
                    const inputVal = event.target.value;
                    if (formType === "title") {
                        this.multimediaContent.title = inputVal;
                    }
                    else {
                        this.multimediaContent.description = inputVal;
                    }
                    this.reRender = !this.reRender;
                }, onClick: () => this.closePopupPopovers.emit() }), ((_a = this.popupTemplate.fieldInfos) === null || _a === void 0 ? void 0 : _a.length) > 0 && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: this.strings.attributes, onClick: () => {
                    this.closePopupPopovers.emit();
                    if (!this.popupFieldSelectionPickList) {
                        this.popupFieldSelectionPickList = document.createElement("arcgis-popup-field-pick-list");
                        this.popupFieldSelectionPickList.popoverProps = {
                            refElement: this.popupFlowItem
                        };
                        this.popupFieldSelectionPickList.multiple = false;
                        this.popupFieldSelectionPickList.heading = this.strings.addField;
                        this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListDismissed", () => {
                            this.closePopupPopovers.emit();
                        });
                        this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListChange", (event) => this.popupFieldSelectionPickListChanges(event, formType));
                        document.body.appendChild(this.popupFieldSelectionPickList);
                        this.disablePopupPanel.emit(true);
                    }
                }, scale: "s", icon: "brackets-curly" })))));
        };
        this.guid = undefined;
        this.multimediaContent = undefined;
        this.blockOpen = false;
        this.popupFlowItem = undefined;
        this.reRender = undefined;
    }
    // lifecycle methods
    async componentWillLoad() {
        this.strings = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
        this.mapView = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.mapView;
        this.popupTemplate = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
        // watch if popup changes to reset the index
        const [reactiveUtils] = await (0,_loadModules_b4ac1247_js__WEBPACK_IMPORTED_MODULE_4__.l)(["esri/core/reactiveUtils"]);
        reactiveUtils.watch(() => { var _a; return (_a = this.mapView.popup) === null || _a === void 0 ? void 0 : _a.selectedFeature; }, () => this.setActiveMediaInfoIndex(0));
        reactiveUtils.watch(() => { var _a; return (_a = this.mapView.popup) === null || _a === void 0 ? void 0 : _a.visible; }, () => this.setActiveMediaInfoIndex(0));
        if (!this.multimediaContent.title) {
            this.multimediaContent.title = "";
        }
        if (!this.multimediaContent.description) {
            this.multimediaContent.description = "";
        }
    }
    componentDidLoad() {
        if (this.blockOpen) {
            this.addMediaBtn.scrollIntoView({ behavior: "auto", block: "nearest", inline: "start" });
            if (this.multimediaContent.mediaInfos.length === 1) {
                this.openMediaPopover(this.multimediaContent.mediaInfos[0], 0);
            }
            else {
                this.blockOptions.setFocus();
            }
        }
    }
    componentWillRender() {
        this.pickList = [];
        this.mediaMap.clear();
        this.multimediaContent.mediaInfos.forEach((mediaInfo) => {
            const listItemGuid = (0,_guid_aeaed84d_js__WEBPACK_IMPORTED_MODULE_5__.g)();
            this.mediaMap.set(listItemGuid, mediaInfo);
            this.pickList.push(this.calciteValueListItem(mediaInfo, listItemGuid));
        });
    }
    componentDidUpdate() {
        this.internalPopupUpdated.emit();
    }
    disconnectedCallback() {
        if (this.imagePopover) {
            document.body.removeChild(this.imagePopover);
        }
        if (this.chartPopover) {
            document.body.removeChild(this.chartPopover);
        }
        if (this.multimediaContentPopover) {
            document.body.removeChild(this.multimediaContentPopover);
        }
        if (this.popupFieldSelectionPickList) {
            document.body.removeChild(this.popupFieldSelectionPickList);
        }
    }
    // events
    calciteBlockToggleHandler() {
        this.closePopupPopovers.emit();
    }
    // drag and drop to re-order
    calciteListOrderChangeHandler() {
        let tempMediaInfos = [];
        const allListItems = this.hostElement.shadowRoot
            .getElementById("valueList_Id")
            .getElementsByTagName("calcite-value-list-item");
        const eventValueGuids = Array.from(allListItems).map((item) => item.id);
        eventValueGuids.forEach((eventValueGuid) => {
            if (this.mediaMap.has(eventValueGuid)) {
                tempMediaInfos.push(this.mediaMap.get(eventValueGuid));
            }
        });
        if (tempMediaInfos.length > 0) {
            this.multimediaContent.mediaInfos = tempMediaInfos;
        }
        // reset to 0 on drag and drop
        this.setActiveMediaInfoIndex(0, true);
        // dont need to re-render since only updating media infos.
        // calcite pick list takes care of rendering correctly.
        this.closePopupPopovers.emit();
    }
    resetMultiMediaIndexHandler() {
        this.setActiveMediaInfoIndex(0, true);
    }
    closePopupPopoversHandler(event) {
        if ((event === null || event === void 0 ? void 0 : event.detail) !== this.guid && this.imagePopover) {
            this.closeMultiMediaPopover.emit();
            document.body.removeChild(this.imagePopover);
            this.imagePopover = null;
            this.addMediaBtn.setFocus();
            this.disablePopupPanel.emit(false);
        }
        if ((event === null || event === void 0 ? void 0 : event.detail) !== this.guid && this.chartPopover) {
            this.closeMultiMediaPopover.emit();
            document.body.removeChild(this.chartPopover);
            this.chartPopover = null;
            this.addMediaBtn.setFocus();
            this.disablePopupPanel.emit(false);
        }
        if (this.multimediaContentPopover) {
            document.body.removeChild(this.multimediaContentPopover);
            this.multimediaContentPopover = null;
            this.addMediaBtn.disabled = false;
            requestAnimationFrame(() => this.addMediaBtn.setFocus());
            this.disablePopupPanel.emit(false);
        }
        if (this.popupFieldSelectionPickList) {
            document.body.removeChild(this.popupFieldSelectionPickList);
            this.popupFieldSelectionPickList = null;
            this.disablePopupPanel.emit(false);
        }
    }
    notifyMultiMediaChangeHandler(event) {
        var _a, _b;
        if (((_a = event.detail) === null || _a === void 0 ? void 0 : _a.guid) === this.guid) {
            this.setActiveMediaInfoIndex((_b = event.detail) === null || _b === void 0 ? void 0 : _b.mediaIndexPosition);
            this.reRender = this.reRender ? false : true;
        }
    }
    async notifyAddMultiMediaContentSelectionHandler(event) {
        event.stopPropagation();
        this.closePopupPopovers.emit();
        if (event.detail.guid === this.guid) {
            const contentType = event.detail.content;
            const [ImageMediaInfo, ColumnChartMediaInfo, ImageMediaInfoValue, ChartMediaInfoValue] = await (0,_loadModules_b4ac1247_js__WEBPACK_IMPORTED_MODULE_4__.l)([
                "esri/popup/content/ImageMediaInfo",
                "esri/popup/content/ColumnChartMediaInfo",
                "esri/popup/content/support/ImageMediaInfoValue",
                "esri/popup/content/support/ChartMediaInfoValue"
            ]);
            let multiMediaElement;
            if (contentType === ContentSelection.images) {
                multiMediaElement = new ImageMediaInfo({
                    title: "",
                    caption: "",
                    altText: "",
                    value: new ImageMediaInfoValue({
                        sourceURL: "",
                        linkURL: ""
                    })
                });
            }
            else if (contentType === ContentSelection.charts) {
                multiMediaElement = new ColumnChartMediaInfo({
                    title: "",
                    caption: "",
                    altText: "",
                    value: new ChartMediaInfoValue({
                        fields: []
                    })
                });
            }
            this.multimediaContent.mediaInfos.push(multiMediaElement);
            this.reRender = !this.reRender;
            this.openMediaPopover(multiMediaElement, this.multimediaContent.mediaInfos.length - 1);
        }
    }
    // private methods
    setActiveMediaInfoIndex(index, updatePopup) {
        this.multimediaContent.activeMediaInfoIndex = index || 0;
        updatePopup && this.internalPopupUpdated.emit();
    }
    findChartIndexPosition(listItemGuid) {
        const allListItems = this.hostElement.shadowRoot
            .getElementById("valueList_Id")
            .getElementsByTagName("calcite-value-list-item");
        for (let x = 0; x < allListItems.length; x++) {
            if (allListItems[x].id === listItemGuid) {
                return x;
            }
        }
    }
    getMultiMediaText(type) {
        if (type === PopupMultiMediaType.image) {
            return this.strings.image;
        }
        else if (type === PopupMultiMediaType.barChart || type === PopupMultiMediaType.columnChart) {
            return this.strings.barChart;
        }
        else if (type === PopupMultiMediaType.lineChart) {
            return this.strings.lineChart;
        }
        else if (type === PopupMultiMediaType.pieChart) {
            return this.strings.pieChart;
        }
        return this.strings.image;
    }
    openMediaPopover(mediaInfo, indexPosition) {
        if (mediaInfo.type === PopupMultiMediaType.image) {
            this.imagePopover = document.createElement("arcgis-popup-image");
            this.imagePopover.guid = this.guid;
            this.imagePopover.refElement = this.popupFlowItem;
            this.imagePopover.imageMediaInfo = mediaInfo;
            this.imagePopover.mediaIndexPosition = indexPosition;
            document.body.appendChild(this.imagePopover);
        }
        else {
            this.chartPopover = document.createElement("arcgis-popup-chart");
            this.chartPopover.guid = this.guid;
            this.chartPopover.refElement = this.popupFlowItem;
            this.chartPopover.chartMediaInfo = mediaInfo;
            this.chartPopover.mediaContent = this.multimediaContent;
            this.chartPopover.mediaIndexPosition = indexPosition;
            document.body.appendChild(this.chartPopover);
        }
        this.disablePopupPanel.emit(true);
    }
    getSummartText() {
        if (this.multimediaContent.mediaInfos.length > 1) {
            return `${this.strings.multiple} (${this.multimediaContent.mediaInfos.length})`;
        }
        else {
            return this.getMultiMediaText(this.multimediaContent.mediaInfos[0].type);
        }
    }
    // field selection for title and caption
    popupFieldSelectionPickListChanges(event, formType) {
        const selectedFieldName = event.detail.selectedFields[0];
        if (formType === "title") {
            this.contentTitle.value = addSelectedFieldAtCursor(this.contentTitle, selectedFieldName);
            this.contentTitle.setFocus();
            this.multimediaContent.title = this.contentTitle.value;
        }
        else if (formType === "description") {
            this.contentDescription.value = addSelectedFieldAtCursor(this.contentDescription, selectedFieldName);
            this.contentDescription.setFocus();
            this.multimediaContent.description = this.contentDescription.value;
        }
        this.closePopupPopovers.emit();
        this.reRender = !this.reRender;
    }
    // rendor methods
    render() {
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.H, null, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { dir: (0,_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), heading: this.multimediaContent.mediaInfos.length > 1
                ? this.strings.mediaGroup
                : this.strings.media, description: (this.multimediaContent.title &&
                `${this.multimediaContent.title.substring(0, 25)}${this.multimediaContent.title.length > 25 ? "..." : ""}`) ||
                this.getSummartText(), collapsible: true, open: this.blockOpen, dragHandle: true }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable", slot: "control" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-calcite-block-options", { ref: (el) => (this.blockOptions = el), guid: this.guid, intlOptions: this.strings.options, intlDelete: this.strings.delete, intlDuplicate: this.strings.duplicate, calciteBlockOptions: { hasDelete: true, hasDuplicate: true } })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "icon" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "m", icon: "images" })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable" }, this.formInput("title", this.strings.title, (element) => {
            return (this.contentTitle = element);
        }, this.multimediaContent.title, this.strings.enterTitle
        // this.strings.titleContext.replace("${titleContext}", this.strings.media_L)
        ), this.formInput("description", this.strings.desc, (element) => {
            return (this.contentDescription = element);
        }, this.multimediaContent.description, this.strings.enterDescription
        // this.strings.descriptionContext.replace("${descriptionContext}", this.strings.media_L)
        ), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { class: CSS$1.disableSpacing, scale: "s" }, this.strings.mediaContent), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-value-list", { id: "valueList_Id", "drag-enabled": true }, this.pickList), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { ref: (el) => (this.addMediaBtn = el), title: this.strings.addMedia, appearance: "outline-fill", round: true, scale: "s", class: CSS$1.addMediaButton, iconStart: "plus", onClick: (event) => {
                event.stopPropagation();
                this.closePopupPopovers.emit();
                if (!this.multimediaContentPopover) {
                    this.multimediaContentPopover = document.createElement("arcgis-popup-main-contentpopover");
                    this.multimediaContentPopover.contentPopoverRefElement = this.addMediaBtn;
                    this.multimediaContentPopover.popoverPanelWidth =
                        this.hostElement.getBoundingClientRect().width;
                    this.multimediaContentPopover.isMultimediaContent = true;
                    this.multimediaContentPopover.guid = this.guid;
                    document.body.appendChild(this.multimediaContentPopover);
                    this.addMediaBtn.disabled = true;
                    this.disablePopupPanel.emit(true);
                }
            } })))));
    }
    get hostElement() { return (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisPopupMultimedia.style = arcgisPopupMultimediaCss;

const arcgisPopupRelationshipCss = ".form-input-button{display:flex}.form-input-button calcite-input[type=text]{display:flex;flex-flow:column nowrap;flex:1 0 0%;overflow:hidden}.form-input-button calcite-action{margin:0;flex:0 0 0%;justify-self:flex-end}.dropdown{width:100%}";

const ArcgisPopupRelationship = class {
    constructor(hostRef) {
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
        this.closePopupPopovers = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
        this.internalPopupUpdated = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "internalPopupUpdated", 7);
        this.disablePopupPanel = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "disablePopupPanel", 7);
        this.maxPreviewCount = 11;
        this.fieldPickListChanges = (event) => {
            var _a, _b;
            event.stopPropagation();
            const selectedField = (_b = (_a = event.detail) === null || _a === void 0 ? void 0 : _a.selectedFields) === null || _b === void 0 ? void 0 : _b[0];
            if (selectedField) {
                this.relatedRecordsContent.orderByFields[0].field = selectedField;
                this.reRender = !this.reRender;
            }
            this.closePopupPopovers.emit();
        };
        this.formInput = (formType, formString, formInputElement, formValue, formPlaceholder) => {
            var _a;
            return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", { scale: "s" }, formString, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "form-input-button" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { type: "text", autofocus: true, ref: formInputElement, value: formValue, placeholder: formPlaceholder, disabled: !this.hasRelationshipLayer, onCalciteInputInput: (event) => {
                    event.stopPropagation();
                    const inputVal = event.target.value;
                    if (formType === "title") {
                        this.relatedRecordsContent.title = inputVal;
                    }
                    else {
                        this.relatedRecordsContent.description = inputVal;
                    }
                    this.reRender = !this.reRender;
                }, onClick: () => this.closePopupPopovers.emit() }), ((_a = this.popupTemplate.fieldInfos) === null || _a === void 0 ? void 0 : _a.length) && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: this.strings.attributes, disabled: !this.hasRelationshipLayer, onClick: () => {
                    this.closePopupPopovers.emit();
                    if (!this.popupFieldSelectionPickList) {
                        this.popupFieldSelectionPickList = document.createElement("arcgis-popup-field-pick-list");
                        this.popupFieldSelectionPickList.popoverProps = {
                            refElement: this.popupFlowItem,
                            offsetSkidding: 50
                        };
                        this.popupFieldSelectionPickList.multiple = false;
                        this.popupFieldSelectionPickList.heading = this.strings.addField;
                        this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListDismissed", () => {
                            this.closePopupPopovers.emit();
                        });
                        this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListChange", (event) => this.popupFieldSelectionPickListChanges(event, formType));
                        document.body.appendChild(this.popupFieldSelectionPickList);
                        this.disablePopupPanel.emit(true);
                    }
                }, scale: "s", icon: "brackets-curly" })))));
        };
        this.guid = undefined;
        this.relatedRecordsContent = undefined;
        this.blockOpen = false;
        this.popupFlowItem = undefined;
        this.reRender = undefined;
        this.hasRelationshipLayer = true;
    }
    // --------------------------------------------------------------------------
    //
    //  Lifecycle
    //
    // --------------------------------------------------------------------------
    async componentWillLoad() {
        this.strings = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
        this.layer = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.layer;
        this.view = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.mapView;
        this.popupTemplate = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
        await this.loadAllModules();
        this.hasRelationshipLayer = await this.checkIfRelationshipExists();
        if (!this.relatedRecordsContent.title) {
            this.relatedRecordsContent.title = "";
        }
        if (!this.relatedRecordsContent.description) {
            this.relatedRecordsContent.description = "";
        }
    }
    componentDidLoad() {
        if (this.blockOpen) {
            this.blockOptions.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "start" });
            this.blockOptions.setFocus();
        }
        this.watchForChangesToLayersList();
    }
    componentDidUpdate() {
        this.internalPopupUpdated.emit();
    }
    disconnectedCallback() {
        var _a;
        (_a = this.watchLayersTables) === null || _a === void 0 ? void 0 : _a.remove();
        if (this.popupFieldSelectionPickList) {
            document.body.removeChild(this.popupFieldSelectionPickList);
        }
        if (this.arcgisFieldPickList) {
            document.body.removeChild(this.arcgisFieldPickList);
        }
    }
    // --------------------------------------------------------------------------
    //
    // Events
    //
    // --------------------------------------------------------------------------
    closePopupPopoversHandler() {
        if (this.popupFieldSelectionPickList) {
            document.body.removeChild(this.popupFieldSelectionPickList);
            this.popupFieldSelectionPickList = null;
            this.disablePopupPanel.emit(false);
        }
        if (this.arcgisFieldPickList) {
            document.body.removeChild(this.arcgisFieldPickList);
            this.arcgisFieldPickList = null;
            this.disablePopupPanel.emit(false);
        }
    }
    // --------------------------------------------------------------------------
    //
    // Private Methods
    //
    // --------------------------------------------------------------------------
    async loadAllModules() {
        [this.RelatedRecordsInfoFieldOrder, this.reactiveUtils] = await (0,_loadModules_b4ac1247_js__WEBPACK_IMPORTED_MODULE_4__.l)([
            "esri/popup/support/RelatedRecordsInfoFieldOrder",
            "esri/core/reactiveUtils"
        ]);
    }
    // field selection for title and caption
    popupFieldSelectionPickListChanges(event, formType) {
        const selectedFieldName = event.detail.selectedFields[0];
        if (formType === "title") {
            this.contentTitle.value = addSelectedFieldAtCursor(this.contentTitle, selectedFieldName);
            this.contentTitle.setFocus();
            this.relatedRecordsContent.title = this.contentTitle.value;
        }
        else if (formType === "description") {
            this.contentDescription.value = addSelectedFieldAtCursor(this.contentDescription, selectedFieldName);
            this.contentDescription.setFocus();
            this.relatedRecordsContent.description = this.contentDescription.value;
        }
        this.closePopupPopovers.emit();
        this.reRender = !this.reRender;
    }
    async openPickList(currLayer) {
        var _a, _b, _c;
        this.closePopupPopovers.emit();
        if (!this.arcgisFieldPickList) {
            this.arcgisFieldPickList = document.createElement("arcgis-field-pick-list");
            this.arcgisFieldPickList.popoverProps = {
                refElement: this.popupFlowItem,
                offsetSkidding: 50
            };
            this.arcgisFieldPickList.fields = currLayer.fields.filter((field) => field.visible);
            this.arcgisFieldPickList.layer = currLayer;
            this.arcgisFieldPickList.mapView = this.view;
            this.arcgisFieldPickList.showFieldInfo = true;
            this.arcgisFieldPickList.showFieldName = true;
            this.arcgisFieldPickList.selectedFields = [
                (_c = (_b = (_a = this.relatedRecordsContent) === null || _a === void 0 ? void 0 : _a.orderByFields) === null || _b === void 0 ? void 0 : _b[0]) === null || _c === void 0 ? void 0 : _c.field
            ];
            this.arcgisFieldPickList.addEventListener("arcgisFieldPickListDismissed", this.fieldPickListChanges);
            document.body.appendChild(this.arcgisFieldPickList);
            this.disablePopupPanel.emit(true);
        }
    }
    async checkIfRelationshipExists() {
        var _a;
        for (const relationship of (_a = this.layer) === null || _a === void 0 ? void 0 : _a.relationships) {
            if (relationship.id === this.relatedRecordsContent.relationshipId) {
                for (const currLayerOrTable of [...this.view.map.allLayers, ...this.view.map.allTables]) {
                    const curr = currLayerOrTable;
                    if (await relationshipExists(this.layer, curr, relationship)) {
                        await curr.load();
                        return Promise.resolve(true);
                    }
                }
                return Promise.resolve(false);
            }
        }
        return Promise.resolve(false);
    }
    watchForChangesToLayersList() {
        this.watchLayersTables = this.reactiveUtils.watch(() => [this.view.map.allLayers.length, this.view.map.allTables.length], async () => {
            // check if related layer/table is removed, and disable panel/show warning if yes
            this.hasRelationshipLayer = await this.checkIfRelationshipExists();
        });
    }
    // --------------------------------------------------------------------------
    //
    // Rendor  Methods
    //
    // --------------------------------------------------------------------------
    render() {
        var _a, _b, _c, _d, _e, _f, _g;
        const relationship = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, this.strings.relationship, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown", { disabled: !this.hasRelationshipLayer, overlayPositioning: "fixed", class: "dropdown" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { slot: "trigger", appearance: "outline-fill", kind: "neutral", iconEnd: "chevronDown", alignment: "icon-end-space-between", width: "full", scale: "m" }, (() => {
            for (const relationship of this.layer.relationships) {
                if (relationship.id === this.relatedRecordsContent.relationshipId) {
                    return relationship.name || this.strings.relationship;
                }
            }
            return this.strings.relationship;
        })()), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-group", null, this.layer.relationships.map((relationship) => {
            for (const currLayerOrTable of [
                ...this.view.map.allLayers,
                ...this.view.map.allTables
            ]) {
                const curr = currLayerOrTable;
                if (relationshipExistsCheckWithoutLoad(this.layer, curr, relationship)) {
                    return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { selected: this.relatedRecordsContent.relationshipId === relationship.id, onClick: async () => {
                            var _a;
                            await curr.load();
                            this.relatedRecordsContent.relationshipId = relationship.id;
                            this.relatedRecordsContent.orderByFields = [
                                new this.RelatedRecordsInfoFieldOrder({
                                    field: curr.fields.find((field) => field.visible)
                                        .name,
                                    order: ((_a = this.relatedRecordsContent.orderByFields) === null || _a === void 0 ? void 0 : _a[0].order) || "asc"
                                })
                            ];
                            this.reRender = !this.reRender;
                        } }, relationship.name || this.strings.relationship));
                }
            }
        })))));
        const sortBy = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, this.strings.sortBy, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "outline-fill", kind: "neutral", iconEnd: "chevronDown", alignment: "icon-end-space-between", width: "full", scale: "m", disabled: !this.hasRelationshipLayer, onClick: async () => {
                // find the layer/table, and display the pick list based on the related layer/table
                this.layer.relationships.map(async (relationship) => {
                    for (const currLayerOrTable of [
                        ...this.view.map.allLayers,
                        ...this.view.map.allTables
                    ]) {
                        const curr = currLayerOrTable;
                        if (this.relatedRecordsContent.relationshipId === relationship.id &&
                            relationshipExistsCheckWithoutLoad(this.layer, curr, relationship)) {
                            this.openPickList(curr);
                        }
                    }
                });
            } }, ((_c = (_b = (_a = this.relatedRecordsContent) === null || _a === void 0 ? void 0 : _a.orderByFields) === null || _b === void 0 ? void 0 : _b[0]) === null || _c === void 0 ? void 0 : _c.field) || this.strings.default)));
        const sortOrder = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, this.strings.sortOrder, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown", { disabled: !this.hasRelationshipLayer, overlayPositioning: "fixed" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { slot: "trigger", appearance: "outline-fill", kind: "neutral", iconEnd: "chevronDown", alignment: "icon-end-space-between", width: "full", scale: "m" }, ((_d = this.relatedRecordsContent.orderByFields) === null || _d === void 0 ? void 0 : _d[0].order) === "desc"
            ? this.strings.descending
            : this.strings.ascending), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { selected: ((_e = this.relatedRecordsContent.orderByFields) === null || _e === void 0 ? void 0 : _e[0].order) === "asc", onClick: () => {
                this.relatedRecordsContent.orderByFields[0].order = "asc";
                this.reRender = !this.reRender;
            } }, this.strings.ascending), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { selected: ((_f = this.relatedRecordsContent.orderByFields) === null || _f === void 0 ? void 0 : _f[0].order) === "desc", onClick: () => {
                this.relatedRecordsContent.orderByFields[0].order = "desc";
                this.reRender = !this.reRender;
            } }, this.strings.descending))));
        const previewCount = ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-label", null, this.strings.previewCount, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown", { disabled: !this.hasRelationshipLayer, overlayPositioning: "fixed" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { slot: "trigger", appearance: "outline-fill", kind: "neutral", iconEnd: "chevronDown", alignment: "icon-end-space-between", width: "full", scale: "m" }, (_g = (this.relatedRecordsContent.displayCount === 0
            ? this.strings.none
            : this.relatedRecordsContent.displayCount)) !== null && _g !== void 0 ? _g : 1), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-group", null, [...Array(this.maxPreviewCount).keys()].map((x) => {
            return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { selected: this.relatedRecordsContent.displayCount === x, onClick: () => {
                    this.relatedRecordsContent.displayCount = x;
                    this.reRender = !this.reRender;
                } }, x === 0 ? this.strings.none : x));
        })))));
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.H, null, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { dir: (0,_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), heading: this.strings.relatedRecords, description: (this.relatedRecordsContent.title &&
                `${this.relatedRecordsContent.title.substring(0, 25)}${this.relatedRecordsContent.title.length > 25 ? "..." : ""}`) ||
                (() => {
                    for (const relationship of this.layer.relationships) {
                        if (relationship.id === this.relatedRecordsContent.relationshipId) {
                            return relationship.name;
                        }
                    }
                    return this.strings.selectTable;
                })(), collapsible: true, open: this.blockOpen, dragHandle: true, onCalciteBlockOpen: () => this.closePopupPopovers.emit(), onCalciteBlockClose: () => this.closePopupPopovers.emit() }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable", slot: "control" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-calcite-block-options", { ref: (el) => (this.blockOptions = el), guid: this.guid, intlOptions: this.strings.options, intlDelete: this.strings.delete, intlDuplicate: this.strings.duplicate, calciteBlockOptions: { hasDelete: true, hasDuplicate: this.hasRelationshipLayer } })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "icon" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "m", icon: this.hasRelationshipLayer ? "link" : "exclamation-mark-triangle" })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable" }, this.formInput("title", this.strings.title, (element) => {
            return (this.contentTitle = element);
        }, this.relatedRecordsContent.title, this.strings.enterTitle), this.formInput("description", this.strings.desc, (element) => {
            return (this.contentDescription = element);
        }, this.relatedRecordsContent.description, this.strings.enterDescription), relationship, sortBy, sortOrder, previewCount))));
    }
    get hostElement() { return (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisPopupRelationship.style = arcgisPopupRelationshipCss;

const ArcgisPopupRichtext = class {
    constructor(hostRef) {
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
        this.closePopupPopovers = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
        this.internalPopupUpdated = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "internalPopupUpdated", 7);
        this.richTextChangedReRender = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "richTextChangedReRender", 7);
        this.disablePopupPanel = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "disablePopupPanel", 7);
        this.arcadeExpMap = new Map();
        this.guid = undefined;
        this.fieldExpressionData = undefined;
        this.arcgisColorPickerData = undefined;
        this.richtextContent = undefined;
        this.blockOpen = false;
        this.popupFlowItem = undefined;
        this.reRender = undefined;
    }
    // lifecycle methods
    componentWillLoad() {
        this.strings = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
        this.currentLanguage = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.currentLanguage;
        this.popupTemplate = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
    }
    componentDidLoad() {
        this.ckEditorMentionFieldsSetup();
        if (this.blockOpen) {
            const content = this.hostElement.shadowRoot.getElementById("content_Id");
            content.scrollIntoView({
                behavior: "auto",
                block: "nearest",
                inline: "start"
            });
            this.showRichTextEditor();
        }
    }
    componentDidUpdate() {
        this.internalPopupUpdated.emit();
    }
    disconnectedCallback() {
        if (this.arcgisCkeditor5) {
            document.body.removeChild(this.arcgisCkeditor5);
        }
    }
    // Events
    richTextChangedReRenderHandler(event) {
        event.stopPropagation();
        this.reRender = this.reRender ? false : true;
    }
    closeAllPopoversHandler() {
        if (this.arcgisCkeditor5) {
            document.body.removeChild(this.arcgisCkeditor5);
            this.arcgisCkeditor5 = null;
            this.disablePopupPanel.emit(false);
        }
    }
    ckEditorPopoverClosedHandler(event) {
        var _a, _b, _c, _d, _e;
        if (((_a = event.detail) === null || _a === void 0 ? void 0 : _a.guid) === this.guid) {
            event.stopPropagation();
            if (((_c = (_b = event.detail) === null || _b === void 0 ? void 0 : _b.data) === null || _c === void 0 ? void 0 : _c.length) || ((_e = (_d = event.detail) === null || _d === void 0 ? void 0 : _d.data) === null || _e === void 0 ? void 0 : _e.length) === 0) {
                this.richtextContent.text = event.detail.data;
                this.reRender = !this.reRender;
                this.richTextChangedReRender.emit();
            } // else null
            this.closePopupPopovers.emit();
        }
    }
    calciteBlockToggleHandler() {
        this.closePopupPopovers.emit();
    }
    // for arcade changes
    arcadeChangeNotificationHandler() {
        this.ckEditorMentionFieldsSetup();
    }
    // private methods and properties
    ckEditorMentionFieldsSetup() {
        var _a;
        this.arcadeExpMap = (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.e)(this.popupTemplate);
        this.ckEditorMentionFields = [];
        (_a = this.popupTemplate.fieldInfos) === null || _a === void 0 ? void 0 : _a.forEach((field) => {
            if (field.fieldName) {
                this.ckEditorMentionFields.push({
                    id: "{" + field.fieldName + "}",
                    name: (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_3__.b)(field, this.arcadeExpMap)
                });
            }
        });
    }
    getTextFromHtml(totalChars) {
        var _a;
        const tempHtml = (_a = this.richtextContent.text) !== null && _a !== void 0 ? _a : "";
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = tempHtml;
        const tempString = tempDiv.textContent || tempDiv.innerText || "";
        return `${tempString.substring(0, totalChars)}${tempString.length > totalChars ? "..." : ""}`;
    }
    showRichTextEditor() {
        var _a, _b;
        this.closePopupPopovers.emit();
        this.arcgisCkeditor5 = document.createElement("arcgis-ckeditor5");
        this.arcgisCkeditor5.fieldExpressionConfig = this.fieldExpressionData;
        this.arcgisCkeditor5.arcgisColorPickerConfig = Object.assign(Object.assign({}, this.arcgisColorPickerData), { enableFields: this.arcgisColorPickerData.data && this.arcgisColorPickerData.data.length ? true : false });
        this.arcgisCkeditor5.guid = this.guid;
        this.arcgisCkeditor5.refElement = this.popupFlowItem;
        this.arcgisCkeditor5.textData = (_a = this.richtextContent.text) !== null && _a !== void 0 ? _a : "";
        this.arcgisCkeditor5.ckEditorMentionFields = this.ckEditorMentionFields;
        this.arcgisCkeditor5.intlTextPlaceHolder =
            ((_b = this.popupTemplate.fieldInfos) === null || _b === void 0 ? void 0 : _b.length) > 0
                ? this.strings.textPlaceHolder
                : this.strings.textPlaceHolderLabel;
        this.arcgisCkeditor5.intlOk = this.strings.ok;
        this.arcgisCkeditor5.intlCancel = this.strings.cancel;
        this.arcgisCkeditor5.currentLanguage = this.currentLanguage;
        document.body.appendChild(this.arcgisCkeditor5);
        this.arcgisCkeditor5.setFocus();
        this.disablePopupPanel.emit(true);
    }
    // rendor methods
    render() {
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.H, null, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { dir: (0,_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), id: "richText_Id", heading: this.strings.text, description: this.getTextFromHtml(25), open: this.blockOpen, collapsible: true, dragHandle: true }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable", slot: "control" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-calcite-block-options", { guid: this.guid, intlOptions: this.strings.options, intlDelete: this.strings.delete, intlDuplicate: this.strings.duplicate, calciteBlockOptions: { hasDelete: true, hasDuplicate: true } })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "icon" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "m", icon: "text" })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: "ignore-elements-sortable", id: "content_Id" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "transparent", width: "full", onClick: () => this.showRichTextEditor() }, this.strings.editText)))));
    }
    get hostElement() { return (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};

const CSS = {
    formInputButton: "form-input-button"
};

const arcgisPopupTitleCss = ".form-input-button{display:flex}.form-input-button calcite-input[type=text]{display:flex;flex-flow:column nowrap;flex:1 0 0%;overflow:hidden}.form-input-button calcite-action{margin:0;flex:0 0 0%;justify-self:flex-end}";

const ArcgisPopupTitle = class {
    constructor(hostRef) {
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
        this.closePopupPopovers = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "closePopupPopovers", 7);
        this.titleChangedReRender = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "titleChangedReRender", 7);
        this.internalPopupUpdated = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "internalPopupUpdated", 7);
        this.disablePopupPanel = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "disablePopupPanel", 7);
        // private methods and properties
        this.changeTitle = () => {
            this.popupTemplate.title = this.titleInput.value;
            this.internalPopupUpdated.emit();
            this.titleChangedReRender.emit();
        };
        // open popover
        this.openAttributesList = (event) => {
            event.stopPropagation();
            // close first since we can have multiple attributes open
            this.closePopupPopovers.emit();
            // lazy load attribute selection component
            if (!this.popupFieldSelectionPickList) {
                this.popupFieldSelectionPickList = document.createElement("arcgis-popup-field-pick-list");
                this.popupFieldSelectionPickList.popoverProps = {
                    refElement: this.popupFlowItem
                };
                this.popupFieldSelectionPickList.multiple = false;
                this.popupFieldSelectionPickList.heading = this.strings.addField;
                this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListDismissed", () => {
                    this.closePopupPopovers.emit();
                });
                this.popupFieldSelectionPickList.addEventListener("arcgisPopupPickListChange", this.popupFieldSelectionPickListChanges);
                document.body.appendChild(this.popupFieldSelectionPickList);
                this.disablePopupPanel.emit(true);
            }
        };
        this.popupFieldSelectionPickListChanges = (event) => {
            const selectedFieldName = event.detail.selectedFields[0];
            this.titleInput.value = addSelectedFieldAtCursor(this.titleInput, selectedFieldName);
            this.titleInput.setFocus();
            this.popupTemplate.title = this.titleInput.value;
            this.changeTitle();
            this.closePopupPopovers.emit();
        };
        this.popupFlowItem = undefined;
        this.reRender = undefined;
    }
    // lifecycle methods
    componentWillLoad() {
        this.strings = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.strings;
        this.popupTemplate = _popupStore_85381453_js__WEBPACK_IMPORTED_MODULE_9__.p.popupTemplate;
    }
    componentDidLoad() {
        this.guidForSelection = (0,_guid_aeaed84d_js__WEBPACK_IMPORTED_MODULE_5__.g)();
    }
    // Events
    titleChangedReRenderHandler(event) {
        event.stopPropagation();
        this.reRender = this.reRender ? false : true;
    }
    closePopupPopoversHandler() {
        if (this.popupFieldSelectionPickList) {
            document.body.removeChild(this.popupFieldSelectionPickList);
            this.popupFieldSelectionPickList = null;
            this.titleInput.setFocus();
            this.disablePopupPanel.emit(false);
        }
    }
    // rendor methods
    render() {
        var _a;
        const popupTitle = this.popupTemplate.title;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.H, null, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-block", { dir: (0,_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_7__.g)(this.hostElement), heading: this.strings.popupTitle, description: popupTitle && `${popupTitle.substring(0, 25)}${popupTitle.length > 25 ? "..." : ""}`, collapsible: true }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "icon" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "m", icon: "title" })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS.formInputButton }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-input", { type: "text", autofocus: true, ref: (element) => {
                this.titleInput = element;
            }, value: popupTitle, onCalciteInputInput: (event) => {
                event.stopPropagation();
                this.changeTitle();
            }, onClick: () => this.closePopupPopovers.emit() }), ((_a = this.popupTemplate.fieldInfos) === null || _a === void 0 ? void 0 : _a.length) > 0 && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { scale: "s", text: this.strings.attributes, onClick: this.openAttributesList, icon: "brackets-curly" }))))));
    }
    get hostElement() { return (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisPopupTitle.style = arcgisPopupTitleCss;



//# sourceMappingURL=arcgis-popup_13.entry.js.map

/***/ }),

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/guid-aeaed84d.js":
/*!**********************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/guid-aeaed84d.js ***!
  \**********************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   g: () => (/* binding */ guid)
/* harmony export */ });
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v4.0.58
 */
function generateId(counts) {
    return counts
        .map((count) => {
        let out = "";
        for (let i = 0; i < count; i++) {
            out += (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
        }
        return out;
    })
        .join("-");
}
const guid = () => generateId([2, 1, 1, 1, 3]);



//# sourceMappingURL=guid-aeaed84d.js.map

/***/ }),

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-05956cab.js":
/*!***********************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-05956cab.js ***!
  \***********************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   c: () => (/* binding */ createStore)
/* harmony export */ });
/* harmony import */ var _index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./index-e3bf7da7.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-e3bf7da7.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v4.0.58
 */


const appendToMap = (map, propName, value) => {
    const items = map.get(propName);
    if (!items) {
        map.set(propName, [value]);
    }
    else if (!items.includes(value)) {
        items.push(value);
    }
};
const debounce = (fn, ms) => {
    let timeoutId;
    return (...args) => {
        if (timeoutId) {
            clearTimeout(timeoutId);
        }
        timeoutId = setTimeout(() => {
            timeoutId = 0;
            fn(...args);
        }, ms);
    };
};

/**
 * Check if a possible element isConnected.
 * The property might not be there, so we check for it.
 *
 * We want it to return true if isConnected is not a property,
 * otherwise we would remove these elements and would not update.
 *
 * Better leak in Edge than to be useless.
 */
const isConnected = (maybeElement) => !('isConnected' in maybeElement) || maybeElement.isConnected;
const cleanupElements = debounce((map) => {
    for (let key of map.keys()) {
        map.set(key, map.get(key).filter(isConnected));
    }
}, 2000);
const stencilSubscription = () => {
    if (typeof _index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.g !== 'function') {
        // If we are not in a stencil project, we do nothing.
        // This function is not really exported by @stencil/core.
        return {};
    }
    const elmsToUpdate = new Map();
    return {
        dispose: () => elmsToUpdate.clear(),
        get: (propName) => {
            const elm = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.g)();
            if (elm) {
                appendToMap(elmsToUpdate, propName, elm);
            }
        },
        set: (propName) => {
            const elements = elmsToUpdate.get(propName);
            if (elements) {
                elmsToUpdate.set(propName, elements.filter(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f));
            }
            cleanupElements(elmsToUpdate);
        },
        reset: () => {
            elmsToUpdate.forEach((elms) => elms.forEach(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.f));
            cleanupElements(elmsToUpdate);
        },
    };
};

const unwrap = (val) => (typeof val === 'function' ? val() : val);
const createObservableMap = (defaultState, shouldUpdate = (a, b) => a !== b) => {
    const unwrappedState = unwrap(defaultState);
    let states = new Map(Object.entries(unwrappedState !== null && unwrappedState !== void 0 ? unwrappedState : {}));
    const handlers = {
        dispose: [],
        get: [],
        set: [],
        reset: [],
    };
    const reset = () => {
        var _a;
        // When resetting the state, the default state may be a function - unwrap it to invoke it.
        // otherwise, the state won't be properly reset
        states = new Map(Object.entries((_a = unwrap(defaultState)) !== null && _a !== void 0 ? _a : {}));
        handlers.reset.forEach((cb) => cb());
    };
    const dispose = () => {
        // Call first dispose as resetting the state would
        // cause less updates ;)
        handlers.dispose.forEach((cb) => cb());
        reset();
    };
    const get = (propName) => {
        handlers.get.forEach((cb) => cb(propName));
        return states.get(propName);
    };
    const set = (propName, value) => {
        const oldValue = states.get(propName);
        if (shouldUpdate(value, oldValue, propName)) {
            states.set(propName, value);
            handlers.set.forEach((cb) => cb(propName, value, oldValue));
        }
    };
    const state = (typeof Proxy === 'undefined'
        ? {}
        : new Proxy(unwrappedState, {
            get(_, propName) {
                return get(propName);
            },
            ownKeys(_) {
                return Array.from(states.keys());
            },
            getOwnPropertyDescriptor() {
                return {
                    enumerable: true,
                    configurable: true,
                };
            },
            has(_, propName) {
                return states.has(propName);
            },
            set(_, propName, value) {
                set(propName, value);
                return true;
            },
        }));
    const on = (eventName, callback) => {
        handlers[eventName].push(callback);
        return () => {
            removeFromArray(handlers[eventName], callback);
        };
    };
    const onChange = (propName, cb) => {
        const unSet = on('set', (key, newValue) => {
            if (key === propName) {
                cb(newValue);
            }
        });
        // We need to unwrap the defaultState because it might be a function.
        // Otherwise we might not be sending the right reset value.
        const unReset = on('reset', () => cb(unwrap(defaultState)[propName]));
        return () => {
            unSet();
            unReset();
        };
    };
    const use = (...subscriptions) => {
        const unsubs = subscriptions.reduce((unsubs, subscription) => {
            if (subscription.set) {
                unsubs.push(on('set', subscription.set));
            }
            if (subscription.get) {
                unsubs.push(on('get', subscription.get));
            }
            if (subscription.reset) {
                unsubs.push(on('reset', subscription.reset));
            }
            if (subscription.dispose) {
                unsubs.push(on('dispose', subscription.dispose));
            }
            return unsubs;
        }, []);
        return () => unsubs.forEach((unsub) => unsub());
    };
    const forceUpdate = (key) => {
        const oldValue = states.get(key);
        handlers.set.forEach((cb) => cb(key, oldValue, oldValue));
    };
    return {
        state,
        get,
        set,
        on,
        onChange,
        use,
        dispose,
        reset,
        forceUpdate,
    };
};
const removeFromArray = (array, item) => {
    const index = array.indexOf(item);
    if (index >= 0) {
        array[index] = array[array.length - 1];
        array.length--;
    }
};

const createStore = (defaultState, shouldUpdate) => {
    const map = createObservableMap(defaultState, shouldUpdate);
    map.use(stencilSubscription());
    return map;
};



//# sourceMappingURL=index-05956cab.js.map

/***/ }),

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/popupStore-85381453.js":
/*!****************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/popupStore-85381453.js ***!
  \****************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   c: () => (/* binding */ clearPopupState),
/* harmony export */   p: () => (/* binding */ popupState)
/* harmony export */ });
/* harmony import */ var _index_05956cab_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./index-05956cab.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-05956cab.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v4.0.58
 */


const popupStore = (0,_index_05956cab_js__WEBPACK_IMPORTED_MODULE_0__.c)({
    layer: null,
    mapView: null,
    portal: null,
    config: null,
    strings: null,
    currentLanguage: null,
    currentLanguageIntl: null,
    serviceType: null,
    popupTemplate: null,
    layerHasAttachment: null,
    layerHasET: null,
    layerHasAttributes: null,
    layerHasCharts: null,
    layerHasImages: null,
    layerHasText: null,
    layerDisplayType: null,
    supportsArcade: null,
    layerHasRelatedRecords: false
});
// workaround for starting a panel with a clean state
function clearPopupState(popupState) {
    popupState.layer = null;
    popupState.mapView = null;
    popupState.portal = null;
    popupState.config = null;
    popupState.strings = null;
    popupState.currentLanguage = null;
    popupState.currentLanguageIntl = null;
    popupState.serviceType = null;
    popupState.popupTemplate = null;
    popupState.layerHasAttachment = null;
    popupState.layerHasET = null;
    popupState.layerHasAttributes = null;
    popupState.layerHasCharts = null;
    popupState.layerHasImages = null;
    popupState.layerHasText = null;
    popupState.layerDisplayType = null;
    popupState.supportsArcade = null;
    popupState.layerHasRelatedRecords = false;
}
const popupState = popupStore.state;



//# sourceMappingURL=popupStore-85381453.js.map

/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0cy9jaHVua3MvYXJjZ2lzX2FuYWx5c2lzX25vZGVfbW9kdWxlc19hcmNnaXNfYXBwLWNvbXBvbmVudHNfZGlzdF9lc21fYXJjZ2lzLWFkMGI0Yy5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDK0g7QUFDekQ7QUFDMEg7QUFDaUs7QUFDcFM7QUFDZDtBQUM4QztBQUM3QjtBQUNQO0FBQ3dCO0FBQ3REO0FBQ0U7O0FBRTdCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EseURBQXlELEVBQUUsbUJBQW1CO0FBQzlFO0FBQ0E7QUFDQSxrQkFBa0Isb0JBQW9CLEVBQUUsbUJBQW1CO0FBQzNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVMsdURBQWUsVUFBVSx1REFBZTtBQUNqRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVMsdURBQWUsVUFBVSx1REFBZTtBQUNqRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDZCQUE2QjtBQUM3QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLENBQUMsNENB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O0FBQzlEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxvREFBb0Q7QUFDcEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx3QkFBd0IsMEJBQTBCO0FBQ2xEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHdCQUF3QiwwQkFBMEI7QUFDbEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsK0NBQStDLHVEQUF1RDtBQUN0RztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHNCQUFzQiw0REFBdUI7QUFDN0M7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7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QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx1R0FBdUc7QUFDdkc7QUFDQTtBQUNBO0FBQ0E7QUFDQSwrQkFBK0I7QUFDL0I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFNEI7O0FBRTVCOzs7Ozs7Ozs7Ozs7Ozs7O0FDdk1BO0FBQ0E7QUFDQTtBQUNBO0FBQ3VEOztBQUV2RCxtQkFBbUIscURBQVc7QUFDOUI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVpRDs7QUFFakQiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9leGItY2xpZW50Ly4vZXh0ZW5zaW9ucy93aWRnZXRzL2FyY2dpcy9hbmFseXNpcy9ub2RlX21vZHVsZXMvQGFyY2dpcy9hcHAtY29tcG9uZW50cy9kaXN0L2VzbS9hcmNnaXMtcG9wdXBfMTMuZW50cnkuanMiLCJ3ZWJwYWNrOi8vZXhiLWNsaWVudC8uL2V4dGVuc2lvbnMvd2lkZ2V0cy9hcmNnaXMvYW5hbHlzaXMvbm9kZV9tb2R1bGVzL0BhcmNnaXMvYXBwLWNvbXBvbmVudHMvZGlzdC9lc20vZ3VpZC1hZWFlZDg0ZC5qcyIsIndlYnBhY2s6Ly9leGItY2xpZW50Ly4vZXh0ZW5zaW9ucy93aWRnZXRzL2FyY2dpcy9hbmFseXNpcy9ub2RlX21vZHVsZXMvQGFyY2dpcy9hcHAtY29tcG9uZW50cy9kaXN0L2VzbS9pbmRleC0wNTk1NmNhYi5qcyIsIndlYnBhY2s6Ly9leGItY2xpZW50Ly4vZXh0ZW5zaW9ucy93aWRnZXRzL2FyY2dpcy9hbmFseXNpcy9ub2RlX21vZHVsZXMvQGFyY2dpcy9hcHAtY29tcG9uZW50cy9kaXN0L2VzbS9wb3B1cFN0b3JlLTg1MzgxNDUzLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQWxsIG1hdGVyaWFsIGNvcHlyaWdodCBFU1JJLCBBbGwgUmlnaHRzIFJlc2VydmVkLCB1bmxlc3Mgb3RoZXJ3aXNlIHNwZWNpZmllZC5cbiAqIHY0LjAuNThcbiAqL1xuaW1wb3J0IHsgciBhcyByZWdpc3Rlckluc3RhbmNlLCBjIGFzIGNyZWF0ZUV2ZW50LCBoLCBIIGFzIEhvc3QsIGQgYXMgZ2V0RWxlbWVudCwgZiBhcyBmb3JjZVVwZGF0ZSB9IGZyb20gJy4vaW5kZXgtZTNiZjdkYTcuanMnO1xuaW1wb3J0IHsgZyBhcyBnZXRMb2NhbGVDb21wb25lbnRTdHJpbmdzIH0gZnJvbSAnLi9sb2NhbGUtMDUwYjZkYjkuanMnO1xuaW1wb3J0IHsgcyBhcyBzZXJ2aWNlVHlwZUVudW0sIGwgYXMgbGF5ZXJEaXNwbGF5VHlwZUVudW0sIGYgYXMgZmllbGRJbmZvUHJlZml4RW51bSwgYSBhcyBmaWVsZFR5cGVzRW51bSwgTCBhcyBMYXN0U29ydHlCeSwgaSBhcyBpbWFnZUNvbXBvbmVudElucHV0VHlwZXNFbnVtIH0gZnJvbSAnLi9jb21tb25FbnVtcy1mY2YxMzY2MS5qcyc7XG5pbXBvcnQgeyBrIGFzIGdldENsdXN0ZXJGaWVsZHMsIGwgYXMgZ2V0U2luZ2xlQ2x1c3RlckZlYXR1cmUsIG0gYXMgZ2V0U2luZ2xlRmVhdHVyZSwgYyBhcyBnZXRTZXJ2aWNlVHlwZSwgbyBhcyBnZXRQb2ludEZyb21HZW9tZXRyeSwgcCBhcyBnZXRTZXJ2aWNlVmVyc2lvbiwgYiBhcyBnZXRGaWVsZERpc3BsYXlOYW1lLCBlIGFzIGdlbmVyYXRlQXJjYWRlRXhwcmVzc2lvbk1hcCwgaiBhcyBnZXRGaWVsZHNGcm9tTGF5ZXIsIGQgYXMgZ2VuZXJhdGVMYXllckZpZWxkc01hcCwgYSBhcyBnZXRGaWVsZFR5cGUsIHEgYXMgcXVlcnlQYXJlbnRFbGVtZW50IH0gZnJvbSAnLi9jb21tb25GdW5jdGlvbnMtYjA4MzBlOWUuanMnO1xuaW1wb3J0IHsgbCBhcyBsb2FkTW9kdWxlcyB9IGZyb20gJy4vbG9hZE1vZHVsZXMtYjRhYzEyNDcuanMnO1xuaW1wb3J0IHsgZyBhcyBndWlkIH0gZnJvbSAnLi9ndWlkLWFlYWVkODRkLmpzJztcbmltcG9ydCB7IGcgYXMgZ2VuZXJhdGVNYXN0ZXJGaWVsZEluZm8sIHAgYXMgcHJldmlld1BvcHVwIH0gZnJvbSAnLi9wcmV2aWV3UG9wdXAtMmFjYjk0ODguanMnO1xuaW1wb3J0IHsgZyBhcyBnZXRFbGVtZW50RGlyIH0gZnJvbSAnLi9sYW5ndWFnZVV0aWwtZWYwZTU0YjIuanMnO1xuaW1wb3J0IHsgZCBhcyBkZWJvdW5jZSB9IGZyb20gJy4vZnVuY3Rpb25hbC00NGRlOGZjZi5qcyc7XG5pbXBvcnQgeyBjIGFzIGNsZWFyUG9wdXBTdGF0ZSwgcCBhcyBwb3B1cFN0YXRlIH0gZnJvbSAnLi9wb3B1cFN0b3JlLTg1MzgxNDUzLmpzJztcbmltcG9ydCAnLi9kb20tNGQzNjc2NzcuanMnO1xuaW1wb3J0ICcuL2luZGV4LTA1OTU2Y2FiLmpzJztcblxuY29uc3QgQ1NTJDYgPSB7XG4gICAgZW5hYmxlUG9wdXA6IFwiZW5hYmxlLXBvcHVwXCIsXG4gICAgY29tcG9uZW50RGl2OiBcImNvbXBvbmVudC11bFwiLFxuICAgIHN1bW1hcnlFVDogXCJzdW1tYXJ5LWV0XCIsXG4gICAgc3VtbWFyeUVUTGFiZWw6IFwic3VtbWFyeS1ldC1sYWJlbFwiLFxuICAgIHN1bW1hcnlFVEFjdGlvbjogXCJzdW1tYXJ5LWV0LWFjdGlvblwiLFxuICAgIGltYWdlcnlPcHRpb25zOiBcImltYWdlcnktb3B0aW9uc1wiLFxuICAgIG5vdGljZTogXCJub3RpY2VcIlxufTtcblxuLy8gYWRkIGZpZWxkIGF0IGN1cnNvciBpZiBwb3NpdGlvbiBpcyBhdmFpbGFibGVcbmNvbnN0IGFkZFNlbGVjdGVkRmllbGRBdEN1cnNvciA9IChpbnB1dEVsZW1lbnQsIHNlbGVjdGVkRmllbGROYW1lKSA9PiB7XG4gICAgdmFyIF9hLCBfYjtcbiAgICBjb25zdCBwb3NpdGlvbiA9IChfYiA9IChfYSA9IGlucHV0RWxlbWVudCA9PT0gbnVsbCB8fCBpbnB1dEVsZW1lbnQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGlucHV0RWxlbWVudC5zaGFkb3dSb290KSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucXVlcnlTZWxlY3RvcihcImlucHV0XCIpKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Iuc2VsZWN0aW9uU3RhcnQ7XG4gICAgaWYgKGlzRGVmaW5lZChwb3NpdGlvbikpIHtcbiAgICAgICAgcmV0dXJuIFtpbnB1dEVsZW1lbnQudmFsdWUuc2xpY2UoMCwgcG9zaXRpb24pLCBgeyR7c2VsZWN0ZWRGaWVsZE5hbWV9fWAsIGlucHV0RWxlbWVudC52YWx1ZS5zbGljZShwb3NpdGlvbildLmpvaW4oXCJcIik7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICByZXR1cm4gYCR7aW5wdXRFbGVtZW50LnZhbHVlfXske3NlbGVjdGVkRmllbGROYW1lfX1gO1xuICAgIH1cbn07XG5jb25zdCBpc0RlZmluZWQgPSAodmFsdWUpID0+IHtcbiAgICByZXR1cm4gdmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gbnVsbDtcbn07XG5jb25zdCBsYXllckhhc1JlbGF0ZWRSZWNvcmRzID0gYXN5bmMgKGxheWVyLCB2aWV3LCBzZXJ2aWNlVHlwZSkgPT4ge1xuICAgIHZhciBfYSwgX2IsIF9jLCBfZCwgX2U7XG4gICAgY29uc3Qgc3VwcG9ydHNDb3VudCA9IChfYiA9IChfYSA9IGxheWVyLmNhcGFiaWxpdGllcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnF1ZXJ5UmVsYXRlZCkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnN1cHBvcnRzQ291bnQ7XG4gICAgY29uc3Qgc3VwcG9ydHNQYWdpbmF0aW9uID0gKF9kID0gKF9jID0gbGF5ZXIuY2FwYWJpbGl0aWVzKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MucXVlcnlSZWxhdGVkKSA9PT0gbnVsbCB8fCBfZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Quc3VwcG9ydHNQYWdpbmF0aW9uO1xuICAgIGlmIChbc2VydmljZVR5cGVFbnVtLmZlYXR1cmUsIHNlcnZpY2VUeXBlRW51bS5zY2VuZV0uaW5kZXhPZihzZXJ2aWNlVHlwZSkgPiAtMSAmJlxuICAgICAgICAoKF9lID0gbGF5ZXIgPT09IG51bGwgfHwgbGF5ZXIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGxheWVyLnJlbGF0aW9uc2hpcHMpID09PSBudWxsIHx8IF9lID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZS5sZW5ndGgpICYmXG4gICAgICAgIHN1cHBvcnRzQ291bnQgJiZcbiAgICAgICAgc3VwcG9ydHNQYWdpbmF0aW9uKSB7XG4gICAgICAgIGZvciAoY29uc3QgcmVsYXRpb25zaGlwIG9mIGxheWVyLnJlbGF0aW9uc2hpcHMpIHtcbiAgICAgICAgICAgIC8vIGNoZWNrIHRhYmxlIGFuZCBsYXllcnMsIGluY2x1ZGluZyBncm91cCBsYXllcnMgaW4gbWFwIHZpZXdcbiAgICAgICAgICAgIC8vIHJldHVybiB0cnVlIGlmIGFueSByZWxhdGVkIGxheWVyL3RhYmxlIGlzIGZvdW5kIGluIHRoZSBtYXBcbiAgICAgICAgICAgIGZvciAoY29uc3QgY3VyckxheWVyT3JUYWJsZSBvZiBbLi4udmlldy5tYXAuYWxsTGF5ZXJzLCAuLi52aWV3Lm1hcC5hbGxUYWJsZXNdKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY3VyciA9IGN1cnJMYXllck9yVGFibGU7XG4gICAgICAgICAgICAgICAgaWYgKGF3YWl0IHJlbGF0aW9uc2hpcEV4aXN0cyhsYXllciwgY3VyciwgcmVsYXRpb25zaGlwKSkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBjdXJyLmxvYWQoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmYWxzZSk7XG59O1xuY29uc3QgZ2V0RGVmYXVsdFJlbGF0aW9uc2hpcEFuZExheWVyID0gYXN5bmMgKGxheWVyLCB2aWV3LCBzZXJ2aWNlVHlwZSkgPT4ge1xuICAgIHZhciBfYTtcbiAgICBpZiAoW3NlcnZpY2VUeXBlRW51bS5mZWF0dXJlLCBzZXJ2aWNlVHlwZUVudW0uc2NlbmVdLmluZGV4T2Yoc2VydmljZVR5cGUpID4gLTEgJiYgKChfYSA9IGxheWVyID09PSBudWxsIHx8IGxheWVyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBsYXllci5yZWxhdGlvbnNoaXBzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKSkge1xuICAgICAgICBmb3IgKGNvbnN0IHJlbGF0aW9uc2hpcCBvZiBsYXllci5yZWxhdGlvbnNoaXBzKSB7XG4gICAgICAgICAgICAvLyBjaGVjayB0YWJsZSBhbmQgbGF5ZXJzLCBpbmNsdWRpbmcgZ3JvdXAgbGF5ZXJzIGluIG1hcCB2aWV3XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGN1cnJMYXllck9yVGFibGUgb2YgWy4uLnZpZXcubWFwLmFsbExheWVycywgLi4udmlldy5tYXAuYWxsVGFibGVzXSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGN1cnIgPSBjdXJyTGF5ZXJPclRhYmxlO1xuICAgICAgICAgICAgICAgIC8vIGJ5IGRlZmF1bHQgc2V0dXAgcmVsYXRpb25zaGlwcyBiYXNlZCBvbiB0aGUgMXN0IGxheWVyL3RhYmxlIGZvdW5kXG4gICAgICAgICAgICAgICAgaWYgKGF3YWl0IHJlbGF0aW9uc2hpcEV4aXN0cyhsYXllciwgY3VyciwgcmVsYXRpb25zaGlwKSkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBjdXJyLmxvYWQoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsgcmVsYXRpb25zaGlwOiByZWxhdGlvbnNoaXAsIGN1cnJMYXllcjogY3VyciB9O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn07XG5mdW5jdGlvbiB0cmltU2VydmVyRnJvbVVybChsYXllcikge1xuICAgIGlmIChsYXllci50eXBlID09PSBcImZlYXR1cmVcIiAmJiBsYXllci51cmwudG9Mb2NhbGVMb3dlckNhc2UoKS5lbmRzV2l0aChcIi9mZWF0dXJlc2VydmVyXCIpKSB7XG4gICAgICAgIHJldHVybiBsYXllci51cmwuc3Vic3RyaW5nKDAsIGxheWVyLnVybC5sZW5ndGggLSAxNCk7XG4gICAgfVxuICAgIGVsc2UgaWYgKGxheWVyLnR5cGUgPT09IFwic2NlbmVcIiAmJiBsYXllci51cmwudG9Mb2NhbGVMb3dlckNhc2UoKS5lbmRzV2l0aChcIi9zY2VuZXNlcnZlclwiKSkge1xuICAgICAgICByZXR1cm4gbGF5ZXIudXJsLnN1YnN0cmluZygwLCBsYXllci51cmwubGVuZ3RoIC0gMTIpO1xuICAgIH1cbiAgICByZXR1cm4gbGF5ZXIudXJsO1xufVxuYXN5bmMgZnVuY3Rpb24gcmVsYXRpb25zaGlwRXhpc3RzKGxheWVyLCByZWxhdGVkTGF5ZXIsIHJlbGF0aW9uc2hpcCkge1xuICAgIHZhciBfYSwgX2IsIF9jO1xuICAgIGNvbnN0IHNhbWVQYXJlbnQgPSByZWxhdGVkTGF5ZXIudXJsXG4gICAgICAgID8gcmVsYXRlZExheWVyLnVybCA9PT0gbGF5ZXIudXJsIHx8IHRyaW1TZXJ2ZXJGcm9tVXJsKHJlbGF0ZWRMYXllcikgPT09IHRyaW1TZXJ2ZXJGcm9tVXJsKGxheWVyKVxuICAgICAgICA6IFwidHlwZVwiIGluIHJlbGF0ZWRMYXllci5wYXJlbnQgJiZcbiAgICAgICAgICAgIHJlbGF0ZWRMYXllci5wYXJlbnQudHlwZSA9PT0gXCJncm91cFwiICYmXG4gICAgICAgICAgICAoKF9iID0gKF9hID0gcmVsYXRlZExheWVyLnBhcmVudCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnBvcnRhbEl0ZW0pID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5pZCkgPT09ICgoX2MgPSBsYXllci5wb3J0YWxJdGVtKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MuaWQpO1xuICAgIGlmIChbXCJmZWF0dXJlXCIsIFwic2NlbmVcIl0uaW5kZXhPZihyZWxhdGVkTGF5ZXIudHlwZSkgPiAtMSAmJiBzYW1lUGFyZW50ICYmICFpc0RlZmluZWQocmVsYXRlZExheWVyLmxheWVySWQpKSB7XG4gICAgICAgIC8vIGhhcHBlbnMgaW4gU1ZcbiAgICAgICAgYXdhaXQgcmVsYXRlZExheWVyLmxvYWQoKTtcbiAgICB9XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShbXCJmZWF0dXJlXCIsIFwic2NlbmVcIl0uaW5kZXhPZihyZWxhdGVkTGF5ZXIudHlwZSkgPiAtMSAmJlxuICAgICAgICBzYW1lUGFyZW50ICYmXG4gICAgICAgIHJlbGF0ZWRMYXllci5sYXllcklkID09PSByZWxhdGlvbnNoaXAucmVsYXRlZFRhYmxlSWQpO1xufVxuZnVuY3Rpb24gcmVsYXRpb25zaGlwRXhpc3RzQ2hlY2tXaXRob3V0TG9hZChsYXllciwgcmVsYXRlZExheWVyLCByZWxhdGlvbnNoaXApIHtcbiAgICB2YXIgX2EsIF9iLCBfYztcbiAgICBjb25zdCBzYW1lUGFyZW50ID0gcmVsYXRlZExheWVyLnVybFxuICAgICAgICA/IHJlbGF0ZWRMYXllci51cmwgPT09IGxheWVyLnVybCB8fCB0cmltU2VydmVyRnJvbVVybChyZWxhdGVkTGF5ZXIpID09PSB0cmltU2VydmVyRnJvbVVybChsYXllcilcbiAgICAgICAgOiBcInR5cGVcIiBpbiByZWxhdGVkTGF5ZXIucGFyZW50ICYmXG4gICAgICAgICAgICByZWxhdGVkTGF5ZXIucGFyZW50LnR5cGUgPT09IFwiZ3JvdXBcIiAmJlxuICAgICAgICAgICAgKChfYiA9IChfYSA9IHJlbGF0ZWRMYXllci5wYXJlbnQpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5wb3J0YWxJdGVtKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuaWQpID09PSAoKF9jID0gbGF5ZXIucG9ydGFsSXRlbSkgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmlkKTtcbiAgICByZXR1cm4gKFtcImZlYXR1cmVcIiwgXCJzY2VuZVwiXS5pbmRleE9mKHJlbGF0ZWRMYXllci50eXBlKSA+IC0xICYmXG4gICAgICAgIHNhbWVQYXJlbnQgJiZcbiAgICAgICAgcmVsYXRlZExheWVyLmxheWVySWQgPT09IHJlbGF0aW9uc2hpcC5yZWxhdGVkVGFibGVJZCk7XG59XG5cbnZhciBDb250ZW50U2VsZWN0aW9uO1xuKGZ1bmN0aW9uIChDb250ZW50U2VsZWN0aW9uKSB7XG4gICAgQ29udGVudFNlbGVjdGlvbltcImF0dHJpYnV0ZXNcIl0gPSBcImF0dHJpYnV0ZXNcIjtcbiAgICBDb250ZW50U2VsZWN0aW9uW1wiYXR0YWNobWVudHNcIl0gPSBcImF0dGFjaG1lbnRzXCI7XG4gICAgQ29udGVudFNlbGVjdGlvbltcImNoYXJ0c1wiXSA9IFwiY2hhcnRzXCI7XG4gICAgQ29udGVudFNlbGVjdGlvbltcImltYWdlc1wiXSA9IFwiaW1hZ2VzXCI7XG4gICAgQ29udGVudFNlbGVjdGlvbltcInJpY2hUZXh0XCJdID0gXCJyaWNoVGV4dFwiO1xuICAgIENvbnRlbnRTZWxlY3Rpb25bXCJzdW1tYXJ5RVRcIl0gPSBcInN1bW1hcnlFVFwiO1xuICAgIENvbnRlbnRTZWxlY3Rpb25bXCJhcmNhZGVcIl0gPSBcImFyY2FkZVwiO1xuICAgIENvbnRlbnRTZWxlY3Rpb25bXCJyZWxhdGlvbnNoaXBcIl0gPSBcInJlbGF0aW9uc2hpcFwiO1xufSkoQ29udGVudFNlbGVjdGlvbiB8fCAoQ29udGVudFNlbGVjdGlvbiA9IHt9KSk7XG52YXIgUG9wdXBNdWx0aU1lZGlhVHlwZTtcbihmdW5jdGlvbiAoUG9wdXBNdWx0aU1lZGlhVHlwZSkge1xuICAgIFBvcHVwTXVsdGlNZWRpYVR5cGVbXCJpbWFnZVwiXSA9IFwiaW1hZ2VcIjtcbiAgICBQb3B1cE11bHRpTWVkaWFUeXBlW1wiYmFyQ2hhcnRcIl0gPSBcImJhci1jaGFydFwiO1xuICAgIFBvcHVwTXVsdGlNZWRpYVR5cGVbXCJjb2x1bW5DaGFydFwiXSA9IFwiY29sdW1uLWNoYXJ0XCI7XG4gICAgUG9wdXBNdWx0aU1lZGlhVHlwZVtcImxpbmVDaGFydFwiXSA9IFwibGluZS1jaGFydFwiO1xuICAgIFBvcHVwTXVsdGlNZWRpYVR5cGVbXCJwaWVDaGFydFwiXSA9IFwicGllLWNoYXJ0XCI7XG59KShQb3B1cE11bHRpTWVkaWFUeXBlIHx8IChQb3B1cE11bHRpTWVkaWFUeXBlID0ge30pKTtcbnZhciBBdHRhY2htZW50RGlzcGxheVR5cGU7XG4oZnVuY3Rpb24gKEF0dGFjaG1lbnREaXNwbGF5VHlwZSkge1xuICAgIEF0dGFjaG1lbnREaXNwbGF5VHlwZVtcInByZXZpZXdcIl0gPSBcInByZXZpZXdcIjtcbiAgICBBdHRhY2htZW50RGlzcGxheVR5cGVbXCJsaXN0XCJdID0gXCJsaXN0XCI7XG4gICAgQXR0YWNobWVudERpc3BsYXlUeXBlW1wiYXV0b1wiXSA9IFwiYXV0b1wiO1xufSkoQXR0YWNobWVudERpc3BsYXlUeXBlIHx8IChBdHRhY2htZW50RGlzcGxheVR5cGUgPSB7fSkpO1xuXG5jb25zdCBnZXRBcmNhZGVTY3JpcHQgPSAoZXhwcmVzc2lvbiwgbGF5ZXJEaXNwbGF5VHlwZSwgc3RyaW5ncykgPT4ge1xuICAgIGlmIChleHByZXNzaW9uKSB7XG4gICAgICAgIHJldHVybiBleHByZXNzaW9uO1xuICAgIH1cbiAgICBpZiAobGF5ZXJEaXNwbGF5VHlwZSA9PT0gbGF5ZXJEaXNwbGF5VHlwZUVudW0uY2x1c3Rlcikge1xuICAgICAgICByZXR1cm4gZGVmYXVsdENsdXN0ZXJQb3B1cFNjcmlwdChzdHJpbmdzKTtcbiAgICB9XG4gICAgcmV0dXJuIGRlZmF1bHRQb3B1cFNjcmlwdChzdHJpbmdzKTtcbn07XG5jb25zdCBnZXRBcmNhZGVQcm9maWxlID0gYXN5bmMgKGxheWVyLCBtYXBWaWV3LCBzZXJ2aWNlVHlwZSwgcG9wdXBUZW1wbGF0ZSwgbGF5ZXJEaXNwbGF5VHlwZSkgPT4ge1xuICAgIGlmIChsYXllckRpc3BsYXlUeXBlID09PSBsYXllckRpc3BsYXlUeXBlRW51bS5jbHVzdGVyKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBpZDogXCJwb3B1cC1mZWF0dXJlLXJlZHVjdGlvblwiLFxuICAgICAgICAgICAgZGVmaW5pdGlvbnM6IHtcbiAgICAgICAgICAgICAgICAkZmVhdHVyZTogeyBmaWVsZHM6IGdldENsdXN0ZXJGaWVsZHMocG9wdXBUZW1wbGF0ZSwgZmFsc2UpIH0sXG4gICAgICAgICAgICAgICAgJGFnZ3JlZ2F0ZWRGZWF0dXJlczogYXdhaXQgZ2V0QWdncmVnYXRlZEZlYXR1cmVTZXQobWFwVmlldywgbGF5ZXIsIHBvcHVwVGVtcGxhdGUpXG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oeyBpZDogXCJwb3B1cFwiIH0sICgoc2VydmljZVR5cGUgPT09IHNlcnZpY2VUeXBlRW51bS5jc3YgfHxcbiAgICAgICAgc2VydmljZVR5cGUgPT09IHNlcnZpY2VUeXBlRW51bS5nZW9qc29uIHx8XG4gICAgICAgIHNlcnZpY2VUeXBlID09PSBzZXJ2aWNlVHlwZUVudW0ubWFwSW1hZ2UgfHxcbiAgICAgICAgc2VydmljZVR5cGUgPT09IHNlcnZpY2VUeXBlRW51bS50aWxlKSAmJiB7XG4gICAgICAgIGRpc2FibGVkVmFyaWFibGVzOiBbXCIkbGF5ZXJcIiwgXCIkbWFwXCIsIFwiJGRhdGFzdG9yZVwiXVxuICAgIH0pKSwgeyBkZWZpbml0aW9uczoge1xuICAgICAgICAgICAgJGZlYXR1cmU6IGxheWVyLFxuICAgICAgICAgICAgJGxheWVyOiBsYXllcixcbiAgICAgICAgICAgICRtYXA6IG1hcFZpZXcubWFwLFxuICAgICAgICAgICAgJGRhdGFzdG9yZTogbGF5ZXJcbiAgICAgICAgfSB9KTtcbn07XG5jb25zdCBnZXRUZXN0RGF0YSA9IGFzeW5jIChsYXllciwgbWFwVmlldywgbGF5ZXJEaXNwbGF5VHlwZSwgcG9wdXBUZW1wbGF0ZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICAgIGlmIChsYXllckRpc3BsYXlUeXBlID09PSBsYXllckRpc3BsYXlUeXBlRW51bS5jbHVzdGVyKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHByb2ZpbGVWYXJpYWJsZUluc3RhbmNlczoge1xuICAgICAgICAgICAgICAgICAgICAkZmVhdHVyZTogYXdhaXQgZ2V0U2luZ2xlQ2x1c3RlckZlYXR1cmUobWFwVmlldywgbGF5ZXIsIHBvcHVwVGVtcGxhdGUpLFxuICAgICAgICAgICAgICAgICAgICAkYWdncmVnYXRlZEZlYXR1cmVzOiBhd2FpdCBnZXRBZ2dyZWdhdGVkRmVhdHVyZVNldChtYXBWaWV3LCBsYXllciwgcG9wdXBUZW1wbGF0ZSlcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHNwYXRpYWxSZWZlcmVuY2U6IG1hcFZpZXcuc3BhdGlhbFJlZmVyZW5jZSxcbiAgICAgICAgICAgICAgICB0aW1lWm9uZTogbWFwVmlldy50aW1lWm9uZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgcHJvZmlsZVZhcmlhYmxlSW5zdGFuY2VzOiB7XG4gICAgICAgICAgICAgICAgJGZlYXR1cmU6IChhd2FpdCBnZXRTaW5nbGVGZWF0dXJlKGxheWVyLCBtYXBWaWV3KSkuZmVhdHVyZXNbMF0sXG4gICAgICAgICAgICAgICAgJGxheWVyOiBsYXllcixcbiAgICAgICAgICAgICAgICAkbWFwOiBtYXBWaWV3Lm1hcCxcbiAgICAgICAgICAgICAgICAkZGF0YXN0b3JlOiBsYXllci51cmxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzcGF0aWFsUmVmZXJlbmNlOiBtYXBWaWV3LnNwYXRpYWxSZWZlcmVuY2UsXG4gICAgICAgICAgICB0aW1lWm9uZTogbWFwVmlldy50aW1lWm9uZVxuICAgICAgICB9O1xuICAgIH1cbiAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xuICAgIH1cbn07XG5jb25zdCBnZXRUZW1wbGF0ZXMgPSAoc3RyaW5ncykgPT4ge1xuICAgIHJldHVybiBbXG4gICAgICAgIHtcbiAgICAgICAgICAgIGxhYmVsOiBzdHJpbmdzLnRlbXBsYXRlcyxcbiAgICAgICAgICAgIHN1Z2dlc3Rpb25zOiBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBsYWJlbDogc3RyaW5ncy5jaGFydFRlbXBsYXRlLFxuICAgICAgICAgICAgICAgICAgICBjb2RlOiBjaGFydFRlbXBsYXRlKClcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IHN0cmluZ3MuZmllbGRzTGlzdFRlbXBsYXRlLFxuICAgICAgICAgICAgICAgICAgICBjb2RlOiBmaWVsZFRlbXBsYXRlKClcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IHN0cmluZ3MucmljaFRleHQsXG4gICAgICAgICAgICAgICAgICAgIGNvZGU6IHJpY2hUZXh0VGVtcGxhdGUoKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF1cbiAgICAgICAgfVxuICAgIF07XG59O1xuY29uc3QgZ2V0QWdncmVnYXRlZEZlYXR1cmVTZXQgPSBhc3luYyAobWFwVmlldywgbGF5ZXIsIHBvcHVwVGVtcGxhdGUpID0+IHtcbiAgICBjb25zdCBsYXllclZpZXcgPSBhd2FpdCBtYXBWaWV3LndoZW5MYXllclZpZXcobGF5ZXIpO1xuICAgIGNvbnN0IHEgPSBsYXllclZpZXcuY3JlYXRlUXVlcnkoKTtcbiAgICBxLmFnZ3JlZ2F0ZUlkcyA9IFsoYXdhaXQgZ2V0U2luZ2xlQ2x1c3RlckZlYXR1cmUobWFwVmlldywgbGF5ZXIsIHBvcHVwVGVtcGxhdGUpKS5nZXRPYmplY3RJZCgpXTtcbiAgICByZXR1cm4gbGF5ZXJWaWV3LnF1ZXJ5RmVhdHVyZXMocSk7XG59O1xuY29uc3QgZGVmYXVsdFBvcHVwU2NyaXB0ID0gKHN0cmluZ3MpID0+IHtcbiAgICByZXR1cm4gYC8vICR7c3RyaW5ncy5hcmNhZGVTY3JpcHRMaW5lMX0gXFxuLy8gJHtzdHJpbmdzLmFyY2FkZVNjcmlwdExpbmUyfVxcbi8vIEF2ZXJhZ2UoJGZlYXR1cmUuU2FsZXNRMSwgJGZlYXR1cmUuU2FsZXNRMiwgJGZlYXR1cmUuU2FsZXNRMywgJGZlYXR1cmUuU2FsZXNRNClcXG5gO1xufTtcbmNvbnN0IGRlZmF1bHRDbHVzdGVyUG9wdXBTY3JpcHQgPSAoc3RyaW5ncykgPT4ge1xuICAgIHJldHVybiBgLy8gJHtzdHJpbmdzLmNsdXN0ZXJBcmNhZGVTY3JpcHRMaW5lM30gXFxuRXhwZWN0cygkYWdncmVnYXRlZEZlYXR1cmVzLCBcImZpZWxkMVwiLCBcImZpZWxkMlwiKVxcblxcbi8vICR7c3RyaW5ncy5jbHVzdGVyQXJjYWRlU2NyaXB0TGluZTF9IFxcbi8vICR7c3RyaW5ncy5jbHVzdGVyQXJjYWRlU2NyaXB0TGluZTJ9XFxuLy8gQ291bnQoRmlsdGVyKCRhZ2dyZWdhdGVkRmVhdHVyZXMsIFwiZmllbGQxID0gJ3ZhbHVlJ1wiKSlcXG5gO1xufTtcbmNvbnN0IGRlZmF1bHRDb250ZW50TWVzc2FnZSA9IChsYXllckRpc3BsYXlUeXBlLCBzdHJpbmdzKSA9PiB7XG4gICAgY29uc3QgY2x1c3Rlck1lc3NhZ2UgPSBgLy8gJHtzdHJpbmdzLmFyY2FkZUNvbnRlbnRDbHVzdGVyU2NyaXB0TGluZX0gXFxuRXhwZWN0cygkYWdncmVnYXRlZEZlYXR1cmVzLCBcImZpZWxkMVwiLCBcImZpZWxkMlwiKVxcblxcbmA7XG4gICAgY29uc3QgZGVmYXVsdE1lc3NhZ2UgPSBgLyogXFxuJHtzdHJpbmdzLmFyY2FkZUNvbnRlbnRTY3JpcHRMaW5lMX0gXFxuJHtzdHJpbmdzLmFyY2FkZUNvbnRlbnRTY3JpcHRMaW5lMn0gXFxuaHR0cHM6Ly9kZXZlbG9wZXJzLmFyY2dpcy5jb20vYXJjYWRlL2d1aWRlL3Byb2ZpbGVzLyNwb3B1cC1lbGVtZW50IFxcbiovXFxuXFxuJHtyaWNoVGV4dFRlbXBsYXRlKCl9YDtcbiAgICByZXR1cm4gbGF5ZXJEaXNwbGF5VHlwZSA9PT0gbGF5ZXJEaXNwbGF5VHlwZUVudW0uY2x1c3RlciA/IGNsdXN0ZXJNZXNzYWdlICsgZGVmYXVsdE1lc3NhZ2UgOiBkZWZhdWx0TWVzc2FnZTtcbn07XG5jb25zdCByaWNoVGV4dFRlbXBsYXRlID0gKCkgPT4ge1xuICAgIHJldHVybiBgcmV0dXJuIHsgXFxuXFx0dHlwZSA6ICd0ZXh0JywgXFxuXFx0dGV4dCA6ICdwbGFjZSB5b3VyIHRleHQgb3IgaHRtbCBoZXJlJyAvL3RoaXMgcHJvcGVydHkgc3VwcG9ydHMgaHRtbCB0YWdzIFxcbn1gO1xufTtcbmNvbnN0IGZpZWxkVGVtcGxhdGUgPSAoKSA9PiB7XG4gICAgcmV0dXJuIGByZXR1cm4ge1xuICAgIHR5cGU6ICdmaWVsZHMnLFxuICAgIC8vdGl0bGU6ICcnLFxuICAgIC8vZGVzY3JpcHRpb24gOiAnJyxcbiAgICBmaWVsZEluZm9zOiAgW3tcbiAgICAgICAgICBmaWVsZE5hbWU6IFwiYXR0MVwiICAvLyBmaWVsZE5hbWUgc2hvdWxkIG1hdGNoIHRoZSBrZXkgaW4gdGhlIGF0dHJpYnV0ZXMgZGljdGlvbmFyeVxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgZmllbGROYW1lOiBcImF0dDJcIiAgLy8gZmllbGROYW1lIHNob3VsZCBtYXRjaCB0aGUga2V5IGluIHRoZSBhdHRyaWJ1dGVzIGRpY3Rpb25hcnlcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGZpZWxkTmFtZTogXCJhdHQzXCIgIC8vIGZpZWxkTmFtZSBzaG91bGQgbWF0Y2ggdGhlIGtleSBpbiB0aGUgYXR0cmlidXRlcyBkaWN0aW9uYXJ5XG4gICAgICAgIH1dLFxuICAgIGF0dHJpYnV0ZXMgOiB7YXR0MSA6IDIsIGF0dDIgOiAzLCBhdHQzIDogNH0gIC8vIHJlcGxhY2UgdGhpcyBkaWN0aW9uYXJ5IHdpdGggeW91ciBvd24ga2V5LXZhbHVlIHBhaXJzXG4gIH1gO1xufTtcbmNvbnN0IGNoYXJ0VGVtcGxhdGUgPSAoKSA9PiB7XG4gICAgcmV0dXJuIGByZXR1cm4ge1xuICAgIHR5cGU6ICdtZWRpYScsXG4gICAgLy8gdGl0bGUgOiAnVGhlIHRpdGxlIGZvciBhbGwgbWVkaWEgaW4gdGhlIGVsZW1lbnQnLFxuICAgIC8vIGRlc2NyaXB0aW9uIDogJycsXG4gICAgYXR0cmlidXRlcyA6IHthdHQxIDogMiwgYXR0MiA6IDMsIGF0dDMgOiA0fSwgIC8vIHJlcGxhY2UgdGhpcyBkaWN0aW9uYXJ5IHdpdGggeW91ciBvd24ga2V5LXZhbHVlIHBhaXJzLFxuICAgIG1lZGlhSW5mb3M6IFt7XG4gICAgICAgIHR5cGUgOiAncGllY2hhcnQnLCAvL2xpbmVjaGFydCB8IGJhcmNoYXJ0IHwgcGllY2hhcnQgfCBjb2x1bW5jaGFydFxuICAgICAgICB0aXRsZSA6ICdnaXZlIHlvdXIgY2hhcnQgYSB0aXRsZScsXG4gICAgICAgIC8vIGNhcHRpb24gOiAnJyxcbiAgICAgICAgYWx0VGV4dCA6ICcnLCAvL2FsdFRleHQgd2lsbCBiZSByZWFkIGJ5IHNjcmVlbiByZWFkZXJzXG4gICAgICAgIHZhbHVlIDoge1xuICAgICAgICAgIGZpZWxkczogW1wiYXR0MVwiLCBcImF0dDJcIiwgXCJhdHQzXCJdLCAgLy8gY2hvb3NlIHdoYXQgYXR0cmlidXRlcyB0byB1c2UgaW4gdGhlIGNoYXJ0XG4gICAgICAgICAgLyogY29sb3JzOiBbICAvLyB2YWx1ZXMgbXVzdCBiZSBhbiBhcnJheSBvZiBbciwgZywgYiwgYV0gdmFsdWVzICgwLTI1NSlcbiAgICAgICAgICAgIFsxMjIsIDE5MCwgMjI5LCAyNTVdLFxuICAgICAgICAgICAgWzE3OSwgMTU1LCAyMTMsIDI1NV0sXG4gICAgICAgICAgICBbMjQ4LCAxNzQsIDEzMSwgMjU1XVxuICAgICAgICAgIF0sICovXG4gICAgICAgICAgLy9ub3JtYWxpemVGaWVsZCA6ICcnLCAgLy8gdGhlIG5hbWUgb2YgdGhlIGF0dHJpYnV0ZSB0byBub3JtYWxpemUgYnkgb3IgdmFsdWVcbiAgICAgICAgfVxuICAgICAgfV1cbiAgfWA7XG59O1xuY29uc3QgZ2V0Q2x1c3RlckZpZWxkSW5mb3MgPSAocG9wdXBUZW1wbGF0ZSwgRmllbGRJbmZvKSA9PiB7XG4gICAgdmFyIF9hO1xuICAgIGNvbnN0IGNsdXN0ZXJGaWVsZEluZm9zID0gW107XG4gICAgLy8gcmVtb3ZlIGV4cHJlc3Npb25zXG4gICAgcG9wdXBUZW1wbGF0ZS5maWVsZEluZm9zLmZvckVhY2goKGZpZWxkSW5mbykgPT4ge1xuICAgICAgICBpZiAoIWZpZWxkSW5mby5maWVsZE5hbWUuaW5jbHVkZXMoZmllbGRJbmZvUHJlZml4RW51bS5leHByZXNzaW9uKSkge1xuICAgICAgICAgICAgY2x1c3RlckZpZWxkSW5mb3MucHVzaChmaWVsZEluZm8pO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgLy8gYWRkIHBvdGVudGlhbCBuZXcgYW5kIGV4aXN0aW5nIGV4cHJlc3Npb25zXG4gICAgKF9hID0gcG9wdXBUZW1wbGF0ZS5leHByZXNzaW9uSW5mb3MpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5mb3JFYWNoKGFzeW5jIChleHByZXNzaW9uSW5mbykgPT4ge1xuICAgICAgICBjb25zdCB0ZW1wRmllbGRJbmZvID0gbmV3IEZpZWxkSW5mbygpO1xuICAgICAgICB0ZW1wRmllbGRJbmZvLmZpZWxkTmFtZSA9IGAke2ZpZWxkSW5mb1ByZWZpeEVudW0uZXhwcmVzc2lvbn0ke2V4cHJlc3Npb25JbmZvLm5hbWV9YDtcbiAgICAgICAgdGVtcEZpZWxkSW5mby52aXNpYmxlID0gZmFsc2U7XG4gICAgICAgIGNsdXN0ZXJGaWVsZEluZm9zLnB1c2godGVtcEZpZWxkSW5mbyk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGNsdXN0ZXJGaWVsZEluZm9zO1xufTtcbmNvbnN0IGdldEV4cHJlc3Npb05hbWUgPSAocG9wdXBUZW1wbGF0ZSwgYXJjYWRlRmllbGROYW1lKSA9PiB7XG4gICAgdmFyIF9hO1xuICAgIGlmIChhcmNhZGVGaWVsZE5hbWUpIHtcbiAgICAgICAgcmV0dXJuIGFyY2FkZUZpZWxkTmFtZTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGlmICgoX2EgPSBwb3B1cFRlbXBsYXRlLmV4cHJlc3Npb25JbmZvcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkge1xuICAgICAgICAgICAgY29uc3QgdGVtcEV4cCA9IHBvcHVwVGVtcGxhdGUuZXhwcmVzc2lvbkluZm9zW3BvcHVwVGVtcGxhdGUuZXhwcmVzc2lvbkluZm9zLmxlbmd0aCAtIDFdO1xuICAgICAgICAgICAgY29uc3QgbWF0Y2hlcyA9IHRlbXBFeHAubmFtZS5tYXRjaCgvXFxkKyQvKTtcbiAgICAgICAgICAgIGlmIChtYXRjaGVzID09PSBudWxsIHx8IG1hdGNoZXMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG1hdGNoZXNbMF0pIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gYGV4cHIke051bWJlcihtYXRjaGVzWzBdKSArIDF9YDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBgZXhwciR7cG9wdXBUZW1wbGF0ZS5leHByZXNzaW9uSW5mb3MubGVuZ3RofWA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gXCJleHByMFwiO1xuICAgICAgICB9XG4gICAgfVxufTtcbmNvbnN0IHNldEV4cHJlc3Npb25JbmZvSW5Qb3B1cFRlbXBsYXRlID0gKG9iamVjdEFyY2FkZUVkaXRvciwgY3VycmVudEFyY2FkZUZpZWxkTmFtZSwgUG9wdXBFeHByZXNzaW9uSW5mbywgcG9wdXBUZW1wbGF0ZSkgPT4ge1xuICAgIGNvbnN0IHRlbXBDdXJyZW50QXJjYWRlRmllbGROYW1lID0gY3VycmVudEFyY2FkZUZpZWxkTmFtZTtcbiAgICBjb25zdCB0ZW1wRXhwID0gbmV3IFBvcHVwRXhwcmVzc2lvbkluZm8oKTtcbiAgICB0ZW1wRXhwLmV4cHJlc3Npb24gPSBvYmplY3RBcmNhZGVFZGl0b3Iuc2NyaXB0O1xuICAgIHRlbXBFeHAudGl0bGUgPSBvYmplY3RBcmNhZGVFZGl0b3IudGl0bGU7XG4gICAgdGVtcEV4cC5uYW1lID0gZ2V0RXhwcmVzc2lvTmFtZShwb3B1cFRlbXBsYXRlLCB0ZW1wQ3VycmVudEFyY2FkZUZpZWxkTmFtZSk7XG4gICAgdGVtcEV4cC5yZXR1cm5UeXBlID0gb2JqZWN0QXJjYWRlRWRpdG9yLnByZWRpY3RPdXRwdXRUeXBlID09PSBcIm51bWJlclwiID8gXCJudW1iZXJcIiA6IFwic3RyaW5nXCI7XG4gICAgaWYgKHBvcHVwVGVtcGxhdGUuZXhwcmVzc2lvbkluZm9zKSB7XG4gICAgICAgIGlmICh0ZW1wQ3VycmVudEFyY2FkZUZpZWxkTmFtZSkge1xuICAgICAgICAgICAgcG9wdXBUZW1wbGF0ZS5leHByZXNzaW9uSW5mb3MuZmluZCgoZXhwLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChleHAubmFtZSA9PT0gdGVtcEN1cnJlbnRBcmNhZGVGaWVsZE5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgcG9wdXBUZW1wbGF0ZS5leHByZXNzaW9uSW5mb3NbaW5kZXhdID0gdGVtcEV4cDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHBvcHVwVGVtcGxhdGUuZXhwcmVzc2lvbkluZm9zLnB1c2godGVtcEV4cCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIHBvcHVwVGVtcGxhdGUuZXhwcmVzc2lvbkluZm9zID0gW3RlbXBFeHBdO1xuICAgIH1cbiAgICByZXR1cm4gdGVtcEV4cDtcbn07XG5jb25zdCBzZXRMYXllckV4cHJlc3Npb25BbmRGaWVsZEluZm8gPSBhc3luYyAocG9wdXBUZW1wbGF0ZSwgbGF5ZXJEaXNwbGF5VHlwZSwgbGF5ZXIsIEZpZWxkSW5mbykgPT4ge1xuICAgIGlmIChsYXllckRpc3BsYXlUeXBlID09PSBsYXllckRpc3BsYXlUeXBlRW51bS5jbHVzdGVyKSB7XG4gICAgICAgIGxheWVyLmZlYXR1cmVSZWR1Y3Rpb24ucG9wdXBUZW1wbGF0ZS5leHByZXNzaW9uSW5mb3MgPVxuICAgICAgICAgICAgWy4uLnBvcHVwVGVtcGxhdGUuZXhwcmVzc2lvbkluZm9zXTtcbiAgICAgICAgcG9wdXBUZW1wbGF0ZS5maWVsZEluZm9zID0gZ2V0Q2x1c3RlckZpZWxkSW5mb3MocG9wdXBUZW1wbGF0ZSwgRmllbGRJbmZvKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGxheWVyLnBvcHVwVGVtcGxhdGUuZXhwcmVzc2lvbkluZm9zID0gWy4uLnBvcHVwVGVtcGxhdGUuZXhwcmVzc2lvbkluZm9zXTtcbiAgICAgICAgcG9wdXBUZW1wbGF0ZS5maWVsZEluZm9zID0gWy4uLihhd2FpdCBnZW5lcmF0ZU1hc3RlckZpZWxkSW5mbyhsYXllciwgcG9wdXBUZW1wbGF0ZSkpXTtcbiAgICB9XG59O1xuXG5jb25zdCBhcmNnaXNQb3B1cENzcyA9IFwiLmVuYWJsZS1wb3B1cHtiYWNrZ3JvdW5kLWNvbG9yOnZhcigtLWFyY2dpcy1hcHAtYmFja2dyb3VuZCk7ZGlzcGxheTpmbGV4O3BhZGRpbmc6dmFyKC0tYXJjZ2lzLWFwcC1jYXAtc3BhY2luZykgdmFyKC0tYXJjZ2lzLWFwcC1jYXAtc3BhY2luZy1oYWxmKSB2YXIoLS1hcmNnaXMtYXBwLWNhcC1zcGFjaW5nLXF1YXJ0ZXIpO2JvcmRlci1ib3R0b206c29saWQgMXB4IHZhcigtLWFyY2dpcy1hcHAtYm9yZGVyKX0uY29tcG9uZW50LXVse21hcmdpbjowIDAgdmFyKC0tYXJjZ2lzLWFwcC1jYXAtc3BhY2luZyk7cGFkZGluZzowfS5zdW1tYXJ5LWV0e2Rpc3BsYXk6ZmxleDthbGlnbi1pdGVtczpjZW50ZXI7cGFkZGluZzowJSB2YXIoLS1hcmNnaXMtYXBwLWNhcC1zcGFjaW5nLXRocmVlLXF1YXJ0ZXJzKX0uc3VtbWFyeS1ldC1sYWJlbHtkaXNwbGF5OmZsZXg7ZmxleC1mbG93OmNvbHVtbiBub3dyYXA7ZmxleDoxIDAgMCU7b3ZlcmZsb3c6aGlkZGVuO3BhZGRpbmc6MCUgdmFyKC0tYXJjZ2lzLWFwcC1jYXAtc3BhY2luZy1oYWxmKTtmb250LXNpemU6bWVkaXVtfS5zdW1tYXJ5LWV0LWFjdGlvbnttYXJnaW46MDtmbGV4OjAgMCAwJTtqdXN0aWZ5LXNlbGY6ZmxleC1lbmR9Lm5vdGljZXttYXJnaW46MC41cmVtfS5pbWFnZXJ5LW9wdGlvbnN7cGFkZGluZzowIHZhcigtLWFyY2dpcy1hcHAtY2FwLXNwYWNpbmctdGhyZWUtcXVhcnRlcnMpfS5zb3J0YWJsZS1saXN0e2Rpc3BsYXk6YmxvY2t9XCI7XG5cbmNvbnN0IEFyY2dpc1BvcHVwID0gY2xhc3Mge1xuICAgIGNvbnN0cnVjdG9yKGhvc3RSZWYpIHtcbiAgICAgICAgcmVnaXN0ZXJJbnN0YW5jZSh0aGlzLCBob3N0UmVmKTtcbiAgICAgICAgdGhpcy5wb3B1cFVwZGF0ZWQgPSBjcmVhdGVFdmVudCh0aGlzLCBcInBvcHVwVXBkYXRlZFwiLCA3KTtcbiAgICAgICAgdGhpcy5hcmNnaXNQb3B1cERpc21pc3NlZENoYW5nZSA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzUG9wdXBEaXNtaXNzZWRDaGFuZ2VcIiwgNyk7XG4gICAgICAgIHRoaXMuaW50ZXJuYWxQb3B1cFVwZGF0ZWQgPSBjcmVhdGVFdmVudCh0aGlzLCBcImludGVybmFsUG9wdXBVcGRhdGVkXCIsIDcpO1xuICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycyA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiY2xvc2VQb3B1cFBvcG92ZXJzXCIsIDcpO1xuICAgICAgICB0aGlzLnJlc2V0TXVsdGlNZWRpYUluZGV4ID0gY3JlYXRlRXZlbnQodGhpcywgXCJyZXNldE11bHRpTWVkaWFJbmRleFwiLCA3KTtcbiAgICAgICAgdGhpcy5tYWluUG9wdXBSZVJlbmRlciA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwibWFpblBvcHVwUmVSZW5kZXJcIiwgNyk7XG4gICAgICAgIHRoaXMuZGlzYWJsZVBvcHVwUGFuZWwgPSBjcmVhdGVFdmVudCh0aGlzLCBcImRpc2FibGVQb3B1cFBhbmVsXCIsIDcpO1xuICAgICAgICB0aGlzLmNsb3NlQXR0cmlidXRlUG9wb3ZlcnMgPSBjcmVhdGVFdmVudCh0aGlzLCBcImNsb3NlQXR0cmlidXRlUG9wb3ZlcnNcIiwgNyk7XG4gICAgICAgIHRoaXMuYXR0cmlidXRlc0NoYW5nZU5vdGlmaWNhdGlvbiA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXR0cmlidXRlc0NoYW5nZU5vdGlmaWNhdGlvblwiLCA3KTtcbiAgICAgICAgdGhpcy5hcmNhZGVDaGFuZ2VOb3RpZmljYXRpb24gPSBjcmVhdGVFdmVudCh0aGlzLCBcImFyY2FkZUNoYW5nZU5vdGlmaWNhdGlvblwiLCA3KTtcbiAgICAgICAgdGhpcy5hdHRyaWJ1dGVEYXRhID0gW107XG4gICAgICAgIHRoaXMuZmllbGREYXRhID0gW107XG4gICAgICAgIHRoaXMucmljaFRleHRFbGVtZW50cyA9IFtdO1xuICAgICAgICB0aGlzLnBvcHVwSGFzQXR0YWNobWVudCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmxheWVySGFzQXR0cmlidXRlcyA9IHRydWU7XG4gICAgICAgIHRoaXMubGF5ZXJIYXNDaGFydHMgPSB0cnVlO1xuICAgICAgICB0aGlzLmxheWVySGFzSW1hZ2VzID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5sYXllckhhc1RleHQgPSB0cnVlO1xuICAgICAgICB0aGlzLmlzUG9wdXBPcGVuRm9yQ3VycmVudExheWVyID0gZmFsc2U7XG4gICAgICAgIHRoaXMucmVsYXRlZFJlY29yZHNEZWZhdWx0Q291bnQgPSAxO1xuICAgICAgICB0aGlzLmd1aWRMaXN0ID0gW107XG4gICAgICAgIHRoaXMuZGVib3VuY2VkUG9wdXBVcGRhdGVzID0gZGVib3VuY2UoKGRldGFpbCkgPT4ge1xuICAgICAgICAgICAgdmFyIF9hO1xuICAgICAgICAgICAgaWYgKHRoaXMuZGlzYWJsZUVkaXRpbmcpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodGhpcy5zZXJ2aWNlVHlwZSAhPT0gc2VydmljZVR5cGVFbnVtLndtcykge1xuICAgICAgICAgICAgICAgIC8vIGlmIGV2ZW50LmRldGFpbCBpcyB0cnVlLCBvbmx5IHVwZGF0ZSBleHRlcm5hbFxuICAgICAgICAgICAgICAgIGlmICghZGV0YWlsIHx8ICEoKF9hID0gdGhpcy5sYXllcikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnBvcHVwVGVtcGxhdGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmxheWVyRGlzcGxheVR5cGUgPT09IGxheWVyRGlzcGxheVR5cGVFbnVtLmZlYXR1cmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGF5ZXIucG9wdXBUZW1wbGF0ZSA9IHRoaXMucG9wdXBUZW1wbGF0ZS5jbG9uZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMubGF5ZXJEaXNwbGF5VHlwZSA9PT0gbGF5ZXJEaXNwbGF5VHlwZUVudW0uY2x1c3Rlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXllci5mZWF0dXJlUmVkdWN0aW9uLnBvcHVwVGVtcGxhdGUgPSB0aGlzLnBvcHVwVGVtcGxhdGUuY2xvbmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMucG9wdXBVcGRhdGVkLmVtaXQodGhpcy5sYXllckRpc3BsYXlUeXBlID09PSBsYXllckRpc3BsYXlUeXBlRW51bS5tYXBOb3RlcyAmJiB7XG4gICAgICAgICAgICAgICAgbWFwTm90ZXNQb3B1cHRlbXBsYXRlOiB0aGlzLm1hcE5vdGVzUG9wdXBFbmFibGVkID8gdGhpcy5wb3B1cFRlbXBsYXRlLmNsb25lKCkgOiBudWxsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRoaXMuZGlzYWJsZUVkaXRpbmcgPSBmYWxzZTtcbiAgICAgICAgfSwgMTAwMCk7XG4gICAgICAgIHRoaXMubWFuYWdlRXhwcmVzc2lvbkJ0bkNsaWNrID0gKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICAgICAgICAgIGNvbnN0IGV4cHJlc3Npb25Db21wb25lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLXBvcHVwLWV4cHJlc3Npb25zXCIpO1xuICAgICAgICAgICAgaWYgKHRoaXMuY2FsY2l0ZUZsb3dQcm9wcykge1xuICAgICAgICAgICAgICAgIHRoaXMuY2FsY2l0ZUZsb3dQcm9wcy5mbG93LmFwcGVuZENoaWxkKGV4cHJlc3Npb25Db21wb25lbnQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5ob3N0RWxlbWVudC5zaGFkb3dSb290LmdldEVsZW1lbnRCeUlkKFwicG9wdXBGbG93X0lkXCIpLmFwcGVuZENoaWxkKGV4cHJlc3Npb25Db21wb25lbnQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gZXhwcmVzc2lvbkNvbXBvbmVudC5zZXRGb2N1cygpKSwgMjAwKTtcbiAgICAgICAgfTtcbiAgICAgICAgLy8gcmVuZG9yIG1ldGhvZHNcbiAgICAgICAgdGhpcy5wb3B1cFRpdGxlQ29tcG9uZW50ID0gKCkgPT4gKGgoXCJhcmNnaXMtcG9wdXAtdGl0bGVcIiwgeyBwb3B1cEZsb3dJdGVtOiB0aGlzLnBvcHVwUGFuZWwgfSkpO1xuICAgICAgICB0aGlzLmZpZWxkQ29tcG9uZW50ID0gKHVuaXF1ZUd1aWQsIGNvbnRlbnQsIGJsb2NrT3BlbikgPT4gKGgoXCJkaXZcIiwgeyBrZXk6IHVuaXF1ZUd1aWQsIGlkOiB1bmlxdWVHdWlkIH0sIGgoXCJhcmNnaXMtcG9wdXAtYXR0cmlidXRlc1wiLCB7IGd1aWQ6IHVuaXF1ZUd1aWQsIHBvcHVwQ29udGVudDogY29udGVudCwgcG9wdXBGbG93SXRlbTogdGhpcy5wb3B1cFBhbmVsLCBibG9ja09wZW46IGJsb2NrT3BlbiB9KSkpO1xuICAgICAgICB0aGlzLmF0dGFjaG1lbnRDb21wb25lbnQgPSAodW5pcXVlR3VpZCwgY29udGVudCwgYmxvY2tPcGVuKSA9PiB7XG4gICAgICAgICAgICB2YXIgX2EsIF9iLCBfYztcbiAgICAgICAgICAgIHJldHVybiAoaChcImRpdlwiLCB7IGtleTogdW5pcXVlR3VpZCwgaWQ6IHVuaXF1ZUd1aWQgfSwgaChcImFyY2dpcy1wb3B1cC1hdHRhY2htZW50c1wiLCB7IGd1aWQ6IHVuaXF1ZUd1aWQsIGF0dGFjaG1lbnRDb250ZW50OiBjb250ZW50LCBsYXllclN1cHBvcnRzUmVzaXplQXR0YWNobWVudHM6ICgoX2MgPSAoX2IgPSAoX2EgPSB0aGlzLmxheWVyKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY2FwYWJpbGl0aWVzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Iub3BlcmF0aW9ucykgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLnN1cHBvcnRzUmVzaXplQXR0YWNobWVudHMpXG4gICAgICAgICAgICAgICAgICAgID8gdHJ1ZVxuICAgICAgICAgICAgICAgICAgICA6IGZhbHNlLCBwb3B1cEZsb3dJdGVtOiB0aGlzLnBvcHVwUGFuZWwsIGJsb2NrT3BlbjogYmxvY2tPcGVuIH0pKSk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMucmljaHRleHRDb21wb25lbnQgPSAodW5pcXVlR3VpZCwgY29udGVudCwgYmxvY2tPcGVuKSA9PiB7XG4gICAgICAgICAgICAvLyBza2V0Y2gvbWFwTm90ZXMgbGF5ZXJzIGhhdmUgbm8gZmllbGRJbmZvc1xuICAgICAgICAgICAgdmFyIF9hLCBfYjtcbiAgICAgICAgICAgIGNvbnN0IHBvcHVwRGF0YSA9IHRoaXMucG9wdXBUZW1wbGF0ZS50b0pTT04oKTtcbiAgICAgICAgICAgIGNvbnN0IGZpZWxkRGF0YSA9IChfYSA9IHBvcHVwRGF0YS5maWVsZEluZm9zKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubWFwKCh7IGZpZWxkTmFtZSwgbGFiZWwgfSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IGZpZWxkTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgYWxpYXM6IGxhYmVsIHx8IGZpZWxkTmFtZVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRoaXMuZmllbGREYXRhID0gZmllbGREYXRhIHx8IFtdO1xuICAgICAgICAgICAgLy8gdGhlIG9ubHkgd2F5IHRvIHNlZSB0aGUgY3VycmVudCBhcmNhZGUgZXhwcmVzc2lvbnMgaW4gdGhlIGNvbG9yIHBpY2tlciBwbHVnaW4gaXMgaWYgaXQgaXMgZmlyc3RcbiAgICAgICAgICAgIC8vIGFkZGVkIGluIGJlZm9yZSB0aGUgcmljaHRleHQgZWRpdG9yIGNvbXBvbmVudCBpcyBtb3VudGVkIG9uIGluaXRpYWxseVxuICAgICAgICAgICAgY29uc3QgZXhwcmVzc2lvbkluZm9zID0gKF9iID0gdGhpcy5wb3B1cFRlbXBsYXRlKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IudG9KU09OKCkuZXhwcmVzc2lvbkluZm9zO1xuICAgICAgICAgICAgY29uc3QgbmV3RXhwcmVzc2lvbkRhdGEgPSBleHByZXNzaW9uSW5mb3MgPT09IG51bGwgfHwgZXhwcmVzc2lvbkluZm9zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBleHByZXNzaW9uSW5mb3MubWFwKCh7IGV4cHJlc3Npb24sIG5hbWUsIHJldHVyblR5cGUsIHRpdGxlIH0pID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiBgZXhwcmVzc2lvbi8ke25hbWV9YCxcbiAgICAgICAgICAgICAgICAgICAgYWxpYXM6IHRpdGxlID09PSBcIk5ldyBleHByZXNzaW9uXCIgPyBcIiBcIiA6IHRpdGxlLFxuICAgICAgICAgICAgICAgICAgICB0eXBlOiByZXR1cm5UeXBlLFxuICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogZXhwcmVzc2lvblxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGlmIChuZXdFeHByZXNzaW9uRGF0YSA9PT0gbnVsbCB8fCBuZXdFeHByZXNzaW9uRGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogbmV3RXhwcmVzc2lvbkRhdGEubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5maWVsZERhdGEgPSB0aGlzLmZpZWxkRGF0YS5maWx0ZXIoKGZpZWxkKSA9PiAhbmV3RXhwcmVzc2lvbkRhdGEuc29tZSgoZXhwcmVzc2lvbikgPT4gZXhwcmVzc2lvbi5uYW1lID09PSBmaWVsZC5uYW1lKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmF0dHJpYnV0ZURhdGEgPSBuZXdFeHByZXNzaW9uRGF0YVxuICAgICAgICAgICAgICAgID8gWy4uLm5ld0V4cHJlc3Npb25EYXRhLCAuLi50aGlzLmZpZWxkRGF0YV1cbiAgICAgICAgICAgICAgICA6IHRoaXMuZmllbGREYXRhO1xuICAgICAgICAgICAgcmV0dXJuIChoKFwiZGl2XCIsIHsga2V5OiB1bmlxdWVHdWlkLCBpZDogdW5pcXVlR3VpZCwgcmVmOiAoZWwpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJpY2hUZXh0RWxlbWVudHMgPSBbLi4udGhpcy5yaWNoVGV4dEVsZW1lbnRzLCBlbF07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IH0sIGgoXCJhcmNnaXMtcG9wdXAtcmljaHRleHRcIiwgeyBmaWVsZEV4cHJlc3Npb25EYXRhOiB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IHRoaXMuYXR0cmlidXRlRGF0YSxcbiAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXJUZXh0OiB0aGlzLnN0cmluZ3Muc2VhcmNoRmllbGRzLFxuICAgICAgICAgICAgICAgICAgICBoZWFkaW5nOiB0aGlzLnN0cmluZ3Muc2VsZWN0RmllbGQsXG4gICAgICAgICAgICAgICAgICAgIGxhYmVsOiB0aGlzLnN0cmluZ3MuZmllbGRzTGlzdFBsdWdpbk5hbWUsXG4gICAgICAgICAgICAgICAgICAgIG1hcFZpZXc6IHRoaXMubWFwVmlldyxcbiAgICAgICAgICAgICAgICAgICAgbGF5ZXI6IHRoaXMubGF5ZXJcbiAgICAgICAgICAgICAgICB9LCBhcmNnaXNDb2xvclBpY2tlckRhdGE6IHtcbiAgICAgICAgICAgICAgICAgICAgZGF0YTogdGhpcy5hdHRyaWJ1dGVEYXRhLFxuICAgICAgICAgICAgICAgICAgICBmaWx0ZXJQbGFjZWhvbGRlcjogdGhpcy5zdHJpbmdzLnNlYXJjaEF0dHJpYnV0ZXMsXG4gICAgICAgICAgICAgICAgICAgIGxhYmVsOiB0aGlzLnN0cmluZ3MuY29sb3JQaWNrZXIsXG4gICAgICAgICAgICAgICAgICAgIGRvbmVUZXh0OiB0aGlzLnN0cmluZ3MuZG9uZSxcbiAgICAgICAgICAgICAgICAgICAgY3VzdG9tVGV4dDogdGhpcy5zdHJpbmdzLmN1c3RvbVRleHQsXG4gICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZVRleHQ6IHRoaXMuc3RyaW5ncy5hdHRyaWJ1dGVUZXh0XG4gICAgICAgICAgICAgICAgfSwgZ3VpZDogdW5pcXVlR3VpZCwgcmljaHRleHRDb250ZW50OiBjb250ZW50LCBwb3B1cEZsb3dJdGVtOiB0aGlzLnBvcHVwUGFuZWwsIGJsb2NrT3BlbjogYmxvY2tPcGVuIH0pKSk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMubXVsdGltZWRpYUNvbXBvbmVudCA9ICh1bmlxdWVHdWlkLCBjb250ZW50LCBibG9ja09wZW4pID0+IChoKFwiZGl2XCIsIHsga2V5OiB1bmlxdWVHdWlkLCBpZDogdW5pcXVlR3VpZCB9LCBoKFwiYXJjZ2lzLXBvcHVwLW11bHRpbWVkaWFcIiwgeyBndWlkOiB1bmlxdWVHdWlkLCBtdWx0aW1lZGlhQ29udGVudDogY29udGVudCwgcG9wdXBGbG93SXRlbTogdGhpcy5wb3B1cFBhbmVsLCBibG9ja09wZW46IGJsb2NrT3BlbiB9KSkpO1xuICAgICAgICB0aGlzLmFyY2FkZUNvbXBvbmVudCA9ICh1bmlxdWVHdWlkLCBjb250ZW50LCBibG9ja09wZW4pID0+IChoKFwiZGl2XCIsIHsga2V5OiB1bmlxdWVHdWlkLCBpZDogdW5pcXVlR3VpZCB9LCBoKFwiYXJjZ2lzLXBvcHVwLWFyY2FkZVwiLCB7IGd1aWQ6IHVuaXF1ZUd1aWQsIGFyY2FkZUNvbnRlbnQ6IGNvbnRlbnQsIGJsb2NrT3BlbjogYmxvY2tPcGVuIH0pKSk7XG4gICAgICAgIHRoaXMucmVsYXRpb25zaGlwQ29tcG9uZW50ID0gKHVuaXF1ZUd1aWQsIGNvbnRlbnQsIGJsb2NrT3BlbikgPT4gKGgoXCJkaXZcIiwgeyBrZXk6IHVuaXF1ZUd1aWQsIGlkOiB1bmlxdWVHdWlkIH0sIGgoXCJhcmNnaXMtcG9wdXAtcmVsYXRpb25zaGlwXCIsIHsgZ3VpZDogdW5pcXVlR3VpZCwgcmVsYXRlZFJlY29yZHNDb250ZW50OiBjb250ZW50LCBwb3B1cEZsb3dJdGVtOiB0aGlzLnBvcHVwUGFuZWwsIGJsb2NrT3BlbjogYmxvY2tPcGVuIH0pKSk7XG4gICAgICAgIHRoaXMubWFwVmlldyA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5sYXllciA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5wb3J0YWwgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuZGlzcGxheVBvcHVwID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5jb25maWcgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMubGF5ZXJEaXNwbGF5VHlwZSA9IGxheWVyRGlzcGxheVR5cGVFbnVtLmZlYXR1cmU7XG4gICAgICAgIHRoaXMuZGlzbWlzc2libGUgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5iYWNrQnV0dG9uID0gZmFsc2U7XG4gICAgICAgIHRoaXMuaGlkZUxheWVyVGl0bGUgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5zaG93Q29uZmlndXJlRmllbGRzID0gZmFsc2U7XG4gICAgICAgIHRoaXMuc2hvd01hbmFnZUV4cHJlc3Npb25zID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5kaXNhYmxlRWRpdGluZyA9IGZhbHNlO1xuICAgICAgICB0aGlzLmNhbGNpdGVGbG93UHJvcHMgPSBudWxsO1xuICAgICAgICB0aGlzLm1hcE5vdGVzUG9wdXBUZW1wbGF0ZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5tYXBOb3Rlc0dyYXBoaWMgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMucmVSZW5kZXIgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMucG9wdXBDb21wb25lbnRzID0gW107XG4gICAgICAgIHRoaXMuaGFzRXJyb3IgPSBmYWxzZTtcbiAgICB9XG4gICAgLy8gbGlmZWN5Y2xlIG1ldGhvZHNcbiAgICBhc3luYyBjb21wb25lbnRXaWxsTG9hZCgpIHtcbiAgICAgICAgdmFyIF9hLCBfYiwgX2M7XG4gICAgICAgIC8vIHBvcHVwU3RhdGUgaGVyZSBoYXMgdGhlIHNldHRpbmdzIGZyb20gdGhlIGxhc3RcbiAgICAgICAgLy8gc2Vzc2lvbiBvZiB0aGlzIGNvbXBvbmVudCBpbnN0ZWFkIG9mIGEgY2xlYW4gbmV3IG9uZVxuICAgICAgICAvLyBiZWNhdXNlIGNyZWF0ZVN0b3JlIGdldHMgY2FsbGVkIGp1c3Qgb25jZSBpbiBhIGFwcCBzZXNzaW9uXG4gICAgICAgIC8vIHNvIGluc3RlYWQgY2FsbCBhIGNsZWFyIG1ldGhvZCwgYXMgYSB3b3JrYXJvdW5kXG4gICAgICAgIGNsZWFyUG9wdXBTdGF0ZShwb3B1cFN0YXRlKTtcbiAgICAgICAgW3RoaXMuc3RyaW5ncywgdGhpcy5jdXJyZW50TGFuZ3VhZ2UsIHRoaXMuY3VycmVudExhbmd1YWdlSW50bF0gPVxuICAgICAgICAgICAgYXdhaXQgZ2V0TG9jYWxlQ29tcG9uZW50U3RyaW5ncyh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgICAgdGhpcy5zZXJ2aWNlVHlwZSA9IGdldFNlcnZpY2VUeXBlKHRoaXMubGF5ZXIpO1xuICAgICAgICBhd2FpdCB0aGlzLmxvYWRBbGxNb2R1bGVzKCk7XG4gICAgICAgIC8vIGRldGVybWluZSBpZiB0byBzaG93IG1hbmFnZSBleHByZXNzaW9ucyBhbmQgYWxzbyBhcmNhZGUgY29udGVudFxuICAgICAgICB0aGlzLnN1cHBvcnRzQXJjYWRlID1cbiAgICAgICAgICAgIHRoaXMuc2hvd01hbmFnZUV4cHJlc3Npb25zICYmXG4gICAgICAgICAgICAgICAgKHRoaXMubGF5ZXJEaXNwbGF5VHlwZSA9PT0gbGF5ZXJEaXNwbGF5VHlwZUVudW0uZmVhdHVyZSB8fFxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxheWVyRGlzcGxheVR5cGUgPT09IGxheWVyRGlzcGxheVR5cGVFbnVtLmNsdXN0ZXIpICYmXG4gICAgICAgICAgICAgICAgdGhpcy5zZXJ2aWNlVHlwZSAhPT0gc2VydmljZVR5cGVFbnVtLm9nY0ZlYXR1cmUgJiZcbiAgICAgICAgICAgICAgICB0aGlzLnNlcnZpY2VUeXBlICE9PSBzZXJ2aWNlVHlwZUVudW0ud2ZzICYmXG4gICAgICAgICAgICAgICAgdGhpcy5zZXJ2aWNlVHlwZSAhPT0gc2VydmljZVR5cGVFbnVtLmltYWdlcnkgJiZcbiAgICAgICAgICAgICAgICB0aGlzLnNlcnZpY2VUeXBlICE9PSBzZXJ2aWNlVHlwZUVudW0uaW1hZ2VyeVRpbGUgJiZcbiAgICAgICAgICAgICAgICB0aGlzLnNlcnZpY2VUeXBlICE9PSBzZXJ2aWNlVHlwZUVudW0uc3VidHlwZTtcbiAgICAgICAgaWYgKHRoaXMuc2VydmljZVR5cGUgPT09IHNlcnZpY2VUeXBlRW51bS50aWxlICYmXG4gICAgICAgICAgICBcInVybFwiIGluIHRoaXMubGF5ZXIgJiZcbiAgICAgICAgICAgICEoXCJ0eXBlXCIgaW4gdGhpcy5sYXllcikgJiZcbiAgICAgICAgICAgIHRoaXMubGF5ZXIudXJsLmluZGV4T2YodGhpcy5sYXllci5sYXllci51cmwpID4gLTEpIHtcbiAgICAgICAgICAgIC8vIEpTLUFQSSBkb2VzIHRoZSBjaGVjayBpZiBhIHJlbGF0ZWQgRkwgZXhpc3RzXG4gICAgICAgICAgICB0aGlzLmhhc0Vycm9yID0gdHJ1ZTtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJwb3B1cHMgbm90IHN1cHBvcnRlZCwgbm8gcmVsYXRlZCBmZWF0dXJlIHNlcnZpY2VcIik7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAodGhpcy5zZXJ2aWNlVHlwZSAhPT0gc2VydmljZVR5cGVFbnVtLndtcykge1xuICAgICAgICAgICAgaWYgKHRoaXMubGF5ZXJEaXNwbGF5VHlwZSA9PT0gbGF5ZXJEaXNwbGF5VHlwZUVudW0uZmVhdHVyZSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGxheWVyVHlwZSA9IFwidHlwZVwiIGluIHRoaXMubGF5ZXIgPyB0aGlzLmxheWVyLnR5cGUgOiBcInN1YmxheWVyXCI7XG4gICAgICAgICAgICAgICAgY29uc3Qgc291cmNlTGF5ZXIgPSB0aGlzLm1hcFZpZXcucG9wdXAudmlzaWJsZVxuICAgICAgICAgICAgICAgICAgICA/IChfYSA9IHRoaXMubWFwVmlldy5wb3B1cC5zZWxlY3RlZEZlYXR1cmUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zb3VyY2VMYXllclxuICAgICAgICAgICAgICAgICAgICA6IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB0aGlzLmlzUG9wdXBPcGVuRm9yQ3VycmVudExheWVyID1cbiAgICAgICAgICAgICAgICAgICAgbGF5ZXJUeXBlID09PSBcInN1YnR5cGUtc3VibGF5ZXJcIlxuICAgICAgICAgICAgICAgICAgICAgICAgPyAoc291cmNlTGF5ZXIgPT09IG51bGwgfHwgc291cmNlTGF5ZXIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNvdXJjZUxheWVyLnN1YnR5cGVDb2RlKSA9PT0gdGhpcy5sYXllci5zdWJ0eXBlQ29kZSAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIChzb3VyY2VMYXllciA9PT0gbnVsbCB8fCBzb3VyY2VMYXllciA9PT0gdm9pZCAwID8gdm9pZCAwIDogc291cmNlTGF5ZXIucGFyZW50LmlkKSA9PT0gdGhpcy5sYXllci5wYXJlbnQuaWQgLy8gVE9ETyBhbnkgKyBwYXJlbnRcbiAgICAgICAgICAgICAgICAgICAgICAgIDogbGF5ZXJUeXBlID09PSBcInN1YmxheWVyXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IChzb3VyY2VMYXllciA9PT0gbnVsbCB8fCBzb3VyY2VMYXllciA9PT0gdm9pZCAwID8gdm9pZCAwIDogc291cmNlTGF5ZXIuaWQpID09PSB0aGlzLmxheWVyLmlkICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChzb3VyY2VMYXllciA9PT0gbnVsbCB8fCBzb3VyY2VMYXllciA9PT0gdm9pZCAwID8gdm9pZCAwIDogc291cmNlTGF5ZXIubGF5ZXIuaWQpID09PSB0aGlzLmxheWVyLmxheWVyLmlkXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBcImlkXCIgaW4gdGhpcy5sYXllciAmJiAoc291cmNlTGF5ZXIgPT09IG51bGwgfHwgc291cmNlTGF5ZXIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNvdXJjZUxheWVyLmlkKSA9PT0gdGhpcy5sYXllci5pZDtcbiAgICAgICAgICAgICAgICAvLyBkb2VzIGxheWVyIGhhdmUgYXR0YWNobWVudFxuICAgICAgICAgICAgICAgIGlmIChpc0RlZmluZWQoKF9jID0gKF9iID0gdGhpcy5sYXllci5jYXBhYmlsaXRpZXMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5kYXRhKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Muc3VwcG9ydHNBdHRhY2htZW50KSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxheWVySGFzQXR0YWNobWVudCA9IHRoaXMubGF5ZXIuY2FwYWJpbGl0aWVzLmRhdGEuc3VwcG9ydHNBdHRhY2htZW50O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLmxheWVySGFzRVQgPSB0aGlzLmxheWVyLmVkaXRGaWVsZHNJbmZvID8gdHJ1ZSA6IGZhbHNlO1xuICAgICAgICAgICAgICAgIHBvcHVwU3RhdGUubGF5ZXJIYXNSZWxhdGVkUmVjb3JkcyA9IGF3YWl0IGxheWVySGFzUmVsYXRlZFJlY29yZHModGhpcy5sYXllciwgdGhpcy5tYXBWaWV3LCB0aGlzLnNlcnZpY2VUeXBlKTtcbiAgICAgICAgICAgICAgICAvLyB0ZW1wLCB0dXJuIG9mZiBwb3B1cEVuYWJsZWQgZm9yIE1JTFxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnNlcnZpY2VUeXBlID09PSBzZXJ2aWNlVHlwZUVudW0ubWFwSW1hZ2UgJiZcbiAgICAgICAgICAgICAgICAgICAgIXRoaXMubGF5ZXIucG9wdXBUZW1wbGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxheWVyLnBvcHVwRW5hYmxlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBnZW5lcmF0ZSBkZWZhdWx0IGlmIHRlbXBsYXRlIGlzIGVtcHR5XG4gICAgICAgICAgICAgICAgdGhpcy5wb3B1cFRlbXBsYXRlID0gdGhpcy5sYXllci5wb3B1cFRlbXBsYXRlXG4gICAgICAgICAgICAgICAgICAgID8gdGhpcy5sYXllci5wb3B1cFRlbXBsYXRlLmNsb25lKClcbiAgICAgICAgICAgICAgICAgICAgOiB0aGlzLmxheWVyLmNyZWF0ZVBvcHVwVGVtcGxhdGUoKTtcbiAgICAgICAgICAgICAgICAvLyBnZW5lcmF0ZSBtYXN0ZXIgZmllbGQgaW5mb1xuICAgICAgICAgICAgICAgIHRoaXMucG9wdXBUZW1wbGF0ZS5maWVsZEluZm9zID0gW1xuICAgICAgICAgICAgICAgICAgICAuLi4oYXdhaXQgZ2VuZXJhdGVNYXN0ZXJGaWVsZEluZm8odGhpcy5sYXllciwgdGhpcy5wb3B1cFRlbXBsYXRlKSlcbiAgICAgICAgICAgICAgICBdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5sYXllckRpc3BsYXlUeXBlID09PSBsYXllckRpc3BsYXlUeXBlRW51bS5jbHVzdGVyKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sYXllckhhc0F0dGFjaG1lbnQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB0aGlzLmxheWVySGFzRVQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB0aGlzLnBvcHVwVGVtcGxhdGUgPSB0aGlzLmxheWVyLmZlYXR1cmVSZWR1Y3Rpb24ucG9wdXBUZW1wbGF0ZS5jbG9uZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5sYXllckRpc3BsYXlUeXBlID09PSBsYXllckRpc3BsYXlUeXBlRW51bS5tYXBOb3Rlcykge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLm1hcE5vdGVzUG9wdXBUZW1wbGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm1hcE5vdGVzUG9wdXBFbmFibGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3B1cFRlbXBsYXRlID0gdGhpcy5tYXBOb3Rlc1BvcHVwVGVtcGxhdGUuY2xvbmUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubWFwTm90ZXNQb3B1cEVuYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgW1BvcHVwVGVtcGxhdGVdID0gYXdhaXQgbG9hZE1vZHVsZXMoW1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJlc3JpL1BvcHVwVGVtcGxhdGVcIlxuICAgICAgICAgICAgICAgICAgICBdKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3B1cFRlbXBsYXRlID0gbmV3IFBvcHVwVGVtcGxhdGUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5sYXllckhhc0F0dGFjaG1lbnQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB0aGlzLmxheWVySGFzRVQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB0aGlzLmxheWVySGFzQXR0cmlidXRlcyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHRoaXMubGF5ZXJIYXNDaGFydHMgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBwb3B1cFN0YXRlLmxheWVyID0gdGhpcy5sYXllcjtcbiAgICAgICAgcG9wdXBTdGF0ZS5tYXBWaWV3ID0gdGhpcy5tYXBWaWV3O1xuICAgICAgICBwb3B1cFN0YXRlLnBvcnRhbCA9IHRoaXMucG9ydGFsO1xuICAgICAgICBwb3B1cFN0YXRlLmNvbmZpZyA9IHRoaXMuY29uZmlnO1xuICAgICAgICBwb3B1cFN0YXRlLnN0cmluZ3MgPSB0aGlzLnN0cmluZ3M7XG4gICAgICAgIHBvcHVwU3RhdGUuY3VycmVudExhbmd1YWdlID0gdGhpcy5jdXJyZW50TGFuZ3VhZ2U7XG4gICAgICAgIHBvcHVwU3RhdGUuY3VycmVudExhbmd1YWdlSW50bCA9IHRoaXMuY3VycmVudExhbmd1YWdlSW50bDtcbiAgICAgICAgcG9wdXBTdGF0ZS5zZXJ2aWNlVHlwZSA9IHRoaXMuc2VydmljZVR5cGU7XG4gICAgICAgIHBvcHVwU3RhdGUucG9wdXBUZW1wbGF0ZSA9IHRoaXMucG9wdXBUZW1wbGF0ZTtcbiAgICAgICAgcG9wdXBTdGF0ZS5sYXllckhhc0F0dGFjaG1lbnQgPSB0aGlzLmxheWVySGFzQXR0YWNobWVudDtcbiAgICAgICAgcG9wdXBTdGF0ZS5sYXllckhhc0VUID0gdGhpcy5sYXllckhhc0VUO1xuICAgICAgICBwb3B1cFN0YXRlLmxheWVySGFzQXR0cmlidXRlcyA9IHRoaXMubGF5ZXJIYXNBdHRyaWJ1dGVzO1xuICAgICAgICBwb3B1cFN0YXRlLmxheWVySGFzQ2hhcnRzID0gdGhpcy5sYXllckhhc0NoYXJ0cztcbiAgICAgICAgcG9wdXBTdGF0ZS5sYXllckhhc0ltYWdlcyA9IHRoaXMubGF5ZXJIYXNJbWFnZXM7XG4gICAgICAgIHBvcHVwU3RhdGUubGF5ZXJIYXNUZXh0ID0gdGhpcy5sYXllckhhc1RleHQ7XG4gICAgICAgIHBvcHVwU3RhdGUubGF5ZXJEaXNwbGF5VHlwZSA9IHRoaXMubGF5ZXJEaXNwbGF5VHlwZTtcbiAgICAgICAgcG9wdXBTdGF0ZS5zdXBwb3J0c0FyY2FkZSA9IHRoaXMuc3VwcG9ydHNBcmNhZGU7XG4gICAgfVxuICAgIGFzeW5jIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgLy8gbG9hZCBjb250ZW50IG9ubHkgb25jZSBwb3B1cEZsb3dJdGVtIGV4aXN0c1xuICAgICAgICAvLyBwb3B1cFRlbXBsYXRlLmNvbnRlbnQgY2FuIGJlIFtdLCBzdHJpbmcsIGZ1bmN0aW9uIGFuZCBwcm9taXNlXG4gICAgICAgIC8vIGlmIHN0cmluZywgY29udmVydCB0byB0ZXh0IGNvbnRlbnRcbiAgICAgICAgaWYgKHRoaXMucG9wdXBUZW1wbGF0ZSkge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLnBvcHVwVGVtcGxhdGUuY29udGVudCA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRleHRDb250ZW50ID0gYXdhaXQgbG9hZE1vZHVsZXMoW1wiZXNyaS9wb3B1cC9jb250ZW50L1RleHRDb250ZW50XCJdKS50aGVuKChbVGV4dENvbnRlbnRdKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVGV4dENvbnRlbnQoe1xuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogdGhpcy5wb3B1cFRlbXBsYXRlLmNvbnRlbnRcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdGhpcy5wb3B1cFRlbXBsYXRlLmNvbnRlbnQgPSBbdGV4dENvbnRlbnRdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy5wb3B1cFRlbXBsYXRlLmNvbnRlbnQpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wb3B1cFRlbXBsYXRlLmNvbnRlbnQuZm9yRWFjaCgoY29udGVudCwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgLy8gaWYgbGF5ZXIgaGFzIG5vIGF0dGFjaG1lbnQsIHJlbW92ZSBpdFxuICAgICAgICAgICAgICAgICAgICBpZiAoY29udGVudC50eXBlID09PSBcImF0dGFjaG1lbnRzXCIgJiYgIXRoaXMubGF5ZXJIYXNBdHRhY2htZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvcHVwVGVtcGxhdGUuY29udGVudC5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRUb1BvcHVwQ29tcG9uZW50cyhjb250ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihcImNvbnRlbnQgbm90IHN1cHBvcnRlZFwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMucmVSZW5kZXIgPSAhdGhpcy5yZVJlbmRlcjtcbiAgICAgICAgfSAvLyBlbHNlIFdNU1xuICAgICAgICBpZiAodGhpcy5zZXJ2aWNlVHlwZSAhPT0gc2VydmljZVR5cGVFbnVtLndtcykge1xuICAgICAgICAgICAgLy8gd2F0Y2ggZm9yIGNoYW5nZXMgdG8gbGF5ZXJzL3RhYmxlcyB0byBzaG93L2hpZGUgcmVsYXRpb25zaGlwXG4gICAgICAgICAgICBpZiAodGhpcy5sYXllckRpc3BsYXlUeXBlID09PSBsYXllckRpc3BsYXlUeXBlRW51bS5mZWF0dXJlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy53YXRjaEZvckNoYW5nZXNUb0xheWVyc0xpc3QoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuc29ydGFibGVDb21wb25lbnRzID0gdGhpcy5ob3N0RWxlbWVudC5zaGFkb3dSb290LmdldEVsZW1lbnRCeUlkKFwiU29ydGFibGVDb21wb25lbnRzX0lkXCIpO1xuICAgICAgICAgICAgdGhpcy5jYWxjaXRlRmFiID1cbiAgICAgICAgICAgICAgICAoKF9hID0gdGhpcy5jYWxjaXRlRmxvd1Byb3BzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY2FsY2l0ZUZhYikgfHxcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5ob3N0RWxlbWVudC5zaGFkb3dSb290LmdldEVsZW1lbnRCeUlkKFwiYWRkQ29tcG9uZW50QnRuX0lkXCIpO1xuICAgICAgICAgICAgY29uc3QgdGVtcFBvcHVwUHJvcCA9IHRoaXMuZ2V0UG9wdXBFbmFibGVkUHJvcCgpO1xuICAgICAgICAgICAgdGhpcy5lbmFibGVEaXNhYmxlUG9wdXAodGVtcFBvcHVwUHJvcCk7XG4gICAgICAgICAgICAvL3RoaXMuc2hvd1ByZXZpZXdQb3B1cCh0ZW1wUG9wdXBQcm9wKTsgLSBzZXR1cFJlc2l6ZU9ic2VydmVyIG9wZW5zIHRoZSBwb3B1cCBhbHJlYWR5XG4gICAgICAgICAgICAvLyBNViB3b3JrZmxvd1xuICAgICAgICAgICAgdGhpcy5zZXR1cFJlc2l6ZU9ic2VydmVyKCk7XG4gICAgICAgICAgICAvLyBmYWIgZm9yIGNvbnRlbnQgcG9wb3ZlclxuICAgICAgICAgICAgdGhpcy5jYWxjaXRlRmFiLm9uY2xpY2sgPSAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmNvbnRlbnRQb3BvdmVyKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGVudFBvcG92ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLXBvcHVwLW1haW4tY29udGVudHBvcG92ZXJcIik7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGVudFBvcG92ZXIuY29udGVudFBvcG92ZXJSZWZFbGVtZW50ID0gdGhpcy5jYWxjaXRlRmFiO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRlbnRQb3BvdmVyLnBvcHVwSGFzQXR0YWNobWVudCA9IHRoaXMucG9wdXBIYXNBdHRhY2htZW50O1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRlbnRQb3BvdmVyLnBvcG92ZXJQYW5lbFdpZHRoID0gdGhpcy5ob3N0RWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS53aWR0aDtcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLmNvbnRlbnRQb3BvdmVyKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYWxjaXRlRmFiLmRpc2FibGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KHRydWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHRoaXMucG9wdXBQYW5lbC5zZXRGb2N1cygpKTtcbiAgICB9XG4gICAgY29tcG9uZW50RGlkVXBkYXRlKCkge1xuICAgICAgICB0aGlzLmludGVybmFsUG9wdXBVcGRhdGVkLmVtaXQoKTtcbiAgICB9XG4gICAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7XG4gICAgICAgIHZhciBfYSwgX2I7XG4gICAgICAgIChfYSA9IHRoaXMucGFyZW50U2hlbGxPYnNlcnZlcikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmRpc2Nvbm5lY3QoKTtcbiAgICAgICAgKF9iID0gdGhpcy53YXRjaExheWVyc0FuZFRhYmxlcykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnJlbW92ZSgpO1xuICAgICAgICBpZiAodGhpcy5jb250ZW50UG9wb3Zlcikge1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLmNvbnRlbnRQb3BvdmVyKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICAvLyBQdWJsaWMgTWV0aG9kc1xuICAgIGFzeW5jIGRvbmUoKSB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgdGhpcy5yZXNldE11bHRpTWVkaWFJbmRleC5lbWl0KCk7XG4gICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICAgICAgKF9hID0gdGhpcy5hdHRyaWJ1dGVzQ29tcG9uZW50KSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZG9uZSgpO1xuICAgICAgICB0aGlzLnNob3dQcmV2aWV3UG9wdXAoZmFsc2UpO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBAZGVwcmVjYXRlZCB3aXRoIDMuMC54XG4gICAgICogQHBhcmFtIGZvY3VzSWRcbiAgICAgKiovXG4gICAgYXN5bmMgc2V0Rm9jdXMoZm9jdXNJZCkge1xuICAgICAgICB2YXIgX2E7XG4gICAgICAgIChfYSA9IHRoaXMuY2FsY2l0ZUZhYikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNldEZvY3VzKCk7XG4gICAgfVxuICAgIGFzeW5jIHVwZGF0ZSgpIHtcbiAgICAgICAgdGhpcy5pbnRlcm5hbFBvcHVwVXBkYXRlZC5lbWl0KCk7XG4gICAgfVxuICAgIC8vIEV2ZW50c1xuICAgIGNhbGNpdGVGbG93SXRlbUJhY2tIYW5kbGVyKGV2ZW50KSB7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgfVxuICAgIG1haW5Qb3B1cFJlUmVuZGVySGFuZGxlcihldmVudCkge1xuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgdGhpcy5yZVJlbmRlciA9IHRoaXMucmVSZW5kZXIgPyBmYWxzZSA6IHRydWU7XG4gICAgfVxuICAgIC8vIHVwZGF0ZSBwb3B1cFxuICAgIGludGVybmFsUG9wdXBVcGRhdGVkSGFuZGxlcihldmVudCkge1xuICAgICAgICB2YXIgX2EsIF9iO1xuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgLy8gcmVmcmVzaCBwb3B1cCBpbiBjYXNlIGl0J3MgaW4gYSBkcmlsbC1pbiBzdGF0ZVxuICAgICAgICBpZiAodGhpcy5zaW5nbGVGZWF0dXJlICYmICgoX2IgPSAoX2EgPSB0aGlzLm1hcFZpZXcucG9wdXApID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5fZmxvd0l0ZW1zKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IubGVuZ3RoKSkge1xuICAgICAgICAgICAgdGhpcy5tYXBWaWV3LnBvcHVwLmZlYXR1cmVzID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgLy8gd2FpdGluZyBoZXJlIG1ha2VzIHN1cmUgaXQgZG9lc24ndCByZWZyZXNoIHR3aWNlXG4gICAgICAgICAgICAvLyBhIHRpbWVvdXQgb2YgYXQgbGVhc3QgMCBpcyBuZWVkZWQgdG8gcmVzZXQgdGhlIGZlYXR1cmVzIGxpc3RcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gKHRoaXMubWFwVmlldy5wb3B1cC5mZWF0dXJlcyA9IFt0aGlzLnNpbmdsZUZlYXR1cmVdKSwgMTAwMCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kZWJvdW5jZWRQb3B1cFVwZGF0ZXMoZXZlbnQuZGV0YWlsKTtcbiAgICB9XG4gICAgZGVsZXRlQ29tcG9uZW50SGFuZGxlcihldmVudCkge1xuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgICAgICAvLyBlYWNoIGRpdiBoYXMgaWQuIEZpbmQgaWQsIGFuZCBzcGxpY2UgYnkgaW5kZXhcbiAgICAgICAgY29uc3QgYWxsQ29tcG9uZW50cyA9IHRoaXMuc29ydGFibGVDb21wb25lbnRzLmdldEVsZW1lbnRzQnlUYWdOYW1lKFwiZGl2XCIpO1xuICAgICAgICBmb3IgKGxldCB4ID0gMDsgeCA8IGFsbENvbXBvbmVudHMubGVuZ3RoOyB4KyspIHtcbiAgICAgICAgICAgIGlmIChhbGxDb21wb25lbnRzW3hdLmlkID09PSBldmVudC5kZXRhaWwpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnBvcHVwVGVtcGxhdGUuY29udGVudC5zcGxpY2UoeCwgMSk7XG4gICAgICAgICAgICAgICAgdGhpcy5wb3B1cENvbXBvbmVudHMuc3BsaWNlKHgsIDEpO1xuICAgICAgICAgICAgICAgIHRoaXMuZ3VpZExpc3Quc3BsaWNlKHgsIDEpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIG9ubHkgYWxsb3cgMSBhdHRhY2htZW50XG4gICAgICAgIHRoaXMucG9wdXBIYXNBdHRhY2htZW50ID0gdGhpcy5wb3B1cFRlbXBsYXRlLmNvbnRlbnQuc29tZSgoY29udGVudCkgPT4ge1xuICAgICAgICAgICAgaWYgKGNvbnRlbnQudHlwZSA9PT0gXCJhdHRhY2htZW50c1wiKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAodGhpcy5yaWNoVGV4dEVsZW1lbnRzKSB7XG4gICAgICAgICAgICAvLyBSZW1vdmUgdGhlIHJlZmVyZW5jZSB0byB0aGUgcmljaCB0ZXh0IGVkaXRvciBpZiB0aGUgcmljaCB0ZXh0IGVkaXRvciBpcyBiZWluZyBkZXN0cm95ZWRcbiAgICAgICAgICAgIGNvbnN0IG5ld0VsZW1lbnRzID0gdGhpcy5yaWNoVGV4dEVsZW1lbnRzLmZpbHRlcigocmVmKSA9PiByZWYuaWQgIT09IGV2ZW50LmRldGFpbCk7XG4gICAgICAgICAgICB0aGlzLnJpY2hUZXh0RWxlbWVudHMgPSBuZXdFbGVtZW50cztcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm1haW5Qb3B1cFJlUmVuZGVyLmVtaXQoKTtcbiAgICAgICAgdGhpcy5jYWxjaXRlRmFiLnNldEZvY3VzKCk7XG4gICAgfVxuICAgIGR1cGxpY2F0ZUNvbXBvbmVudEhhbmRsZXIoZXZlbnQpIHtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICAgICAgLy8gZWFjaCBkaXYgaGFzIGlkLiBGaW5kIGlkLCBhbmQgY2xvbmVcbiAgICAgICAgY29uc3QgYWxsQ29tcG9uZW50cyA9IHRoaXMuc29ydGFibGVDb21wb25lbnRzLmdldEVsZW1lbnRzQnlUYWdOYW1lKFwiZGl2XCIpO1xuICAgICAgICBmb3IgKGxldCB4ID0gMDsgeCA8IGFsbENvbXBvbmVudHMubGVuZ3RoOyB4KyspIHtcbiAgICAgICAgICAgIGlmIChhbGxDb21wb25lbnRzW3hdLmlkID09PSBldmVudC5kZXRhaWwpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB0ZW1wQ29udGVudCA9IHRoaXMucG9wdXBUZW1wbGF0ZS5jb250ZW50W3hdLmNsb25lKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5wb3B1cFRlbXBsYXRlLmNvbnRlbnQucHVzaCh0ZW1wQ29udGVudCk7XG4gICAgICAgICAgICAgICAgdGhpcy5hZGRUb1BvcHVwQ29tcG9uZW50cyh0ZW1wQ29udGVudCwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgY2xvc2VQb3B1cFBvcG92ZXJzSGFuZGxlcigpIHtcbiAgICAgICAgaWYgKHRoaXMuY29udGVudFBvcG92ZXIpIHtcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5jb250ZW50UG9wb3Zlcik7XG4gICAgICAgICAgICB0aGlzLmNvbnRlbnRQb3BvdmVyID0gbnVsbDtcbiAgICAgICAgICAgIHRoaXMuY2FsY2l0ZUZhYi5kaXNhYmxlZCA9IGZhbHNlO1xuICAgICAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHRoaXMuY2FsY2l0ZUZhYi5zZXRGb2N1cygpKTtcbiAgICAgICAgICAgIHRoaXMuZGlzYWJsZVBvcHVwUGFuZWwuZW1pdChmYWxzZSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgbm90aWZ5QWRkQ29udGVudFNlbGVjdGlvbkhhbmRsZXIoZXZlbnQpIHtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICAgICAgLy8gZWRpdG9yIHRyYWNraW5nXG4gICAgICAgIGlmIChldmVudC5kZXRhaWwgPT09IENvbnRlbnRTZWxlY3Rpb24uc3VtbWFyeUVUKSB7XG4gICAgICAgICAgICB0aGlzLnBvcHVwVGVtcGxhdGUubGFzdEVkaXRJbmZvRW5hYmxlZCA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLm1haW5Qb3B1cFJlUmVuZGVyLmVtaXQoKTtcbiAgICAgICAgICAgIHRoaXMuc3VtbWFyeUVURGl2LnNjcm9sbEludG9WaWV3KHsgYmVoYXZpb3I6IFwic21vb3RoXCIsIGJsb2NrOiBcIm5lYXJlc3RcIiwgaW5saW5lOiBcInN0YXJ0XCIgfSk7XG4gICAgICAgICAgICB0aGlzLmNhbGNpdGVGYWIuc2V0Rm9jdXMoKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuYWRkUG9wdXBDb250ZW50cyhldmVudC5kZXRhaWwpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGRpc2FibGVQb3B1cFBhbmVsSGFuZGxlcihldmVudCkge1xuICAgICAgICB2YXIgX2E7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBjb25zdCBwYW5lbCA9ICgoX2EgPSB0aGlzLmNhbGNpdGVGbG93UHJvcHMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5jYWxjaXRlRmxvd0l0ZW0pIHx8IHRoaXMucG9wdXBQYW5lbDtcbiAgICAgICAgcGFuZWwuZGlzYWJsZWQgPSBldmVudC5kZXRhaWw7XG4gICAgfVxuICAgIC8vdXBkYXRlcyB0byBhdHRyaWJ1dGVzXG4gICAgYXN5bmMgYXR0cmlidXRlc1VwZGF0ZWRIYW5kbGVyKGV2ZW50KSB7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICB0aGlzLnBvcHVwVGVtcGxhdGUuZmllbGRJbmZvcyA9IFtcbiAgICAgICAgICAgIC4uLihhd2FpdCBnZW5lcmF0ZU1hc3RlckZpZWxkSW5mbyh0aGlzLmxheWVyLCB0aGlzLmxheWVyLnBvcHVwVGVtcGxhdGUgfHwgdGhpcy5wb3B1cFRlbXBsYXRlKSlcbiAgICAgICAgXTtcbiAgICAgICAgaWYgKHRoaXMubGF5ZXIucG9wdXBUZW1wbGF0ZS5leHByZXNzaW9uSW5mb3MpIHtcbiAgICAgICAgICAgIHRoaXMucG9wdXBUZW1wbGF0ZS5leHByZXNzaW9uSW5mb3MgPSBbXG4gICAgICAgICAgICAgICAgLi4udGhpcy5sYXllci5wb3B1cFRlbXBsYXRlLmV4cHJlc3Npb25JbmZvc1xuICAgICAgICAgICAgXTtcbiAgICAgICAgICAgIHRoaXMuYXJjYWRlQ2hhbmdlTm90aWZpY2F0aW9uLmVtaXQoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmF0dHJpYnV0ZXNDaGFuZ2VOb3RpZmljYXRpb24uZW1pdCgpO1xuICAgICAgICB0aGlzLm1haW5Qb3B1cFJlUmVuZGVyLmVtaXQoKTtcbiAgICB9XG4gICAgLy8gZm9yIGFyY2FkZSBjaGFuZ2VzXG4gICAgYXJjYWRlQ2hhbmdlTm90aWZpY2F0aW9uSGFuZGxlcigpIHtcbiAgICAgICAgdmFyIF9hO1xuICAgICAgICAvLyBpZiBhbiBhcmNhZGUgZXhwcmVzc2lvbiBpcyBhZGRlZC9yZW1vdmVkLCB1cGRhdGUgdGhlIHNlbGVjdGlvbiBvZiBleHByZXNzaW9ucyBpbiB0aGUgcmljaFxuICAgICAgICAvLyB0ZXh0IGVkaXRvcidzIGNvbG9yIHBpY2tlciBwbHVnaW5cbiAgICAgICAgaWYgKHRoaXMucmljaFRleHRFbGVtZW50cykge1xuICAgICAgICAgICAgY29uc3QgbmV3RXhwcmVzc2lvbkRhdGEgPSAoX2EgPSB0aGlzLnBvcHVwVGVtcGxhdGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS50b0pTT04oKS5leHByZXNzaW9uSW5mb3MubWFwKCh7IGV4cHJlc3Npb24sIG5hbWUsIHJldHVyblR5cGUsIHRpdGxlIH0pID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiBgZXhwcmVzc2lvbi8ke25hbWV9YCxcbiAgICAgICAgICAgICAgICAgICAgYWxpYXM6IHRpdGxlID09PSBcIk5ldyBleHByZXNzaW9uXCIgPyBcIiBcIiA6IHRpdGxlLFxuICAgICAgICAgICAgICAgICAgICB0eXBlOiByZXR1cm5UeXBlLFxuICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogZXhwcmVzc2lvblxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRoaXMuYXR0cmlidXRlRGF0YSA9IG5ld0V4cHJlc3Npb25EYXRhXG4gICAgICAgICAgICAgICAgPyBbLi4ubmV3RXhwcmVzc2lvbkRhdGEsIC4uLnRoaXMuZmllbGREYXRhXVxuICAgICAgICAgICAgICAgIDogdGhpcy5maWVsZERhdGE7XG4gICAgICAgICAgICAvLyB1cGRhdGluZyB0aGUgc3RhdGUgaGVyZSBtYW51YWxseSBoZXJlIHNpbmNlIHRoZSByaWNoIHRleHQgZWRpdG9yIHdpbGwgbm90IGxpc3RlbiBmb3IgY2hhbmdlcyBpbiBzdGF0ZVxuICAgICAgICAgICAgLy8gaW4gaW5pdGlhbGl6YXRpb24gLSB3ZSBkbyBub3QgbmVlZCB0byBrZWVwIGxpc3Qgb2YgZXhwcmVzc2lvbnMgaW4gYSBzdGF0ZSBkZWNvcmF0b3IgZWl0aGVyXG4gICAgICAgICAgICB0aGlzLnJpY2hUZXh0RWxlbWVudHMuZm9yRWFjaCgoZWwpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCByaWNoVGV4dEVsZW1lbnQgPSBlbC5maXJzdENoaWxkO1xuICAgICAgICAgICAgICAgIHJpY2hUZXh0RWxlbWVudC5hcmNnaXNDb2xvclBpY2tlckRhdGEuZGF0YSA9IHRoaXMuYXR0cmlidXRlRGF0YTtcbiAgICAgICAgICAgICAgICByaWNoVGV4dEVsZW1lbnQuZmllbGRFeHByZXNzaW9uRGF0YS5kYXRhID0gdGhpcy5hdHRyaWJ1dGVEYXRhO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5tYWluUG9wdXBSZVJlbmRlci5lbWl0KCk7XG4gICAgfVxuICAgIC8vIHByaXZhdGUgbWV0aG9kcyBhbmQgcHJvcGVydGllc1xuICAgIGFzeW5jIGxvYWRBbGxNb2R1bGVzKCkge1xuICAgICAgICBbdGhpcy5MYXllck9wdGlvbnMsIHRoaXMucmVhY3RpdmVVdGlsc10gPSBhd2FpdCBsb2FkTW9kdWxlcyhbXG4gICAgICAgICAgICBcImVzcmkvcG9wdXAvTGF5ZXJPcHRpb25zXCIsXG4gICAgICAgICAgICBcImVzcmkvY29yZS9yZWFjdGl2ZVV0aWxzXCJcbiAgICAgICAgXSk7XG4gICAgfVxuICAgIHdhdGNoRm9yQ2hhbmdlc1RvTGF5ZXJzTGlzdCgpIHtcbiAgICAgICAgdmFyIF9hLCBfYjtcbiAgICAgICAgaWYgKHRoaXMubGF5ZXJEaXNwbGF5VHlwZSA9PT0gbGF5ZXJEaXNwbGF5VHlwZUVudW0uZmVhdHVyZSAmJlxuICAgICAgICAgICAgdGhpcy5zZXJ2aWNlVHlwZSA9PT0gc2VydmljZVR5cGVFbnVtLmZlYXR1cmUgJiZcbiAgICAgICAgICAgICgoX2IgPSAoX2EgPSB0aGlzLmxheWVyKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucmVsYXRpb25zaGlwcykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmxlbmd0aCkpIHtcbiAgICAgICAgICAgIHRoaXMud2F0Y2hMYXllcnNBbmRUYWJsZXMgPSB0aGlzLnJlYWN0aXZlVXRpbHMud2F0Y2goKCkgPT4gW3RoaXMubWFwVmlldy5tYXAuYWxsTGF5ZXJzLmxlbmd0aCwgdGhpcy5tYXBWaWV3Lm1hcC5hbGxUYWJsZXMubGVuZ3RoXSwgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHBvcHVwU3RhdGUubGF5ZXJIYXNSZWxhdGVkUmVjb3JkcyA9IGF3YWl0IGxheWVySGFzUmVsYXRlZFJlY29yZHModGhpcy5sYXllciwgdGhpcy5tYXBWaWV3LCB0aGlzLnNlcnZpY2VUeXBlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIGVuYWJsZURpc2FibGVQb3B1cChwb3B1cEJvb2wpIHtcbiAgICAgICAgLy8gaGlkZSByZXN0IG9mIHRoZSBjb21wb25lbnQuXG4gICAgICAgIGlmICh0aGlzLnNlcnZpY2VUeXBlICE9PSBzZXJ2aWNlVHlwZUVudW0ud21zKSB7XG4gICAgICAgICAgICBjb25zdCBwb3B1cERpdiA9IHRoaXMuaG9zdEVsZW1lbnQuc2hhZG93Um9vdC5nZXRFbGVtZW50QnlJZChcInBvcHVwRGl2X0lkXCIpO1xuICAgICAgICAgICAgcG9wdXBEaXYuc3R5bGUuZGlzcGxheSA9IHBvcHVwQm9vbCA/IFwiYmxvY2tcIiA6IFwibm9uZVwiO1xuICAgICAgICAgICAgdGhpcy5jYWxjaXRlRmFiLnN0eWxlLmRpc3BsYXkgPSBwb3B1cEJvb2wgPyBcImJsb2NrXCIgOiBcIm5vbmVcIjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgfVxuICAgIGdldFBvcHVwRW5hYmxlZFByb3AoKSB7XG4gICAgICAgIHN3aXRjaCAodGhpcy5sYXllckRpc3BsYXlUeXBlKSB7XG4gICAgICAgICAgICBjYXNlIGxheWVyRGlzcGxheVR5cGVFbnVtLmZlYXR1cmU6IHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5zZXJ2aWNlVHlwZSA9PT0gc2VydmljZVR5cGVFbnVtLndtcykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sYXllci5wb3B1cEVuYWJsZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sYXllci5wb3B1cFRlbXBsYXRlXG4gICAgICAgICAgICAgICAgICAgICAgICA/IHRoaXMubGF5ZXIucG9wdXBFbmFibGVkXG4gICAgICAgICAgICAgICAgICAgICAgICA6IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhc2UgbGF5ZXJEaXNwbGF5VHlwZUVudW0uY2x1c3Rlcjoge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxheWVyLmZlYXR1cmVSZWR1Y3Rpb24ucG9wdXBFbmFibGVkO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2FzZSBsYXllckRpc3BsYXlUeXBlRW51bS5tYXBOb3Rlczoge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm1hcE5vdGVzUG9wdXBFbmFibGVkO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZGVmYXVsdDoge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxheWVyLnBvcHVwRW5hYmxlZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZW9yZGVyKGFyciwgb2xkSWR4cywgbmV3SWR4cykge1xuICAgICAgICBjb25zdCBvbGRBcnIgPSBbLi4uYXJyXTtcbiAgICAgICAgYXJyLmxlbmd0aCA9IDA7XG4gICAgICAgIG9sZEFyci5mb3JFYWNoKChpdGVtLCBpZHgpID0+IHtcbiAgICAgICAgICAgIGxldCBuZXdJZHg7XG4gICAgICAgICAgICBuZXdJZHhzLmZvckVhY2goKGd1aWQsIGlkeDIpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAob2xkSWR4c1tpZHhdID09PSBndWlkKSB7XG4gICAgICAgICAgICAgICAgICAgIG5ld0lkeCA9IGlkeDI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBhcnJbbmV3SWR4XSA9IGl0ZW07XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBhZGRUb1BvcHVwQ29tcG9uZW50cyhjb250ZW50LCBibG9ja09wZW4gPSBmYWxzZSkge1xuICAgICAgICBjb25zdCBuZXdHdWlkID0gZ3VpZCgpO1xuICAgICAgICBpZiAoY29udGVudC50eXBlID09PSBcImZpZWxkc1wiKSB7XG4gICAgICAgICAgICB0aGlzLnBvcHVwQ29tcG9uZW50cyA9IFtcbiAgICAgICAgICAgICAgICAuLi50aGlzLnBvcHVwQ29tcG9uZW50cyxcbiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkQ29tcG9uZW50KG5ld0d1aWQsIGNvbnRlbnQsIGJsb2NrT3BlbilcbiAgICAgICAgICAgIF07XG4gICAgICAgICAgICB0aGlzLmd1aWRMaXN0ID0gWy4uLnRoaXMuZ3VpZExpc3QsIG5ld0d1aWRdO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGNvbnRlbnQudHlwZSA9PT0gXCJhdHRhY2htZW50c1wiKSB7XG4gICAgICAgICAgICB0aGlzLnBvcHVwQ29tcG9uZW50cyA9IFtcbiAgICAgICAgICAgICAgICAuLi50aGlzLnBvcHVwQ29tcG9uZW50cyxcbiAgICAgICAgICAgICAgICB0aGlzLmF0dGFjaG1lbnRDb21wb25lbnQobmV3R3VpZCwgY29udGVudCwgYmxvY2tPcGVuKVxuICAgICAgICAgICAgXTtcbiAgICAgICAgICAgIHRoaXMucG9wdXBIYXNBdHRhY2htZW50ID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuZ3VpZExpc3QgPSBbLi4udGhpcy5ndWlkTGlzdCwgbmV3R3VpZF07XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoY29udGVudC50eXBlID09PSBcIm1lZGlhXCIpIHtcbiAgICAgICAgICAgIHRoaXMucG9wdXBDb21wb25lbnRzID0gW1xuICAgICAgICAgICAgICAgIC4uLnRoaXMucG9wdXBDb21wb25lbnRzLFxuICAgICAgICAgICAgICAgIHRoaXMubXVsdGltZWRpYUNvbXBvbmVudChuZXdHdWlkLCBjb250ZW50LCBibG9ja09wZW4pXG4gICAgICAgICAgICBdO1xuICAgICAgICAgICAgdGhpcy5ndWlkTGlzdCA9IFsuLi50aGlzLmd1aWRMaXN0LCBuZXdHdWlkXTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChjb250ZW50LnR5cGUgPT09IFwidGV4dFwiKSB7XG4gICAgICAgICAgICB0aGlzLnBvcHVwQ29tcG9uZW50cyA9IFtcbiAgICAgICAgICAgICAgICAuLi50aGlzLnBvcHVwQ29tcG9uZW50cyxcbiAgICAgICAgICAgICAgICB0aGlzLnJpY2h0ZXh0Q29tcG9uZW50KG5ld0d1aWQsIGNvbnRlbnQsIGJsb2NrT3BlbilcbiAgICAgICAgICAgIF07XG4gICAgICAgICAgICB0aGlzLmd1aWRMaXN0ID0gWy4uLnRoaXMuZ3VpZExpc3QsIG5ld0d1aWRdO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGNvbnRlbnQudHlwZSA9PT0gXCJleHByZXNzaW9uXCIpIHtcbiAgICAgICAgICAgIHRoaXMucG9wdXBDb21wb25lbnRzID0gW1xuICAgICAgICAgICAgICAgIC4uLnRoaXMucG9wdXBDb21wb25lbnRzLFxuICAgICAgICAgICAgICAgIHRoaXMuYXJjYWRlQ29tcG9uZW50KG5ld0d1aWQsIGNvbnRlbnQsIGJsb2NrT3BlbilcbiAgICAgICAgICAgIF07XG4gICAgICAgICAgICB0aGlzLmd1aWRMaXN0ID0gWy4uLnRoaXMuZ3VpZExpc3QsIG5ld0d1aWRdO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGNvbnRlbnQudHlwZSA9PT0gXCJyZWxhdGlvbnNoaXBcIikge1xuICAgICAgICAgICAgdGhpcy5wb3B1cENvbXBvbmVudHMgPSBbXG4gICAgICAgICAgICAgICAgLi4udGhpcy5wb3B1cENvbXBvbmVudHMsXG4gICAgICAgICAgICAgICAgdGhpcy5yZWxhdGlvbnNoaXBDb21wb25lbnQobmV3R3VpZCwgY29udGVudCwgYmxvY2tPcGVuKVxuICAgICAgICAgICAgXTtcbiAgICAgICAgICAgIHRoaXMuZ3VpZExpc3QgPSBbLi4udGhpcy5ndWlkTGlzdCwgbmV3R3VpZF07XG4gICAgICAgIH1cbiAgICB9XG4gICAgYXN5bmMgYWRkUG9wdXBDb250ZW50cyhwb3B1cENvbnRlbnRUeXBlKSB7XG4gICAgICAgIGNvbnN0IFtGaWVsZHNDb250ZW50LCBBdHRhY2htZW50c0NvbnRlbnQsIFRleHRDb250ZW50LCBNZWRpYUNvbnRlbnQsIEltYWdlTWVkaWFJbmZvLCBDb2x1bW5DaGFydE1lZGlhSW5mbywgSW1hZ2VNZWRpYUluZm9WYWx1ZSwgQ2hhcnRNZWRpYUluZm9WYWx1ZSwgRXhwcmVzc2lvbkNvbnRlbnQsIFJlbGF0aW9uc2hpcENvbnRlbnRdID0gYXdhaXQgbG9hZE1vZHVsZXMoW1xuICAgICAgICAgICAgXCJlc3JpL3BvcHVwL2NvbnRlbnQvRmllbGRzQ29udGVudFwiLFxuICAgICAgICAgICAgXCJlc3JpL3BvcHVwL2NvbnRlbnQvQXR0YWNobWVudHNDb250ZW50XCIsXG4gICAgICAgICAgICBcImVzcmkvcG9wdXAvY29udGVudC9UZXh0Q29udGVudFwiLFxuICAgICAgICAgICAgXCJlc3JpL3BvcHVwL2NvbnRlbnQvTWVkaWFDb250ZW50XCIsXG4gICAgICAgICAgICBcImVzcmkvcG9wdXAvY29udGVudC9JbWFnZU1lZGlhSW5mb1wiLFxuICAgICAgICAgICAgXCJlc3JpL3BvcHVwL2NvbnRlbnQvQ29sdW1uQ2hhcnRNZWRpYUluZm9cIixcbiAgICAgICAgICAgIFwiZXNyaS9wb3B1cC9jb250ZW50L3N1cHBvcnQvSW1hZ2VNZWRpYUluZm9WYWx1ZVwiLFxuICAgICAgICAgICAgXCJlc3JpL3BvcHVwL2NvbnRlbnQvc3VwcG9ydC9DaGFydE1lZGlhSW5mb1ZhbHVlXCIsXG4gICAgICAgICAgICBcImVzcmkvcG9wdXAvY29udGVudC9FeHByZXNzaW9uQ29udGVudFwiLFxuICAgICAgICAgICAgXCJlc3JpL3BvcHVwL2NvbnRlbnQvUmVsYXRpb25zaGlwQ29udGVudFwiXG4gICAgICAgIF0pO1xuICAgICAgICBsZXQgY29udGVudCA9IG51bGw7XG4gICAgICAgIGlmIChwb3B1cENvbnRlbnRUeXBlID09PSBDb250ZW50U2VsZWN0aW9uLmF0dHJpYnV0ZXMpIHtcbiAgICAgICAgICAgIGNvbnRlbnQgPSBuZXcgRmllbGRzQ29udGVudCh7XG4gICAgICAgICAgICAgICAgZmllbGRJbmZvczogbnVsbFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAocG9wdXBDb250ZW50VHlwZSA9PT0gQ29udGVudFNlbGVjdGlvbi5hdHRhY2htZW50cykge1xuICAgICAgICAgICAgY29udGVudCA9IG5ldyBBdHRhY2htZW50c0NvbnRlbnQoe1xuICAgICAgICAgICAgICAgIGRpc3BsYXlUeXBlOiBudWxsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChwb3B1cENvbnRlbnRUeXBlID09PSBDb250ZW50U2VsZWN0aW9uLnJpY2hUZXh0KSB7XG4gICAgICAgICAgICBjb250ZW50ID0gbmV3IFRleHRDb250ZW50KHtcbiAgICAgICAgICAgICAgICB0ZXh0OiBudWxsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChwb3B1cENvbnRlbnRUeXBlID09PSBDb250ZW50U2VsZWN0aW9uLmltYWdlcykge1xuICAgICAgICAgICAgY29uc3QgaW1hZ2VFbGVtZW50ID0gbmV3IEltYWdlTWVkaWFJbmZvKHtcbiAgICAgICAgICAgICAgICB0aXRsZTogXCJcIixcbiAgICAgICAgICAgICAgICBjYXB0aW9uOiBcIlwiLFxuICAgICAgICAgICAgICAgIGFsdFRleHQ6IFwiXCIsXG4gICAgICAgICAgICAgICAgdmFsdWU6IG5ldyBJbWFnZU1lZGlhSW5mb1ZhbHVlKHtcbiAgICAgICAgICAgICAgICAgICAgc291cmNlVVJMOiBcIlwiLFxuICAgICAgICAgICAgICAgICAgICBsaW5rVVJMOiBcIlwiXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgY29udGVudCA9IG5ldyBNZWRpYUNvbnRlbnQoe1xuICAgICAgICAgICAgICAgIG1lZGlhSW5mb3M6IFtpbWFnZUVsZW1lbnRdXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChwb3B1cENvbnRlbnRUeXBlID09PSBDb250ZW50U2VsZWN0aW9uLmNoYXJ0cykge1xuICAgICAgICAgICAgY29uc3QgY2hhcnRFbGVtZW50ID0gbmV3IENvbHVtbkNoYXJ0TWVkaWFJbmZvKHtcbiAgICAgICAgICAgICAgICB0aXRsZTogXCJcIixcbiAgICAgICAgICAgICAgICBjYXB0aW9uOiBcIlwiLFxuICAgICAgICAgICAgICAgIGFsdFRleHQ6IFwiXCIsXG4gICAgICAgICAgICAgICAgdmFsdWU6IG5ldyBDaGFydE1lZGlhSW5mb1ZhbHVlKHtcbiAgICAgICAgICAgICAgICAgICAgZmllbGRzOiBbXVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGNvbnRlbnQgPSBuZXcgTWVkaWFDb250ZW50KHtcbiAgICAgICAgICAgICAgICBtZWRpYUluZm9zOiBbY2hhcnRFbGVtZW50XVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAocG9wdXBDb250ZW50VHlwZSA9PT0gQ29udGVudFNlbGVjdGlvbi5hcmNhZGUpIHtcbiAgICAgICAgICAgIGNvbnRlbnQgPSBuZXcgRXhwcmVzc2lvbkNvbnRlbnQoe1xuICAgICAgICAgICAgICAgIGV4cHJlc3Npb25JbmZvOiB7XG4gICAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb246IGRlZmF1bHRDb250ZW50TWVzc2FnZSh0aGlzLmxheWVyRGlzcGxheVR5cGUsIHRoaXMuc3RyaW5ncylcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChwb3B1cENvbnRlbnRUeXBlID09PSBDb250ZW50U2VsZWN0aW9uLnJlbGF0aW9uc2hpcCkge1xuICAgICAgICAgICAgY29uc3QgcmVsYXRpb25zaGlwQW5kTGF5ZXIgPSBhd2FpdCBnZXREZWZhdWx0UmVsYXRpb25zaGlwQW5kTGF5ZXIodGhpcy5sYXllciwgdGhpcy5tYXBWaWV3LCB0aGlzLnNlcnZpY2VUeXBlKTtcbiAgICAgICAgICAgIGxldCBkZWZhdWx0RmllbGQgPSByZWxhdGlvbnNoaXBBbmRMYXllci5jdXJyTGF5ZXIuZmllbGRzLmZpbmQoKGZpZWxkKSA9PiBmaWVsZC52aXNpYmxlICYmIGZpZWxkLnR5cGUgPT09IFwiZGF0ZVwiKTtcbiAgICAgICAgICAgIGlmICghZGVmYXVsdEZpZWxkKSB7XG4gICAgICAgICAgICAgICAgZGVmYXVsdEZpZWxkID0gcmVsYXRpb25zaGlwQW5kTGF5ZXIuY3VyckxheWVyLmZpZWxkcy5maW5kKChmaWVsZCkgPT4gZmllbGQudmlzaWJsZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb250ZW50ID0gbmV3IFJlbGF0aW9uc2hpcENvbnRlbnQoe1xuICAgICAgICAgICAgICAgIGRpc3BsYXlDb3VudDogdGhpcy5yZWxhdGVkUmVjb3Jkc0RlZmF1bHRDb3VudCxcbiAgICAgICAgICAgICAgICByZWxhdGlvbnNoaXBJZDogcmVsYXRpb25zaGlwQW5kTGF5ZXIucmVsYXRpb25zaGlwLmlkLFxuICAgICAgICAgICAgICAgIG9yZGVyQnlGaWVsZHM6IFt7IGZpZWxkOiBkZWZhdWx0RmllbGQubmFtZSwgb3JkZXI6IFwiYXNjXCIgfV1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucG9wdXBUZW1wbGF0ZS5jb250ZW50LnB1c2goY29udGVudCk7XG4gICAgICAgIHRoaXMuYWRkVG9Qb3B1cENvbXBvbmVudHMoY29udGVudCwgdHJ1ZSk7XG4gICAgfVxuICAgIGFzeW5jIHNob3dQcmV2aWV3UG9wdXAoc2hvdykge1xuICAgICAgICB2YXIgX2EsIF9iLCBfYztcbiAgICAgICAgaWYgKHRoaXMuZGlzcGxheVBvcHVwICYmXG4gICAgICAgICAgICB0aGlzLmxheWVyRGlzcGxheVR5cGUgPT09IGxheWVyRGlzcGxheVR5cGVFbnVtLmZlYXR1cmUgJiZcbiAgICAgICAgICAgICF0aGlzLmlzUG9wdXBPcGVuRm9yQ3VycmVudExheWVyKSB7XG4gICAgICAgICAgICBpZiAoc2hvdyAmJlxuICAgICAgICAgICAgICAgIHRoaXMubGF5ZXIucG9wdXBFbmFibGVkICYmXG4gICAgICAgICAgICAgICAgdGhpcy5sYXllci5wb3B1cFRlbXBsYXRlKSB7XG4gICAgICAgICAgICAgICAgaWYgKChfYiA9IChfYSA9IHRoaXMubWFwVmlldy5wb3B1cCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmZlYXR1cmVzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGlmIHdlIGhhdmUgYSBwb3B1cCwgbWF5YmUgZnJvbSBhbm90aGVyIGxheWVyXG4gICAgICAgICAgICAgICAgICAgIC8vIG1ha2Ugc3VyZSB3ZSBkb24ndCBzdGF5IGluIGEgZHJpbGwtaW4gc3RhdGVcbiAgICAgICAgICAgICAgICAgICAgLy8gcG9wdXAgbWlnaHQgbm90IGJlIHZpc2libGUgYXQgdGhpcyBtb21lbnRcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYXBWaWV3LmNsb3NlUG9wdXAoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tYXBWaWV3LnBvcHVwLmZlYXR1cmVzID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLnByZXZpZXdQb3B1cENvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5zaW5nbGVGZWF0dXJlID0gYXdhaXQgcHJldmlld1BvcHVwKHRoaXMubWFwVmlldywgdGhpcy5sYXllciwgdGhpcy5wcmV2aWV3UG9wdXBDb250cm9sbGVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIChfYyA9IHRoaXMucHJldmlld1BvcHVwQ29udHJvbGxlcikgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmFib3J0KCk7XG4gICAgICAgICAgICAgICAgdGhpcy5tYXBWaWV3LmNsb3NlUG9wdXAoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmICh0aGlzLmxheWVyRGlzcGxheVR5cGUgPT09IGxheWVyRGlzcGxheVR5cGVFbnVtLm1hcE5vdGVzKSB7XG4gICAgICAgICAgICBpZiAoc2hvdyAmJiB0aGlzLm1hcE5vdGVzR3JhcGhpYykge1xuICAgICAgICAgICAgICAgIHRoaXMubWFwVmlldy5vcGVuUG9wdXAoe1xuICAgICAgICAgICAgICAgICAgICBmZWF0dXJlczogW3RoaXMubWFwTm90ZXNHcmFwaGljXSxcbiAgICAgICAgICAgICAgICAgICAgbG9jYXRpb246IGdldFBvaW50RnJvbUdlb21ldHJ5KHRoaXMubWFwTm90ZXNHcmFwaGljLmdlb21ldHJ5KVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5tYXBWaWV3LmNsb3NlUG9wdXAoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICAvLyBpZiBwYXJlbnQgaXMgc2hlbGwgcGFuZWwuIE1WIHdvcmtmbG93LlxuICAgIHNldHVwUmVzaXplT2JzZXJ2ZXIoKSB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgY29uc3QgcGFyZW50Tm9kZSA9IChfYSA9IHRoaXMuaG9zdEVsZW1lbnQpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5wYXJlbnRFbGVtZW50O1xuICAgICAgICBpZiAoKHBhcmVudE5vZGUgPT09IG51bGwgfHwgcGFyZW50Tm9kZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogcGFyZW50Tm9kZS50YWdOYW1lKSA9PT0gXCJDQUxDSVRFLVNIRUxMLVBBTkVMXCIpIHtcbiAgICAgICAgICAgIGNvbnN0IHNoZWxsUGFuZWxOb2RlID0gcGFyZW50Tm9kZTtcbiAgICAgICAgICAgIGlmIChpc0RlZmluZWQoc2hlbGxQYW5lbE5vZGUuY29sbGFwc2VkKSkge1xuICAgICAgICAgICAgICAgIHRoaXMucGFyZW50U2hlbGxPYnNlcnZlciA9IG5ldyBSZXNpemVPYnNlcnZlcigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzaGVsbFBhbmVsTm9kZS5jb2xsYXBzZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZG9uZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93UHJldmlld1BvcHVwKHRydWUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdGhpcy5wYXJlbnRTaGVsbE9ic2VydmVyLm9ic2VydmUoc2hlbGxQYW5lbE5vZGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zaG93UHJldmlld1BvcHVwKHRydWUpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNyZWF0ZUxheWVyT3B0aW9ucygpIHtcbiAgICAgICAgdmFyIF9hLCBfYjtcbiAgICAgICAgY29uc3QgbGF5ZXJPcHRpb25zID0gdGhpcy5wb3B1cFRlbXBsYXRlLmxheWVyT3B0aW9ucyB8fCBuZXcgdGhpcy5MYXllck9wdGlvbnMoKTtcbiAgICAgICAgLy8gc2hvd05vRGF0YVJlY29yZHMgYW5kIHJldHVyblRvcG1vc3RSYXN0ZXIgY2FuIGJlIG51bGwgd2hlbiBub3Qgc2V0XG4gICAgICAgIGxheWVyT3B0aW9ucy5zaG93Tm9EYXRhUmVjb3JkcyA9IChfYSA9IGxheWVyT3B0aW9ucy5zaG93Tm9EYXRhUmVjb3JkcykgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogZmFsc2U7XG4gICAgICAgIGxheWVyT3B0aW9ucy5yZXR1cm5Ub3Btb3N0UmFzdGVyID0gKF9iID0gbGF5ZXJPcHRpb25zLnJldHVyblRvcG1vc3RSYXN0ZXIpICE9PSBudWxsICYmIF9iICE9PSB2b2lkIDAgPyBfYiA6IHRydWU7XG4gICAgICAgIHRoaXMucG9wdXBUZW1wbGF0ZS5sYXllck9wdGlvbnMgPSBsYXllck9wdGlvbnM7XG4gICAgfVxuICAgIHJlbmRlcigpIHtcbiAgICAgICAgdmFyIF9hLCBfYiwgX2MsIF9kLCBfZSwgX2Y7XG4gICAgICAgIGlmICh0aGlzLmhhc0Vycm9yKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZW5kZXJQb3B1cEVycm9yKCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZW5hYmxlUG9wdXAgPSAoaChcImNhbGNpdGUtbGFiZWxcIiwgeyBjbGFzczogQ1NTJDYuZW5hYmxlUG9wdXAsIGFsaWdubWVudDogXCJzdGFydFwiLCBsYXlvdXQ6IFwiaW5saW5lLXNwYWNlLWJldHdlZW5cIiB9LCB0aGlzLnN0cmluZ3MuZW5hYmxlUG9wdXAsIGgoXCJjYWxjaXRlLXN3aXRjaFwiLCB7IHNjYWxlOiBcInNcIiwgY2hlY2tlZDogdGhpcy5nZXRQb3B1cEVuYWJsZWRQcm9wKCksIG9uQ2FsY2l0ZVN3aXRjaENoYW5nZTogKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2hlY2tlZCA9IGV2ZW50LnRhcmdldC5jaGVja2VkO1xuICAgICAgICAgICAgICAgIHN3aXRjaCAodGhpcy5sYXllckRpc3BsYXlUeXBlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgbGF5ZXJEaXNwbGF5VHlwZUVudW0uZmVhdHVyZToge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXllci5wb3B1cEVuYWJsZWQgPSBjaGVja2VkO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY2FzZSBsYXllckRpc3BsYXlUeXBlRW51bS5jbHVzdGVyOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxheWVyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZlYXR1cmVSZWR1Y3Rpb24ucG9wdXBFbmFibGVkID0gY2hlY2tlZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgbGF5ZXJEaXNwbGF5VHlwZUVudW0ubWFwTm90ZXM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWFwTm90ZXNQb3B1cEVuYWJsZWQgPSBjaGVja2VkO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXllci5wb3B1cEVuYWJsZWQgPSBjaGVja2VkO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuZW5hYmxlRGlzYWJsZVBvcHVwKGNoZWNrZWQpO1xuICAgICAgICAgICAgICAgIHRoaXMuaW50ZXJuYWxQb3B1cFVwZGF0ZWQuZW1pdCh0cnVlKTtcbiAgICAgICAgICAgICAgICAvLyBsYXllci5wb3B1cFRlbXBsYXRlIGNhbiBiZSBudWxsLCBkdWUgdG8gZGVib3VuY2VkUG9wdXBVcGRhdGVzLCBjYXVzaW5nIHBvcHVwIHByZXZpZXcgdG8gbm90IHdvcmtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5sYXllckRpc3BsYXlUeXBlICE9PSBsYXllckRpc3BsYXlUeXBlRW51bS5tYXBOb3RlcyAmJlxuICAgICAgICAgICAgICAgICAgICBjaGVja2VkICYmXG4gICAgICAgICAgICAgICAgICAgICF0aGlzLmxheWVyLnBvcHVwVGVtcGxhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXllci5wb3B1cFRlbXBsYXRlID0gdGhpcy5wb3B1cFRlbXBsYXRlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLnNob3dQcmV2aWV3UG9wdXAoY2hlY2tlZCk7XG4gICAgICAgICAgICB9IH0pKSk7XG4gICAgICAgIGNvbnN0IG1hbmFnZUV4cHJlc3Npb25CdG4gPSAoaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgYWxpZ25tZW50OiBcImljb24tZW5kLXNwYWNlLWJldHdlZW5cIiwgYXBwZWFyYW5jZTogXCJ0cmFuc3BhcmVudFwiLCBraW5kOiBcIm5ldXRyYWxcIiwgaWNvbkVuZDogZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSA9PT0gXCJydGxcIiA/IFwiY2hldnJvbi1sZWZ0XCIgOiBcImNoZXZyb24tcmlnaHRcIiwgbGFiZWw6IHRoaXMuc3RyaW5ncy5tYW5hZ2VFeHByZXNzaW9ucywgd2lkdGg6IFwiZnVsbFwiLCBvbkNsaWNrOiB0aGlzLm1hbmFnZUV4cHJlc3Npb25CdG5DbGljayB9LCB0aGlzLnN0cmluZ3MubWFuYWdlRXhwcmVzc2lvbnMpKTtcbiAgICAgICAgY29uc3QgaWdub3JlTm9kYXRhID0gKGgoXCJjYWxjaXRlLWxhYmVsXCIsIHsgYWxpZ25tZW50OiBcInN0YXJ0XCIsIGxheW91dDogXCJpbmxpbmUtc3BhY2UtYmV0d2VlblwiIH0sIHRoaXMuc3RyaW5ncy5pZ25vcmVOb0RhdGEsIGgoXCJjYWxjaXRlLXN3aXRjaFwiLCB7IHNjYWxlOiBcInNcIiwgY2hlY2tlZDogISgoX2MgPSAoX2IgPSAoX2EgPSB0aGlzLnBvcHVwVGVtcGxhdGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sYXllck9wdGlvbnMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5zaG93Tm9EYXRhUmVjb3JkcykgIT09IG51bGwgJiYgX2MgIT09IHZvaWQgMCA/IF9jIDogZmFsc2UpLCBvbkNhbGNpdGVTd2l0Y2hDaGFuZ2U6IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIHZhciBfYTtcbiAgICAgICAgICAgICAgICBjb25zdCBjaGVja2VkID0gZXZlbnQudGFyZ2V0LmNoZWNrZWQ7XG4gICAgICAgICAgICAgICAgaWYgKCEoKF9hID0gdGhpcy5wb3B1cFRlbXBsYXRlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGF5ZXJPcHRpb25zKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZUxheWVyT3B0aW9ucygpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLnBvcHVwVGVtcGxhdGUubGF5ZXJPcHRpb25zLnNob3dOb0RhdGFSZWNvcmRzID0gIWNoZWNrZWQ7XG4gICAgICAgICAgICAgICAgdGhpcy5pbnRlcm5hbFBvcHVwVXBkYXRlZC5lbWl0KCk7XG4gICAgICAgICAgICB9IH0pKSk7XG4gICAgICAgIGNvbnN0IGRpc3BsYXlUb3Btb3N0ID0gKGgoXCJjYWxjaXRlLWxhYmVsXCIsIHsgYWxpZ25tZW50OiBcInN0YXJ0XCIsIGxheW91dDogXCJpbmxpbmUtc3BhY2UtYmV0d2VlblwiIH0sIHRoaXMuc3RyaW5ncy5kaXNwbGF5VG9wbW9zdCwgaChcImNhbGNpdGUtc3dpdGNoXCIsIHsgc2NhbGU6IFwic1wiLCBjaGVja2VkOiAoX2YgPSAoX2UgPSAoX2QgPSB0aGlzLnBvcHVwVGVtcGxhdGUpID09PSBudWxsIHx8IF9kID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZC5sYXllck9wdGlvbnMpID09PSBudWxsIHx8IF9lID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZS5yZXR1cm5Ub3Btb3N0UmFzdGVyKSAhPT0gbnVsbCAmJiBfZiAhPT0gdm9pZCAwID8gX2YgOiB0cnVlLCBvbkNhbGNpdGVTd2l0Y2hDaGFuZ2U6IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIHZhciBfYTtcbiAgICAgICAgICAgICAgICBjb25zdCBjaGVja2VkID0gZXZlbnQudGFyZ2V0LmNoZWNrZWQ7XG4gICAgICAgICAgICAgICAgaWYgKCEoKF9hID0gdGhpcy5wb3B1cFRlbXBsYXRlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGF5ZXJPcHRpb25zKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZUxheWVyT3B0aW9ucygpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLnBvcHVwVGVtcGxhdGUubGF5ZXJPcHRpb25zLnJldHVyblRvcG1vc3RSYXN0ZXIgPSBjaGVja2VkO1xuICAgICAgICAgICAgICAgIHRoaXMuaW50ZXJuYWxQb3B1cFVwZGF0ZWQuZW1pdCgpO1xuICAgICAgICAgICAgfSB9KSkpO1xuICAgICAgICBjb25zdCBzdW1tYXJ5RVQgPSAoaChcInNlY3Rpb25cIiwgeyBjbGFzczogQ1NTJDYuc3VtbWFyeUVUIH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBzY2FsZTogXCJtXCIsIGljb246IFwidXNlclwiIH0pLCBoKFwibGFiZWxcIiwgeyBjbGFzczogQ1NTJDYuc3VtbWFyeUVUTGFiZWwgfSwgdGhpcy5zdHJpbmdzLnN1bW1hcnlFVEhlYWRpbmcpLCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyB0ZXh0OiB0aGlzLnN0cmluZ3MucmVtb3ZlLCBhcHBlYXJhbmNlOiBcInRyYW5zcGFyZW50XCIsIGljb246IFwieFwiLCBjbGFzczogQ1NTJDYuc3VtbWFyeUVUQWN0aW9uLCBvbkNsaWNrOiAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgICAgICAgICAgICAgdGhpcy5wb3B1cFRlbXBsYXRlLmxhc3RFZGl0SW5mb0VuYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB0aGlzLm1haW5Qb3B1cFJlUmVuZGVyLmVtaXQoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNhbGNpdGVGYWIuc2V0Rm9jdXMoKTtcbiAgICAgICAgICAgIH0gfSkpKTtcbiAgICAgICAgY29uc3QgY2FsY2l0ZUZhYiA9IChoKFwiY2FsY2l0ZS1mYWJcIiwgeyBpZDogXCJhZGRDb21wb25lbnRCdG5fSWRcIiwgaWNvbjogXCJwbHVzXCIsIHNsb3Q6IFwiZmFiXCIsIHNjYWxlOiBcInNcIiwgYXBwZWFyYW5jZTogXCJvdXRsaW5lLWZpbGxcIiwga2luZDogXCJuZXV0cmFsXCIsIGxhYmVsOiB0aGlzLnN0cmluZ3MuYWRkQ29udGVudCwgdGV4dDogdGhpcy5zdHJpbmdzLmFkZENvbnRlbnQsIFwidGV4dC1lbmFibGVkXCI6IHRydWUgfSkpO1xuICAgICAgICBjb25zdCBtYW5hZ2VGaWVsZHNCdG4gPSAoaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgYWxpZ25tZW50OiBcImljb24tZW5kLXNwYWNlLWJldHdlZW5cIiwgYXBwZWFyYW5jZTogXCJ0cmFuc3BhcmVudFwiLCBraW5kOiBcIm5ldXRyYWxcIiwgaWNvbkVuZDogZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSA9PT0gXCJydGxcIiA/IFwiY2hldnJvbi1sZWZ0XCIgOiBcImNoZXZyb24tcmlnaHRcIiwgbGFiZWw6IHRoaXMuc3RyaW5ncy5jb25maWd1cmVGaWVsZHMsIHdpZHRoOiBcImZ1bGxcIiwgb25DbGljazogKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZXNGbG93SXRlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJjYWxjaXRlLWZsb3ctaXRlbVwiKTtcbiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzRmxvd0l0ZW0uaGVhZGluZyA9IHRoaXMuc3RyaW5ncy5hdHRyaWJ1dGVzO1xuICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXNGbG93SXRlbS5kZXNjcmlwdGlvbiA9ICF0aGlzLmhpZGVMYXllclRpdGxlID8gdGhpcy5sYXllci50aXRsZSA6IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB0aGlzLmF0dHJpYnV0ZXNDb21wb25lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLWF0dHJpYnV0ZXNcIik7XG4gICAgICAgICAgICAgICAgdGhpcy5hdHRyaWJ1dGVzQ29tcG9uZW50LmxhbmcgPSB0aGlzLmN1cnJlbnRMYW5ndWFnZTtcbiAgICAgICAgICAgICAgICB0aGlzLmF0dHJpYnV0ZXNDb21wb25lbnQubGF5ZXIgPSB0aGlzLmxheWVyO1xuICAgICAgICAgICAgICAgIHRoaXMuYXR0cmlidXRlc0NvbXBvbmVudC5tYXBWaWV3ID0gdGhpcy5tYXBWaWV3O1xuICAgICAgICAgICAgICAgIHRoaXMuYXR0cmlidXRlc0NvbXBvbmVudC5wb3J0YWwgPSB0aGlzLnBvcnRhbDtcbiAgICAgICAgICAgICAgICB0aGlzLmF0dHJpYnV0ZXNDb21wb25lbnQubGF5ZXJEaXNwbGF5VHlwZSA9IHRoaXMubGF5ZXJEaXNwbGF5VHlwZTtcbiAgICAgICAgICAgICAgICB0aGlzLmF0dHJpYnV0ZXNDb21wb25lbnQuY29uZmlnID0gdGhpcy5jb25maWc7XG4gICAgICAgICAgICAgICAgdGhpcy5hdHRyaWJ1dGVzQ29tcG9uZW50LmNhbGNpdGVGbG93UHJvcHMgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHRoaXMuYXR0cmlidXRlc0NvbXBvbmVudC5kaXNwbGF5UG9wdXAgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzRmxvd0l0ZW0uYXBwZW5kQ2hpbGQodGhpcy5hdHRyaWJ1dGVzQ29tcG9uZW50KTtcbiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzRmxvd0l0ZW0uYmVmb3JlQmFjayA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZUF0dHJpYnV0ZVBvcG92ZXJzLmVtaXQoKTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbGNpdGVGbG93UHJvcHMpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYWxjaXRlRmxvd1Byb3BzLmZsb3cuYXBwZW5kQ2hpbGQoYXR0cmlidXRlc0Zsb3dJdGVtKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaG9zdEVsZW1lbnQuc2hhZG93Um9vdFxuICAgICAgICAgICAgICAgICAgICAgICAgLmdldEVsZW1lbnRCeUlkKFwicG9wdXBGbG93X0lkXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICAuYXBwZW5kQ2hpbGQoYXR0cmlidXRlc0Zsb3dJdGVtKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gYXR0cmlidXRlc0Zsb3dJdGVtLnNldEZvY3VzKCkpLCAyMDApO1xuICAgICAgICAgICAgfSB9LCB0aGlzLnN0cmluZ3MuY29uZmlndXJlRmllbGRzKSk7XG4gICAgICAgIGNvbnN0IHBvcHVwT3B0aW9ucyA9ICgpID0+IHtcbiAgICAgICAgICAgIC8vIHNob3cgcG9wdXAgb3B0aW9ucyBpZiBhbnkgb2YgdGhlIGZvbGxvd2luZyBpcyB0cnVlXG4gICAgICAgICAgICBjb25zdCBjb25maWd1cmVGaWVsZHMgPSB0aGlzLnNob3dDb25maWd1cmVGaWVsZHM7XG4gICAgICAgICAgICBjb25zdCBpc0ltYWdlcnkgPSB0aGlzLnNlcnZpY2VUeXBlID09PSBzZXJ2aWNlVHlwZUVudW0uaW1hZ2VyeTtcbiAgICAgICAgICAgIGlmIChjb25maWd1cmVGaWVsZHMgfHwgdGhpcy5zdXBwb3J0c0FyY2FkZSB8fCBpc0ltYWdlcnkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWJsb2NrXCIsIHsgaGVhZGluZzogdGhpcy5zdHJpbmdzLm9wdGlvbnMsIG9wZW46IHRydWUsIGNvbGxhcHNpYmxlOiB0cnVlIH0sIGlzSW1hZ2VyeSAmJiBpbWFnZXJ5T3B0aW9ucygpLCB0aGlzLnN1cHBvcnRzQXJjYWRlICYmIG1hbmFnZUV4cHJlc3Npb25CdG4sIGNvbmZpZ3VyZUZpZWxkcyAmJiBtYW5hZ2VGaWVsZHNCdG4pKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgaW1hZ2VyeU9wdGlvbnMgPSAoKSA9PiB7XG4gICAgICAgICAgICB2YXIgX2EsIF9iLCBfYztcbiAgICAgICAgICAgIC8vZW5hYmxlIGRpc3BsYXkgdG9wbW9zdCBpZiBzZXJ2aWNlIHZlcnNpb24gaXMgZ3JlYXRlciB0aGFuIDEwLjggYW5kIGlmIGl0cyBtb3NhaWMgZGF0YXNldFxuICAgICAgICAgICAgLy9vciBzaW5nbGUgcmFzdGVyIGRhdGFzZXQgd2hpY2ggaXMgbXVsdGlkaW1lbnNpb25hbFxuICAgICAgICAgICAgY29uc3QgbGF5ZXIgPSB0aGlzLmxheWVyO1xuICAgICAgICAgICAgY29uc3QgaXNNb3NhaWNEYXRhc2V0U2VydmljZSA9ICEhKChfYiA9IChfYSA9IGxheWVyLmNhcGFiaWxpdGllcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLm9wZXJhdGlvbnMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5zdXBwb3J0c1F1ZXJ5KSAmJiAoKF9jID0gbGF5ZXIuZmllbGRzKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MubGVuZ3RoKTtcbiAgICAgICAgICAgIGNvbnN0IGlzTXVsdGlkaW1lbnNpb25hbCA9IGxheWVyLmhhc011bHRpZGltZW5zaW9ucztcbiAgICAgICAgICAgIHJldHVybiAoaChcImRpdlwiLCB7IGNsYXNzOiBDU1MkNi5pbWFnZXJ5T3B0aW9ucyB9LCBpZ25vcmVOb2RhdGEsIGdldFNlcnZpY2VWZXJzaW9uKGxheWVyKSA+PSAxMC44ICYmXG4gICAgICAgICAgICAgICAgKGlzTW9zYWljRGF0YXNldFNlcnZpY2UgfHwgaXNNdWx0aWRpbWVuc2lvbmFsKSAmJlxuICAgICAgICAgICAgICAgIGRpc3BsYXlUb3Btb3N0KSk7XG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IHBvcHVwTWFpbiA9IChoKFwiZGl2XCIsIG51bGwsIGVuYWJsZVBvcHVwLCBoKFwiZGl2XCIsIHsgaWQ6IFwicG9wdXBEaXZfSWRcIiB9LCBwb3B1cE9wdGlvbnMoKSwgdGhpcy5wb3B1cFRpdGxlQ29tcG9uZW50KCksIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDYuY29tcG9uZW50RGl2IH0sIGgoXCJjYWxjaXRlLXNvcnRhYmxlLWxpc3RcIiwgeyBpZDogXCJTb3J0YWJsZUNvbXBvbmVudHNfSWRcIiwgY2xhc3M6IFwic29ydGFibGUtbGlzdFwiLCBvbkNhbGNpdGVMaXN0T3JkZXJDaGFuZ2U6IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgIHRoaXMuc29ydGFibGVDb21wb25lbnRzID1cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5ob3N0RWxlbWVudC5zaGFkb3dSb290LmdldEVsZW1lbnRCeUlkKFwiU29ydGFibGVDb21wb25lbnRzX0lkXCIpO1xuICAgICAgICAgICAgICAgIGNvbnN0IG5ld0d1aWRMaXN0ID0gW107XG4gICAgICAgICAgICAgICAgY29uc3QgYWxsQ29tcG9uZW50cyA9IHRoaXMuc29ydGFibGVDb21wb25lbnRzLmdldEVsZW1lbnRzQnlUYWdOYW1lKFwiZGl2XCIpO1xuICAgICAgICAgICAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgYWxsQ29tcG9uZW50cy5sZW5ndGg7IHgrKykge1xuICAgICAgICAgICAgICAgICAgICBuZXdHdWlkTGlzdC5wdXNoKGFsbENvbXBvbmVudHNbeF0uaWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLnJlb3JkZXIodGhpcy5wb3B1cFRlbXBsYXRlLmNvbnRlbnQsIHRoaXMuZ3VpZExpc3QsIG5ld0d1aWRMaXN0KTtcbiAgICAgICAgICAgICAgICB0aGlzLnJlb3JkZXIodGhpcy5wb3B1cENvbXBvbmVudHMsIHRoaXMuZ3VpZExpc3QsIG5ld0d1aWRMaXN0KTtcbiAgICAgICAgICAgICAgICB0aGlzLmd1aWRMaXN0ID0gbmV3R3VpZExpc3Q7XG4gICAgICAgICAgICAgICAgdGhpcy5pbnRlcm5hbFBvcHVwVXBkYXRlZC5lbWl0KCk7XG4gICAgICAgICAgICB9IH0sIHRoaXMucG9wdXBDb21wb25lbnRzKSksIGgoXCJkaXZcIiwgeyByZWY6IChlbCkgPT4gKHRoaXMuc3VtbWFyeUVURGl2ID0gZWwpIH0sIHRoaXMubGF5ZXJIYXNFVCAmJiB0aGlzLnBvcHVwVGVtcGxhdGUubGFzdEVkaXRJbmZvRW5hYmxlZCAmJiBzdW1tYXJ5RVQpKSkpO1xuICAgICAgICBjb25zdCBiYWNrQnV0dG9uID0gKGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IHRleHQ6IHRoaXMuc3RyaW5ncy5iYWNrLCBzY2FsZTogXCJzXCIsIHNsb3Q6IFwiaGVhZGVyLWFjdGlvbnMtc3RhcnRcIiwgcmVmOiAoYmFja0J1dHRvbkVsKSA9PiAodGhpcy5iYWNrQnV0dG9uRWwgPSBiYWNrQnV0dG9uRWwpLCBvbkNsaWNrOiAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICB0aGlzLmRvbmUoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmFyY2dpc1BvcHVwRGlzbWlzc2VkQ2hhbmdlLmVtaXQoKTtcbiAgICAgICAgICAgIH0gfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IGljb246IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCkgPT09IFwicnRsXCIgPyBcImNoZXZyb24tcmlnaHRcIiA6IFwiY2hldnJvbi1sZWZ0XCIgfSkpKTtcbiAgICAgICAgcmV0dXJuIChoKEhvc3QsIHsgc3R5bGU6IHRoaXMuY2FsY2l0ZUZsb3dQcm9wcyA/IHt9IDogeyBkaXNwbGF5OiBcImZsZXhcIiwgZmxleDogXCIxIDEgYXV0b1wiLCBvdmVyZmxvdzogXCJoaWRkZW5cIiB9IH0sIHRoaXMuY2FsY2l0ZUZsb3dQcm9wcyA/IChoKFwiZGl2XCIsIHsgZGlyOiBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpLCByZWY6ICgpID0+ICh0aGlzLnBvcHVwUGFuZWwgPSB0aGlzLmNhbGNpdGVGbG93UHJvcHMuY2FsY2l0ZUZsb3dJdGVtKSB9LCB0aGlzLnNlcnZpY2VUeXBlID09PSBzZXJ2aWNlVHlwZUVudW0ud21zID8gZW5hYmxlUG9wdXAgOiBwb3B1cE1haW4pKSA6IChoKFwiY2FsY2l0ZS1mbG93XCIsIHsgaWQ6IFwicG9wdXBGbG93X0lkXCIsIGRpcjogZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSB9LCBoKFwiY2FsY2l0ZS1mbG93LWl0ZW1cIiwgeyByZWY6IChlbCkgPT4gKHRoaXMucG9wdXBQYW5lbCA9IGVsKSwgaGVhZGluZzogdGhpcy5zdHJpbmdzLnBvcHVwSGVhZGluZywgZGVzY3JpcHRpb246ICF0aGlzLmhpZGVMYXllclRpdGxlID8gdGhpcy5sYXllci50aXRsZSA6IHVuZGVmaW5lZCwgY2xvc2FibGU6IHRoaXMuZGlzbWlzc2libGUsIG9uQ2FsY2l0ZUZsb3dJdGVtQ2xvc2U6IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgIHRoaXMuZG9uZSgpO1xuICAgICAgICAgICAgICAgIHRoaXMuYXJjZ2lzUG9wdXBEaXNtaXNzZWRDaGFuZ2UuZW1pdCgpO1xuICAgICAgICAgICAgfSB9LCB0aGlzLnNlcnZpY2VUeXBlID09PSBzZXJ2aWNlVHlwZUVudW0ud21zID8gZW5hYmxlUG9wdXAgOiBwb3B1cE1haW4sIHRoaXMuc2VydmljZVR5cGUgIT09IHNlcnZpY2VUeXBlRW51bS53bXMgJiYgY2FsY2l0ZUZhYiwgdGhpcy5iYWNrQnV0dG9uICYmIGJhY2tCdXR0b24pKSkpKTtcbiAgICB9XG4gICAgcmVuZGVyUG9wdXBFcnJvcigpIHtcbiAgICAgICAgY29uc3QgcG9wdXBNYWluID0gKGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDYubm90aWNlIH0sIGgoXCJjYWxjaXRlLW5vdGljZVwiLCB7IG9wZW46IHRydWUsIGNsb3NhYmxlOiBmYWxzZSwgaWNvbjogXCJleGNsYW1hdGlvbi1tYXJrLXRyaWFuZ2xlXCIsIHNjYWxlOiBcInNcIiB9LCBoKFwiZGl2XCIsIHsgc2xvdDogXCJtZXNzYWdlXCIgfSwgXCIgXCIsIHRoaXMuc3RyaW5ncy5wb3B1cFRpbGVFcnJvcikpKSk7XG4gICAgICAgIHJldHVybiAoaChIb3N0LCB7IHN0eWxlOiB0aGlzLmNhbGNpdGVGbG93UHJvcHMgPyB7fSA6IHsgZGlzcGxheTogXCJmbGV4XCIsIGZsZXg6IFwiMSAxIGF1dG9cIiwgb3ZlcmZsb3c6IFwiaGlkZGVuXCIgfSB9LCB0aGlzLmNhbGNpdGVGbG93UHJvcHMgPyAoaChcImRpdlwiLCB7IGRpcjogZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSwgcmVmOiAoKSA9PiAodGhpcy5wb3B1cFBhbmVsID0gdGhpcy5jYWxjaXRlRmxvd1Byb3BzLmNhbGNpdGVGbG93SXRlbSkgfSwgcG9wdXBNYWluKSkgOiAoaChcImNhbGNpdGUtZmxvd1wiLCB7IGlkOiBcInBvcHVwRmxvd19JZFwiLCBkaXI6IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCkgfSwgaChcImNhbGNpdGUtZmxvdy1pdGVtXCIsIHsgcmVmOiAoZWwpID0+ICh0aGlzLnBvcHVwUGFuZWwgPSBlbCksIGhlYWRpbmc6IHRoaXMuc3RyaW5ncy5wb3B1cEhlYWRpbmcsIGRlc2NyaXB0aW9uOiAhdGhpcy5oaWRlTGF5ZXJUaXRsZSA/IHRoaXMubGF5ZXIudGl0bGUgOiB1bmRlZmluZWQsIGNsb3NhYmxlOiB0aGlzLmRpc21pc3NpYmxlLCBvbkNhbGNpdGVGbG93SXRlbUNsb3NlOiAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICB0aGlzLmRvbmUoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmFyY2dpc1BvcHVwRGlzbWlzc2VkQ2hhbmdlLmVtaXQoKTtcbiAgICAgICAgICAgIH0gfSwgcG9wdXBNYWluKSkpKSk7XG4gICAgfVxuICAgIGdldCBob3N0RWxlbWVudCgpIHsgcmV0dXJuIGdldEVsZW1lbnQodGhpcyk7IH1cbn07XG5BcmNnaXNQb3B1cC5zdHlsZSA9IGFyY2dpc1BvcHVwQ3NzO1xuXG5jb25zdCBBcmNnaXNQb3B1cEFyY2FkZSA9IGNsYXNzIHtcbiAgICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgICAgIHJlZ2lzdGVySW5zdGFuY2UodGhpcywgaG9zdFJlZik7XG4gICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzID0gY3JlYXRlRXZlbnQodGhpcywgXCJjbG9zZVBvcHVwUG9wb3ZlcnNcIiwgNyk7XG4gICAgICAgIHRoaXMuaW50ZXJuYWxQb3B1cFVwZGF0ZWQgPSBjcmVhdGVFdmVudCh0aGlzLCBcImludGVybmFsUG9wdXBVcGRhdGVkXCIsIDcpO1xuICAgICAgICB0aGlzLmRpc2FibGVQb3B1cFBhbmVsID0gY3JlYXRlRXZlbnQodGhpcywgXCJkaXNhYmxlUG9wdXBQYW5lbFwiLCA3KTtcbiAgICAgICAgdGhpcy5ndWlkID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLmFyY2FkZUNvbnRlbnQgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuYmxvY2tPcGVuID0gZmFsc2U7XG4gICAgICAgIHRoaXMucmVSZW5kZXIgPSB1bmRlZmluZWQ7XG4gICAgfVxuICAgIC8vIGxpZmVjeWNsZSBtZXRob2RzXG4gICAgYXN5bmMgY29tcG9uZW50V2lsbExvYWQoKSB7XG4gICAgICAgIHRoaXMubGF5ZXIgPSBwb3B1cFN0YXRlLmxheWVyO1xuICAgICAgICB0aGlzLm1hcFZpZXcgPSBwb3B1cFN0YXRlLm1hcFZpZXc7XG4gICAgICAgIHRoaXMucG9ydGFsID0gcG9wdXBTdGF0ZS5wb3J0YWw7XG4gICAgICAgIHRoaXMuY29uZmlnID0gcG9wdXBTdGF0ZS5jb25maWc7XG4gICAgICAgIHRoaXMuc3RyaW5ncyA9IHBvcHVwU3RhdGUuc3RyaW5ncztcbiAgICAgICAgdGhpcy5jdXJyZW50TGFuZ3VhZ2UgPSBwb3B1cFN0YXRlLmN1cnJlbnRMYW5ndWFnZTtcbiAgICAgICAgdGhpcy5zZXJ2aWNlVHlwZSA9IHBvcHVwU3RhdGUuc2VydmljZVR5cGU7XG4gICAgICAgIHRoaXMucG9wdXBUZW1wbGF0ZSA9IHBvcHVwU3RhdGUucG9wdXBUZW1wbGF0ZTtcbiAgICAgICAgdGhpcy5sYXllckRpc3BsYXlUeXBlID0gcG9wdXBTdGF0ZS5sYXllckRpc3BsYXlUeXBlO1xuICAgIH1cbiAgICBhc3luYyBjb21wb25lbnREaWRMb2FkKCkge1xuICAgICAgICBpZiAodGhpcy5ibG9ja09wZW4pIHtcbiAgICAgICAgICAgIHRoaXMuYmxvY2tPcHRpb25zLnNjcm9sbEludG9WaWV3KHsgYmVoYXZpb3I6IFwic21vb3RoXCIsIGJsb2NrOiBcIm5lYXJlc3RcIiwgaW5saW5lOiBcInN0YXJ0XCIgfSk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmxhdW5jaEFyY2FkZSgpO1xuICAgICAgICB9XG4gICAgfVxuICAgIC8vIHByaXZhdGUgbWV0aG9kcyBhbmQgcHJvcGVydGllc1xuICAgIGFzeW5jIGxhdW5jaEFyY2FkZSgpIHtcbiAgICAgICAgdmFyIF9hLCBfYiwgX2M7XG4gICAgICAgIGlmICghdGhpcy5hcmNhZGVFZGl0b3IpIHtcbiAgICAgICAgICAgIHRoaXMuZGlzYWJsZVBvcHVwUGFuZWwuZW1pdCh0cnVlKTtcbiAgICAgICAgICAgIHRoaXMuYXJjYWRlRWRpdG9yID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1tb2RhbC1hcmNhZGVcIik7XG4gICAgICAgICAgICB0aGlzLmFyY2FkZUVkaXRvci5hcmNhZGVTY3JpcHQgPSBnZXRBcmNhZGVTY3JpcHQoKF9hID0gdGhpcy5hcmNhZGVDb250ZW50LmV4cHJlc3Npb25JbmZvKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZXhwcmVzc2lvbiwgdGhpcy5sYXllckRpc3BsYXlUeXBlLCB0aGlzLnN0cmluZ3MpO1xuICAgICAgICAgICAgdGhpcy5hcmNhZGVFZGl0b3IuYXJjYWRlUHJvZmlsZSA9IGF3YWl0IGdldEFyY2FkZVByb2ZpbGUodGhpcy5sYXllciwgdGhpcy5tYXBWaWV3LCB0aGlzLnNlcnZpY2VUeXBlLCB0aGlzLnBvcHVwVGVtcGxhdGUsIHRoaXMubGF5ZXJEaXNwbGF5VHlwZSk7XG4gICAgICAgICAgICB0aGlzLmFyY2FkZUVkaXRvci50ZXN0RGF0YSA9IGF3YWl0IGdldFRlc3REYXRhKHRoaXMubGF5ZXIsIHRoaXMubWFwVmlldywgdGhpcy5sYXllckRpc3BsYXlUeXBlLCB0aGlzLnBvcHVwVGVtcGxhdGUpO1xuICAgICAgICAgICAgdGhpcy5hcmNhZGVFZGl0b3Iuc3VnZ2VzdGlvbnMgPSBnZXRUZW1wbGF0ZXModGhpcy5zdHJpbmdzKTtcbiAgICAgICAgICAgIHRoaXMuYXJjYWRlRWRpdG9yLmFkZEV4aXN0aW5nRXhwcmVzc2lvbnMgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5hcmNhZGVFZGl0b3IubGF5ZXIgPSB0aGlzLmxheWVyO1xuICAgICAgICAgICAgdGhpcy5hcmNhZGVFZGl0b3IuYXJjYWRlVGl0bGUgPVxuICAgICAgICAgICAgICAgICgoX2IgPSB0aGlzLmFyY2FkZUNvbnRlbnQuZXhwcmVzc2lvbkluZm8pID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi50aXRsZSkgfHwgdGhpcy5zdHJpbmdzLmFyY2FkZURlZmF1bHRUaXRsZTtcbiAgICAgICAgICAgIHRoaXMuYXJjYWRlRWRpdG9yLmFyY2FkZVRpdGxlRWRpdGFibGUgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5hcmNhZGVFZGl0b3IucmV0dXJuUHJlZGljdE91dHB1dFR5cGUgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMuYXJjYWRlRWRpdG9yLmFyY2FkZVRpdGxlRWRpdGluZ0VuYWJsZWQgPSAhKChfYyA9IHRoaXMuYXJjYWRlQ29udGVudC5leHByZXNzaW9uSW5mbykgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLnRpdGxlKTtcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5hcmNhZGVFZGl0b3IpO1xuICAgICAgICAgICAgdGhpcy5hcmNhZGVFZGl0b3IuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc01vZGFsQXJjYWRlQ2xvc2VcIiwgKGV2ZW50KSA9PiB0aGlzLmFyY2FkZVNldHVwKGV2ZW50LmRldGFpbCkpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGFzeW5jIGFyY2FkZVNldHVwKGFyY2FkZU9iamVjdCkge1xuICAgICAgICBpZiAoYXJjYWRlT2JqZWN0KSB7XG4gICAgICAgICAgICB0aGlzLmFyY2FkZUNvbnRlbnQuZXhwcmVzc2lvbkluZm8uZXhwcmVzc2lvbiA9IGFyY2FkZU9iamVjdC5zY3JpcHQ7XG4gICAgICAgICAgICB0aGlzLmFyY2FkZUNvbnRlbnQuZXhwcmVzc2lvbkluZm8udGl0bGUgPSBhcmNhZGVPYmplY3QudGl0bGU7XG4gICAgICAgICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgICAgICAgICB0aGlzLmludGVybmFsUG9wdXBVcGRhdGVkLmVtaXQoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmRpc2FibGVQb3B1cFBhbmVsLmVtaXQoZmFsc2UpO1xuICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuYXJjYWRlRWRpdG9yKTtcbiAgICAgICAgdGhpcy5hcmNhZGVFZGl0b3IgPSBudWxsO1xuICAgIH1cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIHJldHVybiAoaChIb3N0LCBudWxsLCBoKFwiY2FsY2l0ZS1ibG9ja1wiLCB7IGRpcjogZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSwgaGVhZGluZzogdGhpcy5zdHJpbmdzLmFyY2FkZSwgZGVzY3JpcHRpb246IHRoaXMuYXJjYWRlQ29udGVudC5leHByZXNzaW9uSW5mby50aXRsZSwgY29sbGFwc2libGU6IHRydWUsIG9wZW46IHRoaXMuYmxvY2tPcGVuLCBkcmFnSGFuZGxlOiB0cnVlIH0sIGgoXCJkaXZcIiwgeyBjbGFzczogXCJpZ25vcmUtZWxlbWVudHMtc29ydGFibGVcIiwgc2xvdDogXCJjb250cm9sXCIgfSwgaChcImFyY2dpcy1jYWxjaXRlLWJsb2NrLW9wdGlvbnNcIiwgeyByZWY6IChlbCkgPT4gKHRoaXMuYmxvY2tPcHRpb25zID0gZWwpLCBndWlkOiB0aGlzLmd1aWQsIGludGxPcHRpb25zOiB0aGlzLnN0cmluZ3Mub3B0aW9ucywgaW50bERlbGV0ZTogdGhpcy5zdHJpbmdzLmRlbGV0ZSwgaW50bER1cGxpY2F0ZTogdGhpcy5zdHJpbmdzLmR1cGxpY2F0ZSwgY2FsY2l0ZUJsb2NrT3B0aW9uczogeyBoYXNEZWxldGU6IHRydWUsIGhhc0R1cGxpY2F0ZTogdHJ1ZSB9IH0pKSwgaChcImRpdlwiLCB7IHNsb3Q6IFwiaWNvblwiIH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBzY2FsZTogXCJtXCIsIGljb246IFwiY29kZVwiIH0pKSwgaChcImRpdlwiLCB7IGNsYXNzOiBcImlnbm9yZS1lbGVtZW50cy1zb3J0YWJsZVwiIH0sIGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IGFwcGVhcmFuY2U6IFwidHJhbnNwYXJlbnRcIiwgd2lkdGg6IFwiZnVsbFwiLCBvbkNsaWNrOiBhc3luYyAoKSA9PiBhd2FpdCB0aGlzLmxhdW5jaEFyY2FkZSgpIH0sIHRoaXMuc3RyaW5ncy5lZGl0RXhwcmVzc2lvbikpKSkpO1xuICAgIH1cbiAgICBnZXQgaG9zdEVsZW1lbnQoKSB7IHJldHVybiBnZXRFbGVtZW50KHRoaXMpOyB9XG59O1xuXG5jb25zdCBDU1MkNSA9IHtcbiAgICBsaXN0V2FybmluZ0RpdjogXCJsaXN0LXdhcm5pbmctZGl2XCIsXG4gICAgbGlzdFdhcm5pbmdJY29uOiBcImxpc3Qtd2FybmluZy1pY29uXCIsXG4gICAgbGlzdFdhcm5pbmdMYWJlbDogXCJsaXN0LXdhcm5pbmctbGFiZWxcIixcbiAgICBsaXN0V2FybmluZ1RleHQ6IFwibGlzdC13YXJuaW5nLXRleHRcIixcbiAgICBmb3JtSW5wdXRCdXR0b246IFwiZm9ybS1pbnB1dC1idXR0b25cIlxufTtcblxuY29uc3QgYXJjZ2lzUG9wdXBBdHRhY2htZW50c0NzcyA9IFwiLmxpc3Qtd2FybmluZy1kaXZ7YmFja2dyb3VuZC1jb2xvcjp2YXIoLS1hcmNnaXMtYXBwLWJhY2tncm91bmQpfS5saXN0LXdhcm5pbmctbGFiZWx7YWxpZ24taXRlbXM6c3RyZXRjaDtiYWNrZ3JvdW5kLWNvbG9yOnZhcigtLWFyY2dpcy1hcHAtYmFja2dyb3VuZCk7Ym9yZGVyLXJhZGl1czp2YXIoLS1hcmNnaXMtYXBwLWJvcmRlci1yYWRpdXMpO2JvcmRlcjoxcHggc29saWQgdmFyKC0tYXJjZ2lzLWFwcC1ib3JkZXIpO2Rpc3BsYXk6ZmxleDtmb250LXNpemU6dmFyKC0tYXJjZ2lzLWFwcC1mb250LXNpemUtLTIpfS5saXN0LXdhcm5pbmctaWNvbnthbGlnbi1pdGVtczpjZW50ZXI7YmFja2dyb3VuZC1jb2xvcjp2YXIoLS1hcmNnaXMtYXBwLWJhY2tncm91bmQtY29udGVudCk7ZGlzcGxheTpmbGV4O3BhZGRpbmc6MCB2YXIoLS1hcmNnaXMtYXBwLXNpZGUtc3BhY2luZy1oYWxmKX0ubGlzdC13YXJuaW5nLXRleHR7cGFkZGluZzp2YXIoLS1hcmNnaXMtYXBwLWNhcC1zcGFjaW5nLXF1YXJ0ZXIpIHZhcigtLWFyY2dpcy1hcHAtc2lkZS1zcGFjaW5nLWhhbGYpfS5mb3JtLWlucHV0LWJ1dHRvbntkaXNwbGF5OmZsZXh9LmZvcm0taW5wdXQtYnV0dG9uIGNhbGNpdGUtaW5wdXRbdHlwZT10ZXh0XXtkaXNwbGF5OmZsZXg7ZmxleC1mbG93OmNvbHVtbiBub3dyYXA7ZmxleDoxIDAgMCU7b3ZlcmZsb3c6aGlkZGVufS5mb3JtLWlucHV0LWJ1dHRvbiBjYWxjaXRlLWFjdGlvbnttYXJnaW46MDtmbGV4OjAgMCAwJTtqdXN0aWZ5LXNlbGY6ZmxleC1lbmR9XCI7XG5cbmNvbnN0IEFyY2dpc1BvcHVwQXR0YWNobWVudHMgPSBjbGFzcyB7XG4gICAgY29uc3RydWN0b3IoaG9zdFJlZikge1xuICAgICAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycyA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiY2xvc2VQb3B1cFBvcG92ZXJzXCIsIDcpO1xuICAgICAgICB0aGlzLmludGVybmFsUG9wdXBVcGRhdGVkID0gY3JlYXRlRXZlbnQodGhpcywgXCJpbnRlcm5hbFBvcHVwVXBkYXRlZFwiLCA3KTtcbiAgICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbCA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiZGlzYWJsZVBvcHVwUGFuZWxcIiwgNyk7XG4gICAgICAgIHRoaXMuZm9ybUlucHV0ID0gKGZvcm1UeXBlLCBmb3JtU3RyaW5nLCBmb3JtSW5wdXRFbGVtZW50LCBmb3JtVmFsdWUsIGZvcm1QbGFjZWhvbGRlclxuICAgICAgICAvLyBwcm9tcHRNZXNzYWdlOiBzdHJpbmdcbiAgICAgICAgKSA9PiB7XG4gICAgICAgICAgICB2YXIgX2E7XG4gICAgICAgICAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWxhYmVsXCIsIHsgc2NhbGU6IFwic1wiIH0sIGZvcm1TdHJpbmcsIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDUuZm9ybUlucHV0QnV0dG9uIH0sIGgoXCJjYWxjaXRlLWlucHV0XCIsIHsgdHlwZTogXCJ0ZXh0XCIsIGF1dG9mb2N1czogdHJ1ZSwgcmVmOiBmb3JtSW5wdXRFbGVtZW50LCB2YWx1ZTogZm9ybVZhbHVlLCBwbGFjZWhvbGRlcjogZm9ybVBsYWNlaG9sZGVyLCBvbkNhbGNpdGVJbnB1dElucHV0OiAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGlucHV0VmFsID0gZXZlbnQudGFyZ2V0LnZhbHVlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZm9ybVR5cGUgPT09IFwidGl0bGVcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hdHRhY2htZW50Q29udGVudC50aXRsZSA9IGlucHV0VmFsO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hdHRhY2htZW50Q29udGVudC5kZXNjcmlwdGlvbiA9IGlucHV0VmFsO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVSZW5kZXIgPSAhdGhpcy5yZVJlbmRlcjtcbiAgICAgICAgICAgICAgICB9LCBvbkNsaWNrOiAoKSA9PiB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCkgfSksICgoX2EgPSB0aGlzLnBvcHVwVGVtcGxhdGUuZmllbGRJbmZvcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkgPiAwICYmIChoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyB0ZXh0OiB0aGlzLnN0cmluZ3MuYXR0cmlidXRlcywgb25DbGljazogKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1wb3B1cC1maWVsZC1waWNrLWxpc3RcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5wb3BvdmVyUHJvcHMgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmRWxlbWVudDogdGhpcy5wb3B1cEZsb3dJdGVtXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QubXVsdGlwbGUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0LmhlYWRpbmcgPSB0aGlzLnN0cmluZ3MuYWRkRmllbGQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzUG9wdXBQaWNrTGlzdERpc21pc3NlZFwiLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzUG9wdXBQaWNrTGlzdENoYW5nZVwiLCAoZXZlbnQpID0+IHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0Q2hhbmdlcyhldmVudCwgZm9ybVR5cGUpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KHRydWUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSwgc2NhbGU6IFwic1wiLCBpY29uOiBcImJyYWNrZXRzLWN1cmx5XCIgfSkpKSkpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLmd1aWQgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuYXR0YWNobWVudENvbnRlbnQgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMubGF5ZXJTdXBwb3J0c1Jlc2l6ZUF0dGFjaG1lbnRzID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLmJsb2NrT3BlbiA9IGZhbHNlO1xuICAgICAgICB0aGlzLnBvcHVwRmxvd0l0ZW0gPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMucmVSZW5kZXIgPSB1bmRlZmluZWQ7XG4gICAgfVxuICAgIC8vIGxpZmVjeWNsZSBtZXRob2RzXG4gICAgY29tcG9uZW50V2lsbExvYWQoKSB7XG4gICAgICAgIHRoaXMuc3RyaW5ncyA9IHBvcHVwU3RhdGUuc3RyaW5ncztcbiAgICAgICAgdGhpcy5wb3B1cFRlbXBsYXRlID0gcG9wdXBTdGF0ZS5wb3B1cFRlbXBsYXRlO1xuICAgICAgICBpZiAodGhpcy5sYXllclN1cHBvcnRzUmVzaXplQXR0YWNobWVudHMpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5hdHRhY2htZW50Q29udGVudC5kaXNwbGF5VHlwZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuYXR0YWNobWVudENvbnRlbnQuZGlzcGxheVR5cGUgPSBBdHRhY2htZW50RGlzcGxheVR5cGUuYXV0bztcbiAgICAgICAgICAgICAgICAvLyB0ZW1wXG4gICAgICAgICAgICAgICAgdGhpcy5pbnRlcm5hbFBvcHVwVXBkYXRlZC5lbWl0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmF0dGFjaG1lbnRDb250ZW50LmRpc3BsYXlUeXBlID0gQXR0YWNobWVudERpc3BsYXlUeXBlLmxpc3Q7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGlzLmF0dGFjaG1lbnRDb250ZW50LnRpdGxlKSB7XG4gICAgICAgICAgICB0aGlzLmF0dGFjaG1lbnRDb250ZW50LnRpdGxlID0gXCJcIjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMuYXR0YWNobWVudENvbnRlbnQuZGVzY3JpcHRpb24pIHtcbiAgICAgICAgICAgIHRoaXMuYXR0YWNobWVudENvbnRlbnQuZGVzY3JpcHRpb24gPSBcIlwiO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgICAgIGlmICh0aGlzLmJsb2NrT3Blbikge1xuICAgICAgICAgICAgdGhpcy5ibG9ja09wdGlvbnMuc2Nyb2xsSW50b1ZpZXcoeyBiZWhhdmlvcjogXCJzbW9vdGhcIiwgYmxvY2s6IFwibmVhcmVzdFwiLCBpbmxpbmU6IFwic3RhcnRcIiB9KTtcbiAgICAgICAgICAgIHRoaXMuYmxvY2tPcHRpb25zLnNldEZvY3VzKCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgY29tcG9uZW50RGlkVXBkYXRlKCkge1xuICAgICAgICB0aGlzLmludGVybmFsUG9wdXBVcGRhdGVkLmVtaXQoKTtcbiAgICB9XG4gICAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7XG4gICAgICAgIGlmICh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCkge1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLy8gRXZlbnRzXG4gICAgY2FsY2l0ZUJsb2NrVG9nZ2xlSGFuZGxlcigpIHtcbiAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgIH1cbiAgICBjbG9zZVBvcHVwUG9wb3ZlcnNIYW5kbGVyKCkge1xuICAgICAgICBpZiAodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpIHtcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpO1xuICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QgPSBudWxsO1xuICAgICAgICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KGZhbHNlKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICAvLyBmaWVsZCBzZWxlY3Rpb24gZm9yIHRpdGxlIGFuZCBjYXB0aW9uXG4gICAgcG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0Q2hhbmdlcyhldmVudCwgZm9ybVR5cGUpIHtcbiAgICAgICAgY29uc3Qgc2VsZWN0ZWRGaWVsZE5hbWUgPSBldmVudC5kZXRhaWwuc2VsZWN0ZWRGaWVsZHNbMF07XG4gICAgICAgIGlmIChmb3JtVHlwZSA9PT0gXCJ0aXRsZVwiKSB7XG4gICAgICAgICAgICB0aGlzLmNvbnRlbnRUaXRsZS52YWx1ZSA9IGFkZFNlbGVjdGVkRmllbGRBdEN1cnNvcih0aGlzLmNvbnRlbnRUaXRsZSwgc2VsZWN0ZWRGaWVsZE5hbWUpO1xuICAgICAgICAgICAgdGhpcy5jb250ZW50VGl0bGUuc2V0Rm9jdXMoKTtcbiAgICAgICAgICAgIHRoaXMuYXR0YWNobWVudENvbnRlbnQudGl0bGUgPSB0aGlzLmNvbnRlbnRUaXRsZS52YWx1ZTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChmb3JtVHlwZSA9PT0gXCJkZXNjcmlwdGlvblwiKSB7XG4gICAgICAgICAgICB0aGlzLmNvbnRlbnREZXNjcmlwdGlvbi52YWx1ZSA9IGFkZFNlbGVjdGVkRmllbGRBdEN1cnNvcih0aGlzLmNvbnRlbnREZXNjcmlwdGlvbiwgc2VsZWN0ZWRGaWVsZE5hbWUpO1xuICAgICAgICAgICAgdGhpcy5jb250ZW50RGVzY3JpcHRpb24uc2V0Rm9jdXMoKTtcbiAgICAgICAgICAgIHRoaXMuYXR0YWNobWVudENvbnRlbnQuZGVzY3JpcHRpb24gPSB0aGlzLmNvbnRlbnREZXNjcmlwdGlvbi52YWx1ZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgICAgIHRoaXMucmVSZW5kZXIgPSAhdGhpcy5yZVJlbmRlcjtcbiAgICB9XG4gICAgLy8gcmVuZG9yIG1ldGhvZHNcbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGNvbnN0IGF0dGFjaG1lbnREaXNwbGF5VHlwZSA9IChoKFwiY2FsY2l0ZS1sYWJlbFwiLCBudWxsLCB0aGlzLnN0cmluZ3MuZGlzcGxheUF0dGFjaG1lbnRzQXMsIGgoXCJjYWxjaXRlLXNlZ21lbnRlZC1jb250cm9sXCIsIHsgd2lkdGg6IFwiZnVsbFwiLCBzY2FsZTogXCJzXCIsIGRpc2FibGVkOiAhdGhpcy5sYXllclN1cHBvcnRzUmVzaXplQXR0YWNobWVudHMsIG9uQ2FsY2l0ZVNlZ21lbnRlZENvbnRyb2xDaGFuZ2U6IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IG5vZGUgPSBldmVudC50YXJnZXQ7XG4gICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRJdGVtID0gbm9kZS5zZWxlY3RlZEl0ZW07XG4gICAgICAgICAgICAgICAgdGhpcy5hdHRhY2htZW50Q29udGVudC5kaXNwbGF5VHlwZSA9IHNlbGVjdGVkSXRlbS52YWx1ZTtcbiAgICAgICAgICAgICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgICAgICAgICB9IH0sIGgoXCJjYWxjaXRlLXNlZ21lbnRlZC1jb250cm9sLWl0ZW1cIiwgeyB2YWx1ZTogQXR0YWNobWVudERpc3BsYXlUeXBlLmF1dG8sIGljb25TdGFydDogXCJjaGVja1wiLCBjaGVja2VkOiB0aGlzLmF0dGFjaG1lbnRDb250ZW50LmRpc3BsYXlUeXBlID09PSBBdHRhY2htZW50RGlzcGxheVR5cGUuYXV0byB9LCB0aGlzLnN0cmluZ3MuYXV0byksIGgoXCJjYWxjaXRlLXNlZ21lbnRlZC1jb250cm9sLWl0ZW1cIiwgeyB2YWx1ZTogQXR0YWNobWVudERpc3BsYXlUeXBlLmxpc3QsIGljb25TdGFydDogXCJsaXN0XCIsIGNoZWNrZWQ6IHRoaXMuYXR0YWNobWVudENvbnRlbnQuZGlzcGxheVR5cGUgPT09IEF0dGFjaG1lbnREaXNwbGF5VHlwZS5saXN0IH0sIHRoaXMuc3RyaW5ncy5saXN0KSwgaChcImNhbGNpdGUtc2VnbWVudGVkLWNvbnRyb2wtaXRlbVwiLCB7IHZhbHVlOiBBdHRhY2htZW50RGlzcGxheVR5cGUucHJldmlldywgaWNvblN0YXJ0OiBcImltYWdlXCIsIGNoZWNrZWQ6IHRoaXMuYXR0YWNobWVudENvbnRlbnQuZGlzcGxheVR5cGUgPT09IEF0dGFjaG1lbnREaXNwbGF5VHlwZS5wcmV2aWV3IH0sIHRoaXMuc3RyaW5ncy5nYWxsZXJ5KSksIGgoXCJjYWxjaXRlLWxhYmVsXCIsIHsgc2NhbGU6IFwic1wiIH0sICgoKSA9PiB7XG4gICAgICAgICAgICBzd2l0Y2ggKHRoaXMuYXR0YWNobWVudENvbnRlbnQuZGlzcGxheVR5cGUpIHtcbiAgICAgICAgICAgICAgICBjYXNlIEF0dGFjaG1lbnREaXNwbGF5VHlwZS5hdXRvOlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLmF1dG9EaXNwbGF5TWVzc2FnZTtcbiAgICAgICAgICAgICAgICBjYXNlIEF0dGFjaG1lbnREaXNwbGF5VHlwZS5saXN0OlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLmxpc3REaXNwbGF5TWVzc2FnZTtcbiAgICAgICAgICAgICAgICBjYXNlIEF0dGFjaG1lbnREaXNwbGF5VHlwZS5wcmV2aWV3OlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLnByZXZpZXdEaXNwbGF5TWVzc2FnZTtcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLmxpc3REaXNwbGF5TWVzc2FnZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSkoKSkpKTtcbiAgICAgICAgY29uc3QgbGlzdFdhcm5pbmdNZXNzYWdlID0gKGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDUubGlzdFdhcm5pbmdEaXYgfSwgaChcImxhYmVsXCIsIHsgY2xhc3M6IENTUyQ1Lmxpc3RXYXJuaW5nTGFiZWwgfSwgaChcInNwYW5cIiwgeyBjbGFzczogQ1NTJDUubGlzdFdhcm5pbmdJY29uIH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBzY2FsZTogXCJzXCIsIGljb246IFwiZXhjbGFtYXRpb24tbWFyay10cmlhbmdsZVwiIH0pKSwgaChcInNwYW5cIiwgeyBjbGFzczogQ1NTJDUubGlzdFdhcm5pbmdUZXh0IH0sIHRoaXMuc3RyaW5ncy5sYXllck9ubHlTdXBwb3J0c0xpc3RWaWV3KSkpKTtcbiAgICAgICAgcmV0dXJuIChoKEhvc3QsIG51bGwsIGgoXCJjYWxjaXRlLWJsb2NrXCIsIHsgZGlyOiBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpLCBoZWFkaW5nOiB0aGlzLnN0cmluZ3MuYXR0YWNobWVudHMsIGRlc2NyaXB0aW9uOiAodGhpcy5hdHRhY2htZW50Q29udGVudC50aXRsZSAmJlxuICAgICAgICAgICAgICAgIGAke3RoaXMuYXR0YWNobWVudENvbnRlbnQudGl0bGUuc3Vic3RyaW5nKDAsIDI1KX0ke3RoaXMuYXR0YWNobWVudENvbnRlbnQudGl0bGUubGVuZ3RoID4gMjUgPyBcIi4uLlwiIDogXCJcIn1gKSB8fFxuICAgICAgICAgICAgICAgICgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHN3aXRjaCAodGhpcy5hdHRhY2htZW50Q29udGVudC5kaXNwbGF5VHlwZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBBdHRhY2htZW50RGlzcGxheVR5cGUuYXV0bzpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLmF1dG87XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIEF0dGFjaG1lbnREaXNwbGF5VHlwZS5saXN0OlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnN0cmluZ3MubGlzdDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgQXR0YWNobWVudERpc3BsYXlUeXBlLnByZXZpZXc6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RyaW5ncy5nYWxsZXJ5O1xuICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLmxpc3Q7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KSgpLCBjb2xsYXBzaWJsZTogdHJ1ZSwgb3BlbjogdGhpcy5ibG9ja09wZW4sIGRyYWdIYW5kbGU6IHRydWUgfSwgaChcImRpdlwiLCB7IGNsYXNzOiBcImlnbm9yZS1lbGVtZW50cy1zb3J0YWJsZVwiLCBzbG90OiBcImNvbnRyb2xcIiB9LCBoKFwiYXJjZ2lzLWNhbGNpdGUtYmxvY2stb3B0aW9uc1wiLCB7IHJlZjogKGVsKSA9PiAodGhpcy5ibG9ja09wdGlvbnMgPSBlbCksIGd1aWQ6IHRoaXMuZ3VpZCwgaW50bE9wdGlvbnM6IHRoaXMuc3RyaW5ncy5vcHRpb25zLCBpbnRsRGVsZXRlOiB0aGlzLnN0cmluZ3MuZGVsZXRlLCBjYWxjaXRlQmxvY2tPcHRpb25zOiB7IGhhc0RlbGV0ZTogdHJ1ZSB9IH0pKSwgaChcImRpdlwiLCB7IHNsb3Q6IFwiaWNvblwiIH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBzY2FsZTogXCJtXCIsIGljb246IFwiYXR0YWNobWVudFwiIH0pKSwgaChcImRpdlwiLCB7IGNsYXNzOiBcImlnbm9yZS1lbGVtZW50cy1zb3J0YWJsZVwiIH0sIHRoaXMuZm9ybUlucHV0KFwidGl0bGVcIiwgdGhpcy5zdHJpbmdzLnRpdGxlLCAoZWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuICh0aGlzLmNvbnRlbnRUaXRsZSA9IGVsZW1lbnQpO1xuICAgICAgICB9LCB0aGlzLmF0dGFjaG1lbnRDb250ZW50LnRpdGxlLCB0aGlzLnN0cmluZ3MuZW50ZXJUaXRsZVxuICAgICAgICAvLyB0aGlzLnN0cmluZ3MudGl0bGVDb250ZXh0LnJlcGxhY2UoXCIke3RpdGxlQ29udGV4dH1cIiwgdGhpcy5zdHJpbmdzLmF0dGFjaG1lbnRzX0wpXG4gICAgICAgICksIHRoaXMuZm9ybUlucHV0KFwiZGVzY3JpcHRpb25cIiwgdGhpcy5zdHJpbmdzLmRlc2MsIChlbGVtZW50KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gKHRoaXMuY29udGVudERlc2NyaXB0aW9uID0gZWxlbWVudCk7XG4gICAgICAgIH0sIHRoaXMuYXR0YWNobWVudENvbnRlbnQuZGVzY3JpcHRpb24sIHRoaXMuc3RyaW5ncy5lbnRlckRlc2NyaXB0aW9uXG4gICAgICAgIC8vIHRoaXMuc3RyaW5ncy5kZXNjcmlwdGlvbkNvbnRleHQucmVwbGFjZShcbiAgICAgICAgLy8gICBcIiR7ZGVzY3JpcHRpb25Db250ZXh0fVwiLFxuICAgICAgICAvLyAgIHRoaXMuc3RyaW5ncy5hdHRhY2htZW50c19MXG4gICAgICAgIC8vIClcbiAgICAgICAgKSwgYXR0YWNobWVudERpc3BsYXlUeXBlLCB0aGlzLmxheWVyU3VwcG9ydHNSZXNpemVBdHRhY2htZW50cyA/IG51bGwgOiBsaXN0V2FybmluZ01lc3NhZ2UpKSkpO1xuICAgIH1cbiAgICBnZXQgaG9zdEVsZW1lbnQoKSB7IHJldHVybiBnZXRFbGVtZW50KHRoaXMpOyB9XG59O1xuQXJjZ2lzUG9wdXBBdHRhY2htZW50cy5zdHlsZSA9IGFyY2dpc1BvcHVwQXR0YWNobWVudHNDc3M7XG5cbmNvbnN0IENTUyQ0ID0ge1xuICAgIG1hbmFnZUJ0bjogXCJtYW5hZ2UtYnRuXCIsXG4gICAgZm9ybUlucHV0QnV0dG9uOiBcImZvcm0taW5wdXQtYnV0dG9uXCJcbn07XG5cbmNvbnN0IGFyY2dpc1BvcHVwQXR0cmlidXRlc0NzcyA9IFwiLm1hbmFnZS1idG57anVzdGlmeS1jb250ZW50OmZsZXgtZW5kO21hcmdpbjo0cHggMH0uZm9ybS1pbnB1dC1idXR0b257ZGlzcGxheTpmbGV4fS5mb3JtLWlucHV0LWJ1dHRvbiBjYWxjaXRlLWlucHV0W3R5cGU9dGV4dF17ZGlzcGxheTpmbGV4O2ZsZXgtZmxvdzpjb2x1bW4gbm93cmFwO2ZsZXg6MSAwIDAlO292ZXJmbG93OmhpZGRlbn0uZm9ybS1pbnB1dC1idXR0b24gY2FsY2l0ZS1hY3Rpb257bWFyZ2luOjA7ZmxleDowIDAgMCU7anVzdGlmeS1zZWxmOmZsZXgtZW5kfVwiO1xuXG5jb25zdCBBcmNnaXNQb3B1cEF0dHJpYnV0ZXMgPSBjbGFzcyB7XG4gICAgY29uc3RydWN0b3IoaG9zdFJlZikge1xuICAgICAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycyA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiY2xvc2VQb3B1cFBvcG92ZXJzXCIsIDcpO1xuICAgICAgICB0aGlzLmludGVybmFsUG9wdXBVcGRhdGVkID0gY3JlYXRlRXZlbnQodGhpcywgXCJpbnRlcm5hbFBvcHVwVXBkYXRlZFwiLCA3KTtcbiAgICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbCA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiZGlzYWJsZVBvcHVwUGFuZWxcIiwgNyk7XG4gICAgICAgIHRoaXMucGlja0xpc3QgPSBbXTtcbiAgICAgICAgdGhpcy5hcmNhZGVFeHBNYXAgPSBuZXcgTWFwKCk7XG4gICAgICAgIC8vIG9wZW4gcG9wb3ZlclxuICAgICAgICB0aGlzLm1hbmFnZUJ0bkNsaWNrID0gKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIC8vIGNsb3NlIGZpcnN0IHNpbmNlIHdlIGNhbiBoYXZlIG11bHRpcGxlIGF0dHJpYnV0ZXMgb3BlblxuICAgICAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgICAgICAgICAgLy8gbGF6eSBsb2FkIGF0dHJpYnV0ZSBtYW5hZ2VyIGNvbXBvbmVudFxuICAgICAgICAgICAgaWYgKCF0aGlzLnBvcHVwRmllbGRNYW5hZ2VQaWNrTGlzdCkge1xuICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1wb3B1cC1maWVsZC1waWNrLWxpc3RcIik7XG4gICAgICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3QucG9wb3ZlclByb3BzID0ge1xuICAgICAgICAgICAgICAgICAgICByZWZFbGVtZW50OiB0aGlzLnBvcHVwRmxvd0l0ZW1cbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0LnNlbGVjdGVkRmllbGRzID0gdGhpcy5nZXRTZWxlY3RlZEZpZWxkcygpO1xuICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0LnNob3dDYW5jZWwgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRNYW5hZ2VQaWNrTGlzdC5tdWx0aXBsZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3QuaGVhZGluZyA9IHRoaXMuc3RyaW5ncy5zZWxlY3RGaWVsZHM7XG4gICAgICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3Qub2tCdG5UZXh0ID0gdGhpcy5zdHJpbmdzLmRvbmU7XG4gICAgICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3QuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc1BvcHVwUGlja0xpc3REaXNtaXNzZWRcIiwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3QuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc1BvcHVwUGlja0xpc3RDaGFuZ2VcIiwgdGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3RDaGFuZ2VzKTtcbiAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0KTtcbiAgICAgICAgICAgICAgICB0aGlzLmRpc2FibGVQb3B1cFBhbmVsLmVtaXQodHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0Q2hhbmdlcyA9IChldmVudCkgPT4ge1xuICAgICAgICAgICAgdmFyIF9hO1xuICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICBjb25zdCBzZWxlY3RlZEZpZWxkID0gKF9hID0gZXZlbnQuZGV0YWlsKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2VsZWN0ZWRGaWVsZHM7XG4gICAgICAgICAgICBjb25zdCBmaWVsZEluZm9zID0gW107XG4gICAgICAgICAgICB0aGlzLnNldHVwRmllbGRNYXBJbmZvKCk7XG4gICAgICAgICAgICBzZWxlY3RlZEZpZWxkLmZvckVhY2goKGZpZWxkTmFtZSkgPT4ge1xuICAgICAgICAgICAgICAgIHZhciBfYTtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5maWVsZEluZm9NYXAuaGFzKGZpZWxkTmFtZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGVtcEZpZWxkID0gKF9hID0gdGhpcy5maWVsZEluZm9NYXAuZ2V0KGZpZWxkTmFtZSkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5jbG9uZSgpO1xuICAgICAgICAgICAgICAgICAgICB0ZW1wRmllbGQudmlzaWJsZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGZpZWxkSW5mb3MucHVzaCh0ZW1wRmllbGQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGhpcy5wb3B1cENvbnRlbnQuZmllbGRJbmZvcyA9IFsuLi5maWVsZEluZm9zXTtcbiAgICAgICAgICAgIHRoaXMucmVSZW5kZXIgPSAhdGhpcy5yZVJlbmRlcjtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5jYWxjaXRlUGlja0xpc3QgPSAoZmllbGQpID0+IChcbiAgICAgICAgLy8gZmllbGQuZmllbGROYW1lIGlzIGFsd2F5cyB1bmlxdWVcbiAgICAgICAgaChcImNhbGNpdGUtdmFsdWUtbGlzdC1pdGVtXCIsIHsga2V5OiBmaWVsZC5maWVsZE5hbWUsIGxhYmVsOiBnZXRGaWVsZERpc3BsYXlOYW1lKGZpZWxkLCB0aGlzLmFyY2FkZUV4cE1hcCksIHZhbHVlOiBmaWVsZC5maWVsZE5hbWUgfSwgaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgc2xvdDogXCJhY3Rpb25zLWVuZFwiLCBhcHBlYXJhbmNlOiBcInRyYW5zcGFyZW50XCIsIHRleHQ6IHRoaXMuc3RyaW5ncy5yZW1vdmUsIG9uQ2xpY2s6ICgpID0+IHRoaXMucmVtb3ZlQnRuQ2xpY2soZmllbGQuZmllbGROYW1lKSB9LCBoKFwiY2FsY2l0ZS1pY29uXCIsIHsgc2NhbGU6IFwic1wiLCBpY29uOiBcInhcIiB9KSkpKTtcbiAgICAgICAgdGhpcy5mb3JtSW5wdXQgPSAoZm9ybVR5cGUsIGZvcm1TdHJpbmcsIGZvcm1JbnB1dEVsZW1lbnQsIGZvcm1WYWx1ZSwgZm9ybVBsYWNlaG9sZGVyXG4gICAgICAgIC8vIHByb21wdE1lc3NhZ2U6IHN0cmluZ1xuICAgICAgICApID0+IHtcbiAgICAgICAgICAgIHZhciBfYTtcbiAgICAgICAgICAgIHJldHVybiAoaChcImNhbGNpdGUtbGFiZWxcIiwgeyBzY2FsZTogXCJzXCIgfSwgZm9ybVN0cmluZywgaChcImRpdlwiLCB7IGNsYXNzOiBDU1MkNC5mb3JtSW5wdXRCdXR0b24gfSwgaChcImNhbGNpdGUtaW5wdXRcIiwgeyB0eXBlOiBcInRleHRcIiwgYXV0b2ZvY3VzOiB0cnVlLCByZWY6IGZvcm1JbnB1dEVsZW1lbnQsIHZhbHVlOiBmb3JtVmFsdWUsIHBsYWNlaG9sZGVyOiBmb3JtUGxhY2Vob2xkZXIsIG9uQ2FsY2l0ZUlucHV0SW5wdXQ6IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5wdXRWYWwgPSBldmVudC50YXJnZXQudmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIGlmIChmb3JtVHlwZSA9PT0gXCJ0aXRsZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvcHVwQ29udGVudC50aXRsZSA9IGlucHV0VmFsO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3B1cENvbnRlbnQuZGVzY3JpcHRpb24gPSBpbnB1dFZhbDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgICAgICAgICAgICAgfSwgb25DbGljazogKCkgPT4gdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpIH0pLCAoKF9hID0gdGhpcy5wb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpID4gMCAmJiAoaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgdGV4dDogdGhpcy5zdHJpbmdzLmF0dHJpYnV0ZXMsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtcG9wdXAtZmllbGQtcGljay1saXN0XCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QucG9wb3ZlclByb3BzID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZkVsZW1lbnQ6IHRoaXMucG9wdXBGbG93SXRlbSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvZmZzZXRTa2lkZGluZzogNTBcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5tdWx0aXBsZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QuaGVhZGluZyA9IHRoaXMuc3RyaW5ncy5hZGRGaWVsZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0LmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNQb3B1cFBpY2tMaXN0RGlzbWlzc2VkXCIsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0LmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNQb3B1cFBpY2tMaXN0Q2hhbmdlXCIsIChldmVudCkgPT4gdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3RDaGFuZ2VzKGV2ZW50LCBmb3JtVHlwZSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc2FibGVQb3B1cFBhbmVsLmVtaXQodHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LCBzY2FsZTogXCJzXCIsIGljb246IFwiYnJhY2tldHMtY3VybHlcIiB9KSkpKSk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuZ3VpZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5wb3B1cENvbnRlbnQgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuYmxvY2tPcGVuID0gZmFsc2U7XG4gICAgICAgIHRoaXMucG9wdXBGbG93SXRlbSA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5yZVJlbmRlciA9IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgLy8gbGlmZWN5Y2xlIG1ldGhvZHNcbiAgICBhc3luYyBjb21wb25lbnRXaWxsTG9hZCgpIHtcbiAgICAgICAgdGhpcy5sYXllciA9IHBvcHVwU3RhdGUubGF5ZXI7XG4gICAgICAgIHRoaXMuc3RyaW5ncyA9IHBvcHVwU3RhdGUuc3RyaW5ncztcbiAgICAgICAgdGhpcy5wb3B1cFRlbXBsYXRlID0gcG9wdXBTdGF0ZS5wb3B1cFRlbXBsYXRlO1xuICAgICAgICB0aGlzLmxheWVyRGlzcGxheVR5cGUgPSBwb3B1cFN0YXRlLmxheWVyRGlzcGxheVR5cGU7XG4gICAgICAgIGlmICghdGhpcy5wb3B1cENvbnRlbnQuZmllbGRJbmZvcykge1xuICAgICAgICAgICAgdGhpcy5wb3B1cENvbnRlbnQuZmllbGRJbmZvcyA9IGF3YWl0IHRoaXMuZ2V0RmllbGRzQ29udGVudCgpO1xuICAgICAgICB9XG4gICAgICAgIGlmICghdGhpcy5wb3B1cENvbnRlbnQudGl0bGUpIHtcbiAgICAgICAgICAgIHRoaXMucG9wdXBDb250ZW50LnRpdGxlID0gXCJcIjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMucG9wdXBDb250ZW50LmRlc2NyaXB0aW9uKSB7XG4gICAgICAgICAgICB0aGlzLnBvcHVwQ29udGVudC5kZXNjcmlwdGlvbiA9IFwiXCI7XG4gICAgICAgIH1cbiAgICB9XG4gICAgY29tcG9uZW50RGlkTG9hZCgpIHtcbiAgICAgICAgaWYgKHRoaXMuYmxvY2tPcGVuKSB7XG4gICAgICAgICAgICB0aGlzLmJsb2NrT3B0aW9ucy5zY3JvbGxJbnRvVmlldyh7IGJlaGF2aW9yOiBcInNtb290aFwiLCBibG9jazogXCJuZWFyZXN0XCIsIGlubGluZTogXCJzdGFydFwiIH0pO1xuICAgICAgICAgICAgdGhpcy5ibG9ja09wdGlvbnMuc2V0Rm9jdXMoKTtcbiAgICAgICAgICAgIHRoaXMuaW50ZXJuYWxQb3B1cFVwZGF0ZWQuZW1pdCgpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNvbXBvbmVudFdpbGxSZW5kZXIoKSB7XG4gICAgICAgIHRoaXMuYXJjYWRlRXhwTWFwID0gZ2VuZXJhdGVBcmNhZGVFeHByZXNzaW9uTWFwKHRoaXMucG9wdXBUZW1wbGF0ZSk7XG4gICAgICAgIHRoaXMuc2V0dXBGaWVsZE1hcEluZm8oKTtcbiAgICAgICAgdGhpcy5waWNrTGlzdCA9IFtdO1xuICAgICAgICB0aGlzLnBvcHVwQ29udGVudC5maWVsZEluZm9zLmZvckVhY2goKGZpZWxkKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnBpY2tMaXN0LnB1c2godGhpcy5jYWxjaXRlUGlja0xpc3QoZmllbGQpKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGNvbXBvbmVudERpZFVwZGF0ZSgpIHtcbiAgICAgICAgdGhpcy5pbnRlcm5hbFBvcHVwVXBkYXRlZC5lbWl0KCk7XG4gICAgfVxuICAgIGRpc2Nvbm5lY3RlZENhbGxiYWNrKCkge1xuICAgICAgICBpZiAodGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3QpIHtcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3QpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCkge1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLy8gRXZlbnRzXG4gICAgLy8gZm9yIGFyY2FkZSBjaGFuZ2VzXG4gICAgYXJjYWRlQ2hhbmdlTm90aWZpY2F0aW9uSGFuZGxlcigpIHtcbiAgICAgICAgdGhpcy5yZVJlbmRlciA9IHRoaXMucmVSZW5kZXIgPyBmYWxzZSA6IHRydWU7XG4gICAgfVxuICAgIC8vIGZvciBhdHRyaWJ1dGUgY2hhbmdlc1xuICAgIGFzeW5jIGF0dHJpYnV0ZXNDaGFuZ2VOb3RpZmljYXRpb25IYW5kbGVyKCkge1xuICAgICAgICAvLyB1cGRhdGUgZmllbGQgaW5mb3NcbiAgICAgICAgdGhpcy5wb3B1cENvbnRlbnQuZmllbGRJbmZvcy5mb3JFYWNoKChmaWVsZCwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkSW5mb01hcC5oYXMoZmllbGQuZmllbGROYW1lKSkge1xuICAgICAgICAgICAgICAgIHRoaXMucG9wdXBDb250ZW50LmZpZWxkSW5mb3NbaW5kZXhdID0gdGhpcy5maWVsZEluZm9NYXAuZ2V0KGZpZWxkLmZpZWxkTmFtZSkuY2xvbmUoKTtcbiAgICAgICAgICAgICAgICB0aGlzLnBvcHVwQ29udGVudC5maWVsZEluZm9zW2luZGV4XS52aXNpYmxlID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMucmVSZW5kZXIgPSAhdGhpcy5yZVJlbmRlcjtcbiAgICB9XG4gICAgY2xvc2VQb3B1cFBvcG92ZXJzSGFuZGxlcigpIHtcbiAgICAgICAgaWYgKHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0KSB7XG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0KTtcbiAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0ID0gbnVsbDtcbiAgICAgICAgICAgIHRoaXMuYmxvY2tPcHRpb25zLnNldEZvY3VzKCk7XG4gICAgICAgICAgICB0aGlzLmRpc2FibGVQb3B1cFBhbmVsLmVtaXQoZmFsc2UpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCkge1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCk7XG4gICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCA9IG51bGw7XG4gICAgICAgICAgICB0aGlzLmRpc2FibGVQb3B1cFBhbmVsLmVtaXQoZmFsc2UpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNhbGNpdGVCbG9ja1RvZ2dsZUhhbmRsZXIoKSB7XG4gICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICB9XG4gICAgY2FsY2l0ZUxpc3RPcmRlckNoYW5nZUhhbmRsZXIoZXZlbnQpIHtcbiAgICAgICAgY29uc3QgdGVtcEZpZWxkcyA9IGV2ZW50LmRldGFpbDtcbiAgICAgICAgY29uc3QgdGVtcEZpZWxkSW5mb3MgPSBbXTtcbiAgICAgICAgdGVtcEZpZWxkcy5mb3JFYWNoKChmaWVsZE5hbWUpID0+IHtcbiAgICAgICAgICAgIHRoaXMucG9wdXBDb250ZW50LmZpZWxkSW5mb3MuZmluZCgoZmllbGQpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZmllbGQuZmllbGROYW1lID09PSBmaWVsZE5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRlbXBGaWVsZEluZm9zLnB1c2goZmllbGQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5wb3B1cENvbnRlbnQuZmllbGRJbmZvcyA9IHRlbXBGaWVsZEluZm9zO1xuICAgICAgICB0aGlzLmludGVybmFsUG9wdXBVcGRhdGVkLmVtaXQoKTtcbiAgICB9XG4gICAgLy8gcHJpdmF0ZSBtZXRob2RzIGFuZCBwcm9wZXJ0aWVzXG4gICAgYXN5bmMgZ2V0RmllbGRzQ29udGVudCgpIHtcbiAgICAgICAgdmFyIF9hLCBfYjtcbiAgICAgICAgbGV0IGZpZWxkSW5mb3MgPSBbXTtcbiAgICAgICAgaWYgKHRoaXMuY2hlY2tGb3JDcmVhdGVGaWVsZHNDb250ZW50KCkpIHtcbiAgICAgICAgICAgIGNvbnN0IFtwb3B1cFV0aWxzXSA9IGF3YWl0IGxvYWRNb2R1bGVzKFtcImVzcmkvc3VwcG9ydC9wb3B1cFV0aWxzXCJdKTtcbiAgICAgICAgICAgIC8vIGdldCBkZWZhdWx0IGZyb20gY3JlYXRlRmllbGRzQ29udGVudFxuICAgICAgICAgICAgY29uc3QgcG9wdXBVdGlsc0ZpZWxkSW5mbyA9IChfYiA9IHBvcHVwVXRpbHMuY3JlYXRlRmllbGRzQ29udGVudCh7XG4gICAgICAgICAgICAgICAgZmllbGRzOiBhd2FpdCBnZXRGaWVsZHNGcm9tTGF5ZXIodGhpcy5sYXllciksXG4gICAgICAgICAgICAgICAgb2JqZWN0SWRGaWVsZDogdGhpcy5sYXllci5vYmplY3RJZEZpZWxkLFxuICAgICAgICAgICAgICAgIGVkaXRGaWVsZHNJbmZvOiAoKF9hID0gdGhpcy5sYXllcikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmVkaXRGaWVsZHNJbmZvKSB8fCBudWxsXG4gICAgICAgICAgICB9KSkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmZpZWxkSW5mb3M7XG4gICAgICAgICAgICAvLyBwb3B1cFV0aWxzRmllbGRJbmZvIHNob3VsZCBoYXZlIGEgc3Vic2V0IG9mIGZpZWxkSW5mb01hcFxuICAgICAgICAgICAgLy8gYnV0IHdpdGggZGlmZmVyZW5jZXMgaW4gZm9ybWF0IGFuZCB2aXNpYmlsaXR5XG4gICAgICAgICAgICAhdGhpcy5maWVsZEluZm9NYXAgJiYgdGhpcy5zZXR1cEZpZWxkTWFwSW5mbygpO1xuICAgICAgICAgICAgcG9wdXBVdGlsc0ZpZWxkSW5mby5mb3JFYWNoKChmaWVsZEluZm8pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5maWVsZEluZm9NYXAuaGFzKGZpZWxkSW5mby5maWVsZE5hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRlbXBGaWVsZEluZm8gPSB0aGlzLmZpZWxkSW5mb01hcC5nZXQoZmllbGRJbmZvLmZpZWxkTmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIGZpZWxkSW5mb3MucHVzaCh0ZW1wRmllbGRJbmZvLmNsb25lKCkpO1xuICAgICAgICAgICAgICAgICAgICBmaWVsZEluZm9zW2ZpZWxkSW5mb3MubGVuZ3RoIC0gMV0udmlzaWJsZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAvLyBhZGQgZXhwcmVzc2lvbnMgYW5kIHJlbGF0aW9uc2hpcCBmaWVsZHMgaXMgdmlzaWJsZSA9IHRydWVcbiAgICAgICAgICAgIHRoaXMucG9wdXBUZW1wbGF0ZS5maWVsZEluZm9zLmZvckVhY2goKGZpZWxkSW5mbykgPT4ge1xuICAgICAgICAgICAgICAgIGlmICgoZmllbGRJbmZvLmZpZWxkTmFtZS5pbmNsdWRlcyhmaWVsZEluZm9QcmVmaXhFbnVtLmV4cHJlc3Npb24pIHx8XG4gICAgICAgICAgICAgICAgICAgIGZpZWxkSW5mby5maWVsZE5hbWUuaW5jbHVkZXMoZmllbGRJbmZvUHJlZml4RW51bS5yZWxhdGlvbnNoaXApKSAmJlxuICAgICAgICAgICAgICAgICAgICBmaWVsZEluZm8udmlzaWJsZSkge1xuICAgICAgICAgICAgICAgICAgICBmaWVsZEluZm9zLnB1c2goZmllbGRJbmZvLmNsb25lKCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgLy8gZmVhdHVyZSByZWR1Y3Rpb24sIDN4IGFuZCBkZWZhdWx0IGNhc2VcbiAgICAgICAgICAgIHRoaXMucG9wdXBUZW1wbGF0ZS5maWVsZEluZm9zLmZvckVhY2goKGZpZWxkSW5mbykgPT4ge1xuICAgICAgICAgICAgICAgIGZpZWxkSW5mby52aXNpYmxlICYmIGZpZWxkSW5mb3MucHVzaChmaWVsZEluZm8uY2xvbmUoKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmllbGRJbmZvcztcbiAgICB9XG4gICAgY2hlY2tGb3JDcmVhdGVGaWVsZHNDb250ZW50KCkge1xuICAgICAgICB2YXIgX2EsIF9iLCBfYztcbiAgICAgICAgLy8gcmVndWxhciBmZWF0dXJlIG9yIGZlYXR1cmUgcmVkdWN0aW9uXG4gICAgICAgIGlmICh0aGlzLmxheWVyRGlzcGxheVR5cGUgPT09IGxheWVyRGlzcGxheVR5cGVFbnVtLmZlYXR1cmUpIHtcbiAgICAgICAgICAgIC8vIGNoZWNrIDFzdCBjb250ZW50IGZvciAzeCBhbmQgZGVmYXVsdCB1c2UgY2FzZVxuICAgICAgICAgICAgaWYgKCgoX2IgPSAoX2EgPSB0aGlzLnBvcHVwVGVtcGxhdGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5jb250ZW50WzBdKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IudHlwZSkgPT09IFwiZmllbGRzXCIpIHtcbiAgICAgICAgICAgICAgICBpZiAoKF9jID0gdGhpcy5wb3B1cFRlbXBsYXRlLmNvbnRlbnRbMF0pID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5maWVsZEluZm9zKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIHVzZSBjcmVhdGVGaWVsZHNDb250ZW50XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gRGVmYXVsdCBvciBjb21pbmcgZnJvbSAzeC5cbiAgICAgICAgICAgICAgICAgICAgLy8gRG9udCB1c2UgY3JlYXRlRmllbGRzQ29udGVudCwgYnV0IGRlcGVuZCBvbiBmaWVsZEluZm9zXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyAxc3QgZWxlbWVudCBpcyBub3QgZmllbGQsIHVzZSBjcmVhdGVGaWVsZHNDb250ZW50XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAvLyBmZWF0dXJlIHJlZHVjdGlvblxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJlbW92ZUJ0bkNsaWNrKGZpZWxkTmFtZSkge1xuICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgICAgIHRoaXMucG9wdXBDb250ZW50LmZpZWxkSW5mb3MuZmluZCgoZmllbGRJbkNvbnRlbnQsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICBpZiAoZmllbGRJbkNvbnRlbnQuZmllbGROYW1lID09PSBmaWVsZE5hbWUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5wb3B1cENvbnRlbnQuZmllbGRJbmZvcy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgIH1cbiAgICBnZXRTZWxlY3RlZEZpZWxkcygpIHtcbiAgICAgICAgY29uc3Qgc2VsZWN0ZWRGaWVsZHMgPSBbXTtcbiAgICAgICAgdGhpcy5wb3B1cENvbnRlbnQuZmllbGRJbmZvcy5mb3JFYWNoKChmaWVsZCkgPT4ge1xuICAgICAgICAgICAgc2VsZWN0ZWRGaWVsZHMucHVzaChmaWVsZC5maWVsZE5hbWUpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHNlbGVjdGVkRmllbGRzO1xuICAgIH1cbiAgICAvLyBmaWVsZCBzZWxlY3Rpb24gZm9yIHRpdGxlIGFuZCBjYXB0aW9uXG4gICAgcG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0Q2hhbmdlcyhldmVudCwgZm9ybVR5cGUpIHtcbiAgICAgICAgY29uc3Qgc2VsZWN0ZWRGaWVsZE5hbWUgPSBldmVudC5kZXRhaWwuc2VsZWN0ZWRGaWVsZHNbMF07XG4gICAgICAgIGlmIChmb3JtVHlwZSA9PT0gXCJ0aXRsZVwiKSB7XG4gICAgICAgICAgICB0aGlzLmNvbnRlbnRUaXRsZS52YWx1ZSA9IGFkZFNlbGVjdGVkRmllbGRBdEN1cnNvcih0aGlzLmNvbnRlbnRUaXRsZSwgc2VsZWN0ZWRGaWVsZE5hbWUpO1xuICAgICAgICAgICAgdGhpcy5jb250ZW50VGl0bGUuc2V0Rm9jdXMoKTtcbiAgICAgICAgICAgIHRoaXMucG9wdXBDb250ZW50LnRpdGxlID0gdGhpcy5jb250ZW50VGl0bGUudmFsdWU7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoZm9ybVR5cGUgPT09IFwiZGVzY3JpcHRpb25cIikge1xuICAgICAgICAgICAgdGhpcy5jb250ZW50RGVzY3JpcHRpb24udmFsdWUgPSBhZGRTZWxlY3RlZEZpZWxkQXRDdXJzb3IodGhpcy5jb250ZW50RGVzY3JpcHRpb24sIHNlbGVjdGVkRmllbGROYW1lKTtcbiAgICAgICAgICAgIHRoaXMuY29udGVudERlc2NyaXB0aW9uLnNldEZvY3VzKCk7XG4gICAgICAgICAgICB0aGlzLnBvcHVwQ29udGVudC5kZXNjcmlwdGlvbiA9IHRoaXMuY29udGVudERlc2NyaXB0aW9uLnZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgIH1cbiAgICBzZXR1cEZpZWxkTWFwSW5mbygpIHtcbiAgICAgICAgdGhpcy5maWVsZEluZm9NYXAgPSBuZXcgTWFwKHRoaXMucG9wdXBUZW1wbGF0ZS5maWVsZEluZm9zLm1hcCgoZmllbGRJbmZvKSA9PiBbXG4gICAgICAgICAgICBmaWVsZEluZm8uZmllbGROYW1lLFxuICAgICAgICAgICAgZmllbGRJbmZvXG4gICAgICAgIF0pKTtcbiAgICB9XG4gICAgLy8gcmVuZG9yIG1ldGhvZHNcbiAgICByZW5kZXIoKSB7XG4gICAgICAgIHJldHVybiAoaChIb3N0LCBudWxsLCBoKFwiY2FsY2l0ZS1ibG9ja1wiLCB7IGRpcjogZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSwgaGVhZGluZzogdGhpcy5zdHJpbmdzLmZpZWxkc0xpc3QsIGRlc2NyaXB0aW9uOiAodGhpcy5wb3B1cENvbnRlbnQudGl0bGUgJiZcbiAgICAgICAgICAgICAgICBgJHt0aGlzLnBvcHVwQ29udGVudC50aXRsZS5zdWJzdHJpbmcoMCwgMjUpfSR7dGhpcy5wb3B1cENvbnRlbnQudGl0bGUubGVuZ3RoID4gMjUgPyBcIi4uLlwiIDogXCJcIn1gKSB8fFxuICAgICAgICAgICAgICAgIGAke3RoaXMucG9wdXBDb250ZW50LmZpZWxkSW5mb3MubGVuZ3RofS8ke3RoaXMucG9wdXBUZW1wbGF0ZS5maWVsZEluZm9zLmxlbmd0aH0gJHt0aGlzLnN0cmluZ3MuYXR0cmlidXRlc19MfWAsIGNvbGxhcHNpYmxlOiB0cnVlLCBvcGVuOiB0aGlzLmJsb2NrT3BlbiwgZHJhZ0hhbmRsZTogdHJ1ZSB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IFwiaWdub3JlLWVsZW1lbnRzLXNvcnRhYmxlXCIsIHNsb3Q6IFwiY29udHJvbFwiIH0sIGgoXCJhcmNnaXMtY2FsY2l0ZS1ibG9jay1vcHRpb25zXCIsIHsgcmVmOiAoZWwpID0+ICh0aGlzLmJsb2NrT3B0aW9ucyA9IGVsKSwgZ3VpZDogdGhpcy5ndWlkLCBpbnRsT3B0aW9uczogdGhpcy5zdHJpbmdzLm9wdGlvbnMsIGludGxEZWxldGU6IHRoaXMuc3RyaW5ncy5kZWxldGUsIGludGxEdXBsaWNhdGU6IHRoaXMuc3RyaW5ncy5kdXBsaWNhdGUsIGNhbGNpdGVCbG9ja09wdGlvbnM6IHsgaGFzRGVsZXRlOiB0cnVlLCBoYXNEdXBsaWNhdGU6IHRydWUgfSB9KSksIGgoXCJkaXZcIiwgeyBzbG90OiBcImljb25cIiB9LCBoKFwiY2FsY2l0ZS1pY29uXCIsIHsgc2NhbGU6IFwibVwiLCBpY29uOiBcImZlYXR1cmUtZGV0YWlsc1wiIH0pKSwgaChcImRpdlwiLCB7IGNsYXNzOiBcImlnbm9yZS1lbGVtZW50cy1zb3J0YWJsZVwiIH0sIHRoaXMuZm9ybUlucHV0KFwidGl0bGVcIiwgdGhpcy5zdHJpbmdzLnRpdGxlLCAoZWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuICh0aGlzLmNvbnRlbnRUaXRsZSA9IGVsZW1lbnQpO1xuICAgICAgICB9LCB0aGlzLnBvcHVwQ29udGVudC50aXRsZSwgdGhpcy5zdHJpbmdzLmVudGVyVGl0bGVcbiAgICAgICAgLy8gdGhpcy5zdHJpbmdzLnRpdGxlQ29udGV4dC5yZXBsYWNlKFwiJHt0aXRsZUNvbnRleHR9XCIsIHRoaXMuc3RyaW5ncy5hdHRyaWJ1dGVzX0wpXG4gICAgICAgICksIHRoaXMuZm9ybUlucHV0KFwiZGVzY3JpcHRpb25cIiwgdGhpcy5zdHJpbmdzLmRlc2MsIChlbGVtZW50KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gKHRoaXMuY29udGVudERlc2NyaXB0aW9uID0gZWxlbWVudCk7XG4gICAgICAgIH0sIHRoaXMucG9wdXBDb250ZW50LmRlc2NyaXB0aW9uLCB0aGlzLnN0cmluZ3MuZW50ZXJEZXNjcmlwdGlvblxuICAgICAgICAvLyB0aGlzLnN0cmluZ3MuZGVzY3JpcHRpb25Db250ZXh0LnJlcGxhY2UoXG4gICAgICAgIC8vICAgXCIke2Rlc2NyaXB0aW9uQ29udGV4dH1cIixcbiAgICAgICAgLy8gICB0aGlzLnN0cmluZ3MuYXR0cmlidXRlc19MXG4gICAgICAgIC8vIClcbiAgICAgICAgKSwgaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgY2xhc3M6IENTUyQ0Lm1hbmFnZUJ0biwgYXBwZWFyYW5jZTogXCJ0cmFuc3BhcmVudFwiLCBzY2FsZTogXCJtXCIsIHdpZHRoOiBcImZ1bGxcIiwgaWQ6IFwib3Blbk1hbmFnZUF0dHJpYnV0ZXNfSWRcIiwgb25DbGljazogdGhpcy5tYW5hZ2VCdG5DbGljayB9LCB0aGlzLnN0cmluZ3Muc2VsZWN0QXR0cmlidXRlcyksIGgoXCJjYWxjaXRlLXZhbHVlLWxpc3RcIiwgeyBcImRyYWctZW5hYmxlZFwiOiB0cnVlIH0sIHRoaXMucGlja0xpc3QpKSkpKTtcbiAgICB9XG4gICAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcbkFyY2dpc1BvcHVwQXR0cmlidXRlcy5zdHlsZSA9IGFyY2dpc1BvcHVwQXR0cmlidXRlc0NzcztcblxuY29uc3QgQ1NTJDMgPSB7XG4gICAgbWFuYWdlQnRuOiBcIm1hbmFnZS1idG5cIixcbiAgICBlbmFibGVDb2x1bW46IFwiZW5hYmxlLWNvbHVtblwiLFxuICAgIGVuYWJsZUNvbHVtbkxhYmVsOiBcImVuYWJsZS1jb2x1bW4tbGFiZWxcIixcbiAgICBDb2x1bW5Td2l0Y2g6IFwiY29sdW1uLXN3aXRjaFwiLFxuICAgIG5vcm1hbGl6ZUJsb2NrOiBcIm5vcm1hbGl6ZS1ibG9ja1wiLFxuICAgIG5vcm1hbGl6ZUNvbnRlbnRCdXR0b25TZWN0aW9uOiBcIm5vcm1hbGl6ZS1jb250ZW50LWJ0bi1zZWN0aW9uXCIsXG4gICAgbm9ybWFsaXplQ29udGVudEJ1dHRvbjogXCJub3JtYWxpemUtY29udGVudC1idG5cIixcbiAgICBub3JtYWxpemVDb250ZW50QnV0dG9uVGV4dDogXCJub3JtYWxpemUtY29udGVudC1idG4tdGV4dFwiLFxuICAgIG5vcm1hbGl6ZUNvbnRlbnRCdXR0b25JY29uOiBcIm5vcm1hbGl6ZS1jb250ZW50LWJ0bi1pY29uXCIsXG4gICAgcG9wb3ZlckNoYXJ0RGl2OiBcInBvcG92ZXItY2hhcnQtZGl2XCIsXG4gICAgZm9ybUlucHV0QnV0dG9uOiBcImZvcm0taW5wdXQtYnV0dG9uXCIsXG4gICAgY2hhcnRHcm91cDogXCJjaGFydC1ncm91cFwiXG59O1xuXG5jb25zdCBhcmNnaXNQb3B1cENoYXJ0Q3NzID0gXCIubWFuYWdlLWJ0bntqdXN0aWZ5LWNvbnRlbnQ6ZmxleC1lbmR9LmVuYWJsZS1jb2x1bW57YmFja2dyb3VuZC1jb2xvcjp2YXIoLS1hcmNnaXMtYXBwLWJhY2tncm91bmQpO2Rpc3BsYXk6ZmxleDtwYWRkaW5nOnZhcigtLWFyY2dpcy1hcHAtY2FwLXNwYWNpbmctaGFsZikgdmFyKC0tYXJjZ2lzLWFwcC1zaWRlLXNwYWNpbmctcXVhcnRlcil9LmVuYWJsZS1jb2x1bW4tbGFiZWx7ZGlzcGxheTpmbGV4O2ZsZXgtZmxvdzpjb2x1bW4gbm93cmFwO2ZsZXg6MSAwIDAlO292ZXJmbG93OmhpZGRlbn0uY29sdW1uLXN3aXRjaHttYXJnaW46MDtmbGV4OjAgMCAwJTtqdXN0aWZ5LXNlbGY6ZmxleC1lbmR9Lm5vcm1hbGl6ZS1ibG9ja3twYWRkaW5nOjAgdmFyKC0tYXJjZ2lzLWFwcC1zaWRlLXNwYWNpbmctcXVhcnRlcil9Lm5vcm1hbGl6ZS1jb250ZW50LWJ0bi1zZWN0aW9ue2JhY2tncm91bmQtY29sb3I6dmFyKC0tYXJjZ2lzLWFwcC1iYWNrZ3JvdW5kKTttaW4td2lkdGg6MTAwJX0ubm9ybWFsaXplLWNvbnRlbnQtYnRue2JhY2tncm91bmQ6dmFyKC0tYXJjZ2lzLWFwcC1iYWNrZ3JvdW5kLWNsZWFyKTtib3JkZXI6MXB4IHNvbGlkIHZhcigtLWFyY2dpcy1hcHAtYm9yZGVyKTtib3JkZXItcmFkaXVzOnZhcigtLWFyY2dpcy1hcHAtYm9yZGVyLXJhZGl1cyk7ZGlzcGxheTpmbGV4O2FsaWduLWl0ZW1zOmNlbnRlcjtqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjtwYWRkaW5nOnZhcigtLWFyY2dpcy1hcHAtY2FwLXNwYWNpbmctaGFsZikgdmFyKC0tYXJjZ2lzLWFwcC1zaWRlLXNwYWNpbmctcXVhcnRlcik7Y3Vyc29yOnBvaW50ZXI7d2lkdGg6MTAwJTt0ZXh0LWFsaWduOnVuc2V0O3RyYW5zaXRpb246YmFja2dyb3VuZC1jb2xvciB2YXIoLS1hcmNnaXMtYXBwLWFuaW1hdGlvbi10aW1lLWZhc3QpIHZhcigtLWFyY2dpcy1hcHAtZWFzaW5nLWZ1bmN0aW9uKSwgYm9yZGVyLWNvbG9yIHZhcigtLWFyY2dpcy1hcHAtYW5pbWF0aW9uLXRpbWUtZmFzdCkgdmFyKC0tYXJjZ2lzLWFwcC1lYXNpbmctZnVuY3Rpb24pfS5ub3JtYWxpemUtY29udGVudC1idG46aG92ZXJ7YmFja2dyb3VuZC1jb2xvcjp2YXIoLS1hcmNnaXMtYXBwLWJhY2tncm91bmQtaG92ZXIpO2JvcmRlci1jb2xvcjp2YXIoLS1hcmNnaXMtYXBwLWJvcmRlci1ob3Zlcil9Lm5vcm1hbGl6ZS1jb250ZW50LWJ0bi10ZXh0e2ZvbnQtZmFtaWx5OnZhcigtLWFyY2dpcy1hcHAtZm9udC1mYW1pbHkpO2ZvbnQtc2l6ZTp2YXIoLS1hcmNnaXMtYXBwLWZvbnQtc2l6ZS0wKTtmbGV4OjAgMSBhdXRvO292ZXJmbG93OmhpZGRlbjtwYWRkaW5nOjAgdmFyKC0tYXJjZ2lzLWFwcC1zaWRlLXNwYWNpbmctZWlnaHRoKTt0ZXh0LW92ZXJmbG93OmVsbGlwc2lzO3doaXRlLXNwYWNlOm5vd3JhcH0ubm9ybWFsaXplLWNvbnRlbnQtYnRuLWljb257ZmxleDowIDAgMCU7cGFkZGluZzowIHZhcigtLWFyY2dpcy1hcHAtc2lkZS1zcGFjaW5nLWhhbGYpfS5wb3BvdmVyLWNoYXJ0LWRpdntiYWNrZ3JvdW5kLWNvbG9yOnZhcigtLWFyY2dpcy1hcHAtYmFja2dyb3VuZCk7cGFkZGluZzp2YXIoLS1hcmNnaXMtYXBwLWNhcC1zcGFjaW5nKSB2YXIoLS1hcmNnaXMtYXBwLXNpZGUtc3BhY2luZy1oYWxmKTttYXgtaGVpZ2h0OjYwdmh9LmZvcm0taW5wdXQtYnV0dG9ue2Rpc3BsYXk6ZmxleH0uZm9ybS1pbnB1dC1idXR0b24gY2FsY2l0ZS1pbnB1dFt0eXBlPXRleHRde2Rpc3BsYXk6ZmxleDtmbGV4LWZsb3c6Y29sdW1uIG5vd3JhcDtmbGV4OjEgMCAwJTtvdmVyZmxvdzpoaWRkZW59LmZvcm0taW5wdXQtYnV0dG9uIGNhbGNpdGUtYWN0aW9ue21hcmdpbjowO2ZsZXg6MCAwIDAlO2p1c3RpZnktc2VsZjpmbGV4LWVuZH0uY2hhcnQtZ3JvdXB7bWFyZ2luLWJvdHRvbTp2YXIoLS1hcmNnaXMtYXBwLWNhcC1zcGFjaW5nLWhhbGYpfS5jb2xvci1pY29ue3dpZHRoOjE4cHg7aGVpZ2h0OjE4cHg7Ym9yZGVyLXJhZGl1czo5MCV9XCI7XG5cbmNvbnN0IE1BWF9SQU1QX0NPTE9SUyA9IDEwO1xuY29uc3QgQXJjZ2lzUG9wdXBDaGFydCA9IGNsYXNzIHtcbiAgICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgICAgIHJlZ2lzdGVySW5zdGFuY2UodGhpcywgaG9zdFJlZik7XG4gICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzID0gY3JlYXRlRXZlbnQodGhpcywgXCJjbG9zZVBvcHVwUG9wb3ZlcnNcIiwgNyk7XG4gICAgICAgIHRoaXMuY2hhcnRDaGFuZ2VkUmVSZW5kZXIgPSBjcmVhdGVFdmVudCh0aGlzLCBcImNoYXJ0Q2hhbmdlZFJlUmVuZGVyXCIsIDcpO1xuICAgICAgICB0aGlzLm5vdGlmeU11bHRpTWVkaWFDaGFuZ2UgPSBjcmVhdGVFdmVudCh0aGlzLCBcIm5vdGlmeU11bHRpTWVkaWFDaGFuZ2VcIiwgNyk7XG4gICAgICAgIHRoaXMubGFzdENvbG9ycyA9IHt9O1xuICAgICAgICB0aGlzLnBpY2tMaXN0ID0gW107XG4gICAgICAgIHRoaXMuYXJjYWRlRXhwTWFwID0gbmV3IE1hcCgpO1xuICAgICAgICB0aGlzLmNvbG9yTm9kZXMgPSBbXTtcbiAgICAgICAgdGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3RDaGFuZ2VzID0gKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICB2YXIgX2EsIF9iLCBfYywgX2QsIF9lLCBfZiwgX2csIF9oLCBfaiwgX2s7XG4gICAgICAgICAgICBjb25zdCB7IGVzcmlMYW5nLCBlc3JpQ29sb3IsIHJlbmRlcmVyQ29sb3JzIH0gPSB0aGlzO1xuICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICBjb25zdCBvbGRGaWVsZHMgPSB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmZpZWxkcztcbiAgICAgICAgICAgIGNvbnN0IG5ld0ZpZWxkcyA9IGV2ZW50LmRldGFpbC5zZWxlY3RlZEZpZWxkcztcbiAgICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuZmllbGRzID0gbmV3RmllbGRzO1xuICAgICAgICAgICAgaWYgKHRoaXMuY2hhcnRNZWRpYUluZm8udHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5saW5lQ2hhcnQpIHtcbiAgICAgICAgICAgICAgICBpZiAoKChfYSA9IHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuZmllbGRzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKSAmJiAhKChfYiA9IHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuY29sb3JzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IubGVuZ3RoKSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBkZWZhdWx0U2NoZW1lID0gdGhpcy5nZXREZWZhdWx0Q29sb3JTY2hlbWUoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xvcnMgPSBbZGVmYXVsdFNjaGVtZS5jb2xvcnNbMF1dO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmNvbG9ycyA9IGVzcmlMYW5nLmNsb25lKHRoaXMuY29sb3JzKTtcbiAgICAgICAgICAgICAgICAgICAgZm9yY2VVcGRhdGUodGhpcy5ob3N0RWxlbWVudCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKCEoKF9jID0gdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5maWVsZHMpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5sZW5ndGgpICYmXG4gICAgICAgICAgICAgICAgICAgICgoX2QgPSB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmNvbG9ycykgPT09IG51bGwgfHwgX2QgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9kLmxlbmd0aCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xvcnMgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuY29sb3JzID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKChfZSA9IHRoaXMubGFzdENvbG9ycy5yYW1wQ29sb3JzKSA9PT0gbnVsbCB8fCBfZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2UubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlZmF1bHRTY2hlbWUgPSB0aGlzLmdldERlZmF1bHRDb2xvclNjaGVtZSgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxhc3RDb2xvcnMucmFtcENvbG9ycyA9IChfZiA9IHRoaXMuY2hhcnRNZWRpYUluZm8pID09PSBudWxsIHx8IF9mID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZi52YWx1ZS5maWVsZHMubWFwKChmaWVsZCwgaWR4KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2E7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvbGRJZHggPSBvbGRGaWVsZHMuaW5kZXhPZihmaWVsZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKChvbGRJZHggPiAtMSAmJiAoKF9hID0gdGhpcy5sYXN0Q29sb3JzLnJhbXBDb2xvcnMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYVtvbGRJZHhdKSkgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgZXNyaUNvbG9yKGRlZmF1bHRTY2hlbWUuY29sb3JzW2lkeCAlIE1BWF9SQU1QX0NPTE9SU10pIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3IGVzcmlDb2xvcihbMCwgMCwgMCwgMV0pKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKChfZyA9IHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuZmllbGRzKSA9PT0gbnVsbCB8fCBfZyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2cubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlZmF1bHRTY2hlbWUgPSB0aGlzLmdldERlZmF1bHRDb2xvclNjaGVtZSgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbG9ycyA9IChfaCA9IHRoaXMuY2hhcnRNZWRpYUluZm8pID09PSBudWxsIHx8IF9oID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfaC52YWx1ZS5maWVsZHMubWFwKChmaWVsZE5hbWUsIGlkeCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9hO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2xkSWR4ID0gb2xkRmllbGRzLmluZGV4T2YoZmllbGROYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoKG9sZElkeCA+IC0xICYmICgoX2EgPSB0aGlzLmNvbG9ycykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hW29sZElkeF0pKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIChyZW5kZXJlckNvbG9ycy5nZXQoZmllbGROYW1lKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGVzcmlMYW5nLmNsb25lKHJlbmRlcmVyQ29sb3JzLmdldChmaWVsZE5hbWUpWzBdKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG5ldyBlc3JpQ29sb3IoZGVmYXVsdFNjaGVtZS5jb2xvcnNbaWR4ICUgTUFYX1JBTVBfQ09MT1JTXSkgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBlc3JpQ29sb3IoWzAsIDAsIDAsIDFdKSkpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKChfaiA9IHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuY29sb3JzKSA9PT0gbnVsbCB8fCBfaiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2oubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmNvbG9ycyA9IGVzcmlMYW5nLmNsb25lKHRoaXMuY29sb3JzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRvbid0IGF1dG8gc2F2ZSBjb2xvcnMgb24gcmVtb3ZlOyB1cGRhdGUgdG8gbWFrZSBzdXJlIGRlZmF1bHQgY29sb3JzIHN0aWxsIG1hdGNoXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbG9ycyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRDb2xvcnMoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChvbGRGaWVsZHMgPT09IG51bGwgfHwgb2xkRmllbGRzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvbGRGaWVsZHMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbG9yQnV0dG9uTm9kZSAmJiBmb3JjZVVwZGF0ZSh0aGlzLmNvbG9yQnV0dG9uTm9kZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xvcnMgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuY29sb3JzID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmNoYXJ0Q2hhbmdlZFJlUmVuZGVyLmVtaXQoKTtcbiAgICAgICAgICAgIGlmICghKG9sZEZpZWxkcyA9PT0gbnVsbCB8fCBvbGRGaWVsZHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9sZEZpZWxkcy5sZW5ndGgpIHx8ICEoKF9rID0gdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5maWVsZHMpID09PSBudWxsIHx8IF9rID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfay5sZW5ndGgpKSB7XG4gICAgICAgICAgICAgICAgZm9yY2VVcGRhdGUodGhpcy5ob3N0RWxlbWVudCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuZmllbGRQaWNrTGlzdENoYW5nZXMgPSAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgIHZhciBfYSwgX2I7XG4gICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkRmllbGQgPSAoX2IgPSAoX2EgPSBldmVudC5kZXRhaWwpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zZWxlY3RlZEZpZWxkcykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iWzBdO1xuICAgICAgICAgICAgaWYgKHNlbGVjdGVkRmllbGQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLm5vcm1hbGl6ZUZpZWxkID0gc2VsZWN0ZWRGaWVsZDtcbiAgICAgICAgICAgICAgICB0aGlzLmNoYXJ0Q2hhbmdlZFJlUmVuZGVyLmVtaXQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQodGhpcy5ndWlkKTtcbiAgICAgICAgICAgIHRoaXMubm9ybWFsaXplQnRuLmZvY3VzKCk7XG4gICAgICAgIH07XG4gICAgICAgIC8vIGZpZWxkIHNlbGVjdGlvbiBmb3IgdGl0bGUgYW5kIGNhcHRpb25cbiAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3RDaGFuZ2VzID0gKGV2ZW50LCBmb3JtVHlwZSkgPT4ge1xuICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRGaWVsZE5hbWUgPSBldmVudC5kZXRhaWwuc2VsZWN0ZWRGaWVsZHNbMF07XG4gICAgICAgICAgICBpZiAoZm9ybVR5cGUgPT09IFwidGl0bGVcIikge1xuICAgICAgICAgICAgICAgIHRoaXMuZWRpdENoYXJ0VGl0bGUudmFsdWUgPSBhZGRTZWxlY3RlZEZpZWxkQXRDdXJzb3IodGhpcy5lZGl0Q2hhcnRUaXRsZSwgc2VsZWN0ZWRGaWVsZE5hbWUpO1xuICAgICAgICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udGl0bGUgPSB0aGlzLmVkaXRDaGFydFRpdGxlLnZhbHVlO1xuICAgICAgICAgICAgICAgIHRoaXMuZWRpdENoYXJ0VGl0bGUuc2V0Rm9jdXMoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKGZvcm1UeXBlID09PSBcImNhcHRpb25cIikge1xuICAgICAgICAgICAgICAgIHRoaXMuZWRpdENoYXJ0Q2FwdGlvbi52YWx1ZSA9IGFkZFNlbGVjdGVkRmllbGRBdEN1cnNvcih0aGlzLmVkaXRDaGFydENhcHRpb24sIHNlbGVjdGVkRmllbGROYW1lKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLmNhcHRpb24gPSB0aGlzLmVkaXRDaGFydENhcHRpb24udmFsdWU7XG4gICAgICAgICAgICAgICAgdGhpcy5lZGl0Q2hhcnRDYXB0aW9uLnNldEZvY3VzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChmb3JtVHlwZSA9PT0gXCJhbHRUZXh0XCIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmVkaXRBbHRUZXh0LnZhbHVlID0gYWRkU2VsZWN0ZWRGaWVsZEF0Q3Vyc29yKHRoaXMuZWRpdEFsdFRleHQsIHNlbGVjdGVkRmllbGROYW1lKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLmFsdFRleHQgPSB0aGlzLmVkaXRBbHRUZXh0LnZhbHVlO1xuICAgICAgICAgICAgICAgIHRoaXMuZWRpdEFsdFRleHQuc2V0Rm9jdXMoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQodGhpcy5ndWlkKTtcbiAgICAgICAgICAgIHRoaXMuY2hhcnRDaGFuZ2VkUmVSZW5kZXIuZW1pdCgpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLmNoYXJ0Rm9ybUlucHV0ID0gKGNoYXJ0Rm9ybUlucHV0VHlwZSkgPT4ge1xuICAgICAgICAgICAgdmFyIF9hO1xuICAgICAgICAgICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1sYWJlbFwiLCB7IHNjYWxlOiBcInNcIiB9LCAoKCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChjaGFydEZvcm1JbnB1dFR5cGUgPT09IFwidGl0bGVcIikge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLnRpdGxlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmIChjaGFydEZvcm1JbnB1dFR5cGUgPT09IFwiY2FwdGlvblwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnN0cmluZ3MuY2FwdGlvbjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoY2hhcnRGb3JtSW5wdXRUeXBlID09PSBcImFsdFRleHRcIikge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLmRlc2NyaXB0aW9uO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pKCksIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDMuZm9ybUlucHV0QnV0dG9uIH0sIGgoXCJjYWxjaXRlLWlucHV0XCIsIHsgdHlwZTogXCJ0ZXh0XCIsIGF1dG9mb2N1czogdHJ1ZSwgcmVmOiAoZWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJjYWxjaXRlSW5wdXRDaGFuZ2VcIiwgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlucHV0VmFsID0gZXZlbnQudGFyZ2V0LnZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoYXJ0Rm9ybUlucHV0VHlwZSA9PT0gXCJ0aXRsZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGFydE1lZGlhSW5mby50aXRsZSA9IGlucHV0VmFsO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoY2hhcnRGb3JtSW5wdXRUeXBlID09PSBcImNhcHRpb25cIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8uY2FwdGlvbiA9IGlucHV0VmFsO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoY2hhcnRGb3JtSW5wdXRUeXBlID09PSBcImFsdFRleHRcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8uYWx0VGV4dCA9IGlucHV0VmFsO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGFydENoYW5nZWRSZVJlbmRlci5lbWl0KCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2hhcnRGb3JtSW5wdXRUeXBlID09PSBcInRpdGxlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAodGhpcy5lZGl0Q2hhcnRUaXRsZSA9IGVsZW1lbnQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGNoYXJ0Rm9ybUlucHV0VHlwZSA9PT0gXCJjYXB0aW9uXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAodGhpcy5lZGl0Q2hhcnRDYXB0aW9uID0gZWxlbWVudCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoY2hhcnRGb3JtSW5wdXRUeXBlID09PSBcImFsdFRleHRcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICh0aGlzLmVkaXRBbHRUZXh0ID0gZWxlbWVudCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LCB2YWx1ZTogKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNoYXJ0Rm9ybUlucHV0VHlwZSA9PT0gXCJ0aXRsZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jaGFydE1lZGlhSW5mby50aXRsZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChjaGFydEZvcm1JbnB1dFR5cGUgPT09IFwiY2FwdGlvblwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jaGFydE1lZGlhSW5mby5jYXB0aW9uO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGNoYXJ0Rm9ybUlucHV0VHlwZSA9PT0gXCJhbHRUZXh0XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNoYXJ0TWVkaWFJbmZvLmFsdFRleHQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KSgpLCBwbGFjZWhvbGRlcjogKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNoYXJ0Rm9ybUlucHV0VHlwZSA9PT0gXCJ0aXRsZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLmltYWdlVGl0bGVQbGFjZUhvbGRlcjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChjaGFydEZvcm1JbnB1dFR5cGUgPT09IFwiY2FwdGlvblwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLmltYWdlQ2FwdGlvblBsYWNlSG9sZGVyO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGNoYXJ0Rm9ybUlucHV0VHlwZSA9PT0gXCJhbHRUZXh0XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnN0cmluZ3MuZGVzY3JpYmVDaGFydDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pKCksIG9uQ2xpY2s6ICgpID0+IHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQodGhpcy5ndWlkKSB9KSwgKChfYSA9IHRoaXMucG9wdXBUZW1wbGF0ZS5maWVsZEluZm9zKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKSA+IDAgJiYgKGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IHRleHQ6IHRoaXMuc3RyaW5ncy5hdHRyaWJ1dGVzLCBcInRleHQtZGlzcGxheVwiOiBcImhpZGRlblwiLCBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBfYTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCh0aGlzLmd1aWQpO1xuICAgICAgICAgICAgICAgICAgICAoX2EgPSB0aGlzLmNvbG9yQnV0dG9uTm9kZSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmNsb3NlUG9wb3ZlcigpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNsb3NlQ29sb3JQb3BvdmVyKCk7XG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1wb3B1cC1maWVsZC1waWNrLWxpc3RcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5wb3BvdmVyUHJvcHMgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmRWxlbWVudDogdGhpcy5wYW5lbEVsZW1lbnRcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5tdWx0aXBsZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QuaGVhZGluZyA9IHRoaXMuc3RyaW5ncy5hZGRGaWVsZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0LmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNQb3B1cFBpY2tMaXN0RGlzbWlzc2VkXCIsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KHRoaXMuZ3VpZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0LmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNQb3B1cFBpY2tMaXN0Q2hhbmdlXCIsIChldmVudCkgPT4gdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3RDaGFuZ2VzKGV2ZW50LCBjaGFydEZvcm1JbnB1dFR5cGUpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYW5lbEVsZW1lbnQuZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSwgc2NhbGU6IFwic1wiLCBpY29uOiBcImJyYWNrZXRzLWN1cmx5XCIgfSkpKSkpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLmNhbGNpdGVQaWNrTGlzdCA9IChmaWVsZCwgaWR4KSA9PiAoaChcImNhbGNpdGUtbGlzdC1pdGVtXCIsIHsga2V5OiBmaWVsZC5maWVsZE5hbWUsIGxhYmVsOiBnZXRGaWVsZERpc3BsYXlOYW1lKGZpZWxkLCB0aGlzLmFyY2FkZUV4cE1hcCksIHZhbHVlOiBmaWVsZC5maWVsZE5hbWUgfSwgdGhpcy5yZW5kZXJDb2xvckljb24oaWR4KSwgaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgc2xvdDogXCJhY3Rpb25zLWVuZFwiLCBhcHBlYXJhbmNlOiBcInRyYW5zcGFyZW50XCIsIHRleHQ6IHRoaXMuc3RyaW5ncy5yZW1vdmUsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgICAgICAgICB2YXIgX2EsIF9iLCBfYztcbiAgICAgICAgICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KHRoaXMuZ3VpZCk7XG4gICAgICAgICAgICAgICAgKF9hID0gdGhpcy5jb2xvckJ1dHRvbk5vZGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5jbG9zZVBvcG92ZXIoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNsb3NlQ29sb3JQb3BvdmVyKCk7XG4gICAgICAgICAgICAgICAgaWYgKChfYiA9IHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuY29sb3JzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuZmllbGRzLmZvckVhY2goKGZpZWxkTmFtZSwgaWR4KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2E7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmllbGROYW1lID09PSBmaWVsZC5maWVsZE5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmZpZWxkcy5zcGxpY2UoaWR4LCAxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jaGFydE1lZGlhSW5mby50eXBlICE9PSBQb3B1cE11bHRpTWVkaWFUeXBlLmxpbmVDaGFydCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmNvbG9ycy5zcGxpY2UoaWR4LCAxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xvcnMuc3BsaWNlKGlkeCwgMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29sb3JCdXR0b25Ob2RlICYmIGZvcmNlVXBkYXRlKHRoaXMuY29sb3JCdXR0b25Ob2RlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChfYSA9IHRoaXMubGFzdENvbG9ycy5yYW1wQ29sb3JzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGFzdENvbG9ycy5yYW1wQ29sb3JzLnNwbGljZShpZHgsIDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmZpZWxkcy5mb3JFYWNoKChmaWVsZE5hbWUsIGlkeCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpZWxkTmFtZSA9PT0gZmllbGQuZmllbGROYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5maWVsZHMuc3BsaWNlKGlkeCwgMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAvLyBkb24ndCBhdXRvIHNhdmUgY29sb3JzIG9uIHJlbW92ZS9hZGQ7IHVwZGF0ZSB0byBtYWtlIHN1cmUgZGVmYXVsdCBjb2xvcnMgc3RpbGwgbWF0Y2hcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xvcnMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRDb2xvcnMoKTtcbiAgICAgICAgICAgICAgICAgICAgZm9yY2VVcGRhdGUodGhpcy5ob3N0RWxlbWVudCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuY2hhcnRDaGFuZ2VkUmVSZW5kZXIuZW1pdCgpO1xuICAgICAgICAgICAgICAgIGlmICghKChfYyA9IHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuZmllbGRzKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MubGVuZ3RoKSkge1xuICAgICAgICAgICAgICAgICAgICBmb3JjZVVwZGF0ZSh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBzY2FsZTogXCJzXCIsIGljb246IFwieFwiIH0pKSkpO1xuICAgICAgICB0aGlzLmd1aWQgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8gPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMubWVkaWFDb250ZW50ID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLm1lZGlhSW5kZXhQb3NpdGlvbiA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5yZWZFbGVtZW50ID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLmlzT3BlbiA9IGZhbHNlO1xuICAgICAgICB0aGlzLnJlUmVuZGVyID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgICAvLyBsaWZlY3ljbGUgbWV0aG9kc1xuICAgIGFzeW5jIGNvbXBvbmVudFdpbGxMb2FkKCkge1xuICAgICAgICB2YXIgX2E7XG4gICAgICAgIHRoaXMubGF5ZXIgPSBwb3B1cFN0YXRlLmxheWVyO1xuICAgICAgICB0aGlzLm1hcFZpZXcgPSBwb3B1cFN0YXRlLm1hcFZpZXc7XG4gICAgICAgIHRoaXMuc3RyaW5ncyA9IHBvcHVwU3RhdGUuc3RyaW5ncztcbiAgICAgICAgdGhpcy5wb3B1cFRlbXBsYXRlID0gcG9wdXBTdGF0ZS5wb3B1cFRlbXBsYXRlO1xuICAgICAgICB0aGlzLmxheWVyRGlzcGxheVR5cGUgPSBwb3B1cFN0YXRlLmxheWVyRGlzcGxheVR5cGU7XG4gICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udGl0bGUgPSB0aGlzLmNoYXJ0TWVkaWFJbmZvLnRpdGxlIHx8IFwiXCI7XG4gICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8uYWx0VGV4dCA9IHRoaXMuY2hhcnRNZWRpYUluZm8uYWx0VGV4dCB8fCBcIlwiO1xuICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLmNhcHRpb24gPSB0aGlzLmNoYXJ0TWVkaWFJbmZvLmNhcHRpb24gfHwgXCJcIjtcbiAgICAgICAgY29uc3QgW2VzcmlMYW5nLCBlc3JpQ29sb3IsIHBpZUNoYXJ0U2NoZW1lcywgcmVuZGVyZXJVdGlsc10gPSBhd2FpdCBsb2FkTW9kdWxlcyhbXG4gICAgICAgICAgICBcImVzcmkvY29yZS9sYW5nXCIsXG4gICAgICAgICAgICBcImVzcmkvQ29sb3JcIixcbiAgICAgICAgICAgIFwiZXNyaS9zbWFydE1hcHBpbmcvc3ltYm9sb2d5L3BpZUNoYXJ0XCIsXG4gICAgICAgICAgICBcImVzcmkvcmVuZGVyZXJzL3N1cHBvcnQvdXRpbHNcIlxuICAgICAgICBdKTtcbiAgICAgICAgdGhpcy5lc3JpTGFuZyA9IGVzcmlMYW5nO1xuICAgICAgICB0aGlzLmVzcmlDb2xvciA9IGVzcmlDb2xvcjtcbiAgICAgICAgdGhpcy5waWVDaGFydFNjaGVtZXMgPSBwaWVDaGFydFNjaGVtZXM7XG4gICAgICAgIHRoaXMucmVuZGVyZXJVdGlscyA9IHJlbmRlcmVyVXRpbHM7XG4gICAgICAgIGlmIChcInJlbmRlcmVyXCIgaW4gdGhpcy5sYXllcikge1xuICAgICAgICAgICAgbGV0IHJlbmRlcmVyO1xuICAgICAgICAgICAgaWYgKHRoaXMubGF5ZXJEaXNwbGF5VHlwZSA9PT0gbGF5ZXJEaXNwbGF5VHlwZUVudW0uY2x1c3Rlcikge1xuICAgICAgICAgICAgICAgIHJlbmRlcmVyID0gdGhpcy5sYXllci5mZWF0dXJlUmVkdWN0aW9uLnJlbmRlcmVyO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVuZGVyZXIgPSB0aGlzLmxheWVyLnJlbmRlcmVyO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKFtcImNsYXNzLWJyZWFrc1wiLCBcImRvdC1kZW5zaXR5XCIsIFwiaGVhdG1hcFwiLCBcInBpZS1jaGFydFwiLCBcInNpbXBsZVwiLCBcInVuaXF1ZS12YWx1ZVwiXS5pbmRleE9mKHJlbmRlcmVyLnR5cGUpID4gLTEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcmVyQ29sb3JzID0gYXdhaXQgdGhpcy5yZW5kZXJlclV0aWxzLmdldENvbG9yc0Zyb21SZW5kZXJlcihyZW5kZXJlcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jb2xvcnMgPSBlc3JpTGFuZy5jbG9uZSgoX2EgPSB0aGlzLmNoYXJ0TWVkaWFJbmZvKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EudmFsdWUuY29sb3JzKSB8fCBbXTtcbiAgICAgICAgdGhpcy5zZXRDb2xvcnMoKTtcbiAgICB9XG4gICAgY29tcG9uZW50RGlkTG9hZCgpIHtcbiAgICAgICAgdGhpcy5pc09wZW4gPSB0cnVlO1xuICAgICAgICAvLyBuZWVkIHRpbWVvdXQgYmVjYXVzZSBvZiByZS1yZW5kZXJcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gdGhpcy5wYW5lbEVsZW1lbnQuc2V0Rm9jdXMoKSksIDMwMCk7XG4gICAgfVxuICAgIGFzeW5jIGNvbXBvbmVudFdpbGxSZW5kZXIoKSB7XG4gICAgICAgIHRoaXMuZmllbGRJbmZvTWFwID0gbmV3IE1hcCh0aGlzLnBvcHVwVGVtcGxhdGUuZmllbGRJbmZvcy5tYXAoKGZpZWxkSW5mbykgPT4gW1xuICAgICAgICAgICAgZmllbGRJbmZvLmZpZWxkTmFtZSxcbiAgICAgICAgICAgIGZpZWxkSW5mb1xuICAgICAgICBdKSk7XG4gICAgICAgIHRoaXMubGF5ZXJGaWVsZHNNYXAgPSBhd2FpdCBnZW5lcmF0ZUxheWVyRmllbGRzTWFwKHRoaXMubGF5ZXIpO1xuICAgICAgICB0aGlzLmFyY2FkZUV4cE1hcCA9IGdlbmVyYXRlQXJjYWRlRXhwcmVzc2lvbk1hcCh0aGlzLnBvcHVwVGVtcGxhdGUpO1xuICAgICAgICB0aGlzLnBpY2tMaXN0ID0gW107XG4gICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuZmllbGRzLmZvckVhY2goKGZpZWxkLCBpZHgpID0+IHtcbiAgICAgICAgICAgIHZhciBfYSwgX2I7XG4gICAgICAgICAgICBpZiAodGhpcy5maWVsZEluZm9NYXAuaGFzKGZpZWxkKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRGaWVsZEluZm8gPSB0aGlzLmZpZWxkSW5mb01hcC5nZXQoZmllbGQpO1xuICAgICAgICAgICAgICAgIHRoaXMucGlja0xpc3QucHVzaCh0aGlzLmNhbGNpdGVQaWNrTGlzdChjdXJyZW50RmllbGRJbmZvLCBpZHgpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIGZpZWxkIGRvZXMgbm90IGV4aXN0IGFueW1vcmUsIHJlbW92ZVxuICAgICAgICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuZmllbGRzLnNwbGljZShpZHgsIDEpO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoYXJ0TWVkaWFJbmZvLnR5cGUgIT09IFBvcHVwTXVsdGlNZWRpYVR5cGUubGluZUNoYXJ0KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICgoX2EgPSB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmNvbG9ycykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5jb2xvcnMuc3BsaWNlKGlkeCwgMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbG9ycy5zcGxpY2UoaWR4LCAxKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlZmF1bHRTY2hlbWUgPSB0aGlzLmdldERlZmF1bHRDb2xvclNjaGVtZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xvcnMgPSAoX2IgPSB0aGlzLmNoYXJ0TWVkaWFJbmZvKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IudmFsdWUuZmllbGRzLm1hcCgoZmllbGROYW1lLCBpZHgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2E7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVuZGVyZXJDb2xvcnMuZ2V0KGZpZWxkTmFtZSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyB0aGlzLmVzcmlMYW5nLmNsb25lKHRoaXMucmVuZGVyZXJDb2xvcnMuZ2V0KGZpZWxkTmFtZSlbMF0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogKChfYSA9IHRoaXMuY29sb3JzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2FbaWR4XSkgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldyB0aGlzLmVzcmlDb2xvcihkZWZhdWx0U2NoZW1lLmNvbG9yc1tpZHggJSBNQVhfUkFNUF9DT0xPUlNdKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3IHRoaXMuZXNyaUNvbG9yKFswLCAwLCAwLCAxXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGNvbXBvbmVudERpZFVwZGF0ZSgpIHtcbiAgICAgICAgdGhpcy5ub3RpZnlNdWx0aU1lZGlhQ2hhbmdlLmVtaXQoe1xuICAgICAgICAgICAgZ3VpZDogdGhpcy5ndWlkLFxuICAgICAgICAgICAgbWVkaWFJbmRleFBvc2l0aW9uOiB0aGlzLm1lZGlhSW5kZXhQb3NpdGlvblxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5jaGFydFBvcG92ZXIucmVwb3NpdGlvbigpO1xuICAgIH1cbiAgICBkaXNjb25uZWN0ZWRDYWxsYmFjaygpIHtcbiAgICAgICAgdmFyIF9hO1xuICAgICAgICBpZiAodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpIHtcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnBvcHVwRmllbGRNYW5hZ2VQaWNrTGlzdCkge1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLnBvcHVwRmllbGRNYW5hZ2VQaWNrTGlzdCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdCkge1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QpO1xuICAgICAgICB9XG4gICAgICAgIChfYSA9IHRoaXMuY29sb3JCdXR0b25Ob2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY2xvc2VQb3BvdmVyKCk7XG4gICAgfVxuICAgIC8vIFB1YmxpYyBNZXRob2RzXG4gICAgYXN5bmMgcmVwb3NpdGlvbigpIHtcbiAgICAgICAgdGhpcy5jaGFydFBvcG92ZXIucmVwb3NpdGlvbigpO1xuICAgIH1cbiAgICAvLyBFdmVudHNcbiAgICBjaGFydENoYW5nZWRSZVJlbmRlckhhbmRsZXIoZXZlbnQpIHtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIHRoaXMucmVSZW5kZXIgPSB0aGlzLnJlUmVuZGVyID8gZmFsc2UgOiB0cnVlO1xuICAgIH1cbiAgICBjbG9zZVBvcHVwUG9wb3ZlcnNIYW5kbGVyKCkge1xuICAgICAgICB0aGlzLnJlbW92ZUF0dHJpYnV0ZXNTZWxlY3Rpb25Qb3BvdmVyKCk7XG4gICAgfVxuICAgIGNsb3NlTXVsdGlNZWRpYVBvcG92ZXJIYW5kbGVyKCkge1xuICAgICAgICB0aGlzLnJlbW92ZUF0dHJpYnV0ZXNTZWxlY3Rpb25Qb3BvdmVyKCk7XG4gICAgfVxuICAgIC8vIGFyY2FkZSBjaGFuZ2VzXG4gICAgYXJjYWRlQ2hhbmdlTm90aWZpY2F0aW9uSGFuZGxlcigpIHtcbiAgICAgICAgdGhpcy5jaGFydENoYW5nZWRSZVJlbmRlci5lbWl0KCk7XG4gICAgfVxuICAgIC8vIHByaXZhdGUgbWV0aG9kcyBhbmQgcHJvcGVydGllc1xuICAgIHJlbW92ZUF0dHJpYnV0ZXNTZWxlY3Rpb25Qb3BvdmVyKCkge1xuICAgICAgICBpZiAodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpIHtcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpO1xuICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QgPSBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnBvcHVwRmllbGRNYW5hZ2VQaWNrTGlzdCkge1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLnBvcHVwRmllbGRNYW5hZ2VQaWNrTGlzdCk7XG4gICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRNYW5hZ2VQaWNrTGlzdCA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdCkge1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QpO1xuICAgICAgICAgICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0ID0gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5jb2xvclBvcG92ZXJOb2RlKSB7XG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuY29sb3JQb3BvdmVyTm9kZSk7XG4gICAgICAgICAgICB0aGlzLmNvbG9yUG9wb3Zlck5vZGUgPSBudWxsO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucGFuZWxFbGVtZW50LmRpc2FibGVkID0gZmFsc2U7XG4gICAgfVxuICAgIGFzeW5jIGNoYXJ0U2VsZWN0aW9uKGNoYXJ0VHlwZSkge1xuICAgICAgICBjb25zdCBbQmFyQ2hhcnRNZWRpYUluZm8sIENvbHVtbkNoYXJ0TWVkaWFJbmZvLCBMaW5lQ2hhcnRNZWRpYUluZm8sIFBpZUNoYXJ0TWVkaWFJbmZvXSA9IGF3YWl0IGxvYWRNb2R1bGVzKFtcbiAgICAgICAgICAgIFwiZXNyaS9wb3B1cC9jb250ZW50L0JhckNoYXJ0TWVkaWFJbmZvXCIsXG4gICAgICAgICAgICBcImVzcmkvcG9wdXAvY29udGVudC9Db2x1bW5DaGFydE1lZGlhSW5mb1wiLFxuICAgICAgICAgICAgXCJlc3JpL3BvcHVwL2NvbnRlbnQvTGluZUNoYXJ0TWVkaWFJbmZvXCIsXG4gICAgICAgICAgICBcImVzcmkvcG9wdXAvY29udGVudC9QaWVDaGFydE1lZGlhSW5mb1wiXG4gICAgICAgIF0pO1xuICAgICAgICBsZXQgY2hhcnRFbGVtZW50ID0gbnVsbDtcbiAgICAgICAgaWYgKGNoYXJ0VHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5iYXJDaGFydCkge1xuICAgICAgICAgICAgY2hhcnRFbGVtZW50ID0gbmV3IEJhckNoYXJ0TWVkaWFJbmZvKHtcbiAgICAgICAgICAgICAgICB0aXRsZTogdGhpcy5jaGFydE1lZGlhSW5mby50aXRsZSxcbiAgICAgICAgICAgICAgICBjYXB0aW9uOiB0aGlzLmNoYXJ0TWVkaWFJbmZvLmNhcHRpb24sXG4gICAgICAgICAgICAgICAgdmFsdWU6IHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUsXG4gICAgICAgICAgICAgICAgYWx0VGV4dDogdGhpcy5jaGFydE1lZGlhSW5mby5hbHRUZXh0XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY2hhcnRUeXBlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLmNvbHVtbkNoYXJ0KSB7XG4gICAgICAgICAgICBjaGFydEVsZW1lbnQgPSBuZXcgQ29sdW1uQ2hhcnRNZWRpYUluZm8oe1xuICAgICAgICAgICAgICAgIHRpdGxlOiB0aGlzLmNoYXJ0TWVkaWFJbmZvLnRpdGxlLFxuICAgICAgICAgICAgICAgIGNhcHRpb246IHRoaXMuY2hhcnRNZWRpYUluZm8uY2FwdGlvbixcbiAgICAgICAgICAgICAgICB2YWx1ZTogdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZSxcbiAgICAgICAgICAgICAgICBhbHRUZXh0OiB0aGlzLmNoYXJ0TWVkaWFJbmZvLmFsdFRleHRcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjaGFydFR5cGUgPT09IFBvcHVwTXVsdGlNZWRpYVR5cGUubGluZUNoYXJ0KSB7XG4gICAgICAgICAgICBjaGFydEVsZW1lbnQgPSBuZXcgTGluZUNoYXJ0TWVkaWFJbmZvKHtcbiAgICAgICAgICAgICAgICB0aXRsZTogdGhpcy5jaGFydE1lZGlhSW5mby50aXRsZSxcbiAgICAgICAgICAgICAgICBjYXB0aW9uOiB0aGlzLmNoYXJ0TWVkaWFJbmZvLmNhcHRpb24sXG4gICAgICAgICAgICAgICAgdmFsdWU6IHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUsXG4gICAgICAgICAgICAgICAgYWx0VGV4dDogdGhpcy5jaGFydE1lZGlhSW5mby5hbHRUZXh0XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY2hhcnRUeXBlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLnBpZUNoYXJ0KSB7XG4gICAgICAgICAgICBjaGFydEVsZW1lbnQgPSBuZXcgUGllQ2hhcnRNZWRpYUluZm8oe1xuICAgICAgICAgICAgICAgIHRpdGxlOiB0aGlzLmNoYXJ0TWVkaWFJbmZvLnRpdGxlLFxuICAgICAgICAgICAgICAgIGNhcHRpb246IHRoaXMuY2hhcnRNZWRpYUluZm8uY2FwdGlvbixcbiAgICAgICAgICAgICAgICB2YWx1ZTogdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZSxcbiAgICAgICAgICAgICAgICBhbHRUZXh0OiB0aGlzLmNoYXJ0TWVkaWFJbmZvLmFsdFRleHRcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8gPSBjaGFydEVsZW1lbnQuY2xvbmUoKTtcbiAgICAgICAgdGhpcy5tZWRpYUNvbnRlbnQubWVkaWFJbmZvc1t0aGlzLm1lZGlhSW5kZXhQb3NpdGlvbl0gPSB0aGlzLmNoYXJ0TWVkaWFJbmZvO1xuICAgICAgICB0aGlzLmNoYXJ0Q2hhbmdlZFJlUmVuZGVyLmVtaXQoKTtcbiAgICB9XG4gICAgZ2V0U3VtbWFyeVN0cmluZygpIHtcbiAgICAgICAgaWYgKHRoaXMuY2hhcnRNZWRpYUluZm8udHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5iYXJDaGFydCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RyaW5ncy5iYXI7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuY2hhcnRNZWRpYUluZm8udHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5jb2x1bW5DaGFydCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RyaW5ncy5jb2x1bW47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuY2hhcnRNZWRpYUluZm8udHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5saW5lQ2hhcnQpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnN0cmluZ3MubGluZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5jaGFydE1lZGlhSW5mby50eXBlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLnBpZUNoYXJ0KSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpbmdzLnBpZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICAvLyByZW5kb3IgbWV0aG9kc1xuICAgIHJlbmRlcigpIHtcbiAgICAgICAgdmFyIF9hLCBfYjtcbiAgICAgICAgY29uc3QgaGFzRmllbGRzID0gISEoKF9hID0gdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5maWVsZHMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpO1xuICAgICAgICBjb25zdCBjaGFydEdyb3VwID0gKGgoXCJjYWxjaXRlLXNlZ21lbnRlZC1jb250cm9sXCIsIHsgd2lkdGg6IFwiZnVsbFwiLCBzY2FsZTogXCJzXCIsIGNsYXNzOiBDU1MkMy5jaGFydEdyb3VwLCBvbkNhbGNpdGVTZWdtZW50ZWRDb250cm9sQ2hhbmdlOiBhc3luYyAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICB2YXIgX2E7XG4gICAgICAgICAgICAgICAgKF9hID0gdGhpcy5jb2xvckJ1dHRvbk5vZGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5jbG9zZVBvcG92ZXIoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNsb3NlQ29sb3JQb3BvdmVyKCk7XG4gICAgICAgICAgICAgICAgY29uc3Qgbm9kZSA9IGV2ZW50LnRhcmdldDtcbiAgICAgICAgICAgICAgICBjb25zdCBzZWxlY3RlZEl0ZW0gPSBub2RlLnNlbGVjdGVkSXRlbTtcbiAgICAgICAgICAgICAgICBpZiAoKHRoaXMuY2hhcnRNZWRpYUluZm8udHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5saW5lQ2hhcnQgJiZcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRJdGVtLnZhbHVlICE9PSBQb3B1cE11bHRpTWVkaWFUeXBlLmxpbmVDaGFydCkgfHxcbiAgICAgICAgICAgICAgICAgICAgKHRoaXMuY2hhcnRNZWRpYUluZm8udHlwZSAhPT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5saW5lQ2hhcnQgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkSXRlbS52YWx1ZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5saW5lQ2hhcnQpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNhdmVkQ29sb3JzID0gdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5jb2xvcnM7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoYXJ0TWVkaWFJbmZvLnR5cGUgPT09IFBvcHVwTXVsdGlNZWRpYVR5cGUubGluZUNoYXJ0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxhc3RDb2xvcnMubGluZUNvbG9ycyA9IHNhdmVkQ29sb3JzICYmIHRoaXMuZXNyaUxhbmcuY2xvbmUoc2F2ZWRDb2xvcnMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xvcnMgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmNvbG9ycyA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGFzdENvbG9ycy5yYW1wQ29sb3JzID0gc2F2ZWRDb2xvcnMgJiYgdGhpcy5lc3JpTGFuZy5jbG9uZShzYXZlZENvbG9ycyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0ZWRJdGVtLnZhbHVlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLmxpbmVDaGFydCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29sb3JzID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuY29sb3JzID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzZWxlY3RlZEl0ZW0udmFsdWUgIT09IHRoaXMuY2hhcnRNZWRpYUluZm8udHlwZSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBiYXIgYW5kIGNvbHVtbiBhcmUgaW4gc2FtZSByYWRpbyBncm91cFxuICAgICAgICAgICAgICAgICAgICAhKHNlbGVjdGVkSXRlbS52YWx1ZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5jb2x1bW5DaGFydCAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGFydE1lZGlhSW5mby50eXBlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLmJhckNoYXJ0KSAmJiAoYXdhaXQgdGhpcy5jaGFydFNlbGVjdGlvbihzZWxlY3RlZEl0ZW0udmFsdWUpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRDb2xvcnMoKTtcbiAgICAgICAgICAgIH0gfSwgaChcImNhbGNpdGUtc2VnbWVudGVkLWNvbnRyb2wtaXRlbVwiLCB7IHZhbHVlOiBQb3B1cE11bHRpTWVkaWFUeXBlLmNvbHVtbkNoYXJ0LCBpY29uU3RhcnQ6IFwiZ3JhcGgtYmFyXCIsIGNoZWNrZWQ6IHRoaXMuY2hhcnRNZWRpYUluZm8udHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5jb2x1bW5DaGFydCB8fFxuICAgICAgICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5iYXJDaGFydCB9LCB0aGlzLnN0cmluZ3MuYmFyKSwgaChcImNhbGNpdGUtc2VnbWVudGVkLWNvbnRyb2wtaXRlbVwiLCB7IHZhbHVlOiBQb3B1cE11bHRpTWVkaWFUeXBlLmxpbmVDaGFydCwgaWNvblN0YXJ0OiBcImdyYXBoLXRpbWUtc2VyaWVzXCIsIGNoZWNrZWQ6IHRoaXMuY2hhcnRNZWRpYUluZm8udHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5saW5lQ2hhcnQgfSwgdGhpcy5zdHJpbmdzLmxpbmUpLCBoKFwiY2FsY2l0ZS1zZWdtZW50ZWQtY29udHJvbC1pdGVtXCIsIHsgdmFsdWU6IFBvcHVwTXVsdGlNZWRpYVR5cGUucGllQ2hhcnQsIGljb25TdGFydDogXCJwaWUtY2hhcnRcIiwgY2hlY2tlZDogdGhpcy5jaGFydE1lZGlhSW5mby50eXBlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLnBpZUNoYXJ0IH0sIHRoaXMuc3RyaW5ncy5waWUpKSk7XG4gICAgICAgIGNvbnN0IGNvbG9yQnV0dG9uID0gKGgoXCJhcmNnaXMtcG9wdXAtY29sb3ItYnV0dG9uXCIsIHsgY2hhcnRNZWRpYUluZm86IHRoaXMuY2hhcnRNZWRpYUluZm8sIGNvbG9yczogdGhpcy5jb2xvcnMsIHBvcG92ZXJSZWZlcmVuY2VFbGVtZW50OiB0aGlzLnBhbmVsRWxlbWVudCwgb25BcmNnaXNQb3B1cENvbG9yQnV0dG9uQ2hhbmdlOiAoeyBkZXRhaWw6IGNvbG9ycyB9KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb2xvcnMgPSBjb2xvcnM7XG4gICAgICAgICAgICAgICAgLy8gb25jZSB0aGUgdXNlciBtYWtlcyBhIGNoYW5nZSB3ZSBzYXZlIGFsbCBjb2xvcnNcbiAgICAgICAgICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmNvbG9ycyA9IHRoaXMuZXNyaUxhbmcuY2xvbmUoY29sb3JzKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNoYXJ0Q2hhbmdlZFJlUmVuZGVyLmVtaXQoKTtcbiAgICAgICAgICAgIH0sIG9uQXJjZ2lzUG9wdXBDb2xvckJ1dHRvbkJlZm9yZU9wZW46ICgpID0+IHRoaXMuY2xvc2VDb2xvclBvcG92ZXIoKSwgcmVmOiAobm9kZSkgPT4gKHRoaXMuY29sb3JCdXR0b25Ob2RlID0gbm9kZSkgfSkpO1xuICAgICAgICBjb25zdCByZXNldEJ1dHRvbiA9IChoKFwiY2FsY2l0ZS1sYWJlbFwiLCB7IGxheW91dDogXCJpbmxpbmUtc3BhY2UtYmV0d2VlblwiIH0sIHRoaXMuc3RyaW5ncy5yZXNldENvbG9ycywgaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgYXBwZWFyYW5jZTogXCJ0cmFuc3BhcmVudFwiLCB0ZXh0OiB0aGlzLnN0cmluZ3MucmVzZXRDb2xvcnMsIGRpc2FibGVkOiAhKChfYiA9IHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuY29sb3JzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IubGVuZ3RoKSwgb25DbGljazogKCkgPT4ge1xuICAgICAgICAgICAgICAgIHZhciBfYTtcbiAgICAgICAgICAgICAgICAoX2EgPSB0aGlzLmNvbG9yQnV0dG9uTm9kZSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmNsb3NlUG9wb3ZlcigpO1xuICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VDb2xvclBvcG92ZXIoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmNvbG9ycyA9IG51bGw7XG4gICAgICAgICAgICAgICAgdGhpcy5jb2xvcnMgPSBbXTtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5jaGFydE1lZGlhSW5mby50eXBlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLmxpbmVDaGFydCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxhc3RDb2xvcnMubGluZUNvbG9ycyA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubGFzdENvbG9ycy5yYW1wQ29sb3JzID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLnNldENvbG9ycygpO1xuICAgICAgICAgICAgICAgIGZvcmNlVXBkYXRlKHRoaXMuaG9zdEVsZW1lbnQpO1xuICAgICAgICAgICAgfSB9LCBoKFwiY2FsY2l0ZS1pY29uXCIsIHsgc2NhbGU6IFwic1wiLCBpY29uOiBcInJlc2V0XCIgfSkpKSk7XG4gICAgICAgIC8vIG1hbmFnZSBidXR0b24gYW5kIGxpc3Qgb2Ygc2VsZWN0ZWQgZmllbGRzXG4gICAgICAgIGNvbnN0IGZpZWxkTGlzdCA9IChoKFwiZGl2XCIsIG51bGwsIGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IGNsYXNzOiBDU1MkMy5tYW5hZ2VCdG4sIGFwcGVhcmFuY2U6IFwidHJhbnNwYXJlbnRcIiwgc2NhbGU6IFwibVwiLCB3aWR0aDogXCJmdWxsXCIsIG9uQ2xpY2s6IGFzeW5jIChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIHZhciBfYSwgX2IsIF9jO1xuICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQodGhpcy5ndWlkKTtcbiAgICAgICAgICAgICAgICAoX2EgPSB0aGlzLmNvbG9yQnV0dG9uTm9kZSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmNsb3NlUG9wb3ZlcigpO1xuICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VDb2xvclBvcG92ZXIoKTtcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0KSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1wb3B1cC1maWVsZC1waWNrLWxpc3RcIik7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0LnBvcG92ZXJQcm9wcyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlZkVsZW1lbnQ6IHRoaXMucGFuZWxFbGVtZW50XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0LnNlbGVjdGVkRmllbGRzID1cbiAgICAgICAgICAgICAgICAgICAgICAgICgoX2MgPSAoX2IgPSB0aGlzLmNoYXJ0TWVkaWFJbmZvKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IudmFsdWUpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5maWVsZHMpIHx8IFtdO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRNYW5hZ2VQaWNrTGlzdC5zaG93Q2FuY2VsID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0Lm11bHRpcGxlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3QuaGVhZGluZyA9IHRoaXMuc3RyaW5ncy5zZWxlY3RGaWVsZHM7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0Lm9rQnRuVGV4dCA9IHRoaXMuc3RyaW5ncy5kb25lO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRNYW5hZ2VQaWNrTGlzdC5udW1iZXJzT25seSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0LmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNQb3B1cFBpY2tMaXN0RGlzbWlzc2VkXCIsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQodGhpcy5ndWlkKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0LmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNQb3B1cFBpY2tMaXN0Q2hhbmdlXCIsIHRoaXMucG9wdXBGaWVsZE1hbmFnZVBpY2tMaXN0Q2hhbmdlcyk7XG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5wb3B1cEZpZWxkTWFuYWdlUGlja0xpc3QpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5kaXNhYmxlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSB9LCB0aGlzLnN0cmluZ3Muc2VsZWN0QXR0cmlidXRlcyksIGgoXCJjYWxjaXRlLWxpc3RcIiwgeyBcImRyYWctZW5hYmxlZFwiOiB0cnVlLCBvbkNhbGNpdGVMaXN0T3JkZXJDaGFuZ2U6IGFzeW5jIChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIHZhciBfYSwgX2I7XG4gICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgY29uc3QgYWxsSXRlbXMgPSBldmVudC50YXJnZXQucXVlcnlTZWxlY3RvckFsbChcImNhbGNpdGUtbGlzdC1pdGVtXCIpO1xuICAgICAgICAgICAgICAgIGNvbnN0IG5ld0luZGV4T3JkZXIgPSBbXTtcbiAgICAgICAgICAgICAgICBhbGxJdGVtcy5mb3JFYWNoKChpdGVtKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuZmllbGRzLmZvckVhY2goKGZpZWxkLCBpZHgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLnZhbHVlID09PSBmaWVsZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0luZGV4T3JkZXIucHVzaChpZHgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5jaGFydE1lZGlhSW5mby50eXBlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLmxpbmVDaGFydCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmZpZWxkcyA9IEFycmF5LmZyb20oYWxsSXRlbXMpLm1hcCgoaXRlbSkgPT4gaXRlbS52YWx1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoISgoX2EgPSB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmNvbG9ycykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG9uY2UgdGhlIHVzZXIgbWFrZXMgYSByZS1vcmRlciBjaGFuZ2Ugd2Ugc2F2ZSBhbGwgY29sb3JzXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmNvbG9ycyA9IHRoaXMuZXNyaUxhbmcuY2xvbmUodGhpcy5jb2xvcnMpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld0ZpZWxkcyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdDb2xvcnMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgbmV3SW5kZXhPcmRlci5mb3JFYWNoKChpZHgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0ZpZWxkcy5wdXNoKHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuZmllbGRzW2lkeF0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3Q29sb3JzLnB1c2godGhpcy5lc3JpTGFuZy5jbG9uZSh0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmNvbG9yc1tpZHhdKSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLmZpZWxkcyA9IG5ld0ZpZWxkcztcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xvcnMgPSBuZXdDb2xvcnM7XG4gICAgICAgICAgICAgICAgICAgIC8vIHdlIHNhdmUgY29sb3JzIG9uIHJlLW9yZGVyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuY29sb3JzID0gdGhpcy5lc3JpTGFuZy5jbG9uZShuZXdDb2xvcnMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoKF9iID0gdGhpcy5sYXN0Q29sb3JzLnJhbXBDb2xvcnMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmFtcENvbG9ycyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBuZXdJbmRleE9yZGVyLmZvckVhY2goKGlkeCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmFtcENvbG9ycy5wdXNoKHRoaXMubGFzdENvbG9ycy5yYW1wQ29sb3JzW2lkeF0pO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXN0Q29sb3JzLnJhbXBDb2xvcnMgPSByYW1wQ29sb3JzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLmNoYXJ0Q2hhbmdlZFJlUmVuZGVyLmVtaXQoKTtcbiAgICAgICAgICAgIH0gfSwgdGhpcy5waWNrTGlzdCkpKTtcbiAgICAgICAgLy8gYmFyIGNoYXJ0IGNoZWNrYm94IG9ubHkgdW5kZXIgZGVmYXVsdCBjb2x1bW4tY2hhcnRcbiAgICAgICAgY29uc3QgYmFyQ2hhcnQgPSAodGhpcy5jaGFydE1lZGlhSW5mby50eXBlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLmJhckNoYXJ0IHx8XG4gICAgICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnR5cGUgPT09IFBvcHVwTXVsdGlNZWRpYVR5cGUuY29sdW1uQ2hhcnQpICYmIChoKFwic2VjdGlvblwiLCB7IGNsYXNzOiBDU1MkMy5lbmFibGVDb2x1bW4gfSwgaChcImxhYmVsXCIsIHsgY2xhc3M6IENTUyQzLmVuYWJsZUNvbHVtbkxhYmVsIH0sIHRoaXMuc3RyaW5ncy5ob3Jpem9udGFsT3JpZW50YXRpb24pLCBoKFwiY2FsY2l0ZS1zd2l0Y2hcIiwgeyBzY2FsZTogXCJzXCIsIGNsYXNzOiBDU1MkMy5Db2x1bW5Td2l0Y2gsIGNoZWNrZWQ6IHRoaXMuY2hhcnRNZWRpYUluZm8udHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5iYXJDaGFydCA/IHRydWUgOiBmYWxzZSwgb25DYWxjaXRlU3dpdGNoQ2hhbmdlOiBhc3luYyAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICB2YXIgX2E7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5jaGFydFNlbGVjdGlvbigoKF9hID0gZXZlbnQudGFyZ2V0KSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY2hlY2tlZClcbiAgICAgICAgICAgICAgICAgICAgPyBQb3B1cE11bHRpTWVkaWFUeXBlLmJhckNoYXJ0XG4gICAgICAgICAgICAgICAgICAgIDogUG9wdXBNdWx0aU1lZGlhVHlwZS5jb2x1bW5DaGFydCk7XG4gICAgICAgICAgICB9IH0pKSk7XG4gICAgICAgIGNvbnN0IG5vcm1hbGl6ZUZpZWxkID0gKGgoXCJjYWxjaXRlLWJsb2NrLXNlY3Rpb25cIiwgeyBjbGFzczogQ1NTJDMubm9ybWFsaXplQmxvY2ssIHRleHQ6IHRoaXMuc3RyaW5ncy5ub3JtYWxpemUsIHRvZ2dsZURpc3BsYXk6IFwic3dpdGNoXCIsIG9wZW46IHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUubm9ybWFsaXplRmllbGQgPyB0cnVlIDogZmFsc2UsIG9uQ2FsY2l0ZUJsb2NrU2VjdGlvblRvZ2dsZTogKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50LnRhcmdldC5vcGVuKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUubm9ybWFsaXplRmllbGQgPSB0aGlzLnRlbXBOb3JtYWxpemVkRmllbGQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnRlbXBOb3JtYWxpemVkRmllbGQgPSB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLm5vcm1hbGl6ZUZpZWxkO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYXJ0TWVkaWFJbmZvLnZhbHVlLm5vcm1hbGl6ZUZpZWxkID0gXCJcIjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5jaGFydENoYW5nZWRSZVJlbmRlci5lbWl0KCk7XG4gICAgICAgICAgICB9IH0sIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDMubm9ybWFsaXplQ29udGVudEJ1dHRvblNlY3Rpb24gfSwgaChcImJ1dHRvblwiLCB7IHJlZjogKGVsKSA9PiAodGhpcy5ub3JtYWxpemVCdG4gPSBlbCksIGNsYXNzOiBDU1MkMy5ub3JtYWxpemVDb250ZW50QnV0dG9uLCB0aXRsZTogdGhpcy5zdHJpbmdzLm5vcm1hbGl6ZUJ5LCBvbkNsaWNrOiAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICB2YXIgX2E7XG4gICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCh0aGlzLmd1aWQpO1xuICAgICAgICAgICAgICAgIChfYSA9IHRoaXMuY29sb3JCdXR0b25Ob2RlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY2xvc2VQb3BvdmVyKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5jbG9zZUNvbG9yUG9wb3ZlcigpO1xuICAgICAgICAgICAgICAgIC8vIGxhenkgbG9hZCBhdHRyaWJ1dGUgc2VsZWN0aW9uIGNvbXBvbmVudFxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0KSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtcG9wdXAtZmllbGQtcGljay1saXN0XCIpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QucG9wb3ZlclByb3BzID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVmRWxlbWVudDogdGhpcy5wYW5lbEVsZW1lbnRcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0LnNlbGVjdGVkRmllbGRzID0gW1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5ub3JtYWxpemVGaWVsZFxuICAgICAgICAgICAgICAgICAgICBdO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QubnVtYmVyc09ubHkgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc1BvcHVwUGlja0xpc3REaXNtaXNzZWRcIiwgdGhpcy5maWVsZFBpY2tMaXN0Q2hhbmdlcyk7XG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0KTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYW5lbEVsZW1lbnQuZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gfSwgaChcInNwYW5cIiwgeyBjbGFzczogQ1NTJDMubm9ybWFsaXplQ29udGVudEJ1dHRvblRleHQgfSwgdGhpcy5maWVsZEluZm9NYXAuaGFzKHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUubm9ybWFsaXplRmllbGQpXG4gICAgICAgICAgICA/IGdldEZpZWxkRGlzcGxheU5hbWUodGhpcy5maWVsZEluZm9NYXAuZ2V0KHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUubm9ybWFsaXplRmllbGQpLCB0aGlzLmFyY2FkZUV4cE1hcClcbiAgICAgICAgICAgIDogdGhpcy5zdHJpbmdzLm5vcm1hbGl6ZUJ5KSwgaChcInNwYW5cIiwgeyBjbGFzczogQ1NTJDMubm9ybWFsaXplQ29udGVudEJ1dHRvbkljb24gfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcInNcIiwgaWNvbjogXCJwZW5jaWxcIiB9KSkpKSkpO1xuICAgICAgICBjb25zdCBkb25lQnRuID0gKGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IGFwcGVhcmFuY2U6IFwib3V0bGluZS1maWxsXCIsIHNjYWxlOiBcIm1cIiwgc2xvdDogXCJmb290ZXJcIiwgd2lkdGg6IFwiZnVsbFwiLCBvbkNsaWNrOiAoKSA9PiB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCkgfSwgdGhpcy5zdHJpbmdzLmRvbmUpKTtcbiAgICAgICAgcmV0dXJuIChoKEhvc3QsIHsgY2xhc3M6IFwianMtYXBwLWZseW91dFwiIH0sIGgoXCJjYWxjaXRlLXBvcG92ZXJcIiwgeyBkaXI6IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCksIHJlZjogKGVsZW1lbnQpID0+ICh0aGlzLmNoYXJ0UG9wb3ZlciA9IGVsZW1lbnQpLCBwbGFjZW1lbnQ6IFwibGVhZGluZy1zdGFydFwiLCBvcGVuOiB0aGlzLmlzT3BlbiwgcG9pbnRlckRpc2FibGVkOiB0cnVlLCByZWZlcmVuY2VFbGVtZW50OiB0aGlzLnJlZkVsZW1lbnQsIG9mZnNldERpc3RhbmNlOiAtTWF0aC5yb3VuZCh0aGlzLnJlZkVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGgpLCBvZmZzZXRTa2lkZGluZzogNTAsIGxhYmVsOiBcIlwiLCBzdHlsZToge1xuICAgICAgICAgICAgICAgIHpJbmRleDogXCIxMDBcIlxuICAgICAgICAgICAgfSwgdHJpZ2dlckRpc2FibGVkOiB0cnVlIH0sIGgoXCJjYWxjaXRlLXBhbmVsXCIsIHsgcmVmOiAoZWxlbWVudCkgPT4gKHRoaXMucGFuZWxFbGVtZW50ID0gZWxlbWVudCksIGNsb3NhYmxlOiB0cnVlLCBzdHlsZToge1xuICAgICAgICAgICAgICAgIHdpZHRoOiBgJHt0aGlzLnJlZkVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGh9cHhgXG4gICAgICAgICAgICB9LCBvbkNhbGNpdGVQYW5lbENsb3NlOiAoKSA9PiB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCkgfSwgaChcImRpdlwiLCB7IHNsb3Q6IFwiaGVhZGVyLWNvbnRlbnRcIiB9LCB0aGlzLnN0cmluZ3MuY29uZmlndXJlQ2hhcnQpLCBkb25lQnRuLCBoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQzLnBvcG92ZXJDaGFydERpdiB9LCBjaGFydEdyb3VwLCB0aGlzLmNoYXJ0Rm9ybUlucHV0KFwidGl0bGVcIiksIHRoaXMuY2hhcnRGb3JtSW5wdXQoXCJjYXB0aW9uXCIpLCB0aGlzLmNoYXJ0Rm9ybUlucHV0KFwiYWx0VGV4dFwiKSwgaGFzRmllbGRzICYmIGNvbG9yQnV0dG9uLCBoYXNGaWVsZHMgJiYgcmVzZXRCdXR0b24sIGZpZWxkTGlzdCwgYmFyQ2hhcnQsIG5vcm1hbGl6ZUZpZWxkKSkpKSk7XG4gICAgfVxuICAgIHJlbmRlckNvbG9ySWNvbihpbmRleCkge1xuICAgICAgICBjb25zdCB7IHN0cmluZ3MsIHNlbGVjdGVkRmllbGRJZHgsIGNvbG9ycyB9ID0gdGhpcztcbiAgICAgICAgaWYgKHRoaXMuY2hhcnRNZWRpYUluZm8udHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5saW5lQ2hhcnQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gKGgoXCJkaXZcIiwgeyBjbGFzczogXCJjb2xvci1pY29uXCIsIHN0eWxlOiB7IGJhY2tncm91bmRDb2xvcjogY29sb3JzW2luZGV4XS50b0hleCgpIH0sIHNsb3Q6IFwiY29udGVudC1zdGFydFwiLCBvbkNsaWNrOiAoKSA9PiB0aGlzLm9wZW5Db2xvclBpY2tlcihpbmRleCksIHJvbGU6IFwiYnV0dG9uXCIsIHRhYkluZGV4OiAwLCBcImFyaWEtbGFiZWxcIjogc3RyaW5ncy5jaGFuZ2VDb2xvciwgXCJhcmlhLWhhc3BvcHVwXCI6IFwidHJ1ZVwiLCBcImFyaWEtZXhwYW5kZWRcIjogc2VsZWN0ZWRGaWVsZElkeCA9PT0gaW5kZXgsIG9uS2V5VXA6IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChldmVudC5rZXkgPT09IFwiIFwiIHx8IGV2ZW50LmtleSA9PT0gXCJFbnRlclwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMub3BlbkNvbG9yUGlja2VyKGluZGV4KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LCByZWY6IChub2RlKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb2xvck5vZGVzW2luZGV4XSA9IG5vZGU7XG4gICAgICAgICAgICB9IH0pKTtcbiAgICB9XG4gICAgb3BlbkNvbG9yUGlja2VyKGluZGV4KSB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgY29uc3QgeyBjb2xvcnMsIHN0cmluZ3MsIGVzcmlDb2xvciB9ID0gdGhpcztcbiAgICAgICAgKF9hID0gdGhpcy5jb2xvckJ1dHRvbk5vZGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5jbG9zZVBvcG92ZXIoKTtcbiAgICAgICAgdGhpcy5jbG9zZUNvbG9yUG9wb3ZlcigpO1xuICAgICAgICB0aGlzLnNlbGVjdGVkRmllbGRJZHggPSBpbmRleDtcbiAgICAgICAgY29uc3QgcG9wb3ZlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtcG9wdXAtY29sb3ItcG9wb3ZlclwiKTtcbiAgICAgICAgcG9wb3Zlci5oZWFkaW5nID0gc3RyaW5ncy5zZWxlY3RDb2xvcjtcbiAgICAgICAgcG9wb3Zlci5pbnRsRG9uZSA9IHN0cmluZ3MuZG9uZTtcbiAgICAgICAgcG9wb3Zlci5sYWJlbCA9IHN0cmluZ3Muc2VsZWN0Q29sb3I7XG4gICAgICAgIHBvcG92ZXIuaGV4Q29sb3IgPSBjb2xvcnNbaW5kZXhdLnRvSGV4KCk7XG4gICAgICAgIHBvcG92ZXIucG9wb3ZlclByb3BzID0ge1xuICAgICAgICAgICAgcGxhY2VtZW50OiBcImxlYWRpbmctc3RhcnRcIixcbiAgICAgICAgICAgIG9mZnNldERpc3RhbmNlOiAxLFxuICAgICAgICAgICAgb2Zmc2V0U2tpZGRpbmc6IDUyLFxuICAgICAgICAgICAgcG9pbnRlckRpc2FibGVkOiBcInRydWVcIixcbiAgICAgICAgICAgIHBvcG92ZXJXaWR0aDogMzE1LFxuICAgICAgICAgICAgLy9vdmVybGF5UG9zaXRpb25pbmc6IFwiZml4ZWRcIiwgLS0gYnVnZ3ksIG9mZnNldCBpc3N1ZVxuICAgICAgICAgICAgcmVmRWxlbWVudDogdGhpcy5jaGFydFBvcG92ZXJcbiAgICAgICAgfTtcbiAgICAgICAgcG9wb3Zlci5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzUG9wdXBDb2xvclBvcG92ZXJDbG9zZVwiLCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkRmllbGRJZHggPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB0aGlzLmNvbG9yUG9wb3Zlck5vZGUgPSBudWxsO1xuICAgICAgICB9KTtcbiAgICAgICAgcG9wb3Zlci5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzUG9wdXBDb2xvclBvcG92ZXJDaGFuZ2VcIiwgKHsgZGV0YWlsOiBoZXhDb2xvciB9KSA9PiB7XG4gICAgICAgICAgICBjb2xvcnNbaW5kZXhdID0gbmV3IGVzcmlDb2xvcihoZXhDb2xvcik7XG4gICAgICAgICAgICAvLyBvbmNlIHRoZSB1c2VyIG1ha2VzIGEgY2hhbmdlIHdlIHNhdmUgYWxsIGNvbG9yc1xuICAgICAgICAgICAgdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5jb2xvcnMgPSB0aGlzLmVzcmlMYW5nLmNsb25lKGNvbG9ycyk7XG4gICAgICAgICAgICB0aGlzLmNoYXJ0Q2hhbmdlZFJlUmVuZGVyLmVtaXQoKTtcbiAgICAgICAgICAgIGZvcmNlVXBkYXRlKHRoaXMuY29sb3JCdXR0b25Ob2RlKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQocG9wb3Zlcik7XG4gICAgICAgIHBvcG92ZXIuc2V0T3Blbih0cnVlKTtcbiAgICAgICAgdGhpcy5jb2xvclBvcG92ZXJOb2RlID0gcG9wb3ZlcjtcbiAgICAgICAgLy9wb3BvdmVyLmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNQb3B1cENvbG9yUG9wb3Zlck9wZW5cIiwgKCkgPT4ge30pO1xuICAgIH1cbiAgICBzZXRDb2xvcnMoKSB7XG4gICAgICAgIHZhciBfYSwgX2IsIF9jLCBfZCwgX2UsIF9mO1xuICAgICAgICBjb25zdCB7IGVzcmlDb2xvciwgbGFzdENvbG9ycywgcmVuZGVyZXJDb2xvcnMgfSA9IHRoaXM7XG4gICAgICAgIGlmICh0aGlzLmNoYXJ0TWVkaWFJbmZvLnR5cGUgPT09IFBvcHVwTXVsdGlNZWRpYVR5cGUubGluZUNoYXJ0KSB7XG4gICAgICAgICAgICBpZiAoISgoX2EgPSB0aGlzLmNvbG9ycykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkgJiYgbGFzdENvbG9ycy5saW5lQ29sb3JzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb2xvcnMgPSBsYXN0Q29sb3JzLmxpbmVDb2xvcnM7XG4gICAgICAgICAgICAgICAgdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5jb2xvcnMgPSB0aGlzLmVzcmlMYW5nLmNsb25lKHRoaXMuY29sb3JzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghKChfYiA9IHRoaXMuY29sb3JzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IubGVuZ3RoKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGRlZmF1bHRTY2hlbWUgPSB0aGlzLmdldERlZmF1bHRDb2xvclNjaGVtZSgpO1xuICAgICAgICAgICAgICAgIHRoaXMuY29sb3JzID0gW2RlZmF1bHRTY2hlbWUuY29sb3JzWzBdXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuY29sb3JzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbG9ycyA9IFt0aGlzLmNvbG9yc1swXV07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBpZiAoISgoX2MgPSB0aGlzLmNvbG9ycykgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmxlbmd0aCkgJiYgbGFzdENvbG9ycy5yYW1wQ29sb3JzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb2xvcnMgPSB0aGlzLmVzcmlMYW5nLmNsb25lKGxhc3RDb2xvcnMucmFtcENvbG9ycyk7XG4gICAgICAgICAgICAgICAgdGhpcy5jaGFydE1lZGlhSW5mby52YWx1ZS5jb2xvcnMgPSB0aGlzLmVzcmlMYW5nLmNsb25lKHRoaXMuY29sb3JzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghKChfZCA9IHRoaXMuY29sb3JzKSA9PT0gbnVsbCB8fCBfZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2QubGVuZ3RoKSB8fCB0aGlzLmNvbG9ycy5sZW5ndGggIT09ICgoX2UgPSB0aGlzLmNoYXJ0TWVkaWFJbmZvKSA9PT0gbnVsbCB8fCBfZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2UudmFsdWUuZmllbGRzLmxlbmd0aCkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBkZWZhdWx0U2NoZW1lID0gdGhpcy5nZXREZWZhdWx0Q29sb3JTY2hlbWUoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbG9ycyA9IChfZiA9IHRoaXMuY2hhcnRNZWRpYUluZm8pID09PSBudWxsIHx8IF9mID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZi52YWx1ZS5maWVsZHMubWFwKChmaWVsZE5hbWUsIGlkeCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB2YXIgX2E7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZW5kZXJlckNvbG9ycy5nZXQoZmllbGROYW1lKVxuICAgICAgICAgICAgICAgICAgICAgICAgPyB0aGlzLmVzcmlMYW5nLmNsb25lKHJlbmRlcmVyQ29sb3JzLmdldChmaWVsZE5hbWUpWzBdKVxuICAgICAgICAgICAgICAgICAgICAgICAgOiAoKF9hID0gdGhpcy5jb2xvcnMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYVtpZHhdKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBlc3JpQ29sb3IoZGVmYXVsdFNjaGVtZS5jb2xvcnNbaWR4ICUgTUFYX1JBTVBfQ09MT1JTXSkgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgZXNyaUNvbG9yKFswLCAwLCAwLCAxXSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgZ2V0RGVmYXVsdENvbG9yU2NoZW1lKCkge1xuICAgICAgICBjb25zdCBzY2hlbWVzID0gdGhpcy5waWVDaGFydFNjaGVtZXMuZ2V0U2NoZW1lcyh7XG4gICAgICAgICAgICBiYXNlbWFwOiB0aGlzLm1hcFZpZXcubWFwLmJhc2VtYXAsXG4gICAgICAgICAgICBnZW9tZXRyeVR5cGU6IFwicG9seWdvblwiLFxuICAgICAgICAgICAgbnVtQ29sb3JzOiBNYXRoLm1pbihNQVhfUkFNUF9DT0xPUlMsIHRoaXMuY2hhcnRNZWRpYUluZm8udmFsdWUuZmllbGRzLmxlbmd0aClcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiAoW3NjaGVtZXMucHJpbWFyeVNjaGVtZV1cbiAgICAgICAgICAgIC5jb25jYXQoc2NoZW1lcy5zZWNvbmRhcnlTY2hlbWVzKVxuICAgICAgICAgICAgLmZpbmQoKHNjaGVtZSkgPT4gc2NoZW1lLm5hbWUgPT09IFwiT2x5bXBpYyBTdW5zZXRcIikgfHxcbiAgICAgICAgICAgIHNjaGVtZXMucHJpbWFyeVNjaGVtZSk7XG4gICAgfVxuICAgIGNsb3NlQ29sb3JQb3BvdmVyKCkge1xuICAgICAgICBpZiAodGhpcy5jb2xvclBvcG92ZXJOb2RlKSB7XG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuY29sb3JQb3BvdmVyTm9kZSk7XG4gICAgICAgICAgICB0aGlzLmNvbG9yUG9wb3Zlck5vZGUgPSBudWxsO1xuICAgICAgICB9XG4gICAgfVxuICAgIGdldCBob3N0RWxlbWVudCgpIHsgcmV0dXJuIGdldEVsZW1lbnQodGhpcyk7IH1cbn07XG5BcmNnaXNQb3B1cENoYXJ0LnN0eWxlID0gYXJjZ2lzUG9wdXBDaGFydENzcztcblxuY29uc3QgQXJjZ2lzUG9wdXBFeHByZXNzaW9ucyA9IGNsYXNzIHtcbiAgICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgICAgIHJlZ2lzdGVySW5zdGFuY2UodGhpcywgaG9zdFJlZik7XG4gICAgICAgIHRoaXMuYXJjYWRlQ2hhbmdlTm90aWZpY2F0aW9uID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNhZGVDaGFuZ2VOb3RpZmljYXRpb25cIiwgNyk7XG4gICAgICAgIHRoaXMuaW50ZXJuYWxQb3B1cFVwZGF0ZWQgPSBjcmVhdGVFdmVudCh0aGlzLCBcImludGVybmFsUG9wdXBVcGRhdGVkXCIsIDcpO1xuICAgICAgICB0aGlzLnZhbHVlTGlzdCA9IFtdO1xuICAgICAgICB0aGlzLmZpbHRlckxlbmd0aCA9IDU7XG4gICAgICAgIC8vIHJlbmRvciBtZXRob2RzXG4gICAgICAgIHRoaXMuY2FsY2l0ZVZhbHVlTGlzdCA9IChhcmNhZGVGaWVsZCkgPT4gKGgoXCJjYWxjaXRlLXZhbHVlLWxpc3QtaXRlbVwiLCB7IGxhYmVsOiBhcmNhZGVGaWVsZC50aXRsZSwgZGVzY3JpcHRpb246IGB7JHtmaWVsZEluZm9QcmVmaXhFbnVtLmV4cHJlc3Npb259JHthcmNhZGVGaWVsZC5uYW1lfX1gLCB2YWx1ZTogYXJjYWRlRmllbGQubmFtZSwgbWV0YWRhdGE6IHtcbiAgICAgICAgICAgICAgICB0aXRsZTogYXJjYWRlRmllbGQudGl0bGUsXG4gICAgICAgICAgICAgICAgbmFtZTogYHske2ZpZWxkSW5mb1ByZWZpeEVudW0uZXhwcmVzc2lvbn0ke2FyY2FkZUZpZWxkLm5hbWV9fWBcbiAgICAgICAgICAgIH0sIG9uQ2xpY2s6IChldmVudCkgPT4gdGhpcy5sYXVuY2hBcmNhZGUoZXZlbnQsIGFyY2FkZUZpZWxkKSB9LCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBzbG90OiBcImFjdGlvbnMtZW5kXCIsIGFwcGVhcmFuY2U6IFwidHJhbnNwYXJlbnRcIiwgdGV4dDogdGhpcy5zdHJpbmdzLnJlbW92ZSwgb25DbGljazogKGV2ZW50KSA9PiB0aGlzLnJlbW92ZUJ0bkNsaWNrKGV2ZW50LCBhcmNhZGVGaWVsZC5uYW1lKSB9LCBoKFwiY2FsY2l0ZS1pY29uXCIsIHsgc2NhbGU6IFwic1wiLCBpY29uOiBcInhcIiB9KSkpKTtcbiAgICAgICAgdGhpcy5yZVJlbmRlciA9IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgY29tcG9uZW50V2lsbExvYWQoKSB7XG4gICAgICAgIHRoaXMubGF5ZXIgPSBwb3B1cFN0YXRlLmxheWVyO1xuICAgICAgICB0aGlzLm1hcFZpZXcgPSBwb3B1cFN0YXRlLm1hcFZpZXc7XG4gICAgICAgIHRoaXMucG9ydGFsID0gcG9wdXBTdGF0ZS5wb3J0YWw7XG4gICAgICAgIHRoaXMuY29uZmlnID0gcG9wdXBTdGF0ZS5jb25maWc7XG4gICAgICAgIHRoaXMuc3RyaW5ncyA9IHBvcHVwU3RhdGUuc3RyaW5ncztcbiAgICAgICAgdGhpcy5jdXJyZW50TGFuZ3VhZ2UgPSBwb3B1cFN0YXRlLmN1cnJlbnRMYW5ndWFnZTtcbiAgICAgICAgdGhpcy5zZXJ2aWNlVHlwZSA9IHBvcHVwU3RhdGUuc2VydmljZVR5cGU7XG4gICAgICAgIHRoaXMucG9wdXBUZW1wbGF0ZSA9IHBvcHVwU3RhdGUucG9wdXBUZW1wbGF0ZTtcbiAgICAgICAgdGhpcy5sYXllckRpc3BsYXlUeXBlID0gcG9wdXBTdGF0ZS5sYXllckRpc3BsYXlUeXBlO1xuICAgIH1cbiAgICAvLyBsaWZlY3ljbGUgbWV0aG9kc1xuICAgIGFzeW5jIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgICAgIGF3YWl0IHRoaXMubG9hZEFsbE1vZHVsZXMoKTtcbiAgICB9XG4gICAgY29tcG9uZW50V2lsbFJlbmRlcigpIHtcbiAgICAgICAgdmFyIF9hO1xuICAgICAgICB0aGlzLnZhbHVlTGlzdCA9IFtdO1xuICAgICAgICBpZiAoKF9hID0gdGhpcy5wb3B1cFRlbXBsYXRlLmV4cHJlc3Npb25JbmZvcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkge1xuICAgICAgICAgICAgdGhpcy5wb3B1cFRlbXBsYXRlLmV4cHJlc3Npb25JbmZvcy5mb3JFYWNoKChhcmNhZGVGaWVsZCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMudmFsdWVMaXN0LnB1c2godGhpcy5jYWxjaXRlVmFsdWVMaXN0KGFyY2FkZUZpZWxkKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICAvLyBQdWJsaWMgTWV0aG9kc1xuICAgIGFzeW5jIHNldEZvY3VzKCkge1xuICAgICAgICB0aGlzLmV4cHJlc3Npb25GbG93SXRlbS5zZXRGb2N1cygpO1xuICAgIH1cbiAgICAvLyBwcml2YXRlIG1ldGhvZHMgYW5kIHByb3BlcnRpZXNcbiAgICBhc3luYyBsb2FkQWxsTW9kdWxlcygpIHtcbiAgICAgICAgW3RoaXMuRmllbGRJbmZvLCB0aGlzLlBvcHVwRXhwcmVzc2lvbkluZm9dID0gYXdhaXQgbG9hZE1vZHVsZXMoW1xuICAgICAgICAgICAgXCJlc3JpL3BvcHVwL0ZpZWxkSW5mb1wiLFxuICAgICAgICAgICAgXCJlc3JpL3BvcHVwL0V4cHJlc3Npb25JbmZvXCJcbiAgICAgICAgXSk7XG4gICAgfVxuICAgIGFzeW5jIGxhdW5jaEFyY2FkZShldmVudCwgY3VycmVudEV4cHJlc3Npb24pIHtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGlmICghdGhpcy5hcmNhZGVFZGl0b3IpIHtcbiAgICAgICAgICAgIHRoaXMuZXhwcmVzc2lvbkZsb3dJdGVtLmRpc2FibGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuYXJjYWRlRWRpdG9yID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1tb2RhbC1hcmNhZGVcIik7XG4gICAgICAgICAgICB0aGlzLmFyY2FkZUVkaXRvci5hcmNhZGVTY3JpcHQgPSBnZXRBcmNhZGVTY3JpcHQoY3VycmVudEV4cHJlc3Npb24gPT09IG51bGwgfHwgY3VycmVudEV4cHJlc3Npb24gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGN1cnJlbnRFeHByZXNzaW9uLmV4cHJlc3Npb24sIHRoaXMubGF5ZXJEaXNwbGF5VHlwZSwgdGhpcy5zdHJpbmdzKTtcbiAgICAgICAgICAgIHRoaXMuYXJjYWRlRWRpdG9yLmFyY2FkZVByb2ZpbGUgPSBhd2FpdCBnZXRBcmNhZGVQcm9maWxlKHRoaXMubGF5ZXIsIHRoaXMubWFwVmlldywgdGhpcy5zZXJ2aWNlVHlwZSwgdGhpcy5wb3B1cFRlbXBsYXRlLCB0aGlzLmxheWVyRGlzcGxheVR5cGUpO1xuICAgICAgICAgICAgdGhpcy5hcmNhZGVFZGl0b3IudGVzdERhdGEgPSBhd2FpdCBnZXRUZXN0RGF0YSh0aGlzLmxheWVyLCB0aGlzLm1hcFZpZXcsIHRoaXMubGF5ZXJEaXNwbGF5VHlwZSwgdGhpcy5wb3B1cFRlbXBsYXRlKTtcbiAgICAgICAgICAgIHRoaXMuYXJjYWRlRWRpdG9yLmFkZEV4aXN0aW5nRXhwcmVzc2lvbnMgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5hcmNhZGVFZGl0b3IubGF5ZXIgPSB0aGlzLmxheWVyO1xuICAgICAgICAgICAgdGhpcy5hcmNhZGVFZGl0b3IuYXJjYWRlVGl0bGUgPSAoY3VycmVudEV4cHJlc3Npb24gPT09IG51bGwgfHwgY3VycmVudEV4cHJlc3Npb24gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGN1cnJlbnRFeHByZXNzaW9uLnRpdGxlKSB8fCB0aGlzLnN0cmluZ3MuYXJjYWRlRGVmYXVsdFRpdGxlO1xuICAgICAgICAgICAgdGhpcy5hcmNhZGVFZGl0b3IuYXJjYWRlVGl0bGVFZGl0YWJsZSA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmFyY2FkZUVkaXRvci5hcmNhZGVUaXRsZUVkaXRpbmdFbmFibGVkID0gIShjdXJyZW50RXhwcmVzc2lvbiA9PT0gbnVsbCB8fCBjdXJyZW50RXhwcmVzc2lvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogY3VycmVudEV4cHJlc3Npb24udGl0bGUpO1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLmFyY2FkZUVkaXRvcik7XG4gICAgICAgICAgICB0aGlzLmFyY2FkZUVkaXRvci5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzTW9kYWxBcmNhZGVDbG9zZVwiLCAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmFyY2FkZVNldHVwKGV2ZW50LmRldGFpbCwgY3VycmVudEV4cHJlc3Npb24pO1xuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5mYWJCdXR0b25Ob2RlLnNldEZvY3VzKCksIDMwMCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBhc3luYyBhcmNhZGVTZXR1cChhcmNhZGVPYmplY3QsIGN1cnJlbnRFeHByZXNzaW9uKSB7XG4gICAgICAgIGlmIChhcmNhZGVPYmplY3QpIHtcbiAgICAgICAgICAgIHNldEV4cHJlc3Npb25JbmZvSW5Qb3B1cFRlbXBsYXRlKGFyY2FkZU9iamVjdCwgY3VycmVudEV4cHJlc3Npb24gPT09IG51bGwgfHwgY3VycmVudEV4cHJlc3Npb24gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGN1cnJlbnRFeHByZXNzaW9uLm5hbWUsIHRoaXMuUG9wdXBFeHByZXNzaW9uSW5mbywgdGhpcy5wb3B1cFRlbXBsYXRlKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMucG9wdXBFeHByZXNzaW9uU2V0dXAoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmV4cHJlc3Npb25GbG93SXRlbS5kaXNhYmxlZCA9IGZhbHNlO1xuICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuYXJjYWRlRWRpdG9yKTtcbiAgICAgICAgdGhpcy5hcmNhZGVFZGl0b3IgPSBudWxsO1xuICAgIH1cbiAgICAvLyB1cGRhdGUgbWFzdGVyIGZpZWxkIGluZm8gYW5kIGVtaXQgZm9yIGF0dHJpYnV0ZXMgcmUtcmVuZGVyLCBzZWxmIHJlLXJlbmRlciBhbmQgdXBkYXRlIHBvcHVwXG4gICAgYXN5bmMgcG9wdXBFeHByZXNzaW9uU2V0dXAoKSB7XG4gICAgICAgIGF3YWl0IHNldExheWVyRXhwcmVzc2lvbkFuZEZpZWxkSW5mbyh0aGlzLnBvcHVwVGVtcGxhdGUsIHRoaXMubGF5ZXJEaXNwbGF5VHlwZSwgdGhpcy5sYXllciwgdGhpcy5GaWVsZEluZm8pO1xuICAgICAgICB0aGlzLmFyY2FkZUNoYW5nZU5vdGlmaWNhdGlvbi5lbWl0KCk7XG4gICAgICAgIHRoaXMuaW50ZXJuYWxQb3B1cFVwZGF0ZWQuZW1pdCgpO1xuICAgICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgfVxuICAgIHJlbW92ZUJ0bkNsaWNrKGV2ZW50LCBmaWVsZE5hbWUpIHtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIHRoaXMucG9wdXBUZW1wbGF0ZS5leHByZXNzaW9uSW5mb3MuZmluZCgoZXhwLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgaWYgKGV4cC5uYW1lID09PSBmaWVsZE5hbWUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5wb3B1cFRlbXBsYXRlLmV4cHJlc3Npb25JbmZvcy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5wb3B1cEV4cHJlc3Npb25TZXR1cCgpO1xuICAgIH1cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgY29uc3QgYWRkRXhwcmVzc2lvbkJ0biA9IChoKFwiY2FsY2l0ZS1mYWJcIiwgeyBzbG90OiBcImZhYlwiLCBjbGFzczogXCJmYWJcIiwgaWNvbjogXCJwbHVzXCIsIHNjYWxlOiBcInNcIiwgYXBwZWFyYW5jZTogXCJvdXRsaW5lLWZpbGxcIiwga2luZDogXCJuZXV0cmFsXCIsIGxhYmVsOiB0aGlzLnN0cmluZ3MuYWRkRXhwcmVzc2lvbiwgdGV4dDogdGhpcy5zdHJpbmdzLmFkZEV4cHJlc3Npb24sIFwidGV4dC1lbmFibGVkXCI6IHRydWUsIG9uQ2xpY2s6IChldmVudCkgPT4gdGhpcy5sYXVuY2hBcmNhZGUoZXZlbnQpLCByZWY6IChub2RlKSA9PiAodGhpcy5mYWJCdXR0b25Ob2RlID0gbm9kZSkgfSkpO1xuICAgICAgICByZXR1cm4gKGgoSG9zdCwgeyBjbGFzczogXCJjYWxjaXRlLW1hdGNoLWhlaWdodFwiIH0sIGgoXCJjYWxjaXRlLWZsb3ctaXRlbVwiLCB7IGRpcjogZ2V0RWxlbWVudERpcih0aGlzLmhvc3RFbGVtZW50KSwgaGVhZGluZzogdGhpcy5zdHJpbmdzLm1hbmFnZUV4cHJlc3Npb25zLCByZWY6IChub2RlKSA9PiAodGhpcy5leHByZXNzaW9uRmxvd0l0ZW0gPSBub2RlKSB9LCAoKF9hID0gdGhpcy5wb3B1cFRlbXBsYXRlLmV4cHJlc3Npb25JbmZvcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmxlbmd0aCkgPiAwICYmIChoKFwiY2FsY2l0ZS12YWx1ZS1saXN0XCIsIHsgZmlsdGVyRW5hYmxlZDogdGhpcy52YWx1ZUxpc3QubGVuZ3RoID49IHRoaXMuZmlsdGVyTGVuZ3RoID8gdHJ1ZSA6IGZhbHNlIH0sIHRoaXMudmFsdWVMaXN0KSksIGFkZEV4cHJlc3Npb25CdG4pKSk7XG4gICAgfVxuICAgIGdldCBob3N0RWxlbWVudCgpIHsgcmV0dXJuIGdldEVsZW1lbnQodGhpcyk7IH1cbn07XG5cbmNvbnN0IGFyY2dpc1BvcHVwRmllbGRQaWNrTGlzdENzcyA9IFwiLnBvcG92ZXJ7ei1pbmRleDoxMDB9LnBhbmVse21pbi1oZWlnaHQ6MzAwcHh9LmNvbnRlbnR7bWF4LWhlaWdodDpjYWxjKDYwdmggLSAxNDJweCk7fS5zZWxlY3Rpb24tYnV0dG9uLWRpdntwYWRkaW5nOjRweCAxMHB4fS5mb290ZXJ7d2lkdGg6MTAwJX0uZXhwcmVzc2lvbi1hY3Rpb25ze2Rpc3BsYXk6ZmxleH0uYWRkLWV4cHJlc3Npb24tYnV0dG9ue21hcmdpbjo0cHggMCA4cHh9XCI7XG5cbmNvbnN0IEFyY2dpc1BvcHVwRmllbGRQaWNrTGlzdCA9IGNsYXNzIHtcbiAgICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgICAgIHJlZ2lzdGVySW5zdGFuY2UodGhpcywgaG9zdFJlZik7XG4gICAgICAgIHRoaXMuYXJjZ2lzUG9wdXBQaWNrTGlzdERpc21pc3NlZCA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzUG9wdXBQaWNrTGlzdERpc21pc3NlZFwiLCA3KTtcbiAgICAgICAgdGhpcy5hcmNnaXNQb3B1cFBpY2tMaXN0Q2hhbmdlID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNQb3B1cFBpY2tMaXN0Q2hhbmdlXCIsIDcpO1xuICAgICAgICB0aGlzLmFyY2FkZUNoYW5nZU5vdGlmaWNhdGlvbiA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjYWRlQ2hhbmdlTm90aWZpY2F0aW9uXCIsIDcpO1xuICAgICAgICB0aGlzLmFyY2FkZUV4cE1hcCA9IG5ldyBNYXAoKTtcbiAgICAgICAgdGhpcy5jYWxjaXRlRmllbGRPbmx5VmFsdWVMaXN0ID0gKGZpZWxkKSA9PiAoaChcImNhbGNpdGUtcGljay1saXN0LWl0ZW1cIiwgeyBrZXk6IGZpZWxkLm5hbWUsIGxhYmVsOiBmaWVsZC5hbGlhcyB8fCBmaWVsZC5uYW1lLCB2YWx1ZTogZmllbGQubmFtZSwgZGVzY3JpcHRpb246IGB7JHtmaWVsZC5uYW1lfX1gLCBzZWxlY3RlZDogKCF0aGlzLm11bHRpcGxlICYmIGZpZWxkLm5hbWUgPT09IHRoaXMuc2VsZWN0ZWRGaWVsZHNbMF0pIHx8XG4gICAgICAgICAgICAgICAgKHRoaXMubXVsdGlwbGUgJiYgdGhpcy5zZWxlY3RlZEZpZWxkcy5pbmRleE9mKGZpZWxkLm5hbWUpID4gLTEpLCBtZXRhZGF0YToge1xuICAgICAgICAgICAgICAgIGxhYmVsOiBmaWVsZC5hbGlhcyxcbiAgICAgICAgICAgICAgICBmaWVsZE5hbWU6IGZpZWxkLm5hbWVcbiAgICAgICAgICAgIH0gfSwgdGhpcy5sYXllckRpc3BsYXlUeXBlID09PSBsYXllckRpc3BsYXlUeXBlRW51bS5mZWF0dXJlICYmXG4gICAgICAgICAgICAhZmllbGQubmFtZS5pbmNsdWRlcyhmaWVsZEluZm9QcmVmaXhFbnVtLnJlbGF0aW9uc2hpcCkgJiYgKGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IHNsb3Q6IFwiYWN0aW9ucy1lbmRcIiwgdGV4dDogdGhpcy5zdHJpbmdzLmluZm8sIHRpdGxlOiB0aGlzLnN0cmluZ3MuaW5mbywgc2NhbGU6IFwic1wiLCBpY29uOiBcImluZm9ybWF0aW9uXCIsIG9uQ2xpY2s6IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIHZhciBfYTtcbiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICBjb25zdCBhY3Rpb24gPSBldmVudC50YXJnZXQ7XG4gICAgICAgICAgICAgICAgY29uc3QgZmllbGRJbmZvRmxvd0l0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiY2FsY2l0ZS1mbG93LWl0ZW1cIik7XG4gICAgICAgICAgICAgICAgZmllbGRJbmZvRmxvd0l0ZW0uaGVhZGluZyA9IChfYSA9IGZpZWxkLmFsaWFzKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiBmaWVsZC5uYW1lO1xuICAgICAgICAgICAgICAgIGZpZWxkSW5mb0Zsb3dJdGVtLmRlc2NyaXB0aW9uID0gZmllbGQubmFtZTtcbiAgICAgICAgICAgICAgICBjb25zdCBmaWVsZEluZm8gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLWZpZWxkLWluZm9cIik7XG4gICAgICAgICAgICAgICAgZmllbGRJbmZvLmxhbmcgPSB0aGlzLmN1cnJlbnRMYW5ndWFnZUludGw7XG4gICAgICAgICAgICAgICAgZmllbGRJbmZvLmZpZWxkTmFtZSA9IGZpZWxkLm5hbWU7XG4gICAgICAgICAgICAgICAgZmllbGRJbmZvLmxheWVyID0gdGhpcy5sYXllcjtcbiAgICAgICAgICAgICAgICBmaWVsZEluZm8udmlldyA9IHRoaXMubWFwVmlldztcbiAgICAgICAgICAgICAgICBmaWVsZEluZm8uY2xhc3NMaXN0LmFkZChcImNvbnRlbnRcIik7XG4gICAgICAgICAgICAgICAgZmllbGRJbmZvRmxvd0l0ZW0uYWRkRXZlbnRMaXN0ZW5lcihcImNhbGNpdGVGbG93SXRlbUJhY2tcIiwgKCkgPT4gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IGFjdGlvbi5zZXRGb2N1cygpKSk7XG4gICAgICAgICAgICAgICAgZmllbGRJbmZvRmxvd0l0ZW0uYXBwZW5kQ2hpbGQoZmllbGRJbmZvKTtcbiAgICAgICAgICAgICAgICB0aGlzLmZsb3dFbGVtZW50LmFwcGVuZENoaWxkKGZpZWxkSW5mb0Zsb3dJdGVtKTtcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGZpZWxkSW5mb0Zsb3dJdGVtLnNldEZvY3VzKCksIDIwMCk7XG4gICAgICAgICAgICB9IH0pKSkpO1xuICAgICAgICB0aGlzLmNhbGNpdGVFeHByZXNzaW9uc09ubHlWYWx1ZUxpc3QgPSAoZmllbGQpID0+IChoKFwiY2FsY2l0ZS1waWNrLWxpc3QtaXRlbVwiLCB7IGtleTogZmllbGQubmFtZSwgbGFiZWw6IGZpZWxkLmFsaWFzIHx8IGZpZWxkLm5hbWUsIHZhbHVlOiBmaWVsZC5uYW1lLCBkZXNjcmlwdGlvbjogYHske2ZpZWxkLm5hbWV9fWAsIHNlbGVjdGVkOiAoIXRoaXMubXVsdGlwbGUgJiYgZmllbGQubmFtZSA9PT0gdGhpcy5zZWxlY3RlZEZpZWxkc1swXSkgfHxcbiAgICAgICAgICAgICAgICAodGhpcy5tdWx0aXBsZSAmJiB0aGlzLnNlbGVjdGVkRmllbGRzLmluZGV4T2YoZmllbGQubmFtZSkgPiAtMSksIG1ldGFkYXRhOiB7XG4gICAgICAgICAgICAgICAgbGFiZWw6IGZpZWxkLmFsaWFzLFxuICAgICAgICAgICAgICAgIGZpZWxkTmFtZTogZmllbGQubmFtZVxuICAgICAgICAgICAgfSB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IFwiZXhwcmVzc2lvbi1hY3Rpb25zXCIsIHNsb3Q6IFwiYWN0aW9ucy1lbmRcIiB9LCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyB0ZXh0OiB0aGlzLnN0cmluZ3MuZWRpdCwgdGl0bGU6IHRoaXMuc3RyaW5ncy5lZGl0LCBzY2FsZTogXCJzXCIsIGljb246IHRoaXMubnVtYmVyc09ubHkgJiYgZmllbGQudHlwZS50b0xvd2VyQ2FzZSgpICE9PSBmaWVsZFR5cGVzRW51bS5udW1iZXJcbiAgICAgICAgICAgICAgICA/IFwiZXhjbGFtYXRpb24tbWFyay10cmlhbmdsZVwiXG4gICAgICAgICAgICAgICAgOiBcInBlbmNpbFwiLCBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuYXJjYWRlRXhwTWFwLmhhcyhmaWVsZC5uYW1lKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxhdW5jaEFyY2FkZSh0aGlzLmFyY2FkZUV4cE1hcC5nZXQoZmllbGQubmFtZSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gfSksIGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IHRleHQ6IHRoaXMuc3RyaW5ncy5yZW1vdmUsIHRpdGxlOiB0aGlzLnN0cmluZ3MucmVtb3ZlLCBzY2FsZTogXCJzXCIsIGljb246IFwidHJhc2hcIiwgb25DbGljazogYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMucG9wdXBUZW1wbGF0ZS5leHByZXNzaW9uSW5mb3MuZmluZCgoZXhwLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZmllbGQubmFtZS5pbmNsdWRlcyhgLyR7ZXhwLm5hbWV9YCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnBvcHVwVGVtcGxhdGUuZXhwcmVzc2lvbkluZm9zLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBhd2FpdCBzZXRMYXllckV4cHJlc3Npb25BbmRGaWVsZEluZm8odGhpcy5wb3B1cFRlbXBsYXRlLCB0aGlzLmxheWVyRGlzcGxheVR5cGUsIHRoaXMubGF5ZXIsIHRoaXMuRmllbGRJbmZvKTtcbiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkcyA9IHRoaXMuZmllbGRzLmZpbHRlcigoY3VyckZpZWxkKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjdXJyRmllbGQubmFtZSAhPT0gZmllbGQubmFtZTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkRmllbGRzID0gWy4uLnRoaXMuc2VsZWN0ZWRGaWVsZHNdLmZpbHRlcigoZmllbGROYW1lKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmaWVsZE5hbWUgIT09IGZpZWxkLm5hbWU7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdGhpcy5tdWx0aXBsZSAmJlxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFyY2dpc1BvcHVwUGlja0xpc3RDaGFuZ2UuZW1pdCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEZpZWxkczogWy4uLm5ldyBTZXQodGhpcy5zZWxlY3RlZEZpZWxkcyldXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHRoaXMuYXJjYWRlQ2hhbmdlTm90aWZpY2F0aW9uLmVtaXQoKTtcbiAgICAgICAgICAgIH0gfSkpKSk7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWRGaWVsZHMgPSBbXTtcbiAgICAgICAgdGhpcy5wb3BvdmVyUHJvcHMgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuc2hvd0NhbmNlbCA9IHRydWU7XG4gICAgICAgIHRoaXMubXVsdGlwbGUgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5oZWFkaW5nID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLm9rQnRuVGV4dCA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5zaG93RmlsdGVyTGVuZ3RoID0gNTtcbiAgICAgICAgdGhpcy5udW1iZXJzT25seSA9IGZhbHNlO1xuICAgICAgICB0aGlzLmxhc3RTb3J0eUJ5ID0gTGFzdFNvcnR5QnkuZGVmYXVsdDtcbiAgICAgICAgdGhpcy5maWx0ZXJGaWVsZHMgPSBudWxsO1xuICAgICAgICB0aGlzLmFyY2FkZUVkaXRvciA9IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvL1xuICAgIC8vICBMaWZlY3ljbGVcbiAgICAvL1xuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgYXN5bmMgY29tcG9uZW50V2lsbExvYWQoKSB7XG4gICAgICAgIHRoaXMubGF5ZXIgPSBwb3B1cFN0YXRlLmxheWVyO1xuICAgICAgICB0aGlzLm1hcFZpZXcgPSBwb3B1cFN0YXRlLm1hcFZpZXc7XG4gICAgICAgIHRoaXMucG9ydGFsID0gcG9wdXBTdGF0ZS5wb3J0YWw7XG4gICAgICAgIHRoaXMuY29uZmlnID0gcG9wdXBTdGF0ZS5jb25maWc7XG4gICAgICAgIHRoaXMuc3RyaW5ncyA9IHBvcHVwU3RhdGUuc3RyaW5ncztcbiAgICAgICAgdGhpcy5jdXJyZW50TGFuZ3VhZ2UgPSBwb3B1cFN0YXRlLmN1cnJlbnRMYW5ndWFnZTtcbiAgICAgICAgdGhpcy5jdXJyZW50TGFuZ3VhZ2VJbnRsID0gcG9wdXBTdGF0ZS5jdXJyZW50TGFuZ3VhZ2VJbnRsO1xuICAgICAgICB0aGlzLnNlcnZpY2VUeXBlID0gcG9wdXBTdGF0ZS5zZXJ2aWNlVHlwZTtcbiAgICAgICAgdGhpcy5wb3B1cFRlbXBsYXRlID0gcG9wdXBTdGF0ZS5wb3B1cFRlbXBsYXRlO1xuICAgICAgICB0aGlzLmxheWVyRGlzcGxheVR5cGUgPSBwb3B1cFN0YXRlLmxheWVyRGlzcGxheVR5cGU7XG4gICAgICAgIHRoaXMuc3VwcG9ydHNBcmNhZGUgPSBwb3B1cFN0YXRlLnN1cHBvcnRzQXJjYWRlO1xuICAgICAgICB0aGlzLmxheWVyRmllbGRzTWFwID0gYXdhaXQgZ2VuZXJhdGVMYXllckZpZWxkc01hcCh0aGlzLmxheWVyKTtcbiAgICAgICAgdGhpcy5hcmNhZGVFeHBNYXAgPSBnZW5lcmF0ZUFyY2FkZUV4cHJlc3Npb25NYXAodGhpcy5wb3B1cFRlbXBsYXRlKTtcbiAgICAgICAgdGhpcy5maWVsZHMgPSBhd2FpdCB0aGlzLmdldEZpZWxkcygpO1xuICAgICAgICAvLyBpbiBjYXNlIG1vcmUgdGhhbiAxIHNlbGVjdGVkIGZpZWxkIGFuZCBtdWx0aXBsZSBpcyBzZXQgdG8gZmFsc2VcbiAgICAgICAgaWYgKCF0aGlzLm11bHRpcGxlICYmIHRoaXMuc2VsZWN0ZWRGaWVsZHMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgdGhpcy5zZWxlY3RlZEZpZWxkcyA9IFt0aGlzLnNlbGVjdGVkRmllbGRzWzBdXTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBhc3luYyBjb21wb25lbnREaWRMb2FkKCkge1xuICAgICAgICBhd2FpdCB0aGlzLmxvYWRBbGxNb2R1bGVzKCk7XG4gICAgICAgIHRoaXMucG9wb3Zlck5vZGUub3BlbiA9IHRydWU7XG4gICAgICAgIC8vIG5lZWQgdGltZW91dCBiZWNhdXNlIG9mIHJlLXJlbmRlclxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB0aGlzLmZsb3dJdGVtRWxlbWVudC5zZXRGb2N1cygpKSwgMjAwKTtcbiAgICB9XG4gICAgY29tcG9uZW50V2lsbFJlbmRlcigpIHtcbiAgICAgICAgdGhpcy5hcmNhZGVFeHBNYXAgPSBnZW5lcmF0ZUFyY2FkZUV4cHJlc3Npb25NYXAodGhpcy5wb3B1cFRlbXBsYXRlKTtcbiAgICAgICAgdGhpcy5maWVsZHNPbmx5ID0gWy4uLnRoaXMuZ2V0U29ydGVkTGlzdCgpXS5maWx0ZXIoKGZpZWxkKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gIWZpZWxkLm5hbWUuaW5jbHVkZXMoZmllbGRJbmZvUHJlZml4RW51bS5leHByZXNzaW9uKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuZXhwcmVzc2lvbnNPbmx5ID0gWy4uLnRoaXMuZ2V0U29ydGVkTGlzdCgpXS5maWx0ZXIoKGZpZWxkKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gZmllbGQubmFtZS5pbmNsdWRlcyhmaWVsZEluZm9QcmVmaXhFbnVtLmV4cHJlc3Npb24pO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgLy8gUHVibGljIE1ldGhvZHNcbiAgICBhc3luYyByZXBvc2l0aW9uKCkge1xuICAgICAgICB2YXIgX2E7XG4gICAgICAgIChfYSA9IHRoaXMucG9wb3Zlck5vZGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5yZXBvc2l0aW9uKCk7XG4gICAgfVxuICAgIC8vIHRlbXA6IGh0dHBzOi8vZ2l0aHViLmNvbS9Fc3JpL2NhbGNpdGUtY29tcG9uZW50cy9pc3N1ZXMvNDMzM1xuICAgIGNhbGNpdGVGaWx0ZXJDaGFuZ2VIYW5kbGVyKGV2ZW50KSB7XG4gICAgICAgIHZhciBfYSwgX2I7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBjb25zdCBmaWx0ZXJOb2RlID0gKF9hID0gZXZlbnQgPT09IG51bGwgfHwgZXZlbnQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGV2ZW50LnBhdGgpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5maW5kKChpdGVtKSA9PiBpdGVtLm5vZGVOYW1lID09PSBcIkNBTENJVEUtRklMVEVSXCIpO1xuICAgICAgICB0aGlzLmZpbHRlckZpZWxkcyA9IChfYiA9IGZpbHRlck5vZGUgPT09IG51bGwgfHwgZmlsdGVyTm9kZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmlsdGVyTm9kZS5maWx0ZXJlZEl0ZW1zKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IubWFwKChpdGVtKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gaXRlbS52YWx1ZTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy9cbiAgICAvLyBQcml2YXRlIE1ldGhvZHNcbiAgICAvL1xuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgZ2V0U29ydGVkTGlzdCgpIHtcbiAgICAgICAgY29uc3QgdGVtcFNvcnRlZCA9IFsuLi50aGlzLmZpZWxkc107XG4gICAgICAgIGlmICh0aGlzLmxhc3RTb3J0eUJ5ID09PSBMYXN0U29ydHlCeS5kaXNwbGF5KSB7XG4gICAgICAgICAgICB0ZW1wU29ydGVkLnNvcnQoKGEsIGIpID0+IGEuYWxpYXMubG9jYWxlQ29tcGFyZShiLmFsaWFzKSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAodGhpcy5sYXN0U29ydHlCeSA9PT0gTGFzdFNvcnR5QnkuZmllbGQpIHtcbiAgICAgICAgICAgIHRlbXBTb3J0ZWQuc29ydCgoYSwgYikgPT4gYS5uYW1lLmxvY2FsZUNvbXBhcmUoYi5uYW1lKSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAodGhpcy5sYXN0U29ydHlCeSA9PT0gTGFzdFNvcnR5QnkudHlwZSkge1xuICAgICAgICAgICAgdGVtcFNvcnRlZC5zb3J0KChhLCBiKSA9PiBhLnR5cGUubG9jYWxlQ29tcGFyZShiLnR5cGUpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGVtcFNvcnRlZDtcbiAgICB9XG4gICAgLy8gcmV0dXJuIHRydWUgZm9yIGRlc2VsZWN0IGFsbCwgZmFsc2UgZm9yIHNlbGVjdCBhbGxcbiAgICBzZWxlY3REZXNlbGVjdCgpIHtcbiAgICAgICAgdmFyIF9hO1xuICAgICAgICByZXR1cm4gKChfYSA9IHRoaXMuZmlsdGVyRmllbGRzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKVxuICAgICAgICAgICAgPyB0aGlzLmZpbHRlckNvbnRhaW5zQWxsKClcbiAgICAgICAgICAgIDogdGhpcy5zZWxlY3RlZEZpZWxkcy5sZW5ndGggPT09IHRoaXMuZmllbGRzLmxlbmd0aDtcbiAgICB9XG4gICAgLy8gY2hlY2sgaWYgZmlsdGVyIGhhcyBhbGwgY3VycmVudCBmaWVsZCBpbmZvXG4gICAgZmlsdGVyQ29udGFpbnNBbGwoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmZpbHRlckZpZWxkcy5ldmVyeSgoZmlsdGVyKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZWxlY3RlZEZpZWxkcy5zb21lKChjdXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGN1cnIgPT09IGZpbHRlcjtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgYXN5bmMgbG9hZEFsbE1vZHVsZXMoKSB7XG4gICAgICAgIFt0aGlzLlBvcHVwRXhwcmVzc2lvbkluZm8sIHRoaXMuRmllbGRJbmZvXSA9IGF3YWl0IGxvYWRNb2R1bGVzKFtcbiAgICAgICAgICAgIFwiZXNyaS9wb3B1cC9FeHByZXNzaW9uSW5mb1wiLFxuICAgICAgICAgICAgXCJlc3JpL3BvcHVwL0ZpZWxkSW5mb1wiXG4gICAgICAgIF0pO1xuICAgIH1cbiAgICBhc3luYyBsYXVuY2hBcmNhZGUoY3VycmVudEV4cHJlc3Npb24pIHtcbiAgICAgICAgaWYgKCF0aGlzLmFyY2FkZUVkaXRvcikge1xuICAgICAgICAgICAgdGhpcy5mbG93SXRlbUVsZW1lbnQuZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5hcmNhZGVFZGl0b3IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLW1vZGFsLWFyY2FkZVwiKTtcbiAgICAgICAgICAgIHRoaXMuYXJjYWRlRWRpdG9yLmFyY2FkZVNjcmlwdCA9IGdldEFyY2FkZVNjcmlwdChjdXJyZW50RXhwcmVzc2lvbiA9PT0gbnVsbCB8fCBjdXJyZW50RXhwcmVzc2lvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogY3VycmVudEV4cHJlc3Npb24uZXhwcmVzc2lvbiwgdGhpcy5sYXllckRpc3BsYXlUeXBlLCB0aGlzLnN0cmluZ3MpO1xuICAgICAgICAgICAgdGhpcy5hcmNhZGVFZGl0b3IuYXJjYWRlUHJvZmlsZSA9IGF3YWl0IGdldEFyY2FkZVByb2ZpbGUodGhpcy5sYXllciwgdGhpcy5tYXBWaWV3LCB0aGlzLnNlcnZpY2VUeXBlLCB0aGlzLnBvcHVwVGVtcGxhdGUsIHRoaXMubGF5ZXJEaXNwbGF5VHlwZSk7XG4gICAgICAgICAgICB0aGlzLmFyY2FkZUVkaXRvci50ZXN0RGF0YSA9IGF3YWl0IGdldFRlc3REYXRhKHRoaXMubGF5ZXIsIHRoaXMubWFwVmlldywgdGhpcy5sYXllckRpc3BsYXlUeXBlLCB0aGlzLnBvcHVwVGVtcGxhdGUpO1xuICAgICAgICAgICAgdGhpcy5hcmNhZGVFZGl0b3IuYWRkRXhpc3RpbmdFeHByZXNzaW9ucyA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmFyY2FkZUVkaXRvci5sYXllciA9IHRoaXMubGF5ZXI7XG4gICAgICAgICAgICB0aGlzLmFyY2FkZUVkaXRvci5hcmNhZGVUaXRsZSA9IChjdXJyZW50RXhwcmVzc2lvbiA9PT0gbnVsbCB8fCBjdXJyZW50RXhwcmVzc2lvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogY3VycmVudEV4cHJlc3Npb24udGl0bGUpIHx8IHRoaXMuc3RyaW5ncy5hcmNhZGVEZWZhdWx0VGl0bGU7XG4gICAgICAgICAgICB0aGlzLmFyY2FkZUVkaXRvci5hcmNhZGVUaXRsZUVkaXRhYmxlID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuYXJjYWRlRWRpdG9yLmFyY2FkZVRpdGxlRWRpdGluZ0VuYWJsZWQgPSAhKGN1cnJlbnRFeHByZXNzaW9uID09PSBudWxsIHx8IGN1cnJlbnRFeHByZXNzaW9uID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjdXJyZW50RXhwcmVzc2lvbi50aXRsZSk7XG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMuYXJjYWRlRWRpdG9yKTtcbiAgICAgICAgICAgIHRoaXMuYXJjYWRlRWRpdG9yLmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNNb2RhbEFyY2FkZUNsb3NlXCIsIChldmVudCkgPT4gdGhpcy5hcmNhZGVTZXR1cChldmVudC5kZXRhaWwsIGN1cnJlbnRFeHByZXNzaW9uKSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgYXN5bmMgYXJjYWRlU2V0dXAoYXJjYWRlT2JqZWN0LCBjdXJyZW50RXhwcmVzc2lvbikge1xuICAgICAgICBpZiAoYXJjYWRlT2JqZWN0KSB7XG4gICAgICAgICAgICBjb25zdCBwb3B1cEV4cHJlc3Npb24gPSBzZXRFeHByZXNzaW9uSW5mb0luUG9wdXBUZW1wbGF0ZShhcmNhZGVPYmplY3QsIGN1cnJlbnRFeHByZXNzaW9uID09PSBudWxsIHx8IGN1cnJlbnRFeHByZXNzaW9uID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjdXJyZW50RXhwcmVzc2lvbi5uYW1lLCB0aGlzLlBvcHVwRXhwcmVzc2lvbkluZm8sIHRoaXMucG9wdXBUZW1wbGF0ZSk7XG4gICAgICAgICAgICBhd2FpdCBzZXRMYXllckV4cHJlc3Npb25BbmRGaWVsZEluZm8odGhpcy5wb3B1cFRlbXBsYXRlLCB0aGlzLmxheWVyRGlzcGxheVR5cGUsIHRoaXMubGF5ZXIsIHRoaXMuRmllbGRJbmZvKTtcbiAgICAgICAgICAgIGNvbnN0IGV4cE5hbWUgPSBgJHtmaWVsZEluZm9QcmVmaXhFbnVtLmV4cHJlc3Npb259JHtwb3B1cEV4cHJlc3Npb24ubmFtZX1gO1xuICAgICAgICAgICAgdGhpcy5maWVsZHMucHVzaCh7XG4gICAgICAgICAgICAgICAgbmFtZTogZXhwTmFtZSxcbiAgICAgICAgICAgICAgICBhbGlhczogcG9wdXBFeHByZXNzaW9uLnRpdGxlLFxuICAgICAgICAgICAgICAgIHR5cGU6IHBvcHVwRXhwcmVzc2lvbi5yZXR1cm5UeXBlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIC8vIHJlbW92ZSBkdXBsaWNhdGVzXG4gICAgICAgICAgICB0aGlzLmZpZWxkcyA9IFtcbiAgICAgICAgICAgICAgICAuLi5uZXcgTWFwKHRoaXMuZmllbGRzLm1hcCgoaXRlbSkgPT4gW2l0ZW0ubmFtZSwgaXRlbV0pKS52YWx1ZXMoKVxuICAgICAgICAgICAgXTtcbiAgICAgICAgICAgIGlmICh0aGlzLm11bHRpcGxlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZEZpZWxkcy5wdXNoKGV4cE5hbWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZEZpZWxkcyA9IFtleHBOYW1lXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuYXJjZ2lzUG9wdXBQaWNrTGlzdENoYW5nZS5lbWl0KHsgc2VsZWN0ZWRGaWVsZHM6IFsuLi5uZXcgU2V0KHRoaXMuc2VsZWN0ZWRGaWVsZHMpXSB9KTtcbiAgICAgICAgICAgIHRoaXMuYXJjYWRlQ2hhbmdlTm90aWZpY2F0aW9uLmVtaXQoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmZsb3dJdGVtRWxlbWVudC5kaXNhYmxlZCA9IGZhbHNlO1xuICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuYXJjYWRlRWRpdG9yKTtcbiAgICAgICAgdGhpcy5hcmNhZGVFZGl0b3IgPSBudWxsO1xuICAgIH1cbiAgICBhc3luYyBnZXRGaWVsZHMoKSB7XG4gICAgICAgIGNvbnN0IHRlbXBGaWVsZEFuZEZpZWxkSW5mbyA9IFtdO1xuICAgICAgICBsZXQgZmllbGRzT3JkZXJJblNlcnZpY2UgPSBhd2FpdCBnZXRGaWVsZHNGcm9tTGF5ZXIodGhpcy5sYXllcik7XG4gICAgICAgIGZpZWxkc09yZGVySW5TZXJ2aWNlID0gZmllbGRzT3JkZXJJblNlcnZpY2UuZmlsdGVyKChmaWVsZCkgPT4gZmllbGQudmlzaWJsZSk7XG4gICAgICAgIC8vIG1hcCBmaWVsZEluZm9zIGZvciBmYXN0ZXIgYWNjZXNzXG4gICAgICAgIGNvbnN0IGZpZWxkSW5mb01hcCA9IG5ldyBNYXAodGhpcy5wb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MubWFwKChmaWVsZEluZm8pID0+IFtcbiAgICAgICAgICAgIGZpZWxkSW5mby5maWVsZE5hbWUsXG4gICAgICAgICAgICBmaWVsZEluZm9cbiAgICAgICAgXSkpO1xuICAgICAgICAvLyBvcmRlciBiYXNlZCBvbiBvcmRlciBvZiBmaWVsZHMgaW4gdGhlIHNlcnZpY2VcbiAgICAgICAgZmllbGRzT3JkZXJJblNlcnZpY2UuZm9yRWFjaCgobGF5ZXJGaWVsZCkgPT4ge1xuICAgICAgICAgICAgaWYgKGZpZWxkSW5mb01hcC5oYXMobGF5ZXJGaWVsZC5uYW1lKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGZpZWxkSW5mbyA9IGZpZWxkSW5mb01hcC5nZXQobGF5ZXJGaWVsZC5uYW1lKTtcbiAgICAgICAgICAgICAgICB0ZW1wRmllbGRBbmRGaWVsZEluZm8ucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IGZpZWxkSW5mby5maWVsZE5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGFsaWFzOiBnZXRGaWVsZERpc3BsYXlOYW1lKGZpZWxkSW5mbywgdGhpcy5hcmNhZGVFeHBNYXApLFxuICAgICAgICAgICAgICAgICAgICB0eXBlOiBnZXRGaWVsZFR5cGUoZmllbGRJbmZvLmZpZWxkTmFtZSwgdGhpcy5sYXllckZpZWxkc01hcCwgdGhpcy5hcmNhZGVFeHBNYXApXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgLy8gZGVsZXRlIGZyb20gbWFwXG4gICAgICAgICAgICAgICAgZmllbGRJbmZvTWFwLmRlbGV0ZShsYXllckZpZWxkLm5hbWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgLy8gYWRkIHJlbWFpbmluZyBmaWVsZHMgaW4gcG9wdXB0ZW1wbGF0ZS4gZS5nLiBhcmNhZGUsIHJlbGF0ZWRcbiAgICAgICAgZmllbGRJbmZvTWFwLmZvckVhY2goKGZpZWxkSW5mbykgPT4ge1xuICAgICAgICAgICAgdGVtcEZpZWxkQW5kRmllbGRJbmZvLnB1c2goe1xuICAgICAgICAgICAgICAgIG5hbWU6IGZpZWxkSW5mby5maWVsZE5hbWUsXG4gICAgICAgICAgICAgICAgYWxpYXM6IGdldEZpZWxkRGlzcGxheU5hbWUoZmllbGRJbmZvLCB0aGlzLmFyY2FkZUV4cE1hcCksXG4gICAgICAgICAgICAgICAgdHlwZTogZ2V0RmllbGRUeXBlKGZpZWxkSW5mby5maWVsZE5hbWUsIHRoaXMubGF5ZXJGaWVsZHNNYXAsIHRoaXMuYXJjYWRlRXhwTWFwKVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAodGhpcy5udW1iZXJzT25seSkge1xuICAgICAgICAgICAgLy8gc2V0IGZvciBmYXN0ZXIgbG9va3VwXG4gICAgICAgICAgICBjb25zdCBzZWxlY3RlZEZpZWxkc1NldCA9IG5ldyBTZXQodGhpcy5zZWxlY3RlZEZpZWxkcyk7XG4gICAgICAgICAgICByZXR1cm4gdGVtcEZpZWxkQW5kRmllbGRJbmZvLmZpbHRlcigoY3VyckZpZWxkQW5kRmllbGRJbmZvKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZmllbGRUeXBlID0gY3VyckZpZWxkQW5kRmllbGRJbmZvLnR5cGUudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgICAgICBpZiAoKHNlbGVjdGVkRmllbGRzU2V0LmhhcyhjdXJyRmllbGRBbmRGaWVsZEluZm8ubmFtZSkgfHxcbiAgICAgICAgICAgICAgICAgICAgZmllbGRUeXBlID09PSBmaWVsZFR5cGVzRW51bS5pbnRlZ2VyIHx8XG4gICAgICAgICAgICAgICAgICAgIGZpZWxkVHlwZSA9PT0gZmllbGRUeXBlc0VudW0uc21hbGxJbnRlZ2VyIHx8XG4gICAgICAgICAgICAgICAgICAgIGZpZWxkVHlwZSA9PT0gZmllbGRUeXBlc0VudW0uYmlnSW50ZWdlciB8fFxuICAgICAgICAgICAgICAgICAgICBmaWVsZFR5cGUgPT09IGZpZWxkVHlwZXNFbnVtLnNpbmdsZSB8fFxuICAgICAgICAgICAgICAgICAgICBmaWVsZFR5cGUgPT09IGZpZWxkVHlwZXNFbnVtLmRvdWJsZSB8fFxuICAgICAgICAgICAgICAgICAgICBmaWVsZFR5cGUgPT09IGZpZWxkVHlwZXNFbnVtLmxvbmcgfHxcbiAgICAgICAgICAgICAgICAgICAgZmllbGRUeXBlID09PSBmaWVsZFR5cGVzRW51bS5udW1iZXIgfHxcbiAgICAgICAgICAgICAgICAgICAgZmllbGRUeXBlID09PSBmaWVsZFR5cGVzRW51bS5vaWQpICYmXG4gICAgICAgICAgICAgICAgICAgICFjdXJyRmllbGRBbmRGaWVsZEluZm8ubmFtZS5pbmNsdWRlcyhmaWVsZEluZm9QcmVmaXhFbnVtLnJlbGF0aW9uc2hpcCkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJGaWVsZEFuZEZpZWxkSW5mbztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGVtcEZpZWxkQW5kRmllbGRJbmZvO1xuICAgIH1cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vXG4gICAgLy8gUmVuZG9yICBNZXRob2RzXG4gICAgLy9cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgYWRkQnRuID0gKGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IGFwcGVhcmFuY2U6IHRoaXMuc2hvd0NhbmNlbCA/IFwic29saWRcIiA6IFwib3V0bGluZS1maWxsXCIsIHdpZHRoOiB0aGlzLnNob3dDYW5jZWwgPyBcImhhbGZcIiA6IFwiZnVsbFwiLCBzY2FsZTogXCJtXCIsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmFyY2dpc1BvcHVwUGlja0xpc3REaXNtaXNzZWQuZW1pdCh7XG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkRmllbGRzOiBbLi4ubmV3IFNldCh0aGlzLnNlbGVjdGVkRmllbGRzKV1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gfSwgdGhpcy5va0J0blRleHQgfHwgKHRoaXMubXVsdGlwbGUgPyB0aGlzLnN0cmluZ3MuZG9uZSA6IHRoaXMuc3RyaW5ncy5vaykpKTtcbiAgICAgICAgY29uc3QgY2FuY2VsQnRuID0gKGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IGFwcGVhcmFuY2U6IFwib3V0bGluZS1maWxsXCIsIHdpZHRoOiB0aGlzLm11bHRpcGxlID8gXCJoYWxmXCIgOiBcImZ1bGxcIiwgc2NhbGU6IFwibVwiLCBvbkNsaWNrOiAoKSA9PiB0aGlzLmFyY2dpc1BvcHVwUGlja0xpc3REaXNtaXNzZWQuZW1pdCgpIH0sIHRoaXMuc3RyaW5ncy5jYW5jZWwpKTtcbiAgICAgICAgY29uc3Qgc29ydCA9IChoKFwiY2FsY2l0ZS1kcm9wZG93blwiLCB7IHNsb3Q6IFwibWVudS1hY3Rpb25zXCIsIHBsYWNlbWVudDogXCJib3R0b20tZW5kXCIsIG92ZXJsYXlQb3NpdGlvbmluZzogXCJmaXhlZFwiIH0sIGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IHNsb3Q6IFwidHJpZ2dlclwiLCB0ZXh0OiB0aGlzLnN0cmluZ3Muc29ydCwgdGl0bGU6IHRoaXMuc3RyaW5ncy5zb3J0IH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBzY2FsZTogXCJzXCIsIGljb246IFwic29ydERlc2NlbmRpbmdcIiB9KSksIGgoXCJjYWxjaXRlLWRyb3Bkb3duLWdyb3VwXCIsIG51bGwsIGgoXCJjYWxjaXRlLWRyb3Bkb3duLWl0ZW1cIiwgeyBzZWxlY3RlZDogdGhpcy5sYXN0U29ydHlCeSA9PT0gTGFzdFNvcnR5QnkuZGVmYXVsdCwgb25DbGljazogKCkgPT4gKHRoaXMubGFzdFNvcnR5QnkgPSBMYXN0U29ydHlCeS5kZWZhdWx0KSB9LCB0aGlzLnN0cmluZ3MuZGVmYXVsdCksIGgoXCJjYWxjaXRlLWRyb3Bkb3duLWl0ZW1cIiwgeyBzZWxlY3RlZDogdGhpcy5sYXN0U29ydHlCeSA9PT0gTGFzdFNvcnR5QnkuZGlzcGxheSwgb25DbGljazogKCkgPT4gKHRoaXMubGFzdFNvcnR5QnkgPSBMYXN0U29ydHlCeS5kaXNwbGF5KSB9LCB0aGlzLnN0cmluZ3MuZGlzcGxheU5hbWUpLCBoKFwiY2FsY2l0ZS1kcm9wZG93bi1pdGVtXCIsIHsgc2VsZWN0ZWQ6IHRoaXMubGFzdFNvcnR5QnkgPT09IExhc3RTb3J0eUJ5LnR5cGUsIG9uQ2xpY2s6ICgpID0+ICh0aGlzLmxhc3RTb3J0eUJ5ID0gTGFzdFNvcnR5QnkudHlwZSkgfSwgdGhpcy5zdHJpbmdzLnR5cGUpLCBoKFwiY2FsY2l0ZS1kcm9wZG93bi1pdGVtXCIsIHsgc2VsZWN0ZWQ6IHRoaXMubGFzdFNvcnR5QnkgPT09IExhc3RTb3J0eUJ5LmZpZWxkLCBvbkNsaWNrOiAoKSA9PiAodGhpcy5sYXN0U29ydHlCeSA9IExhc3RTb3J0eUJ5LmZpZWxkKSB9LCB0aGlzLnN0cmluZ3MuZmllbGROYW1lKSkpKTtcbiAgICAgICAgY29uc3Qgc2VsZWN0aW9uQnRuID0gKGgoXCJkaXZcIiwgeyBjbGFzczogXCJzZWxlY3Rpb24tYnV0dG9uLWRpdlwiIH0sIGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IGFwcGVhcmFuY2U6IFwidHJhbnNwYXJlbnRcIiwgc2NhbGU6IFwibVwiLCB3aWR0aDogXCJmdWxsXCIsIGNsYXNzOiBcInNlbGVjdGlvbi1idXR0b25cIiwgb25DbGljazogKCkgPT4ge1xuICAgICAgICAgICAgICAgIHZhciBfYSwgX2I7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuc2VsZWN0RGVzZWxlY3QoKSkge1xuICAgICAgICAgICAgICAgICAgICAvL2Rlc2VsZWN0IGFsbFxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkRmllbGRzID0gKChfYSA9IHRoaXMuZmlsdGVyRmllbGRzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKVxuICAgICAgICAgICAgICAgICAgICAgICAgPyB0aGlzLnNlbGVjdGVkRmllbGRzLmZpbHRlcigoaXRlbSkgPT4gIXRoaXMuZmlsdGVyRmllbGRzLmluY2x1ZGVzKGl0ZW0pKVxuICAgICAgICAgICAgICAgICAgICAgICAgOiBbXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIC8vc2VsZWN0IGFsbFxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkRmllbGRzID0gKChfYiA9IHRoaXMuZmlsdGVyRmllbGRzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IubGVuZ3RoKVxuICAgICAgICAgICAgICAgICAgICAgICAgPyBbLi4ubmV3IFNldChbLi4udGhpcy5zZWxlY3RlZEZpZWxkcywgLi4udGhpcy5maWx0ZXJGaWVsZHNdKV1cbiAgICAgICAgICAgICAgICAgICAgICAgIDogdGhpcy5maWVsZHMubWFwKChmaWVsZCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmaWVsZC5uYW1lO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSB9LCB0aGlzLnNlbGVjdERlc2VsZWN0KCkgPyB0aGlzLnN0cmluZ3MuZGVzZWxlY3RBbGwgOiB0aGlzLnN0cmluZ3Muc2VsZWN0QWxsKSkpO1xuICAgICAgICBjb25zdCBhZGRFeHByZXNzaW9uc0J0biA9IChoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBhcHBlYXJhbmNlOiBcInRyYW5zcGFyZW50XCIsIHNjYWxlOiBcIm1cIiwgd2lkdGg6IFwiZnVsbFwiLCBpY29uU3RhcnQ6IFwicGx1c1wiLCBjbGFzczogXCJhZGQtZXhwcmVzc2lvbi1idXR0b25cIiwgb25DbGljazogKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubGF1bmNoQXJjYWRlKCk7XG4gICAgICAgICAgICB9IH0sIHRoaXMuc3RyaW5ncy5hZGRFeHByZXNzaW9uKSk7XG4gICAgICAgIHJldHVybiAoaChIb3N0LCB7IGNsYXNzOiBcImpzLWFwcC1mbHlvdXRcIiB9LCBoKFwiY2FsY2l0ZS1wb3BvdmVyXCIsIHsgZGlyOiBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpLCBjbGFzczogXCJwb3BvdmVyXCIsIHBsYWNlbWVudDogdGhpcy5wb3BvdmVyUHJvcHMucGxhY2VtZW50IHx8IFwibGVhZGluZy1zdGFydFwiLCBvcGVuOiBmYWxzZSwgcG9pbnRlckRpc2FibGVkOiB0cnVlLCByZWZlcmVuY2VFbGVtZW50OiB0aGlzLnBvcG92ZXJQcm9wcy5yZWZFbGVtZW50LCBvZmZzZXREaXN0YW5jZTogdGhpcy5wb3BvdmVyUHJvcHMub2Zmc2V0RGlzdGFuY2UgfHxcbiAgICAgICAgICAgICAgICAtTWF0aC5yb3VuZCh0aGlzLnBvcG92ZXJQcm9wcy5yZWZFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoKSwgb2Zmc2V0U2tpZGRpbmc6IHRoaXMucG9wb3ZlclByb3BzLm9mZnNldFNraWRkaW5nIHx8IDUwLCBsYWJlbDogdGhpcy5oZWFkaW5nLCB0cmlnZ2VyRGlzYWJsZWQ6IHRydWUsIHJlZjogKG5vZGUpID0+ICh0aGlzLnBvcG92ZXJOb2RlID0gbm9kZSkgfSwgaChcImNhbGNpdGUtZmxvd1wiLCB7IHJlZjogKG5vZGUpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmZsb3dFbGVtZW50ID0gbm9kZTtcbiAgICAgICAgICAgIH0sIHN0eWxlOiB7XG4gICAgICAgICAgICAgICAgd2lkdGg6IGAke3RoaXMucG9wb3ZlclByb3BzLnBvcG92ZXJXaWR0aCB8fFxuICAgICAgICAgICAgICAgICAgICB0aGlzLnBvcG92ZXJQcm9wcy5yZWZFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRofXB4YFxuICAgICAgICAgICAgfSB9LCBoKFwiY2FsY2l0ZS1mbG93LWl0ZW1cIiwgeyByZWY6IChlbCkgPT4gKHRoaXMuZmxvd0l0ZW1FbGVtZW50ID0gZWwpLCBjbGFzczogXCJwYW5lbFwiLCBoZWFkaW5nOiB0aGlzLmhlYWRpbmcsIGNsb3NhYmxlOiB0cnVlLCBvbkNhbGNpdGVGbG93SXRlbUNsb3NlOiAoKSA9PiB0aGlzLmFyY2dpc1BvcHVwUGlja0xpc3REaXNtaXNzZWQuZW1pdCgpIH0sIGgoXCJkaXZcIiwgeyBjbGFzczogXCJmb290ZXJcIiwgc2xvdDogXCJmb290ZXJcIiB9LCB0aGlzLnN1cHBvcnRzQXJjYWRlICYmIGFkZEV4cHJlc3Npb25zQnRuLCB0aGlzLm11bHRpcGxlICYmIGFkZEJ0biwgdGhpcy5zaG93Q2FuY2VsICYmIGNhbmNlbEJ0biksIGgoXCJjYWxjaXRlLXBpY2stbGlzdFwiLCB7IGNsYXNzOiBcImNvbnRlbnRcIiwgbXVsdGlwbGU6IHRoaXMubXVsdGlwbGUsIHJlZjogKG5vZGUpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnBpY2tMaXN0Tm9kZSA9IG5vZGU7XG4gICAgICAgICAgICB9LCBmaWx0ZXJFbmFibGVkOiB0aGlzLmZpZWxkcy5sZW5ndGggPj0gdGhpcy5zaG93RmlsdGVyTGVuZ3RoID8gdHJ1ZSA6IGZhbHNlLCBmaWx0ZXJQbGFjZWhvbGRlcjogdGhpcy5zdHJpbmdzLnNlYXJjaEZpZWxkcywgb25DYWxjaXRlTGlzdENoYW5nZTogYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIGtlZXAgb3JpZ2luYWwgb3JkZXIuIEFkZCBhZGRpb25hbCB2YWx1ZXMgYXQgdGhlIGVuZFxuICAgICAgICAgICAgICAgIGNvbnN0IHRlbXBTZWxlY3RlZEZpZWxkcyA9IGF3YWl0IHRoaXMucGlja0xpc3ROb2RlLmdldFNlbGVjdGVkSXRlbXMoKTtcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkRmllbGRzID0gW1xuICAgICAgICAgICAgICAgICAgICAuLi5uZXcgU2V0KFtcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLnRoaXMuc2VsZWN0ZWRGaWVsZHMuZmlsdGVyKChpdGVtKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRlbXBTZWxlY3RlZEZpZWxkcy5oYXMoaXRlbSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLnRlbXBTZWxlY3RlZEZpZWxkcy5rZXlzKClcbiAgICAgICAgICAgICAgICAgICAgXSlcbiAgICAgICAgICAgICAgICBdO1xuICAgICAgICAgICAgICAgIHRoaXMuYXJjZ2lzUG9wdXBQaWNrTGlzdENoYW5nZS5lbWl0KHtcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRGaWVsZHM6IHRoaXMuc2VsZWN0ZWRGaWVsZHNcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMubXVsdGlwbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcmNnaXNQb3B1cFBpY2tMaXN0RGlzbWlzc2VkLmVtaXQoeyBzZWxlY3RlZEZpZWxkczogdGhpcy5zZWxlY3RlZEZpZWxkcyB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IH0sIHRoaXMuZmllbGRzLmxlbmd0aCA+PSB0aGlzLnNob3dGaWx0ZXJMZW5ndGggJiYgc29ydCwgdGhpcy5tdWx0aXBsZSAmJiBzZWxlY3Rpb25CdG4sIHRoaXMuc3VwcG9ydHNBcmNhZGUgJiYgKGgoXCJjYWxjaXRlLXBpY2stbGlzdC1ncm91cFwiLCB7IFwiZ3JvdXAtdGl0bGVcIjogdGhpcy5zdHJpbmdzLmV4cHJlc3Npb25zIH0sIHRoaXMuZXhwcmVzc2lvbnNPbmx5Lmxlbmd0aCA/ICh0aGlzLmV4cHJlc3Npb25zT25seS5tYXAoKGZpZWxkKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jYWxjaXRlRXhwcmVzc2lvbnNPbmx5VmFsdWVMaXN0KGZpZWxkKTtcbiAgICAgICAgfSkpIDogKGgoXCJjYWxjaXRlLWxhYmVsXCIsIHsgYWxpZ25tZW50OiBcImNlbnRlclwiIH0sIHRoaXMuc3RyaW5ncy5ub0V4cHJlc3Npb25zKSkpKSwgaChcImNhbGNpdGUtcGljay1saXN0LWdyb3VwXCIsIHsgZ3JvdXBUaXRsZTogdGhpcy5zdXBwb3J0c0FyY2FkZSA/IHRoaXMuc3RyaW5ncy5hdHRyaWJ1dGVzIDogbnVsbCB9LCB0aGlzLmZpZWxkc09ubHkubWFwKChmaWVsZCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2FsY2l0ZUZpZWxkT25seVZhbHVlTGlzdChmaWVsZCk7XG4gICAgICAgIH0pKSkpKSkpKTtcbiAgICB9XG4gICAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcbkFyY2dpc1BvcHVwRmllbGRQaWNrTGlzdC5zdHlsZSA9IGFyY2dpc1BvcHVwRmllbGRQaWNrTGlzdENzcztcblxuY29uc3QgQ1NTJDIgPSB7XG4gICAgcG9wb3ZlckltYWdlRGl2OiBcInBvcG92ZXItaW1hZ2UtZGl2XCIsXG4gICAgZm9ybUlucHV0QnV0dG9uOiBcImZvcm0taW5wdXQtYnV0dG9uXCIsXG4gICAgcmVmcmVzaEltYWdlSW5wdXQ6IFwicmVmcmVzaC1pbWFnZS1pbnB1dFwiXG59O1xuXG5jb25zdCBhcmNnaXNQb3B1cEltYWdlQ3NzID0gXCIucG9wb3Zlci1pbWFnZS1kaXZ7YmFja2dyb3VuZC1jb2xvcjp2YXIoLS1hcmNnaXMtYXBwLWJhY2tncm91bmQpO3BhZGRpbmc6dmFyKC0tYXJjZ2lzLWFwcC1jYXAtc3BhY2luZykgdmFyKC0tYXJjZ2lzLWFwcC1zaWRlLXNwYWNpbmctaGFsZik7bWF4LWhlaWdodDpjYWxjKDYwdmggLSAxMDJweCk7fS5yZWZyZXNoLWxhYmVse21hcmdpbi10b3A6NnB4fS5mb3JtLWlucHV0LWJ1dHRvbntkaXNwbGF5OmZsZXh9LmZvcm0taW5wdXQtYnV0dG9uIGNhbGNpdGUtaW5wdXRbdHlwZT10ZXh0XXtkaXNwbGF5OmZsZXg7ZmxleC1mbG93OmNvbHVtbiBub3dyYXA7ZmxleDoxIDAgMCU7b3ZlcmZsb3c6aGlkZGVufS5mb3JtLWlucHV0LWJ1dHRvbiBjYWxjaXRlLWFjdGlvbnttYXJnaW46MDtmbGV4OjAgMCAwJTtqdXN0aWZ5LXNlbGY6ZmxleC1lbmR9LnJlZnJlc2gtaW1hZ2UtaW5wdXR7d2lkdGg6NXJlbX1cIjtcblxuY29uc3QgQXJjZ2lzUG9wdXBJbWFnZSA9IGNsYXNzIHtcbiAgICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgICAgIHJlZ2lzdGVySW5zdGFuY2UodGhpcywgaG9zdFJlZik7XG4gICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzID0gY3JlYXRlRXZlbnQodGhpcywgXCJjbG9zZVBvcHVwUG9wb3ZlcnNcIiwgNyk7XG4gICAgICAgIHRoaXMuaW1hZ2VDaGFuZ2VkUmVSZW5kZXIgPSBjcmVhdGVFdmVudCh0aGlzLCBcImltYWdlQ2hhbmdlZFJlUmVuZGVyXCIsIDcpO1xuICAgICAgICB0aGlzLm5vdGlmeU11bHRpTWVkaWFDaGFuZ2UgPSBjcmVhdGVFdmVudCh0aGlzLCBcIm5vdGlmeU11bHRpTWVkaWFDaGFuZ2VcIiwgNyk7XG4gICAgICAgIHRoaXMuY2hhbmdlSW1hZ2VQcm9wZXJ0aWVzID0gKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICBldmVudCA9PT0gbnVsbCB8fCBldmVudCA9PT0gdm9pZCAwID8gdm9pZCAwIDogZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICBldmVudCA9PT0gbnVsbCB8fCBldmVudCA9PT0gdm9pZCAwID8gdm9pZCAwIDogZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIC8vIGhpZGUgcmVzdCBvZiB0aGUgY29tcG9uZW50LlxuICAgICAgICAgICAgdGhpcy5pbWFnZU1lZGlhSW5mby52YWx1ZS5zb3VyY2VVUkwgPSB0aGlzLmVkaXRJbWFnZVVybC52YWx1ZTtcbiAgICAgICAgICAgIHRoaXMuaW1hZ2VNZWRpYUluZm8udGl0bGUgPSB0aGlzLmVkaXRJbWFnZVRpdGxlLnZhbHVlO1xuICAgICAgICAgICAgdGhpcy5pbWFnZU1lZGlhSW5mby5yZWZyZXNoSW50ZXJ2YWwgPSB0aGlzLmVkaXRSZWZyZXNoSW1hZ2UudmFsdWUgfHwgMDtcbiAgICAgICAgICAgIHRoaXMuaW1hZ2VNZWRpYUluZm8uY2FwdGlvbiA9IHRoaXMuZWRpdEltYWdlQ2FwdGlvbi52YWx1ZTtcbiAgICAgICAgICAgIHRoaXMuaW1hZ2VNZWRpYUluZm8uYWx0VGV4dCA9IHRoaXMuZWRpdEFsdFRleHQudmFsdWU7XG4gICAgICAgICAgICB0aGlzLmltYWdlTWVkaWFJbmZvLnZhbHVlLmxpbmtVUkwgPSB0aGlzLmVkaXRJbWFnZUxpbmtVcmwudmFsdWU7XG4gICAgICAgICAgICB0aGlzLmltYWdlQ2hhbmdlZFJlUmVuZGVyLmVtaXQoKTtcbiAgICAgICAgfTtcbiAgICAgICAgLy8gb3BlbiBwb3BvdmVyXG4gICAgICAgIHRoaXMub3BlbkF0dHJpYnV0ZXNMaXN0ID0gKGltYWdlQ29tcG9uZW50SW5wdXRUeXBlKSA9PiB7XG4gICAgICAgICAgICAvLyBjbG9zZSBmaXJzdCBzaW5jZSB3ZSBjYW4gaGF2ZSBtdWx0aXBsZSBhdHRyaWJ1dGVzIG9wZW5cbiAgICAgICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQodGhpcy5ndWlkKTtcbiAgICAgICAgICAgIC8vIGxhenkgbG9hZCBhdHRyaWJ1dGUgc2VsZWN0aW9uIGNvbXBvbmVudFxuICAgICAgICAgICAgaWYgKCF0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCkge1xuICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1wb3B1cC1maWVsZC1waWNrLWxpc3RcIik7XG4gICAgICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QucG9wb3ZlclByb3BzID0ge1xuICAgICAgICAgICAgICAgICAgICByZWZFbGVtZW50OiB0aGlzLnBhbmVsRWxlbWVudFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QubXVsdGlwbGUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5oZWFkaW5nID0gdGhpcy5zdHJpbmdzLmFkZEZpZWxkO1xuICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0LmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNQb3B1cFBpY2tMaXN0RGlzbWlzc2VkXCIsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCh0aGlzLmd1aWQpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0LmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNQb3B1cFBpY2tMaXN0Q2hhbmdlXCIsIChldmVudCkgPT4gdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3RDaGFuZ2VzKGV2ZW50LCBpbWFnZUNvbXBvbmVudElucHV0VHlwZSkpO1xuICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpO1xuICAgICAgICAgICAgICAgIHRoaXMucGFuZWxFbGVtZW50LmRpc2FibGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5pbWFnZUZvcm1JbnB1dCA9IChpbWFnZUlucHV0VHlwZSkgPT4ge1xuICAgICAgICAgICAgdmFyIF9hO1xuICAgICAgICAgICAgY29uc3QgaW1hZ2VJbnB1dE9iamVjdCA9IHRoaXMuZ2V0SW1hZ2VJbnB1dE9iamVjdChpbWFnZUlucHV0VHlwZSk7XG4gICAgICAgICAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWxhYmVsXCIsIHsgc2NhbGU6IFwic1wiIH0sIGltYWdlSW5wdXRPYmplY3QuaW5wdXRMYWJlbCwgaChcImRpdlwiLCB7IGlkOiBpbWFnZUlucHV0T2JqZWN0LnBvcG92ZXJJZCwgY2xhc3M6IENTUyQyLmZvcm1JbnB1dEJ1dHRvbiB9LCBoKFwiY2FsY2l0ZS1pbnB1dFwiLCB7IHR5cGU6IFwidGV4dFwiLCBhdXRvZm9jdXM6IHRydWUsIHJlZjogaW1hZ2VJbnB1dE9iamVjdC5yZWZlcmVuY2VFbGVtZW50LCB2YWx1ZTogaW1hZ2VJbnB1dE9iamVjdC5pbnB1dFZhbHVlLCBwbGFjZWhvbGRlcjogaW1hZ2VJbnB1dE9iamVjdC5wbGFjZUhvbGRlciwgb25DbGljazogKCkgPT4gdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCh0aGlzLmd1aWQpIH0pLCAoKF9hID0gdGhpcy5wb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpID4gMCAmJiAoaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgdGV4dDogdGhpcy5zdHJpbmdzLmF0dHJpYnV0ZXMsIFwidGV4dC1kaXNwbGF5XCI6IFwiaGlkZGVuXCIsIG9uQ2xpY2s6ICgpID0+IHRoaXMub3BlbkF0dHJpYnV0ZXNMaXN0KGltYWdlSW5wdXRPYmplY3QuaW1hZ2VJbnB1dCksIHNjYWxlOiBcInNcIiwgaWNvbjogXCJicmFja2V0cy1jdXJseVwiIH0pKSkpKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5nZXRJbWFnZUlucHV0T2JqZWN0ID0gKGltYWdlSW5wdXRUeXBlKSA9PiB7XG4gICAgICAgICAgICBjbGFzcyBJbWFnZUlucHV0Q2xhc3Mge1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgaW1hZ2VJbnB1dE9iamVjdCA9IG5ldyBJbWFnZUlucHV0Q2xhc3MoKTtcbiAgICAgICAgICAgIGltYWdlSW5wdXRPYmplY3QuaW1hZ2VJbnB1dCA9IGltYWdlSW5wdXRUeXBlO1xuICAgICAgICAgICAgaW1hZ2VJbnB1dE9iamVjdC5wb3BvdmVySWQgPSBgcG9wb3ZlcklkXyR7aW1hZ2VJbnB1dE9iamVjdC5pbWFnZUlucHV0fWA7XG4gICAgICAgICAgICBpZiAoaW1hZ2VJbnB1dFR5cGUgPT09IGltYWdlQ29tcG9uZW50SW5wdXRUeXBlc0VudW0uc291cmNlVXJsKSB7XG4gICAgICAgICAgICAgICAgaW1hZ2VJbnB1dE9iamVjdC5pbnB1dExhYmVsID0gdGhpcy5zdHJpbmdzLnVybDtcbiAgICAgICAgICAgICAgICBpbWFnZUlucHV0T2JqZWN0LnJlZmVyZW5jZUVsZW1lbnQgPSAoZWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJjYWxjaXRlSW5wdXRDaGFuZ2VcIiwgdGhpcy5jaGFuZ2VJbWFnZVByb3BlcnRpZXMpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVkaXRJbWFnZVVybCA9IGVsZW1lbnQ7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBpbWFnZUlucHV0T2JqZWN0LmlucHV0VmFsdWUgPSB0aGlzLmltYWdlTWVkaWFJbmZvLnZhbHVlLnNvdXJjZVVSTDtcbiAgICAgICAgICAgICAgICBpbWFnZUlucHV0T2JqZWN0LnBsYWNlSG9sZGVyID0gdGhpcy5zdHJpbmdzLmltYWdlVXJsUGxhY2VIb2xkZXI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChpbWFnZUlucHV0VHlwZSA9PT0gaW1hZ2VDb21wb25lbnRJbnB1dFR5cGVzRW51bS50aXRsZSkge1xuICAgICAgICAgICAgICAgIGltYWdlSW5wdXRPYmplY3QuaW5wdXRMYWJlbCA9IHRoaXMuc3RyaW5ncy50aXRsZTtcbiAgICAgICAgICAgICAgICBpbWFnZUlucHV0T2JqZWN0LnJlZmVyZW5jZUVsZW1lbnQgPSAoZWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJjYWxjaXRlSW5wdXRDaGFuZ2VcIiwgdGhpcy5jaGFuZ2VJbWFnZVByb3BlcnRpZXMpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVkaXRJbWFnZVRpdGxlID0gZWxlbWVudDtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGltYWdlSW5wdXRPYmplY3QuaW5wdXRWYWx1ZSA9IHRoaXMuaW1hZ2VNZWRpYUluZm8udGl0bGU7XG4gICAgICAgICAgICAgICAgaW1hZ2VJbnB1dE9iamVjdC5wbGFjZUhvbGRlciA9IHRoaXMuc3RyaW5ncy5pbWFnZVRpdGxlUGxhY2VIb2xkZXI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChpbWFnZUlucHV0VHlwZSA9PT0gaW1hZ2VDb21wb25lbnRJbnB1dFR5cGVzRW51bS5jYXB0aW9uKSB7XG4gICAgICAgICAgICAgICAgaW1hZ2VJbnB1dE9iamVjdC5pbnB1dExhYmVsID0gdGhpcy5zdHJpbmdzLmNhcHRpb247XG4gICAgICAgICAgICAgICAgaW1hZ2VJbnB1dE9iamVjdC5yZWZlcmVuY2VFbGVtZW50ID0gKGVsZW1lbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwiY2FsY2l0ZUlucHV0Q2hhbmdlXCIsIHRoaXMuY2hhbmdlSW1hZ2VQcm9wZXJ0aWVzKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lZGl0SW1hZ2VDYXB0aW9uID0gZWxlbWVudDtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGltYWdlSW5wdXRPYmplY3QuaW5wdXRWYWx1ZSA9IHRoaXMuaW1hZ2VNZWRpYUluZm8uY2FwdGlvbjtcbiAgICAgICAgICAgICAgICBpbWFnZUlucHV0T2JqZWN0LnBsYWNlSG9sZGVyID0gdGhpcy5zdHJpbmdzLmltYWdlQ2FwdGlvblBsYWNlSG9sZGVyO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoaW1hZ2VJbnB1dFR5cGUgPT09IGltYWdlQ29tcG9uZW50SW5wdXRUeXBlc0VudW0uYWx0VGV4dCkge1xuICAgICAgICAgICAgICAgIGltYWdlSW5wdXRPYmplY3QuaW5wdXRMYWJlbCA9IHRoaXMuc3RyaW5ncy5kZXNjcmlwdGlvbjtcbiAgICAgICAgICAgICAgICBpbWFnZUlucHV0T2JqZWN0LnJlZmVyZW5jZUVsZW1lbnQgPSAoZWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJjYWxjaXRlSW5wdXRDaGFuZ2VcIiwgdGhpcy5jaGFuZ2VJbWFnZVByb3BlcnRpZXMpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVkaXRBbHRUZXh0ID0gZWxlbWVudDtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGltYWdlSW5wdXRPYmplY3QuaW5wdXRWYWx1ZSA9IHRoaXMuaW1hZ2VNZWRpYUluZm8uYWx0VGV4dDtcbiAgICAgICAgICAgICAgICBpbWFnZUlucHV0T2JqZWN0LnBsYWNlSG9sZGVyID0gdGhpcy5zdHJpbmdzLmRlc2NyaWJlSW1hZ2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChpbWFnZUlucHV0VHlwZSA9PT0gaW1hZ2VDb21wb25lbnRJbnB1dFR5cGVzRW51bS5saW5rVXJsKSB7XG4gICAgICAgICAgICAgICAgaW1hZ2VJbnB1dE9iamVjdC5pbnB1dExhYmVsID0gdGhpcy5zdHJpbmdzLmxpbms7XG4gICAgICAgICAgICAgICAgaW1hZ2VJbnB1dE9iamVjdC5yZWZlcmVuY2VFbGVtZW50ID0gKGVsZW1lbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwiY2FsY2l0ZUlucHV0Q2hhbmdlXCIsIHRoaXMuY2hhbmdlSW1hZ2VQcm9wZXJ0aWVzKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lZGl0SW1hZ2VMaW5rVXJsID0gZWxlbWVudDtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGltYWdlSW5wdXRPYmplY3QuaW5wdXRWYWx1ZSA9IHRoaXMuaW1hZ2VNZWRpYUluZm8udmFsdWUubGlua1VSTDtcbiAgICAgICAgICAgICAgICBpbWFnZUlucHV0T2JqZWN0LnBsYWNlSG9sZGVyID0gdGhpcy5zdHJpbmdzLmltYWdlTGlua1VybFBsYWNlSG9sZGVyO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGltYWdlSW5wdXRPYmplY3Q7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuZ3VpZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5pbWFnZU1lZGlhSW5mbyA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5yZWZFbGVtZW50ID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLm1lZGlhSW5kZXhQb3NpdGlvbiA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5pc09wZW4gPSBmYWxzZTtcbiAgICAgICAgdGhpcy5yZVJlbmRlciA9IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgLy8gbGlmZWN5Y2xlIG1ldGhvZHNcbiAgICBjb21wb25lbnRXaWxsTG9hZCgpIHtcbiAgICAgICAgdGhpcy5zdHJpbmdzID0gcG9wdXBTdGF0ZS5zdHJpbmdzO1xuICAgICAgICB0aGlzLnBvcHVwVGVtcGxhdGUgPSBwb3B1cFN0YXRlLnBvcHVwVGVtcGxhdGU7XG4gICAgICAgIHRoaXMuaW1hZ2VNZWRpYUluZm8udGl0bGUgPSB0aGlzLmltYWdlTWVkaWFJbmZvLnRpdGxlIHx8IFwiXCI7XG4gICAgICAgIHRoaXMuaW1hZ2VNZWRpYUluZm8uYWx0VGV4dCA9IHRoaXMuaW1hZ2VNZWRpYUluZm8uYWx0VGV4dCB8fCBcIlwiO1xuICAgICAgICB0aGlzLmltYWdlTWVkaWFJbmZvLmNhcHRpb24gPSB0aGlzLmltYWdlTWVkaWFJbmZvLmNhcHRpb24gfHwgXCJcIjtcbiAgICAgICAgdGhpcy5pbWFnZU1lZGlhSW5mby52YWx1ZS5zb3VyY2VVUkwgPSB0aGlzLmltYWdlTWVkaWFJbmZvLnZhbHVlLnNvdXJjZVVSTCB8fCBcIlwiO1xuICAgICAgICB0aGlzLmltYWdlTWVkaWFJbmZvLnZhbHVlLmxpbmtVUkwgPSB0aGlzLmltYWdlTWVkaWFJbmZvLnZhbHVlLmxpbmtVUkwgfHwgXCJcIjtcbiAgICB9XG4gICAgY29tcG9uZW50RGlkTG9hZCgpIHtcbiAgICAgICAgdGhpcy5lZGl0SW1hZ2VVcmwudmFsdWUgPSB0aGlzLmltYWdlTWVkaWFJbmZvLnZhbHVlLnNvdXJjZVVSTDtcbiAgICAgICAgdGhpcy5lZGl0SW1hZ2VUaXRsZS52YWx1ZSA9IHRoaXMuaW1hZ2VNZWRpYUluZm8udGl0bGU7XG4gICAgICAgIHRoaXMuZWRpdFJlZnJlc2hJbWFnZS52YWx1ZSA9IHRoaXMuaW1hZ2VNZWRpYUluZm8ucmVmcmVzaEludGVydmFsIHx8IDA7XG4gICAgICAgIHRoaXMuZWRpdEltYWdlQ2FwdGlvbi52YWx1ZSA9IHRoaXMuaW1hZ2VNZWRpYUluZm8uY2FwdGlvbjtcbiAgICAgICAgdGhpcy5lZGl0SW1hZ2VMaW5rVXJsLnZhbHVlID0gdGhpcy5pbWFnZU1lZGlhSW5mby52YWx1ZS5saW5rVVJMO1xuICAgICAgICB0aGlzLmVkaXRBbHRUZXh0LnZhbHVlID0gdGhpcy5pbWFnZU1lZGlhSW5mby5hbHRUZXh0O1xuICAgICAgICB0aGlzLmlzT3BlbiA9IHRydWU7XG4gICAgICAgIC8vIG5lZWQgdGltZW91dCBiZWNhdXNlIG9mIHJlLXJlbmRlclxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB0aGlzLnBhbmVsRWxlbWVudC5zZXRGb2N1cygpKSwgMzAwKTtcbiAgICB9XG4gICAgY29tcG9uZW50RGlkVXBkYXRlKCkge1xuICAgICAgICB0aGlzLm5vdGlmeU11bHRpTWVkaWFDaGFuZ2UuZW1pdCh7XG4gICAgICAgICAgICBndWlkOiB0aGlzLmd1aWQsXG4gICAgICAgICAgICBtZWRpYUluZGV4UG9zaXRpb246IHRoaXMubWVkaWFJbmRleFBvc2l0aW9uXG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBkaXNjb25uZWN0ZWRDYWxsYmFjaygpIHtcbiAgICAgICAgaWYgKHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KSB7XG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICAvLyBQdWJsaWMgTWV0aG9kc1xuICAgIGFzeW5jIHJlcG9zaXRpb24oKSB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgKF9hID0gdGhpcy5wb3BvdmVyTm9kZSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnJlcG9zaXRpb24oKTtcbiAgICB9XG4gICAgLy8gRXZlbnRzXG4gICAgaW1hZ2VDaGFuZ2VkUmVSZW5kZXJIYW5kbGVyKGV2ZW50KSB7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICB0aGlzLnJlUmVuZGVyID0gdGhpcy5yZVJlbmRlciA/IGZhbHNlIDogdHJ1ZTtcbiAgICB9XG4gICAgY2FsY2l0ZUJsb2NrVG9nZ2xlSGFuZGxlcigpIHtcbiAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgIH1cbiAgICBjbG9zZVBvcHVwUG9wb3ZlcnNIYW5kbGVyKCkge1xuICAgICAgICB0aGlzLnJlbW92ZUF0dHJpYnV0ZXNTZWxlY3Rpb25Qb3BvdmVyKCk7XG4gICAgfVxuICAgIGNsb3NlTXVsdGlNZWRpYVBvcG92ZXJIYW5kbGVyKCkge1xuICAgICAgICB0aGlzLnJlbW92ZUF0dHJpYnV0ZXNTZWxlY3Rpb25Qb3BvdmVyKCk7XG4gICAgfVxuICAgIGNhbGNpdGVCbG9ja1NlY3Rpb25Ub2dnbGVIYW5kbGVyKGV2ZW50KSB7XG4gICAgICAgIGNvbnN0IGNvbXBvc2VkUGF0aCA9IGV2ZW50LmNvbXBvc2VkUGF0aCgpO1xuICAgICAgICBpZiAoKGNvbXBvc2VkUGF0aCA9PT0gbnVsbCB8fCBjb21wb3NlZFBhdGggPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNvbXBvc2VkUGF0aFswXS5pZCkgPT09IFwicmVmcmVzaEltYWdlQmxvY2tTZWN0aW9uX2lkXCIpIHtcbiAgICAgICAgICAgIHRoaXMuZWRpdFJlZnJlc2hJbWFnZS52YWx1ZSA9IDA7XG4gICAgICAgICAgICB0aGlzLmNoYW5nZUltYWdlUHJvcGVydGllcyhldmVudCk7XG4gICAgICAgICAgICB0aGlzLmhvc3RFbGVtZW50LnNoYWRvd1Jvb3QuZ2V0RWxlbWVudEJ5SWQoXCJtYW5hZ2VQb3BvdmVyX0lkXCIpW1wicmVwb3NpdGlvblwiXSgpO1xuICAgICAgICB9XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIH1cbiAgICAvLyBwcml2YXRlIG1ldGhvZHMgYW5kIHByb3BlcnRpZXNcbiAgICByZW1vdmVBdHRyaWJ1dGVzU2VsZWN0aW9uUG9wb3ZlcigpIHtcbiAgICAgICAgaWYgKHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KSB7XG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KTtcbiAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0ID0gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5kaXNhYmxlZCA9IGZhbHNlO1xuICAgIH1cbiAgICAvLyBmaWVsZCBzZWxlY3Rpb24gZm9yIHRpdGxlIGFuZCBjYXB0aW9uXG4gICAgcG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0Q2hhbmdlcyhldmVudCwgY3VyckltYWdlQ29tcG9uZW50SW5wdXRUeXBlcykge1xuICAgICAgICBjb25zdCBzZWxlY3RlZEZpZWxkTmFtZSA9IGV2ZW50LmRldGFpbC5zZWxlY3RlZEZpZWxkc1swXTtcbiAgICAgICAgaWYgKGN1cnJJbWFnZUNvbXBvbmVudElucHV0VHlwZXMgPT09IGltYWdlQ29tcG9uZW50SW5wdXRUeXBlc0VudW0uc291cmNlVXJsKSB7XG4gICAgICAgICAgICB0aGlzLmVkaXRJbWFnZVVybC52YWx1ZSA9IGFkZFNlbGVjdGVkRmllbGRBdEN1cnNvcih0aGlzLmVkaXRJbWFnZVVybCwgc2VsZWN0ZWRGaWVsZE5hbWUpO1xuICAgICAgICAgICAgdGhpcy5lZGl0SW1hZ2VVcmwuc2V0Rm9jdXMoKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChjdXJySW1hZ2VDb21wb25lbnRJbnB1dFR5cGVzID09PSBpbWFnZUNvbXBvbmVudElucHV0VHlwZXNFbnVtLnRpdGxlKSB7XG4gICAgICAgICAgICB0aGlzLmVkaXRJbWFnZVRpdGxlLnZhbHVlID0gYWRkU2VsZWN0ZWRGaWVsZEF0Q3Vyc29yKHRoaXMuZWRpdEltYWdlVGl0bGUsIHNlbGVjdGVkRmllbGROYW1lKTtcbiAgICAgICAgICAgIHRoaXMuZWRpdEltYWdlVGl0bGUuc2V0Rm9jdXMoKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChjdXJySW1hZ2VDb21wb25lbnRJbnB1dFR5cGVzID09PSBpbWFnZUNvbXBvbmVudElucHV0VHlwZXNFbnVtLmNhcHRpb24pIHtcbiAgICAgICAgICAgIHRoaXMuZWRpdEltYWdlQ2FwdGlvbi52YWx1ZSA9IGFkZFNlbGVjdGVkRmllbGRBdEN1cnNvcih0aGlzLmVkaXRJbWFnZUNhcHRpb24sIHNlbGVjdGVkRmllbGROYW1lKTtcbiAgICAgICAgICAgIHRoaXMuZWRpdEltYWdlQ2FwdGlvbi5zZXRGb2N1cygpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGN1cnJJbWFnZUNvbXBvbmVudElucHV0VHlwZXMgPT09IGltYWdlQ29tcG9uZW50SW5wdXRUeXBlc0VudW0ubGlua1VybCkge1xuICAgICAgICAgICAgdGhpcy5lZGl0SW1hZ2VMaW5rVXJsLnZhbHVlID0gYWRkU2VsZWN0ZWRGaWVsZEF0Q3Vyc29yKHRoaXMuZWRpdEltYWdlTGlua1VybCwgc2VsZWN0ZWRGaWVsZE5hbWUpO1xuICAgICAgICAgICAgdGhpcy5lZGl0SW1hZ2VMaW5rVXJsLnNldEZvY3VzKCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoY3VyckltYWdlQ29tcG9uZW50SW5wdXRUeXBlcyA9PT0gaW1hZ2VDb21wb25lbnRJbnB1dFR5cGVzRW51bS5hbHRUZXh0KSB7XG4gICAgICAgICAgICB0aGlzLmVkaXRBbHRUZXh0LnZhbHVlID0gYWRkU2VsZWN0ZWRGaWVsZEF0Q3Vyc29yKHRoaXMuZWRpdEFsdFRleHQsIHNlbGVjdGVkRmllbGROYW1lKTtcbiAgICAgICAgICAgIHRoaXMuZWRpdEFsdFRleHQuc2V0Rm9jdXMoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KHRoaXMuZ3VpZCk7XG4gICAgICAgIHRoaXMuY2hhbmdlSW1hZ2VQcm9wZXJ0aWVzKCk7XG4gICAgfVxuICAgIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgcmVmcmVzaEltYWdlSW5wdXQgPSAoaChcImNhbGNpdGUtYmxvY2stc2VjdGlvblwiLCB7IGlkOiBcInJlZnJlc2hJbWFnZUJsb2NrU2VjdGlvbl9pZFwiLCB0ZXh0OiB0aGlzLnN0cmluZ3MucmVmcmVzaEludGVydmFsLCB0b2dnbGVEaXNwbGF5OiBcInN3aXRjaFwiLCBvcGVuOiB0aGlzLmltYWdlTWVkaWFJbmZvLnJlZnJlc2hJbnRlcnZhbCA/IHRydWUgOiBmYWxzZSB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IFwicmVmcmVzaC1sYWJlbFwiIH0sIGgoXCJjYWxjaXRlLWxhYmVsXCIsIHsgc2NhbGU6IFwic1wiLCBsYXlvdXQ6IFwiaW5saW5lXCIgfSwgaChcImNhbGNpdGUtaW5wdXRcIiwgeyBjbGFzczogQ1NTJDIucmVmcmVzaEltYWdlSW5wdXQsIHR5cGU6IFwibnVtYmVyXCIsIG1pbjogMCwgbWF4OiAxNDQwLCByZWY6IChlbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwiY2FsY2l0ZUlucHV0Q2hhbmdlXCIsIHRoaXMuY2hhbmdlSW1hZ2VQcm9wZXJ0aWVzKTtcbiAgICAgICAgICAgICAgICB0aGlzLmVkaXRSZWZyZXNoSW1hZ2UgPSBlbGVtZW50O1xuICAgICAgICAgICAgfSwgdmFsdWU6IHRoaXMuaW1hZ2VNZWRpYUluZm8ucmVmcmVzaEludGVydmFsXG4gICAgICAgICAgICAgICAgPyB0aGlzLmltYWdlTWVkaWFJbmZvLnJlZnJlc2hJbnRlcnZhbC50b1N0cmluZygpXG4gICAgICAgICAgICAgICAgOiBcIjBcIiwgb25DbGljazogKCkgPT4gdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCh0aGlzLmd1aWQpLCBvbkNhbGNpdGVJbnB1dElucHV0OiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZWRpdFJlZnJlc2hJbWFnZS52YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHBhcnNlSW50KHRoaXMuZWRpdFJlZnJlc2hJbWFnZS52YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA8IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZWRpdFJlZnJlc2hJbWFnZS52YWx1ZSA9IDA7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodmFsdWUgPiAxNDQwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVkaXRSZWZyZXNoSW1hZ2UudmFsdWUgPSAxNDQwO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSB9KSwgdGhpcy5zdHJpbmdzLm1pbnV0ZXMpKSkpO1xuICAgICAgICBjb25zdCBpbWFnZURpdiA9IChoKFwiZGl2XCIsIHsgY2xhc3M6IFwiaWdub3JlLWVsZW1lbnRzLXNvcnRhYmxlXCIgfSwgdGhpcy5pbWFnZUZvcm1JbnB1dChpbWFnZUNvbXBvbmVudElucHV0VHlwZXNFbnVtLnNvdXJjZVVybCksIGgoXCJjYWxjaXRlLWJsb2NrLXNlY3Rpb25cIiwgeyBvcGVuOiB0cnVlLCB0ZXh0OiB0aGlzLnN0cmluZ3Mub3B0aW9ucyB9LCB0aGlzLmltYWdlRm9ybUlucHV0KGltYWdlQ29tcG9uZW50SW5wdXRUeXBlc0VudW0udGl0bGUpLCB0aGlzLmltYWdlRm9ybUlucHV0KGltYWdlQ29tcG9uZW50SW5wdXRUeXBlc0VudW0uY2FwdGlvbiksIHRoaXMuaW1hZ2VGb3JtSW5wdXQoaW1hZ2VDb21wb25lbnRJbnB1dFR5cGVzRW51bS5hbHRUZXh0KSwgdGhpcy5pbWFnZUZvcm1JbnB1dChpbWFnZUNvbXBvbmVudElucHV0VHlwZXNFbnVtLmxpbmtVcmwpLCByZWZyZXNoSW1hZ2VJbnB1dCkpKTtcbiAgICAgICAgY29uc3QgZG9uZUJ0biA9IChoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBhcHBlYXJhbmNlOiBcIm91dGxpbmUtZmlsbFwiLCBzY2FsZTogXCJtXCIsIHNsb3Q6IFwiZm9vdGVyXCIsIHdpZHRoOiBcImZ1bGxcIiwgb25DbGljazogKCkgPT4gdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpIH0sIHRoaXMuc3RyaW5ncy5kb25lKSk7XG4gICAgICAgIHJldHVybiAoaChIb3N0LCB7IGNsYXNzOiBcImpzLWFwcC1mbHlvdXRcIiB9LCBoKFwiY2FsY2l0ZS1wb3BvdmVyXCIsIHsgZGlyOiBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpLCBpZDogXCJtYW5hZ2VQb3BvdmVyX0lkXCIsIHBsYWNlbWVudDogXCJsZWFkaW5nLXN0YXJ0XCIsIG9wZW46IHRoaXMuaXNPcGVuLCBwb2ludGVyRGlzYWJsZWQ6IHRydWUsIHJlZmVyZW5jZUVsZW1lbnQ6IHRoaXMucmVmRWxlbWVudCwgb2Zmc2V0RGlzdGFuY2U6IC1NYXRoLnJvdW5kKHRoaXMucmVmRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS53aWR0aCksIG9mZnNldFNraWRkaW5nOiA1MCwgbGFiZWw6IFwiXCIsIHN0eWxlOiB7XG4gICAgICAgICAgICAgICAgekluZGV4OiBcIjEwMFwiXG4gICAgICAgICAgICB9LCB0cmlnZ2VyRGlzYWJsZWQ6IHRydWUsIHJlZjogKG5vZGUpID0+ICh0aGlzLnBvcG92ZXJOb2RlID0gbm9kZSkgfSwgaChcImNhbGNpdGUtcGFuZWxcIiwgeyByZWY6IChlbGVtZW50KSA9PiAodGhpcy5wYW5lbEVsZW1lbnQgPSBlbGVtZW50KSwgY2xvc2FibGU6IHRydWUsIHN0eWxlOiB7XG4gICAgICAgICAgICAgICAgd2lkdGg6IGAke3RoaXMucmVmRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS53aWR0aH1weGBcbiAgICAgICAgICAgIH0sIG9uQ2FsY2l0ZVBhbmVsQ2xvc2U6ICgpID0+IHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKSB9LCBoKFwiZGl2XCIsIHsgc2xvdDogXCJoZWFkZXItY29udGVudFwiIH0sIHRoaXMuc3RyaW5ncy5jb25maWd1cmVJbWFnZSksIGRvbmVCdG4sIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDIucG9wb3ZlckltYWdlRGl2IH0sIGltYWdlRGl2KSkpKSk7XG4gICAgfVxuICAgIGdldCBob3N0RWxlbWVudCgpIHsgcmV0dXJuIGdldEVsZW1lbnQodGhpcyk7IH1cbn07XG5BcmNnaXNQb3B1cEltYWdlLnN0eWxlID0gYXJjZ2lzUG9wdXBJbWFnZUNzcztcblxuY29uc3QgQXJjZ2lzUG9wdXBNYWluQ29udGVudHBvcG92ZXIgPSBjbGFzcyB7XG4gICAgY29uc3RydWN0b3IoaG9zdFJlZikge1xuICAgICAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycyA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiY2xvc2VQb3B1cFBvcG92ZXJzXCIsIDcpO1xuICAgICAgICB0aGlzLm5vdGlmeUFkZENvbnRlbnRTZWxlY3Rpb24gPSBjcmVhdGVFdmVudCh0aGlzLCBcIm5vdGlmeUFkZENvbnRlbnRTZWxlY3Rpb25cIiwgNyk7XG4gICAgICAgIHRoaXMubm90aWZ5QWRkTXVsdGlNZWRpYUNvbnRlbnRTZWxlY3Rpb24gPSBjcmVhdGVFdmVudCh0aGlzLCBcIm5vdGlmeUFkZE11bHRpTWVkaWFDb250ZW50U2VsZWN0aW9uXCIsIDcpO1xuICAgICAgICB0aGlzLmNvbnRlbnRQb3BvdmVyUmVmRWxlbWVudCA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5wb3B1cEhhc0F0dGFjaG1lbnQgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMucG9wb3ZlclBhbmVsV2lkdGggPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuaXNNdWx0aW1lZGlhQ29udGVudCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmd1aWQgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuaXNPcGVuID0gZmFsc2U7XG4gICAgfVxuICAgIGFzeW5jIHJlcG9zaXRpb24oKSB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgKF9hID0gdGhpcy5wb3BvdmVyRWxlbWVudCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnJlcG9zaXRpb24oKTtcbiAgICB9XG4gICAgY29tcG9uZW50V2lsbExvYWQoKSB7XG4gICAgICAgIHRoaXMuc3RyaW5ncyA9IHBvcHVwU3RhdGUuc3RyaW5ncztcbiAgICAgICAgdGhpcy5sYXllckhhc0F0dGFjaG1lbnQgPSBwb3B1cFN0YXRlLmxheWVySGFzQXR0YWNobWVudDtcbiAgICAgICAgdGhpcy5sYXllckhhc0VUID0gcG9wdXBTdGF0ZS5sYXllckhhc0VUO1xuICAgICAgICB0aGlzLmxheWVySGFzQXR0cmlidXRlcyA9IHBvcHVwU3RhdGUubGF5ZXJIYXNBdHRyaWJ1dGVzO1xuICAgICAgICB0aGlzLmxheWVySGFzQ2hhcnRzID0gcG9wdXBTdGF0ZS5sYXllckhhc0NoYXJ0cztcbiAgICAgICAgdGhpcy5sYXllckhhc0ltYWdlcyA9IHBvcHVwU3RhdGUubGF5ZXJIYXNJbWFnZXM7XG4gICAgICAgIHRoaXMubGF5ZXJIYXNUZXh0ID0gcG9wdXBTdGF0ZS5sYXllckhhc1RleHQ7XG4gICAgICAgIHRoaXMucG9wdXBUZW1wbGF0ZSA9IHBvcHVwU3RhdGUucG9wdXBUZW1wbGF0ZTtcbiAgICAgICAgdGhpcy5zdXBwb3J0c0FyY2FkZSA9IHBvcHVwU3RhdGUuc3VwcG9ydHNBcmNhZGU7XG4gICAgfVxuICAgIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgICAgIHRoaXMuaG9zdEVsZW1lbnQuc2hhZG93Um9vdC5nZXRFbGVtZW50QnlJZChcIm1hbmFnZVBvcG92ZXJfSWRcIilbXCJyZXBvc2l0aW9uXCJdKCk7XG4gICAgICAgIHRoaXMuaXNPcGVuID0gdHJ1ZTtcbiAgICAgICAgLy8gbmVlZCB0aW1lb3V0IGJlY2F1c2Ugb2YgcmUtcmVuZGVyXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHRoaXMucGFuZWxFbGVtZW50LnNldEZvY3VzKCkpLCAzMDApO1xuICAgIH1cbiAgICBjb250ZW50U2VsZWN0aW9uKGNvbnRlbnQpIHtcbiAgICAgICAgaWYgKHRoaXMuaXNNdWx0aW1lZGlhQ29udGVudCkge1xuICAgICAgICAgICAgdGhpcy5ub3RpZnlBZGRNdWx0aU1lZGlhQ29udGVudFNlbGVjdGlvbi5lbWl0KHsgZ3VpZDogdGhpcy5ndWlkLCBjb250ZW50OiBjb250ZW50IH0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5ub3RpZnlBZGRDb250ZW50U2VsZWN0aW9uLmVtaXQoY29udGVudCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLy8gcmVuZG9yIG1ldGhvZHNcbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSAoaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgbGFiZWw6IHRoaXMuc3RyaW5ncy5maWVsZHNMaXN0LCB0ZXh0OiB0aGlzLnN0cmluZ3MuZmllbGRzTGlzdCwgdGV4dEVuYWJsZWQ6IHRydWUsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRlbnRTZWxlY3Rpb24oQ29udGVudFNlbGVjdGlvbi5hdHRyaWJ1dGVzKTtcbiAgICAgICAgICAgIH0gfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcInNcIiwgaWNvbjogXCJmZWF0dXJlLWRldGFpbHNcIiB9KSkpO1xuICAgICAgICBjb25zdCBhdHRhY2htZW50cyA9IChoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBsYWJlbDogdGhpcy5zdHJpbmdzLmF0dGFjaG1lbnRzLCB0ZXh0OiB0aGlzLnN0cmluZ3MuYXR0YWNobWVudHMsIHRleHRFbmFibGVkOiB0cnVlLCBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb250ZW50U2VsZWN0aW9uKENvbnRlbnRTZWxlY3Rpb24uYXR0YWNobWVudHMpO1xuICAgICAgICAgICAgfSwgZGlzYWJsZWQ6IHRoaXMucG9wdXBIYXNBdHRhY2htZW50ID8gdHJ1ZSA6IGZhbHNlIH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBzY2FsZTogXCJzXCIsIGljb246IFwiYXR0YWNobWVudFwiIH0pKSk7XG4gICAgICAgIGNvbnN0IGNoYXJ0cyA9IChoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBsYWJlbDogdGhpcy5zdHJpbmdzLmNoYXJ0LCB0ZXh0OiB0aGlzLnN0cmluZ3MuY2hhcnQsIHRleHRFbmFibGVkOiB0cnVlLCBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb250ZW50U2VsZWN0aW9uKENvbnRlbnRTZWxlY3Rpb24uY2hhcnRzKTtcbiAgICAgICAgICAgIH0gfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcInNcIiwgaWNvbjogXCJncmFwaC1iYXJcIiB9KSkpO1xuICAgICAgICBjb25zdCBpbWFnZXMgPSAoaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgbGFiZWw6IHRoaXMuc3RyaW5ncy5pbWFnZSwgdGV4dDogdGhpcy5zdHJpbmdzLmltYWdlLCB0ZXh0RW5hYmxlZDogdHJ1ZSwgb25DbGljazogKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuY29udGVudFNlbGVjdGlvbihDb250ZW50U2VsZWN0aW9uLmltYWdlcyk7XG4gICAgICAgICAgICB9IH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBzY2FsZTogXCJzXCIsIGljb246IFwiaW1hZ2VcIiB9KSkpO1xuICAgICAgICBjb25zdCByaWNoVGV4dCA9IChoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBsYWJlbDogdGhpcy5zdHJpbmdzLnRleHQsIHRleHQ6IHRoaXMuc3RyaW5ncy50ZXh0LCB0ZXh0RW5hYmxlZDogdHJ1ZSwgb25DbGljazogKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuY29udGVudFNlbGVjdGlvbihDb250ZW50U2VsZWN0aW9uLnJpY2hUZXh0KTtcbiAgICAgICAgICAgIH0gfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcInNcIiwgaWNvbjogXCJ0ZXh0XCIgfSkpKTtcbiAgICAgICAgY29uc3QgYXJjYWRlID0gKGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IGxhYmVsOiB0aGlzLnN0cmluZ3MuYXJjYWRlLCB0ZXh0OiB0aGlzLnN0cmluZ3MuYXJjYWRlLCBpY29uOiBcImNvZGVcIiwgdGV4dEVuYWJsZWQ6IHRydWUsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRlbnRTZWxlY3Rpb24oQ29udGVudFNlbGVjdGlvbi5hcmNhZGUpO1xuICAgICAgICAgICAgfSB9KSk7XG4gICAgICAgIGNvbnN0IGV0ID0gKGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IGxhYmVsOiB0aGlzLnN0cmluZ3Muc3VtbWFyeUVUSGVhZGluZywgdGV4dDogdGhpcy5zdHJpbmdzLnN1bW1hcnlFVEhlYWRpbmcsIHRleHRFbmFibGVkOiB0cnVlLCBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb250ZW50U2VsZWN0aW9uKENvbnRlbnRTZWxlY3Rpb24uc3VtbWFyeUVUKTtcbiAgICAgICAgICAgIH0sIGRpc2FibGVkOiB0aGlzLnBvcHVwVGVtcGxhdGUubGFzdEVkaXRJbmZvRW5hYmxlZCA/IHRydWUgOiBmYWxzZSB9LCBoKFwiY2FsY2l0ZS1pY29uXCIsIHsgc2NhbGU6IFwic1wiLCBpY29uOiBcInVzZXJcIiB9KSkpO1xuICAgICAgICBjb25zdCByZWxhdGVkUmVjb3JkcyA9IChoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBsYWJlbDogdGhpcy5zdHJpbmdzLnJlbGF0ZWRSZWNvcmRzLCB0ZXh0OiB0aGlzLnN0cmluZ3MucmVsYXRlZFJlY29yZHMsIHRleHRFbmFibGVkOiB0cnVlLCBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb250ZW50U2VsZWN0aW9uKENvbnRlbnRTZWxlY3Rpb24ucmVsYXRpb25zaGlwKTtcbiAgICAgICAgICAgIH0gfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcInNcIiwgaWNvbjogXCJsaW5rXCIgfSkpKTtcbiAgICAgICAgY29uc3QgcGFuZWwgPSBxdWVyeVBhcmVudEVsZW1lbnQodGhpcy5jb250ZW50UG9wb3ZlclJlZkVsZW1lbnQsIFwiY2FsY2l0ZS1mbG93LWl0ZW1cIik7XG4gICAgICAgIGNvbnN0IHBhbmVsVG9wID0gKHBhbmVsID09PSBudWxsIHx8IHBhbmVsID09PSB2b2lkIDAgPyB2b2lkIDAgOiBwYW5lbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS50b3ApIHx8IDU2O1xuICAgICAgICBjb25zdCBidXR0b25Ub3AgPSB0aGlzLmNvbnRlbnRQb3BvdmVyUmVmRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS50b3A7XG4gICAgICAgIC8vIDU0OiBwYW5lbCBoZWFkZXI7IDEwOiBwYW5lbCBhcnJvd1xuICAgICAgICBjb25zdCBwb3BvdmVyTWF4SGVpZ2h0ID0gYnV0dG9uVG9wIC0gcGFuZWxUb3AgLSA1NCAtIDEwO1xuICAgICAgICBjb25zdCBjb250ZW50U3R5bGUgPSB7IG1heEhlaWdodDogcG9wb3Zlck1heEhlaWdodCA+IDAgPyBgJHtwb3BvdmVyTWF4SGVpZ2h0fXB4YCA6IFwiNjB2aFwiIH07XG4gICAgICAgIHJldHVybiAoaChIb3N0LCB7IGNsYXNzOiBcImpzLWFwcC1mbHlvdXRcIiB9LCBoKFwiY2FsY2l0ZS1wb3BvdmVyXCIsIHsgcmVmOiAoZWwpID0+ICh0aGlzLnBvcG92ZXJFbGVtZW50ID0gZWwpLCBkaXI6IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCksIGlkOiBcIm1hbmFnZVBvcG92ZXJfSWRcIiwgcGxhY2VtZW50OiBcImJvdHRvbVwiLCBvcGVuOiB0aGlzLmlzT3BlbiwgcmVmZXJlbmNlRWxlbWVudDogdGhpcy5jb250ZW50UG9wb3ZlclJlZkVsZW1lbnQsIGxhYmVsOiB0aGlzLmlzTXVsdGltZWRpYUNvbnRlbnQgPyB0aGlzLnN0cmluZ3MuYWRkTWVkaWEgOiB0aGlzLnN0cmluZ3MuYWRkQ29udGVudCwgc3R5bGU6IHtcbiAgICAgICAgICAgICAgICB6SW5kZXg6IFwiMTAwXCJcbiAgICAgICAgICAgIH0sIHRyaWdnZXJEaXNhYmxlZDogdHJ1ZSB9LCBoKFwiY2FsY2l0ZS1wYW5lbFwiLCB7IHJlZjogKGVsKSA9PiAodGhpcy5wYW5lbEVsZW1lbnQgPSBlbCksIGNsb3NhYmxlOiB0cnVlLCBzdHlsZToge1xuICAgICAgICAgICAgICAgIHdpZHRoOiBgJHt0aGlzLnBvcG92ZXJQYW5lbFdpZHRofXB4YFxuICAgICAgICAgICAgfSwgb25DYWxjaXRlUGFuZWxDbG9zZTogKCkgPT4gdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpIH0sIGgoXCJkaXZcIiwgeyBzbG90OiBcImhlYWRlci1jb250ZW50XCIgfSwgdGhpcy5pc011bHRpbWVkaWFDb250ZW50ID8gdGhpcy5zdHJpbmdzLmFkZE1lZGlhIDogdGhpcy5zdHJpbmdzLmNvbnRlbnQpLCB0aGlzLmlzTXVsdGltZWRpYUNvbnRlbnQgPyAoaChcImRpdlwiLCB7IHN0eWxlOiBjb250ZW50U3R5bGUgfSwgdGhpcy5sYXllckhhc0NoYXJ0cyAmJiBjaGFydHMsIHRoaXMubGF5ZXJIYXNJbWFnZXMgJiYgaW1hZ2VzKSkgOiAoaChcImRpdlwiLCB7IHN0eWxlOiBjb250ZW50U3R5bGUgfSwgdGhpcy5sYXllckhhc0F0dHJpYnV0ZXMgJiYgYXR0cmlidXRlcywgdGhpcy5sYXllckhhc0F0dGFjaG1lbnQgJiYgYXR0YWNobWVudHMsIHRoaXMubGF5ZXJIYXNDaGFydHMgJiYgY2hhcnRzLCB0aGlzLmxheWVySGFzSW1hZ2VzICYmIGltYWdlcywgdGhpcy5sYXllckhhc1RleHQgJiYgcmljaFRleHQsIHRoaXMuc3VwcG9ydHNBcmNhZGUgJiYgYXJjYWRlLCB0aGlzLmxheWVySGFzRVQgJiYgZXQsIHBvcHVwU3RhdGUubGF5ZXJIYXNSZWxhdGVkUmVjb3JkcyAmJiByZWxhdGVkUmVjb3JkcykpKSkpKTtcbiAgICB9XG4gICAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcblxuY29uc3QgQ1NTJDEgPSB7XG4gICAgYWRkTWVkaWFCdXR0b246IFwiYWRkLW1lZGlhLWJ1dHRvblwiLFxuICAgIGZvcm1JbnB1dEJ1dHRvbjogXCJmb3JtLWlucHV0LWJ1dHRvblwiLFxuICAgIGRpc2FibGVTcGFjaW5nOiBcImRpc2FibGUtc3BhY2luZ1wiXG59O1xuXG5jb25zdCBhcmNnaXNQb3B1cE11bHRpbWVkaWFDc3MgPSBcIi5hZGQtbWVkaWEtYnV0dG9ue2Rpc3BsYXk6ZmxleDtqdXN0aWZ5LWNvbnRlbnQ6Y2VudGVyO3BhZGRpbmc6dmFyKC0tYXJjZ2lzLWFwcC1jYXAtc3BhY2luZy1oYWxmKSAwIDAgMH0uZm9ybS1pbnB1dC1idXR0b257ZGlzcGxheTpmbGV4fS5mb3JtLWlucHV0LWJ1dHRvbiBjYWxjaXRlLWlucHV0W3R5cGU9dGV4dF17ZGlzcGxheTpmbGV4O2ZsZXgtZmxvdzpjb2x1bW4gbm93cmFwO2ZsZXg6MSAwIDAlO292ZXJmbG93OmhpZGRlbn0uZm9ybS1pbnB1dC1idXR0b24gY2FsY2l0ZS1hY3Rpb257bWFyZ2luOjA7ZmxleDowIDAgMCU7anVzdGlmeS1zZWxmOmZsZXgtZW5kfS5kaXNhYmxlLXNwYWNpbmd7LS1jYWxjaXRlLWxhYmVsLW1hcmdpbi1ib3R0b206MH1cIjtcblxuY29uc3QgQXJjZ2lzUG9wdXBNdWx0aW1lZGlhID0gY2xhc3Mge1xuICAgIGNvbnN0cnVjdG9yKGhvc3RSZWYpIHtcbiAgICAgICAgcmVnaXN0ZXJJbnN0YW5jZSh0aGlzLCBob3N0UmVmKTtcbiAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMgPSBjcmVhdGVFdmVudCh0aGlzLCBcImNsb3NlUG9wdXBQb3BvdmVyc1wiLCA3KTtcbiAgICAgICAgdGhpcy5jbG9zZU11bHRpTWVkaWFQb3BvdmVyID0gY3JlYXRlRXZlbnQodGhpcywgXCJjbG9zZU11bHRpTWVkaWFQb3BvdmVyXCIsIDcpO1xuICAgICAgICB0aGlzLmludGVybmFsUG9wdXBVcGRhdGVkID0gY3JlYXRlRXZlbnQodGhpcywgXCJpbnRlcm5hbFBvcHVwVXBkYXRlZFwiLCA3KTtcbiAgICAgICAgdGhpcy5kZWxldGVDb21wb25lbnQgPSBjcmVhdGVFdmVudCh0aGlzLCBcImRlbGV0ZUNvbXBvbmVudFwiLCA3KTtcbiAgICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbCA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiZGlzYWJsZVBvcHVwUGFuZWxcIiwgNyk7XG4gICAgICAgIHRoaXMucGlja0xpc3QgPSBbXTtcbiAgICAgICAgLy8gdG8ga2VlcCB0cmFjayBvZiBkcmFnIGFuZCBkcm9wXG4gICAgICAgIHRoaXMubWVkaWFNYXAgPSBuZXcgTWFwKCk7XG4gICAgICAgIHRoaXMuY2FsY2l0ZVZhbHVlTGlzdEl0ZW0gPSAobWVkaWFJbmZvLCBsaXN0SXRlbUd1aWQpID0+IChoKFwiY2FsY2l0ZS12YWx1ZS1saXN0LWl0ZW1cIiwgeyBpZDogbGlzdEl0ZW1HdWlkLCBsYWJlbDogKG1lZGlhSW5mby50aXRsZSAmJlxuICAgICAgICAgICAgICAgIGAke21lZGlhSW5mby50aXRsZS5zdWJzdHJpbmcoMCwgMjUpfSR7bWVkaWFJbmZvLnRpdGxlLmxlbmd0aCA+IDI1ID8gXCIuLi5cIiA6IFwiXCJ9YCkgfHxcbiAgICAgICAgICAgICAgICB0aGlzLnN0cmluZ3Mubm9UaXRsZSwgZGVzY3JpcHRpb246IHRoaXMuZ2V0TXVsdGlNZWRpYVRleHQobWVkaWFJbmZvLnR5cGUpLCB2YWx1ZTogbGlzdEl0ZW1HdWlkLCBvbkNsaWNrOiAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgICAgICAgICAgICAgdGhpcy5vcGVuTWVkaWFQb3BvdmVyKG1lZGlhSW5mbywgdGhpcy5maW5kQ2hhcnRJbmRleFBvc2l0aW9uKGxpc3RJdGVtR3VpZCkpO1xuICAgICAgICAgICAgfSB9LCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBzbG90OiBcImFjdGlvbnMtZW5kXCIsIGFwcGVhcmFuY2U6IFwidHJhbnNwYXJlbnRcIiwgdGV4dDogdGhpcy5zdHJpbmdzLnJlbW92ZSwgb25DbGljazogKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgICAgICAgICAgICAgIC8vIGVhY2ggbGlzdC1pdGVtIGhhcyBpZC4gRmluZCBpZCwgYW5kIHNwbGljZSBieSBpbmRleFxuICAgICAgICAgICAgICAgIGNvbnN0IGFsbExpc3RJdGVtcyA9IHRoaXMuaG9zdEVsZW1lbnQuc2hhZG93Um9vdFxuICAgICAgICAgICAgICAgICAgICAuZ2V0RWxlbWVudEJ5SWQoXCJ2YWx1ZUxpc3RfSWRcIilcbiAgICAgICAgICAgICAgICAgICAgLmdldEVsZW1lbnRzQnlUYWdOYW1lKFwiY2FsY2l0ZS12YWx1ZS1saXN0LWl0ZW1cIik7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCBhbGxMaXN0SXRlbXMubGVuZ3RoOyB4KyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFsbExpc3RJdGVtc1t4XS5pZCA9PT0gbGlzdEl0ZW1HdWlkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm11bHRpbWVkaWFDb250ZW50Lm1lZGlhSW5mb3Muc3BsaWNlKHgsIDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gZGVsZXRlIGNvbXBvbmVudCBpZiBlbXB0eSwgZWxzZSByZS1yZW5kZXJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm11bHRpbWVkaWFDb250ZW50Lm1lZGlhSW5mb3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWxldGVDb21wb25lbnQuZW1pdCh0aGlzLmd1aWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVzZXQgdG8gMCBvbiBkZWxldGVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZU1lZGlhSW5mb0luZGV4KDApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVSZW5kZXIgPSB0aGlzLnJlUmVuZGVyID8gZmFsc2UgOiB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBzY2FsZTogXCJzXCIsIGljb246IFwieFwiIH0pKSkpO1xuICAgICAgICB0aGlzLmZvcm1JbnB1dCA9IChmb3JtVHlwZSwgZm9ybVN0cmluZywgZm9ybUlucHV0RWxlbWVudCwgZm9ybVZhbHVlLCBmb3JtUGxhY2Vob2xkZXJcbiAgICAgICAgLy8gcHJvbXB0TWVzc2FnZTogc3RyaW5nXG4gICAgICAgICkgPT4ge1xuICAgICAgICAgICAgdmFyIF9hO1xuICAgICAgICAgICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1sYWJlbFwiLCB7IHNjYWxlOiBcInNcIiB9LCBmb3JtU3RyaW5nLCBoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQxLmZvcm1JbnB1dEJ1dHRvbiB9LCBoKFwiY2FsY2l0ZS1pbnB1dFwiLCB7IHR5cGU6IFwidGV4dFwiLCBhdXRvZm9jdXM6IHRydWUsIHJlZjogZm9ybUlucHV0RWxlbWVudCwgdmFsdWU6IGZvcm1WYWx1ZSwgcGxhY2Vob2xkZXI6IGZvcm1QbGFjZWhvbGRlciwgb25DYWxjaXRlSW5wdXRJbnB1dDogKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnB1dFZhbCA9IGV2ZW50LnRhcmdldC52YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZvcm1UeXBlID09PSBcInRpdGxlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubXVsdGltZWRpYUNvbnRlbnQudGl0bGUgPSBpbnB1dFZhbDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubXVsdGltZWRpYUNvbnRlbnQuZGVzY3JpcHRpb24gPSBpbnB1dFZhbDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgICAgICAgICAgICAgfSwgb25DbGljazogKCkgPT4gdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpIH0pLCAoKF9hID0gdGhpcy5wb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpID4gMCAmJiAoaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgdGV4dDogdGhpcy5zdHJpbmdzLmF0dHJpYnV0ZXMsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtcG9wdXAtZmllbGQtcGljay1saXN0XCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QucG9wb3ZlclByb3BzID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZkVsZW1lbnQ6IHRoaXMucG9wdXBGbG93SXRlbVxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0Lm11bHRpcGxlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5oZWFkaW5nID0gdGhpcy5zdHJpbmdzLmFkZEZpZWxkO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc1BvcHVwUGlja0xpc3REaXNtaXNzZWRcIiwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc1BvcHVwUGlja0xpc3RDaGFuZ2VcIiwgKGV2ZW50KSA9PiB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdENoYW5nZXMoZXZlbnQsIGZvcm1UeXBlKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGlzYWJsZVBvcHVwUGFuZWwuZW1pdCh0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sIHNjYWxlOiBcInNcIiwgaWNvbjogXCJicmFja2V0cy1jdXJseVwiIH0pKSkpKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5ndWlkID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLm11bHRpbWVkaWFDb250ZW50ID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLmJsb2NrT3BlbiA9IGZhbHNlO1xuICAgICAgICB0aGlzLnBvcHVwRmxvd0l0ZW0gPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMucmVSZW5kZXIgPSB1bmRlZmluZWQ7XG4gICAgfVxuICAgIC8vIGxpZmVjeWNsZSBtZXRob2RzXG4gICAgYXN5bmMgY29tcG9uZW50V2lsbExvYWQoKSB7XG4gICAgICAgIHRoaXMuc3RyaW5ncyA9IHBvcHVwU3RhdGUuc3RyaW5ncztcbiAgICAgICAgdGhpcy5tYXBWaWV3ID0gcG9wdXBTdGF0ZS5tYXBWaWV3O1xuICAgICAgICB0aGlzLnBvcHVwVGVtcGxhdGUgPSBwb3B1cFN0YXRlLnBvcHVwVGVtcGxhdGU7XG4gICAgICAgIC8vIHdhdGNoIGlmIHBvcHVwIGNoYW5nZXMgdG8gcmVzZXQgdGhlIGluZGV4XG4gICAgICAgIGNvbnN0IFtyZWFjdGl2ZVV0aWxzXSA9IGF3YWl0IGxvYWRNb2R1bGVzKFtcImVzcmkvY29yZS9yZWFjdGl2ZVV0aWxzXCJdKTtcbiAgICAgICAgcmVhY3RpdmVVdGlscy53YXRjaCgoKSA9PiB7IHZhciBfYTsgcmV0dXJuIChfYSA9IHRoaXMubWFwVmlldy5wb3B1cCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNlbGVjdGVkRmVhdHVyZTsgfSwgKCkgPT4gdGhpcy5zZXRBY3RpdmVNZWRpYUluZm9JbmRleCgwKSk7XG4gICAgICAgIHJlYWN0aXZlVXRpbHMud2F0Y2goKCkgPT4geyB2YXIgX2E7IHJldHVybiAoX2EgPSB0aGlzLm1hcFZpZXcucG9wdXApID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS52aXNpYmxlOyB9LCAoKSA9PiB0aGlzLnNldEFjdGl2ZU1lZGlhSW5mb0luZGV4KDApKTtcbiAgICAgICAgaWYgKCF0aGlzLm11bHRpbWVkaWFDb250ZW50LnRpdGxlKSB7XG4gICAgICAgICAgICB0aGlzLm11bHRpbWVkaWFDb250ZW50LnRpdGxlID0gXCJcIjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMubXVsdGltZWRpYUNvbnRlbnQuZGVzY3JpcHRpb24pIHtcbiAgICAgICAgICAgIHRoaXMubXVsdGltZWRpYUNvbnRlbnQuZGVzY3JpcHRpb24gPSBcIlwiO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgICAgIGlmICh0aGlzLmJsb2NrT3Blbikge1xuICAgICAgICAgICAgdGhpcy5hZGRNZWRpYUJ0bi5zY3JvbGxJbnRvVmlldyh7IGJlaGF2aW9yOiBcImF1dG9cIiwgYmxvY2s6IFwibmVhcmVzdFwiLCBpbmxpbmU6IFwic3RhcnRcIiB9KTtcbiAgICAgICAgICAgIGlmICh0aGlzLm11bHRpbWVkaWFDb250ZW50Lm1lZGlhSW5mb3MubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5vcGVuTWVkaWFQb3BvdmVyKHRoaXMubXVsdGltZWRpYUNvbnRlbnQubWVkaWFJbmZvc1swXSwgMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmJsb2NrT3B0aW9ucy5zZXRGb2N1cygpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGNvbXBvbmVudFdpbGxSZW5kZXIoKSB7XG4gICAgICAgIHRoaXMucGlja0xpc3QgPSBbXTtcbiAgICAgICAgdGhpcy5tZWRpYU1hcC5jbGVhcigpO1xuICAgICAgICB0aGlzLm11bHRpbWVkaWFDb250ZW50Lm1lZGlhSW5mb3MuZm9yRWFjaCgobWVkaWFJbmZvKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBsaXN0SXRlbUd1aWQgPSBndWlkKCk7XG4gICAgICAgICAgICB0aGlzLm1lZGlhTWFwLnNldChsaXN0SXRlbUd1aWQsIG1lZGlhSW5mbyk7XG4gICAgICAgICAgICB0aGlzLnBpY2tMaXN0LnB1c2godGhpcy5jYWxjaXRlVmFsdWVMaXN0SXRlbShtZWRpYUluZm8sIGxpc3RJdGVtR3VpZCkpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgY29tcG9uZW50RGlkVXBkYXRlKCkge1xuICAgICAgICB0aGlzLmludGVybmFsUG9wdXBVcGRhdGVkLmVtaXQoKTtcbiAgICB9XG4gICAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7XG4gICAgICAgIGlmICh0aGlzLmltYWdlUG9wb3Zlcikge1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLmltYWdlUG9wb3Zlcik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuY2hhcnRQb3BvdmVyKSB7XG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuY2hhcnRQb3BvdmVyKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5tdWx0aW1lZGlhQ29udGVudFBvcG92ZXIpIHtcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5tdWx0aW1lZGlhQ29udGVudFBvcG92ZXIpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCkge1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLy8gZXZlbnRzXG4gICAgY2FsY2l0ZUJsb2NrVG9nZ2xlSGFuZGxlcigpIHtcbiAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgIH1cbiAgICAvLyBkcmFnIGFuZCBkcm9wIHRvIHJlLW9yZGVyXG4gICAgY2FsY2l0ZUxpc3RPcmRlckNoYW5nZUhhbmRsZXIoKSB7XG4gICAgICAgIGxldCB0ZW1wTWVkaWFJbmZvcyA9IFtdO1xuICAgICAgICBjb25zdCBhbGxMaXN0SXRlbXMgPSB0aGlzLmhvc3RFbGVtZW50LnNoYWRvd1Jvb3RcbiAgICAgICAgICAgIC5nZXRFbGVtZW50QnlJZChcInZhbHVlTGlzdF9JZFwiKVxuICAgICAgICAgICAgLmdldEVsZW1lbnRzQnlUYWdOYW1lKFwiY2FsY2l0ZS12YWx1ZS1saXN0LWl0ZW1cIik7XG4gICAgICAgIGNvbnN0IGV2ZW50VmFsdWVHdWlkcyA9IEFycmF5LmZyb20oYWxsTGlzdEl0ZW1zKS5tYXAoKGl0ZW0pID0+IGl0ZW0uaWQpO1xuICAgICAgICBldmVudFZhbHVlR3VpZHMuZm9yRWFjaCgoZXZlbnRWYWx1ZUd1aWQpID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLm1lZGlhTWFwLmhhcyhldmVudFZhbHVlR3VpZCkpIHtcbiAgICAgICAgICAgICAgICB0ZW1wTWVkaWFJbmZvcy5wdXNoKHRoaXMubWVkaWFNYXAuZ2V0KGV2ZW50VmFsdWVHdWlkKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAodGVtcE1lZGlhSW5mb3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdGhpcy5tdWx0aW1lZGlhQ29udGVudC5tZWRpYUluZm9zID0gdGVtcE1lZGlhSW5mb3M7XG4gICAgICAgIH1cbiAgICAgICAgLy8gcmVzZXQgdG8gMCBvbiBkcmFnIGFuZCBkcm9wXG4gICAgICAgIHRoaXMuc2V0QWN0aXZlTWVkaWFJbmZvSW5kZXgoMCwgdHJ1ZSk7XG4gICAgICAgIC8vIGRvbnQgbmVlZCB0byByZS1yZW5kZXIgc2luY2Ugb25seSB1cGRhdGluZyBtZWRpYSBpbmZvcy5cbiAgICAgICAgLy8gY2FsY2l0ZSBwaWNrIGxpc3QgdGFrZXMgY2FyZSBvZiByZW5kZXJpbmcgY29ycmVjdGx5LlxuICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgfVxuICAgIHJlc2V0TXVsdGlNZWRpYUluZGV4SGFuZGxlcigpIHtcbiAgICAgICAgdGhpcy5zZXRBY3RpdmVNZWRpYUluZm9JbmRleCgwLCB0cnVlKTtcbiAgICB9XG4gICAgY2xvc2VQb3B1cFBvcG92ZXJzSGFuZGxlcihldmVudCkge1xuICAgICAgICBpZiAoKGV2ZW50ID09PSBudWxsIHx8IGV2ZW50ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBldmVudC5kZXRhaWwpICE9PSB0aGlzLmd1aWQgJiYgdGhpcy5pbWFnZVBvcG92ZXIpIHtcbiAgICAgICAgICAgIHRoaXMuY2xvc2VNdWx0aU1lZGlhUG9wb3Zlci5lbWl0KCk7XG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuaW1hZ2VQb3BvdmVyKTtcbiAgICAgICAgICAgIHRoaXMuaW1hZ2VQb3BvdmVyID0gbnVsbDtcbiAgICAgICAgICAgIHRoaXMuYWRkTWVkaWFCdG4uc2V0Rm9jdXMoKTtcbiAgICAgICAgICAgIHRoaXMuZGlzYWJsZVBvcHVwUGFuZWwuZW1pdChmYWxzZSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKChldmVudCA9PT0gbnVsbCB8fCBldmVudCA9PT0gdm9pZCAwID8gdm9pZCAwIDogZXZlbnQuZGV0YWlsKSAhPT0gdGhpcy5ndWlkICYmIHRoaXMuY2hhcnRQb3BvdmVyKSB7XG4gICAgICAgICAgICB0aGlzLmNsb3NlTXVsdGlNZWRpYVBvcG92ZXIuZW1pdCgpO1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLmNoYXJ0UG9wb3Zlcik7XG4gICAgICAgICAgICB0aGlzLmNoYXJ0UG9wb3ZlciA9IG51bGw7XG4gICAgICAgICAgICB0aGlzLmFkZE1lZGlhQnRuLnNldEZvY3VzKCk7XG4gICAgICAgICAgICB0aGlzLmRpc2FibGVQb3B1cFBhbmVsLmVtaXQoZmFsc2UpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLm11bHRpbWVkaWFDb250ZW50UG9wb3Zlcikge1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLm11bHRpbWVkaWFDb250ZW50UG9wb3Zlcik7XG4gICAgICAgICAgICB0aGlzLm11bHRpbWVkaWFDb250ZW50UG9wb3ZlciA9IG51bGw7XG4gICAgICAgICAgICB0aGlzLmFkZE1lZGlhQnRuLmRpc2FibGVkID0gZmFsc2U7XG4gICAgICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gdGhpcy5hZGRNZWRpYUJ0bi5zZXRGb2N1cygpKTtcbiAgICAgICAgICAgIHRoaXMuZGlzYWJsZVBvcHVwUGFuZWwuZW1pdChmYWxzZSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KSB7XG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KTtcbiAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0ID0gbnVsbDtcbiAgICAgICAgICAgIHRoaXMuZGlzYWJsZVBvcHVwUGFuZWwuZW1pdChmYWxzZSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgbm90aWZ5TXVsdGlNZWRpYUNoYW5nZUhhbmRsZXIoZXZlbnQpIHtcbiAgICAgICAgdmFyIF9hLCBfYjtcbiAgICAgICAgaWYgKCgoX2EgPSBldmVudC5kZXRhaWwpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5ndWlkKSA9PT0gdGhpcy5ndWlkKSB7XG4gICAgICAgICAgICB0aGlzLnNldEFjdGl2ZU1lZGlhSW5mb0luZGV4KChfYiA9IGV2ZW50LmRldGFpbCkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLm1lZGlhSW5kZXhQb3NpdGlvbik7XG4gICAgICAgICAgICB0aGlzLnJlUmVuZGVyID0gdGhpcy5yZVJlbmRlciA/IGZhbHNlIDogdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBhc3luYyBub3RpZnlBZGRNdWx0aU1lZGlhQ29udGVudFNlbGVjdGlvbkhhbmRsZXIoZXZlbnQpIHtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICAgICAgaWYgKGV2ZW50LmRldGFpbC5ndWlkID09PSB0aGlzLmd1aWQpIHtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gZXZlbnQuZGV0YWlsLmNvbnRlbnQ7XG4gICAgICAgICAgICBjb25zdCBbSW1hZ2VNZWRpYUluZm8sIENvbHVtbkNoYXJ0TWVkaWFJbmZvLCBJbWFnZU1lZGlhSW5mb1ZhbHVlLCBDaGFydE1lZGlhSW5mb1ZhbHVlXSA9IGF3YWl0IGxvYWRNb2R1bGVzKFtcbiAgICAgICAgICAgICAgICBcImVzcmkvcG9wdXAvY29udGVudC9JbWFnZU1lZGlhSW5mb1wiLFxuICAgICAgICAgICAgICAgIFwiZXNyaS9wb3B1cC9jb250ZW50L0NvbHVtbkNoYXJ0TWVkaWFJbmZvXCIsXG4gICAgICAgICAgICAgICAgXCJlc3JpL3BvcHVwL2NvbnRlbnQvc3VwcG9ydC9JbWFnZU1lZGlhSW5mb1ZhbHVlXCIsXG4gICAgICAgICAgICAgICAgXCJlc3JpL3BvcHVwL2NvbnRlbnQvc3VwcG9ydC9DaGFydE1lZGlhSW5mb1ZhbHVlXCJcbiAgICAgICAgICAgIF0pO1xuICAgICAgICAgICAgbGV0IG11bHRpTWVkaWFFbGVtZW50O1xuICAgICAgICAgICAgaWYgKGNvbnRlbnRUeXBlID09PSBDb250ZW50U2VsZWN0aW9uLmltYWdlcykge1xuICAgICAgICAgICAgICAgIG11bHRpTWVkaWFFbGVtZW50ID0gbmV3IEltYWdlTWVkaWFJbmZvKHtcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IFwiXCIsXG4gICAgICAgICAgICAgICAgICAgIGNhcHRpb246IFwiXCIsXG4gICAgICAgICAgICAgICAgICAgIGFsdFRleHQ6IFwiXCIsXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiBuZXcgSW1hZ2VNZWRpYUluZm9WYWx1ZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VVUkw6IFwiXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBsaW5rVVJMOiBcIlwiXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChjb250ZW50VHlwZSA9PT0gQ29udGVudFNlbGVjdGlvbi5jaGFydHMpIHtcbiAgICAgICAgICAgICAgICBtdWx0aU1lZGlhRWxlbWVudCA9IG5ldyBDb2x1bW5DaGFydE1lZGlhSW5mbyh7XG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOiBcIlwiLFxuICAgICAgICAgICAgICAgICAgICBjYXB0aW9uOiBcIlwiLFxuICAgICAgICAgICAgICAgICAgICBhbHRUZXh0OiBcIlwiLFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbmV3IENoYXJ0TWVkaWFJbmZvVmFsdWUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgZmllbGRzOiBbXVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5tdWx0aW1lZGlhQ29udGVudC5tZWRpYUluZm9zLnB1c2gobXVsdGlNZWRpYUVsZW1lbnQpO1xuICAgICAgICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgICAgICAgICAgdGhpcy5vcGVuTWVkaWFQb3BvdmVyKG11bHRpTWVkaWFFbGVtZW50LCB0aGlzLm11bHRpbWVkaWFDb250ZW50Lm1lZGlhSW5mb3MubGVuZ3RoIC0gMSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLy8gcHJpdmF0ZSBtZXRob2RzXG4gICAgc2V0QWN0aXZlTWVkaWFJbmZvSW5kZXgoaW5kZXgsIHVwZGF0ZVBvcHVwKSB7XG4gICAgICAgIHRoaXMubXVsdGltZWRpYUNvbnRlbnQuYWN0aXZlTWVkaWFJbmZvSW5kZXggPSBpbmRleCB8fCAwO1xuICAgICAgICB1cGRhdGVQb3B1cCAmJiB0aGlzLmludGVybmFsUG9wdXBVcGRhdGVkLmVtaXQoKTtcbiAgICB9XG4gICAgZmluZENoYXJ0SW5kZXhQb3NpdGlvbihsaXN0SXRlbUd1aWQpIHtcbiAgICAgICAgY29uc3QgYWxsTGlzdEl0ZW1zID0gdGhpcy5ob3N0RWxlbWVudC5zaGFkb3dSb290XG4gICAgICAgICAgICAuZ2V0RWxlbWVudEJ5SWQoXCJ2YWx1ZUxpc3RfSWRcIilcbiAgICAgICAgICAgIC5nZXRFbGVtZW50c0J5VGFnTmFtZShcImNhbGNpdGUtdmFsdWUtbGlzdC1pdGVtXCIpO1xuICAgICAgICBmb3IgKGxldCB4ID0gMDsgeCA8IGFsbExpc3RJdGVtcy5sZW5ndGg7IHgrKykge1xuICAgICAgICAgICAgaWYgKGFsbExpc3RJdGVtc1t4XS5pZCA9PT0gbGlzdEl0ZW1HdWlkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHg7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgZ2V0TXVsdGlNZWRpYVRleHQodHlwZSkge1xuICAgICAgICBpZiAodHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5pbWFnZSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RyaW5ncy5pbWFnZTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmICh0eXBlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLmJhckNoYXJ0IHx8IHR5cGUgPT09IFBvcHVwTXVsdGlNZWRpYVR5cGUuY29sdW1uQ2hhcnQpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnN0cmluZ3MuYmFyQ2hhcnQ7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gUG9wdXBNdWx0aU1lZGlhVHlwZS5saW5lQ2hhcnQpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnN0cmluZ3MubGluZUNoYXJ0O1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHR5cGUgPT09IFBvcHVwTXVsdGlNZWRpYVR5cGUucGllQ2hhcnQpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnN0cmluZ3MucGllQ2hhcnQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuc3RyaW5ncy5pbWFnZTtcbiAgICB9XG4gICAgb3Blbk1lZGlhUG9wb3ZlcihtZWRpYUluZm8sIGluZGV4UG9zaXRpb24pIHtcbiAgICAgICAgaWYgKG1lZGlhSW5mby50eXBlID09PSBQb3B1cE11bHRpTWVkaWFUeXBlLmltYWdlKSB7XG4gICAgICAgICAgICB0aGlzLmltYWdlUG9wb3ZlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtcG9wdXAtaW1hZ2VcIik7XG4gICAgICAgICAgICB0aGlzLmltYWdlUG9wb3Zlci5ndWlkID0gdGhpcy5ndWlkO1xuICAgICAgICAgICAgdGhpcy5pbWFnZVBvcG92ZXIucmVmRWxlbWVudCA9IHRoaXMucG9wdXBGbG93SXRlbTtcbiAgICAgICAgICAgIHRoaXMuaW1hZ2VQb3BvdmVyLmltYWdlTWVkaWFJbmZvID0gbWVkaWFJbmZvO1xuICAgICAgICAgICAgdGhpcy5pbWFnZVBvcG92ZXIubWVkaWFJbmRleFBvc2l0aW9uID0gaW5kZXhQb3NpdGlvbjtcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5pbWFnZVBvcG92ZXIpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5jaGFydFBvcG92ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLXBvcHVwLWNoYXJ0XCIpO1xuICAgICAgICAgICAgdGhpcy5jaGFydFBvcG92ZXIuZ3VpZCA9IHRoaXMuZ3VpZDtcbiAgICAgICAgICAgIHRoaXMuY2hhcnRQb3BvdmVyLnJlZkVsZW1lbnQgPSB0aGlzLnBvcHVwRmxvd0l0ZW07XG4gICAgICAgICAgICB0aGlzLmNoYXJ0UG9wb3Zlci5jaGFydE1lZGlhSW5mbyA9IG1lZGlhSW5mbztcbiAgICAgICAgICAgIHRoaXMuY2hhcnRQb3BvdmVyLm1lZGlhQ29udGVudCA9IHRoaXMubXVsdGltZWRpYUNvbnRlbnQ7XG4gICAgICAgICAgICB0aGlzLmNoYXJ0UG9wb3Zlci5tZWRpYUluZGV4UG9zaXRpb24gPSBpbmRleFBvc2l0aW9uO1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLmNoYXJ0UG9wb3Zlcik7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KHRydWUpO1xuICAgIH1cbiAgICBnZXRTdW1tYXJ0VGV4dCgpIHtcbiAgICAgICAgaWYgKHRoaXMubXVsdGltZWRpYUNvbnRlbnQubWVkaWFJbmZvcy5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICByZXR1cm4gYCR7dGhpcy5zdHJpbmdzLm11bHRpcGxlfSAoJHt0aGlzLm11bHRpbWVkaWFDb250ZW50Lm1lZGlhSW5mb3MubGVuZ3RofSlgO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0TXVsdGlNZWRpYVRleHQodGhpcy5tdWx0aW1lZGlhQ29udGVudC5tZWRpYUluZm9zWzBdLnR5cGUpO1xuICAgICAgICB9XG4gICAgfVxuICAgIC8vIGZpZWxkIHNlbGVjdGlvbiBmb3IgdGl0bGUgYW5kIGNhcHRpb25cbiAgICBwb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3RDaGFuZ2VzKGV2ZW50LCBmb3JtVHlwZSkge1xuICAgICAgICBjb25zdCBzZWxlY3RlZEZpZWxkTmFtZSA9IGV2ZW50LmRldGFpbC5zZWxlY3RlZEZpZWxkc1swXTtcbiAgICAgICAgaWYgKGZvcm1UeXBlID09PSBcInRpdGxlXCIpIHtcbiAgICAgICAgICAgIHRoaXMuY29udGVudFRpdGxlLnZhbHVlID0gYWRkU2VsZWN0ZWRGaWVsZEF0Q3Vyc29yKHRoaXMuY29udGVudFRpdGxlLCBzZWxlY3RlZEZpZWxkTmFtZSk7XG4gICAgICAgICAgICB0aGlzLmNvbnRlbnRUaXRsZS5zZXRGb2N1cygpO1xuICAgICAgICAgICAgdGhpcy5tdWx0aW1lZGlhQ29udGVudC50aXRsZSA9IHRoaXMuY29udGVudFRpdGxlLnZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGZvcm1UeXBlID09PSBcImRlc2NyaXB0aW9uXCIpIHtcbiAgICAgICAgICAgIHRoaXMuY29udGVudERlc2NyaXB0aW9uLnZhbHVlID0gYWRkU2VsZWN0ZWRGaWVsZEF0Q3Vyc29yKHRoaXMuY29udGVudERlc2NyaXB0aW9uLCBzZWxlY3RlZEZpZWxkTmFtZSk7XG4gICAgICAgICAgICB0aGlzLmNvbnRlbnREZXNjcmlwdGlvbi5zZXRGb2N1cygpO1xuICAgICAgICAgICAgdGhpcy5tdWx0aW1lZGlhQ29udGVudC5kZXNjcmlwdGlvbiA9IHRoaXMuY29udGVudERlc2NyaXB0aW9uLnZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgIH1cbiAgICAvLyByZW5kb3IgbWV0aG9kc1xuICAgIHJlbmRlcigpIHtcbiAgICAgICAgcmV0dXJuIChoKEhvc3QsIG51bGwsIGgoXCJjYWxjaXRlLWJsb2NrXCIsIHsgZGlyOiBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpLCBoZWFkaW5nOiB0aGlzLm11bHRpbWVkaWFDb250ZW50Lm1lZGlhSW5mb3MubGVuZ3RoID4gMVxuICAgICAgICAgICAgICAgID8gdGhpcy5zdHJpbmdzLm1lZGlhR3JvdXBcbiAgICAgICAgICAgICAgICA6IHRoaXMuc3RyaW5ncy5tZWRpYSwgZGVzY3JpcHRpb246ICh0aGlzLm11bHRpbWVkaWFDb250ZW50LnRpdGxlICYmXG4gICAgICAgICAgICAgICAgYCR7dGhpcy5tdWx0aW1lZGlhQ29udGVudC50aXRsZS5zdWJzdHJpbmcoMCwgMjUpfSR7dGhpcy5tdWx0aW1lZGlhQ29udGVudC50aXRsZS5sZW5ndGggPiAyNSA/IFwiLi4uXCIgOiBcIlwifWApIHx8XG4gICAgICAgICAgICAgICAgdGhpcy5nZXRTdW1tYXJ0VGV4dCgpLCBjb2xsYXBzaWJsZTogdHJ1ZSwgb3BlbjogdGhpcy5ibG9ja09wZW4sIGRyYWdIYW5kbGU6IHRydWUgfSwgaChcImRpdlwiLCB7IGNsYXNzOiBcImlnbm9yZS1lbGVtZW50cy1zb3J0YWJsZVwiLCBzbG90OiBcImNvbnRyb2xcIiB9LCBoKFwiYXJjZ2lzLWNhbGNpdGUtYmxvY2stb3B0aW9uc1wiLCB7IHJlZjogKGVsKSA9PiAodGhpcy5ibG9ja09wdGlvbnMgPSBlbCksIGd1aWQ6IHRoaXMuZ3VpZCwgaW50bE9wdGlvbnM6IHRoaXMuc3RyaW5ncy5vcHRpb25zLCBpbnRsRGVsZXRlOiB0aGlzLnN0cmluZ3MuZGVsZXRlLCBpbnRsRHVwbGljYXRlOiB0aGlzLnN0cmluZ3MuZHVwbGljYXRlLCBjYWxjaXRlQmxvY2tPcHRpb25zOiB7IGhhc0RlbGV0ZTogdHJ1ZSwgaGFzRHVwbGljYXRlOiB0cnVlIH0gfSkpLCBoKFwiZGl2XCIsIHsgc2xvdDogXCJpY29uXCIgfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcIm1cIiwgaWNvbjogXCJpbWFnZXNcIiB9KSksIGgoXCJkaXZcIiwgeyBjbGFzczogXCJpZ25vcmUtZWxlbWVudHMtc29ydGFibGVcIiB9LCB0aGlzLmZvcm1JbnB1dChcInRpdGxlXCIsIHRoaXMuc3RyaW5ncy50aXRsZSwgKGVsZW1lbnQpID0+IHtcbiAgICAgICAgICAgIHJldHVybiAodGhpcy5jb250ZW50VGl0bGUgPSBlbGVtZW50KTtcbiAgICAgICAgfSwgdGhpcy5tdWx0aW1lZGlhQ29udGVudC50aXRsZSwgdGhpcy5zdHJpbmdzLmVudGVyVGl0bGVcbiAgICAgICAgLy8gdGhpcy5zdHJpbmdzLnRpdGxlQ29udGV4dC5yZXBsYWNlKFwiJHt0aXRsZUNvbnRleHR9XCIsIHRoaXMuc3RyaW5ncy5tZWRpYV9MKVxuICAgICAgICApLCB0aGlzLmZvcm1JbnB1dChcImRlc2NyaXB0aW9uXCIsIHRoaXMuc3RyaW5ncy5kZXNjLCAoZWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuICh0aGlzLmNvbnRlbnREZXNjcmlwdGlvbiA9IGVsZW1lbnQpO1xuICAgICAgICB9LCB0aGlzLm11bHRpbWVkaWFDb250ZW50LmRlc2NyaXB0aW9uLCB0aGlzLnN0cmluZ3MuZW50ZXJEZXNjcmlwdGlvblxuICAgICAgICAvLyB0aGlzLnN0cmluZ3MuZGVzY3JpcHRpb25Db250ZXh0LnJlcGxhY2UoXCIke2Rlc2NyaXB0aW9uQ29udGV4dH1cIiwgdGhpcy5zdHJpbmdzLm1lZGlhX0wpXG4gICAgICAgICksIGgoXCJjYWxjaXRlLWxhYmVsXCIsIHsgY2xhc3M6IENTUyQxLmRpc2FibGVTcGFjaW5nLCBzY2FsZTogXCJzXCIgfSwgdGhpcy5zdHJpbmdzLm1lZGlhQ29udGVudCksIGgoXCJjYWxjaXRlLXZhbHVlLWxpc3RcIiwgeyBpZDogXCJ2YWx1ZUxpc3RfSWRcIiwgXCJkcmFnLWVuYWJsZWRcIjogdHJ1ZSB9LCB0aGlzLnBpY2tMaXN0KSwgaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgcmVmOiAoZWwpID0+ICh0aGlzLmFkZE1lZGlhQnRuID0gZWwpLCB0aXRsZTogdGhpcy5zdHJpbmdzLmFkZE1lZGlhLCBhcHBlYXJhbmNlOiBcIm91dGxpbmUtZmlsbFwiLCByb3VuZDogdHJ1ZSwgc2NhbGU6IFwic1wiLCBjbGFzczogQ1NTJDEuYWRkTWVkaWFCdXR0b24sIGljb25TdGFydDogXCJwbHVzXCIsIG9uQ2xpY2s6IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMubXVsdGltZWRpYUNvbnRlbnRQb3BvdmVyKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubXVsdGltZWRpYUNvbnRlbnRQb3BvdmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1wb3B1cC1tYWluLWNvbnRlbnRwb3BvdmVyXCIpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm11bHRpbWVkaWFDb250ZW50UG9wb3Zlci5jb250ZW50UG9wb3ZlclJlZkVsZW1lbnQgPSB0aGlzLmFkZE1lZGlhQnRuO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm11bHRpbWVkaWFDb250ZW50UG9wb3Zlci5wb3BvdmVyUGFuZWxXaWR0aCA9XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhvc3RFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm11bHRpbWVkaWFDb250ZW50UG9wb3Zlci5pc011bHRpbWVkaWFDb250ZW50ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tdWx0aW1lZGlhQ29udGVudFBvcG92ZXIuZ3VpZCA9IHRoaXMuZ3VpZDtcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLm11bHRpbWVkaWFDb250ZW50UG9wb3Zlcik7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkTWVkaWFCdG4uZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc2FibGVQb3B1cFBhbmVsLmVtaXQodHJ1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSB9KSkpKSk7XG4gICAgfVxuICAgIGdldCBob3N0RWxlbWVudCgpIHsgcmV0dXJuIGdldEVsZW1lbnQodGhpcyk7IH1cbn07XG5BcmNnaXNQb3B1cE11bHRpbWVkaWEuc3R5bGUgPSBhcmNnaXNQb3B1cE11bHRpbWVkaWFDc3M7XG5cbmNvbnN0IGFyY2dpc1BvcHVwUmVsYXRpb25zaGlwQ3NzID0gXCIuZm9ybS1pbnB1dC1idXR0b257ZGlzcGxheTpmbGV4fS5mb3JtLWlucHV0LWJ1dHRvbiBjYWxjaXRlLWlucHV0W3R5cGU9dGV4dF17ZGlzcGxheTpmbGV4O2ZsZXgtZmxvdzpjb2x1bW4gbm93cmFwO2ZsZXg6MSAwIDAlO292ZXJmbG93OmhpZGRlbn0uZm9ybS1pbnB1dC1idXR0b24gY2FsY2l0ZS1hY3Rpb257bWFyZ2luOjA7ZmxleDowIDAgMCU7anVzdGlmeS1zZWxmOmZsZXgtZW5kfS5kcm9wZG93bnt3aWR0aDoxMDAlfVwiO1xuXG5jb25zdCBBcmNnaXNQb3B1cFJlbGF0aW9uc2hpcCA9IGNsYXNzIHtcbiAgICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgICAgIHJlZ2lzdGVySW5zdGFuY2UodGhpcywgaG9zdFJlZik7XG4gICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzID0gY3JlYXRlRXZlbnQodGhpcywgXCJjbG9zZVBvcHVwUG9wb3ZlcnNcIiwgNyk7XG4gICAgICAgIHRoaXMuaW50ZXJuYWxQb3B1cFVwZGF0ZWQgPSBjcmVhdGVFdmVudCh0aGlzLCBcImludGVybmFsUG9wdXBVcGRhdGVkXCIsIDcpO1xuICAgICAgICB0aGlzLmRpc2FibGVQb3B1cFBhbmVsID0gY3JlYXRlRXZlbnQodGhpcywgXCJkaXNhYmxlUG9wdXBQYW5lbFwiLCA3KTtcbiAgICAgICAgdGhpcy5tYXhQcmV2aWV3Q291bnQgPSAxMTtcbiAgICAgICAgdGhpcy5maWVsZFBpY2tMaXN0Q2hhbmdlcyA9IChldmVudCkgPT4ge1xuICAgICAgICAgICAgdmFyIF9hLCBfYjtcbiAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRGaWVsZCA9IChfYiA9IChfYSA9IGV2ZW50LmRldGFpbCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNlbGVjdGVkRmllbGRzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2JbMF07XG4gICAgICAgICAgICBpZiAoc2VsZWN0ZWRGaWVsZCkge1xuICAgICAgICAgICAgICAgIHRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50Lm9yZGVyQnlGaWVsZHNbMF0uZmllbGQgPSBzZWxlY3RlZEZpZWxkO1xuICAgICAgICAgICAgICAgIHRoaXMucmVSZW5kZXIgPSAhdGhpcy5yZVJlbmRlcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5mb3JtSW5wdXQgPSAoZm9ybVR5cGUsIGZvcm1TdHJpbmcsIGZvcm1JbnB1dEVsZW1lbnQsIGZvcm1WYWx1ZSwgZm9ybVBsYWNlaG9sZGVyKSA9PiB7XG4gICAgICAgICAgICB2YXIgX2E7XG4gICAgICAgICAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWxhYmVsXCIsIHsgc2NhbGU6IFwic1wiIH0sIGZvcm1TdHJpbmcsIGgoXCJkaXZcIiwgeyBjbGFzczogXCJmb3JtLWlucHV0LWJ1dHRvblwiIH0sIGgoXCJjYWxjaXRlLWlucHV0XCIsIHsgdHlwZTogXCJ0ZXh0XCIsIGF1dG9mb2N1czogdHJ1ZSwgcmVmOiBmb3JtSW5wdXRFbGVtZW50LCB2YWx1ZTogZm9ybVZhbHVlLCBwbGFjZWhvbGRlcjogZm9ybVBsYWNlaG9sZGVyLCBkaXNhYmxlZDogIXRoaXMuaGFzUmVsYXRpb25zaGlwTGF5ZXIsIG9uQ2FsY2l0ZUlucHV0SW5wdXQ6IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5wdXRWYWwgPSBldmVudC50YXJnZXQudmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIGlmIChmb3JtVHlwZSA9PT0gXCJ0aXRsZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbGF0ZWRSZWNvcmRzQ29udGVudC50aXRsZSA9IGlucHV0VmFsO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQuZGVzY3JpcHRpb24gPSBpbnB1dFZhbDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgICAgICAgICAgICAgfSwgb25DbGljazogKCkgPT4gdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpIH0pLCAoKF9hID0gdGhpcy5wb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpICYmIChoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyB0ZXh0OiB0aGlzLnN0cmluZ3MuYXR0cmlidXRlcywgZGlzYWJsZWQ6ICF0aGlzLmhhc1JlbGF0aW9uc2hpcExheWVyLCBvbkNsaWNrOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLXBvcHVwLWZpZWxkLXBpY2stbGlzdFwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0LnBvcG92ZXJQcm9wcyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWZFbGVtZW50OiB0aGlzLnBvcHVwRmxvd0l0ZW0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0U2tpZGRpbmc6IDUwXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QubXVsdGlwbGUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0LmhlYWRpbmcgPSB0aGlzLnN0cmluZ3MuYWRkRmllbGQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzUG9wdXBQaWNrTGlzdERpc21pc3NlZFwiLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzUG9wdXBQaWNrTGlzdENoYW5nZVwiLCAoZXZlbnQpID0+IHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0Q2hhbmdlcyhldmVudCwgZm9ybVR5cGUpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KHRydWUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSwgc2NhbGU6IFwic1wiLCBpY29uOiBcImJyYWNrZXRzLWN1cmx5XCIgfSkpKSkpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLmd1aWQgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50ID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLmJsb2NrT3BlbiA9IGZhbHNlO1xuICAgICAgICB0aGlzLnBvcHVwRmxvd0l0ZW0gPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMucmVSZW5kZXIgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuaGFzUmVsYXRpb25zaGlwTGF5ZXIgPSB0cnVlO1xuICAgIH1cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vXG4gICAgLy8gIExpZmVjeWNsZVxuICAgIC8vXG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICBhc3luYyBjb21wb25lbnRXaWxsTG9hZCgpIHtcbiAgICAgICAgdGhpcy5zdHJpbmdzID0gcG9wdXBTdGF0ZS5zdHJpbmdzO1xuICAgICAgICB0aGlzLmxheWVyID0gcG9wdXBTdGF0ZS5sYXllcjtcbiAgICAgICAgdGhpcy52aWV3ID0gcG9wdXBTdGF0ZS5tYXBWaWV3O1xuICAgICAgICB0aGlzLnBvcHVwVGVtcGxhdGUgPSBwb3B1cFN0YXRlLnBvcHVwVGVtcGxhdGU7XG4gICAgICAgIGF3YWl0IHRoaXMubG9hZEFsbE1vZHVsZXMoKTtcbiAgICAgICAgdGhpcy5oYXNSZWxhdGlvbnNoaXBMYXllciA9IGF3YWl0IHRoaXMuY2hlY2tJZlJlbGF0aW9uc2hpcEV4aXN0cygpO1xuICAgICAgICBpZiAoIXRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50LnRpdGxlKSB7XG4gICAgICAgICAgICB0aGlzLnJlbGF0ZWRSZWNvcmRzQ29udGVudC50aXRsZSA9IFwiXCI7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGlzLnJlbGF0ZWRSZWNvcmRzQ29udGVudC5kZXNjcmlwdGlvbikge1xuICAgICAgICAgICAgdGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQuZGVzY3JpcHRpb24gPSBcIlwiO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgICAgIGlmICh0aGlzLmJsb2NrT3Blbikge1xuICAgICAgICAgICAgdGhpcy5ibG9ja09wdGlvbnMuc2Nyb2xsSW50b1ZpZXcoeyBiZWhhdmlvcjogXCJzbW9vdGhcIiwgYmxvY2s6IFwibmVhcmVzdFwiLCBpbmxpbmU6IFwic3RhcnRcIiB9KTtcbiAgICAgICAgICAgIHRoaXMuYmxvY2tPcHRpb25zLnNldEZvY3VzKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy53YXRjaEZvckNoYW5nZXNUb0xheWVyc0xpc3QoKTtcbiAgICB9XG4gICAgY29tcG9uZW50RGlkVXBkYXRlKCkge1xuICAgICAgICB0aGlzLmludGVybmFsUG9wdXBVcGRhdGVkLmVtaXQoKTtcbiAgICB9XG4gICAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgKF9hID0gdGhpcy53YXRjaExheWVyc1RhYmxlcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnJlbW92ZSgpO1xuICAgICAgICBpZiAodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpIHtcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QpIHtcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vXG4gICAgLy8gRXZlbnRzXG4gICAgLy9cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIGNsb3NlUG9wdXBQb3BvdmVyc0hhbmRsZXIoKSB7XG4gICAgICAgIGlmICh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCkge1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCk7XG4gICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCA9IG51bGw7XG4gICAgICAgICAgICB0aGlzLmRpc2FibGVQb3B1cFBhbmVsLmVtaXQoZmFsc2UpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QpIHtcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0KTtcbiAgICAgICAgICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdCA9IG51bGw7XG4gICAgICAgICAgICB0aGlzLmRpc2FibGVQb3B1cFBhbmVsLmVtaXQoZmFsc2UpO1xuICAgICAgICB9XG4gICAgfVxuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy9cbiAgICAvLyBQcml2YXRlIE1ldGhvZHNcbiAgICAvL1xuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgYXN5bmMgbG9hZEFsbE1vZHVsZXMoKSB7XG4gICAgICAgIFt0aGlzLlJlbGF0ZWRSZWNvcmRzSW5mb0ZpZWxkT3JkZXIsIHRoaXMucmVhY3RpdmVVdGlsc10gPSBhd2FpdCBsb2FkTW9kdWxlcyhbXG4gICAgICAgICAgICBcImVzcmkvcG9wdXAvc3VwcG9ydC9SZWxhdGVkUmVjb3Jkc0luZm9GaWVsZE9yZGVyXCIsXG4gICAgICAgICAgICBcImVzcmkvY29yZS9yZWFjdGl2ZVV0aWxzXCJcbiAgICAgICAgXSk7XG4gICAgfVxuICAgIC8vIGZpZWxkIHNlbGVjdGlvbiBmb3IgdGl0bGUgYW5kIGNhcHRpb25cbiAgICBwb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3RDaGFuZ2VzKGV2ZW50LCBmb3JtVHlwZSkge1xuICAgICAgICBjb25zdCBzZWxlY3RlZEZpZWxkTmFtZSA9IGV2ZW50LmRldGFpbC5zZWxlY3RlZEZpZWxkc1swXTtcbiAgICAgICAgaWYgKGZvcm1UeXBlID09PSBcInRpdGxlXCIpIHtcbiAgICAgICAgICAgIHRoaXMuY29udGVudFRpdGxlLnZhbHVlID0gYWRkU2VsZWN0ZWRGaWVsZEF0Q3Vyc29yKHRoaXMuY29udGVudFRpdGxlLCBzZWxlY3RlZEZpZWxkTmFtZSk7XG4gICAgICAgICAgICB0aGlzLmNvbnRlbnRUaXRsZS5zZXRGb2N1cygpO1xuICAgICAgICAgICAgdGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQudGl0bGUgPSB0aGlzLmNvbnRlbnRUaXRsZS52YWx1ZTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChmb3JtVHlwZSA9PT0gXCJkZXNjcmlwdGlvblwiKSB7XG4gICAgICAgICAgICB0aGlzLmNvbnRlbnREZXNjcmlwdGlvbi52YWx1ZSA9IGFkZFNlbGVjdGVkRmllbGRBdEN1cnNvcih0aGlzLmNvbnRlbnREZXNjcmlwdGlvbiwgc2VsZWN0ZWRGaWVsZE5hbWUpO1xuICAgICAgICAgICAgdGhpcy5jb250ZW50RGVzY3JpcHRpb24uc2V0Rm9jdXMoKTtcbiAgICAgICAgICAgIHRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50LmRlc2NyaXB0aW9uID0gdGhpcy5jb250ZW50RGVzY3JpcHRpb24udmFsdWU7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgfVxuICAgIGFzeW5jIG9wZW5QaWNrTGlzdChjdXJyTGF5ZXIpIHtcbiAgICAgICAgdmFyIF9hLCBfYiwgX2M7XG4gICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICAgICAgaWYgKCF0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QpIHtcbiAgICAgICAgICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtZmllbGQtcGljay1saXN0XCIpO1xuICAgICAgICAgICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0LnBvcG92ZXJQcm9wcyA9IHtcbiAgICAgICAgICAgICAgICByZWZFbGVtZW50OiB0aGlzLnBvcHVwRmxvd0l0ZW0sXG4gICAgICAgICAgICAgICAgb2Zmc2V0U2tpZGRpbmc6IDUwXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0LmZpZWxkcyA9IGN1cnJMYXllci5maWVsZHMuZmlsdGVyKChmaWVsZCkgPT4gZmllbGQudmlzaWJsZSk7XG4gICAgICAgICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QubGF5ZXIgPSBjdXJyTGF5ZXI7XG4gICAgICAgICAgICB0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QubWFwVmlldyA9IHRoaXMudmlldztcbiAgICAgICAgICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdC5zaG93RmllbGRJbmZvID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdC5zaG93RmllbGROYW1lID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuYXJjZ2lzRmllbGRQaWNrTGlzdC5zZWxlY3RlZEZpZWxkcyA9IFtcbiAgICAgICAgICAgICAgICAoX2MgPSAoX2IgPSAoX2EgPSB0aGlzLnJlbGF0ZWRSZWNvcmRzQ29udGVudCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLm9yZGVyQnlGaWVsZHMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYlswXSkgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmZpZWxkXG4gICAgICAgICAgICBdO1xuICAgICAgICAgICAgdGhpcy5hcmNnaXNGaWVsZFBpY2tMaXN0LmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNGaWVsZFBpY2tMaXN0RGlzbWlzc2VkXCIsIHRoaXMuZmllbGRQaWNrTGlzdENoYW5nZXMpO1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLmFyY2dpc0ZpZWxkUGlja0xpc3QpO1xuICAgICAgICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KHRydWUpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGFzeW5jIGNoZWNrSWZSZWxhdGlvbnNoaXBFeGlzdHMoKSB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgZm9yIChjb25zdCByZWxhdGlvbnNoaXAgb2YgKF9hID0gdGhpcy5sYXllcikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnJlbGF0aW9uc2hpcHMpIHtcbiAgICAgICAgICAgIGlmIChyZWxhdGlvbnNoaXAuaWQgPT09IHRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50LnJlbGF0aW9uc2hpcElkKSB7XG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBjdXJyTGF5ZXJPclRhYmxlIG9mIFsuLi50aGlzLnZpZXcubWFwLmFsbExheWVycywgLi4udGhpcy52aWV3Lm1hcC5hbGxUYWJsZXNdKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGN1cnIgPSBjdXJyTGF5ZXJPclRhYmxlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXdhaXQgcmVsYXRpb25zaGlwRXhpc3RzKHRoaXMubGF5ZXIsIGN1cnIsIHJlbGF0aW9uc2hpcCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGN1cnIubG9hZCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGZhbHNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGZhbHNlKTtcbiAgICB9XG4gICAgd2F0Y2hGb3JDaGFuZ2VzVG9MYXllcnNMaXN0KCkge1xuICAgICAgICB0aGlzLndhdGNoTGF5ZXJzVGFibGVzID0gdGhpcy5yZWFjdGl2ZVV0aWxzLndhdGNoKCgpID0+IFt0aGlzLnZpZXcubWFwLmFsbExheWVycy5sZW5ndGgsIHRoaXMudmlldy5tYXAuYWxsVGFibGVzLmxlbmd0aF0sIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIC8vIGNoZWNrIGlmIHJlbGF0ZWQgbGF5ZXIvdGFibGUgaXMgcmVtb3ZlZCwgYW5kIGRpc2FibGUgcGFuZWwvc2hvdyB3YXJuaW5nIGlmIHllc1xuICAgICAgICAgICAgdGhpcy5oYXNSZWxhdGlvbnNoaXBMYXllciA9IGF3YWl0IHRoaXMuY2hlY2tJZlJlbGF0aW9uc2hpcEV4aXN0cygpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvL1xuICAgIC8vIFJlbmRvciAgTWV0aG9kc1xuICAgIC8vXG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIHZhciBfYSwgX2IsIF9jLCBfZCwgX2UsIF9mLCBfZztcbiAgICAgICAgY29uc3QgcmVsYXRpb25zaGlwID0gKGgoXCJjYWxjaXRlLWxhYmVsXCIsIG51bGwsIHRoaXMuc3RyaW5ncy5yZWxhdGlvbnNoaXAsIGgoXCJjYWxjaXRlLWRyb3Bkb3duXCIsIHsgZGlzYWJsZWQ6ICF0aGlzLmhhc1JlbGF0aW9uc2hpcExheWVyLCBvdmVybGF5UG9zaXRpb25pbmc6IFwiZml4ZWRcIiwgY2xhc3M6IFwiZHJvcGRvd25cIiB9LCBoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBzbG90OiBcInRyaWdnZXJcIiwgYXBwZWFyYW5jZTogXCJvdXRsaW5lLWZpbGxcIiwga2luZDogXCJuZXV0cmFsXCIsIGljb25FbmQ6IFwiY2hldnJvbkRvd25cIiwgYWxpZ25tZW50OiBcImljb24tZW5kLXNwYWNlLWJldHdlZW5cIiwgd2lkdGg6IFwiZnVsbFwiLCBzY2FsZTogXCJtXCIgfSwgKCgpID0+IHtcbiAgICAgICAgICAgIGZvciAoY29uc3QgcmVsYXRpb25zaGlwIG9mIHRoaXMubGF5ZXIucmVsYXRpb25zaGlwcykge1xuICAgICAgICAgICAgICAgIGlmIChyZWxhdGlvbnNoaXAuaWQgPT09IHRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50LnJlbGF0aW9uc2hpcElkKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZWxhdGlvbnNoaXAubmFtZSB8fCB0aGlzLnN0cmluZ3MucmVsYXRpb25zaGlwO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0aGlzLnN0cmluZ3MucmVsYXRpb25zaGlwO1xuICAgICAgICB9KSgpKSwgaChcImNhbGNpdGUtZHJvcGRvd24tZ3JvdXBcIiwgbnVsbCwgdGhpcy5sYXllci5yZWxhdGlvbnNoaXBzLm1hcCgocmVsYXRpb25zaGlwKSA9PiB7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGN1cnJMYXllck9yVGFibGUgb2YgW1xuICAgICAgICAgICAgICAgIC4uLnRoaXMudmlldy5tYXAuYWxsTGF5ZXJzLFxuICAgICAgICAgICAgICAgIC4uLnRoaXMudmlldy5tYXAuYWxsVGFibGVzXG4gICAgICAgICAgICBdKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY3VyciA9IGN1cnJMYXllck9yVGFibGU7XG4gICAgICAgICAgICAgICAgaWYgKHJlbGF0aW9uc2hpcEV4aXN0c0NoZWNrV2l0aG91dExvYWQodGhpcy5sYXllciwgY3VyciwgcmVsYXRpb25zaGlwKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWRyb3Bkb3duLWl0ZW1cIiwgeyBzZWxlY3RlZDogdGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQucmVsYXRpb25zaGlwSWQgPT09IHJlbGF0aW9uc2hpcC5pZCwgb25DbGljazogYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfYTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBjdXJyLmxvYWQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbGF0ZWRSZWNvcmRzQ29udGVudC5yZWxhdGlvbnNoaXBJZCA9IHJlbGF0aW9uc2hpcC5pZDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbGF0ZWRSZWNvcmRzQ29udGVudC5vcmRlckJ5RmllbGRzID0gW1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgdGhpcy5SZWxhdGVkUmVjb3Jkc0luZm9GaWVsZE9yZGVyKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkOiBjdXJyLmZpZWxkcy5maW5kKChmaWVsZCkgPT4gZmllbGQudmlzaWJsZSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAubmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9yZGVyOiAoKF9hID0gdGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQub3JkZXJCeUZpZWxkcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hWzBdLm9yZGVyKSB8fCBcImFzY1wiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IH0sIHJlbGF0aW9uc2hpcC5uYW1lIHx8IHRoaXMuc3RyaW5ncy5yZWxhdGlvbnNoaXApKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pKSkpKTtcbiAgICAgICAgY29uc3Qgc29ydEJ5ID0gKGgoXCJjYWxjaXRlLWxhYmVsXCIsIG51bGwsIHRoaXMuc3RyaW5ncy5zb3J0QnksIGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IGFwcGVhcmFuY2U6IFwib3V0bGluZS1maWxsXCIsIGtpbmQ6IFwibmV1dHJhbFwiLCBpY29uRW5kOiBcImNoZXZyb25Eb3duXCIsIGFsaWdubWVudDogXCJpY29uLWVuZC1zcGFjZS1iZXR3ZWVuXCIsIHdpZHRoOiBcImZ1bGxcIiwgc2NhbGU6IFwibVwiLCBkaXNhYmxlZDogIXRoaXMuaGFzUmVsYXRpb25zaGlwTGF5ZXIsIG9uQ2xpY2s6IGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICAvLyBmaW5kIHRoZSBsYXllci90YWJsZSwgYW5kIGRpc3BsYXkgdGhlIHBpY2sgbGlzdCBiYXNlZCBvbiB0aGUgcmVsYXRlZCBsYXllci90YWJsZVxuICAgICAgICAgICAgICAgIHRoaXMubGF5ZXIucmVsYXRpb25zaGlwcy5tYXAoYXN5bmMgKHJlbGF0aW9uc2hpcCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGN1cnJMYXllck9yVGFibGUgb2YgW1xuICAgICAgICAgICAgICAgICAgICAgICAgLi4udGhpcy52aWV3Lm1hcC5hbGxMYXllcnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAuLi50aGlzLnZpZXcubWFwLmFsbFRhYmxlc1xuICAgICAgICAgICAgICAgICAgICBdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjdXJyID0gY3VyckxheWVyT3JUYWJsZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlbGF0ZWRSZWNvcmRzQ29udGVudC5yZWxhdGlvbnNoaXBJZCA9PT0gcmVsYXRpb25zaGlwLmlkICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVsYXRpb25zaGlwRXhpc3RzQ2hlY2tXaXRob3V0TG9hZCh0aGlzLmxheWVyLCBjdXJyLCByZWxhdGlvbnNoaXApKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGVuUGlja0xpc3QoY3Vycik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gfSwgKChfYyA9IChfYiA9IChfYSA9IHRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50KSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Eub3JkZXJCeUZpZWxkcykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iWzBdKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MuZmllbGQpIHx8IHRoaXMuc3RyaW5ncy5kZWZhdWx0KSkpO1xuICAgICAgICBjb25zdCBzb3J0T3JkZXIgPSAoaChcImNhbGNpdGUtbGFiZWxcIiwgbnVsbCwgdGhpcy5zdHJpbmdzLnNvcnRPcmRlciwgaChcImNhbGNpdGUtZHJvcGRvd25cIiwgeyBkaXNhYmxlZDogIXRoaXMuaGFzUmVsYXRpb25zaGlwTGF5ZXIsIG92ZXJsYXlQb3NpdGlvbmluZzogXCJmaXhlZFwiIH0sIGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IHNsb3Q6IFwidHJpZ2dlclwiLCBhcHBlYXJhbmNlOiBcIm91dGxpbmUtZmlsbFwiLCBraW5kOiBcIm5ldXRyYWxcIiwgaWNvbkVuZDogXCJjaGV2cm9uRG93blwiLCBhbGlnbm1lbnQ6IFwiaWNvbi1lbmQtc3BhY2UtYmV0d2VlblwiLCB3aWR0aDogXCJmdWxsXCIsIHNjYWxlOiBcIm1cIiB9LCAoKF9kID0gdGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQub3JkZXJCeUZpZWxkcykgPT09IG51bGwgfHwgX2QgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9kWzBdLm9yZGVyKSA9PT0gXCJkZXNjXCJcbiAgICAgICAgICAgID8gdGhpcy5zdHJpbmdzLmRlc2NlbmRpbmdcbiAgICAgICAgICAgIDogdGhpcy5zdHJpbmdzLmFzY2VuZGluZyksIGgoXCJjYWxjaXRlLWRyb3Bkb3duLWl0ZW1cIiwgeyBzZWxlY3RlZDogKChfZSA9IHRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50Lm9yZGVyQnlGaWVsZHMpID09PSBudWxsIHx8IF9lID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZVswXS5vcmRlcikgPT09IFwiYXNjXCIsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlbGF0ZWRSZWNvcmRzQ29udGVudC5vcmRlckJ5RmllbGRzWzBdLm9yZGVyID0gXCJhc2NcIjtcbiAgICAgICAgICAgICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgICAgICAgICB9IH0sIHRoaXMuc3RyaW5ncy5hc2NlbmRpbmcpLCBoKFwiY2FsY2l0ZS1kcm9wZG93bi1pdGVtXCIsIHsgc2VsZWN0ZWQ6ICgoX2YgPSB0aGlzLnJlbGF0ZWRSZWNvcmRzQ29udGVudC5vcmRlckJ5RmllbGRzKSA9PT0gbnVsbCB8fCBfZiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2ZbMF0ub3JkZXIpID09PSBcImRlc2NcIiwgb25DbGljazogKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50Lm9yZGVyQnlGaWVsZHNbMF0ub3JkZXIgPSBcImRlc2NcIjtcbiAgICAgICAgICAgICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgICAgICAgICB9IH0sIHRoaXMuc3RyaW5ncy5kZXNjZW5kaW5nKSkpKTtcbiAgICAgICAgY29uc3QgcHJldmlld0NvdW50ID0gKGgoXCJjYWxjaXRlLWxhYmVsXCIsIG51bGwsIHRoaXMuc3RyaW5ncy5wcmV2aWV3Q291bnQsIGgoXCJjYWxjaXRlLWRyb3Bkb3duXCIsIHsgZGlzYWJsZWQ6ICF0aGlzLmhhc1JlbGF0aW9uc2hpcExheWVyLCBvdmVybGF5UG9zaXRpb25pbmc6IFwiZml4ZWRcIiB9LCBoKFwiY2FsY2l0ZS1idXR0b25cIiwgeyBzbG90OiBcInRyaWdnZXJcIiwgYXBwZWFyYW5jZTogXCJvdXRsaW5lLWZpbGxcIiwga2luZDogXCJuZXV0cmFsXCIsIGljb25FbmQ6IFwiY2hldnJvbkRvd25cIiwgYWxpZ25tZW50OiBcImljb24tZW5kLXNwYWNlLWJldHdlZW5cIiwgd2lkdGg6IFwiZnVsbFwiLCBzY2FsZTogXCJtXCIgfSwgKF9nID0gKHRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50LmRpc3BsYXlDb3VudCA9PT0gMFxuICAgICAgICAgICAgPyB0aGlzLnN0cmluZ3Mubm9uZVxuICAgICAgICAgICAgOiB0aGlzLnJlbGF0ZWRSZWNvcmRzQ29udGVudC5kaXNwbGF5Q291bnQpKSAhPT0gbnVsbCAmJiBfZyAhPT0gdm9pZCAwID8gX2cgOiAxKSwgaChcImNhbGNpdGUtZHJvcGRvd24tZ3JvdXBcIiwgbnVsbCwgWy4uLkFycmF5KHRoaXMubWF4UHJldmlld0NvdW50KS5rZXlzKCldLm1hcCgoeCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1kcm9wZG93bi1pdGVtXCIsIHsgc2VsZWN0ZWQ6IHRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50LmRpc3BsYXlDb3VudCA9PT0geCwgb25DbGljazogKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbGF0ZWRSZWNvcmRzQ29udGVudC5kaXNwbGF5Q291bnQgPSB4O1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlUmVuZGVyID0gIXRoaXMucmVSZW5kZXI7XG4gICAgICAgICAgICAgICAgfSB9LCB4ID09PSAwID8gdGhpcy5zdHJpbmdzLm5vbmUgOiB4KSk7XG4gICAgICAgIH0pKSkpKTtcbiAgICAgICAgcmV0dXJuIChoKEhvc3QsIG51bGwsIGgoXCJjYWxjaXRlLWJsb2NrXCIsIHsgZGlyOiBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpLCBoZWFkaW5nOiB0aGlzLnN0cmluZ3MucmVsYXRlZFJlY29yZHMsIGRlc2NyaXB0aW9uOiAodGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQudGl0bGUgJiZcbiAgICAgICAgICAgICAgICBgJHt0aGlzLnJlbGF0ZWRSZWNvcmRzQ29udGVudC50aXRsZS5zdWJzdHJpbmcoMCwgMjUpfSR7dGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQudGl0bGUubGVuZ3RoID4gMjUgPyBcIi4uLlwiIDogXCJcIn1gKSB8fFxuICAgICAgICAgICAgICAgICgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcmVsYXRpb25zaGlwIG9mIHRoaXMubGF5ZXIucmVsYXRpb25zaGlwcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlbGF0aW9uc2hpcC5pZCA9PT0gdGhpcy5yZWxhdGVkUmVjb3Jkc0NvbnRlbnQucmVsYXRpb25zaGlwSWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVsYXRpb25zaGlwLm5hbWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RyaW5ncy5zZWxlY3RUYWJsZTtcbiAgICAgICAgICAgICAgICB9KSgpLCBjb2xsYXBzaWJsZTogdHJ1ZSwgb3BlbjogdGhpcy5ibG9ja09wZW4sIGRyYWdIYW5kbGU6IHRydWUsIG9uQ2FsY2l0ZUJsb2NrT3BlbjogKCkgPT4gdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpLCBvbkNhbGNpdGVCbG9ja0Nsb3NlOiAoKSA9PiB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCkgfSwgaChcImRpdlwiLCB7IGNsYXNzOiBcImlnbm9yZS1lbGVtZW50cy1zb3J0YWJsZVwiLCBzbG90OiBcImNvbnRyb2xcIiB9LCBoKFwiYXJjZ2lzLWNhbGNpdGUtYmxvY2stb3B0aW9uc1wiLCB7IHJlZjogKGVsKSA9PiAodGhpcy5ibG9ja09wdGlvbnMgPSBlbCksIGd1aWQ6IHRoaXMuZ3VpZCwgaW50bE9wdGlvbnM6IHRoaXMuc3RyaW5ncy5vcHRpb25zLCBpbnRsRGVsZXRlOiB0aGlzLnN0cmluZ3MuZGVsZXRlLCBpbnRsRHVwbGljYXRlOiB0aGlzLnN0cmluZ3MuZHVwbGljYXRlLCBjYWxjaXRlQmxvY2tPcHRpb25zOiB7IGhhc0RlbGV0ZTogdHJ1ZSwgaGFzRHVwbGljYXRlOiB0aGlzLmhhc1JlbGF0aW9uc2hpcExheWVyIH0gfSkpLCBoKFwiZGl2XCIsIHsgc2xvdDogXCJpY29uXCIgfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcIm1cIiwgaWNvbjogdGhpcy5oYXNSZWxhdGlvbnNoaXBMYXllciA/IFwibGlua1wiIDogXCJleGNsYW1hdGlvbi1tYXJrLXRyaWFuZ2xlXCIgfSkpLCBoKFwiZGl2XCIsIHsgY2xhc3M6IFwiaWdub3JlLWVsZW1lbnRzLXNvcnRhYmxlXCIgfSwgdGhpcy5mb3JtSW5wdXQoXCJ0aXRsZVwiLCB0aGlzLnN0cmluZ3MudGl0bGUsIChlbGVtZW50KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gKHRoaXMuY29udGVudFRpdGxlID0gZWxlbWVudCk7XG4gICAgICAgIH0sIHRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50LnRpdGxlLCB0aGlzLnN0cmluZ3MuZW50ZXJUaXRsZSksIHRoaXMuZm9ybUlucHV0KFwiZGVzY3JpcHRpb25cIiwgdGhpcy5zdHJpbmdzLmRlc2MsIChlbGVtZW50KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gKHRoaXMuY29udGVudERlc2NyaXB0aW9uID0gZWxlbWVudCk7XG4gICAgICAgIH0sIHRoaXMucmVsYXRlZFJlY29yZHNDb250ZW50LmRlc2NyaXB0aW9uLCB0aGlzLnN0cmluZ3MuZW50ZXJEZXNjcmlwdGlvbiksIHJlbGF0aW9uc2hpcCwgc29ydEJ5LCBzb3J0T3JkZXIsIHByZXZpZXdDb3VudCkpKSk7XG4gICAgfVxuICAgIGdldCBob3N0RWxlbWVudCgpIHsgcmV0dXJuIGdldEVsZW1lbnQodGhpcyk7IH1cbn07XG5BcmNnaXNQb3B1cFJlbGF0aW9uc2hpcC5zdHlsZSA9IGFyY2dpc1BvcHVwUmVsYXRpb25zaGlwQ3NzO1xuXG5jb25zdCBBcmNnaXNQb3B1cFJpY2h0ZXh0ID0gY2xhc3Mge1xuICAgIGNvbnN0cnVjdG9yKGhvc3RSZWYpIHtcbiAgICAgICAgcmVnaXN0ZXJJbnN0YW5jZSh0aGlzLCBob3N0UmVmKTtcbiAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMgPSBjcmVhdGVFdmVudCh0aGlzLCBcImNsb3NlUG9wdXBQb3BvdmVyc1wiLCA3KTtcbiAgICAgICAgdGhpcy5pbnRlcm5hbFBvcHVwVXBkYXRlZCA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiaW50ZXJuYWxQb3B1cFVwZGF0ZWRcIiwgNyk7XG4gICAgICAgIHRoaXMucmljaFRleHRDaGFuZ2VkUmVSZW5kZXIgPSBjcmVhdGVFdmVudCh0aGlzLCBcInJpY2hUZXh0Q2hhbmdlZFJlUmVuZGVyXCIsIDcpO1xuICAgICAgICB0aGlzLmRpc2FibGVQb3B1cFBhbmVsID0gY3JlYXRlRXZlbnQodGhpcywgXCJkaXNhYmxlUG9wdXBQYW5lbFwiLCA3KTtcbiAgICAgICAgdGhpcy5hcmNhZGVFeHBNYXAgPSBuZXcgTWFwKCk7XG4gICAgICAgIHRoaXMuZ3VpZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5maWVsZEV4cHJlc3Npb25EYXRhID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLmFyY2dpc0NvbG9yUGlja2VyRGF0YSA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5yaWNodGV4dENvbnRlbnQgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuYmxvY2tPcGVuID0gZmFsc2U7XG4gICAgICAgIHRoaXMucG9wdXBGbG93SXRlbSA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5yZVJlbmRlciA9IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgLy8gbGlmZWN5Y2xlIG1ldGhvZHNcbiAgICBjb21wb25lbnRXaWxsTG9hZCgpIHtcbiAgICAgICAgdGhpcy5zdHJpbmdzID0gcG9wdXBTdGF0ZS5zdHJpbmdzO1xuICAgICAgICB0aGlzLmN1cnJlbnRMYW5ndWFnZSA9IHBvcHVwU3RhdGUuY3VycmVudExhbmd1YWdlO1xuICAgICAgICB0aGlzLnBvcHVwVGVtcGxhdGUgPSBwb3B1cFN0YXRlLnBvcHVwVGVtcGxhdGU7XG4gICAgfVxuICAgIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgICAgIHRoaXMuY2tFZGl0b3JNZW50aW9uRmllbGRzU2V0dXAoKTtcbiAgICAgICAgaWYgKHRoaXMuYmxvY2tPcGVuKSB7XG4gICAgICAgICAgICBjb25zdCBjb250ZW50ID0gdGhpcy5ob3N0RWxlbWVudC5zaGFkb3dSb290LmdldEVsZW1lbnRCeUlkKFwiY29udGVudF9JZFwiKTtcbiAgICAgICAgICAgIGNvbnRlbnQuc2Nyb2xsSW50b1ZpZXcoe1xuICAgICAgICAgICAgICAgIGJlaGF2aW9yOiBcImF1dG9cIixcbiAgICAgICAgICAgICAgICBibG9jazogXCJuZWFyZXN0XCIsXG4gICAgICAgICAgICAgICAgaW5saW5lOiBcInN0YXJ0XCJcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGhpcy5zaG93UmljaFRleHRFZGl0b3IoKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBjb21wb25lbnREaWRVcGRhdGUoKSB7XG4gICAgICAgIHRoaXMuaW50ZXJuYWxQb3B1cFVwZGF0ZWQuZW1pdCgpO1xuICAgIH1cbiAgICBkaXNjb25uZWN0ZWRDYWxsYmFjaygpIHtcbiAgICAgICAgaWYgKHRoaXMuYXJjZ2lzQ2tlZGl0b3I1KSB7XG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuYXJjZ2lzQ2tlZGl0b3I1KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICAvLyBFdmVudHNcbiAgICByaWNoVGV4dENoYW5nZWRSZVJlbmRlckhhbmRsZXIoZXZlbnQpIHtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIHRoaXMucmVSZW5kZXIgPSB0aGlzLnJlUmVuZGVyID8gZmFsc2UgOiB0cnVlO1xuICAgIH1cbiAgICBjbG9zZUFsbFBvcG92ZXJzSGFuZGxlcigpIHtcbiAgICAgICAgaWYgKHRoaXMuYXJjZ2lzQ2tlZGl0b3I1KSB7XG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuYXJjZ2lzQ2tlZGl0b3I1KTtcbiAgICAgICAgICAgIHRoaXMuYXJjZ2lzQ2tlZGl0b3I1ID0gbnVsbDtcbiAgICAgICAgICAgIHRoaXMuZGlzYWJsZVBvcHVwUGFuZWwuZW1pdChmYWxzZSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgY2tFZGl0b3JQb3BvdmVyQ2xvc2VkSGFuZGxlcihldmVudCkge1xuICAgICAgICB2YXIgX2EsIF9iLCBfYywgX2QsIF9lO1xuICAgICAgICBpZiAoKChfYSA9IGV2ZW50LmRldGFpbCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmd1aWQpID09PSB0aGlzLmd1aWQpIHtcbiAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgaWYgKCgoX2MgPSAoX2IgPSBldmVudC5kZXRhaWwpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5kYXRhKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MubGVuZ3RoKSB8fCAoKF9lID0gKF9kID0gZXZlbnQuZGV0YWlsKSA9PT0gbnVsbCB8fCBfZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2QuZGF0YSkgPT09IG51bGwgfHwgX2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9lLmxlbmd0aCkgPT09IDApIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJpY2h0ZXh0Q29udGVudC50ZXh0ID0gZXZlbnQuZGV0YWlsLmRhdGE7XG4gICAgICAgICAgICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgICAgICAgICAgICAgIHRoaXMucmljaFRleHRDaGFuZ2VkUmVSZW5kZXIuZW1pdCgpO1xuICAgICAgICAgICAgfSAvLyBlbHNlIG51bGxcbiAgICAgICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBjYWxjaXRlQmxvY2tUb2dnbGVIYW5kbGVyKCkge1xuICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgfVxuICAgIC8vIGZvciBhcmNhZGUgY2hhbmdlc1xuICAgIGFyY2FkZUNoYW5nZU5vdGlmaWNhdGlvbkhhbmRsZXIoKSB7XG4gICAgICAgIHRoaXMuY2tFZGl0b3JNZW50aW9uRmllbGRzU2V0dXAoKTtcbiAgICB9XG4gICAgLy8gcHJpdmF0ZSBtZXRob2RzIGFuZCBwcm9wZXJ0aWVzXG4gICAgY2tFZGl0b3JNZW50aW9uRmllbGRzU2V0dXAoKSB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgdGhpcy5hcmNhZGVFeHBNYXAgPSBnZW5lcmF0ZUFyY2FkZUV4cHJlc3Npb25NYXAodGhpcy5wb3B1cFRlbXBsYXRlKTtcbiAgICAgICAgdGhpcy5ja0VkaXRvck1lbnRpb25GaWVsZHMgPSBbXTtcbiAgICAgICAgKF9hID0gdGhpcy5wb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5mb3JFYWNoKChmaWVsZCkgPT4ge1xuICAgICAgICAgICAgaWYgKGZpZWxkLmZpZWxkTmFtZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuY2tFZGl0b3JNZW50aW9uRmllbGRzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICBpZDogXCJ7XCIgKyBmaWVsZC5maWVsZE5hbWUgKyBcIn1cIixcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogZ2V0RmllbGREaXNwbGF5TmFtZShmaWVsZCwgdGhpcy5hcmNhZGVFeHBNYXApXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBnZXRUZXh0RnJvbUh0bWwodG90YWxDaGFycykge1xuICAgICAgICB2YXIgX2E7XG4gICAgICAgIGNvbnN0IHRlbXBIdG1sID0gKF9hID0gdGhpcy5yaWNodGV4dENvbnRlbnQudGV4dCkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogXCJcIjtcbiAgICAgICAgY29uc3QgdGVtcERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gICAgICAgIHRlbXBEaXYuaW5uZXJIVE1MID0gdGVtcEh0bWw7XG4gICAgICAgIGNvbnN0IHRlbXBTdHJpbmcgPSB0ZW1wRGl2LnRleHRDb250ZW50IHx8IHRlbXBEaXYuaW5uZXJUZXh0IHx8IFwiXCI7XG4gICAgICAgIHJldHVybiBgJHt0ZW1wU3RyaW5nLnN1YnN0cmluZygwLCB0b3RhbENoYXJzKX0ke3RlbXBTdHJpbmcubGVuZ3RoID4gdG90YWxDaGFycyA/IFwiLi4uXCIgOiBcIlwifWA7XG4gICAgfVxuICAgIHNob3dSaWNoVGV4dEVkaXRvcigpIHtcbiAgICAgICAgdmFyIF9hLCBfYjtcbiAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgICAgICB0aGlzLmFyY2dpc0NrZWRpdG9yNSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtY2tlZGl0b3I1XCIpO1xuICAgICAgICB0aGlzLmFyY2dpc0NrZWRpdG9yNS5maWVsZEV4cHJlc3Npb25Db25maWcgPSB0aGlzLmZpZWxkRXhwcmVzc2lvbkRhdGE7XG4gICAgICAgIHRoaXMuYXJjZ2lzQ2tlZGl0b3I1LmFyY2dpc0NvbG9yUGlja2VyQ29uZmlnID0gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCB0aGlzLmFyY2dpc0NvbG9yUGlja2VyRGF0YSksIHsgZW5hYmxlRmllbGRzOiB0aGlzLmFyY2dpc0NvbG9yUGlja2VyRGF0YS5kYXRhICYmIHRoaXMuYXJjZ2lzQ29sb3JQaWNrZXJEYXRhLmRhdGEubGVuZ3RoID8gdHJ1ZSA6IGZhbHNlIH0pO1xuICAgICAgICB0aGlzLmFyY2dpc0NrZWRpdG9yNS5ndWlkID0gdGhpcy5ndWlkO1xuICAgICAgICB0aGlzLmFyY2dpc0NrZWRpdG9yNS5yZWZFbGVtZW50ID0gdGhpcy5wb3B1cEZsb3dJdGVtO1xuICAgICAgICB0aGlzLmFyY2dpc0NrZWRpdG9yNS50ZXh0RGF0YSA9IChfYSA9IHRoaXMucmljaHRleHRDb250ZW50LnRleHQpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IFwiXCI7XG4gICAgICAgIHRoaXMuYXJjZ2lzQ2tlZGl0b3I1LmNrRWRpdG9yTWVudGlvbkZpZWxkcyA9IHRoaXMuY2tFZGl0b3JNZW50aW9uRmllbGRzO1xuICAgICAgICB0aGlzLmFyY2dpc0NrZWRpdG9yNS5pbnRsVGV4dFBsYWNlSG9sZGVyID1cbiAgICAgICAgICAgICgoX2IgPSB0aGlzLnBvcHVwVGVtcGxhdGUuZmllbGRJbmZvcykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmxlbmd0aCkgPiAwXG4gICAgICAgICAgICAgICAgPyB0aGlzLnN0cmluZ3MudGV4dFBsYWNlSG9sZGVyXG4gICAgICAgICAgICAgICAgOiB0aGlzLnN0cmluZ3MudGV4dFBsYWNlSG9sZGVyTGFiZWw7XG4gICAgICAgIHRoaXMuYXJjZ2lzQ2tlZGl0b3I1LmludGxPayA9IHRoaXMuc3RyaW5ncy5vaztcbiAgICAgICAgdGhpcy5hcmNnaXNDa2VkaXRvcjUuaW50bENhbmNlbCA9IHRoaXMuc3RyaW5ncy5jYW5jZWw7XG4gICAgICAgIHRoaXMuYXJjZ2lzQ2tlZGl0b3I1LmN1cnJlbnRMYW5ndWFnZSA9IHRoaXMuY3VycmVudExhbmd1YWdlO1xuICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMuYXJjZ2lzQ2tlZGl0b3I1KTtcbiAgICAgICAgdGhpcy5hcmNnaXNDa2VkaXRvcjUuc2V0Rm9jdXMoKTtcbiAgICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KHRydWUpO1xuICAgIH1cbiAgICAvLyByZW5kb3IgbWV0aG9kc1xuICAgIHJlbmRlcigpIHtcbiAgICAgICAgcmV0dXJuIChoKEhvc3QsIG51bGwsIGgoXCJjYWxjaXRlLWJsb2NrXCIsIHsgZGlyOiBnZXRFbGVtZW50RGlyKHRoaXMuaG9zdEVsZW1lbnQpLCBpZDogXCJyaWNoVGV4dF9JZFwiLCBoZWFkaW5nOiB0aGlzLnN0cmluZ3MudGV4dCwgZGVzY3JpcHRpb246IHRoaXMuZ2V0VGV4dEZyb21IdG1sKDI1KSwgb3BlbjogdGhpcy5ibG9ja09wZW4sIGNvbGxhcHNpYmxlOiB0cnVlLCBkcmFnSGFuZGxlOiB0cnVlIH0sIGgoXCJkaXZcIiwgeyBjbGFzczogXCJpZ25vcmUtZWxlbWVudHMtc29ydGFibGVcIiwgc2xvdDogXCJjb250cm9sXCIgfSwgaChcImFyY2dpcy1jYWxjaXRlLWJsb2NrLW9wdGlvbnNcIiwgeyBndWlkOiB0aGlzLmd1aWQsIGludGxPcHRpb25zOiB0aGlzLnN0cmluZ3Mub3B0aW9ucywgaW50bERlbGV0ZTogdGhpcy5zdHJpbmdzLmRlbGV0ZSwgaW50bER1cGxpY2F0ZTogdGhpcy5zdHJpbmdzLmR1cGxpY2F0ZSwgY2FsY2l0ZUJsb2NrT3B0aW9uczogeyBoYXNEZWxldGU6IHRydWUsIGhhc0R1cGxpY2F0ZTogdHJ1ZSB9IH0pKSwgaChcImRpdlwiLCB7IHNsb3Q6IFwiaWNvblwiIH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBzY2FsZTogXCJtXCIsIGljb246IFwidGV4dFwiIH0pKSwgaChcImRpdlwiLCB7IGNsYXNzOiBcImlnbm9yZS1lbGVtZW50cy1zb3J0YWJsZVwiLCBpZDogXCJjb250ZW50X0lkXCIgfSwgaChcImNhbGNpdGUtYnV0dG9uXCIsIHsgYXBwZWFyYW5jZTogXCJ0cmFuc3BhcmVudFwiLCB3aWR0aDogXCJmdWxsXCIsIG9uQ2xpY2s6ICgpID0+IHRoaXMuc2hvd1JpY2hUZXh0RWRpdG9yKCkgfSwgdGhpcy5zdHJpbmdzLmVkaXRUZXh0KSkpKSk7XG4gICAgfVxuICAgIGdldCBob3N0RWxlbWVudCgpIHsgcmV0dXJuIGdldEVsZW1lbnQodGhpcyk7IH1cbn07XG5cbmNvbnN0IENTUyA9IHtcbiAgICBmb3JtSW5wdXRCdXR0b246IFwiZm9ybS1pbnB1dC1idXR0b25cIlxufTtcblxuY29uc3QgYXJjZ2lzUG9wdXBUaXRsZUNzcyA9IFwiLmZvcm0taW5wdXQtYnV0dG9ue2Rpc3BsYXk6ZmxleH0uZm9ybS1pbnB1dC1idXR0b24gY2FsY2l0ZS1pbnB1dFt0eXBlPXRleHRde2Rpc3BsYXk6ZmxleDtmbGV4LWZsb3c6Y29sdW1uIG5vd3JhcDtmbGV4OjEgMCAwJTtvdmVyZmxvdzpoaWRkZW59LmZvcm0taW5wdXQtYnV0dG9uIGNhbGNpdGUtYWN0aW9ue21hcmdpbjowO2ZsZXg6MCAwIDAlO2p1c3RpZnktc2VsZjpmbGV4LWVuZH1cIjtcblxuY29uc3QgQXJjZ2lzUG9wdXBUaXRsZSA9IGNsYXNzIHtcbiAgICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgICAgIHJlZ2lzdGVySW5zdGFuY2UodGhpcywgaG9zdFJlZik7XG4gICAgICAgIHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzID0gY3JlYXRlRXZlbnQodGhpcywgXCJjbG9zZVBvcHVwUG9wb3ZlcnNcIiwgNyk7XG4gICAgICAgIHRoaXMudGl0bGVDaGFuZ2VkUmVSZW5kZXIgPSBjcmVhdGVFdmVudCh0aGlzLCBcInRpdGxlQ2hhbmdlZFJlUmVuZGVyXCIsIDcpO1xuICAgICAgICB0aGlzLmludGVybmFsUG9wdXBVcGRhdGVkID0gY3JlYXRlRXZlbnQodGhpcywgXCJpbnRlcm5hbFBvcHVwVXBkYXRlZFwiLCA3KTtcbiAgICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbCA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiZGlzYWJsZVBvcHVwUGFuZWxcIiwgNyk7XG4gICAgICAgIC8vIHByaXZhdGUgbWV0aG9kcyBhbmQgcHJvcGVydGllc1xuICAgICAgICB0aGlzLmNoYW5nZVRpdGxlID0gKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5wb3B1cFRlbXBsYXRlLnRpdGxlID0gdGhpcy50aXRsZUlucHV0LnZhbHVlO1xuICAgICAgICAgICAgdGhpcy5pbnRlcm5hbFBvcHVwVXBkYXRlZC5lbWl0KCk7XG4gICAgICAgICAgICB0aGlzLnRpdGxlQ2hhbmdlZFJlUmVuZGVyLmVtaXQoKTtcbiAgICAgICAgfTtcbiAgICAgICAgLy8gb3BlbiBwb3BvdmVyXG4gICAgICAgIHRoaXMub3BlbkF0dHJpYnV0ZXNMaXN0ID0gKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIC8vIGNsb3NlIGZpcnN0IHNpbmNlIHdlIGNhbiBoYXZlIG11bHRpcGxlIGF0dHJpYnV0ZXMgb3BlblxuICAgICAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgICAgICAgICAgLy8gbGF6eSBsb2FkIGF0dHJpYnV0ZSBzZWxlY3Rpb24gY29tcG9uZW50XG4gICAgICAgICAgICBpZiAoIXRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYXJjZ2lzLXBvcHVwLWZpZWxkLXBpY2stbGlzdFwiKTtcbiAgICAgICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5wb3BvdmVyUHJvcHMgPSB7XG4gICAgICAgICAgICAgICAgICAgIHJlZkVsZW1lbnQ6IHRoaXMucG9wdXBGbG93SXRlbVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgdGhpcy5wb3B1cEZpZWxkU2VsZWN0aW9uUGlja0xpc3QubXVsdGlwbGUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdC5oZWFkaW5nID0gdGhpcy5zdHJpbmdzLmFkZEZpZWxkO1xuICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0LmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNQb3B1cFBpY2tMaXN0RGlzbWlzc2VkXCIsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZVBvcHVwUG9wb3ZlcnMuZW1pdCgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0LmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNQb3B1cFBpY2tMaXN0Q2hhbmdlXCIsIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0Q2hhbmdlcyk7XG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdCk7XG4gICAgICAgICAgICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnBvcHVwRmllbGRTZWxlY3Rpb25QaWNrTGlzdENoYW5nZXMgPSAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkRmllbGROYW1lID0gZXZlbnQuZGV0YWlsLnNlbGVjdGVkRmllbGRzWzBdO1xuICAgICAgICAgICAgdGhpcy50aXRsZUlucHV0LnZhbHVlID0gYWRkU2VsZWN0ZWRGaWVsZEF0Q3Vyc29yKHRoaXMudGl0bGVJbnB1dCwgc2VsZWN0ZWRGaWVsZE5hbWUpO1xuICAgICAgICAgICAgdGhpcy50aXRsZUlucHV0LnNldEZvY3VzKCk7XG4gICAgICAgICAgICB0aGlzLnBvcHVwVGVtcGxhdGUudGl0bGUgPSB0aGlzLnRpdGxlSW5wdXQudmFsdWU7XG4gICAgICAgICAgICB0aGlzLmNoYW5nZVRpdGxlKCk7XG4gICAgICAgICAgICB0aGlzLmNsb3NlUG9wdXBQb3BvdmVycy5lbWl0KCk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMucG9wdXBGbG93SXRlbSA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5yZVJlbmRlciA9IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgLy8gbGlmZWN5Y2xlIG1ldGhvZHNcbiAgICBjb21wb25lbnRXaWxsTG9hZCgpIHtcbiAgICAgICAgdGhpcy5zdHJpbmdzID0gcG9wdXBTdGF0ZS5zdHJpbmdzO1xuICAgICAgICB0aGlzLnBvcHVwVGVtcGxhdGUgPSBwb3B1cFN0YXRlLnBvcHVwVGVtcGxhdGU7XG4gICAgfVxuICAgIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgICAgIHRoaXMuZ3VpZEZvclNlbGVjdGlvbiA9IGd1aWQoKTtcbiAgICB9XG4gICAgLy8gRXZlbnRzXG4gICAgdGl0bGVDaGFuZ2VkUmVSZW5kZXJIYW5kbGVyKGV2ZW50KSB7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICB0aGlzLnJlUmVuZGVyID0gdGhpcy5yZVJlbmRlciA/IGZhbHNlIDogdHJ1ZTtcbiAgICB9XG4gICAgY2xvc2VQb3B1cFBvcG92ZXJzSGFuZGxlcigpIHtcbiAgICAgICAgaWYgKHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KSB7XG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0KTtcbiAgICAgICAgICAgIHRoaXMucG9wdXBGaWVsZFNlbGVjdGlvblBpY2tMaXN0ID0gbnVsbDtcbiAgICAgICAgICAgIHRoaXMudGl0bGVJbnB1dC5zZXRGb2N1cygpO1xuICAgICAgICAgICAgdGhpcy5kaXNhYmxlUG9wdXBQYW5lbC5lbWl0KGZhbHNlKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICAvLyByZW5kb3IgbWV0aG9kc1xuICAgIHJlbmRlcigpIHtcbiAgICAgICAgdmFyIF9hO1xuICAgICAgICBjb25zdCBwb3B1cFRpdGxlID0gdGhpcy5wb3B1cFRlbXBsYXRlLnRpdGxlO1xuICAgICAgICByZXR1cm4gKGgoSG9zdCwgbnVsbCwgaChcImNhbGNpdGUtYmxvY2tcIiwgeyBkaXI6IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCksIGhlYWRpbmc6IHRoaXMuc3RyaW5ncy5wb3B1cFRpdGxlLCBkZXNjcmlwdGlvbjogcG9wdXBUaXRsZSAmJiBgJHtwb3B1cFRpdGxlLnN1YnN0cmluZygwLCAyNSl9JHtwb3B1cFRpdGxlLmxlbmd0aCA+IDI1ID8gXCIuLi5cIiA6IFwiXCJ9YCwgY29sbGFwc2libGU6IHRydWUgfSwgaChcImRpdlwiLCB7IHNsb3Q6IFwiaWNvblwiIH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBzY2FsZTogXCJtXCIsIGljb246IFwidGl0bGVcIiB9KSksIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTLmZvcm1JbnB1dEJ1dHRvbiB9LCBoKFwiY2FsY2l0ZS1pbnB1dFwiLCB7IHR5cGU6IFwidGV4dFwiLCBhdXRvZm9jdXM6IHRydWUsIHJlZjogKGVsZW1lbnQpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnRpdGxlSW5wdXQgPSBlbGVtZW50O1xuICAgICAgICAgICAgfSwgdmFsdWU6IHBvcHVwVGl0bGUsIG9uQ2FsY2l0ZUlucHV0SW5wdXQ6IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgIHRoaXMuY2hhbmdlVGl0bGUoKTtcbiAgICAgICAgICAgIH0sIG9uQ2xpY2s6ICgpID0+IHRoaXMuY2xvc2VQb3B1cFBvcG92ZXJzLmVtaXQoKSB9KSwgKChfYSA9IHRoaXMucG9wdXBUZW1wbGF0ZS5maWVsZEluZm9zKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKSA+IDAgJiYgKGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IHNjYWxlOiBcInNcIiwgdGV4dDogdGhpcy5zdHJpbmdzLmF0dHJpYnV0ZXMsIG9uQ2xpY2s6IHRoaXMub3BlbkF0dHJpYnV0ZXNMaXN0LCBpY29uOiBcImJyYWNrZXRzLWN1cmx5XCIgfSkpKSkpKTtcbiAgICB9XG4gICAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcbkFyY2dpc1BvcHVwVGl0bGUuc3R5bGUgPSBhcmNnaXNQb3B1cFRpdGxlQ3NzO1xuXG5leHBvcnQgeyBBcmNnaXNQb3B1cCBhcyBhcmNnaXNfcG9wdXAsIEFyY2dpc1BvcHVwQXJjYWRlIGFzIGFyY2dpc19wb3B1cF9hcmNhZGUsIEFyY2dpc1BvcHVwQXR0YWNobWVudHMgYXMgYXJjZ2lzX3BvcHVwX2F0dGFjaG1lbnRzLCBBcmNnaXNQb3B1cEF0dHJpYnV0ZXMgYXMgYXJjZ2lzX3BvcHVwX2F0dHJpYnV0ZXMsIEFyY2dpc1BvcHVwQ2hhcnQgYXMgYXJjZ2lzX3BvcHVwX2NoYXJ0LCBBcmNnaXNQb3B1cEV4cHJlc3Npb25zIGFzIGFyY2dpc19wb3B1cF9leHByZXNzaW9ucywgQXJjZ2lzUG9wdXBGaWVsZFBpY2tMaXN0IGFzIGFyY2dpc19wb3B1cF9maWVsZF9waWNrX2xpc3QsIEFyY2dpc1BvcHVwSW1hZ2UgYXMgYXJjZ2lzX3BvcHVwX2ltYWdlLCBBcmNnaXNQb3B1cE1haW5Db250ZW50cG9wb3ZlciBhcyBhcmNnaXNfcG9wdXBfbWFpbl9jb250ZW50cG9wb3ZlciwgQXJjZ2lzUG9wdXBNdWx0aW1lZGlhIGFzIGFyY2dpc19wb3B1cF9tdWx0aW1lZGlhLCBBcmNnaXNQb3B1cFJlbGF0aW9uc2hpcCBhcyBhcmNnaXNfcG9wdXBfcmVsYXRpb25zaGlwLCBBcmNnaXNQb3B1cFJpY2h0ZXh0IGFzIGFyY2dpc19wb3B1cF9yaWNodGV4dCwgQXJjZ2lzUG9wdXBUaXRsZSBhcyBhcmNnaXNfcG9wdXBfdGl0bGUgfTtcblxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9YXJjZ2lzLXBvcHVwXzEzLmVudHJ5LmpzLm1hcCIsIi8qIVxuICogQWxsIG1hdGVyaWFsIGNvcHlyaWdodCBFU1JJLCBBbGwgUmlnaHRzIFJlc2VydmVkLCB1bmxlc3Mgb3RoZXJ3aXNlIHNwZWNpZmllZC5cbiAqIHY0LjAuNThcbiAqL1xuZnVuY3Rpb24gZ2VuZXJhdGVJZChjb3VudHMpIHtcbiAgICByZXR1cm4gY291bnRzXG4gICAgICAgIC5tYXAoKGNvdW50KSA9PiB7XG4gICAgICAgIGxldCBvdXQgPSBcIlwiO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHtcbiAgICAgICAgICAgIG91dCArPSAoKCgxICsgTWF0aC5yYW5kb20oKSkgKiAweDEwMDAwKSB8IDApLnRvU3RyaW5nKDE2KS5zdWJzdHJpbmcoMSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG91dDtcbiAgICB9KVxuICAgICAgICAuam9pbihcIi1cIik7XG59XG5jb25zdCBndWlkID0gKCkgPT4gZ2VuZXJhdGVJZChbMiwgMSwgMSwgMSwgM10pO1xuXG5leHBvcnQgeyBndWlkIGFzIGcgfTtcblxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9Z3VpZC1hZWFlZDg0ZC5qcy5tYXAiLCIvKiFcbiAqIEFsbCBtYXRlcmlhbCBjb3B5cmlnaHQgRVNSSSwgQWxsIFJpZ2h0cyBSZXNlcnZlZCwgdW5sZXNzIG90aGVyd2lzZSBzcGVjaWZpZWQuXG4gKiB2NC4wLjU4XG4gKi9cbmltcG9ydCB7IGcgYXMgZ2V0UmVuZGVyaW5nUmVmLCBmIGFzIGZvcmNlVXBkYXRlIH0gZnJvbSAnLi9pbmRleC1lM2JmN2RhNy5qcyc7XG5cbmNvbnN0IGFwcGVuZFRvTWFwID0gKG1hcCwgcHJvcE5hbWUsIHZhbHVlKSA9PiB7XG4gICAgY29uc3QgaXRlbXMgPSBtYXAuZ2V0KHByb3BOYW1lKTtcbiAgICBpZiAoIWl0ZW1zKSB7XG4gICAgICAgIG1hcC5zZXQocHJvcE5hbWUsIFt2YWx1ZV0pO1xuICAgIH1cbiAgICBlbHNlIGlmICghaXRlbXMuaW5jbHVkZXModmFsdWUpKSB7XG4gICAgICAgIGl0ZW1zLnB1c2godmFsdWUpO1xuICAgIH1cbn07XG5jb25zdCBkZWJvdW5jZSA9IChmbiwgbXMpID0+IHtcbiAgICBsZXQgdGltZW91dElkO1xuICAgIHJldHVybiAoLi4uYXJncykgPT4ge1xuICAgICAgICBpZiAodGltZW91dElkKSB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTtcbiAgICAgICAgfVxuICAgICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHRpbWVvdXRJZCA9IDA7XG4gICAgICAgICAgICBmbiguLi5hcmdzKTtcbiAgICAgICAgfSwgbXMpO1xuICAgIH07XG59O1xuXG4vKipcbiAqIENoZWNrIGlmIGEgcG9zc2libGUgZWxlbWVudCBpc0Nvbm5lY3RlZC5cbiAqIFRoZSBwcm9wZXJ0eSBtaWdodCBub3QgYmUgdGhlcmUsIHNvIHdlIGNoZWNrIGZvciBpdC5cbiAqXG4gKiBXZSB3YW50IGl0IHRvIHJldHVybiB0cnVlIGlmIGlzQ29ubmVjdGVkIGlzIG5vdCBhIHByb3BlcnR5LFxuICogb3RoZXJ3aXNlIHdlIHdvdWxkIHJlbW92ZSB0aGVzZSBlbGVtZW50cyBhbmQgd291bGQgbm90IHVwZGF0ZS5cbiAqXG4gKiBCZXR0ZXIgbGVhayBpbiBFZGdlIHRoYW4gdG8gYmUgdXNlbGVzcy5cbiAqL1xuY29uc3QgaXNDb25uZWN0ZWQgPSAobWF5YmVFbGVtZW50KSA9PiAhKCdpc0Nvbm5lY3RlZCcgaW4gbWF5YmVFbGVtZW50KSB8fCBtYXliZUVsZW1lbnQuaXNDb25uZWN0ZWQ7XG5jb25zdCBjbGVhbnVwRWxlbWVudHMgPSBkZWJvdW5jZSgobWFwKSA9PiB7XG4gICAgZm9yIChsZXQga2V5IG9mIG1hcC5rZXlzKCkpIHtcbiAgICAgICAgbWFwLnNldChrZXksIG1hcC5nZXQoa2V5KS5maWx0ZXIoaXNDb25uZWN0ZWQpKTtcbiAgICB9XG59LCAyMDAwKTtcbmNvbnN0IHN0ZW5jaWxTdWJzY3JpcHRpb24gPSAoKSA9PiB7XG4gICAgaWYgKHR5cGVvZiBnZXRSZW5kZXJpbmdSZWYgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgLy8gSWYgd2UgYXJlIG5vdCBpbiBhIHN0ZW5jaWwgcHJvamVjdCwgd2UgZG8gbm90aGluZy5cbiAgICAgICAgLy8gVGhpcyBmdW5jdGlvbiBpcyBub3QgcmVhbGx5IGV4cG9ydGVkIGJ5IEBzdGVuY2lsL2NvcmUuXG4gICAgICAgIHJldHVybiB7fTtcbiAgICB9XG4gICAgY29uc3QgZWxtc1RvVXBkYXRlID0gbmV3IE1hcCgpO1xuICAgIHJldHVybiB7XG4gICAgICAgIGRpc3Bvc2U6ICgpID0+IGVsbXNUb1VwZGF0ZS5jbGVhcigpLFxuICAgICAgICBnZXQ6IChwcm9wTmFtZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZWxtID0gZ2V0UmVuZGVyaW5nUmVmKCk7XG4gICAgICAgICAgICBpZiAoZWxtKSB7XG4gICAgICAgICAgICAgICAgYXBwZW5kVG9NYXAoZWxtc1RvVXBkYXRlLCBwcm9wTmFtZSwgZWxtKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgc2V0OiAocHJvcE5hbWUpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGVsZW1lbnRzID0gZWxtc1RvVXBkYXRlLmdldChwcm9wTmFtZSk7XG4gICAgICAgICAgICBpZiAoZWxlbWVudHMpIHtcbiAgICAgICAgICAgICAgICBlbG1zVG9VcGRhdGUuc2V0KHByb3BOYW1lLCBlbGVtZW50cy5maWx0ZXIoZm9yY2VVcGRhdGUpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNsZWFudXBFbGVtZW50cyhlbG1zVG9VcGRhdGUpO1xuICAgICAgICB9LFxuICAgICAgICByZXNldDogKCkgPT4ge1xuICAgICAgICAgICAgZWxtc1RvVXBkYXRlLmZvckVhY2goKGVsbXMpID0+IGVsbXMuZm9yRWFjaChmb3JjZVVwZGF0ZSkpO1xuICAgICAgICAgICAgY2xlYW51cEVsZW1lbnRzKGVsbXNUb1VwZGF0ZSk7XG4gICAgICAgIH0sXG4gICAgfTtcbn07XG5cbmNvbnN0IHVud3JhcCA9ICh2YWwpID0+ICh0eXBlb2YgdmFsID09PSAnZnVuY3Rpb24nID8gdmFsKCkgOiB2YWwpO1xuY29uc3QgY3JlYXRlT2JzZXJ2YWJsZU1hcCA9IChkZWZhdWx0U3RhdGUsIHNob3VsZFVwZGF0ZSA9IChhLCBiKSA9PiBhICE9PSBiKSA9PiB7XG4gICAgY29uc3QgdW53cmFwcGVkU3RhdGUgPSB1bndyYXAoZGVmYXVsdFN0YXRlKTtcbiAgICBsZXQgc3RhdGVzID0gbmV3IE1hcChPYmplY3QuZW50cmllcyh1bndyYXBwZWRTdGF0ZSAhPT0gbnVsbCAmJiB1bndyYXBwZWRTdGF0ZSAhPT0gdm9pZCAwID8gdW53cmFwcGVkU3RhdGUgOiB7fSkpO1xuICAgIGNvbnN0IGhhbmRsZXJzID0ge1xuICAgICAgICBkaXNwb3NlOiBbXSxcbiAgICAgICAgZ2V0OiBbXSxcbiAgICAgICAgc2V0OiBbXSxcbiAgICAgICAgcmVzZXQ6IFtdLFxuICAgIH07XG4gICAgY29uc3QgcmVzZXQgPSAoKSA9PiB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgLy8gV2hlbiByZXNldHRpbmcgdGhlIHN0YXRlLCB0aGUgZGVmYXVsdCBzdGF0ZSBtYXkgYmUgYSBmdW5jdGlvbiAtIHVud3JhcCBpdCB0byBpbnZva2UgaXQuXG4gICAgICAgIC8vIG90aGVyd2lzZSwgdGhlIHN0YXRlIHdvbid0IGJlIHByb3Blcmx5IHJlc2V0XG4gICAgICAgIHN0YXRlcyA9IG5ldyBNYXAoT2JqZWN0LmVudHJpZXMoKF9hID0gdW53cmFwKGRlZmF1bHRTdGF0ZSkpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IHt9KSk7XG4gICAgICAgIGhhbmRsZXJzLnJlc2V0LmZvckVhY2goKGNiKSA9PiBjYigpKTtcbiAgICB9O1xuICAgIGNvbnN0IGRpc3Bvc2UgPSAoKSA9PiB7XG4gICAgICAgIC8vIENhbGwgZmlyc3QgZGlzcG9zZSBhcyByZXNldHRpbmcgdGhlIHN0YXRlIHdvdWxkXG4gICAgICAgIC8vIGNhdXNlIGxlc3MgdXBkYXRlcyA7KVxuICAgICAgICBoYW5kbGVycy5kaXNwb3NlLmZvckVhY2goKGNiKSA9PiBjYigpKTtcbiAgICAgICAgcmVzZXQoKTtcbiAgICB9O1xuICAgIGNvbnN0IGdldCA9IChwcm9wTmFtZSkgPT4ge1xuICAgICAgICBoYW5kbGVycy5nZXQuZm9yRWFjaCgoY2IpID0+IGNiKHByb3BOYW1lKSk7XG4gICAgICAgIHJldHVybiBzdGF0ZXMuZ2V0KHByb3BOYW1lKTtcbiAgICB9O1xuICAgIGNvbnN0IHNldCA9IChwcm9wTmFtZSwgdmFsdWUpID0+IHtcbiAgICAgICAgY29uc3Qgb2xkVmFsdWUgPSBzdGF0ZXMuZ2V0KHByb3BOYW1lKTtcbiAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSh2YWx1ZSwgb2xkVmFsdWUsIHByb3BOYW1lKSkge1xuICAgICAgICAgICAgc3RhdGVzLnNldChwcm9wTmFtZSwgdmFsdWUpO1xuICAgICAgICAgICAgaGFuZGxlcnMuc2V0LmZvckVhY2goKGNiKSA9PiBjYihwcm9wTmFtZSwgdmFsdWUsIG9sZFZhbHVlKSk7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIGNvbnN0IHN0YXRlID0gKHR5cGVvZiBQcm94eSA9PT0gJ3VuZGVmaW5lZCdcbiAgICAgICAgPyB7fVxuICAgICAgICA6IG5ldyBQcm94eSh1bndyYXBwZWRTdGF0ZSwge1xuICAgICAgICAgICAgZ2V0KF8sIHByb3BOYW1lKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGdldChwcm9wTmFtZSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb3duS2V5cyhfKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIEFycmF5LmZyb20oc3RhdGVzLmtleXMoKSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGhhcyhfLCBwcm9wTmFtZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBzdGF0ZXMuaGFzKHByb3BOYW1lKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzZXQoXywgcHJvcE5hbWUsIHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgc2V0KHByb3BOYW1lLCB2YWx1ZSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9KSk7XG4gICAgY29uc3Qgb24gPSAoZXZlbnROYW1lLCBjYWxsYmFjaykgPT4ge1xuICAgICAgICBoYW5kbGVyc1tldmVudE5hbWVdLnB1c2goY2FsbGJhY2spO1xuICAgICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICAgICAgcmVtb3ZlRnJvbUFycmF5KGhhbmRsZXJzW2V2ZW50TmFtZV0sIGNhbGxiYWNrKTtcbiAgICAgICAgfTtcbiAgICB9O1xuICAgIGNvbnN0IG9uQ2hhbmdlID0gKHByb3BOYW1lLCBjYikgPT4ge1xuICAgICAgICBjb25zdCB1blNldCA9IG9uKCdzZXQnLCAoa2V5LCBuZXdWYWx1ZSkgPT4ge1xuICAgICAgICAgICAgaWYgKGtleSA9PT0gcHJvcE5hbWUpIHtcbiAgICAgICAgICAgICAgICBjYihuZXdWYWx1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICAvLyBXZSBuZWVkIHRvIHVud3JhcCB0aGUgZGVmYXVsdFN0YXRlIGJlY2F1c2UgaXQgbWlnaHQgYmUgYSBmdW5jdGlvbi5cbiAgICAgICAgLy8gT3RoZXJ3aXNlIHdlIG1pZ2h0IG5vdCBiZSBzZW5kaW5nIHRoZSByaWdodCByZXNldCB2YWx1ZS5cbiAgICAgICAgY29uc3QgdW5SZXNldCA9IG9uKCdyZXNldCcsICgpID0+IGNiKHVud3JhcChkZWZhdWx0U3RhdGUpW3Byb3BOYW1lXSkpO1xuICAgICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICAgICAgdW5TZXQoKTtcbiAgICAgICAgICAgIHVuUmVzZXQoKTtcbiAgICAgICAgfTtcbiAgICB9O1xuICAgIGNvbnN0IHVzZSA9ICguLi5zdWJzY3JpcHRpb25zKSA9PiB7XG4gICAgICAgIGNvbnN0IHVuc3VicyA9IHN1YnNjcmlwdGlvbnMucmVkdWNlKCh1bnN1YnMsIHN1YnNjcmlwdGlvbikgPT4ge1xuICAgICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbi5zZXQpIHtcbiAgICAgICAgICAgICAgICB1bnN1YnMucHVzaChvbignc2V0Jywgc3Vic2NyaXB0aW9uLnNldCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbi5nZXQpIHtcbiAgICAgICAgICAgICAgICB1bnN1YnMucHVzaChvbignZ2V0Jywgc3Vic2NyaXB0aW9uLmdldCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbi5yZXNldCkge1xuICAgICAgICAgICAgICAgIHVuc3Vicy5wdXNoKG9uKCdyZXNldCcsIHN1YnNjcmlwdGlvbi5yZXNldCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbi5kaXNwb3NlKSB7XG4gICAgICAgICAgICAgICAgdW5zdWJzLnB1c2gob24oJ2Rpc3Bvc2UnLCBzdWJzY3JpcHRpb24uZGlzcG9zZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHVuc3VicztcbiAgICAgICAgfSwgW10pO1xuICAgICAgICByZXR1cm4gKCkgPT4gdW5zdWJzLmZvckVhY2goKHVuc3ViKSA9PiB1bnN1YigpKTtcbiAgICB9O1xuICAgIGNvbnN0IGZvcmNlVXBkYXRlID0gKGtleSkgPT4ge1xuICAgICAgICBjb25zdCBvbGRWYWx1ZSA9IHN0YXRlcy5nZXQoa2V5KTtcbiAgICAgICAgaGFuZGxlcnMuc2V0LmZvckVhY2goKGNiKSA9PiBjYihrZXksIG9sZFZhbHVlLCBvbGRWYWx1ZSkpO1xuICAgIH07XG4gICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdGUsXG4gICAgICAgIGdldCxcbiAgICAgICAgc2V0LFxuICAgICAgICBvbixcbiAgICAgICAgb25DaGFuZ2UsXG4gICAgICAgIHVzZSxcbiAgICAgICAgZGlzcG9zZSxcbiAgICAgICAgcmVzZXQsXG4gICAgICAgIGZvcmNlVXBkYXRlLFxuICAgIH07XG59O1xuY29uc3QgcmVtb3ZlRnJvbUFycmF5ID0gKGFycmF5LCBpdGVtKSA9PiB7XG4gICAgY29uc3QgaW5kZXggPSBhcnJheS5pbmRleE9mKGl0ZW0pO1xuICAgIGlmIChpbmRleCA+PSAwKSB7XG4gICAgICAgIGFycmF5W2luZGV4XSA9IGFycmF5W2FycmF5Lmxlbmd0aCAtIDFdO1xuICAgICAgICBhcnJheS5sZW5ndGgtLTtcbiAgICB9XG59O1xuXG5jb25zdCBjcmVhdGVTdG9yZSA9IChkZWZhdWx0U3RhdGUsIHNob3VsZFVwZGF0ZSkgPT4ge1xuICAgIGNvbnN0IG1hcCA9IGNyZWF0ZU9ic2VydmFibGVNYXAoZGVmYXVsdFN0YXRlLCBzaG91bGRVcGRhdGUpO1xuICAgIG1hcC51c2Uoc3RlbmNpbFN1YnNjcmlwdGlvbigpKTtcbiAgICByZXR1cm4gbWFwO1xufTtcblxuZXhwb3J0IHsgY3JlYXRlU3RvcmUgYXMgYyB9O1xuXG4vLyMgc291cmNlTWFwcGluZ1VSTD1pbmRleC0wNTk1NmNhYi5qcy5tYXAiLCIvKiFcbiAqIEFsbCBtYXRlcmlhbCBjb3B5cmlnaHQgRVNSSSwgQWxsIFJpZ2h0cyBSZXNlcnZlZCwgdW5sZXNzIG90aGVyd2lzZSBzcGVjaWZpZWQuXG4gKiB2NC4wLjU4XG4gKi9cbmltcG9ydCB7IGMgYXMgY3JlYXRlU3RvcmUgfSBmcm9tICcuL2luZGV4LTA1OTU2Y2FiLmpzJztcblxuY29uc3QgcG9wdXBTdG9yZSA9IGNyZWF0ZVN0b3JlKHtcbiAgICBsYXllcjogbnVsbCxcbiAgICBtYXBWaWV3OiBudWxsLFxuICAgIHBvcnRhbDogbnVsbCxcbiAgICBjb25maWc6IG51bGwsXG4gICAgc3RyaW5nczogbnVsbCxcbiAgICBjdXJyZW50TGFuZ3VhZ2U6IG51bGwsXG4gICAgY3VycmVudExhbmd1YWdlSW50bDogbnVsbCxcbiAgICBzZXJ2aWNlVHlwZTogbnVsbCxcbiAgICBwb3B1cFRlbXBsYXRlOiBudWxsLFxuICAgIGxheWVySGFzQXR0YWNobWVudDogbnVsbCxcbiAgICBsYXllckhhc0VUOiBudWxsLFxuICAgIGxheWVySGFzQXR0cmlidXRlczogbnVsbCxcbiAgICBsYXllckhhc0NoYXJ0czogbnVsbCxcbiAgICBsYXllckhhc0ltYWdlczogbnVsbCxcbiAgICBsYXllckhhc1RleHQ6IG51bGwsXG4gICAgbGF5ZXJEaXNwbGF5VHlwZTogbnVsbCxcbiAgICBzdXBwb3J0c0FyY2FkZTogbnVsbCxcbiAgICBsYXllckhhc1JlbGF0ZWRSZWNvcmRzOiBmYWxzZVxufSk7XG4vLyB3b3JrYXJvdW5kIGZvciBzdGFydGluZyBhIHBhbmVsIHdpdGggYSBjbGVhbiBzdGF0ZVxuZnVuY3Rpb24gY2xlYXJQb3B1cFN0YXRlKHBvcHVwU3RhdGUpIHtcbiAgICBwb3B1cFN0YXRlLmxheWVyID0gbnVsbDtcbiAgICBwb3B1cFN0YXRlLm1hcFZpZXcgPSBudWxsO1xuICAgIHBvcHVwU3RhdGUucG9ydGFsID0gbnVsbDtcbiAgICBwb3B1cFN0YXRlLmNvbmZpZyA9IG51bGw7XG4gICAgcG9wdXBTdGF0ZS5zdHJpbmdzID0gbnVsbDtcbiAgICBwb3B1cFN0YXRlLmN1cnJlbnRMYW5ndWFnZSA9IG51bGw7XG4gICAgcG9wdXBTdGF0ZS5jdXJyZW50TGFuZ3VhZ2VJbnRsID0gbnVsbDtcbiAgICBwb3B1cFN0YXRlLnNlcnZpY2VUeXBlID0gbnVsbDtcbiAgICBwb3B1cFN0YXRlLnBvcHVwVGVtcGxhdGUgPSBudWxsO1xuICAgIHBvcHVwU3RhdGUubGF5ZXJIYXNBdHRhY2htZW50ID0gbnVsbDtcbiAgICBwb3B1cFN0YXRlLmxheWVySGFzRVQgPSBudWxsO1xuICAgIHBvcHVwU3RhdGUubGF5ZXJIYXNBdHRyaWJ1dGVzID0gbnVsbDtcbiAgICBwb3B1cFN0YXRlLmxheWVySGFzQ2hhcnRzID0gbnVsbDtcbiAgICBwb3B1cFN0YXRlLmxheWVySGFzSW1hZ2VzID0gbnVsbDtcbiAgICBwb3B1cFN0YXRlLmxheWVySGFzVGV4dCA9IG51bGw7XG4gICAgcG9wdXBTdGF0ZS5sYXllckRpc3BsYXlUeXBlID0gbnVsbDtcbiAgICBwb3B1cFN0YXRlLnN1cHBvcnRzQXJjYWRlID0gbnVsbDtcbiAgICBwb3B1cFN0YXRlLmxheWVySGFzUmVsYXRlZFJlY29yZHMgPSBmYWxzZTtcbn1cbmNvbnN0IHBvcHVwU3RhdGUgPSBwb3B1cFN0b3JlLnN0YXRlO1xuXG5leHBvcnQgeyBjbGVhclBvcHVwU3RhdGUgYXMgYywgcG9wdXBTdGF0ZSBhcyBwIH07XG5cbi8vIyBzb3VyY2VNYXBwaW5nVVJMPXBvcHVwU3RvcmUtODUzODE0NTMuanMubWFwIl0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9