"use strict";
(self["webpackChunkexb_client"] = self["webpackChunkexb_client"] || []).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_colorS-3eca0a"],{

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/colorSize-ce0ccdeb.js":
/*!***************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/colorSize-ce0ccdeb.js ***!
  \***************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   a: () => (/* binding */ createSizeAgeRenderer),
/* harmony export */   b: () => (/* binding */ createColorSizeRenderer),
/* harmony export */   c: () => (/* binding */ createSizeRenderer),
/* harmony export */   d: () => (/* binding */ createColorAgeSizeRenderer),
/* harmony export */   e: () => (/* binding */ createColorSizeAgeRenderer),
/* harmony export */   f: () => (/* binding */ createSizeRendererFromExisting),
/* harmony export */   g: () => (/* binding */ createSizeAgeRendererFromExisting),
/* harmony export */   h: () => (/* binding */ createColorAgeSizeRendererFromExisting),
/* harmony export */   i: () => (/* binding */ createColorSizeAgeRendererFromExisting),
/* harmony export */   j: () => (/* binding */ createColorSizeRendererFromExisting),
/* harmony export */   k: () => (/* binding */ createClassedSizeRendererFromExisting),
/* harmony export */   l: () => (/* binding */ getSizeSliderStops),
/* harmony export */   m: () => (/* binding */ getClassBreaksSizes),
/* harmony export */   s: () => (/* binding */ sameSizeField)
/* harmony export */ });
/* harmony import */ var _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./raster-unique-value-0976ec7f.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/raster-unique-value-0976ec7f.js");
/* harmony import */ var _loadModules_b4ac1247_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./loadModules-b4ac1247.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/loadModules-b4ac1247.js");
/* harmony import */ var _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./commonEnums-fcf13661.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/commonEnums-fcf13661.js");
/* harmony import */ var _color_d6da0a9a_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./color-d6da0a9a.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/color-d6da0a9a.js");
/* harmony import */ var _commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./commonFunctions-b0830e9e.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/commonFunctions-b0830e9e.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v4.0.58
 */






/**
 * Updates the layer with a Size renderer with default settings
 * @param options: options
 */
function createSizeRenderer(options) {
    var _a, _b;
    const { layer: smLayer, mapImageSublayer, mapView, supportsArcade, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const layer = smLayer;
    if (mapImageSublayer && !supportsArcade) {
        return createClassedSizeRenderer(options);
    }
    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer);
    const authInfo = renderer.authoringInfo;
    const rendererType = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.g)();
    options = options || {};
    const extras = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.m)((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer));
    const fieldInfo = (_a = options.fieldInfos) === null || _a === void 0 ? void 0 : _a[0];
    const theme = options.theme ? options.theme : "high-to-low";
    const config = {
        layer,
        view: mapView,
        field: fieldInfo === null || fieldInfo === void 0 ? void 0 : fieldInfo.field,
        theme,
        valueExpression: fieldInfo === null || fieldInfo === void 0 ? void 0 : fieldInfo.expression,
        valueExpressionTitle: fieldInfo === null || fieldInfo === void 0 ? void 0 : fieldInfo.expressionTitle,
        normalizationField: options.normalizationField,
        outlineOptimizationEnabled: mapImageSublayer
            ? false
            : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.i)(options.outlineOptimizationEnabled)
                ? options.outlineOptimizationEnabled
                : (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.q)(layer)
                    ? true
                    : false,
        sizeOptimizationEnabled: mapImageSublayer
            ? false
            : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.i)(options.sizeOptimizationEnabled)
                ? options.sizeOptimizationEnabled
                : true /* isPolygon(layer)
        ? true
        : false, */,
        legendOptions: options.legendOptions,
        defaultSymbolEnabled: false,
        forBinning: ((_b = layer.featureReduction) === null || _b === void 0 ? void 0 : _b.type) === "binning"
    };
    //console.log("createSizeRenderer-config", config);
    return modules.SizeCreator.createContinuousRenderer(config).then((result) => {
        //console.log("createSizeRenderer-success", result.renderer);
        if (!options.noReuse &&
            sameSizeField(options) &&
            ["size", "color-size", "type-size", "relationship-size"].indexOf(rendererType) > -1 &&
            authInfo &&
            authInfo.univariateTheme !== "above-and-below") {
            // re-use size renderer
            const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer).clone();
            const sizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(renderer, "size");
            const authSizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.p)(renderer, "size");
            const sizeOutlineVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(renderer, "size", "outline");
            result.renderer.visualVariables = [sizeVisVar];
            if (sizeOutlineVisVar) {
                result.renderer.visualVariables.push(sizeOutlineVisVar);
            }
            result.renderer.authoringInfo.visualVariables = [authSizeVisVar];
            /* if (renderer.classBreakInfos?.length) {
              result.renderer.classBreakInfos[0].symbol = renderer.classBreakInfos[0].symbol;
            } else {
              result.renderer.classBreakInfos[0].symbol = renderer.uniqueValueInfos[0].symbol;
            } color-size -> size: markers loose orange color */
            (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.Q)(result.renderer);
        }
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.l)(extras, result.renderer);
        //console.log("createSizeRenderer out", result.renderer.toJSON());
        return Promise.resolve(result);
    }, (error) => Promise.reject(error));
}
/**
 * Creates a Size Age renderer with default settings
 * @param options: options
 */
function createSizeAgeRenderer(options) {
    var _a;
    const { layer: smLayer, mapImageSublayer, mapView, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const layer = smLayer;
    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer);
    const authInfo = renderer.authoringInfo;
    const rendererType = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.g)();
    options = options || {};
    const extras = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.m)((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer));
    const fieldInfo = (_a = options.fieldInfos) === null || _a === void 0 ? void 0 : _a[0];
    const theme = options.theme ? options.theme : "high-to-low";
    const config = {
        layer,
        view: mapView,
        startTime: fieldInfo === null || fieldInfo === void 0 ? void 0 : fieldInfo.field,
        endTime: new Date(),
        theme,
        unit: undefined,
        outlineOptimizationEnabled: mapImageSublayer
            ? false
            : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.i)(options.outlineOptimizationEnabled)
                ? options.outlineOptimizationEnabled
                : (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.q)(layer)
                    ? true
                    : false,
        sizeOptimizationEnabled: true,
        legendOptions: options.legendOptions,
        defaultSymbolEnabled: false
    };
    return modules.SizeCreator.createAgeRenderer(config).then((result) => {
        if (sameSizeField(options) &&
            ["size-age", "color-size-age", "type-size-age"].indexOf(rendererType) > -1 &&
            authInfo &&
            (authInfo === null || authInfo === void 0 ? void 0 : authInfo.univariateTheme) !== "above-and-below") {
            // re-use size renderer
            const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer).clone();
            const sizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(renderer, "size");
            const authSizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.p)(renderer, "size");
            const sizeOutlineVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(renderer, "size", "outline");
            result.renderer.visualVariables = [sizeVisVar];
            if (sizeOutlineVisVar) {
                result.renderer.visualVariables.push(sizeOutlineVisVar);
            }
            result.renderer.authoringInfo.visualVariables = [authSizeVisVar];
            /* if (renderer.classBreakInfos?.length) {
              result.renderer.classBreakInfos[0].symbol = renderer.classBreakInfos[0].symbol;
            } else {
              result.renderer.classBreakInfos[0].symbol = renderer.uniqueValueInfos[0].symbol;
            } color-size -> size: markers loose orange color */
            (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.Q)(result.renderer);
        }
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.l)(extras, result.renderer);
        //console.log("createSizeAgeRenderer out", result.renderer.toJSON());
        return Promise.resolve(result);
    }, (error) => Promise.reject(error));
}
/**
 * Updates the layer with a Size renderer with default settings
 * @param options: options
 */
function createClassedSizeRenderer(options) {
    var _a, _b;
    const { layer: smLayer, mapImageSublayer, mapView, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const layer = smLayer;
    options = options || {};
    const extras = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.m)((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer));
    const fieldInfo = (_a = options.fieldInfos) === null || _a === void 0 ? void 0 : _a[0];
    return modules.SizeCreator.createClassBreaksRenderer({
        layer,
        view: mapView,
        field: fieldInfo === null || fieldInfo === void 0 ? void 0 : fieldInfo.field,
        valueExpression: fieldInfo === null || fieldInfo === void 0 ? void 0 : fieldInfo.expression,
        valueExpressionTitle: fieldInfo === null || fieldInfo === void 0 ? void 0 : fieldInfo.expressionTitle,
        normalizationField: undefined,
        classificationMethod: options.classificationMethod ? options.classificationMethod : "natural-breaks",
        standardDeviationInterval: options.classificationMethod === "standard-deviation"
            ? options.standardDeviationInterval
                ? options.standardDeviationInterval
                : 1
            : undefined,
        numClasses: options.numClasses ? options.numClasses : 4,
        outlineOptimizationEnabled: mapImageSublayer
            ? false
            : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.i)(options.outlineOptimizationEnabled)
                ? options.outlineOptimizationEnabled
                : (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.q)(layer)
                    ? true
                    : false,
        legendOptions: options.legendOptions,
        defaultSymbolEnabled: false,
        forBinning: ((_b = layer.featureReduction) === null || _b === void 0 ? void 0 : _b.type) === "binning"
    }).then((result) => {
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.l)(extras, result.renderer);
        return Promise.resolve(result);
    }, (error) => Promise.reject(error));
}
/**
 * Creates a Size renderer with settings from current renderer
 */
function createSizeRendererFromExisting(options) {
    var _a, _b, _c, _d;
    const { layer: smLayer, mapImageSublayer, mapView, supportsArcade, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const layer = smLayer;
    if (mapImageSublayer && !supportsArcade) {
        return createClassedSizeRendererFromExisting(options);
    }
    options = options || {};
    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer);
    const authInfo = renderer.authoringInfo || {};
    const rendererType = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.g)();
    const sizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(renderer, "size");
    const authSizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.p)(renderer, "size");
    const extras = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.m)(renderer);
    let symbol;
    if (["type-size", "relationship-size"].indexOf(rendererType) > -1) {
        const uvRenderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer);
        symbol =
            uvRenderer.uniqueValueInfos && uvRenderer.uniqueValueInfos.length
                ? uvRenderer.uniqueValueInfos[0].symbol
                : (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.S)(layer, mapView, rendererType);
    }
    else {
        // use largest symbol
        symbol =
            renderer.classBreakInfos && renderer.classBreakInfos.length
                ? renderer.classBreakInfos[renderer.classBreakInfos.length - 1].symbol
                : (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.S)(layer, mapView, rendererType);
    }
    const defaultSymbol = renderer.defaultSymbol;
    const defaultLabel = renderer.defaultLabel;
    const backgroundFillSymbol = renderer.backgroundFillSymbol;
    const theme = options.theme ? options.theme : authSizeVisVar ? authSizeVisVar.theme : "high-to-low";
    let isInverted = false;
    if (sizeVisVar) {
        if (theme === sizeVisVar.theme) {
            // only if theme stays the same
            if (sizeVisVar.minSize.stops) {
                isInverted = sizeVisVar.minSize.stops[0].size > sizeVisVar.maxSize.stops[0].size;
            }
            else {
                isInverted = sizeVisVar.minSize > sizeVisVar.maxSize;
            }
        }
    }
    else {
        const minSym = renderer.classBreakInfos[0].symbol;
        const maxSym = renderer.classBreakInfos[renderer.classBreakInfos.length - 1].symbol;
        const lowValue = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.T)(minSym);
        const highValue = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.T)(maxSym);
        isInverted = lowValue > highValue;
    }
    if (options.fieldInfos &&
        options.fieldInfos[0] &&
        sizeVisVar &&
        options.fieldInfos[0].field === sizeVisVar.field &&
        options.fieldInfos[0].expression === sizeVisVar.valueExpression &&
        options.normalizationField === sizeVisVar.normalizationField) {
        delete options.fieldInfos;
        if ((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.R)(options)) {
            // nothing really changes; remove color visVar if there is one
            const newRenderer = renderer.clone();
            newRenderer.visualVariables = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.n)(renderer, "color");
            //console.log("createSizeRendererFromExisting out 1", newRenderer.toJSON());
            return Promise.resolve({ renderer: newRenderer });
        }
    }
    const fieldInfo = options.fieldInfos && options.fieldInfos[0]
        ? options.fieldInfos[0]
        : sizeVisVar
            ? {
                field: sizeVisVar.field,
                expression: sizeVisVar.valueExpression,
                expressionTitle: sizeVisVar.valueExpressionTitle,
                simpleFieldType: _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.w.NUMBER
            }
            : {
                field: renderer.field,
                expression: renderer.valueExpression,
                expressionTitle: renderer.valueExpressionTitle,
                simpleFieldType: _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.w.NUMBER
            };
    const normalizationField = options.normalizationField === null
        ? undefined
        : options.normalizationField
            ? options.normalizationField
            : sizeVisVar
                ? sizeVisVar.normalizationField
                : renderer.normalizationField;
    let needNewStatistics = false;
    if (options.normalizationField === null ||
        options.normalizationField ||
        (options.fieldInfos && options.fieldInfos[0]) ||
        (authInfo.classificationMethod === "manual" && !options.theme) ||
        authInfo.classificationMethod === "equal-interval") {
        needNewStatistics = true;
    }
    const minValue = options.discardMinMax
        ? undefined
        : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.i)(options.min)
            ? options.min
            : needNewStatistics
                ? undefined
                : sizeVisVar
                    ? authSizeVisVar === null || authSizeVisVar === void 0 ? void 0 : authSizeVisVar.minSliderValue
                    : renderer.classBreakInfos[0].minValue;
    const maxValue = options.discardMinMax
        ? undefined
        : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.i)(options.max)
            ? options.max
            : needNewStatistics
                ? undefined
                : sizeVisVar
                    ? authSizeVisVar === null || authSizeVisVar === void 0 ? void 0 : authSizeVisVar.maxSliderValue
                    : renderer.classBreakInfos[renderer.classBreakInfos.length - 1].maxValue;
    const config = {
        layer,
        view: mapView,
        theme,
        field: fieldInfo.field,
        valueExpression: fieldInfo.expression,
        valueExpressionTitle: fieldInfo.expressionTitle,
        normalizationField,
        minValue,
        maxValue,
        outlineOptimizationEnabled: mapImageSublayer
            ? false
            : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.i)(options.outlineOptimizationEnabled)
                ? options.outlineOptimizationEnabled
                : !!extras.sizeOutlineVisVar,
        sizeOptimizationEnabled: mapImageSublayer
            ? false
            : sizeVisVar
                ? (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.i)(options.sizeOptimizationEnabled)
                    ? options.sizeOptimizationEnabled
                    : typeof sizeVisVar.minSize === "object"
                : true /* isPolygon(layer)
        ? true
        : false, */,
        legendOptions: ((_a = options.legendOptions) === null || _a === void 0 ? void 0 : _a.toJSON()) ||
            ((_b = sizeVisVar === null || sizeVisVar === void 0 ? void 0 : sizeVisVar.legendOptions) === null || _b === void 0 ? void 0 : _b.toJSON()) ||
            ((_c = renderer.legendOptions) === null || _c === void 0 ? void 0 : _c.toJSON()),
        defaultSymbolEnabled: (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.i)(options.defaultSymbolEnabled)
            ? options.defaultSymbolEnabled
            : !!renderer.defaultSymbol,
        forBinning: ((_d = layer.featureReduction) === null || _d === void 0 ? void 0 : _d.type) === "binning"
    };
    // console.log("createSizeRendererFromExisting-config", config);
    return modules.SizeCreator.createContinuousRenderer(config).then((result) => {
        var _a;
        // console.log("createSizeRendererFromExisting-success", result.renderer.toJSON());
        // reset data values if necessary
        if (options.discardMinMax) {
            const sizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(renderer, "size");
            const newSizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(result.renderer, "size");
            sizeVisVar.minDataValue = newSizeVisVar.minDataValue;
            sizeVisVar.maxDataValue = newSizeVisVar.maxDataValue;
        }
        // keep slider values
        if (!options.fieldInfos &&
            options.normalizationField === undefined &&
            sizeVisVar &&
            theme === (sizeVisVar === null || sizeVisVar === void 0 ? void 0 : sizeVisVar.theme)) {
            const newSizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(result.renderer, "size");
            newSizeVisVar.minDataValue = sizeVisVar.minDataValue;
            newSizeVisVar.maxDataValue = sizeVisVar.maxDataValue;
        }
        if ([
            "color-size",
            "color-age-size",
            "color-size-age",
            "type-size",
            "type-size-age",
            "relationship-size",
            "predominance-size"
        ].indexOf(rendererType) > -1) {
            // just switch out size variables
            renderer.visualVariables = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.n)(renderer, "size") || [];
            renderer.visualVariables = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.n)(renderer, "size", "outline") || [];
            renderer.authoringInfo.visualVariables = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.o)(renderer, "size") || [];
            const sizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(result.renderer, "size");
            renderer.visualVariables.push(sizeVisVar);
            const sizeAuthVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.p)(result.renderer, "size");
            renderer.authoringInfo.visualVariables.push(sizeAuthVisVar);
            const sizeOutlineVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(result.renderer, "size", "outline");
            if (sizeOutlineVisVar) {
                renderer.visualVariables.push(sizeOutlineVisVar);
            }
            (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.Q)(renderer);
            result.renderer = renderer.clone();
            return Promise.resolve(result);
        }
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.l)(extras, result.renderer);
        if (symbol && ((_a = result.renderer.classBreakInfos) === null || _a === void 0 ? void 0 : _a.length)) {
            result.renderer.classBreakInfos[0].symbol = symbol;
        }
        if (defaultSymbol) {
            result.renderer.defaultSymbol = defaultSymbol;
            result.renderer.defaultLabel = defaultLabel;
        }
        if (backgroundFillSymbol) {
            result.renderer.backgroundFillSymbol = backgroundFillSymbol;
        }
        if (isInverted) {
            const sizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(result.renderer, "size");
            const tmp = sizeVisVar.minSize;
            sizeVisVar.minSize = sizeVisVar.maxSize;
            sizeVisVar.maxSize = tmp;
        }
        return Promise.resolve(result);
    }, (error) => Promise.reject(error));
}
/**
 * Creates a Size renderer with settings from current renderer
 */
function createSizeAgeRendererFromExisting(options) {
    var _a, _b, _c;
    const { layer: smLayer, mapImageSublayer, mapView /* , supportsArcade */, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const layer = smLayer;
    /* if (mapImageSublayer && !supportsArcade) {
      return createClassedSizeRendererFromExisting(options);
    } */
    options = options || {};
    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer);
    const rendererType = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.g)();
    const sizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(renderer, "size");
    const authSizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.p)(renderer, "size");
    const extras = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.m)(renderer);
    const startTime = options.startTime ? options.startTime : authSizeVisVar.startTime;
    const endTime = options.endTime ? options.endTime : authSizeVisVar.endTime;
    let symbol;
    if (["type-size-age"].indexOf(rendererType) > -1) {
        const uvRenderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer);
        symbol =
            uvRenderer.uniqueValueInfos && uvRenderer.uniqueValueInfos.length
                ? uvRenderer.uniqueValueInfos[0].symbol
                : (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.S)(layer, mapView, rendererType);
    }
    else {
        symbol =
            renderer.classBreakInfos && renderer.classBreakInfos.length
                ? renderer.classBreakInfos[0].symbol
                : (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.S)(layer, mapView, rendererType);
    }
    const defaultSymbol = renderer.defaultSymbol;
    const defaultLabel = renderer.defaultLabel;
    const backgroundFillSymbol = renderer.backgroundFillSymbol;
    let isInverted = false;
    if (sizeVisVar) {
        if (sizeVisVar.minSize.stops) {
            isInverted = sizeVisVar.minSize.stops[0].size > sizeVisVar.maxSize.stops[0].size;
        }
        else {
            isInverted = sizeVisVar.minSize > sizeVisVar.maxSize;
        }
        if (authSizeVisVar.theme === "below") {
            // we want it different for below
            isInverted = !isInverted;
        }
    }
    else {
        const minSym = renderer.classBreakInfos[0].symbol;
        const maxSym = renderer.classBreakInfos[renderer.classBreakInfos.length - 1].symbol;
        const lowValue = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.T)(minSym);
        const highValue = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.T)(maxSym);
        isInverted = lowValue > highValue;
    }
    if (options.fieldInfos && options.fieldInfos[0] && sizeVisVar && options.fieldInfos[0].field === sizeVisVar.field) {
        delete options.fieldInfos;
        if ((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.R)(options)) {
            // nothing really changes; remove color visVar if there is one
            const newRenderer = renderer.clone();
            newRenderer.visualVariables = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.n)(renderer, "color");
            //console.log("createSizeRendererFromExisting out 1", newRenderer.toJSON());
            return Promise.resolve({ renderer: newRenderer });
        }
    }
    let rangeChanged = false;
    if (options.startTime || options.endTime || options.units || options.fieldInfo || options.theme) {
        rangeChanged = true;
    }
    const minValue = options.discardMinMax
        ? undefined
        : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.i)(options.min)
            ? options.min
            : rangeChanged
                ? undefined
                : authSizeVisVar
                    ? authSizeVisVar.minSliderValue
                    : renderer.classBreakInfos[0].minValue;
    const maxValue = options.discardMinMax
        ? undefined
        : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.i)(options.max)
            ? options.max
            : rangeChanged
                ? undefined
                : authSizeVisVar
                    ? authSizeVisVar.maxSliderValue
                    : renderer.classBreakInfos[renderer.classBreakInfos.length - 1].maxValue;
    const theme = options.theme ? options.theme : authSizeVisVar ? authSizeVisVar.theme : "high-to-low";
    const config = {
        layer,
        view: mapView,
        theme,
        startTime,
        endTime,
        unit: options.units ? options.units : authSizeVisVar.units,
        minValue,
        maxValue,
        outlineOptimizationEnabled: mapImageSublayer
            ? false
            : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.i)(options.outlineOptimizationEnabled)
                ? options.outlineOptimizationEnabled
                : !!extras.sizeOutlineVisVar,
        sizeOptimizationEnabled: mapImageSublayer
            ? false
            : sizeVisVar
                ? (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.i)(options.sizeOptimizationEnabled)
                    ? options.sizeOptimizationEnabled
                    : typeof sizeVisVar.minSize === "object"
                : true /* isPolygonType(layer)
        ? true
        : false, */,
        legendOptions: ((_a = options.legendOptions) === null || _a === void 0 ? void 0 : _a.toJSON()) ||
            ((_b = sizeVisVar === null || sizeVisVar === void 0 ? void 0 : sizeVisVar.legendOptions) === null || _b === void 0 ? void 0 : _b.toJSON()) ||
            ((_c = renderer.legendOptions) === null || _c === void 0 ? void 0 : _c.toJSON()),
        defaultSymbolEnabled: (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.i)(options.defaultSymbolEnabled)
            ? options.defaultSymbolEnabled
            : !!renderer.defaultSymbol
    };
    //console.log(config);
    return modules.SizeCreator.createAgeRenderer(config).then((result) => {
        var _a;
        // console.log("createAgeRendererFromExisting", result.renderer.toJSON());
        // reset data values if necessary
        if (options.discardMinMax) {
            const sizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(renderer, "size");
            const newSizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(result.renderer, "size");
            sizeVisVar.minDataValue = newSizeVisVar.minDataValue;
            sizeVisVar.maxDataValue = newSizeVisVar.maxDataValue;
        }
        // keep field the same as before
        const newAuthSizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.p)(result.renderer, "size");
        newAuthSizeVisVar.field = authSizeVisVar.field;
        // keep slider values
        if (!rangeChanged) {
            const newSizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(result.renderer, "size");
            newSizeVisVar.minDataValue = sizeVisVar.minDataValue;
            newSizeVisVar.maxDataValue = sizeVisVar.maxDataValue;
        }
        if (["color-size-age"].indexOf(rendererType) > -1) {
            // just switch out size variables
            renderer.visualVariables = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.n)(renderer, "size") || [];
            renderer.visualVariables = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.n)(renderer, "size", "outline") || [];
            renderer.authoringInfo.visualVariables = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.o)(renderer, "size") || [];
            const sizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(result.renderer, "size");
            renderer.visualVariables.push(sizeVisVar);
            const sizeAuthVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.p)(result.renderer, "size");
            renderer.authoringInfo.visualVariables.push(sizeAuthVisVar);
            const sizeOutlineVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(result.renderer, "size", "outline");
            if (sizeOutlineVisVar) {
                renderer.visualVariables.push(sizeOutlineVisVar);
            }
            (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.Q)(renderer);
            result.renderer = renderer.clone();
            return Promise.resolve(result);
        }
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.l)(extras, result.renderer);
        if (symbol && ((_a = result.renderer.classBreakInfos) === null || _a === void 0 ? void 0 : _a.length)) {
            result.renderer.classBreakInfos[0].symbol = symbol;
        }
        if (defaultSymbol) {
            result.renderer.defaultSymbol = defaultSymbol;
            result.renderer.defaultLabel = defaultLabel;
        }
        if (backgroundFillSymbol) {
            result.renderer.backgroundFillSymbol = backgroundFillSymbol;
        }
        if (isInverted) {
            const sizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(result.renderer, "size");
            const tmp = sizeVisVar.minSize;
            sizeVisVar.minSize = sizeVisVar.maxSize;
            sizeVisVar.maxSize = tmp;
        }
        return Promise.resolve(result);
    }, (error) => Promise.reject(error));
}
/**
 * Creates a Size renderer with settings from current renderer
 */
function createClassedSizeRendererFromExisting(options) {
    var _a;
    const { layer: smLayer, mapImageSublayer, mapView, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const layer = smLayer;
    options = options || {};
    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer);
    const rendererType = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.g)();
    const authInfo = renderer.authoringInfo;
    const sizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(renderer, "size");
    const authSizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.p)(renderer, "size");
    const extras = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.m)(renderer);
    const rendererFieldInfo = {
        field: renderer.field,
        expression: renderer.valueExpression,
        expressionTitle: renderer.valueExpressionTitle,
        simpleFieldType: _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.w.NUMBER
    };
    let fieldInfo = options.fieldInfos
        ? options.fieldInfos[0]
        : sizeVisVar
            ? {
                field: sizeVisVar.field,
                expression: sizeVisVar.valueExpression,
                expressionTitle: sizeVisVar.valueExpressionTitle,
                simpleFieldType: _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.w.NUMBER
            }
            : rendererFieldInfo;
    // options.normalizationField = null means don't set the value
    const normalizationField = options.normalizationField !== undefined
        ? options.normalizationField
        : sizeVisVar
            ? sizeVisVar.normalizationField
            : renderer.normalizationField;
    let symbol;
    if (["type-size"].indexOf(rendererType) > -1) {
        const uvRenderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer);
        symbol =
            uvRenderer.uniqueValueInfos && uvRenderer.uniqueValueInfos.length
                ? uvRenderer.uniqueValueInfos[0].symbol
                : (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.S)(layer, mapView, rendererType);
    }
    else {
        symbol =
            renderer.classBreakInfos && renderer.classBreakInfos.length
                ? renderer.classBreakInfos[0].symbol
                : (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.S)(layer, mapView, rendererType);
    }
    const defaultSymbol = renderer.defaultSymbol;
    const defaultLabel = renderer.defaultLabel;
    const backgroundFillSymbol = renderer.backgroundFillSymbol;
    let isInverted = false;
    if (renderer.classBreakInfos.length > 1) {
        const firstSym = renderer.classBreakInfos[0].symbol;
        const secondSym = renderer.classBreakInfos[1].symbol;
        const firstSize = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.T)(firstSym) || 0;
        const secondSize = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.T)(secondSym) || 0;
        isInverted = firstSize > secondSize;
    }
    if (!sizeVisVar &&
        authInfo &&
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.x)(fieldInfo, rendererFieldInfo) &&
        normalizationField === renderer.normalizationField) {
        // no changes to fields
        delete options.fieldInfos;
        if ((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.R)(options)) {
            // nothing really changes; remove color visVar if there is one
            const newRender = renderer.clone();
            newRender.visualVariables = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.n)(renderer, "color");
            return Promise.resolve({ renderer: newRender });
        }
    }
    const classificationMethod = options.classificationMethod
        ? options.classificationMethod
        : (authInfo === null || authInfo === void 0 ? void 0 : authInfo.classificationMethod) && authInfo.classificationMethod !== "manual"
            ? authInfo.classificationMethod
            : "equal-interval";
    const standardDeviationInterval = classificationMethod === "standard-deviation"
        ? options.standardDeviationInterval
            ? options.standardDeviationInterval
            : authInfo.standardDeviationInterval
                ? authInfo.standardDeviationInterval
                : 1
        : undefined;
    let keepNumClasses = true;
    if (options.classificationMethod &&
        options.classificationMethod !== (authInfo === null || authInfo === void 0 ? void 0 : authInfo.classificationMethod) &&
        (options.classificationMethod === "standard-deviation" || (authInfo === null || authInfo === void 0 ? void 0 : authInfo.classificationMethod) === "standard-deviation")) {
        keepNumClasses = false;
    }
    let needNewStatistics = false;
    if (options.normalizationField !== undefined ||
        !(0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.x)(fieldInfo, rendererFieldInfo) ||
        classificationMethod !== "equal-interval" ||
        (
        // is it currently a continuous size renderer?, then start with full data range
        authSizeVisVar === null || authSizeVisVar === void 0 ? void 0 : authSizeVisVar.minSliderValue) ||
        (authSizeVisVar === null || authSizeVisVar === void 0 ? void 0 : authSizeVisVar.maxSliderValue)) {
        needNewStatistics = true;
    }
    const minValue = (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.i)(options.min)
        ? options.min
        : needNewStatistics
            ? undefined
            : authSizeVisVar
                ? authSizeVisVar.minSliderValue
                : renderer.classBreakInfos[0].minValue;
    const maxValue = (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.i)(options.max)
        ? options.max
        : needNewStatistics
            ? undefined
            : authSizeVisVar
                ? authSizeVisVar.maxSliderValue
                : renderer.classBreakInfos[renderer.classBreakInfos.length - 1].maxValue;
    return modules.SizeCreator.createClassBreaksRenderer({
        layer,
        view: mapView,
        //theme: options.theme ? options.theme : authSizeVisVar.theme,
        field: fieldInfo.field,
        valueExpression: fieldInfo.expression,
        valueExpressionTitle: fieldInfo.expressionTitle,
        normalizationField,
        classificationMethod,
        standardDeviationInterval,
        numClasses: (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.i)(options.numClasses)
            ? options.numClasses
            : sizeVisVar || !keepNumClasses
                ? 4
                : renderer.classBreakInfos.length,
        minValue,
        maxValue,
        outlineOptimizationEnabled: mapImageSublayer
            ? false
            : (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.i)(options.outlineOptimizationEnabled)
                ? options.outlineOptimizationEnabled
                : !!extras.sizeOutlineVisVar,
        legendOptions: options.legendOptions || renderer.legendOptions,
        defaultSymbolEnabled: (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.i)(options.defaultSymbolEnabled)
            ? options.defaultSymbolEnabled
            : !!renderer.defaultSymbol,
        forBinning: ((_a = layer.featureReduction) === null || _a === void 0 ? void 0 : _a.type) === "binning"
    }).then((result) => {
        //console.log("createClassBreaksRenderer", result.renderer.toJSON());
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.l)(extras, result.renderer);
        if (symbol && result.renderer.classBreakInfos) {
            result.renderer.classBreakInfos.map((classBreakInfo) => {
                const sym = symbol.clone();
                (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.U)(sym, (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.T)(classBreakInfo.symbol));
                classBreakInfo.symbol = sym;
            });
        }
        if (defaultSymbol) {
            result.renderer.defaultSymbol = defaultSymbol;
            result.renderer.defaultLabel = defaultLabel;
        }
        if (backgroundFillSymbol) {
            result.renderer.backgroundFillSymbol = backgroundFillSymbol;
        }
        if (isInverted) {
            const sizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(result.renderer, "size");
            const tmp = sizeVisVar.minSize;
            sizeVisVar.minSize = sizeVisVar.maxSize;
            sizeVisVar.maxSize = tmp;
        }
        return Promise.resolve(result);
    }, (error) => Promise.reject(error));
}
function sameSizeField(options) {
    var _a;
    // not checking for normalizationField
    // we keep it if the renderer has it and it does not get overwritten
    const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer).clone();
    const rendererType = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.g)();
    if ([
        "size",
        "size-age",
        "color-size",
        "color-size-age",
        "color-age-size",
        "type-size",
        "type-size-age",
        "relationship-size"
    ].indexOf(rendererType) > -1 &&
        options.normalizationField === undefined) {
        let renderFieldInfo;
        const sizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(renderer, "size");
        if (sizeVisVar) {
            // continuous
            if (["size-age", "color-size-age", "type-size-age"].indexOf(rendererType) > -1) {
                const authSizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.p)(renderer, "size");
                renderFieldInfo = {
                    field: authSizeVisVar.field
                };
            }
            else {
                renderFieldInfo = {
                    field: sizeVisVar.field,
                    expression: sizeVisVar.valueExpression,
                    expressionTitle: sizeVisVar.valueExpressionTitle
                };
            }
        }
        else {
            // classed
            renderFieldInfo = {
                field: renderer.field,
                expression: renderer.valueExpression,
                expressionTitle: renderer.valueExpressionTitle
            };
        }
        if ((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.x)((_a = options.fieldInfos) === null || _a === void 0 ? void 0 : _a[0], renderFieldInfo)) {
            return true;
        }
    }
    return false;
}
function getSizeSliderStops() {
    const { layer, mapView, modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer);
    const sizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(renderer, "size");
    const scale = mapView.scale;
    const { minSize, maxSize, minDataValue, maxDataValue } = sizeVisVar;
    let stops;
    if (sizeVisVar.stops) {
        stops = modules.esriLang.clone(sizeVisVar.stops);
    }
    else {
        let min, max;
        if (typeof minSize === "number") {
            min = minSize;
            max = maxSize;
        }
        else {
            const lastIdx = minSize.stops.length - 1;
            if (scale > minSize.stops[lastIdx].value) {
                min = minSize.stops[lastIdx].size;
                max = maxSize.stops[lastIdx].size;
            }
            else {
                minSize.stops.forEach((stop, idx) => {
                    if (scale <= stop.value) {
                        min = stop.size;
                        max = maxSize.stops[idx].size;
                    }
                });
            }
        }
        stops = [
            new modules.SizeStop({ value: minDataValue, size: min }),
            new modules.SizeStop({ value: maxDataValue, size: max })
        ];
    }
    return stops;
}
function getClassBreaksSizes() {
    const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer);
    return renderer.classBreakInfos.map((classBreakInfo) => {
        const sym = classBreakInfo.symbol;
        return {
            min: classBreakInfo.minValue,
            max: classBreakInfo.maxValue,
            size: (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.T)(sym)
        };
    });
}

/**
 * Updates the layer with a Color+size renderer with default settings
 * @param options: options
 */
function createColorSizeRenderer(options) {
    const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer);
    const authInfo = renderer.authoringInfo;
    const rendererType = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.g)();
    options = options || {};
    // first size renderer, so we have the correct symbol types
    const secondField = options.fieldInfos.length > 1 ? options.fieldInfos[1] : options.fieldInfos[0];
    if (sameSizeField({ fieldInfos: [secondField] }) &&
        ["color-size", "color-age-size", "type-size"].indexOf(rendererType) > -1 &&
        authInfo &&
        (authInfo === null || authInfo === void 0 ? void 0 : authInfo.univariateTheme) !== "above-and-below") {
        const sizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer), "size");
        if (sizeVisVar) {
            // re-use size renderer
            return createColorPartForRenderer((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer), options).then((rendererResult) => {
                return Promise.resolve(rendererResult);
            }, (error) => Promise.reject(error));
        } // else classed
    }
    return createSizeRenderer(Object.assign(Object.assign({}, options), { fieldInfos: [secondField] })).then((sizeRendererResult) => {
        return createColorPartForRenderer(sizeRendererResult.renderer, options).then((rendererResult) => {
            return Promise.resolve(rendererResult);
        }, (error) => Promise.reject(error));
    }, (error) => Promise.reject(error));
}
/**
 * Updates the layer with a Color+size renderer with default settings
 * @param options: options
 */
function createColorAgeSizeRenderer(options) {
    const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer);
    const authInfo = renderer.authoringInfo;
    const rendererType = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.g)();
    options = options || {};
    // first size renderer, so we have the correct symbol types
    const secondField = options.fieldInfos.length > 1 ? options.fieldInfos[1] : options.fieldInfos[0];
    if (sameSizeField({ fieldInfos: [secondField] }) &&
        ["color-size", "color-age-size", "type-size"].indexOf(rendererType) > -1 &&
        authInfo &&
        (authInfo === null || authInfo === void 0 ? void 0 : authInfo.univariateTheme) !== "above-and-below") {
        const sizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer), "size");
        if (sizeVisVar) {
            // re-use size renderer
            return createColorAgePartForRenderer((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer), options).then((rendererResult) => {
                return Promise.resolve(rendererResult);
            }, (error) => Promise.reject(error));
        } // else classed
    }
    return createSizeRenderer(Object.assign(Object.assign({}, options), { fieldInfos: [secondField] })).then((sizeRendererResult) => {
        return createColorAgePartForRenderer(sizeRendererResult.renderer, options).then((rendererResult) => {
            return Promise.resolve(rendererResult);
        }, (error) => Promise.reject(error));
    }, (error) => Promise.reject(error));
}
/**
 * Updates the layer with a Color+size renderer with default settings
 * @param options: options
 */
function createColorSizeAgeRenderer(options) {
    const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer);
    const authInfo = renderer.authoringInfo;
    const rendererType = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.g)();
    options = options || {};
    // first size renderer, so we have the correct symbol types
    const secondField = options.fieldInfos.length > 1 ? options.fieldInfos[1] : options.fieldInfos[0];
    if (sameSizeField({ fieldInfos: [secondField] }) &&
        ["color-size-age", "type-size-age"].indexOf(rendererType) > -1 &&
        authInfo &&
        (authInfo === null || authInfo === void 0 ? void 0 : authInfo.univariateTheme) !== "above-and-below") {
        const sizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer), "size");
        if (sizeVisVar) {
            // re-use size renderer
            return createColorPartForRenderer((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer), options).then((rendererResult) => {
                return Promise.resolve(rendererResult);
            }, (error) => Promise.reject(error));
        } // else classed
    }
    return createSizeAgeRenderer(Object.assign(Object.assign({}, options), { fieldInfos: [secondField] })).then((sizeRendererResult) => {
        return createColorPartForRenderer(sizeRendererResult.renderer, options).then((rendererResult) => {
            return Promise.resolve(rendererResult);
        }, (error) => Promise.reject(error));
    }, (error) => Promise.reject(error));
}
/**
 * Creates a Color&Size renderer with settings from current renderer
 */
function createColorSizeRendererFromExisting(options, rendererSubtype) {
    const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    options = options || {};
    // first size renderer, so we have the correct symbol types
    return createSizeRendererFromExisting(Object.assign(Object.assign({}, options), { fieldInfos: options.fieldInfos
            ? options.fieldInfos.length > 1
                ? [options.fieldInfos[1]]
                : [options.fieldInfos[0]]
            : null })).then((sizeRendererResult) => {
        return (0,_color_d6da0a9a_js__WEBPACK_IMPORTED_MODULE_3__.b)(Object.assign(Object.assign({}, options), { fieldInfos: options.fieldInfos ? [options.fieldInfos[0]] : null })).then((colorRendererResult) => {
            copySizeToColorRenderer(colorRendererResult.renderer, sizeRendererResult.renderer);
            colorRendererResult.backgroundFillSymbol = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer).backgroundFillSymbol;
            // handle situations where renderer recreation occurs from the size panel. Slider statistics must correspond to the size variable.
            if (rendererSubtype === "size") {
                colorRendererResult.statistics = sizeRendererResult.statistics;
            }
            return Promise.resolve(colorRendererResult);
        }, (error) => Promise.reject(error));
    }, (error) => Promise.reject(error));
}
/**
 * Creates a ColorAge&Size renderer with settings from current renderer
 */
function createColorAgeSizeRendererFromExisting(options, rendererSubtype) {
    const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    options = options || {};
    // first size renderer, so we have the correct symbol types
    return createSizeRendererFromExisting(Object.assign(Object.assign({}, options), { fieldInfos: options.fieldInfos
            ? options.fieldInfos.length > 1
                ? [options.fieldInfos[1]]
                : [options.fieldInfos[0]]
            : null })).then((sizeRendererResult) => {
        return (0,_color_d6da0a9a_js__WEBPACK_IMPORTED_MODULE_3__.d)(Object.assign(Object.assign({}, options), { fieldInfos: options.fieldInfos ? [options.fieldInfos[0]] : null })).then((colorRendererResult) => {
            copySizeToColorRenderer(colorRendererResult.renderer, sizeRendererResult.renderer);
            colorRendererResult.backgroundFillSymbol = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer).backgroundFillSymbol;
            // handle situations where renderer recreation occurs from the size panel. Slider statistics must correspond to the size variable.
            if (rendererSubtype === "size") {
                colorRendererResult.statistics = sizeRendererResult.statistics;
            }
            return Promise.resolve(colorRendererResult);
        }, (error) => Promise.reject(error));
    }, (error) => Promise.reject(error));
}
/**
 * Creates a Color&SizeAge renderer with settings from current renderer
 */
function createColorSizeAgeRendererFromExisting(options, rendererSubtype) {
    const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    options = options || {};
    // first size renderer, so we have the correct symbol types
    return createSizeAgeRendererFromExisting(Object.assign(Object.assign({}, options), { fieldInfos: options.fieldInfos
            ? options.fieldInfos.length > 1
                ? [options.fieldInfos[1]]
                : [options.fieldInfos[0]]
            : null })).then((sizeRendererResult) => {
        return (0,_color_d6da0a9a_js__WEBPACK_IMPORTED_MODULE_3__.b)(Object.assign(Object.assign({}, options), { fieldInfos: options.fieldInfos ? [options.fieldInfos[0]] : null })).then((colorRendererResult) => {
            copySizeToColorRenderer(colorRendererResult.renderer, sizeRendererResult.renderer);
            colorRendererResult.backgroundFillSymbol = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer).backgroundFillSymbol;
            // handle situations where renderer recreation occurs from the size panel. Slider statistics must correspond to the size variable.
            if (rendererSubtype === "size") {
                colorRendererResult.statistics = sizeRendererResult.statistics;
            }
            return Promise.resolve(colorRendererResult);
        }, (error) => Promise.reject(error));
    }, (error) => Promise.reject(error));
}
function createColorPartForRenderer(sizeRenderer, options) {
    const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer);
    const authInfo = renderer.authoringInfo;
    const rendererType = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.g)();
    const authColorVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.p)(renderer, "color");
    if ((0,_color_d6da0a9a_js__WEBPACK_IMPORTED_MODULE_3__.s)(options) &&
        ["color", "color-size", "color-size-age"].indexOf(rendererType) > -1 &&
        authInfo &&
        (authInfo === null || authInfo === void 0 ? void 0 : authInfo.univariateTheme) !== "above-and-below" &&
        ["centered-on", "extremes"].indexOf(authColorVisVar.theme) === -1) {
        // re-use color renderer
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer).clone();
        copySizeToColorRenderer(renderer, sizeRenderer);
        if (options.fieldInfos.length === 2) {
            // in case we're coming from an univariate Color+Size renderer
            const authInfo = renderer.authoringInfo;
            authInfo.type = null;
            authInfo.univariateTheme = null;
            authInfo.univariateSymbolStyle = null;
        }
        return Promise.resolve({ renderer });
    }
    return (0,_color_d6da0a9a_js__WEBPACK_IMPORTED_MODULE_3__.c)(Object.assign(Object.assign({}, options), { fieldInfos: [options.fieldInfos[0]] })).then((colorRendererResult) => {
        copySizeToColorRenderer(colorRendererResult.renderer, sizeRenderer);
        return Promise.resolve(colorRendererResult);
    }, (error) => Promise.reject(error));
}
function createColorAgePartForRenderer(sizeRenderer, options) {
    const { layer } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer);
    const authInfo = renderer.authoringInfo;
    const rendererType = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.g)();
    if ((0,_color_d6da0a9a_js__WEBPACK_IMPORTED_MODULE_3__.s)(options) &&
        ["color-age", "color-age-size"].indexOf(rendererType) > -1 &&
        authInfo &&
        (authInfo === null || authInfo === void 0 ? void 0 : authInfo.univariateTheme) !== "above-and-below") {
        // we can re-use the color renderer
        const renderer = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.h)(layer).clone();
        copySizeToColorRenderer(renderer, sizeRenderer);
        return Promise.resolve({ renderer });
    }
    return (0,_color_d6da0a9a_js__WEBPACK_IMPORTED_MODULE_3__.a)(Object.assign(Object.assign({}, options), { fieldInfos: [options.fieldInfos[0]] })).then((colorRendererResult) => {
        copySizeToColorRenderer(colorRendererResult.renderer, sizeRenderer);
        return Promise.resolve(colorRendererResult);
    }, (error) => Promise.reject(error));
}
function copySizeToColorRenderer(colorRenderer, sizeRenderer) {
    var _a;
    const { layer, mapView } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    if (!colorRenderer.authoringInfo) {
        // don't keep anything
        return;
    }
    colorRenderer.visualVariables = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.n)(colorRenderer, "size") || [];
    colorRenderer.visualVariables = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.n)(colorRenderer, "size", "auto") || [];
    const sizeVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(sizeRenderer, "size");
    colorRenderer.visualVariables.push(sizeVisVar);
    colorRenderer.authoringInfo.visualVariables = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.o)(colorRenderer, "size") || [];
    const sizeAuthVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.p)(sizeRenderer, "size");
    colorRenderer.authoringInfo.visualVariables.push(sizeAuthVisVar);
    const infos = ((_a = sizeRenderer.classBreakInfos) === null || _a === void 0 ? void 0 : _a.length) ? sizeRenderer.classBreakInfos : sizeRenderer.uniqueValueInfos;
    let markerSymbol = (infos === null || infos === void 0 ? void 0 : infos.length) ? infos[0].symbol : (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.S)(layer, mapView, "color-size");
    if (markerSymbol.type === "picture-marker") {
        markerSymbol = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.S)(layer, mapView, "color-size");
    }
    if ((0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.q)(layer)) {
        colorRenderer.classBreakInfos.map((valueInfo) => {
            const color = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.t)(valueInfo.symbol);
            valueInfo.symbol = markerSymbol.clone();
            (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.r)(valueInfo.symbol, color);
        });
        colorRenderer.backgroundFillSymbol = sizeRenderer.backgroundFillSymbol;
        const sizeOutlineVisVar = (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.a)(sizeRenderer, "size", "outline");
        if (sizeOutlineVisVar) {
            colorRenderer.visualVariables.push(sizeOutlineVisVar);
        }
    }
    updateMainSymbol(markerSymbol);
}
function updateMainSymbol(symbol) {
    // this symbol shows up if one of the fields is null
    const { modules } = _raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.s;
    if (symbol.type === "simple-line") {
        symbol.color = [0, 0, 0, 0.5];
        symbol.width = 1;
    }
    else if (symbol.type === "cim") {
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.r)(symbol, new modules.esriColor([0, 0, 0, 0.5]));
        //const outline = getCimPointOutline(symbol);
        //outline.color = [0, 0, 0, 0.5];
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.U)(symbol, 4);
    }
    else {
        // simple-marker
        symbol.color = null;
        symbol.outline.color = [0, 0, 0, 0.5];
        (0,_raster_unique_value_0976ec7f_js__WEBPACK_IMPORTED_MODULE_0__.U)(symbol, 4);
    }
}



//# sourceMappingURL=colorSize-ce0ccdeb.js.map

/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0cy9jaHVua3MvYXJjZ2lzX2FuYWx5c2lzX25vZGVfbW9kdWxlc19hcmNnaXNfYXBwLWNvbXBvbmVudHNfZGlzdF9lc21fY29sb3JTLTNlY2EwYS5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDZ2Q7QUFDN2E7QUFDQTtBQUM2SjtBQUNqSTs7QUFFL0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsWUFBWSxxRUFBcUUsRUFBRSwrREFBaUI7QUFDcEc7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQkFBcUIsbUVBQVc7QUFDaEM7QUFDQSx5QkFBeUIsbUVBQWU7QUFDeEM7QUFDQSxtQkFBbUIsbUVBQWdCLENBQUMsbUVBQVc7QUFDL0M7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsY0FBYywrREFBUztBQUN2QjtBQUNBLGtCQUFrQixtRUFBYTtBQUMvQjtBQUNBO0FBQ0E7QUFDQTtBQUNBLGNBQWMsK0RBQVM7QUFDdkI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDZCQUE2QixtRUFBVztBQUN4QywrQkFBK0IsbUVBQVM7QUFDeEMsbUNBQW1DLG1FQUFhO0FBQ2hELHNDQUFzQyxtRUFBUztBQUMvQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGNBQWM7QUFDZDtBQUNBLGNBQWM7QUFDZCxZQUFZLG1FQUFxQjtBQUNqQztBQUNBLFFBQVEsbUVBQWlCO0FBQ3pCO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxZQUFZLHFEQUFxRCxFQUFFLCtEQUFpQjtBQUNwRjtBQUNBLHFCQUFxQixtRUFBVztBQUNoQztBQUNBLHlCQUF5QixtRUFBZTtB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QUFDdkI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFFBQVEsbUVBQWU7QUFDdkI7QUFDQTs7QUFFbWU7O0FBRW5lIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vZXhiLWNsaWVudC8uL2V4dGVuc2lvbnMvd2lkZ2V0cy9hcmNnaXMvYW5hbHlzaXMvbm9kZV9tb2R1bGVzL0BhcmNnaXMvYXBwLWNvbXBvbmVudHMvZGlzdC9lc20vY29sb3JTaXplLWNlMGNjZGViLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQWxsIG1hdGVyaWFsIGNvcHlyaWdodCBFU1JJLCBBbGwgUmlnaHRzIFJlc2VydmVkLCB1bmxlc3Mgb3RoZXJ3aXNlIHNwZWNpZmllZC5cbiAqIHY0LjAuNThcbiAqL1xuaW1wb3J0IHsgVCBhcyBnZXRTeW1ib2xTaXplLCBoIGFzIGdldFJlbmRlcmVyLCBhIGFzIGdldFZpc1ZhciwgcCBhcyBnZXRBdXRoVmlzVmFyLCBRIGFzIGZpeE5vcm1hbGl6YXRpb25GaWVsZCwgbCBhcyBhcHBseUV4dHJhVmlzVmFycywgcSBhcyBpc1BvbHlnb25UeXBlLCBnIGFzIGdldFJlbmRlcmVyVHlwZSwgbSBhcyBzYXZlRXh0cmFWaXNWYXJzLCBzIGFzIHNtYXJ0TWFwcGluZ1N0YXRlLCBTIGFzIGdldERlZmF1bHRTeW1ib2wsIFIgYXMgaXNFbXB0eSwgbiBhcyBnZXRWaXNWYXJzRXhjZXB0LCBvIGFzIGdldEF1dGhWaXNWYXJzRXhjZXB0LCB4IGFzIGlzU2FtZUZpZWxkSW5mbywgVSBhcyBhcHBseVN5bWJvbFNpemUsIHcgYXMgc2ltcGxlRmllbGRUeXBlcywgdCBhcyBnZXRTeW1ib2xDb2xvciwgciBhcyBhcHBseVN5bWJvbENvbG9yIH0gZnJvbSAnLi9yYXN0ZXItdW5pcXVlLXZhbHVlLTA5NzZlYzdmLmpzJztcbmltcG9ydCAnLi9sb2FkTW9kdWxlcy1iNGFjMTI0Ny5qcyc7XG5pbXBvcnQgJy4vY29tbW9uRW51bXMtZmNmMTM2NjEuanMnO1xuaW1wb3J0IHsgYiBhcyBjcmVhdGVDb2xvclJlbmRlcmVyRnJvbUV4aXN0aW5nLCBkIGFzIGNyZWF0ZUNvbG9yQWdlUmVuZGVyZXJGcm9tRXhpc3RpbmcsIHMgYXMgc2FtZUNvbG9yRmllbGQsIGMgYXMgY3JlYXRlQ29sb3JSZW5kZXJlciwgYSBhcyBjcmVhdGVDb2xvckFnZVJlbmRlcmVyIH0gZnJvbSAnLi9jb2xvci1kNmRhMGE5YS5qcyc7XG5pbXBvcnQgeyBpIGFzIGlzRGVmaW5lZCB9IGZyb20gJy4vY29tbW9uRnVuY3Rpb25zLWIwODMwZTllLmpzJztcblxuLyoqXG4gKiBVcGRhdGVzIHRoZSBsYXllciB3aXRoIGEgU2l6ZSByZW5kZXJlciB3aXRoIGRlZmF1bHQgc2V0dGluZ3NcbiAqIEBwYXJhbSBvcHRpb25zOiBvcHRpb25zXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZVNpemVSZW5kZXJlcihvcHRpb25zKSB7XG4gICAgdmFyIF9hLCBfYjtcbiAgICBjb25zdCB7IGxheWVyOiBzbUxheWVyLCBtYXBJbWFnZVN1YmxheWVyLCBtYXBWaWV3LCBzdXBwb3J0c0FyY2FkZSwgbW9kdWxlcyB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgY29uc3QgbGF5ZXIgPSBzbUxheWVyO1xuICAgIGlmIChtYXBJbWFnZVN1YmxheWVyICYmICFzdXBwb3J0c0FyY2FkZSkge1xuICAgICAgICByZXR1cm4gY3JlYXRlQ2xhc3NlZFNpemVSZW5kZXJlcihvcHRpb25zKTtcbiAgICB9XG4gICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcik7XG4gICAgY29uc3QgYXV0aEluZm8gPSByZW5kZXJlci5hdXRob3JpbmdJbmZvO1xuICAgIGNvbnN0IHJlbmRlcmVyVHlwZSA9IGdldFJlbmRlcmVyVHlwZSgpO1xuICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuICAgIGNvbnN0IGV4dHJhcyA9IHNhdmVFeHRyYVZpc1ZhcnMoZ2V0UmVuZGVyZXIobGF5ZXIpKTtcbiAgICBjb25zdCBmaWVsZEluZm8gPSAoX2EgPSBvcHRpb25zLmZpZWxkSW5mb3MpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYVswXTtcbiAgICBjb25zdCB0aGVtZSA9IG9wdGlvbnMudGhlbWUgPyBvcHRpb25zLnRoZW1lIDogXCJoaWdoLXRvLWxvd1wiO1xuICAgIGNvbnN0IGNvbmZpZyA9IHtcbiAgICAgICAgbGF5ZXIsXG4gICAgICAgIHZpZXc6IG1hcFZpZXcsXG4gICAgICAgIGZpZWxkOiBmaWVsZEluZm8gPT09IG51bGwgfHwgZmllbGRJbmZvID09PSB2b2lkIDAgPyB2b2lkIDAgOiBmaWVsZEluZm8uZmllbGQsXG4gICAgICAgIHRoZW1lLFxuICAgICAgICB2YWx1ZUV4cHJlc3Npb246IGZpZWxkSW5mbyA9PT0gbnVsbCB8fCBmaWVsZEluZm8gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGZpZWxkSW5mby5leHByZXNzaW9uLFxuICAgICAgICB2YWx1ZUV4cHJlc3Npb25UaXRsZTogZmllbGRJbmZvID09PSBudWxsIHx8IGZpZWxkSW5mbyA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmllbGRJbmZvLmV4cHJlc3Npb25UaXRsZSxcbiAgICAgICAgbm9ybWFsaXphdGlvbkZpZWxkOiBvcHRpb25zLm5vcm1hbGl6YXRpb25GaWVsZCxcbiAgICAgICAgb3V0bGluZU9wdGltaXphdGlvbkVuYWJsZWQ6IG1hcEltYWdlU3VibGF5ZXJcbiAgICAgICAgICAgID8gZmFsc2VcbiAgICAgICAgICAgIDogaXNEZWZpbmVkKG9wdGlvbnMub3V0bGluZU9wdGltaXphdGlvbkVuYWJsZWQpXG4gICAgICAgICAgICAgICAgPyBvcHRpb25zLm91dGxpbmVPcHRpbWl6YXRpb25FbmFibGVkXG4gICAgICAgICAgICAgICAgOiBpc1BvbHlnb25UeXBlKGxheWVyKVxuICAgICAgICAgICAgICAgICAgICA/IHRydWVcbiAgICAgICAgICAgICAgICAgICAgOiBmYWxzZSxcbiAgICAgICAgc2l6ZU9wdGltaXphdGlvbkVuYWJsZWQ6IG1hcEltYWdlU3VibGF5ZXJcbiAgICAgICAgICAgID8gZmFsc2VcbiAgICAgICAgICAgIDogaXNEZWZpbmVkKG9wdGlvbnMuc2l6ZU9wdGltaXphdGlvbkVuYWJsZWQpXG4gICAgICAgICAgICAgICAgPyBvcHRpb25zLnNpemVPcHRpbWl6YXRpb25FbmFibGVkXG4gICAgICAgICAgICAgICAgOiB0cnVlIC8qIGlzUG9seWdvbihsYXllcilcbiAgICAgICAgPyB0cnVlXG4gICAgICAgIDogZmFsc2UsICovLFxuICAgICAgICBsZWdlbmRPcHRpb25zOiBvcHRpb25zLmxlZ2VuZE9wdGlvbnMsXG4gICAgICAgIGRlZmF1bHRTeW1ib2xFbmFibGVkOiBmYWxzZSxcbiAgICAgICAgZm9yQmlubmluZzogKChfYiA9IGxheWVyLmZlYXR1cmVSZWR1Y3Rpb24pID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi50eXBlKSA9PT0gXCJiaW5uaW5nXCJcbiAgICB9O1xuICAgIC8vY29uc29sZS5sb2coXCJjcmVhdGVTaXplUmVuZGVyZXItY29uZmlnXCIsIGNvbmZpZyk7XG4gICAgcmV0dXJuIG1vZHVsZXMuU2l6ZUNyZWF0b3IuY3JlYXRlQ29udGludW91c1JlbmRlcmVyKGNvbmZpZykudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgIC8vY29uc29sZS5sb2coXCJjcmVhdGVTaXplUmVuZGVyZXItc3VjY2Vzc1wiLCByZXN1bHQucmVuZGVyZXIpO1xuICAgICAgICBpZiAoIW9wdGlvbnMubm9SZXVzZSAmJlxuICAgICAgICAgICAgc2FtZVNpemVGaWVsZChvcHRpb25zKSAmJlxuICAgICAgICAgICAgW1wic2l6ZVwiLCBcImNvbG9yLXNpemVcIiwgXCJ0eXBlLXNpemVcIiwgXCJyZWxhdGlvbnNoaXAtc2l6ZVwiXS5pbmRleE9mKHJlbmRlcmVyVHlwZSkgPiAtMSAmJlxuICAgICAgICAgICAgYXV0aEluZm8gJiZcbiAgICAgICAgICAgIGF1dGhJbmZvLnVuaXZhcmlhdGVUaGVtZSAhPT0gXCJhYm92ZS1hbmQtYmVsb3dcIikge1xuICAgICAgICAgICAgLy8gcmUtdXNlIHNpemUgcmVuZGVyZXJcbiAgICAgICAgICAgIGNvbnN0IHJlbmRlcmVyID0gZ2V0UmVuZGVyZXIobGF5ZXIpLmNsb25lKCk7XG4gICAgICAgICAgICBjb25zdCBzaXplVmlzVmFyID0gZ2V0VmlzVmFyKHJlbmRlcmVyLCBcInNpemVcIik7XG4gICAgICAgICAgICBjb25zdCBhdXRoU2l6ZVZpc1ZhciA9IGdldEF1dGhWaXNWYXIocmVuZGVyZXIsIFwic2l6ZVwiKTtcbiAgICAgICAgICAgIGNvbnN0IHNpemVPdXRsaW5lVmlzVmFyID0gZ2V0VmlzVmFyKHJlbmRlcmVyLCBcInNpemVcIiwgXCJvdXRsaW5lXCIpO1xuICAgICAgICAgICAgcmVzdWx0LnJlbmRlcmVyLnZpc3VhbFZhcmlhYmxlcyA9IFtzaXplVmlzVmFyXTtcbiAgICAgICAgICAgIGlmIChzaXplT3V0bGluZVZpc1Zhcikge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5yZW5kZXJlci52aXN1YWxWYXJpYWJsZXMucHVzaChzaXplT3V0bGluZVZpc1Zhcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXN1bHQucmVuZGVyZXIuYXV0aG9yaW5nSW5mby52aXN1YWxWYXJpYWJsZXMgPSBbYXV0aFNpemVWaXNWYXJdO1xuICAgICAgICAgICAgLyogaWYgKHJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvcz8ubGVuZ3RoKSB7XG4gICAgICAgICAgICAgIHJlc3VsdC5yZW5kZXJlci5jbGFzc0JyZWFrSW5mb3NbMF0uc3ltYm9sID0gcmVuZGVyZXIuY2xhc3NCcmVha0luZm9zWzBdLnN5bWJvbDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdC5yZW5kZXJlci5jbGFzc0JyZWFrSW5mb3NbMF0uc3ltYm9sID0gcmVuZGVyZXIudW5pcXVlVmFsdWVJbmZvc1swXS5zeW1ib2w7XG4gICAgICAgICAgICB9IGNvbG9yLXNpemUgLT4gc2l6ZTogbWFya2VycyBsb29zZSBvcmFuZ2UgY29sb3IgKi9cbiAgICAgICAgICAgIGZpeE5vcm1hbGl6YXRpb25GaWVsZChyZXN1bHQucmVuZGVyZXIpO1xuICAgICAgICB9XG4gICAgICAgIGFwcGx5RXh0cmFWaXNWYXJzKGV4dHJhcywgcmVzdWx0LnJlbmRlcmVyKTtcbiAgICAgICAgLy9jb25zb2xlLmxvZyhcImNyZWF0ZVNpemVSZW5kZXJlciBvdXRcIiwgcmVzdWx0LnJlbmRlcmVyLnRvSlNPTigpKTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXN1bHQpO1xuICAgIH0sIChlcnJvcikgPT4gUHJvbWlzZS5yZWplY3QoZXJyb3IpKTtcbn1cbi8qKlxuICogQ3JlYXRlcyBhIFNpemUgQWdlIHJlbmRlcmVyIHdpdGggZGVmYXVsdCBzZXR0aW5nc1xuICogQHBhcmFtIG9wdGlvbnM6IG9wdGlvbnNcbiAqL1xuZnVuY3Rpb24gY3JlYXRlU2l6ZUFnZVJlbmRlcmVyKG9wdGlvbnMpIHtcbiAgICB2YXIgX2E7XG4gICAgY29uc3QgeyBsYXllcjogc21MYXllciwgbWFwSW1hZ2VTdWJsYXllciwgbWFwVmlldywgbW9kdWxlcyB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgY29uc3QgbGF5ZXIgPSBzbUxheWVyO1xuICAgIGNvbnN0IHJlbmRlcmVyID0gZ2V0UmVuZGVyZXIobGF5ZXIpO1xuICAgIGNvbnN0IGF1dGhJbmZvID0gcmVuZGVyZXIuYXV0aG9yaW5nSW5mbztcbiAgICBjb25zdCByZW5kZXJlclR5cGUgPSBnZXRSZW5kZXJlclR5cGUoKTtcbiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcbiAgICBjb25zdCBleHRyYXMgPSBzYXZlRXh0cmFWaXNWYXJzKGdldFJlbmRlcmVyKGxheWVyKSk7XG4gICAgY29uc3QgZmllbGRJbmZvID0gKF9hID0gb3B0aW9ucy5maWVsZEluZm9zKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2FbMF07XG4gICAgY29uc3QgdGhlbWUgPSBvcHRpb25zLnRoZW1lID8gb3B0aW9ucy50aGVtZSA6IFwiaGlnaC10by1sb3dcIjtcbiAgICBjb25zdCBjb25maWcgPSB7XG4gICAgICAgIGxheWVyLFxuICAgICAgICB2aWV3OiBtYXBWaWV3LFxuICAgICAgICBzdGFydFRpbWU6IGZpZWxkSW5mbyA9PT0gbnVsbCB8fCBmaWVsZEluZm8gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGZpZWxkSW5mby5maWVsZCxcbiAgICAgICAgZW5kVGltZTogbmV3IERhdGUoKSxcbiAgICAgICAgdGhlbWUsXG4gICAgICAgIHVuaXQ6IHVuZGVmaW5lZCxcbiAgICAgICAgb3V0bGluZU9wdGltaXphdGlvbkVuYWJsZWQ6IG1hcEltYWdlU3VibGF5ZXJcbiAgICAgICAgICAgID8gZmFsc2VcbiAgICAgICAgICAgIDogaXNEZWZpbmVkKG9wdGlvbnMub3V0bGluZU9wdGltaXphdGlvbkVuYWJsZWQpXG4gICAgICAgICAgICAgICAgPyBvcHRpb25zLm91dGxpbmVPcHRpbWl6YXRpb25FbmFibGVkXG4gICAgICAgICAgICAgICAgOiBpc1BvbHlnb25UeXBlKGxheWVyKVxuICAgICAgICAgICAgICAgICAgICA/IHRydWVcbiAgICAgICAgICAgICAgICAgICAgOiBmYWxzZSxcbiAgICAgICAgc2l6ZU9wdGltaXphdGlvbkVuYWJsZWQ6IHRydWUsXG4gICAgICAgIGxlZ2VuZE9wdGlvbnM6IG9wdGlvbnMubGVnZW5kT3B0aW9ucyxcbiAgICAgICAgZGVmYXVsdFN5bWJvbEVuYWJsZWQ6IGZhbHNlXG4gICAgfTtcbiAgICByZXR1cm4gbW9kdWxlcy5TaXplQ3JlYXRvci5jcmVhdGVBZ2VSZW5kZXJlcihjb25maWcpLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgICBpZiAoc2FtZVNpemVGaWVsZChvcHRpb25zKSAmJlxuICAgICAgICAgICAgW1wic2l6ZS1hZ2VcIiwgXCJjb2xvci1zaXplLWFnZVwiLCBcInR5cGUtc2l6ZS1hZ2VcIl0uaW5kZXhPZihyZW5kZXJlclR5cGUpID4gLTEgJiZcbiAgICAgICAgICAgIGF1dGhJbmZvICYmXG4gICAgICAgICAgICAoYXV0aEluZm8gPT09IG51bGwgfHwgYXV0aEluZm8gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF1dGhJbmZvLnVuaXZhcmlhdGVUaGVtZSkgIT09IFwiYWJvdmUtYW5kLWJlbG93XCIpIHtcbiAgICAgICAgICAgIC8vIHJlLXVzZSBzaXplIHJlbmRlcmVyXG4gICAgICAgICAgICBjb25zdCByZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKS5jbG9uZSgpO1xuICAgICAgICAgICAgY29uc3Qgc2l6ZVZpc1ZhciA9IGdldFZpc1ZhcihyZW5kZXJlciwgXCJzaXplXCIpO1xuICAgICAgICAgICAgY29uc3QgYXV0aFNpemVWaXNWYXIgPSBnZXRBdXRoVmlzVmFyKHJlbmRlcmVyLCBcInNpemVcIik7XG4gICAgICAgICAgICBjb25zdCBzaXplT3V0bGluZVZpc1ZhciA9IGdldFZpc1ZhcihyZW5kZXJlciwgXCJzaXplXCIsIFwib3V0bGluZVwiKTtcbiAgICAgICAgICAgIHJlc3VsdC5yZW5kZXJlci52aXN1YWxWYXJpYWJsZXMgPSBbc2l6ZVZpc1Zhcl07XG4gICAgICAgICAgICBpZiAoc2l6ZU91dGxpbmVWaXNWYXIpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQucmVuZGVyZXIudmlzdWFsVmFyaWFibGVzLnB1c2goc2l6ZU91dGxpbmVWaXNWYXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVzdWx0LnJlbmRlcmVyLmF1dGhvcmluZ0luZm8udmlzdWFsVmFyaWFibGVzID0gW2F1dGhTaXplVmlzVmFyXTtcbiAgICAgICAgICAgIC8qIGlmIChyZW5kZXJlci5jbGFzc0JyZWFrSW5mb3M/Lmxlbmd0aCkge1xuICAgICAgICAgICAgICByZXN1bHQucmVuZGVyZXIuY2xhc3NCcmVha0luZm9zWzBdLnN5bWJvbCA9IHJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvc1swXS5zeW1ib2w7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXN1bHQucmVuZGVyZXIuY2xhc3NCcmVha0luZm9zWzBdLnN5bWJvbCA9IHJlbmRlcmVyLnVuaXF1ZVZhbHVlSW5mb3NbMF0uc3ltYm9sO1xuICAgICAgICAgICAgfSBjb2xvci1zaXplIC0+IHNpemU6IG1hcmtlcnMgbG9vc2Ugb3JhbmdlIGNvbG9yICovXG4gICAgICAgICAgICBmaXhOb3JtYWxpemF0aW9uRmllbGQocmVzdWx0LnJlbmRlcmVyKTtcbiAgICAgICAgfVxuICAgICAgICBhcHBseUV4dHJhVmlzVmFycyhleHRyYXMsIHJlc3VsdC5yZW5kZXJlcik7XG4gICAgICAgIC8vY29uc29sZS5sb2coXCJjcmVhdGVTaXplQWdlUmVuZGVyZXIgb3V0XCIsIHJlc3VsdC5yZW5kZXJlci50b0pTT04oKSk7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzdWx0KTtcbiAgICB9LCAoZXJyb3IpID0+IFByb21pc2UucmVqZWN0KGVycm9yKSk7XG59XG4vKipcbiAqIFVwZGF0ZXMgdGhlIGxheWVyIHdpdGggYSBTaXplIHJlbmRlcmVyIHdpdGggZGVmYXVsdCBzZXR0aW5nc1xuICogQHBhcmFtIG9wdGlvbnM6IG9wdGlvbnNcbiAqL1xuZnVuY3Rpb24gY3JlYXRlQ2xhc3NlZFNpemVSZW5kZXJlcihvcHRpb25zKSB7XG4gICAgdmFyIF9hLCBfYjtcbiAgICBjb25zdCB7IGxheWVyOiBzbUxheWVyLCBtYXBJbWFnZVN1YmxheWVyLCBtYXBWaWV3LCBtb2R1bGVzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICBjb25zdCBsYXllciA9IHNtTGF5ZXI7XG4gICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgY29uc3QgZXh0cmFzID0gc2F2ZUV4dHJhVmlzVmFycyhnZXRSZW5kZXJlcihsYXllcikpO1xuICAgIGNvbnN0IGZpZWxkSW5mbyA9IChfYSA9IG9wdGlvbnMuZmllbGRJbmZvcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hWzBdO1xuICAgIHJldHVybiBtb2R1bGVzLlNpemVDcmVhdG9yLmNyZWF0ZUNsYXNzQnJlYWtzUmVuZGVyZXIoe1xuICAgICAgICBsYXllcixcbiAgICAgICAgdmlldzogbWFwVmlldyxcbiAgICAgICAgZmllbGQ6IGZpZWxkSW5mbyA9PT0gbnVsbCB8fCBmaWVsZEluZm8gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGZpZWxkSW5mby5maWVsZCxcbiAgICAgICAgdmFsdWVFeHByZXNzaW9uOiBmaWVsZEluZm8gPT09IG51bGwgfHwgZmllbGRJbmZvID09PSB2b2lkIDAgPyB2b2lkIDAgOiBmaWVsZEluZm8uZXhwcmVzc2lvbixcbiAgICAgICAgdmFsdWVFeHByZXNzaW9uVGl0bGU6IGZpZWxkSW5mbyA9PT0gbnVsbCB8fCBmaWVsZEluZm8gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGZpZWxkSW5mby5leHByZXNzaW9uVGl0bGUsXG4gICAgICAgIG5vcm1hbGl6YXRpb25GaWVsZDogdW5kZWZpbmVkLFxuICAgICAgICBjbGFzc2lmaWNhdGlvbk1ldGhvZDogb3B0aW9ucy5jbGFzc2lmaWNhdGlvbk1ldGhvZCA/IG9wdGlvbnMuY2xhc3NpZmljYXRpb25NZXRob2QgOiBcIm5hdHVyYWwtYnJlYWtzXCIsXG4gICAgICAgIHN0YW5kYXJkRGV2aWF0aW9uSW50ZXJ2YWw6IG9wdGlvbnMuY2xhc3NpZmljYXRpb25NZXRob2QgPT09IFwic3RhbmRhcmQtZGV2aWF0aW9uXCJcbiAgICAgICAgICAgID8gb3B0aW9ucy5zdGFuZGFyZERldmlhdGlvbkludGVydmFsXG4gICAgICAgICAgICAgICAgPyBvcHRpb25zLnN0YW5kYXJkRGV2aWF0aW9uSW50ZXJ2YWxcbiAgICAgICAgICAgICAgICA6IDFcbiAgICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgICBudW1DbGFzc2VzOiBvcHRpb25zLm51bUNsYXNzZXMgPyBvcHRpb25zLm51bUNsYXNzZXMgOiA0LFxuICAgICAgICBvdXRsaW5lT3B0aW1pemF0aW9uRW5hYmxlZDogbWFwSW1hZ2VTdWJsYXllclxuICAgICAgICAgICAgPyBmYWxzZVxuICAgICAgICAgICAgOiBpc0RlZmluZWQob3B0aW9ucy5vdXRsaW5lT3B0aW1pemF0aW9uRW5hYmxlZClcbiAgICAgICAgICAgICAgICA/IG9wdGlvbnMub3V0bGluZU9wdGltaXphdGlvbkVuYWJsZWRcbiAgICAgICAgICAgICAgICA6IGlzUG9seWdvblR5cGUobGF5ZXIpXG4gICAgICAgICAgICAgICAgICAgID8gdHJ1ZVxuICAgICAgICAgICAgICAgICAgICA6IGZhbHNlLFxuICAgICAgICBsZWdlbmRPcHRpb25zOiBvcHRpb25zLmxlZ2VuZE9wdGlvbnMsXG4gICAgICAgIGRlZmF1bHRTeW1ib2xFbmFibGVkOiBmYWxzZSxcbiAgICAgICAgZm9yQmlubmluZzogKChfYiA9IGxheWVyLmZlYXR1cmVSZWR1Y3Rpb24pID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi50eXBlKSA9PT0gXCJiaW5uaW5nXCJcbiAgICB9KS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgYXBwbHlFeHRyYVZpc1ZhcnMoZXh0cmFzLCByZXN1bHQucmVuZGVyZXIpO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlc3VsdCk7XG4gICAgfSwgKGVycm9yKSA9PiBQcm9taXNlLnJlamVjdChlcnJvcikpO1xufVxuLyoqXG4gKiBDcmVhdGVzIGEgU2l6ZSByZW5kZXJlciB3aXRoIHNldHRpbmdzIGZyb20gY3VycmVudCByZW5kZXJlclxuICovXG5mdW5jdGlvbiBjcmVhdGVTaXplUmVuZGVyZXJGcm9tRXhpc3Rpbmcob3B0aW9ucykge1xuICAgIHZhciBfYSwgX2IsIF9jLCBfZDtcbiAgICBjb25zdCB7IGxheWVyOiBzbUxheWVyLCBtYXBJbWFnZVN1YmxheWVyLCBtYXBWaWV3LCBzdXBwb3J0c0FyY2FkZSwgbW9kdWxlcyB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgY29uc3QgbGF5ZXIgPSBzbUxheWVyO1xuICAgIGlmIChtYXBJbWFnZVN1YmxheWVyICYmICFzdXBwb3J0c0FyY2FkZSkge1xuICAgICAgICByZXR1cm4gY3JlYXRlQ2xhc3NlZFNpemVSZW5kZXJlckZyb21FeGlzdGluZyhvcHRpb25zKTtcbiAgICB9XG4gICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcik7XG4gICAgY29uc3QgYXV0aEluZm8gPSByZW5kZXJlci5hdXRob3JpbmdJbmZvIHx8IHt9O1xuICAgIGNvbnN0IHJlbmRlcmVyVHlwZSA9IGdldFJlbmRlcmVyVHlwZSgpO1xuICAgIGNvbnN0IHNpemVWaXNWYXIgPSBnZXRWaXNWYXIocmVuZGVyZXIsIFwic2l6ZVwiKTtcbiAgICBjb25zdCBhdXRoU2l6ZVZpc1ZhciA9IGdldEF1dGhWaXNWYXIocmVuZGVyZXIsIFwic2l6ZVwiKTtcbiAgICBjb25zdCBleHRyYXMgPSBzYXZlRXh0cmFWaXNWYXJzKHJlbmRlcmVyKTtcbiAgICBsZXQgc3ltYm9sO1xuICAgIGlmIChbXCJ0eXBlLXNpemVcIiwgXCJyZWxhdGlvbnNoaXAtc2l6ZVwiXS5pbmRleE9mKHJlbmRlcmVyVHlwZSkgPiAtMSkge1xuICAgICAgICBjb25zdCB1dlJlbmRlcmVyID0gZ2V0UmVuZGVyZXIobGF5ZXIpO1xuICAgICAgICBzeW1ib2wgPVxuICAgICAgICAgICAgdXZSZW5kZXJlci51bmlxdWVWYWx1ZUluZm9zICYmIHV2UmVuZGVyZXIudW5pcXVlVmFsdWVJbmZvcy5sZW5ndGhcbiAgICAgICAgICAgICAgICA/IHV2UmVuZGVyZXIudW5pcXVlVmFsdWVJbmZvc1swXS5zeW1ib2xcbiAgICAgICAgICAgICAgICA6IGdldERlZmF1bHRTeW1ib2wobGF5ZXIsIG1hcFZpZXcsIHJlbmRlcmVyVHlwZSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICAvLyB1c2UgbGFyZ2VzdCBzeW1ib2xcbiAgICAgICAgc3ltYm9sID1cbiAgICAgICAgICAgIHJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvcyAmJiByZW5kZXJlci5jbGFzc0JyZWFrSW5mb3MubGVuZ3RoXG4gICAgICAgICAgICAgICAgPyByZW5kZXJlci5jbGFzc0JyZWFrSW5mb3NbcmVuZGVyZXIuY2xhc3NCcmVha0luZm9zLmxlbmd0aCAtIDFdLnN5bWJvbFxuICAgICAgICAgICAgICAgIDogZ2V0RGVmYXVsdFN5bWJvbChsYXllciwgbWFwVmlldywgcmVuZGVyZXJUeXBlKTtcbiAgICB9XG4gICAgY29uc3QgZGVmYXVsdFN5bWJvbCA9IHJlbmRlcmVyLmRlZmF1bHRTeW1ib2w7XG4gICAgY29uc3QgZGVmYXVsdExhYmVsID0gcmVuZGVyZXIuZGVmYXVsdExhYmVsO1xuICAgIGNvbnN0IGJhY2tncm91bmRGaWxsU3ltYm9sID0gcmVuZGVyZXIuYmFja2dyb3VuZEZpbGxTeW1ib2w7XG4gICAgY29uc3QgdGhlbWUgPSBvcHRpb25zLnRoZW1lID8gb3B0aW9ucy50aGVtZSA6IGF1dGhTaXplVmlzVmFyID8gYXV0aFNpemVWaXNWYXIudGhlbWUgOiBcImhpZ2gtdG8tbG93XCI7XG4gICAgbGV0IGlzSW52ZXJ0ZWQgPSBmYWxzZTtcbiAgICBpZiAoc2l6ZVZpc1Zhcikge1xuICAgICAgICBpZiAodGhlbWUgPT09IHNpemVWaXNWYXIudGhlbWUpIHtcbiAgICAgICAgICAgIC8vIG9ubHkgaWYgdGhlbWUgc3RheXMgdGhlIHNhbWVcbiAgICAgICAgICAgIGlmIChzaXplVmlzVmFyLm1pblNpemUuc3RvcHMpIHtcbiAgICAgICAgICAgICAgICBpc0ludmVydGVkID0gc2l6ZVZpc1Zhci5taW5TaXplLnN0b3BzWzBdLnNpemUgPiBzaXplVmlzVmFyLm1heFNpemUuc3RvcHNbMF0uc2l6ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGlzSW52ZXJ0ZWQgPSBzaXplVmlzVmFyLm1pblNpemUgPiBzaXplVmlzVmFyLm1heFNpemU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGNvbnN0IG1pblN5bSA9IHJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvc1swXS5zeW1ib2w7XG4gICAgICAgIGNvbnN0IG1heFN5bSA9IHJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvc1tyZW5kZXJlci5jbGFzc0JyZWFrSW5mb3MubGVuZ3RoIC0gMV0uc3ltYm9sO1xuICAgICAgICBjb25zdCBsb3dWYWx1ZSA9IGdldFN5bWJvbFNpemUobWluU3ltKTtcbiAgICAgICAgY29uc3QgaGlnaFZhbHVlID0gZ2V0U3ltYm9sU2l6ZShtYXhTeW0pO1xuICAgICAgICBpc0ludmVydGVkID0gbG93VmFsdWUgPiBoaWdoVmFsdWU7XG4gICAgfVxuICAgIGlmIChvcHRpb25zLmZpZWxkSW5mb3MgJiZcbiAgICAgICAgb3B0aW9ucy5maWVsZEluZm9zWzBdICYmXG4gICAgICAgIHNpemVWaXNWYXIgJiZcbiAgICAgICAgb3B0aW9ucy5maWVsZEluZm9zWzBdLmZpZWxkID09PSBzaXplVmlzVmFyLmZpZWxkICYmXG4gICAgICAgIG9wdGlvbnMuZmllbGRJbmZvc1swXS5leHByZXNzaW9uID09PSBzaXplVmlzVmFyLnZhbHVlRXhwcmVzc2lvbiAmJlxuICAgICAgICBvcHRpb25zLm5vcm1hbGl6YXRpb25GaWVsZCA9PT0gc2l6ZVZpc1Zhci5ub3JtYWxpemF0aW9uRmllbGQpIHtcbiAgICAgICAgZGVsZXRlIG9wdGlvbnMuZmllbGRJbmZvcztcbiAgICAgICAgaWYgKGlzRW1wdHkob3B0aW9ucykpIHtcbiAgICAgICAgICAgIC8vIG5vdGhpbmcgcmVhbGx5IGNoYW5nZXM7IHJlbW92ZSBjb2xvciB2aXNWYXIgaWYgdGhlcmUgaXMgb25lXG4gICAgICAgICAgICBjb25zdCBuZXdSZW5kZXJlciA9IHJlbmRlcmVyLmNsb25lKCk7XG4gICAgICAgICAgICBuZXdSZW5kZXJlci52aXN1YWxWYXJpYWJsZXMgPSBnZXRWaXNWYXJzRXhjZXB0KHJlbmRlcmVyLCBcImNvbG9yXCIpO1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhcImNyZWF0ZVNpemVSZW5kZXJlckZyb21FeGlzdGluZyBvdXQgMVwiLCBuZXdSZW5kZXJlci50b0pTT04oKSk7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgcmVuZGVyZXI6IG5ld1JlbmRlcmVyIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGZpZWxkSW5mbyA9IG9wdGlvbnMuZmllbGRJbmZvcyAmJiBvcHRpb25zLmZpZWxkSW5mb3NbMF1cbiAgICAgICAgPyBvcHRpb25zLmZpZWxkSW5mb3NbMF1cbiAgICAgICAgOiBzaXplVmlzVmFyXG4gICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICBmaWVsZDogc2l6ZVZpc1Zhci5maWVsZCxcbiAgICAgICAgICAgICAgICBleHByZXNzaW9uOiBzaXplVmlzVmFyLnZhbHVlRXhwcmVzc2lvbixcbiAgICAgICAgICAgICAgICBleHByZXNzaW9uVGl0bGU6IHNpemVWaXNWYXIudmFsdWVFeHByZXNzaW9uVGl0bGUsXG4gICAgICAgICAgICAgICAgc2ltcGxlRmllbGRUeXBlOiBzaW1wbGVGaWVsZFR5cGVzLk5VTUJFUlxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgOiB7XG4gICAgICAgICAgICAgICAgZmllbGQ6IHJlbmRlcmVyLmZpZWxkLFxuICAgICAgICAgICAgICAgIGV4cHJlc3Npb246IHJlbmRlcmVyLnZhbHVlRXhwcmVzc2lvbixcbiAgICAgICAgICAgICAgICBleHByZXNzaW9uVGl0bGU6IHJlbmRlcmVyLnZhbHVlRXhwcmVzc2lvblRpdGxlLFxuICAgICAgICAgICAgICAgIHNpbXBsZUZpZWxkVHlwZTogc2ltcGxlRmllbGRUeXBlcy5OVU1CRVJcbiAgICAgICAgICAgIH07XG4gICAgY29uc3Qgbm9ybWFsaXphdGlvbkZpZWxkID0gb3B0aW9ucy5ub3JtYWxpemF0aW9uRmllbGQgPT09IG51bGxcbiAgICAgICAgPyB1bmRlZmluZWRcbiAgICAgICAgOiBvcHRpb25zLm5vcm1hbGl6YXRpb25GaWVsZFxuICAgICAgICAgICAgPyBvcHRpb25zLm5vcm1hbGl6YXRpb25GaWVsZFxuICAgICAgICAgICAgOiBzaXplVmlzVmFyXG4gICAgICAgICAgICAgICAgPyBzaXplVmlzVmFyLm5vcm1hbGl6YXRpb25GaWVsZFxuICAgICAgICAgICAgICAgIDogcmVuZGVyZXIubm9ybWFsaXphdGlvbkZpZWxkO1xuICAgIGxldCBuZWVkTmV3U3RhdGlzdGljcyA9IGZhbHNlO1xuICAgIGlmIChvcHRpb25zLm5vcm1hbGl6YXRpb25GaWVsZCA9PT0gbnVsbCB8fFxuICAgICAgICBvcHRpb25zLm5vcm1hbGl6YXRpb25GaWVsZCB8fFxuICAgICAgICAob3B0aW9ucy5maWVsZEluZm9zICYmIG9wdGlvbnMuZmllbGRJbmZvc1swXSkgfHxcbiAgICAgICAgKGF1dGhJbmZvLmNsYXNzaWZpY2F0aW9uTWV0aG9kID09PSBcIm1hbnVhbFwiICYmICFvcHRpb25zLnRoZW1lKSB8fFxuICAgICAgICBhdXRoSW5mby5jbGFzc2lmaWNhdGlvbk1ldGhvZCA9PT0gXCJlcXVhbC1pbnRlcnZhbFwiKSB7XG4gICAgICAgIG5lZWROZXdTdGF0aXN0aWNzID0gdHJ1ZTtcbiAgICB9XG4gICAgY29uc3QgbWluVmFsdWUgPSBvcHRpb25zLmRpc2NhcmRNaW5NYXhcbiAgICAgICAgPyB1bmRlZmluZWRcbiAgICAgICAgOiBpc0RlZmluZWQob3B0aW9ucy5taW4pXG4gICAgICAgICAgICA/IG9wdGlvbnMubWluXG4gICAgICAgICAgICA6IG5lZWROZXdTdGF0aXN0aWNzXG4gICAgICAgICAgICAgICAgPyB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICA6IHNpemVWaXNWYXJcbiAgICAgICAgICAgICAgICAgICAgPyBhdXRoU2l6ZVZpc1ZhciA9PT0gbnVsbCB8fCBhdXRoU2l6ZVZpc1ZhciA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXV0aFNpemVWaXNWYXIubWluU2xpZGVyVmFsdWVcbiAgICAgICAgICAgICAgICAgICAgOiByZW5kZXJlci5jbGFzc0JyZWFrSW5mb3NbMF0ubWluVmFsdWU7XG4gICAgY29uc3QgbWF4VmFsdWUgPSBvcHRpb25zLmRpc2NhcmRNaW5NYXhcbiAgICAgICAgPyB1bmRlZmluZWRcbiAgICAgICAgOiBpc0RlZmluZWQob3B0aW9ucy5tYXgpXG4gICAgICAgICAgICA/IG9wdGlvbnMubWF4XG4gICAgICAgICAgICA6IG5lZWROZXdTdGF0aXN0aWNzXG4gICAgICAgICAgICAgICAgPyB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICA6IHNpemVWaXNWYXJcbiAgICAgICAgICAgICAgICAgICAgPyBhdXRoU2l6ZVZpc1ZhciA9PT0gbnVsbCB8fCBhdXRoU2l6ZVZpc1ZhciA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXV0aFNpemVWaXNWYXIubWF4U2xpZGVyVmFsdWVcbiAgICAgICAgICAgICAgICAgICAgOiByZW5kZXJlci5jbGFzc0JyZWFrSW5mb3NbcmVuZGVyZXIuY2xhc3NCcmVha0luZm9zLmxlbmd0aCAtIDFdLm1heFZhbHVlO1xuICAgIGNvbnN0IGNvbmZpZyA9IHtcbiAgICAgICAgbGF5ZXIsXG4gICAgICAgIHZpZXc6IG1hcFZpZXcsXG4gICAgICAgIHRoZW1lLFxuICAgICAgICBmaWVsZDogZmllbGRJbmZvLmZpZWxkLFxuICAgICAgICB2YWx1ZUV4cHJlc3Npb246IGZpZWxkSW5mby5leHByZXNzaW9uLFxuICAgICAgICB2YWx1ZUV4cHJlc3Npb25UaXRsZTogZmllbGRJbmZvLmV4cHJlc3Npb25UaXRsZSxcbiAgICAgICAgbm9ybWFsaXphdGlvbkZpZWxkLFxuICAgICAgICBtaW5WYWx1ZSxcbiAgICAgICAgbWF4VmFsdWUsXG4gICAgICAgIG91dGxpbmVPcHRpbWl6YXRpb25FbmFibGVkOiBtYXBJbWFnZVN1YmxheWVyXG4gICAgICAgICAgICA/IGZhbHNlXG4gICAgICAgICAgICA6IGlzRGVmaW5lZChvcHRpb25zLm91dGxpbmVPcHRpbWl6YXRpb25FbmFibGVkKVxuICAgICAgICAgICAgICAgID8gb3B0aW9ucy5vdXRsaW5lT3B0aW1pemF0aW9uRW5hYmxlZFxuICAgICAgICAgICAgICAgIDogISFleHRyYXMuc2l6ZU91dGxpbmVWaXNWYXIsXG4gICAgICAgIHNpemVPcHRpbWl6YXRpb25FbmFibGVkOiBtYXBJbWFnZVN1YmxheWVyXG4gICAgICAgICAgICA/IGZhbHNlXG4gICAgICAgICAgICA6IHNpemVWaXNWYXJcbiAgICAgICAgICAgICAgICA/IGlzRGVmaW5lZChvcHRpb25zLnNpemVPcHRpbWl6YXRpb25FbmFibGVkKVxuICAgICAgICAgICAgICAgICAgICA/IG9wdGlvbnMuc2l6ZU9wdGltaXphdGlvbkVuYWJsZWRcbiAgICAgICAgICAgICAgICAgICAgOiB0eXBlb2Ygc2l6ZVZpc1Zhci5taW5TaXplID09PSBcIm9iamVjdFwiXG4gICAgICAgICAgICAgICAgOiB0cnVlIC8qIGlzUG9seWdvbihsYXllcilcbiAgICAgICAgPyB0cnVlXG4gICAgICAgIDogZmFsc2UsICovLFxuICAgICAgICBsZWdlbmRPcHRpb25zOiAoKF9hID0gb3B0aW9ucy5sZWdlbmRPcHRpb25zKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EudG9KU09OKCkpIHx8XG4gICAgICAgICAgICAoKF9iID0gc2l6ZVZpc1ZhciA9PT0gbnVsbCB8fCBzaXplVmlzVmFyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzaXplVmlzVmFyLmxlZ2VuZE9wdGlvbnMpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi50b0pTT04oKSkgfHxcbiAgICAgICAgICAgICgoX2MgPSByZW5kZXJlci5sZWdlbmRPcHRpb25zKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MudG9KU09OKCkpLFxuICAgICAgICBkZWZhdWx0U3ltYm9sRW5hYmxlZDogaXNEZWZpbmVkKG9wdGlvbnMuZGVmYXVsdFN5bWJvbEVuYWJsZWQpXG4gICAgICAgICAgICA/IG9wdGlvbnMuZGVmYXVsdFN5bWJvbEVuYWJsZWRcbiAgICAgICAgICAgIDogISFyZW5kZXJlci5kZWZhdWx0U3ltYm9sLFxuICAgICAgICBmb3JCaW5uaW5nOiAoKF9kID0gbGF5ZXIuZmVhdHVyZVJlZHVjdGlvbikgPT09IG51bGwgfHwgX2QgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9kLnR5cGUpID09PSBcImJpbm5pbmdcIlxuICAgIH07XG4gICAgLy8gY29uc29sZS5sb2coXCJjcmVhdGVTaXplUmVuZGVyZXJGcm9tRXhpc3RpbmctY29uZmlnXCIsIGNvbmZpZyk7XG4gICAgcmV0dXJuIG1vZHVsZXMuU2l6ZUNyZWF0b3IuY3JlYXRlQ29udGludW91c1JlbmRlcmVyKGNvbmZpZykudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJjcmVhdGVTaXplUmVuZGVyZXJGcm9tRXhpc3Rpbmctc3VjY2Vzc1wiLCByZXN1bHQucmVuZGVyZXIudG9KU09OKCkpO1xuICAgICAgICAvLyByZXNldCBkYXRhIHZhbHVlcyBpZiBuZWNlc3NhcnlcbiAgICAgICAgaWYgKG9wdGlvbnMuZGlzY2FyZE1pbk1heCkge1xuICAgICAgICAgICAgY29uc3Qgc2l6ZVZpc1ZhciA9IGdldFZpc1ZhcihyZW5kZXJlciwgXCJzaXplXCIpO1xuICAgICAgICAgICAgY29uc3QgbmV3U2l6ZVZpc1ZhciA9IGdldFZpc1ZhcihyZXN1bHQucmVuZGVyZXIsIFwic2l6ZVwiKTtcbiAgICAgICAgICAgIHNpemVWaXNWYXIubWluRGF0YVZhbHVlID0gbmV3U2l6ZVZpc1Zhci5taW5EYXRhVmFsdWU7XG4gICAgICAgICAgICBzaXplVmlzVmFyLm1heERhdGFWYWx1ZSA9IG5ld1NpemVWaXNWYXIubWF4RGF0YVZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIC8vIGtlZXAgc2xpZGVyIHZhbHVlc1xuICAgICAgICBpZiAoIW9wdGlvbnMuZmllbGRJbmZvcyAmJlxuICAgICAgICAgICAgb3B0aW9ucy5ub3JtYWxpemF0aW9uRmllbGQgPT09IHVuZGVmaW5lZCAmJlxuICAgICAgICAgICAgc2l6ZVZpc1ZhciAmJlxuICAgICAgICAgICAgdGhlbWUgPT09IChzaXplVmlzVmFyID09PSBudWxsIHx8IHNpemVWaXNWYXIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNpemVWaXNWYXIudGhlbWUpKSB7XG4gICAgICAgICAgICBjb25zdCBuZXdTaXplVmlzVmFyID0gZ2V0VmlzVmFyKHJlc3VsdC5yZW5kZXJlciwgXCJzaXplXCIpO1xuICAgICAgICAgICAgbmV3U2l6ZVZpc1Zhci5taW5EYXRhVmFsdWUgPSBzaXplVmlzVmFyLm1pbkRhdGFWYWx1ZTtcbiAgICAgICAgICAgIG5ld1NpemVWaXNWYXIubWF4RGF0YVZhbHVlID0gc2l6ZVZpc1Zhci5tYXhEYXRhVmFsdWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFtcbiAgICAgICAgICAgIFwiY29sb3Itc2l6ZVwiLFxuICAgICAgICAgICAgXCJjb2xvci1hZ2Utc2l6ZVwiLFxuICAgICAgICAgICAgXCJjb2xvci1zaXplLWFnZVwiLFxuICAgICAgICAgICAgXCJ0eXBlLXNpemVcIixcbiAgICAgICAgICAgIFwidHlwZS1zaXplLWFnZVwiLFxuICAgICAgICAgICAgXCJyZWxhdGlvbnNoaXAtc2l6ZVwiLFxuICAgICAgICAgICAgXCJwcmVkb21pbmFuY2Utc2l6ZVwiXG4gICAgICAgIF0uaW5kZXhPZihyZW5kZXJlclR5cGUpID4gLTEpIHtcbiAgICAgICAgICAgIC8vIGp1c3Qgc3dpdGNoIG91dCBzaXplIHZhcmlhYmxlc1xuICAgICAgICAgICAgcmVuZGVyZXIudmlzdWFsVmFyaWFibGVzID0gZ2V0VmlzVmFyc0V4Y2VwdChyZW5kZXJlciwgXCJzaXplXCIpIHx8IFtdO1xuICAgICAgICAgICAgcmVuZGVyZXIudmlzdWFsVmFyaWFibGVzID0gZ2V0VmlzVmFyc0V4Y2VwdChyZW5kZXJlciwgXCJzaXplXCIsIFwib3V0bGluZVwiKSB8fCBbXTtcbiAgICAgICAgICAgIHJlbmRlcmVyLmF1dGhvcmluZ0luZm8udmlzdWFsVmFyaWFibGVzID0gZ2V0QXV0aFZpc1ZhcnNFeGNlcHQocmVuZGVyZXIsIFwic2l6ZVwiKSB8fCBbXTtcbiAgICAgICAgICAgIGNvbnN0IHNpemVWaXNWYXIgPSBnZXRWaXNWYXIocmVzdWx0LnJlbmRlcmVyLCBcInNpemVcIik7XG4gICAgICAgICAgICByZW5kZXJlci52aXN1YWxWYXJpYWJsZXMucHVzaChzaXplVmlzVmFyKTtcbiAgICAgICAgICAgIGNvbnN0IHNpemVBdXRoVmlzVmFyID0gZ2V0QXV0aFZpc1ZhcihyZXN1bHQucmVuZGVyZXIsIFwic2l6ZVwiKTtcbiAgICAgICAgICAgIHJlbmRlcmVyLmF1dGhvcmluZ0luZm8udmlzdWFsVmFyaWFibGVzLnB1c2goc2l6ZUF1dGhWaXNWYXIpO1xuICAgICAgICAgICAgY29uc3Qgc2l6ZU91dGxpbmVWaXNWYXIgPSBnZXRWaXNWYXIocmVzdWx0LnJlbmRlcmVyLCBcInNpemVcIiwgXCJvdXRsaW5lXCIpO1xuICAgICAgICAgICAgaWYgKHNpemVPdXRsaW5lVmlzVmFyKSB7XG4gICAgICAgICAgICAgICAgcmVuZGVyZXIudmlzdWFsVmFyaWFibGVzLnB1c2goc2l6ZU91dGxpbmVWaXNWYXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZml4Tm9ybWFsaXphdGlvbkZpZWxkKHJlbmRlcmVyKTtcbiAgICAgICAgICAgIHJlc3VsdC5yZW5kZXJlciA9IHJlbmRlcmVyLmNsb25lKCk7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgIH1cbiAgICAgICAgYXBwbHlFeHRyYVZpc1ZhcnMoZXh0cmFzLCByZXN1bHQucmVuZGVyZXIpO1xuICAgICAgICBpZiAoc3ltYm9sICYmICgoX2EgPSByZXN1bHQucmVuZGVyZXIuY2xhc3NCcmVha0luZm9zKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubGVuZ3RoKSkge1xuICAgICAgICAgICAgcmVzdWx0LnJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvc1swXS5zeW1ib2wgPSBzeW1ib2w7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGRlZmF1bHRTeW1ib2wpIHtcbiAgICAgICAgICAgIHJlc3VsdC5yZW5kZXJlci5kZWZhdWx0U3ltYm9sID0gZGVmYXVsdFN5bWJvbDtcbiAgICAgICAgICAgIHJlc3VsdC5yZW5kZXJlci5kZWZhdWx0TGFiZWwgPSBkZWZhdWx0TGFiZWw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGJhY2tncm91bmRGaWxsU3ltYm9sKSB7XG4gICAgICAgICAgICByZXN1bHQucmVuZGVyZXIuYmFja2dyb3VuZEZpbGxTeW1ib2wgPSBiYWNrZ3JvdW5kRmlsbFN5bWJvbDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoaXNJbnZlcnRlZCkge1xuICAgICAgICAgICAgY29uc3Qgc2l6ZVZpc1ZhciA9IGdldFZpc1ZhcihyZXN1bHQucmVuZGVyZXIsIFwic2l6ZVwiKTtcbiAgICAgICAgICAgIGNvbnN0IHRtcCA9IHNpemVWaXNWYXIubWluU2l6ZTtcbiAgICAgICAgICAgIHNpemVWaXNWYXIubWluU2l6ZSA9IHNpemVWaXNWYXIubWF4U2l6ZTtcbiAgICAgICAgICAgIHNpemVWaXNWYXIubWF4U2l6ZSA9IHRtcDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlc3VsdCk7XG4gICAgfSwgKGVycm9yKSA9PiBQcm9taXNlLnJlamVjdChlcnJvcikpO1xufVxuLyoqXG4gKiBDcmVhdGVzIGEgU2l6ZSByZW5kZXJlciB3aXRoIHNldHRpbmdzIGZyb20gY3VycmVudCByZW5kZXJlclxuICovXG5mdW5jdGlvbiBjcmVhdGVTaXplQWdlUmVuZGVyZXJGcm9tRXhpc3Rpbmcob3B0aW9ucykge1xuICAgIHZhciBfYSwgX2IsIF9jO1xuICAgIGNvbnN0IHsgbGF5ZXI6IHNtTGF5ZXIsIG1hcEltYWdlU3VibGF5ZXIsIG1hcFZpZXcgLyogLCBzdXBwb3J0c0FyY2FkZSAqLywgbW9kdWxlcyB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgY29uc3QgbGF5ZXIgPSBzbUxheWVyO1xuICAgIC8qIGlmIChtYXBJbWFnZVN1YmxheWVyICYmICFzdXBwb3J0c0FyY2FkZSkge1xuICAgICAgcmV0dXJuIGNyZWF0ZUNsYXNzZWRTaXplUmVuZGVyZXJGcm9tRXhpc3Rpbmcob3B0aW9ucyk7XG4gICAgfSAqL1xuICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuICAgIGNvbnN0IHJlbmRlcmVyID0gZ2V0UmVuZGVyZXIobGF5ZXIpO1xuICAgIGNvbnN0IHJlbmRlcmVyVHlwZSA9IGdldFJlbmRlcmVyVHlwZSgpO1xuICAgIGNvbnN0IHNpemVWaXNWYXIgPSBnZXRWaXNWYXIocmVuZGVyZXIsIFwic2l6ZVwiKTtcbiAgICBjb25zdCBhdXRoU2l6ZVZpc1ZhciA9IGdldEF1dGhWaXNWYXIocmVuZGVyZXIsIFwic2l6ZVwiKTtcbiAgICBjb25zdCBleHRyYXMgPSBzYXZlRXh0cmFWaXNWYXJzKHJlbmRlcmVyKTtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBvcHRpb25zLnN0YXJ0VGltZSA/IG9wdGlvbnMuc3RhcnRUaW1lIDogYXV0aFNpemVWaXNWYXIuc3RhcnRUaW1lO1xuICAgIGNvbnN0IGVuZFRpbWUgPSBvcHRpb25zLmVuZFRpbWUgPyBvcHRpb25zLmVuZFRpbWUgOiBhdXRoU2l6ZVZpc1Zhci5lbmRUaW1lO1xuICAgIGxldCBzeW1ib2w7XG4gICAgaWYgKFtcInR5cGUtc2l6ZS1hZ2VcIl0uaW5kZXhPZihyZW5kZXJlclR5cGUpID4gLTEpIHtcbiAgICAgICAgY29uc3QgdXZSZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKTtcbiAgICAgICAgc3ltYm9sID1cbiAgICAgICAgICAgIHV2UmVuZGVyZXIudW5pcXVlVmFsdWVJbmZvcyAmJiB1dlJlbmRlcmVyLnVuaXF1ZVZhbHVlSW5mb3MubGVuZ3RoXG4gICAgICAgICAgICAgICAgPyB1dlJlbmRlcmVyLnVuaXF1ZVZhbHVlSW5mb3NbMF0uc3ltYm9sXG4gICAgICAgICAgICAgICAgOiBnZXREZWZhdWx0U3ltYm9sKGxheWVyLCBtYXBWaWV3LCByZW5kZXJlclR5cGUpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgc3ltYm9sID1cbiAgICAgICAgICAgIHJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvcyAmJiByZW5kZXJlci5jbGFzc0JyZWFrSW5mb3MubGVuZ3RoXG4gICAgICAgICAgICAgICAgPyByZW5kZXJlci5jbGFzc0JyZWFrSW5mb3NbMF0uc3ltYm9sXG4gICAgICAgICAgICAgICAgOiBnZXREZWZhdWx0U3ltYm9sKGxheWVyLCBtYXBWaWV3LCByZW5kZXJlclR5cGUpO1xuICAgIH1cbiAgICBjb25zdCBkZWZhdWx0U3ltYm9sID0gcmVuZGVyZXIuZGVmYXVsdFN5bWJvbDtcbiAgICBjb25zdCBkZWZhdWx0TGFiZWwgPSByZW5kZXJlci5kZWZhdWx0TGFiZWw7XG4gICAgY29uc3QgYmFja2dyb3VuZEZpbGxTeW1ib2wgPSByZW5kZXJlci5iYWNrZ3JvdW5kRmlsbFN5bWJvbDtcbiAgICBsZXQgaXNJbnZlcnRlZCA9IGZhbHNlO1xuICAgIGlmIChzaXplVmlzVmFyKSB7XG4gICAgICAgIGlmIChzaXplVmlzVmFyLm1pblNpemUuc3RvcHMpIHtcbiAgICAgICAgICAgIGlzSW52ZXJ0ZWQgPSBzaXplVmlzVmFyLm1pblNpemUuc3RvcHNbMF0uc2l6ZSA+IHNpemVWaXNWYXIubWF4U2l6ZS5zdG9wc1swXS5zaXplO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgaXNJbnZlcnRlZCA9IHNpemVWaXNWYXIubWluU2l6ZSA+IHNpemVWaXNWYXIubWF4U2l6ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoYXV0aFNpemVWaXNWYXIudGhlbWUgPT09IFwiYmVsb3dcIikge1xuICAgICAgICAgICAgLy8gd2Ugd2FudCBpdCBkaWZmZXJlbnQgZm9yIGJlbG93XG4gICAgICAgICAgICBpc0ludmVydGVkID0gIWlzSW52ZXJ0ZWQ7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGNvbnN0IG1pblN5bSA9IHJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvc1swXS5zeW1ib2w7XG4gICAgICAgIGNvbnN0IG1heFN5bSA9IHJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvc1tyZW5kZXJlci5jbGFzc0JyZWFrSW5mb3MubGVuZ3RoIC0gMV0uc3ltYm9sO1xuICAgICAgICBjb25zdCBsb3dWYWx1ZSA9IGdldFN5bWJvbFNpemUobWluU3ltKTtcbiAgICAgICAgY29uc3QgaGlnaFZhbHVlID0gZ2V0U3ltYm9sU2l6ZShtYXhTeW0pO1xuICAgICAgICBpc0ludmVydGVkID0gbG93VmFsdWUgPiBoaWdoVmFsdWU7XG4gICAgfVxuICAgIGlmIChvcHRpb25zLmZpZWxkSW5mb3MgJiYgb3B0aW9ucy5maWVsZEluZm9zWzBdICYmIHNpemVWaXNWYXIgJiYgb3B0aW9ucy5maWVsZEluZm9zWzBdLmZpZWxkID09PSBzaXplVmlzVmFyLmZpZWxkKSB7XG4gICAgICAgIGRlbGV0ZSBvcHRpb25zLmZpZWxkSW5mb3M7XG4gICAgICAgIGlmIChpc0VtcHR5KG9wdGlvbnMpKSB7XG4gICAgICAgICAgICAvLyBub3RoaW5nIHJlYWxseSBjaGFuZ2VzOyByZW1vdmUgY29sb3IgdmlzVmFyIGlmIHRoZXJlIGlzIG9uZVxuICAgICAgICAgICAgY29uc3QgbmV3UmVuZGVyZXIgPSByZW5kZXJlci5jbG9uZSgpO1xuICAgICAgICAgICAgbmV3UmVuZGVyZXIudmlzdWFsVmFyaWFibGVzID0gZ2V0VmlzVmFyc0V4Y2VwdChyZW5kZXJlciwgXCJjb2xvclwiKTtcbiAgICAgICAgICAgIC8vY29uc29sZS5sb2coXCJjcmVhdGVTaXplUmVuZGVyZXJGcm9tRXhpc3Rpbmcgb3V0IDFcIiwgbmV3UmVuZGVyZXIudG9KU09OKCkpO1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHJlbmRlcmVyOiBuZXdSZW5kZXJlciB9KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBsZXQgcmFuZ2VDaGFuZ2VkID0gZmFsc2U7XG4gICAgaWYgKG9wdGlvbnMuc3RhcnRUaW1lIHx8IG9wdGlvbnMuZW5kVGltZSB8fCBvcHRpb25zLnVuaXRzIHx8IG9wdGlvbnMuZmllbGRJbmZvIHx8IG9wdGlvbnMudGhlbWUpIHtcbiAgICAgICAgcmFuZ2VDaGFuZ2VkID0gdHJ1ZTtcbiAgICB9XG4gICAgY29uc3QgbWluVmFsdWUgPSBvcHRpb25zLmRpc2NhcmRNaW5NYXhcbiAgICAgICAgPyB1bmRlZmluZWRcbiAgICAgICAgOiBpc0RlZmluZWQob3B0aW9ucy5taW4pXG4gICAgICAgICAgICA/IG9wdGlvbnMubWluXG4gICAgICAgICAgICA6IHJhbmdlQ2hhbmdlZFxuICAgICAgICAgICAgICAgID8gdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgOiBhdXRoU2l6ZVZpc1ZhclxuICAgICAgICAgICAgICAgICAgICA/IGF1dGhTaXplVmlzVmFyLm1pblNsaWRlclZhbHVlXG4gICAgICAgICAgICAgICAgICAgIDogcmVuZGVyZXIuY2xhc3NCcmVha0luZm9zWzBdLm1pblZhbHVlO1xuICAgIGNvbnN0IG1heFZhbHVlID0gb3B0aW9ucy5kaXNjYXJkTWluTWF4XG4gICAgICAgID8gdW5kZWZpbmVkXG4gICAgICAgIDogaXNEZWZpbmVkKG9wdGlvbnMubWF4KVxuICAgICAgICAgICAgPyBvcHRpb25zLm1heFxuICAgICAgICAgICAgOiByYW5nZUNoYW5nZWRcbiAgICAgICAgICAgICAgICA/IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgIDogYXV0aFNpemVWaXNWYXJcbiAgICAgICAgICAgICAgICAgICAgPyBhdXRoU2l6ZVZpc1Zhci5tYXhTbGlkZXJWYWx1ZVxuICAgICAgICAgICAgICAgICAgICA6IHJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvc1tyZW5kZXJlci5jbGFzc0JyZWFrSW5mb3MubGVuZ3RoIC0gMV0ubWF4VmFsdWU7XG4gICAgY29uc3QgdGhlbWUgPSBvcHRpb25zLnRoZW1lID8gb3B0aW9ucy50aGVtZSA6IGF1dGhTaXplVmlzVmFyID8gYXV0aFNpemVWaXNWYXIudGhlbWUgOiBcImhpZ2gtdG8tbG93XCI7XG4gICAgY29uc3QgY29uZmlnID0ge1xuICAgICAgICBsYXllcixcbiAgICAgICAgdmlldzogbWFwVmlldyxcbiAgICAgICAgdGhlbWUsXG4gICAgICAgIHN0YXJ0VGltZSxcbiAgICAgICAgZW5kVGltZSxcbiAgICAgICAgdW5pdDogb3B0aW9ucy51bml0cyA/IG9wdGlvbnMudW5pdHMgOiBhdXRoU2l6ZVZpc1Zhci51bml0cyxcbiAgICAgICAgbWluVmFsdWUsXG4gICAgICAgIG1heFZhbHVlLFxuICAgICAgICBvdXRsaW5lT3B0aW1pemF0aW9uRW5hYmxlZDogbWFwSW1hZ2VTdWJsYXllclxuICAgICAgICAgICAgPyBmYWxzZVxuICAgICAgICAgICAgOiBpc0RlZmluZWQob3B0aW9ucy5vdXRsaW5lT3B0aW1pemF0aW9uRW5hYmxlZClcbiAgICAgICAgICAgICAgICA/IG9wdGlvbnMub3V0bGluZU9wdGltaXphdGlvbkVuYWJsZWRcbiAgICAgICAgICAgICAgICA6ICEhZXh0cmFzLnNpemVPdXRsaW5lVmlzVmFyLFxuICAgICAgICBzaXplT3B0aW1pemF0aW9uRW5hYmxlZDogbWFwSW1hZ2VTdWJsYXllclxuICAgICAgICAgICAgPyBmYWxzZVxuICAgICAgICAgICAgOiBzaXplVmlzVmFyXG4gICAgICAgICAgICAgICAgPyBpc0RlZmluZWQob3B0aW9ucy5zaXplT3B0aW1pemF0aW9uRW5hYmxlZClcbiAgICAgICAgICAgICAgICAgICAgPyBvcHRpb25zLnNpemVPcHRpbWl6YXRpb25FbmFibGVkXG4gICAgICAgICAgICAgICAgICAgIDogdHlwZW9mIHNpemVWaXNWYXIubWluU2l6ZSA9PT0gXCJvYmplY3RcIlxuICAgICAgICAgICAgICAgIDogdHJ1ZSAvKiBpc1BvbHlnb25UeXBlKGxheWVyKVxuICAgICAgICA/IHRydWVcbiAgICAgICAgOiBmYWxzZSwgKi8sXG4gICAgICAgIGxlZ2VuZE9wdGlvbnM6ICgoX2EgPSBvcHRpb25zLmxlZ2VuZE9wdGlvbnMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS50b0pTT04oKSkgfHxcbiAgICAgICAgICAgICgoX2IgPSBzaXplVmlzVmFyID09PSBudWxsIHx8IHNpemVWaXNWYXIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNpemVWaXNWYXIubGVnZW5kT3B0aW9ucykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnRvSlNPTigpKSB8fFxuICAgICAgICAgICAgKChfYyA9IHJlbmRlcmVyLmxlZ2VuZE9wdGlvbnMpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy50b0pTT04oKSksXG4gICAgICAgIGRlZmF1bHRTeW1ib2xFbmFibGVkOiBpc0RlZmluZWQob3B0aW9ucy5kZWZhdWx0U3ltYm9sRW5hYmxlZClcbiAgICAgICAgICAgID8gb3B0aW9ucy5kZWZhdWx0U3ltYm9sRW5hYmxlZFxuICAgICAgICAgICAgOiAhIXJlbmRlcmVyLmRlZmF1bHRTeW1ib2xcbiAgICB9O1xuICAgIC8vY29uc29sZS5sb2coY29uZmlnKTtcbiAgICByZXR1cm4gbW9kdWxlcy5TaXplQ3JlYXRvci5jcmVhdGVBZ2VSZW5kZXJlcihjb25maWcpLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgICB2YXIgX2E7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKFwiY3JlYXRlQWdlUmVuZGVyZXJGcm9tRXhpc3RpbmdcIiwgcmVzdWx0LnJlbmRlcmVyLnRvSlNPTigpKTtcbiAgICAgICAgLy8gcmVzZXQgZGF0YSB2YWx1ZXMgaWYgbmVjZXNzYXJ5XG4gICAgICAgIGlmIChvcHRpb25zLmRpc2NhcmRNaW5NYXgpIHtcbiAgICAgICAgICAgIGNvbnN0IHNpemVWaXNWYXIgPSBnZXRWaXNWYXIocmVuZGVyZXIsIFwic2l6ZVwiKTtcbiAgICAgICAgICAgIGNvbnN0IG5ld1NpemVWaXNWYXIgPSBnZXRWaXNWYXIocmVzdWx0LnJlbmRlcmVyLCBcInNpemVcIik7XG4gICAgICAgICAgICBzaXplVmlzVmFyLm1pbkRhdGFWYWx1ZSA9IG5ld1NpemVWaXNWYXIubWluRGF0YVZhbHVlO1xuICAgICAgICAgICAgc2l6ZVZpc1Zhci5tYXhEYXRhVmFsdWUgPSBuZXdTaXplVmlzVmFyLm1heERhdGFWYWx1ZTtcbiAgICAgICAgfVxuICAgICAgICAvLyBrZWVwIGZpZWxkIHRoZSBzYW1lIGFzIGJlZm9yZVxuICAgICAgICBjb25zdCBuZXdBdXRoU2l6ZVZpc1ZhciA9IGdldEF1dGhWaXNWYXIocmVzdWx0LnJlbmRlcmVyLCBcInNpemVcIik7XG4gICAgICAgIG5ld0F1dGhTaXplVmlzVmFyLmZpZWxkID0gYXV0aFNpemVWaXNWYXIuZmllbGQ7XG4gICAgICAgIC8vIGtlZXAgc2xpZGVyIHZhbHVlc1xuICAgICAgICBpZiAoIXJhbmdlQ2hhbmdlZCkge1xuICAgICAgICAgICAgY29uc3QgbmV3U2l6ZVZpc1ZhciA9IGdldFZpc1ZhcihyZXN1bHQucmVuZGVyZXIsIFwic2l6ZVwiKTtcbiAgICAgICAgICAgIG5ld1NpemVWaXNWYXIubWluRGF0YVZhbHVlID0gc2l6ZVZpc1Zhci5taW5EYXRhVmFsdWU7XG4gICAgICAgICAgICBuZXdTaXplVmlzVmFyLm1heERhdGFWYWx1ZSA9IHNpemVWaXNWYXIubWF4RGF0YVZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChbXCJjb2xvci1zaXplLWFnZVwiXS5pbmRleE9mKHJlbmRlcmVyVHlwZSkgPiAtMSkge1xuICAgICAgICAgICAgLy8ganVzdCBzd2l0Y2ggb3V0IHNpemUgdmFyaWFibGVzXG4gICAgICAgICAgICByZW5kZXJlci52aXN1YWxWYXJpYWJsZXMgPSBnZXRWaXNWYXJzRXhjZXB0KHJlbmRlcmVyLCBcInNpemVcIikgfHwgW107XG4gICAgICAgICAgICByZW5kZXJlci52aXN1YWxWYXJpYWJsZXMgPSBnZXRWaXNWYXJzRXhjZXB0KHJlbmRlcmVyLCBcInNpemVcIiwgXCJvdXRsaW5lXCIpIHx8IFtdO1xuICAgICAgICAgICAgcmVuZGVyZXIuYXV0aG9yaW5nSW5mby52aXN1YWxWYXJpYWJsZXMgPSBnZXRBdXRoVmlzVmFyc0V4Y2VwdChyZW5kZXJlciwgXCJzaXplXCIpIHx8IFtdO1xuICAgICAgICAgICAgY29uc3Qgc2l6ZVZpc1ZhciA9IGdldFZpc1ZhcihyZXN1bHQucmVuZGVyZXIsIFwic2l6ZVwiKTtcbiAgICAgICAgICAgIHJlbmRlcmVyLnZpc3VhbFZhcmlhYmxlcy5wdXNoKHNpemVWaXNWYXIpO1xuICAgICAgICAgICAgY29uc3Qgc2l6ZUF1dGhWaXNWYXIgPSBnZXRBdXRoVmlzVmFyKHJlc3VsdC5yZW5kZXJlciwgXCJzaXplXCIpO1xuICAgICAgICAgICAgcmVuZGVyZXIuYXV0aG9yaW5nSW5mby52aXN1YWxWYXJpYWJsZXMucHVzaChzaXplQXV0aFZpc1Zhcik7XG4gICAgICAgICAgICBjb25zdCBzaXplT3V0bGluZVZpc1ZhciA9IGdldFZpc1ZhcihyZXN1bHQucmVuZGVyZXIsIFwic2l6ZVwiLCBcIm91dGxpbmVcIik7XG4gICAgICAgICAgICBpZiAoc2l6ZU91dGxpbmVWaXNWYXIpIHtcbiAgICAgICAgICAgICAgICByZW5kZXJlci52aXN1YWxWYXJpYWJsZXMucHVzaChzaXplT3V0bGluZVZpc1Zhcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmaXhOb3JtYWxpemF0aW9uRmllbGQocmVuZGVyZXIpO1xuICAgICAgICAgICAgcmVzdWx0LnJlbmRlcmVyID0gcmVuZGVyZXIuY2xvbmUoKTtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzdWx0KTtcbiAgICAgICAgfVxuICAgICAgICBhcHBseUV4dHJhVmlzVmFycyhleHRyYXMsIHJlc3VsdC5yZW5kZXJlcik7XG4gICAgICAgIGlmIChzeW1ib2wgJiYgKChfYSA9IHJlc3VsdC5yZW5kZXJlci5jbGFzc0JyZWFrSW5mb3MpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpKSB7XG4gICAgICAgICAgICByZXN1bHQucmVuZGVyZXIuY2xhc3NCcmVha0luZm9zWzBdLnN5bWJvbCA9IHN5bWJvbDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZGVmYXVsdFN5bWJvbCkge1xuICAgICAgICAgICAgcmVzdWx0LnJlbmRlcmVyLmRlZmF1bHRTeW1ib2wgPSBkZWZhdWx0U3ltYm9sO1xuICAgICAgICAgICAgcmVzdWx0LnJlbmRlcmVyLmRlZmF1bHRMYWJlbCA9IGRlZmF1bHRMYWJlbDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoYmFja2dyb3VuZEZpbGxTeW1ib2wpIHtcbiAgICAgICAgICAgIHJlc3VsdC5yZW5kZXJlci5iYWNrZ3JvdW5kRmlsbFN5bWJvbCA9IGJhY2tncm91bmRGaWxsU3ltYm9sO1xuICAgICAgICB9XG4gICAgICAgIGlmIChpc0ludmVydGVkKSB7XG4gICAgICAgICAgICBjb25zdCBzaXplVmlzVmFyID0gZ2V0VmlzVmFyKHJlc3VsdC5yZW5kZXJlciwgXCJzaXplXCIpO1xuICAgICAgICAgICAgY29uc3QgdG1wID0gc2l6ZVZpc1Zhci5taW5TaXplO1xuICAgICAgICAgICAgc2l6ZVZpc1Zhci5taW5TaXplID0gc2l6ZVZpc1Zhci5tYXhTaXplO1xuICAgICAgICAgICAgc2l6ZVZpc1Zhci5tYXhTaXplID0gdG1wO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzdWx0KTtcbiAgICB9LCAoZXJyb3IpID0+IFByb21pc2UucmVqZWN0KGVycm9yKSk7XG59XG4vKipcbiAqIENyZWF0ZXMgYSBTaXplIHJlbmRlcmVyIHdpdGggc2V0dGluZ3MgZnJvbSBjdXJyZW50IHJlbmRlcmVyXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZUNsYXNzZWRTaXplUmVuZGVyZXJGcm9tRXhpc3Rpbmcob3B0aW9ucykge1xuICAgIHZhciBfYTtcbiAgICBjb25zdCB7IGxheWVyOiBzbUxheWVyLCBtYXBJbWFnZVN1YmxheWVyLCBtYXBWaWV3LCBtb2R1bGVzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICBjb25zdCBsYXllciA9IHNtTGF5ZXI7XG4gICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcik7XG4gICAgY29uc3QgcmVuZGVyZXJUeXBlID0gZ2V0UmVuZGVyZXJUeXBlKCk7XG4gICAgY29uc3QgYXV0aEluZm8gPSByZW5kZXJlci5hdXRob3JpbmdJbmZvO1xuICAgIGNvbnN0IHNpemVWaXNWYXIgPSBnZXRWaXNWYXIocmVuZGVyZXIsIFwic2l6ZVwiKTtcbiAgICBjb25zdCBhdXRoU2l6ZVZpc1ZhciA9IGdldEF1dGhWaXNWYXIocmVuZGVyZXIsIFwic2l6ZVwiKTtcbiAgICBjb25zdCBleHRyYXMgPSBzYXZlRXh0cmFWaXNWYXJzKHJlbmRlcmVyKTtcbiAgICBjb25zdCByZW5kZXJlckZpZWxkSW5mbyA9IHtcbiAgICAgICAgZmllbGQ6IHJlbmRlcmVyLmZpZWxkLFxuICAgICAgICBleHByZXNzaW9uOiByZW5kZXJlci52YWx1ZUV4cHJlc3Npb24sXG4gICAgICAgIGV4cHJlc3Npb25UaXRsZTogcmVuZGVyZXIudmFsdWVFeHByZXNzaW9uVGl0bGUsXG4gICAgICAgIHNpbXBsZUZpZWxkVHlwZTogc2ltcGxlRmllbGRUeXBlcy5OVU1CRVJcbiAgICB9O1xuICAgIGxldCBmaWVsZEluZm8gPSBvcHRpb25zLmZpZWxkSW5mb3NcbiAgICAgICAgPyBvcHRpb25zLmZpZWxkSW5mb3NbMF1cbiAgICAgICAgOiBzaXplVmlzVmFyXG4gICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICBmaWVsZDogc2l6ZVZpc1Zhci5maWVsZCxcbiAgICAgICAgICAgICAgICBleHByZXNzaW9uOiBzaXplVmlzVmFyLnZhbHVlRXhwcmVzc2lvbixcbiAgICAgICAgICAgICAgICBleHByZXNzaW9uVGl0bGU6IHNpemVWaXNWYXIudmFsdWVFeHByZXNzaW9uVGl0bGUsXG4gICAgICAgICAgICAgICAgc2ltcGxlRmllbGRUeXBlOiBzaW1wbGVGaWVsZFR5cGVzLk5VTUJFUlxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgOiByZW5kZXJlckZpZWxkSW5mbztcbiAgICAvLyBvcHRpb25zLm5vcm1hbGl6YXRpb25GaWVsZCA9IG51bGwgbWVhbnMgZG9uJ3Qgc2V0IHRoZSB2YWx1ZVxuICAgIGNvbnN0IG5vcm1hbGl6YXRpb25GaWVsZCA9IG9wdGlvbnMubm9ybWFsaXphdGlvbkZpZWxkICE9PSB1bmRlZmluZWRcbiAgICAgICAgPyBvcHRpb25zLm5vcm1hbGl6YXRpb25GaWVsZFxuICAgICAgICA6IHNpemVWaXNWYXJcbiAgICAgICAgICAgID8gc2l6ZVZpc1Zhci5ub3JtYWxpemF0aW9uRmllbGRcbiAgICAgICAgICAgIDogcmVuZGVyZXIubm9ybWFsaXphdGlvbkZpZWxkO1xuICAgIGxldCBzeW1ib2w7XG4gICAgaWYgKFtcInR5cGUtc2l6ZVwiXS5pbmRleE9mKHJlbmRlcmVyVHlwZSkgPiAtMSkge1xuICAgICAgICBjb25zdCB1dlJlbmRlcmVyID0gZ2V0UmVuZGVyZXIobGF5ZXIpO1xuICAgICAgICBzeW1ib2wgPVxuICAgICAgICAgICAgdXZSZW5kZXJlci51bmlxdWVWYWx1ZUluZm9zICYmIHV2UmVuZGVyZXIudW5pcXVlVmFsdWVJbmZvcy5sZW5ndGhcbiAgICAgICAgICAgICAgICA/IHV2UmVuZGVyZXIudW5pcXVlVmFsdWVJbmZvc1swXS5zeW1ib2xcbiAgICAgICAgICAgICAgICA6IGdldERlZmF1bHRTeW1ib2wobGF5ZXIsIG1hcFZpZXcsIHJlbmRlcmVyVHlwZSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBzeW1ib2wgPVxuICAgICAgICAgICAgcmVuZGVyZXIuY2xhc3NCcmVha0luZm9zICYmIHJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvcy5sZW5ndGhcbiAgICAgICAgICAgICAgICA/IHJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvc1swXS5zeW1ib2xcbiAgICAgICAgICAgICAgICA6IGdldERlZmF1bHRTeW1ib2wobGF5ZXIsIG1hcFZpZXcsIHJlbmRlcmVyVHlwZSk7XG4gICAgfVxuICAgIGNvbnN0IGRlZmF1bHRTeW1ib2wgPSByZW5kZXJlci5kZWZhdWx0U3ltYm9sO1xuICAgIGNvbnN0IGRlZmF1bHRMYWJlbCA9IHJlbmRlcmVyLmRlZmF1bHRMYWJlbDtcbiAgICBjb25zdCBiYWNrZ3JvdW5kRmlsbFN5bWJvbCA9IHJlbmRlcmVyLmJhY2tncm91bmRGaWxsU3ltYm9sO1xuICAgIGxldCBpc0ludmVydGVkID0gZmFsc2U7XG4gICAgaWYgKHJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvcy5sZW5ndGggPiAxKSB7XG4gICAgICAgIGNvbnN0IGZpcnN0U3ltID0gcmVuZGVyZXIuY2xhc3NCcmVha0luZm9zWzBdLnN5bWJvbDtcbiAgICAgICAgY29uc3Qgc2Vjb25kU3ltID0gcmVuZGVyZXIuY2xhc3NCcmVha0luZm9zWzFdLnN5bWJvbDtcbiAgICAgICAgY29uc3QgZmlyc3RTaXplID0gZ2V0U3ltYm9sU2l6ZShmaXJzdFN5bSkgfHwgMDtcbiAgICAgICAgY29uc3Qgc2Vjb25kU2l6ZSA9IGdldFN5bWJvbFNpemUoc2Vjb25kU3ltKSB8fCAwO1xuICAgICAgICBpc0ludmVydGVkID0gZmlyc3RTaXplID4gc2Vjb25kU2l6ZTtcbiAgICB9XG4gICAgaWYgKCFzaXplVmlzVmFyICYmXG4gICAgICAgIGF1dGhJbmZvICYmXG4gICAgICAgIGlzU2FtZUZpZWxkSW5mbyhmaWVsZEluZm8sIHJlbmRlcmVyRmllbGRJbmZvKSAmJlxuICAgICAgICBub3JtYWxpemF0aW9uRmllbGQgPT09IHJlbmRlcmVyLm5vcm1hbGl6YXRpb25GaWVsZCkge1xuICAgICAgICAvLyBubyBjaGFuZ2VzIHRvIGZpZWxkc1xuICAgICAgICBkZWxldGUgb3B0aW9ucy5maWVsZEluZm9zO1xuICAgICAgICBpZiAoaXNFbXB0eShvcHRpb25zKSkge1xuICAgICAgICAgICAgLy8gbm90aGluZyByZWFsbHkgY2hhbmdlczsgcmVtb3ZlIGNvbG9yIHZpc1ZhciBpZiB0aGVyZSBpcyBvbmVcbiAgICAgICAgICAgIGNvbnN0IG5ld1JlbmRlciA9IHJlbmRlcmVyLmNsb25lKCk7XG4gICAgICAgICAgICBuZXdSZW5kZXIudmlzdWFsVmFyaWFibGVzID0gZ2V0VmlzVmFyc0V4Y2VwdChyZW5kZXJlciwgXCJjb2xvclwiKTtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyByZW5kZXJlcjogbmV3UmVuZGVyIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGNsYXNzaWZpY2F0aW9uTWV0aG9kID0gb3B0aW9ucy5jbGFzc2lmaWNhdGlvbk1ldGhvZFxuICAgICAgICA/IG9wdGlvbnMuY2xhc3NpZmljYXRpb25NZXRob2RcbiAgICAgICAgOiAoYXV0aEluZm8gPT09IG51bGwgfHwgYXV0aEluZm8gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF1dGhJbmZvLmNsYXNzaWZpY2F0aW9uTWV0aG9kKSAmJiBhdXRoSW5mby5jbGFzc2lmaWNhdGlvbk1ldGhvZCAhPT0gXCJtYW51YWxcIlxuICAgICAgICAgICAgPyBhdXRoSW5mby5jbGFzc2lmaWNhdGlvbk1ldGhvZFxuICAgICAgICAgICAgOiBcImVxdWFsLWludGVydmFsXCI7XG4gICAgY29uc3Qgc3RhbmRhcmREZXZpYXRpb25JbnRlcnZhbCA9IGNsYXNzaWZpY2F0aW9uTWV0aG9kID09PSBcInN0YW5kYXJkLWRldmlhdGlvblwiXG4gICAgICAgID8gb3B0aW9ucy5zdGFuZGFyZERldmlhdGlvbkludGVydmFsXG4gICAgICAgICAgICA/IG9wdGlvbnMuc3RhbmRhcmREZXZpYXRpb25JbnRlcnZhbFxuICAgICAgICAgICAgOiBhdXRoSW5mby5zdGFuZGFyZERldmlhdGlvbkludGVydmFsXG4gICAgICAgICAgICAgICAgPyBhdXRoSW5mby5zdGFuZGFyZERldmlhdGlvbkludGVydmFsXG4gICAgICAgICAgICAgICAgOiAxXG4gICAgICAgIDogdW5kZWZpbmVkO1xuICAgIGxldCBrZWVwTnVtQ2xhc3NlcyA9IHRydWU7XG4gICAgaWYgKG9wdGlvbnMuY2xhc3NpZmljYXRpb25NZXRob2QgJiZcbiAgICAgICAgb3B0aW9ucy5jbGFzc2lmaWNhdGlvbk1ldGhvZCAhPT0gKGF1dGhJbmZvID09PSBudWxsIHx8IGF1dGhJbmZvID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhdXRoSW5mby5jbGFzc2lmaWNhdGlvbk1ldGhvZCkgJiZcbiAgICAgICAgKG9wdGlvbnMuY2xhc3NpZmljYXRpb25NZXRob2QgPT09IFwic3RhbmRhcmQtZGV2aWF0aW9uXCIgfHwgKGF1dGhJbmZvID09PSBudWxsIHx8IGF1dGhJbmZvID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhdXRoSW5mby5jbGFzc2lmaWNhdGlvbk1ldGhvZCkgPT09IFwic3RhbmRhcmQtZGV2aWF0aW9uXCIpKSB7XG4gICAgICAgIGtlZXBOdW1DbGFzc2VzID0gZmFsc2U7XG4gICAgfVxuICAgIGxldCBuZWVkTmV3U3RhdGlzdGljcyA9IGZhbHNlO1xuICAgIGlmIChvcHRpb25zLm5vcm1hbGl6YXRpb25GaWVsZCAhPT0gdW5kZWZpbmVkIHx8XG4gICAgICAgICFpc1NhbWVGaWVsZEluZm8oZmllbGRJbmZvLCByZW5kZXJlckZpZWxkSW5mbykgfHxcbiAgICAgICAgY2xhc3NpZmljYXRpb25NZXRob2QgIT09IFwiZXF1YWwtaW50ZXJ2YWxcIiB8fFxuICAgICAgICAoXG4gICAgICAgIC8vIGlzIGl0IGN1cnJlbnRseSBhIGNvbnRpbnVvdXMgc2l6ZSByZW5kZXJlcj8sIHRoZW4gc3RhcnQgd2l0aCBmdWxsIGRhdGEgcmFuZ2VcbiAgICAgICAgYXV0aFNpemVWaXNWYXIgPT09IG51bGwgfHwgYXV0aFNpemVWaXNWYXIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF1dGhTaXplVmlzVmFyLm1pblNsaWRlclZhbHVlKSB8fFxuICAgICAgICAoYXV0aFNpemVWaXNWYXIgPT09IG51bGwgfHwgYXV0aFNpemVWaXNWYXIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF1dGhTaXplVmlzVmFyLm1heFNsaWRlclZhbHVlKSkge1xuICAgICAgICBuZWVkTmV3U3RhdGlzdGljcyA9IHRydWU7XG4gICAgfVxuICAgIGNvbnN0IG1pblZhbHVlID0gaXNEZWZpbmVkKG9wdGlvbnMubWluKVxuICAgICAgICA/IG9wdGlvbnMubWluXG4gICAgICAgIDogbmVlZE5ld1N0YXRpc3RpY3NcbiAgICAgICAgICAgID8gdW5kZWZpbmVkXG4gICAgICAgICAgICA6IGF1dGhTaXplVmlzVmFyXG4gICAgICAgICAgICAgICAgPyBhdXRoU2l6ZVZpc1Zhci5taW5TbGlkZXJWYWx1ZVxuICAgICAgICAgICAgICAgIDogcmVuZGVyZXIuY2xhc3NCcmVha0luZm9zWzBdLm1pblZhbHVlO1xuICAgIGNvbnN0IG1heFZhbHVlID0gaXNEZWZpbmVkKG9wdGlvbnMubWF4KVxuICAgICAgICA/IG9wdGlvbnMubWF4XG4gICAgICAgIDogbmVlZE5ld1N0YXRpc3RpY3NcbiAgICAgICAgICAgID8gdW5kZWZpbmVkXG4gICAgICAgICAgICA6IGF1dGhTaXplVmlzVmFyXG4gICAgICAgICAgICAgICAgPyBhdXRoU2l6ZVZpc1Zhci5tYXhTbGlkZXJWYWx1ZVxuICAgICAgICAgICAgICAgIDogcmVuZGVyZXIuY2xhc3NCcmVha0luZm9zW3JlbmRlcmVyLmNsYXNzQnJlYWtJbmZvcy5sZW5ndGggLSAxXS5tYXhWYWx1ZTtcbiAgICByZXR1cm4gbW9kdWxlcy5TaXplQ3JlYXRvci5jcmVhdGVDbGFzc0JyZWFrc1JlbmRlcmVyKHtcbiAgICAgICAgbGF5ZXIsXG4gICAgICAgIHZpZXc6IG1hcFZpZXcsXG4gICAgICAgIC8vdGhlbWU6IG9wdGlvbnMudGhlbWUgPyBvcHRpb25zLnRoZW1lIDogYXV0aFNpemVWaXNWYXIudGhlbWUsXG4gICAgICAgIGZpZWxkOiBmaWVsZEluZm8uZmllbGQsXG4gICAgICAgIHZhbHVlRXhwcmVzc2lvbjogZmllbGRJbmZvLmV4cHJlc3Npb24sXG4gICAgICAgIHZhbHVlRXhwcmVzc2lvblRpdGxlOiBmaWVsZEluZm8uZXhwcmVzc2lvblRpdGxlLFxuICAgICAgICBub3JtYWxpemF0aW9uRmllbGQsXG4gICAgICAgIGNsYXNzaWZpY2F0aW9uTWV0aG9kLFxuICAgICAgICBzdGFuZGFyZERldmlhdGlvbkludGVydmFsLFxuICAgICAgICBudW1DbGFzc2VzOiBpc0RlZmluZWQob3B0aW9ucy5udW1DbGFzc2VzKVxuICAgICAgICAgICAgPyBvcHRpb25zLm51bUNsYXNzZXNcbiAgICAgICAgICAgIDogc2l6ZVZpc1ZhciB8fCAha2VlcE51bUNsYXNzZXNcbiAgICAgICAgICAgICAgICA/IDRcbiAgICAgICAgICAgICAgICA6IHJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvcy5sZW5ndGgsXG4gICAgICAgIG1pblZhbHVlLFxuICAgICAgICBtYXhWYWx1ZSxcbiAgICAgICAgb3V0bGluZU9wdGltaXphdGlvbkVuYWJsZWQ6IG1hcEltYWdlU3VibGF5ZXJcbiAgICAgICAgICAgID8gZmFsc2VcbiAgICAgICAgICAgIDogaXNEZWZpbmVkKG9wdGlvbnMub3V0bGluZU9wdGltaXphdGlvbkVuYWJsZWQpXG4gICAgICAgICAgICAgICAgPyBvcHRpb25zLm91dGxpbmVPcHRpbWl6YXRpb25FbmFibGVkXG4gICAgICAgICAgICAgICAgOiAhIWV4dHJhcy5zaXplT3V0bGluZVZpc1ZhcixcbiAgICAgICAgbGVnZW5kT3B0aW9uczogb3B0aW9ucy5sZWdlbmRPcHRpb25zIHx8IHJlbmRlcmVyLmxlZ2VuZE9wdGlvbnMsXG4gICAgICAgIGRlZmF1bHRTeW1ib2xFbmFibGVkOiBpc0RlZmluZWQob3B0aW9ucy5kZWZhdWx0U3ltYm9sRW5hYmxlZClcbiAgICAgICAgICAgID8gb3B0aW9ucy5kZWZhdWx0U3ltYm9sRW5hYmxlZFxuICAgICAgICAgICAgOiAhIXJlbmRlcmVyLmRlZmF1bHRTeW1ib2wsXG4gICAgICAgIGZvckJpbm5pbmc6ICgoX2EgPSBsYXllci5mZWF0dXJlUmVkdWN0aW9uKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EudHlwZSkgPT09IFwiYmlubmluZ1wiXG4gICAgfSkudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgIC8vY29uc29sZS5sb2coXCJjcmVhdGVDbGFzc0JyZWFrc1JlbmRlcmVyXCIsIHJlc3VsdC5yZW5kZXJlci50b0pTT04oKSk7XG4gICAgICAgIGFwcGx5RXh0cmFWaXNWYXJzKGV4dHJhcywgcmVzdWx0LnJlbmRlcmVyKTtcbiAgICAgICAgaWYgKHN5bWJvbCAmJiByZXN1bHQucmVuZGVyZXIuY2xhc3NCcmVha0luZm9zKSB7XG4gICAgICAgICAgICByZXN1bHQucmVuZGVyZXIuY2xhc3NCcmVha0luZm9zLm1hcCgoY2xhc3NCcmVha0luZm8pID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBzeW0gPSBzeW1ib2wuY2xvbmUoKTtcbiAgICAgICAgICAgICAgICBhcHBseVN5bWJvbFNpemUoc3ltLCBnZXRTeW1ib2xTaXplKGNsYXNzQnJlYWtJbmZvLnN5bWJvbCkpO1xuICAgICAgICAgICAgICAgIGNsYXNzQnJlYWtJbmZvLnN5bWJvbCA9IHN5bTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChkZWZhdWx0U3ltYm9sKSB7XG4gICAgICAgICAgICByZXN1bHQucmVuZGVyZXIuZGVmYXVsdFN5bWJvbCA9IGRlZmF1bHRTeW1ib2w7XG4gICAgICAgICAgICByZXN1bHQucmVuZGVyZXIuZGVmYXVsdExhYmVsID0gZGVmYXVsdExhYmVsO1xuICAgICAgICB9XG4gICAgICAgIGlmIChiYWNrZ3JvdW5kRmlsbFN5bWJvbCkge1xuICAgICAgICAgICAgcmVzdWx0LnJlbmRlcmVyLmJhY2tncm91bmRGaWxsU3ltYm9sID0gYmFja2dyb3VuZEZpbGxTeW1ib2w7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGlzSW52ZXJ0ZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHNpemVWaXNWYXIgPSBnZXRWaXNWYXIocmVzdWx0LnJlbmRlcmVyLCBcInNpemVcIik7XG4gICAgICAgICAgICBjb25zdCB0bXAgPSBzaXplVmlzVmFyLm1pblNpemU7XG4gICAgICAgICAgICBzaXplVmlzVmFyLm1pblNpemUgPSBzaXplVmlzVmFyLm1heFNpemU7XG4gICAgICAgICAgICBzaXplVmlzVmFyLm1heFNpemUgPSB0bXA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXN1bHQpO1xuICAgIH0sIChlcnJvcikgPT4gUHJvbWlzZS5yZWplY3QoZXJyb3IpKTtcbn1cbmZ1bmN0aW9uIHNhbWVTaXplRmllbGQob3B0aW9ucykge1xuICAgIHZhciBfYTtcbiAgICAvLyBub3QgY2hlY2tpbmcgZm9yIG5vcm1hbGl6YXRpb25GaWVsZFxuICAgIC8vIHdlIGtlZXAgaXQgaWYgdGhlIHJlbmRlcmVyIGhhcyBpdCBhbmQgaXQgZG9lcyBub3QgZ2V0IG92ZXJ3cml0dGVuXG4gICAgY29uc3QgeyBsYXllciB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcikuY2xvbmUoKTtcbiAgICBjb25zdCByZW5kZXJlclR5cGUgPSBnZXRSZW5kZXJlclR5cGUoKTtcbiAgICBpZiAoW1xuICAgICAgICBcInNpemVcIixcbiAgICAgICAgXCJzaXplLWFnZVwiLFxuICAgICAgICBcImNvbG9yLXNpemVcIixcbiAgICAgICAgXCJjb2xvci1zaXplLWFnZVwiLFxuICAgICAgICBcImNvbG9yLWFnZS1zaXplXCIsXG4gICAgICAgIFwidHlwZS1zaXplXCIsXG4gICAgICAgIFwidHlwZS1zaXplLWFnZVwiLFxuICAgICAgICBcInJlbGF0aW9uc2hpcC1zaXplXCJcbiAgICBdLmluZGV4T2YocmVuZGVyZXJUeXBlKSA+IC0xICYmXG4gICAgICAgIG9wdGlvbnMubm9ybWFsaXphdGlvbkZpZWxkID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgbGV0IHJlbmRlckZpZWxkSW5mbztcbiAgICAgICAgY29uc3Qgc2l6ZVZpc1ZhciA9IGdldFZpc1ZhcihyZW5kZXJlciwgXCJzaXplXCIpO1xuICAgICAgICBpZiAoc2l6ZVZpc1Zhcikge1xuICAgICAgICAgICAgLy8gY29udGludW91c1xuICAgICAgICAgICAgaWYgKFtcInNpemUtYWdlXCIsIFwiY29sb3Itc2l6ZS1hZ2VcIiwgXCJ0eXBlLXNpemUtYWdlXCJdLmluZGV4T2YocmVuZGVyZXJUeXBlKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgYXV0aFNpemVWaXNWYXIgPSBnZXRBdXRoVmlzVmFyKHJlbmRlcmVyLCBcInNpemVcIik7XG4gICAgICAgICAgICAgICAgcmVuZGVyRmllbGRJbmZvID0ge1xuICAgICAgICAgICAgICAgICAgICBmaWVsZDogYXV0aFNpemVWaXNWYXIuZmllbGRcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVuZGVyRmllbGRJbmZvID0ge1xuICAgICAgICAgICAgICAgICAgICBmaWVsZDogc2l6ZVZpc1Zhci5maWVsZCxcbiAgICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbjogc2l6ZVZpc1Zhci52YWx1ZUV4cHJlc3Npb24sXG4gICAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb25UaXRsZTogc2l6ZVZpc1Zhci52YWx1ZUV4cHJlc3Npb25UaXRsZVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAvLyBjbGFzc2VkXG4gICAgICAgICAgICByZW5kZXJGaWVsZEluZm8gPSB7XG4gICAgICAgICAgICAgICAgZmllbGQ6IHJlbmRlcmVyLmZpZWxkLFxuICAgICAgICAgICAgICAgIGV4cHJlc3Npb246IHJlbmRlcmVyLnZhbHVlRXhwcmVzc2lvbixcbiAgICAgICAgICAgICAgICBleHByZXNzaW9uVGl0bGU6IHJlbmRlcmVyLnZhbHVlRXhwcmVzc2lvblRpdGxlXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIGlmIChpc1NhbWVGaWVsZEluZm8oKF9hID0gb3B0aW9ucy5maWVsZEluZm9zKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2FbMF0sIHJlbmRlckZpZWxkSW5mbykpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn1cbmZ1bmN0aW9uIGdldFNpemVTbGlkZXJTdG9wcygpIHtcbiAgICBjb25zdCB7IGxheWVyLCBtYXBWaWV3LCBtb2R1bGVzIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICBjb25zdCByZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKTtcbiAgICBjb25zdCBzaXplVmlzVmFyID0gZ2V0VmlzVmFyKHJlbmRlcmVyLCBcInNpemVcIik7XG4gICAgY29uc3Qgc2NhbGUgPSBtYXBWaWV3LnNjYWxlO1xuICAgIGNvbnN0IHsgbWluU2l6ZSwgbWF4U2l6ZSwgbWluRGF0YVZhbHVlLCBtYXhEYXRhVmFsdWUgfSA9IHNpemVWaXNWYXI7XG4gICAgbGV0IHN0b3BzO1xuICAgIGlmIChzaXplVmlzVmFyLnN0b3BzKSB7XG4gICAgICAgIHN0b3BzID0gbW9kdWxlcy5lc3JpTGFuZy5jbG9uZShzaXplVmlzVmFyLnN0b3BzKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGxldCBtaW4sIG1heDtcbiAgICAgICAgaWYgKHR5cGVvZiBtaW5TaXplID09PSBcIm51bWJlclwiKSB7XG4gICAgICAgICAgICBtaW4gPSBtaW5TaXplO1xuICAgICAgICAgICAgbWF4ID0gbWF4U2l6ZTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IGxhc3RJZHggPSBtaW5TaXplLnN0b3BzLmxlbmd0aCAtIDE7XG4gICAgICAgICAgICBpZiAoc2NhbGUgPiBtaW5TaXplLnN0b3BzW2xhc3RJZHhdLnZhbHVlKSB7XG4gICAgICAgICAgICAgICAgbWluID0gbWluU2l6ZS5zdG9wc1tsYXN0SWR4XS5zaXplO1xuICAgICAgICAgICAgICAgIG1heCA9IG1heFNpemUuc3RvcHNbbGFzdElkeF0uc2l6ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIG1pblNpemUuc3RvcHMuZm9yRWFjaCgoc3RvcCwgaWR4KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzY2FsZSA8PSBzdG9wLnZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtaW4gPSBzdG9wLnNpemU7XG4gICAgICAgICAgICAgICAgICAgICAgICBtYXggPSBtYXhTaXplLnN0b3BzW2lkeF0uc2l6ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHN0b3BzID0gW1xuICAgICAgICAgICAgbmV3IG1vZHVsZXMuU2l6ZVN0b3AoeyB2YWx1ZTogbWluRGF0YVZhbHVlLCBzaXplOiBtaW4gfSksXG4gICAgICAgICAgICBuZXcgbW9kdWxlcy5TaXplU3RvcCh7IHZhbHVlOiBtYXhEYXRhVmFsdWUsIHNpemU6IG1heCB9KVxuICAgICAgICBdO1xuICAgIH1cbiAgICByZXR1cm4gc3RvcHM7XG59XG5mdW5jdGlvbiBnZXRDbGFzc0JyZWFrc1NpemVzKCkge1xuICAgIGNvbnN0IHsgbGF5ZXIgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgIGNvbnN0IHJlbmRlcmVyID0gZ2V0UmVuZGVyZXIobGF5ZXIpO1xuICAgIHJldHVybiByZW5kZXJlci5jbGFzc0JyZWFrSW5mb3MubWFwKChjbGFzc0JyZWFrSW5mbykgPT4ge1xuICAgICAgICBjb25zdCBzeW0gPSBjbGFzc0JyZWFrSW5mby5zeW1ib2w7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBtaW46IGNsYXNzQnJlYWtJbmZvLm1pblZhbHVlLFxuICAgICAgICAgICAgbWF4OiBjbGFzc0JyZWFrSW5mby5tYXhWYWx1ZSxcbiAgICAgICAgICAgIHNpemU6IGdldFN5bWJvbFNpemUoc3ltKVxuICAgICAgICB9O1xuICAgIH0pO1xufVxuXG4vKipcbiAqIFVwZGF0ZXMgdGhlIGxheWVyIHdpdGggYSBDb2xvcitzaXplIHJlbmRlcmVyIHdpdGggZGVmYXVsdCBzZXR0aW5nc1xuICogQHBhcmFtIG9wdGlvbnM6IG9wdGlvbnNcbiAqL1xuZnVuY3Rpb24gY3JlYXRlQ29sb3JTaXplUmVuZGVyZXIob3B0aW9ucykge1xuICAgIGNvbnN0IHsgbGF5ZXIgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgIGNvbnN0IHJlbmRlcmVyID0gZ2V0UmVuZGVyZXIobGF5ZXIpO1xuICAgIGNvbnN0IGF1dGhJbmZvID0gcmVuZGVyZXIuYXV0aG9yaW5nSW5mbztcbiAgICBjb25zdCByZW5kZXJlclR5cGUgPSBnZXRSZW5kZXJlclR5cGUoKTtcbiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcbiAgICAvLyBmaXJzdCBzaXplIHJlbmRlcmVyLCBzbyB3ZSBoYXZlIHRoZSBjb3JyZWN0IHN5bWJvbCB0eXBlc1xuICAgIGNvbnN0IHNlY29uZEZpZWxkID0gb3B0aW9ucy5maWVsZEluZm9zLmxlbmd0aCA+IDEgPyBvcHRpb25zLmZpZWxkSW5mb3NbMV0gOiBvcHRpb25zLmZpZWxkSW5mb3NbMF07XG4gICAgaWYgKHNhbWVTaXplRmllbGQoeyBmaWVsZEluZm9zOiBbc2Vjb25kRmllbGRdIH0pICYmXG4gICAgICAgIFtcImNvbG9yLXNpemVcIiwgXCJjb2xvci1hZ2Utc2l6ZVwiLCBcInR5cGUtc2l6ZVwiXS5pbmRleE9mKHJlbmRlcmVyVHlwZSkgPiAtMSAmJlxuICAgICAgICBhdXRoSW5mbyAmJlxuICAgICAgICAoYXV0aEluZm8gPT09IG51bGwgfHwgYXV0aEluZm8gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF1dGhJbmZvLnVuaXZhcmlhdGVUaGVtZSkgIT09IFwiYWJvdmUtYW5kLWJlbG93XCIpIHtcbiAgICAgICAgY29uc3Qgc2l6ZVZpc1ZhciA9IGdldFZpc1ZhcihnZXRSZW5kZXJlcihsYXllciksIFwic2l6ZVwiKTtcbiAgICAgICAgaWYgKHNpemVWaXNWYXIpIHtcbiAgICAgICAgICAgIC8vIHJlLXVzZSBzaXplIHJlbmRlcmVyXG4gICAgICAgICAgICByZXR1cm4gY3JlYXRlQ29sb3JQYXJ0Rm9yUmVuZGVyZXIoZ2V0UmVuZGVyZXIobGF5ZXIpLCBvcHRpb25zKS50aGVuKChyZW5kZXJlclJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVuZGVyZXJSZXN1bHQpO1xuICAgICAgICAgICAgfSwgKGVycm9yKSA9PiBQcm9taXNlLnJlamVjdChlcnJvcikpO1xuICAgICAgICB9IC8vIGVsc2UgY2xhc3NlZFxuICAgIH1cbiAgICByZXR1cm4gY3JlYXRlU2l6ZVJlbmRlcmVyKE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucyksIHsgZmllbGRJbmZvczogW3NlY29uZEZpZWxkXSB9KSkudGhlbigoc2l6ZVJlbmRlcmVyUmVzdWx0KSA9PiB7XG4gICAgICAgIHJldHVybiBjcmVhdGVDb2xvclBhcnRGb3JSZW5kZXJlcihzaXplUmVuZGVyZXJSZXN1bHQucmVuZGVyZXIsIG9wdGlvbnMpLnRoZW4oKHJlbmRlcmVyUmVzdWx0KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlbmRlcmVyUmVzdWx0KTtcbiAgICAgICAgfSwgKGVycm9yKSA9PiBQcm9taXNlLnJlamVjdChlcnJvcikpO1xuICAgIH0sIChlcnJvcikgPT4gUHJvbWlzZS5yZWplY3QoZXJyb3IpKTtcbn1cbi8qKlxuICogVXBkYXRlcyB0aGUgbGF5ZXIgd2l0aCBhIENvbG9yK3NpemUgcmVuZGVyZXIgd2l0aCBkZWZhdWx0IHNldHRpbmdzXG4gKiBAcGFyYW0gb3B0aW9uczogb3B0aW9uc1xuICovXG5mdW5jdGlvbiBjcmVhdGVDb2xvckFnZVNpemVSZW5kZXJlcihvcHRpb25zKSB7XG4gICAgY29uc3QgeyBsYXllciB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcik7XG4gICAgY29uc3QgYXV0aEluZm8gPSByZW5kZXJlci5hdXRob3JpbmdJbmZvO1xuICAgIGNvbnN0IHJlbmRlcmVyVHlwZSA9IGdldFJlbmRlcmVyVHlwZSgpO1xuICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuICAgIC8vIGZpcnN0IHNpemUgcmVuZGVyZXIsIHNvIHdlIGhhdmUgdGhlIGNvcnJlY3Qgc3ltYm9sIHR5cGVzXG4gICAgY29uc3Qgc2Vjb25kRmllbGQgPSBvcHRpb25zLmZpZWxkSW5mb3MubGVuZ3RoID4gMSA/IG9wdGlvbnMuZmllbGRJbmZvc1sxXSA6IG9wdGlvbnMuZmllbGRJbmZvc1swXTtcbiAgICBpZiAoc2FtZVNpemVGaWVsZCh7IGZpZWxkSW5mb3M6IFtzZWNvbmRGaWVsZF0gfSkgJiZcbiAgICAgICAgW1wiY29sb3Itc2l6ZVwiLCBcImNvbG9yLWFnZS1zaXplXCIsIFwidHlwZS1zaXplXCJdLmluZGV4T2YocmVuZGVyZXJUeXBlKSA+IC0xICYmXG4gICAgICAgIGF1dGhJbmZvICYmXG4gICAgICAgIChhdXRoSW5mbyA9PT0gbnVsbCB8fCBhdXRoSW5mbyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXV0aEluZm8udW5pdmFyaWF0ZVRoZW1lKSAhPT0gXCJhYm92ZS1hbmQtYmVsb3dcIikge1xuICAgICAgICBjb25zdCBzaXplVmlzVmFyID0gZ2V0VmlzVmFyKGdldFJlbmRlcmVyKGxheWVyKSwgXCJzaXplXCIpO1xuICAgICAgICBpZiAoc2l6ZVZpc1Zhcikge1xuICAgICAgICAgICAgLy8gcmUtdXNlIHNpemUgcmVuZGVyZXJcbiAgICAgICAgICAgIHJldHVybiBjcmVhdGVDb2xvckFnZVBhcnRGb3JSZW5kZXJlcihnZXRSZW5kZXJlcihsYXllciksIG9wdGlvbnMpLnRoZW4oKHJlbmRlcmVyUmVzdWx0KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZW5kZXJlclJlc3VsdCk7XG4gICAgICAgICAgICB9LCAoZXJyb3IpID0+IFByb21pc2UucmVqZWN0KGVycm9yKSk7XG4gICAgICAgIH0gLy8gZWxzZSBjbGFzc2VkXG4gICAgfVxuICAgIHJldHVybiBjcmVhdGVTaXplUmVuZGVyZXIoT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zKSwgeyBmaWVsZEluZm9zOiBbc2Vjb25kRmllbGRdIH0pKS50aGVuKChzaXplUmVuZGVyZXJSZXN1bHQpID0+IHtcbiAgICAgICAgcmV0dXJuIGNyZWF0ZUNvbG9yQWdlUGFydEZvclJlbmRlcmVyKHNpemVSZW5kZXJlclJlc3VsdC5yZW5kZXJlciwgb3B0aW9ucykudGhlbigocmVuZGVyZXJSZXN1bHQpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVuZGVyZXJSZXN1bHQpO1xuICAgICAgICB9LCAoZXJyb3IpID0+IFByb21pc2UucmVqZWN0KGVycm9yKSk7XG4gICAgfSwgKGVycm9yKSA9PiBQcm9taXNlLnJlamVjdChlcnJvcikpO1xufVxuLyoqXG4gKiBVcGRhdGVzIHRoZSBsYXllciB3aXRoIGEgQ29sb3Irc2l6ZSByZW5kZXJlciB3aXRoIGRlZmF1bHQgc2V0dGluZ3NcbiAqIEBwYXJhbSBvcHRpb25zOiBvcHRpb25zXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZUNvbG9yU2l6ZUFnZVJlbmRlcmVyKG9wdGlvbnMpIHtcbiAgICBjb25zdCB7IGxheWVyIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICBjb25zdCByZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKTtcbiAgICBjb25zdCBhdXRoSW5mbyA9IHJlbmRlcmVyLmF1dGhvcmluZ0luZm87XG4gICAgY29uc3QgcmVuZGVyZXJUeXBlID0gZ2V0UmVuZGVyZXJUeXBlKCk7XG4gICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgLy8gZmlyc3Qgc2l6ZSByZW5kZXJlciwgc28gd2UgaGF2ZSB0aGUgY29ycmVjdCBzeW1ib2wgdHlwZXNcbiAgICBjb25zdCBzZWNvbmRGaWVsZCA9IG9wdGlvbnMuZmllbGRJbmZvcy5sZW5ndGggPiAxID8gb3B0aW9ucy5maWVsZEluZm9zWzFdIDogb3B0aW9ucy5maWVsZEluZm9zWzBdO1xuICAgIGlmIChzYW1lU2l6ZUZpZWxkKHsgZmllbGRJbmZvczogW3NlY29uZEZpZWxkXSB9KSAmJlxuICAgICAgICBbXCJjb2xvci1zaXplLWFnZVwiLCBcInR5cGUtc2l6ZS1hZ2VcIl0uaW5kZXhPZihyZW5kZXJlclR5cGUpID4gLTEgJiZcbiAgICAgICAgYXV0aEluZm8gJiZcbiAgICAgICAgKGF1dGhJbmZvID09PSBudWxsIHx8IGF1dGhJbmZvID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhdXRoSW5mby51bml2YXJpYXRlVGhlbWUpICE9PSBcImFib3ZlLWFuZC1iZWxvd1wiKSB7XG4gICAgICAgIGNvbnN0IHNpemVWaXNWYXIgPSBnZXRWaXNWYXIoZ2V0UmVuZGVyZXIobGF5ZXIpLCBcInNpemVcIik7XG4gICAgICAgIGlmIChzaXplVmlzVmFyKSB7XG4gICAgICAgICAgICAvLyByZS11c2Ugc2l6ZSByZW5kZXJlclxuICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUNvbG9yUGFydEZvclJlbmRlcmVyKGdldFJlbmRlcmVyKGxheWVyKSwgb3B0aW9ucykudGhlbigocmVuZGVyZXJSZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlbmRlcmVyUmVzdWx0KTtcbiAgICAgICAgICAgIH0sIChlcnJvcikgPT4gUHJvbWlzZS5yZWplY3QoZXJyb3IpKTtcbiAgICAgICAgfSAvLyBlbHNlIGNsYXNzZWRcbiAgICB9XG4gICAgcmV0dXJuIGNyZWF0ZVNpemVBZ2VSZW5kZXJlcihPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMpLCB7IGZpZWxkSW5mb3M6IFtzZWNvbmRGaWVsZF0gfSkpLnRoZW4oKHNpemVSZW5kZXJlclJlc3VsdCkgPT4ge1xuICAgICAgICByZXR1cm4gY3JlYXRlQ29sb3JQYXJ0Rm9yUmVuZGVyZXIoc2l6ZVJlbmRlcmVyUmVzdWx0LnJlbmRlcmVyLCBvcHRpb25zKS50aGVuKChyZW5kZXJlclJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZW5kZXJlclJlc3VsdCk7XG4gICAgICAgIH0sIChlcnJvcikgPT4gUHJvbWlzZS5yZWplY3QoZXJyb3IpKTtcbiAgICB9LCAoZXJyb3IpID0+IFByb21pc2UucmVqZWN0KGVycm9yKSk7XG59XG4vKipcbiAqIENyZWF0ZXMgYSBDb2xvciZTaXplIHJlbmRlcmVyIHdpdGggc2V0dGluZ3MgZnJvbSBjdXJyZW50IHJlbmRlcmVyXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZUNvbG9yU2l6ZVJlbmRlcmVyRnJvbUV4aXN0aW5nKG9wdGlvbnMsIHJlbmRlcmVyU3VidHlwZSkge1xuICAgIGNvbnN0IHsgbGF5ZXIgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuICAgIC8vIGZpcnN0IHNpemUgcmVuZGVyZXIsIHNvIHdlIGhhdmUgdGhlIGNvcnJlY3Qgc3ltYm9sIHR5cGVzXG4gICAgcmV0dXJuIGNyZWF0ZVNpemVSZW5kZXJlckZyb21FeGlzdGluZyhPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMpLCB7IGZpZWxkSW5mb3M6IG9wdGlvbnMuZmllbGRJbmZvc1xuICAgICAgICAgICAgPyBvcHRpb25zLmZpZWxkSW5mb3MubGVuZ3RoID4gMVxuICAgICAgICAgICAgICAgID8gW29wdGlvbnMuZmllbGRJbmZvc1sxXV1cbiAgICAgICAgICAgICAgICA6IFtvcHRpb25zLmZpZWxkSW5mb3NbMF1dXG4gICAgICAgICAgICA6IG51bGwgfSkpLnRoZW4oKHNpemVSZW5kZXJlclJlc3VsdCkgPT4ge1xuICAgICAgICByZXR1cm4gY3JlYXRlQ29sb3JSZW5kZXJlckZyb21FeGlzdGluZyhPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMpLCB7IGZpZWxkSW5mb3M6IG9wdGlvbnMuZmllbGRJbmZvcyA/IFtvcHRpb25zLmZpZWxkSW5mb3NbMF1dIDogbnVsbCB9KSkudGhlbigoY29sb3JSZW5kZXJlclJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgY29weVNpemVUb0NvbG9yUmVuZGVyZXIoY29sb3JSZW5kZXJlclJlc3VsdC5yZW5kZXJlciwgc2l6ZVJlbmRlcmVyUmVzdWx0LnJlbmRlcmVyKTtcbiAgICAgICAgICAgIGNvbG9yUmVuZGVyZXJSZXN1bHQuYmFja2dyb3VuZEZpbGxTeW1ib2wgPSBnZXRSZW5kZXJlcihsYXllcikuYmFja2dyb3VuZEZpbGxTeW1ib2w7XG4gICAgICAgICAgICAvLyBoYW5kbGUgc2l0dWF0aW9ucyB3aGVyZSByZW5kZXJlciByZWNyZWF0aW9uIG9jY3VycyBmcm9tIHRoZSBzaXplIHBhbmVsLiBTbGlkZXIgc3RhdGlzdGljcyBtdXN0IGNvcnJlc3BvbmQgdG8gdGhlIHNpemUgdmFyaWFibGUuXG4gICAgICAgICAgICBpZiAocmVuZGVyZXJTdWJ0eXBlID09PSBcInNpemVcIikge1xuICAgICAgICAgICAgICAgIGNvbG9yUmVuZGVyZXJSZXN1bHQuc3RhdGlzdGljcyA9IHNpemVSZW5kZXJlclJlc3VsdC5zdGF0aXN0aWNzO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShjb2xvclJlbmRlcmVyUmVzdWx0KTtcbiAgICAgICAgfSwgKGVycm9yKSA9PiBQcm9taXNlLnJlamVjdChlcnJvcikpO1xuICAgIH0sIChlcnJvcikgPT4gUHJvbWlzZS5yZWplY3QoZXJyb3IpKTtcbn1cbi8qKlxuICogQ3JlYXRlcyBhIENvbG9yQWdlJlNpemUgcmVuZGVyZXIgd2l0aCBzZXR0aW5ncyBmcm9tIGN1cnJlbnQgcmVuZGVyZXJcbiAqL1xuZnVuY3Rpb24gY3JlYXRlQ29sb3JBZ2VTaXplUmVuZGVyZXJGcm9tRXhpc3Rpbmcob3B0aW9ucywgcmVuZGVyZXJTdWJ0eXBlKSB7XG4gICAgY29uc3QgeyBsYXllciB9ID0gc21hcnRNYXBwaW5nU3RhdGU7XG4gICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgLy8gZmlyc3Qgc2l6ZSByZW5kZXJlciwgc28gd2UgaGF2ZSB0aGUgY29ycmVjdCBzeW1ib2wgdHlwZXNcbiAgICByZXR1cm4gY3JlYXRlU2l6ZVJlbmRlcmVyRnJvbUV4aXN0aW5nKE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucyksIHsgZmllbGRJbmZvczogb3B0aW9ucy5maWVsZEluZm9zXG4gICAgICAgICAgICA/IG9wdGlvbnMuZmllbGRJbmZvcy5sZW5ndGggPiAxXG4gICAgICAgICAgICAgICAgPyBbb3B0aW9ucy5maWVsZEluZm9zWzFdXVxuICAgICAgICAgICAgICAgIDogW29wdGlvbnMuZmllbGRJbmZvc1swXV1cbiAgICAgICAgICAgIDogbnVsbCB9KSkudGhlbigoc2l6ZVJlbmRlcmVyUmVzdWx0KSA9PiB7XG4gICAgICAgIHJldHVybiBjcmVhdGVDb2xvckFnZVJlbmRlcmVyRnJvbUV4aXN0aW5nKE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucyksIHsgZmllbGRJbmZvczogb3B0aW9ucy5maWVsZEluZm9zID8gW29wdGlvbnMuZmllbGRJbmZvc1swXV0gOiBudWxsIH0pKS50aGVuKChjb2xvclJlbmRlcmVyUmVzdWx0KSA9PiB7XG4gICAgICAgICAgICBjb3B5U2l6ZVRvQ29sb3JSZW5kZXJlcihjb2xvclJlbmRlcmVyUmVzdWx0LnJlbmRlcmVyLCBzaXplUmVuZGVyZXJSZXN1bHQucmVuZGVyZXIpO1xuICAgICAgICAgICAgY29sb3JSZW5kZXJlclJlc3VsdC5iYWNrZ3JvdW5kRmlsbFN5bWJvbCA9IGdldFJlbmRlcmVyKGxheWVyKS5iYWNrZ3JvdW5kRmlsbFN5bWJvbDtcbiAgICAgICAgICAgIC8vIGhhbmRsZSBzaXR1YXRpb25zIHdoZXJlIHJlbmRlcmVyIHJlY3JlYXRpb24gb2NjdXJzIGZyb20gdGhlIHNpemUgcGFuZWwuIFNsaWRlciBzdGF0aXN0aWNzIG11c3QgY29ycmVzcG9uZCB0byB0aGUgc2l6ZSB2YXJpYWJsZS5cbiAgICAgICAgICAgIGlmIChyZW5kZXJlclN1YnR5cGUgPT09IFwic2l6ZVwiKSB7XG4gICAgICAgICAgICAgICAgY29sb3JSZW5kZXJlclJlc3VsdC5zdGF0aXN0aWNzID0gc2l6ZVJlbmRlcmVyUmVzdWx0LnN0YXRpc3RpY3M7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGNvbG9yUmVuZGVyZXJSZXN1bHQpO1xuICAgICAgICB9LCAoZXJyb3IpID0+IFByb21pc2UucmVqZWN0KGVycm9yKSk7XG4gICAgfSwgKGVycm9yKSA9PiBQcm9taXNlLnJlamVjdChlcnJvcikpO1xufVxuLyoqXG4gKiBDcmVhdGVzIGEgQ29sb3ImU2l6ZUFnZSByZW5kZXJlciB3aXRoIHNldHRpbmdzIGZyb20gY3VycmVudCByZW5kZXJlclxuICovXG5mdW5jdGlvbiBjcmVhdGVDb2xvclNpemVBZ2VSZW5kZXJlckZyb21FeGlzdGluZyhvcHRpb25zLCByZW5kZXJlclN1YnR5cGUpIHtcbiAgICBjb25zdCB7IGxheWVyIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcbiAgICAvLyBmaXJzdCBzaXplIHJlbmRlcmVyLCBzbyB3ZSBoYXZlIHRoZSBjb3JyZWN0IHN5bWJvbCB0eXBlc1xuICAgIHJldHVybiBjcmVhdGVTaXplQWdlUmVuZGVyZXJGcm9tRXhpc3RpbmcoT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zKSwgeyBmaWVsZEluZm9zOiBvcHRpb25zLmZpZWxkSW5mb3NcbiAgICAgICAgICAgID8gb3B0aW9ucy5maWVsZEluZm9zLmxlbmd0aCA+IDFcbiAgICAgICAgICAgICAgICA/IFtvcHRpb25zLmZpZWxkSW5mb3NbMV1dXG4gICAgICAgICAgICAgICAgOiBbb3B0aW9ucy5maWVsZEluZm9zWzBdXVxuICAgICAgICAgICAgOiBudWxsIH0pKS50aGVuKChzaXplUmVuZGVyZXJSZXN1bHQpID0+IHtcbiAgICAgICAgcmV0dXJuIGNyZWF0ZUNvbG9yUmVuZGVyZXJGcm9tRXhpc3RpbmcoT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zKSwgeyBmaWVsZEluZm9zOiBvcHRpb25zLmZpZWxkSW5mb3MgPyBbb3B0aW9ucy5maWVsZEluZm9zWzBdXSA6IG51bGwgfSkpLnRoZW4oKGNvbG9yUmVuZGVyZXJSZXN1bHQpID0+IHtcbiAgICAgICAgICAgIGNvcHlTaXplVG9Db2xvclJlbmRlcmVyKGNvbG9yUmVuZGVyZXJSZXN1bHQucmVuZGVyZXIsIHNpemVSZW5kZXJlclJlc3VsdC5yZW5kZXJlcik7XG4gICAgICAgICAgICBjb2xvclJlbmRlcmVyUmVzdWx0LmJhY2tncm91bmRGaWxsU3ltYm9sID0gZ2V0UmVuZGVyZXIobGF5ZXIpLmJhY2tncm91bmRGaWxsU3ltYm9sO1xuICAgICAgICAgICAgLy8gaGFuZGxlIHNpdHVhdGlvbnMgd2hlcmUgcmVuZGVyZXIgcmVjcmVhdGlvbiBvY2N1cnMgZnJvbSB0aGUgc2l6ZSBwYW5lbC4gU2xpZGVyIHN0YXRpc3RpY3MgbXVzdCBjb3JyZXNwb25kIHRvIHRoZSBzaXplIHZhcmlhYmxlLlxuICAgICAgICAgICAgaWYgKHJlbmRlcmVyU3VidHlwZSA9PT0gXCJzaXplXCIpIHtcbiAgICAgICAgICAgICAgICBjb2xvclJlbmRlcmVyUmVzdWx0LnN0YXRpc3RpY3MgPSBzaXplUmVuZGVyZXJSZXN1bHQuc3RhdGlzdGljcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoY29sb3JSZW5kZXJlclJlc3VsdCk7XG4gICAgICAgIH0sIChlcnJvcikgPT4gUHJvbWlzZS5yZWplY3QoZXJyb3IpKTtcbiAgICB9LCAoZXJyb3IpID0+IFByb21pc2UucmVqZWN0KGVycm9yKSk7XG59XG5mdW5jdGlvbiBjcmVhdGVDb2xvclBhcnRGb3JSZW5kZXJlcihzaXplUmVuZGVyZXIsIG9wdGlvbnMpIHtcbiAgICBjb25zdCB7IGxheWVyIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICBjb25zdCByZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKTtcbiAgICBjb25zdCBhdXRoSW5mbyA9IHJlbmRlcmVyLmF1dGhvcmluZ0luZm87XG4gICAgY29uc3QgcmVuZGVyZXJUeXBlID0gZ2V0UmVuZGVyZXJUeXBlKCk7XG4gICAgY29uc3QgYXV0aENvbG9yVmlzVmFyID0gZ2V0QXV0aFZpc1ZhcihyZW5kZXJlciwgXCJjb2xvclwiKTtcbiAgICBpZiAoc2FtZUNvbG9yRmllbGQob3B0aW9ucykgJiZcbiAgICAgICAgW1wiY29sb3JcIiwgXCJjb2xvci1zaXplXCIsIFwiY29sb3Itc2l6ZS1hZ2VcIl0uaW5kZXhPZihyZW5kZXJlclR5cGUpID4gLTEgJiZcbiAgICAgICAgYXV0aEluZm8gJiZcbiAgICAgICAgKGF1dGhJbmZvID09PSBudWxsIHx8IGF1dGhJbmZvID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhdXRoSW5mby51bml2YXJpYXRlVGhlbWUpICE9PSBcImFib3ZlLWFuZC1iZWxvd1wiICYmXG4gICAgICAgIFtcImNlbnRlcmVkLW9uXCIsIFwiZXh0cmVtZXNcIl0uaW5kZXhPZihhdXRoQ29sb3JWaXNWYXIudGhlbWUpID09PSAtMSkge1xuICAgICAgICAvLyByZS11c2UgY29sb3IgcmVuZGVyZXJcbiAgICAgICAgY29uc3QgcmVuZGVyZXIgPSBnZXRSZW5kZXJlcihsYXllcikuY2xvbmUoKTtcbiAgICAgICAgY29weVNpemVUb0NvbG9yUmVuZGVyZXIocmVuZGVyZXIsIHNpemVSZW5kZXJlcik7XG4gICAgICAgIGlmIChvcHRpb25zLmZpZWxkSW5mb3MubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAvLyBpbiBjYXNlIHdlJ3JlIGNvbWluZyBmcm9tIGFuIHVuaXZhcmlhdGUgQ29sb3IrU2l6ZSByZW5kZXJlclxuICAgICAgICAgICAgY29uc3QgYXV0aEluZm8gPSByZW5kZXJlci5hdXRob3JpbmdJbmZvO1xuICAgICAgICAgICAgYXV0aEluZm8udHlwZSA9IG51bGw7XG4gICAgICAgICAgICBhdXRoSW5mby51bml2YXJpYXRlVGhlbWUgPSBudWxsO1xuICAgICAgICAgICAgYXV0aEluZm8udW5pdmFyaWF0ZVN5bWJvbFN0eWxlID0gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgcmVuZGVyZXIgfSk7XG4gICAgfVxuICAgIHJldHVybiBjcmVhdGVDb2xvclJlbmRlcmVyKE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucyksIHsgZmllbGRJbmZvczogW29wdGlvbnMuZmllbGRJbmZvc1swXV0gfSkpLnRoZW4oKGNvbG9yUmVuZGVyZXJSZXN1bHQpID0+IHtcbiAgICAgICAgY29weVNpemVUb0NvbG9yUmVuZGVyZXIoY29sb3JSZW5kZXJlclJlc3VsdC5yZW5kZXJlciwgc2l6ZVJlbmRlcmVyKTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShjb2xvclJlbmRlcmVyUmVzdWx0KTtcbiAgICB9LCAoZXJyb3IpID0+IFByb21pc2UucmVqZWN0KGVycm9yKSk7XG59XG5mdW5jdGlvbiBjcmVhdGVDb2xvckFnZVBhcnRGb3JSZW5kZXJlcihzaXplUmVuZGVyZXIsIG9wdGlvbnMpIHtcbiAgICBjb25zdCB7IGxheWVyIH0gPSBzbWFydE1hcHBpbmdTdGF0ZTtcbiAgICBjb25zdCByZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKTtcbiAgICBjb25zdCBhdXRoSW5mbyA9IHJlbmRlcmVyLmF1dGhvcmluZ0luZm87XG4gICAgY29uc3QgcmVuZGVyZXJUeXBlID0gZ2V0UmVuZGVyZXJUeXBlKCk7XG4gICAgaWYgKHNhbWVDb2xvckZpZWxkKG9wdGlvbnMpICYmXG4gICAgICAgIFtcImNvbG9yLWFnZVwiLCBcImNvbG9yLWFnZS1zaXplXCJdLmluZGV4T2YocmVuZGVyZXJUeXBlKSA+IC0xICYmXG4gICAgICAgIGF1dGhJbmZvICYmXG4gICAgICAgIChhdXRoSW5mbyA9PT0gbnVsbCB8fCBhdXRoSW5mbyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXV0aEluZm8udW5pdmFyaWF0ZVRoZW1lKSAhPT0gXCJhYm92ZS1hbmQtYmVsb3dcIikge1xuICAgICAgICAvLyB3ZSBjYW4gcmUtdXNlIHRoZSBjb2xvciByZW5kZXJlclxuICAgICAgICBjb25zdCByZW5kZXJlciA9IGdldFJlbmRlcmVyKGxheWVyKS5jbG9uZSgpO1xuICAgICAgICBjb3B5U2l6ZVRvQ29sb3JSZW5kZXJlcihyZW5kZXJlciwgc2l6ZVJlbmRlcmVyKTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IHJlbmRlcmVyIH0pO1xuICAgIH1cbiAgICByZXR1cm4gY3JlYXRlQ29sb3JBZ2VSZW5kZXJlcihPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMpLCB7IGZpZWxkSW5mb3M6IFtvcHRpb25zLmZpZWxkSW5mb3NbMF1dIH0pKS50aGVuKChjb2xvclJlbmRlcmVyUmVzdWx0KSA9PiB7XG4gICAgICAgIGNvcHlTaXplVG9Db2xvclJlbmRlcmVyKGNvbG9yUmVuZGVyZXJSZXN1bHQucmVuZGVyZXIsIHNpemVSZW5kZXJlcik7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoY29sb3JSZW5kZXJlclJlc3VsdCk7XG4gICAgfSwgKGVycm9yKSA9PiBQcm9taXNlLnJlamVjdChlcnJvcikpO1xufVxuZnVuY3Rpb24gY29weVNpemVUb0NvbG9yUmVuZGVyZXIoY29sb3JSZW5kZXJlciwgc2l6ZVJlbmRlcmVyKSB7XG4gICAgdmFyIF9hO1xuICAgIGNvbnN0IHsgbGF5ZXIsIG1hcFZpZXcgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgIGlmICghY29sb3JSZW5kZXJlci5hdXRob3JpbmdJbmZvKSB7XG4gICAgICAgIC8vIGRvbid0IGtlZXAgYW55dGhpbmdcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb2xvclJlbmRlcmVyLnZpc3VhbFZhcmlhYmxlcyA9IGdldFZpc1ZhcnNFeGNlcHQoY29sb3JSZW5kZXJlciwgXCJzaXplXCIpIHx8IFtdO1xuICAgIGNvbG9yUmVuZGVyZXIudmlzdWFsVmFyaWFibGVzID0gZ2V0VmlzVmFyc0V4Y2VwdChjb2xvclJlbmRlcmVyLCBcInNpemVcIiwgXCJhdXRvXCIpIHx8IFtdO1xuICAgIGNvbnN0IHNpemVWaXNWYXIgPSBnZXRWaXNWYXIoc2l6ZVJlbmRlcmVyLCBcInNpemVcIik7XG4gICAgY29sb3JSZW5kZXJlci52aXN1YWxWYXJpYWJsZXMucHVzaChzaXplVmlzVmFyKTtcbiAgICBjb2xvclJlbmRlcmVyLmF1dGhvcmluZ0luZm8udmlzdWFsVmFyaWFibGVzID0gZ2V0QXV0aFZpc1ZhcnNFeGNlcHQoY29sb3JSZW5kZXJlciwgXCJzaXplXCIpIHx8IFtdO1xuICAgIGNvbnN0IHNpemVBdXRoVmlzVmFyID0gZ2V0QXV0aFZpc1ZhcihzaXplUmVuZGVyZXIsIFwic2l6ZVwiKTtcbiAgICBjb2xvclJlbmRlcmVyLmF1dGhvcmluZ0luZm8udmlzdWFsVmFyaWFibGVzLnB1c2goc2l6ZUF1dGhWaXNWYXIpO1xuICAgIGNvbnN0IGluZm9zID0gKChfYSA9IHNpemVSZW5kZXJlci5jbGFzc0JyZWFrSW5mb3MpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5sZW5ndGgpID8gc2l6ZVJlbmRlcmVyLmNsYXNzQnJlYWtJbmZvcyA6IHNpemVSZW5kZXJlci51bmlxdWVWYWx1ZUluZm9zO1xuICAgIGxldCBtYXJrZXJTeW1ib2wgPSAoaW5mb3MgPT09IG51bGwgfHwgaW5mb3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGluZm9zLmxlbmd0aCkgPyBpbmZvc1swXS5zeW1ib2wgOiBnZXREZWZhdWx0U3ltYm9sKGxheWVyLCBtYXBWaWV3LCBcImNvbG9yLXNpemVcIik7XG4gICAgaWYgKG1hcmtlclN5bWJvbC50eXBlID09PSBcInBpY3R1cmUtbWFya2VyXCIpIHtcbiAgICAgICAgbWFya2VyU3ltYm9sID0gZ2V0RGVmYXVsdFN5bWJvbChsYXllciwgbWFwVmlldywgXCJjb2xvci1zaXplXCIpO1xuICAgIH1cbiAgICBpZiAoaXNQb2x5Z29uVHlwZShsYXllcikpIHtcbiAgICAgICAgY29sb3JSZW5kZXJlci5jbGFzc0JyZWFrSW5mb3MubWFwKCh2YWx1ZUluZm8pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNvbG9yID0gZ2V0U3ltYm9sQ29sb3IodmFsdWVJbmZvLnN5bWJvbCk7XG4gICAgICAgICAgICB2YWx1ZUluZm8uc3ltYm9sID0gbWFya2VyU3ltYm9sLmNsb25lKCk7XG4gICAgICAgICAgICBhcHBseVN5bWJvbENvbG9yKHZhbHVlSW5mby5zeW1ib2wsIGNvbG9yKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbG9yUmVuZGVyZXIuYmFja2dyb3VuZEZpbGxTeW1ib2wgPSBzaXplUmVuZGVyZXIuYmFja2dyb3VuZEZpbGxTeW1ib2w7XG4gICAgICAgIGNvbnN0IHNpemVPdXRsaW5lVmlzVmFyID0gZ2V0VmlzVmFyKHNpemVSZW5kZXJlciwgXCJzaXplXCIsIFwib3V0bGluZVwiKTtcbiAgICAgICAgaWYgKHNpemVPdXRsaW5lVmlzVmFyKSB7XG4gICAgICAgICAgICBjb2xvclJlbmRlcmVyLnZpc3VhbFZhcmlhYmxlcy5wdXNoKHNpemVPdXRsaW5lVmlzVmFyKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB1cGRhdGVNYWluU3ltYm9sKG1hcmtlclN5bWJvbCk7XG59XG5mdW5jdGlvbiB1cGRhdGVNYWluU3ltYm9sKHN5bWJvbCkge1xuICAgIC8vIHRoaXMgc3ltYm9sIHNob3dzIHVwIGlmIG9uZSBvZiB0aGUgZmllbGRzIGlzIG51bGxcbiAgICBjb25zdCB7IG1vZHVsZXMgfSA9IHNtYXJ0TWFwcGluZ1N0YXRlO1xuICAgIGlmIChzeW1ib2wudHlwZSA9PT0gXCJzaW1wbGUtbGluZVwiKSB7XG4gICAgICAgIHN5bWJvbC5jb2xvciA9IFswLCAwLCAwLCAwLjVdO1xuICAgICAgICBzeW1ib2wud2lkdGggPSAxO1xuICAgIH1cbiAgICBlbHNlIGlmIChzeW1ib2wudHlwZSA9PT0gXCJjaW1cIikge1xuICAgICAgICBhcHBseVN5bWJvbENvbG9yKHN5bWJvbCwgbmV3IG1vZHVsZXMuZXNyaUNvbG9yKFswLCAwLCAwLCAwLjVdKSk7XG4gICAgICAgIC8vY29uc3Qgb3V0bGluZSA9IGdldENpbVBvaW50T3V0bGluZShzeW1ib2wpO1xuICAgICAgICAvL291dGxpbmUuY29sb3IgPSBbMCwgMCwgMCwgMC41XTtcbiAgICAgICAgYXBwbHlTeW1ib2xTaXplKHN5bWJvbCwgNCk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICAvLyBzaW1wbGUtbWFya2VyXG4gICAgICAgIHN5bWJvbC5jb2xvciA9IG51bGw7XG4gICAgICAgIHN5bWJvbC5vdXRsaW5lLmNvbG9yID0gWzAsIDAsIDAsIDAuNV07XG4gICAgICAgIGFwcGx5U3ltYm9sU2l6ZShzeW1ib2wsIDQpO1xuICAgIH1cbn1cblxuZXhwb3J0IHsgY3JlYXRlU2l6ZUFnZVJlbmRlcmVyIGFzIGEsIGNyZWF0ZUNvbG9yU2l6ZVJlbmRlcmVyIGFzIGIsIGNyZWF0ZVNpemVSZW5kZXJlciBhcyBjLCBjcmVhdGVDb2xvckFnZVNpemVSZW5kZXJlciBhcyBkLCBjcmVhdGVDb2xvclNpemVBZ2VSZW5kZXJlciBhcyBlLCBjcmVhdGVTaXplUmVuZGVyZXJGcm9tRXhpc3RpbmcgYXMgZiwgY3JlYXRlU2l6ZUFnZVJlbmRlcmVyRnJvbUV4aXN0aW5nIGFzIGcsIGNyZWF0ZUNvbG9yQWdlU2l6ZVJlbmRlcmVyRnJvbUV4aXN0aW5nIGFzIGgsIGNyZWF0ZUNvbG9yU2l6ZUFnZVJlbmRlcmVyRnJvbUV4aXN0aW5nIGFzIGksIGNyZWF0ZUNvbG9yU2l6ZVJlbmRlcmVyRnJvbUV4aXN0aW5nIGFzIGosIGNyZWF0ZUNsYXNzZWRTaXplUmVuZGVyZXJGcm9tRXhpc3RpbmcgYXMgaywgZ2V0U2l6ZVNsaWRlclN0b3BzIGFzIGwsIGdldENsYXNzQnJlYWtzU2l6ZXMgYXMgbSwgc2FtZVNpemVGaWVsZCBhcyBzIH07XG5cbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWNvbG9yU2l6ZS1jZTBjY2RlYi5qcy5tYXAiXSwibmFtZXMiOltdLCJzb3VyY2VSb290IjoiIn0=