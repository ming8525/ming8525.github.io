"use strict";
(self["webpackChunkexb_client"] = self["webpackChunkexb_client"] || []).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-8f1989"],{

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/arcgis-table_3.entry.js":
/*!*****************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/arcgis-table_3.entry.js ***!
  \*****************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   arcgis_table: () => (/* binding */ ArcgisTable),
/* harmony export */   arcgis_table_column_info: () => (/* binding */ ArcgisTableColumnInfo),
/* harmony export */   arcgis_table_field_selection: () => (/* binding */ ArcgisTableFieldSelection)
/* harmony export */ });
/* harmony import */ var _index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./index-e3bf7da7.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-e3bf7da7.js");
/* harmony import */ var _locale_050b6db9_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./locale-050b6db9.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/locale-050b6db9.js");
/* harmony import */ var _loadModules_b4ac1247_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./loadModules-b4ac1247.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/loadModules-b4ac1247.js");
/* harmony import */ var _basic_6db7ebd7_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./basic-6db7ebd7.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/basic-6db7ebd7.js");
/* harmony import */ var _commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./commonFunctions-b0830e9e.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/commonFunctions-b0830e9e.js");
/* harmony import */ var _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./commonEnums-fcf13661.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/commonEnums-fcf13661.js");
/* harmony import */ var _languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./languageUtil-ef0e54b2.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/languageUtil-ef0e54b2.js");
/* harmony import */ var _dom_4d367677_js__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./dom-4d367677.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/dom-4d367677.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v4.0.58
 */









const CSS$2 = {
    host: "host",
    content: "content",
    manager: "manager",
    actionBar: "action-bar",
    menuActions: "menu-actions",
    table: "table",
    tooltip: "tooltip"
};

/**
 * Returns true if the layer supports attachments
 * @param layer - FeatureLayer
 */
function hasAttachmentsEnabled(layer) {
    if (!(layer === null || layer === void 0 ? void 0 : layer.capabilities)) {
        return false;
    }
    const { capabilities: { data: { supportsAttachment }, operations: { supportsQueryAttachments } } } = layer;
    return supportsAttachment && supportsQueryAttachments;
}
/**
 * Returns the layer type, and "sublayer" for Sublayer
 * @param layer - FeatureLayer
 */
function getLayerType(layer) {
    if (layer.declaredClass === "esri.layers.support.Sublayer") {
        return "sublayer";
    }
    else {
        return (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.c)(layer);
    }
}

/**
 * gives the parameters for identify
 * @param extent - extent at which the identify should be done
 * @param map - map object
 * @param layer - the layer on which identify should perform
 */
async function getIdentifyParams(extent, map, layer) {
    const [Polygon, Point, ImageIdentifyParameters] = await (0,_loadModules_b4ac1247_js__WEBPACK_IMPORTED_MODULE_2__.l)([
        "esri/geometry/Polygon",
        "esri/geometry/Point",
        "esri/rest/support/ImageIdentifyParameters"
    ]);
    const polygon = new Polygon(extent.spatialReference);
    polygon.addRing([
        [extent.xmin, extent.ymin],
        [extent.xmin, extent.ymax],
        [extent.xmax, extent.ymax],
        [extent.xmax, extent.ymin],
        [extent.xmin, extent.ymin]
    ]);
    const psX = (extent.xmax - extent.xmin) / map.width;
    const psY = (extent.ymax - extent.ymin) / map.height;
    const psSR = extent.spatialReference;
    const pixelSize = new Point(psX, psY, psSR);
    // Generate Task Params
    const taskParams = new ImageIdentifyParameters();
    taskParams.geometry = polygon;
    taskParams.returnGeometry = true;
    taskParams.pixelSize = pixelSize;
    const mosaicRule = layer.mosaicRule.clone();
    if (layer.definitionExpression) {
        mosaicRule.where = layer.definitionExpression;
    }
    taskParams.mosaicRule = mosaicRule;
    return taskParams;
}

const arcgisTableCss = ".host.sc-arcgis-table{width:100%}.content.sc-arcgis-table{height:100%;display:flex}.manager.sc-arcgis-table{height:100%}.action-bar.sc-arcgis-table{height:100%;border-width:0 1px 0 0;border-style:solid;border-color:var(--calcite-color-border-2)}.menu-actions.sc-arcgis-table{display:inline-flex;justify-self:stretch}.table.sc-arcgis-table{height:100%}.tooltip.sc-arcgis-table{white-space:nowrap}.arcgis--rtl.sc-arcgis-table .action-bar.sc-arcgis-table{border-width:0 0 0 1px}";

const ArcgisTable = class {
    constructor(hostRef) {
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
        this.arcgisTableScaleChange = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisTableScaleChange", 7);
        this.arcgisTableDismissedChange = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisTableDismissedChange", 7);
        this.selectedOnlyMode = false;
        this.recordsCount = 0;
        this.selectedCount = 0;
        // --------------------------------------------------------------------------
        //
        //  Private methods
        //
        // --------------------------------------------------------------------------
        this.panelKeyDownHandler = (event) => {
            if (this.dismissible && event.key === "Escape" && !event.defaultPrevented) {
                this.handleCloseClick();
                event.preventDefault();
            }
        };
        this.afterCreatePanel = async (node) => {
            const { layer, view } = this.props;
            if (layer.type === "imagery") {
                this.recordsCount = await (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.n)(layer);
            }
            else if (layer.type === "wfs") {
                this.recordsCount = await layer.queryFeatureCount();
            }
            else {
                this.recordsCount = await (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.g)(layer, view);
            }
            this.displayCount();
            this.panelNode = node;
            this.watchTitleHandler = layer.watch("title", () => {
                this.reRender = !this.reRender;
            });
        };
        this.afterCreateCloseButton = (node) => {
            this.closeButtonNode = node;
        };
        this.afterCreateTableNode = (node) => {
            const { props, selectedFeatureIds, reactiveUtils, supportsSelection } = this;
            const { layer, view } = props;
            const { table } = this;
            if (table) {
                return;
            }
            const { tableTemplate } = this;
            const supportsEditing = layer.type === "feature" && layer.effectiveEditingEnabled;
            this.table = new this.FeatureTable({
                layer,
                view,
                tableTemplate,
                editingEnabled: supportsEditing,
                attachmentsEnabled: layer.type === "feature" && hasAttachmentsEnabled(layer),
                highlightOnRowSelectEnabled: supportsSelection,
                multiSortEnabled: false,
                visibleElements: {
                    header: false,
                    menu: false
                },
                container: node
            });
            // hide selection checkboxes
            if (!supportsSelection) {
                this.table.grid.visibleElements = { selectionColumn: false };
            }
            this.watchHndlSize = reactiveUtils.watch(() => this.table.viewModel.size, (count) => {
                this.recordsCount = count;
                this.displayCount();
            });
            if (supportsSelection) {
                this.table.highlightIds.on("change", (event) => {
                    event.removed.forEach((objectId) => {
                        const idx = selectedFeatureIds.indexOf(objectId);
                        if (idx > -1) {
                            selectedFeatureIds.splice(idx, 1);
                        }
                    });
                    event.added.forEach((objectId) => {
                        if (selectedFeatureIds.indexOf(objectId) === -1) {
                            selectedFeatureIds.push(objectId);
                        } // could happen after clicking for popup
                    });
                    this.selectedCount = selectedFeatureIds.length;
                    this.displayCount();
                    this.lockRasters();
                    this.reRender = !this.reRender;
                });
                this.watchHndlActive = reactiveUtils.watch(() => { var _a, _b; return (_b = (_a = view.popup) === null || _a === void 0 ? void 0 : _a.viewModel) === null || _b === void 0 ? void 0 : _b.active; }, () => {
                    const selectedFeature = view.popup.selectedFeature;
                    if (selectedFeature && view.popup.visible) {
                        // delete entire selection in table
                        this.table.highlightIds.removeAll();
                        // only add popup features
                        const id = view.popup.selectedFeature.getObjectId();
                        this.table.highlightIds.push(id);
                        selectedFeatureIds.push(id);
                    }
                    else if (selectedFeature && !view.popup.visible) {
                        // popup got closed,
                        // delete entire selection in table
                        this.table.highlightIds.removeAll();
                    }
                });
            }
        };
        this.handleEditingClick = () => {
            const { strings } = this;
            this.removeEditingPopover();
            this.editingPopoverNode = document.createElement("arcgis-table-editing-popover");
            this.editingPopoverNode.referenceElement = this.editingActionNode;
            this.editingPopoverNode.strings = strings;
            this.editingPopoverNode.addEventListener("arcgisTableEditingPopoverClose", (event) => {
                event.stopPropagation();
                this.removeEditingPopover();
                setTimeout(() => this.editingActionNode.setFocus(), 200);
            });
            this.editingPopoverNode.addEventListener("arcgisTableEditingPopoverDisconnected", (event) => {
                event.stopPropagation();
                this.removeEditingPopover();
            });
            document.body.appendChild(this.editingPopoverNode);
            this.editingPopoverNode.setOpen(true);
            // need to wait until it's all visible
            setTimeout(() => this.editingPopoverNode.setFocus(), 100);
        };
        this.handleVisibilityClick = (event) => {
            if (this.fieldSelectionPopover) {
                // already open, do nothing
                return;
            }
            document.removeEventListener("click", this.clickHandler);
            const { layer } = this.props;
            const { props, strings, currentLanguageIntl, tableTemplate, table, fieldSortOrder } = this;
            const popover = document.createElement("arcgis-table-field-selection");
            popover.props = props;
            popover.strings = strings;
            popover.currentLanguage = currentLanguageIntl;
            popover.columnTemplates = tableTemplate.columnTemplates;
            popover.sortBy = fieldSortOrder;
            popover.attachmentsEnabled =
                layer.type === "feature" && hasAttachmentsEnabled(layer) ? table.attachmentsEnabled : false;
            popover.popoverReferenceElement = event.target;
            popover.addEventListener("columnTemplatesChange", (event) => {
                event.stopPropagation();
                this.updateTable(new this.TableTemplate({ columnTemplates: event.detail }));
            });
            popover.addEventListener("attachmentsChange", (event) => {
                event.stopPropagation();
                this.table.attachmentsEnabled = event.detail;
            });
            popover.addEventListener("fieldSortByChange", (event) => {
                event.stopPropagation();
                this.fieldSortOrder = event.detail;
            });
            popover.addEventListener("arcgisTableFieldSelectionClose", () => {
                this.closePopovers();
                setTimeout(() => this.settingsActionNode.setFocus(), 200);
            });
            document.body.appendChild(popover);
            this.fieldSelectionPopover = popover;
            setTimeout(() => document.addEventListener("click", this.clickHandler), 200);
        };
        this.clickHandler = (event) => {
            if (!this.fieldSelectionPopover) {
                // popover got removed another way
                document.removeEventListener("click", this.clickHandler);
            }
            else if (!(0,_basic_6db7ebd7_js__WEBPACK_IMPORTED_MODULE_3__.i)(event.target, "arcgis-table-field-selection")) {
                document.body.removeChild(this.fieldSelectionPopover);
                this.fieldSelectionPopover = null;
                document.removeEventListener("click", this.clickHandler);
            }
        };
        this.handleHomeClick = () => {
            const { view, initialViewpoint } = this;
            view.goTo(initialViewpoint);
        };
        this.handleZoomToClick = () => {
            const { layer, view, selectedFeatureIds, Query } = this;
            if (getLayerType(layer) === "imagery") {
                const query = new Query();
                query.outSpatialReference = view.spatialReference;
                query.objectIds = [...selectedFeatureIds];
                query.returnGeometry = true;
                layer.queryRasters(query).then((results) => {
                    view.goTo(results.features);
                });
            }
            else {
                const query = layer.createQuery();
                query.outSpatialReference = view.spatialReference;
                query.objectIds = [...selectedFeatureIds];
                query.returnGeometry = true;
                layer.queryFeatures(query).then((results) => {
                    view.goTo(results.features);
                });
            }
        };
        this.handleClearClick = () => {
            const { table, supportsSelection } = this;
            const { viewModel, grid } = table;
            table.highlightIds.removeAll();
            viewModel.clearSelectionFilter();
            this.selectedOnlyMode = false;
            if (supportsSelection) {
                grid.visibleElements = { selectionColumn: true };
            }
        };
        this.handleShowSelectedClick = () => {
            const { table } = this;
            const { viewModel } = table;
            this.selectedOnlyMode = true;
            viewModel.filterBySelection();
            this.reRender = !this.reRender;
        };
        this.handleShowAllClick = () => {
            const { table } = this;
            const { viewModel } = table;
            this.selectedOnlyMode = false;
            viewModel.clearSelectionFilter();
            this.reRender = !this.reRender;
        };
        this.handleSelectVisibleClick = async () => {
            const { layer, view, table } = this;
            table.highlightIds.removeAll();
            const extent = view.get("extent");
            // to do to normalize extend
            // if (getLayerType(layer) === "imagery" && (layer as ImageryLayer).version >=10 && view.wrapAround) {
            //   extent = extent._normalize(true);
            // }
            // Convert extent to polygon
            const identifyParams = await getIdentifyParams(extent, view, layer);
            this.selectFeaturesFromIdentify(identifyParams);
        };
        this.handleDisplaySelectedClick = () => {
            this.lockRaster = true;
            this.lockRasters();
        };
        this.handleDisplayAllClick = () => {
            var _a;
            const { MosaicRule } = this;
            this.lockRaster = false;
            // use service's default mosaic rule, filtered out certain mosaic methods that're not supported without additional inputs.
            const layer = this.layer;
            const { sourceJSON } = layer;
            const methods = sourceJSON.allowedMosaicMethods
                .split(",")
                .map((method) => method.trim().toLowerCase());
            methods.unshift(sourceJSON.defaultMosaicMethod.toLowerCase());
            // viewpoint is not available from sourceJSON, sortField can be null too.
            const defaultMosaicMethod = (_a = methods.find((method) => method !== "lockraster" &&
                method !== "viewpoint" &&
                (method !== "byattribute" || !!sourceJSON.sortField))) !== null && _a !== void 0 ? _a : "none";
            layer.mosaicRule = MosaicRule.fromJSON(Object.assign(Object.assign({}, sourceJSON), { defaultMosaicMethod }));
            layer.visible = true;
        };
        this.handleRefreshClick = () => {
            const { table } = this;
            table.refresh();
            this.reRender = !this.reRender;
        };
        this.handleExpandClick = () => {
            const { scale } = this;
            const newScale = scale === _basic_6db7ebd7_js__WEBPACK_IMPORTED_MODULE_3__.s.SMALL ? _basic_6db7ebd7_js__WEBPACK_IMPORTED_MODULE_3__.s.MEDIUM : _basic_6db7ebd7_js__WEBPACK_IMPORTED_MODULE_3__.s.SMALL;
            this.arcgisTableScaleChange.emit(newScale);
            this.scale = newScale;
            this.closePopovers();
        };
        this.handleCloseClick = () => {
            this.arcgisTableDismissedChange.emit();
        };
        this.view = undefined;
        this.layer = undefined;
        this.initialViewpoint = undefined;
        this.scale = _basic_6db7ebd7_js__WEBPACK_IMPORTED_MODULE_3__.s.SMALL;
        this.dismissible = false;
        this.tableTemplate = undefined;
        this.reRender = false;
        this.lockRaster = false;
        this.isBarExpanded = false;
        this.selectedFeatureIds = [];
    }
    //--------------------------------------------------------------------------
    //
    //  public calls
    //
    //--------------------------------------------------------------------------
    async setFocus(focusId) {
        var _a, _b;
        if (focusId === "dismiss-button" || (!focusId && this.dismissible)) {
            (_a = this.closeButtonNode) === null || _a === void 0 ? void 0 : _a.setFocus();
            return;
        }
        (_b = this.settingsActionNode) === null || _b === void 0 ? void 0 : _b.setFocus();
    }
    //--------------------------------------------------------------------------
    //
    //  Lifecycle
    //
    //--------------------------------------------------------------------------
    async componentWillLoad() {
        const [strings, currentLanguage, currentLanguageIntl] = await (0,_locale_050b6db9_js__WEBPACK_IMPORTED_MODULE_1__.g)(this.hostElement);
        this.strings = strings;
        this.currentLanguage = currentLanguage;
        this.currentLanguageIntl = currentLanguageIntl;
        await this.loadAllModules();
        /*
        // also load JS-API styles
        setDefaultOptions({
          css: true
          url: `https://jsdev.arcgis.com/4.16`,
          css: "https://jsdev.arcgis.com/4.16/esri/css/main.css"
        }); */
        const { view, layer } = this;
        if (getLayerType(layer) === "sublayer") {
            // need to create a FeatureLayer
            this.supportsSelection = false;
            const mapImageSublayer = layer;
            await this.reactiveUtils.whenOnce(() => !view.updating);
            const sublayerFL = await mapImageSublayer.createFeatureLayer();
            await sublayerFL.load();
            this.props = {
                view,
                layer: sublayerFL,
                mapImageSublayer
            };
        }
        else if ((0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.c)(layer) === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_5__.s.imagery) {
            this.supportsSelection = true;
            this.imagerySelection = true;
            this.props = {
                view,
                layer: layer
            };
        }
        else {
            this.supportsSelection = !("isTable" in layer && layer.isTable);
            this.props = {
                view,
                layer: layer
            };
        }
        await this.getFieldTemplates();
    }
    componentDidLoad() {
        requestAnimationFrame(() => this.closeButtonNode.setFocus());
    }
    disconnectedCallback() {
        var _a, _b, _c;
        this.closePopovers();
        const { table } = this;
        table === null || table === void 0 ? void 0 : table.destroy();
        (_a = this.watchTitleHandler) === null || _a === void 0 ? void 0 : _a.remove();
        (_b = this.watchHndlSize) === null || _b === void 0 ? void 0 : _b.remove();
        (_c = this.watchHndlActive) === null || _c === void 0 ? void 0 : _c.remove();
    }
    // --------------------------------------------------------------------------
    //
    //  Render Methods
    //
    //--------------------------------------------------------------------------
    render() {
        const { props } = this;
        const { layer } = props;
        if (!layer) {
            return null;
        }
        const rtl = (0,_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_6__.g)(this.hostElement) === "rtl";
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: CSS$2.host }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: {
                [CSS$2.content]: true,
                [_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_6__.C.rtl]: rtl
            } }, this.renderActionBar(), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-panel", { heading: layer.title, ref: this.afterCreatePanel, onKeyDown: this.panelKeyDownHandler }, this.renderHeaderActions(), this.renderTable()))));
    }
    renderActionBar() {
        const { supportsSelection, selectedFeatureIds, imagerySelection, isBarExpanded, strings } = this;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action-bar", { class: CSS$2.actionBar, onCalciteActionBarToggle: (event) => {
                this.isBarExpanded = event.target.expanded;
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action-group", null, supportsSelection && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.F, null, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { id: "zoom", icon: "zoom-to-object", text: strings.zoomToSelection, disabled: !(selectedFeatureIds === null || selectedFeatureIds === void 0 ? void 0 : selectedFeatureIds.length), onClick: this.handleZoomToClick }), !isBarExpanded && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-tooltip", { referenceElement: "zoom", label: strings.zoomToSelection }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$2.tooltip }, strings.zoomToSelection))))), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { id: "home", icon: "home", text: strings.home, onClick: this.handleHomeClick }), !isBarExpanded && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-tooltip", { referenceElement: "home", label: strings.home }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$2.tooltip }, strings.home))), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-tooltip", { slot: "menu-tooltip", label: strings.more }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$2.tooltip }, strings.more))), !imagerySelection && this.renderTableActions(), imagerySelection && supportsSelection && this.renderImageryTableActions(), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-tooltip", { slot: "expand-tooltip", label: strings.expand }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$2.tooltip }, strings.expand))));
    }
    renderTableActions() {
        var _a, _b;
        const { selectedFeatureIds, supportsSelection, table, isBarExpanded, strings } = this;
        const hasSelectionFilter = !!((_b = (_a = table === null || table === void 0 ? void 0 : table.viewModel) === null || _a === void 0 ? void 0 : _a.activeFilters) === null || _b === void 0 ? void 0 : _b.find((filter) => filter.type === "selection"));
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action-group", null, supportsSelection && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.F, null, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { id: "erase", icon: "erase", text: strings.clearSelection, disabled: !(selectedFeatureIds === null || selectedFeatureIds === void 0 ? void 0 : selectedFeatureIds.length), onClick: this.handleClearClick }), !isBarExpanded && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-tooltip", { referenceElement: "erase", label: strings.clearSelection }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$2.tooltip }, strings.clearSelection))))), supportsSelection && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.F, null, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { id: "showSelected", icon: "selected-items-filter", text: strings.showSelected, disabled: !(selectedFeatureIds === null || selectedFeatureIds === void 0 ? void 0 : selectedFeatureIds.length), onClick: this.handleShowSelectedClick }), !isBarExpanded && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-tooltip", { referenceElement: "showSelected", label: strings.showSelected }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$2.tooltip }, strings.showSelected))))), supportsSelection && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.F, null, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { id: "showAll", icon: "list", text: strings.showAll, disabled: !hasSelectionFilter, onClick: this.handleShowAllClick }), !isBarExpanded && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-tooltip", { referenceElement: "showAll", label: strings.showAll }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$2.tooltip }, strings.showAll))))), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { id: "refresh", icon: "refresh", text: strings.refresh, onClick: this.handleRefreshClick }), !isBarExpanded && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-tooltip", { referenceElement: "refresh", label: strings.refresh }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$2.tooltip }, strings.refresh))), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-tooltip", { slot: "menu-tooltip", label: strings.more }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$2.tooltip }, strings.more))));
    }
    renderImageryTableActions() {
        const { selectedFeatureIds, lockRaster, isBarExpanded, strings } = this;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action-group", null, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { id: "erase", icon: "erase", text: strings.clearSelection, disabled: !(selectedFeatureIds === null || selectedFeatureIds === void 0 ? void 0 : selectedFeatureIds.length), onClick: this.handleClearClick }), !isBarExpanded && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-tooltip", { referenceElement: "erase", label: strings.clearSelection }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$2.tooltip }, strings.clearSelection))), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { id: "visible", icon: "select-visible", text: strings.selectVisible, onClick: this.handleSelectVisibleClick }), !isBarExpanded && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-tooltip", { referenceElement: "visible", label: strings.selectVisible }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$2.tooltip }, strings.selectVisible))), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { id: "displayImage", icon: lockRaster ? "unlock" : "lock", text: lockRaster ? strings.displayAll : strings.displaySelected, onClick: lockRaster ? this.handleDisplayAllClick : this.handleDisplaySelectedClick }), !isBarExpanded && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-tooltip", { referenceElement: "displayImage", label: lockRaster ? strings.displayAll : strings.displaySelected }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$2.tooltip }, lockRaster ? strings.displayAll : strings.displaySelected))), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-tooltip", { slot: "menu-tooltip", label: strings.more }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$2.tooltip }, strings.more))));
    }
    renderHeaderActions() {
        const { layer, scale, strings, dismissible } = this;
        const supportsEditingOnlyForUser = "type" in layer &&
            layer.type === "feature" &&
            layer.effectiveEditingEnabled &&
            !layer.editingEnabled;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { slot: "header-actions-end", class: CSS$2.menuActions }, supportsEditingOnlyForUser && ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { id: "table-editing-action", text: strings.layerEditing, scale: "m", onClick: this.handleEditingClick, ref: (node) => (this.editingActionNode = node) }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "exclamation-mark-circle" }))), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { id: "table-settings-action", text: strings.fieldVisibility, scale: "m", onClick: this.handleVisibilityClick, ref: (node) => (this.settingsActionNode = node) }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "gear" })), scale === _basic_6db7ebd7_js__WEBPACK_IMPORTED_MODULE_3__.s.SMALL ? ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { key: "expand-table", text: strings.expand, scale: "s", onClick: this.handleExpandClick }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "m", icon: "chevrons-up" }))) : ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { key: "expand", text: strings.shrink, scale: "s", onClick: this.handleExpandClick }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "m", icon: "chevrons-down" }))), dismissible ? ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: strings.close, icon: "x", onClick: this.handleCloseClick, ref: this.afterCreateCloseButton })) : null));
    }
    renderTable() {
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { class: CSS$2.table }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("div", { ref: this.afterCreateTableNode })));
    }
    removeEditingPopover() {
        if (this.editingPopoverNode) {
            try {
                document.body.removeChild(this.editingPopoverNode);
                this.editingPopoverNode = null;
            }
            catch (e) { }
        }
    }
    handleHideClick(fieldName) {
        this.table.hideColumn(fieldName);
        this.tableTemplate.columnTemplates.forEach((columnTemplate) => {
            if (columnTemplate.fieldName === fieldName) {
                columnTemplate.visible = false;
            }
        });
    }
    handleColumnInfo(fieldName) {
        const { currentLanguageIntl } = this;
        if (this.columnInfoPopover) {
            // already open, hide it
            this.columnInfoPopover.parentNode.removeChild(this.columnInfoPopover);
        }
        const { props, strings } = this;
        const popover = document.createElement("arcgis-table-column-info");
        popover.props = props;
        popover.strings = strings;
        popover.currentLanguage = currentLanguageIntl;
        popover.fieldName = fieldName;
        popover.popoverReferenceElement = document.getElementById("table-settings-action");
        popover.addEventListener("arcgisTableColumnInfoClose", () => {
            this.closePopovers();
            setTimeout(() => this.closeButtonNode.setFocus(), 100);
        });
        document.body.appendChild(popover);
        this.columnInfoPopover = popover;
    }
    closePopovers() {
        document.removeEventListener("click", this.clickHandler);
        if (this.fieldSelectionPopover) {
            document.body.removeChild(this.fieldSelectionPopover);
            this.fieldSelectionPopover = null;
        }
        if (this.columnInfoPopover) {
            document.body.removeChild(this.columnInfoPopover);
            this.columnInfoPopover = null;
        }
        this.removeEditingPopover();
    }
    async selectFeaturesFromIdentify(params) {
        var _a;
        const { layer, imageService } = this;
        let queryResult = [];
        if (layer.visible) {
            const result = await imageService.identify(layer.url, params);
            if (((_a = result === null || result === void 0 ? void 0 : result.catalogItems) === null || _a === void 0 ? void 0 : _a.features) && result.catalogItemVisibilities) {
                for (let i = 0; i < result.catalogItems.features.length; i++) {
                    if (result.catalogItemVisibilities[i] > 0) {
                        queryResult.push(result.catalogItems.features[i]);
                    }
                }
            }
            const graphics = queryResult.map((feature) => new this.Graphic({
                attributes: feature.attributes,
                geometry: feature.geometry,
                sourceLayer: this.table.layer,
                layer: this.table.layer
            }));
            if (!graphics.length) {
                this.table.highlightIds.removeAll();
            }
            else {
                this.table.selectRows(graphics);
            }
        }
    }
    async lockRasters() {
        const { selectedFeatureIds, layer, imagerySelection, MosaicRule } = this;
        if (this.lockRaster) {
            if (imagerySelection && selectedFeatureIds.length) {
                const ids = [...selectedFeatureIds];
                const mosaicRuleObject = new MosaicRule();
                mosaicRuleObject.method = "lock-raster";
                mosaicRuleObject.lockRasterIds = ids;
                const where = layer.definitionExpression;
                if (where) {
                    mosaicRuleObject.where = where;
                }
                layer.mosaicRule = mosaicRuleObject;
                layer.visible = true;
            }
            else {
                layer.visible = false;
            }
        }
    }
    updateTable(tableTemplate) {
        this.table.tableTemplate = tableTemplate;
    }
    async getFieldTemplates() {
        var _a;
        const { layer } = this.props;
        const { strings } = this;
        const getMenuConfig = (fieldName) => {
            return {
                items: [
                    {
                        label: strings.information,
                        iconClass: "esri-icon-description",
                        autoCloseMenu: true,
                        clickFunction: () => {
                            this.handleColumnInfo(fieldName);
                        }
                    },
                    {
                        label: strings.hideField,
                        iconClass: "esri-icon-non-visible",
                        autoCloseMenu: true,
                        clickFunction: () => {
                            this.handleHideClick(fieldName);
                        }
                    }
                ]
            };
        };
        this.tableTemplate = new this.TableTemplate({ columnTemplates: [] });
        // use default popup settings for field visibility
        const fieldInfos = this.popupUtils.createFieldInfos({
            fields: layer.fields,
            objectIdField: layer.objectIdField
        });
        const fieldInfosMap = new Map(fieldInfos.map((fieldInfo) => [
            fieldInfo.fieldName,
            fieldInfo
        ]));
        let popupFieldsMap;
        if ((_a = layer.popupTemplate) === null || _a === void 0 ? void 0 : _a.fieldInfos) {
            const { popupTemplate } = layer;
            popupFieldsMap = new Map(popupTemplate.fieldInfos.map((fieldInfo) => [
                fieldInfo.fieldName,
                fieldInfo
            ]));
            /* popupTemplate.fieldInfos.forEach((fieldInfo: FieldInfo) => {
              if (fieldInfo.fieldName.startsWith("expression/")) {
                // TODO
              } else if (fieldInfo.fieldName.startsWith("relationships/")) {
                // TODO
              }
            }); */
            // watch for changes
            this.reactiveUtils.watch(() => layer.popupTemplate, () => {
                const { popupTemplate } = layer;
                this.tableTemplate.columnTemplates.forEach((columnTemplate) => {
                    popupTemplate.fieldInfos.forEach((fieldInfo) => {
                        if (columnTemplate.fieldName === fieldInfo.fieldName) {
                            columnTemplate.label = fieldInfo.label;
                            columnTemplate.format = fieldInfo.format;
                        }
                    });
                });
                this.updateTable(this.tableTemplate);
            });
        }
        layer.fields.forEach((field) => {
            if (field.type === "geometry") {
                return;
            }
            const fieldInfo = fieldInfosMap.get(field.name);
            const popupFieldInfo = popupFieldsMap === null || popupFieldsMap === void 0 ? void 0 : popupFieldsMap.get(field.name);
            const fieldColumnTemplate = {
                fieldName: field.name,
                label: (popupFieldInfo === null || popupFieldInfo === void 0 ? void 0 : popupFieldInfo.label) || field.alias || field.name,
                visible: fieldInfo === null || fieldInfo === void 0 ? void 0 : fieldInfo.visible,
                format: (popupFieldInfo === null || popupFieldInfo === void 0 ? void 0 : popupFieldInfo.format) || this.getDefaultFormat(field),
                menuConfig: getMenuConfig(field.name)
            }; /* FieldColumnTemplate */
            this.tableTemplate.columnTemplates.push(fieldColumnTemplate);
        });
    }
    getDefaultFormat(field) {
        if (["integer", "small-integer", "big-integer"].indexOf(field.type) > -1) {
            return new this.FieldInfoFormat({ digitSeparator: false, places: 0 });
        }
        else if (["single", "double", "long"].indexOf(field.type) > -1) {
            return new this.FieldInfoFormat({
                digitSeparator: false,
                places: 2
            });
        }
        else if (["date", "time-only", "timestamp-offset"].indexOf(field.type) > -1) {
            return new this.FieldInfoFormat({
                dateFormat: "short-date-short-time"
            });
        }
        else if ("date-only" === field.type) {
            return new this.FieldInfoFormat({
                dateFormat: "short-date"
            });
        }
        return undefined;
    }
    displayCount() {
        const { strings, panelNode, recordsCount, selectedCount, supportsSelection, intl } = this;
        if (!panelNode) {
            return;
        }
        const numberFormatIntlOptions = intl.convertNumberFormatToIntlOptions({
            digitSeparator: true
        });
        const recordsCountStr = intl.formatNumber(recordsCount, numberFormatIntlOptions);
        if (!(0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.i)(selectedCount) || !supportsSelection) {
            if (recordsCount === 0) {
                panelNode.description = strings.zeroRecords;
            }
            else if (recordsCount === 1) {
                panelNode.description = strings.oneRecord;
            }
            else {
                panelNode.description = strings.numRecords.replace("${count}", `${recordsCountStr}`);
            }
        }
        else if (selectedCount === 0) {
            if (recordsCount === 0) {
                panelNode.description = strings.zeroRecordsZeroSel;
            }
            else if (recordsCount === 1) {
                panelNode.description = strings.oneRecordZeroSel;
            }
            else {
                panelNode.description = strings.numRecordsZeroSel.replace("${count}", `${recordsCountStr}`);
            }
        }
        else if (selectedCount === 1) {
            if (recordsCount === 0) {
                panelNode.description = strings.zeroRecordsOneSel;
            }
            else if (recordsCount === 1) {
                panelNode.description = strings.oneRecordOneSel;
            }
            else {
                panelNode.description = strings.numRecordsOneSel.replace("${count}", `${recordsCountStr}`);
            }
        }
        else {
            // n selected
            const selectedCountStr = intl.formatNumber(selectedCount, numberFormatIntlOptions);
            if (recordsCount === 0) {
                panelNode.description = strings.zeroRecordsNumSel.replace("${countSel}", `${selectedCountStr}`);
            }
            else if (recordsCount === 1) {
                panelNode.description = strings.oneRecordNumSel.replace("${countSel}", `${selectedCountStr}`);
            }
            else {
                panelNode.description = strings.numRecordsNumSel
                    .replace("${count}", `${recordsCountStr}`)
                    .replace("${countSel}", `${selectedCountStr}`);
            }
        }
    }
    async loadAllModules() {
        const [FeatureTable, TableTemplate, popupUtils, reactiveUtils, FieldInfoFormat, Query, imageService, MosaicRule, Graphic, intl] = await (0,_loadModules_b4ac1247_js__WEBPACK_IMPORTED_MODULE_2__.l)([
            "esri/widgets/FeatureTable",
            "esri/widgets/FeatureTable/support/TableTemplate",
            "esri/support/popupUtils",
            "esri/core/reactiveUtils",
            "esri/popup/support/FieldInfoFormat",
            "esri/rest/support/Query",
            "esri/rest/imageService",
            "esri/layers/support/MosaicRule",
            "esri/Graphic",
            "esri/intl"
        ]);
        this.FeatureTable = FeatureTable;
        this.TableTemplate = TableTemplate;
        this.popupUtils = popupUtils;
        this.reactiveUtils = reactiveUtils;
        this.FieldInfoFormat = FieldInfoFormat;
        this.Query = Query;
        this.imageService = imageService;
        this.MosaicRule = MosaicRule;
        this.Graphic = Graphic;
        this.intl = intl;
    }
    get hostElement() { return (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisTable.style = arcgisTableCss;

const CSS$1 = {
    popover: "popover",
    flow: "flow",
    info: "info"
};

const arcgisTableColumnInfoCss = ".flow{max-height:400px}.info{background-color:#ffffff;max-height:400px;width:20vw;max-width:420px;min-width:240px}";

const ArcgisTableColumnInfo = class {
    constructor(hostRef) {
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
        this.arcgisTableColumnInfoClose = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisTableColumnInfoClose", 7);
        // --------------------------------------------------------------------------
        //
        //  Private methods
        //
        // --------------------------------------------------------------------------
        this.afterCreatePopover = (node) => {
            this.popoverNode = node;
        };
        this.afterCreateCloseButton = (node) => {
            this.closeButtonNode = node;
        };
        this.afterCreateFieldInfo = (node) => {
            node.addEventListener("arcgisFieldInfoComplete", () => this.reposition());
        };
        this.handleCloseClick = () => {
            this.arcgisTableColumnInfoClose.emit();
        };
        this.props = undefined;
        this.fieldName = undefined;
        this.popoverReferenceElement = undefined;
        this.strings = undefined;
        this.currentLanguage = undefined;
        this.isOpen = false;
        this.reRender = false;
    }
    //--------------------------------------------------------------------------
    //
    //  Public Methods
    //
    //--------------------------------------------------------------------------
    async reposition() {
        var _a;
        (_a = this.popoverNode) === null || _a === void 0 ? void 0 : _a.reposition();
    }
    //--------------------------------------------------------------------------
    //
    //  Lifecycle
    //
    //--------------------------------------------------------------------------
    async componentWillLoad() {
        const { layer } = this.props;
        this.fieldsMap = await (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.d)(layer);
    }
    componentDidLoad() {
        this.reposition();
        this.isOpen = true;
        // need timeout because of re-render
        setTimeout(() => requestAnimationFrame(() => this.closeButtonNode.setFocus()), 100);
    }
    // --------------------------------------------------------------------------
    //
    //  Render Methods
    //
    //--------------------------------------------------------------------------
    render() {
        const { fieldName, fieldsMap, popoverReferenceElement } = this;
        const field = fieldsMap.get(fieldName);
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "js-app-flyout" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-popover", { placement: "leading", dir: document.dir, open: this.isOpen, pointerDisabled: true, referenceElement: popoverReferenceElement, offsetDistance: -48, offsetSkidding: 0, class: CSS$1.popover, label: "", ref: this.afterCreatePopover }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow", { class: CSS$1.flow }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { heading: field.alias || field.name, description: fieldName }, this.renderCloseButton(), this.renderInfo())))));
    }
    renderCloseButton() {
        const { strings } = this;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: strings.close, scale: "s", slot: "header-actions-end", onClick: this.handleCloseClick, ref: this.afterCreateCloseButton, icon: "x" }));
    }
    renderInfo() {
        const { layer, view } = this.props;
        const { fieldName, currentLanguage } = this;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("arcgis-field-info", { fieldName: fieldName, layer: layer, view: view, lang: currentLanguage, class: CSS$1.info, ref: this.afterCreateFieldInfo }));
    }
    get hostElement() { return (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisTableColumnInfo.style = arcgisTableColumnInfoCss;

const CSS = {
    popover: "popover",
    flow: "flow",
    info: "info",
    selectButton: "select-button"
};

const arcgisTableFieldSelectionCss = ".flow{max-height:400px;width:280px}.content{max-height:80vh}.info{background-color:#ffffff}.select-button{margin:4px 0}";

const ArcgisTableFieldSelection = class {
    constructor(hostRef) {
        (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.r)(this, hostRef);
        this.arcgisTableFieldSelectionClose = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "arcgisTableFieldSelectionClose", 7);
        this.columnTemplatesChange = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "columnTemplatesChange", 7);
        this.fieldSortByChange = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "fieldSortByChange", 7);
        this.attachmentsChange = (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.c)(this, "attachmentsChange", 7);
        this.waitHandler = null;
        // --------------------------------------------------------------------------
        //
        //  Private methods
        //
        // --------------------------------------------------------------------------
        this.afterCreatePopover = (node) => {
            this.popoverNode = node;
        };
        this.afterCreateFlow = (node) => {
            this.flowNode = node;
        };
        this.afterCreateFlowItem = (node) => {
            this.firstPanelNode = node;
        };
        this.afterCreateCloseButton = (node) => {
            this.closeButtonNode = node;
        };
        this.afterCreatePickList = (node) => {
            this.pickListNode = node;
        };
        this.afterCreatePickListItem = (node) => {
            node.addEventListener("calciteListItemChange", (event) => {
                this.handleCalciteListItemChange(event);
            });
        };
        this.afterCreatePickListItemAttachments = (node) => {
            node.addEventListener("calciteListItemChange", (event) => {
                this.handleCalciteAttachmentsItemChange(event);
            });
        };
        this.handleCloseClick = () => {
            this.arcgisTableFieldSelectionClose.emit();
        };
        this.props = undefined;
        this.columnTemplates = undefined;
        this.attachmentsEnabled = false;
        this.popoverReferenceElement = undefined;
        this.sortBy = undefined;
        this.strings = undefined;
        this.currentLanguage = undefined;
        this.reRender = false;
        this.lastSortBy = _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_5__.L.display;
        this.filterFields = null;
        this.isOpen = false;
    }
    //--------------------------------------------------------------------------
    //
    //  Public Methods
    //
    //--------------------------------------------------------------------------
    async reposition() {
        var _a;
        (_a = this.popoverNode) === null || _a === void 0 ? void 0 : _a.reposition();
    }
    //--------------------------------------------------------------------------
    //
    //  Lifecycle
    //
    //--------------------------------------------------------------------------
    async componentWillLoad() {
        const { layer } = this.props;
        this.fieldsMap = await (0,_commonFunctions_b0830e9e_js__WEBPACK_IMPORTED_MODULE_4__.d)(layer);
        this.totalCounts = this.getTotalFieldTypeCount();
        this.lastSortBy = this.sortBy || _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_5__.L.default;
    }
    componentDidLoad() {
        this.reposition();
        this.isOpen = true;
        // need timeout because of re-render
        setTimeout(() => requestAnimationFrame(() => this.closeButtonNode.setFocus()), 200);
    }
    // --------------------------------------------------------------------------
    //
    //  Render Methods
    //
    //--------------------------------------------------------------------------
    render() {
        const { strings, popoverReferenceElement } = this;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)(_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.H, { class: "js-app-flyout" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-popover", { placement: "leading", dir: document.dir, open: this.isOpen, pointerDisabled: true, referenceElement: popoverReferenceElement, offsetDistance: -48, offsetSkidding: 0, class: CSS.popover, label: "", ref: this.afterCreatePopover }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow", { class: CSS.flow, ref: this.afterCreateFlow }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-flow-item", { heading: strings.fieldVisibility, ref: this.afterCreateFlowItem }, this.renderCloseButton(), this.renderDoneButton(), this.renderPickList())))));
    }
    renderCloseButton() {
        const { strings } = this;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { text: strings.close, scale: "s", slot: "header-actions-end", onClick: this.handleCloseClick, icon: "x", ref: this.afterCreateCloseButton }));
    }
    renderDoneButton() {
        const { strings } = this;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { appearance: "outline-fill", scale: "m", slot: "footer", width: "full", onClick: this.handleCloseClick, label: strings.done }, strings.done));
    }
    renderPickList() {
        const { strings } = this;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-pick-list", { class: "content", "drag-enabled": false, multiple: true, filterEnabled: true, filterPlaceholder: strings.filterFields, ref: this.afterCreatePickList, onCalciteListFilter: (event) => {
                const node = event.target;
                this.filterFields = node.filteredItems;
            } }, this.renderSelection(), this.renderSort(), this.renderPickListItems(), this.renderAttachmentPickListItem()));
    }
    renderSelection() {
        const { filterFields, strings } = this;
        const containsAll = this.filterContainsAll();
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-button", { key: `${filterFields}`, class: CSS.selectButton, appearance: "transparent", scale: "s", width: "full", onClick: () => this.handleSelectionAllClick(containsAll), label: containsAll ? strings.deselectAll : strings.selectAll }, containsAll ? strings.deselectAll : strings.selectAll));
    }
    renderSort() {
        const { lastSortBy, totalCounts, strings } = this;
        let hasNumberFields = totalCounts.number > 0;
        let hasStringFields = totalCounts.string > 0;
        let hasDateFields = totalCounts.date > 0;
        let canShowSort = hasNumberFields && (hasStringFields || hasDateFields)
            ? true
            : hasStringFields && hasDateFields
                ? true
                : false;
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown", { slot: "menu-actions", placement: "bottom-end", overlayPositioning: "fixed" }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { slot: "trigger", text: strings.sortFields, label: strings.sortFields, "aria-label": strings.sortFields }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "sortDescending" })), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-group", { "group-title": strings.sortBy }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { selected: lastSortBy === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_5__.L.default, onClick: () => {
                this.lastSortBy = _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_5__.L.default;
                this.fieldSortByChange.emit(this.lastSortBy);
            } }, strings.default), (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { selected: lastSortBy === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_5__.L.display, onClick: () => {
                this.lastSortBy = _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_5__.L.display;
                this.fieldSortByChange.emit(this.lastSortBy);
            } }, strings.sortByDisplayName), canShowSort ? ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { selected: lastSortBy === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_5__.L.type, onClick: () => {
                this.lastSortBy = _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_5__.L.type;
                this.fieldSortByChange.emit(this.lastSortBy);
            } }, strings.sortByType)) : null, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-dropdown-item", { selected: lastSortBy === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_5__.L.field, onClick: () => {
                this.lastSortBy = _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_5__.L.field;
                this.fieldSortByChange.emit(this.lastSortBy);
            } }, strings.sortByFieldName))));
    }
    renderPickListItems() {
        const { lastSortBy } = this;
        let columnTemplates = this.cloneFieldTemplates();
        if (lastSortBy === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_5__.L.display) {
            columnTemplates = this.sortFieldsAlphabetically(columnTemplates);
        }
        else if (lastSortBy === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_5__.L.type) {
            columnTemplates = this.sortFieldsByType(this.sortFieldsAlphabetically(columnTemplates));
        }
        else if (lastSortBy === _commonEnums_fcf13661_js__WEBPACK_IMPORTED_MODULE_5__.L.field) {
            columnTemplates.sort((a, b) => {
                return a.fieldName.localeCompare(b.fieldName);
            });
        }
        else ;
        return columnTemplates.map((columnTemplate) => this.renderPickListItem(columnTemplate));
    }
    renderPickListItem(columnTemplate) {
        const { strings, filterFields } = this;
        let isHidden = false;
        if (filterFields &&
            !filterFields.some((filterField) => filterField.value === columnTemplate.fieldName)) {
            isHidden = true;
        }
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-pick-list-item", { key: columnTemplate.fieldName, label: columnTemplate.label,
            //description={fieldConfig.name}
            value: columnTemplate.fieldName, selected: columnTemplate.visible, hidden: isHidden, ref: this.afterCreatePickListItem }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-action", { slot: "actions-end", text: strings.info, onClick: (event) => {
                event.stopPropagation();
                this.handleInfoClick(columnTemplate, event.target);
            } }, (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-icon", { scale: "s", icon: "information" }))));
    }
    renderAttachmentPickListItem() {
        const { layer } = this.props;
        const { strings, attachmentsEnabled } = this;
        if (layer.type === "imagery") {
            return null;
        }
        if (layer.type === "feature" && !hasAttachmentsEnabled(layer)) {
            return null;
        }
        return ((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.h)("calcite-pick-list-item", { key: "attachments", label: strings.photosAndFiles, description: strings.attachments, value: "__attachments", selected: attachmentsEnabled, hidden: false, ref: this.afterCreatePickListItemAttachments }));
    }
    handleSelectionAllClick(containsAll) {
        const { columnTemplates, filterFields } = this;
        // update fieldConfigs
        columnTemplates.forEach((columnTemplate) => {
            if (!filterFields ||
                filterFields.some((filterField) => filterField.value === columnTemplate.fieldName)) {
                columnTemplate.visible = !containsAll;
            }
        });
        // update pick-list-items
        this.pickListNode
            .querySelectorAll("calcite-pick-list-item")
            .forEach((item) => {
            if (!filterFields ||
                filterFields.some((filterField) => filterField.value === item.getAttribute("value"))) {
                if (!containsAll) {
                    item.setAttribute("selected", "true");
                }
                else {
                    item.removeAttribute("selected");
                }
            }
        });
        this.reRender = !this.reRender;
    }
    handleCalciteListItemChange({ detail: { value, selected } }) {
        const { columnTemplates } = this;
        columnTemplates.forEach((columnTemplate) => {
            if (columnTemplate.fieldName === value) {
                columnTemplate.visible = selected;
            }
        });
        // don't fire too many updates at once
        // e.g. after a user clicks 'Select all'
        if (this.waitHandler) {
            clearTimeout(this.waitHandler);
        }
        this.waitHandler = setTimeout(() => {
            this.waitHandler = null;
            this.columnTemplatesChange.emit(this.cloneFieldTemplates());
            // causes a state change
            this.reRender = !this.reRender;
        }, 100);
    }
    handleCalciteAttachmentsItemChange({ detail: { selected } }) {
        this.attachmentsChange.emit(selected);
        this.attachmentsEnabled = selected;
    }
    handleInfoClick(columnTemplate, action) {
        var _a;
        const { layer, view } = this.props;
        const { flowNode, firstPanelNode, currentLanguage } = this;
        const rect = firstPanelNode.getBoundingClientRect();
        const fieldInfo = document.createElement("arcgis-field-info");
        fieldInfo.lang = currentLanguage;
        fieldInfo.fieldName = columnTemplate.fieldName;
        fieldInfo.layer = layer;
        fieldInfo.view = view;
        fieldInfo.className = CSS.info;
        const fieldInfoFlowItem = document.createElement("calcite-flow-item");
        fieldInfoFlowItem.heading = (_a = columnTemplate.label) !== null && _a !== void 0 ? _a : columnTemplate.fieldName;
        fieldInfoFlowItem.description = columnTemplate.fieldName;
        // making the switch smoothly
        fieldInfoFlowItem.style.height = `${rect.height}px`;
        fieldInfoFlowItem.style.width = `${rect.width}px`;
        fieldInfoFlowItem.appendChild(fieldInfo);
        fieldInfoFlowItem.addEventListener("calciteFlowItemBack", () => requestAnimationFrame(() => action.setFocus()));
        flowNode.appendChild(fieldInfoFlowItem);
        setTimeout(() => fieldInfoFlowItem.setFocus(), 200);
        this.reposition();
    }
    cloneFieldTemplates() {
        return this.columnTemplates.map((columnTemplate) => {
            return Object.assign({}, columnTemplate);
        });
    }
    // check if filter contains all current field configs
    filterContainsAll() {
        const { columnTemplates, filterFields, attachmentsEnabled } = this;
        if (filterFields) {
            // attachment column is part of the filter, but not part of the fieldConfigs
            const filterFieldsFields = filterFields
                .filter((filterField) => filterField.value !== "__attachments")
                .map((filterField) => ({ value: filterField.value, selected: filterField.selected }));
            const fieldConfigsInFilter = columnTemplates.filter((columnTemplate) => filterFieldsFields.some((filterField) => columnTemplate.fieldName === filterField.value));
            let hasAttachments = filterFields.length !== filterFieldsFields.length;
            const containsAll = filterFieldsFields.every((filter) => !fieldConfigsInFilter.some((columnTemplate) => columnTemplate.fieldName === filter.value && !columnTemplate.visible));
            return containsAll && ((hasAttachments && attachmentsEnabled) || !hasAttachments);
        }
        else {
            return !columnTemplates.some((columnTemplate) => {
                return !columnTemplate.visible;
            });
        }
    }
    getTotalFieldTypeCount() {
        const { columnTemplates, fieldsMap } = this;
        const counts = { string: 0, number: 0, date: 0 };
        columnTemplates.forEach((columnTemplate) => {
            const field = fieldsMap.get(columnTemplate.fieldName);
            switch (field.type) {
                case "small-integer":
                case "big-integer":
                case "integer":
                case "single":
                case "double":
                case "long":
                case "oid":
                case "guid":
                    counts.number++;
                    break;
                case "string":
                    counts.string++;
                    break;
                case "date":
                case "date-only":
                case "time-only":
                case "timestamp-offset":
                    counts.date++;
                    break;
            }
        });
        return counts;
    }
    sortFieldsAlphabetically(columnTemplates) {
        return columnTemplates.sort((a, b) => {
            return a.label.charAt(0) === "_"
                ? 1
                : b.label.charAt(0) === "_"
                    ? -1
                    : a.label.localeCompare(b.label);
        });
    }
    sortFieldsByType(columnTemplates) {
        // order: number, string, date, oid, guid
        const { fieldsMap } = this;
        return columnTemplates
            .filter((columnTemplate) => ["small-integer", "big-integer", "integer", "single", "double", "long"].indexOf(fieldsMap.get(columnTemplate.fieldName).type) > -1)
            .map((columnTemplate) => {
            return columnTemplate;
        })
            .concat(columnTemplates
            .filter((columnTemplate) => fieldsMap.get(columnTemplate.fieldName).type === "string")
            .map((columnTemplate) => {
            return columnTemplate;
        }))
            .concat(columnTemplates
            .filter((columnTemplate) => ["date", "date-only", "time-only", "timestamp-offset"].indexOf(fieldsMap.get(columnTemplate.fieldName).type) > -1)
            .map((columnTemplate) => {
            return columnTemplate;
        }))
            .concat(columnTemplates
            .filter((columnTemplate) => fieldsMap.get(columnTemplate.fieldName).type === "oid")
            .map((columnTemplate) => {
            return columnTemplate;
        }))
            .concat(columnTemplates
            .filter((columnTemplate) => fieldsMap.get(columnTemplate.fieldName).type === "guid")
            .map((columnTemplate) => {
            return columnTemplate;
        }))
            .concat(columnTemplates
            .filter((columnTemplate) => [
            "small-integer",
            "big-integer",
            "integer",
            "single",
            "double",
            "long",
            "string",
            "date",
            "date-only",
            "time-only",
            "timestamp-offset",
            "oid",
            "guid"
        ].indexOf(fieldsMap.get(columnTemplate.fieldName).type) === -1)
            .map((columnTemplate) => {
            return columnTemplate;
        }));
    }
    get hostElement() { return (0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_0__.d)(this); }
};
ArcgisTableFieldSelection.style = arcgisTableFieldSelectionCss;



//# sourceMappingURL=arcgis-table_3.entry.js.map

/***/ }),

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/basic-6db7ebd7.js":
/*!***********************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/basic-6db7ebd7.js ***!
  \***********************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   a: () => (/* binding */ isDefined),
/* harmony export */   i: () => (/* binding */ isInNode),
/* harmony export */   s: () => (/* binding */ scales)
/* harmony export */ });
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v4.0.58
 */
var scales;
(function (scales) {
    scales["SMALL"] = "s";
    scales["MEDIUM"] = "m";
    scales["LARGE"] = "l";
})(scales || (scales = {}));
/**
 * Returns true if the value is defined
 * @param value - value to check
 */
function isDefined(value) {
    return value !== undefined && value !== null;
}
/**
 * Returns true if node has nodeName or is contained in a parent node with nodeName
 * @param node
 * @param nodeName
 */
function isInNode(node, nodeName) {
    while (node) {
        if (node.nodeName === nodeName.toUpperCase()) {
            return true;
        }
        node = node.parentElement;
    }
    return false;
}



//# sourceMappingURL=basic-6db7ebd7.js.map

/***/ }),

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/locale-050b6db9.js":
/*!************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/locale-050b6db9.js ***!
  \************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   a: () => (/* binding */ getComponentClosestLanguage),
/* harmony export */   g: () => (/* binding */ getLocaleComponentStrings)
/* harmony export */ });
/* harmony import */ var _dom_4d367677_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./dom-4d367677.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/dom-4d367677.js");
/* harmony import */ var _languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./languageUtil-ef0e54b2.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/languageUtil-ef0e54b2.js");
/* harmony import */ var _index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./index-e3bf7da7.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/index-e3bf7da7.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v4.0.58
 */




// https://medium.com/stencil-tricks/implementing-internationalisation-i18n-with-stencil-5e6559554117
function getComponentClosestLanguage(element) {
    var _a, _b, _c;
    const closestElement = (_a = (0,_dom_4d367677_js__WEBPACK_IMPORTED_MODULE_0__.c)(element, "[lang]")) !== null && _a !== void 0 ? _a : (_c = (_b = element.shadowRoot) === null || _b === void 0 ? void 0 : _b.ownerDocument) === null || _c === void 0 ? void 0 : _c.documentElement;
    // language set by the calling application or browser. defaults to english.
    const lang = ((closestElement === null || closestElement === void 0 ? void 0 : closestElement.lang) || (navigator === null || navigator === void 0 ? void 0 : navigator.language) || "en").toLowerCase();
    if (_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_1__.l.has(lang)) {
        return _languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_1__.l.get(lang);
    }
    else {
        // "ru-RU" maps to "ru" use case
        if (_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_1__.l.has(lang.slice(0, 2))) {
            return _languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_1__.l.get(lang.slice(0, 2));
        }
        else {
            return "en";
        }
    }
}
function getComponentClosestLanguageIntl(element) {
    var _a, _b, _c;
    // it's OK if we don't have the 4 letter language file for it
    // 4 letter language code needed for formatting numbers
    const closestElement = (_a = (0,_dom_4d367677_js__WEBPACK_IMPORTED_MODULE_0__.c)(element, "[lang]")) !== null && _a !== void 0 ? _a : (_c = (_b = element.shadowRoot) === null || _b === void 0 ? void 0 : _b.ownerDocument) === null || _c === void 0 ? void 0 : _c.documentElement;
    // language set by the calling application or browser. defaults to english.
    const lang = ((closestElement === null || closestElement === void 0 ? void 0 : closestElement.lang) || (navigator === null || navigator === void 0 ? void 0 : navigator.language) || "en").toLowerCase();
    if (_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_1__.l.has(lang)) {
        return _languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_1__.l.get(lang);
    }
    else {
        if (_languageUtil_ef0e54b2_js__WEBPACK_IMPORTED_MODULE_1__.l.has(lang.slice(0, 2))) {
            // we support the 2 letter coded language
            // e.g. it-CH vs it
            return lang;
        }
        else {
            return "en";
        }
    }
}
function fetchLocaleStringsForComponent(componentName, locale) {
    return new Promise((resolve, reject) => {
        fetch((0,_index_e3bf7da7_js__WEBPACK_IMPORTED_MODULE_2__.a)(`../arcgis-app-assets/i18n/${componentName}.i18n.${locale}.json`)).then((result) => {
            if (result.ok)
                resolve(result.json());
            else
                reject();
        }, () => reject());
    });
}
const stringCache = {};
function fetchLocaleStringsFromCache(componentName, locale) {
    const id = `${componentName}${locale}`;
    if (!stringCache[id]) {
        stringCache[id] = fetchLocaleStringsForComponent(componentName, locale);
    }
    return stringCache[id];
}
/**
 * Get strings and language codes.
 * This method returns 2 language codes.
 * The first one returns a code that's also supported as a language file.
 * The second one returns a code where there is support for the first 2 letters of the code as part of a language file,
 * but will return the original 4 letter code from the page.
 * E.g. For "it-ch" it will return "it" as the first language code and "it-ch" as the second.
 * The second one is required for esri.intl.setLocale() to get the correct formatting.
 *
 * If a tagName is provided it will overwite the element's tagName
 *
 *  @return [ strings, first language code, second language code]
 */
async function getLocaleComponentStrings(element, tagName) {
    const componentName = tagName || element.tagName.toLowerCase();
    const componentLanguage = getComponentClosestLanguage(element);
    const componentLanguageIntl = getComponentClosestLanguageIntl(element);
    let strings;
    try {
        strings = await fetchLocaleStringsFromCache(componentName, componentLanguage);
    }
    catch (e) {
        console.warn(`no locale for ${componentName} (${componentLanguage}) loading default locale en.`);
        strings = await fetchLocaleStringsFromCache(componentName, "en");
    }
    return [strings, componentLanguage, componentLanguageIntl];
}



//# sourceMappingURL=locale-050b6db9.js.map

/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0cy9jaHVua3MvYXJjZ2lzX2FuYWx5c2lzX25vZGVfbW9kdWxlc19hcmNnaXNfYXBwLWNvbXBvbmVudHNfZGlzdF9lc21fYXJjZ2lzLThmMTk4OS5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQzRIO0FBQ3REO0FBQ1Q7QUFDSTtBQUMyRjtBQUN6RTtBQUNEO0FBQ3ZEOztBQUUzQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFlBQVksZ0JBQWdCLFFBQVEsb0JBQW9CLGdCQUFnQiwrQkFBK0I7QUFDdkc7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGVBQWUsK0RBQWM7QUFDN0I7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDREQUE0RCwyREFBVztBQUN2RTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSw4Q0FBOEMsV0FBVyx5QkFBeUIsWUFBWSxhQUFhLHlCQUF5QixZQUFZLDRCQUE0QixZQUFZLHVCQUF1QixtQkFBbUIsMkNBQTJDLDhCQUE4QixvQkFBb0IscUJBQXFCLHVCQUF1QixZQUFZLHlCQUF5QixtQkFBbUIseURBQXlELHVCQUF1Qjs7QUFFbmY7QUFDQTtBQUNBLFFBQVEscURBQWdCO0FBQ3hCLHNDQUFzQyxxREFBVztBQUNqRCwwQ0FBMEMscURBQVc7QUFDckQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFD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QUNBLHNDQUFzQyxlQUFlLEdBQUcsa0JBQWtCO0FBQzFFO0FBQ0E7QUFDQTtBQUNBOztBQUU0RTs7QUFFNUUiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9leGItY2xpZW50Ly4vZXh0ZW5zaW9ucy93aWRnZXRzL2FyY2dpcy9hbmFseXNpcy9ub2RlX21vZHVsZXMvQGFyY2dpcy9hcHAtY29tcG9uZW50cy9kaXN0L2VzbS9hcmNnaXMtdGFibGVfMy5lbnRyeS5qcyIsIndlYnBhY2s6Ly9leGItY2xpZW50Ly4vZXh0ZW5zaW9ucy93aWRnZXRzL2FyY2dpcy9hbmFseXNpcy9ub2RlX21vZHVsZXMvQGFyY2dpcy9hcHAtY29tcG9uZW50cy9kaXN0L2VzbS9iYXNpYy02ZGI3ZWJkNy5qcyIsIndlYnBhY2s6Ly9leGItY2xpZW50Ly4vZXh0ZW5zaW9ucy93aWRnZXRzL2FyY2dpcy9hbmFseXNpcy9ub2RlX21vZHVsZXMvQGFyY2dpcy9hcHAtY29tcG9uZW50cy9kaXN0L2VzbS9sb2NhbGUtMDUwYjZkYjkuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBBbGwgbWF0ZXJpYWwgY29weXJpZ2h0IEVTUkksIEFsbCBSaWdodHMgUmVzZXJ2ZWQsIHVubGVzcyBvdGhlcndpc2Ugc3BlY2lmaWVkLlxuICogdjQuMC41OFxuICovXG5pbXBvcnQgeyByIGFzIHJlZ2lzdGVySW5zdGFuY2UsIGMgYXMgY3JlYXRlRXZlbnQsIGgsIEggYXMgSG9zdCwgRiBhcyBGcmFnbWVudCwgZCBhcyBnZXRFbGVtZW50IH0gZnJvbSAnLi9pbmRleC1lM2JmN2RhNy5qcyc7XG5pbXBvcnQgeyBnIGFzIGdldExvY2FsZUNvbXBvbmVudFN0cmluZ3MgfSBmcm9tICcuL2xvY2FsZS0wNTBiNmRiOS5qcyc7XG5pbXBvcnQgeyBsIGFzIGxvYWRNb2R1bGVzIH0gZnJvbSAnLi9sb2FkTW9kdWxlcy1iNGFjMTI0Ny5qcyc7XG5pbXBvcnQgeyBpIGFzIGlzSW5Ob2RlLCBzIGFzIHNjYWxlcyB9IGZyb20gJy4vYmFzaWMtNmRiN2ViZDcuanMnO1xuaW1wb3J0IHsgYyBhcyBnZXRTZXJ2aWNlVHlwZSwgbiBhcyBnZXRSYXN0ZXJDb3VudCwgZyBhcyBnZXRGZWF0dXJlQ291bnQsIGkgYXMgaXNEZWZpbmVkLCBkIGFzIGdlbmVyYXRlTGF5ZXJGaWVsZHNNYXAgfSBmcm9tICcuL2NvbW1vbkZ1bmN0aW9ucy1iMDgzMGU5ZS5qcyc7XG5pbXBvcnQgeyBzIGFzIHNlcnZpY2VUeXBlRW51bSwgTCBhcyBMYXN0U29ydHlCeSB9IGZyb20gJy4vY29tbW9uRW51bXMtZmNmMTM2NjEuanMnO1xuaW1wb3J0IHsgZyBhcyBnZXRFbGVtZW50RGlyLCBDIGFzIENTU19VVElMSVRZIH0gZnJvbSAnLi9sYW5ndWFnZVV0aWwtZWYwZTU0YjIuanMnO1xuaW1wb3J0ICcuL2RvbS00ZDM2NzY3Ny5qcyc7XG5cbmNvbnN0IENTUyQyID0ge1xuICAgIGhvc3Q6IFwiaG9zdFwiLFxuICAgIGNvbnRlbnQ6IFwiY29udGVudFwiLFxuICAgIG1hbmFnZXI6IFwibWFuYWdlclwiLFxuICAgIGFjdGlvbkJhcjogXCJhY3Rpb24tYmFyXCIsXG4gICAgbWVudUFjdGlvbnM6IFwibWVudS1hY3Rpb25zXCIsXG4gICAgdGFibGU6IFwidGFibGVcIixcbiAgICB0b29sdGlwOiBcInRvb2x0aXBcIlxufTtcblxuLyoqXG4gKiBSZXR1cm5zIHRydWUgaWYgdGhlIGxheWVyIHN1cHBvcnRzIGF0dGFjaG1lbnRzXG4gKiBAcGFyYW0gbGF5ZXIgLSBGZWF0dXJlTGF5ZXJcbiAqL1xuZnVuY3Rpb24gaGFzQXR0YWNobWVudHNFbmFibGVkKGxheWVyKSB7XG4gICAgaWYgKCEobGF5ZXIgPT09IG51bGwgfHwgbGF5ZXIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGxheWVyLmNhcGFiaWxpdGllcykpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBjb25zdCB7IGNhcGFiaWxpdGllczogeyBkYXRhOiB7IHN1cHBvcnRzQXR0YWNobWVudCB9LCBvcGVyYXRpb25zOiB7IHN1cHBvcnRzUXVlcnlBdHRhY2htZW50cyB9IH0gfSA9IGxheWVyO1xuICAgIHJldHVybiBzdXBwb3J0c0F0dGFjaG1lbnQgJiYgc3VwcG9ydHNRdWVyeUF0dGFjaG1lbnRzO1xufVxuLyoqXG4gKiBSZXR1cm5zIHRoZSBsYXllciB0eXBlLCBhbmQgXCJzdWJsYXllclwiIGZvciBTdWJsYXllclxuICogQHBhcmFtIGxheWVyIC0gRmVhdHVyZUxheWVyXG4gKi9cbmZ1bmN0aW9uIGdldExheWVyVHlwZShsYXllcikge1xuICAgIGlmIChsYXllci5kZWNsYXJlZENsYXNzID09PSBcImVzcmkubGF5ZXJzLnN1cHBvcnQuU3VibGF5ZXJcIikge1xuICAgICAgICByZXR1cm4gXCJzdWJsYXllclwiO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGdldFNlcnZpY2VUeXBlKGxheWVyKTtcbiAgICB9XG59XG5cbi8qKlxuICogZ2l2ZXMgdGhlIHBhcmFtZXRlcnMgZm9yIGlkZW50aWZ5XG4gKiBAcGFyYW0gZXh0ZW50IC0gZXh0ZW50IGF0IHdoaWNoIHRoZSBpZGVudGlmeSBzaG91bGQgYmUgZG9uZVxuICogQHBhcmFtIG1hcCAtIG1hcCBvYmplY3RcbiAqIEBwYXJhbSBsYXllciAtIHRoZSBsYXllciBvbiB3aGljaCBpZGVudGlmeSBzaG91bGQgcGVyZm9ybVxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRJZGVudGlmeVBhcmFtcyhleHRlbnQsIG1hcCwgbGF5ZXIpIHtcbiAgICBjb25zdCBbUG9seWdvbiwgUG9pbnQsIEltYWdlSWRlbnRpZnlQYXJhbWV0ZXJzXSA9IGF3YWl0IGxvYWRNb2R1bGVzKFtcbiAgICAgICAgXCJlc3JpL2dlb21ldHJ5L1BvbHlnb25cIixcbiAgICAgICAgXCJlc3JpL2dlb21ldHJ5L1BvaW50XCIsXG4gICAgICAgIFwiZXNyaS9yZXN0L3N1cHBvcnQvSW1hZ2VJZGVudGlmeVBhcmFtZXRlcnNcIlxuICAgIF0pO1xuICAgIGNvbnN0IHBvbHlnb24gPSBuZXcgUG9seWdvbihleHRlbnQuc3BhdGlhbFJlZmVyZW5jZSk7XG4gICAgcG9seWdvbi5hZGRSaW5nKFtcbiAgICAgICAgW2V4dGVudC54bWluLCBleHRlbnQueW1pbl0sXG4gICAgICAgIFtleHRlbnQueG1pbiwgZXh0ZW50LnltYXhdLFxuICAgICAgICBbZXh0ZW50LnhtYXgsIGV4dGVudC55bWF4XSxcbiAgICAgICAgW2V4dGVudC54bWF4LCBleHRlbnQueW1pbl0sXG4gICAgICAgIFtleHRlbnQueG1pbiwgZXh0ZW50LnltaW5dXG4gICAgXSk7XG4gICAgY29uc3QgcHNYID0gKGV4dGVudC54bWF4IC0gZXh0ZW50LnhtaW4pIC8gbWFwLndpZHRoO1xuICAgIGNvbnN0IHBzWSA9IChleHRlbnQueW1heCAtIGV4dGVudC55bWluKSAvIG1hcC5oZWlnaHQ7XG4gICAgY29uc3QgcHNTUiA9IGV4dGVudC5zcGF0aWFsUmVmZXJlbmNlO1xuICAgIGNvbnN0IHBpeGVsU2l6ZSA9IG5ldyBQb2ludChwc1gsIHBzWSwgcHNTUik7XG4gICAgLy8gR2VuZXJhdGUgVGFzayBQYXJhbXNcbiAgICBjb25zdCB0YXNrUGFyYW1zID0gbmV3IEltYWdlSWRlbnRpZnlQYXJhbWV0ZXJzKCk7XG4gICAgdGFza1BhcmFtcy5nZW9tZXRyeSA9IHBvbHlnb247XG4gICAgdGFza1BhcmFtcy5yZXR1cm5HZW9tZXRyeSA9IHRydWU7XG4gICAgdGFza1BhcmFtcy5waXhlbFNpemUgPSBwaXhlbFNpemU7XG4gICAgY29uc3QgbW9zYWljUnVsZSA9IGxheWVyLm1vc2FpY1J1bGUuY2xvbmUoKTtcbiAgICBpZiAobGF5ZXIuZGVmaW5pdGlvbkV4cHJlc3Npb24pIHtcbiAgICAgICAgbW9zYWljUnVsZS53aGVyZSA9IGxheWVyLmRlZmluaXRpb25FeHByZXNzaW9uO1xuICAgIH1cbiAgICB0YXNrUGFyYW1zLm1vc2FpY1J1bGUgPSBtb3NhaWNSdWxlO1xuICAgIHJldHVybiB0YXNrUGFyYW1zO1xufVxuXG5jb25zdCBhcmNnaXNUYWJsZUNzcyA9IFwiLmhvc3Quc2MtYXJjZ2lzLXRhYmxle3dpZHRoOjEwMCV9LmNvbnRlbnQuc2MtYXJjZ2lzLXRhYmxle2hlaWdodDoxMDAlO2Rpc3BsYXk6ZmxleH0ubWFuYWdlci5zYy1hcmNnaXMtdGFibGV7aGVpZ2h0OjEwMCV9LmFjdGlvbi1iYXIuc2MtYXJjZ2lzLXRhYmxle2hlaWdodDoxMDAlO2JvcmRlci13aWR0aDowIDFweCAwIDA7Ym9yZGVyLXN0eWxlOnNvbGlkO2JvcmRlci1jb2xvcjp2YXIoLS1jYWxjaXRlLWNvbG9yLWJvcmRlci0yKX0ubWVudS1hY3Rpb25zLnNjLWFyY2dpcy10YWJsZXtkaXNwbGF5OmlubGluZS1mbGV4O2p1c3RpZnktc2VsZjpzdHJldGNofS50YWJsZS5zYy1hcmNnaXMtdGFibGV7aGVpZ2h0OjEwMCV9LnRvb2x0aXAuc2MtYXJjZ2lzLXRhYmxle3doaXRlLXNwYWNlOm5vd3JhcH0uYXJjZ2lzLS1ydGwuc2MtYXJjZ2lzLXRhYmxlIC5hY3Rpb24tYmFyLnNjLWFyY2dpcy10YWJsZXtib3JkZXItd2lkdGg6MCAwIDAgMXB4fVwiO1xuXG5jb25zdCBBcmNnaXNUYWJsZSA9IGNsYXNzIHtcbiAgICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgICAgIHJlZ2lzdGVySW5zdGFuY2UodGhpcywgaG9zdFJlZik7XG4gICAgICAgIHRoaXMuYXJjZ2lzVGFibGVTY2FsZUNoYW5nZSA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzVGFibGVTY2FsZUNoYW5nZVwiLCA3KTtcbiAgICAgICAgdGhpcy5hcmNnaXNUYWJsZURpc21pc3NlZENoYW5nZSA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiYXJjZ2lzVGFibGVEaXNtaXNzZWRDaGFuZ2VcIiwgNyk7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWRPbmx5TW9kZSA9IGZhbHNlO1xuICAgICAgICB0aGlzLnJlY29yZHNDb3VudCA9IDA7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWRDb3VudCA9IDA7XG4gICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICAgIC8vXG4gICAgICAgIC8vICBQcml2YXRlIG1ldGhvZHNcbiAgICAgICAgLy9cbiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAgICAgdGhpcy5wYW5lbEtleURvd25IYW5kbGVyID0gKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICBpZiAodGhpcy5kaXNtaXNzaWJsZSAmJiBldmVudC5rZXkgPT09IFwiRXNjYXBlXCIgJiYgIWV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUNsb3NlQ2xpY2soKTtcbiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLmFmdGVyQ3JlYXRlUGFuZWwgPSBhc3luYyAobm9kZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgeyBsYXllciwgdmlldyB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgICAgIGlmIChsYXllci50eXBlID09PSBcImltYWdlcnlcIikge1xuICAgICAgICAgICAgICAgIHRoaXMucmVjb3Jkc0NvdW50ID0gYXdhaXQgZ2V0UmFzdGVyQ291bnQobGF5ZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAobGF5ZXIudHlwZSA9PT0gXCJ3ZnNcIikge1xuICAgICAgICAgICAgICAgIHRoaXMucmVjb3Jkc0NvdW50ID0gYXdhaXQgbGF5ZXIucXVlcnlGZWF0dXJlQ291bnQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMucmVjb3Jkc0NvdW50ID0gYXdhaXQgZ2V0RmVhdHVyZUNvdW50KGxheWVyLCB2aWV3KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuZGlzcGxheUNvdW50KCk7XG4gICAgICAgICAgICB0aGlzLnBhbmVsTm9kZSA9IG5vZGU7XG4gICAgICAgICAgICB0aGlzLndhdGNoVGl0bGVIYW5kbGVyID0gbGF5ZXIud2F0Y2goXCJ0aXRsZVwiLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuYWZ0ZXJDcmVhdGVDbG9zZUJ1dHRvbiA9IChub2RlKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmNsb3NlQnV0dG9uTm9kZSA9IG5vZGU7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuYWZ0ZXJDcmVhdGVUYWJsZU5vZGUgPSAobm9kZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgeyBwcm9wcywgc2VsZWN0ZWRGZWF0dXJlSWRzLCByZWFjdGl2ZVV0aWxzLCBzdXBwb3J0c1NlbGVjdGlvbiB9ID0gdGhpcztcbiAgICAgICAgICAgIGNvbnN0IHsgbGF5ZXIsIHZpZXcgfSA9IHByb3BzO1xuICAgICAgICAgICAgY29uc3QgeyB0YWJsZSB9ID0gdGhpcztcbiAgICAgICAgICAgIGlmICh0YWJsZSkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHsgdGFibGVUZW1wbGF0ZSB9ID0gdGhpcztcbiAgICAgICAgICAgIGNvbnN0IHN1cHBvcnRzRWRpdGluZyA9IGxheWVyLnR5cGUgPT09IFwiZmVhdHVyZVwiICYmIGxheWVyLmVmZmVjdGl2ZUVkaXRpbmdFbmFibGVkO1xuICAgICAgICAgICAgdGhpcy50YWJsZSA9IG5ldyB0aGlzLkZlYXR1cmVUYWJsZSh7XG4gICAgICAgICAgICAgICAgbGF5ZXIsXG4gICAgICAgICAgICAgICAgdmlldyxcbiAgICAgICAgICAgICAgICB0YWJsZVRlbXBsYXRlLFxuICAgICAgICAgICAgICAgIGVkaXRpbmdFbmFibGVkOiBzdXBwb3J0c0VkaXRpbmcsXG4gICAgICAgICAgICAgICAgYXR0YWNobWVudHNFbmFibGVkOiBsYXllci50eXBlID09PSBcImZlYXR1cmVcIiAmJiBoYXNBdHRhY2htZW50c0VuYWJsZWQobGF5ZXIpLFxuICAgICAgICAgICAgICAgIGhpZ2hsaWdodE9uUm93U2VsZWN0RW5hYmxlZDogc3VwcG9ydHNTZWxlY3Rpb24sXG4gICAgICAgICAgICAgICAgbXVsdGlTb3J0RW5hYmxlZDogZmFsc2UsXG4gICAgICAgICAgICAgICAgdmlzaWJsZUVsZW1lbnRzOiB7XG4gICAgICAgICAgICAgICAgICAgIGhlYWRlcjogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgIG1lbnU6IGZhbHNlXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBjb250YWluZXI6IG5vZGVcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgLy8gaGlkZSBzZWxlY3Rpb24gY2hlY2tib3hlc1xuICAgICAgICAgICAgaWYgKCFzdXBwb3J0c1NlbGVjdGlvbikge1xuICAgICAgICAgICAgICAgIHRoaXMudGFibGUuZ3JpZC52aXNpYmxlRWxlbWVudHMgPSB7IHNlbGVjdGlvbkNvbHVtbjogZmFsc2UgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMud2F0Y2hIbmRsU2l6ZSA9IHJlYWN0aXZlVXRpbHMud2F0Y2goKCkgPT4gdGhpcy50YWJsZS52aWV3TW9kZWwuc2l6ZSwgKGNvdW50KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZWNvcmRzQ291bnQgPSBjb3VudDtcbiAgICAgICAgICAgICAgICB0aGlzLmRpc3BsYXlDb3VudCgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpZiAoc3VwcG9ydHNTZWxlY3Rpb24pIHtcbiAgICAgICAgICAgICAgICB0aGlzLnRhYmxlLmhpZ2hsaWdodElkcy5vbihcImNoYW5nZVwiLCAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQucmVtb3ZlZC5mb3JFYWNoKChvYmplY3RJZCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaWR4ID0gc2VsZWN0ZWRGZWF0dXJlSWRzLmluZGV4T2Yob2JqZWN0SWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlkeCA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRGZWF0dXJlSWRzLnNwbGljZShpZHgsIDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQuYWRkZWQuZm9yRWFjaCgob2JqZWN0SWQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3RlZEZlYXR1cmVJZHMuaW5kZXhPZihvYmplY3RJZCkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRGZWF0dXJlSWRzLnB1c2gob2JqZWN0SWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSAvLyBjb3VsZCBoYXBwZW4gYWZ0ZXIgY2xpY2tpbmcgZm9yIHBvcHVwXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkQ291bnQgPSBzZWxlY3RlZEZlYXR1cmVJZHMubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc3BsYXlDb3VudCgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2tSYXN0ZXJzKCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVSZW5kZXIgPSAhdGhpcy5yZVJlbmRlcjtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB0aGlzLndhdGNoSG5kbEFjdGl2ZSA9IHJlYWN0aXZlVXRpbHMud2F0Y2goKCkgPT4geyB2YXIgX2EsIF9iOyByZXR1cm4gKF9iID0gKF9hID0gdmlldy5wb3B1cCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnZpZXdNb2RlbCkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmFjdGl2ZTsgfSwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBzZWxlY3RlZEZlYXR1cmUgPSB2aWV3LnBvcHVwLnNlbGVjdGVkRmVhdHVyZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGVjdGVkRmVhdHVyZSAmJiB2aWV3LnBvcHVwLnZpc2libGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRlbGV0ZSBlbnRpcmUgc2VsZWN0aW9uIGluIHRhYmxlXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRhYmxlLmhpZ2hsaWdodElkcy5yZW1vdmVBbGwoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG9ubHkgYWRkIHBvcHVwIGZlYXR1cmVzXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpZCA9IHZpZXcucG9wdXAuc2VsZWN0ZWRGZWF0dXJlLmdldE9iamVjdElkKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRhYmxlLmhpZ2hsaWdodElkcy5wdXNoKGlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkRmVhdHVyZUlkcy5wdXNoKGlkKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChzZWxlY3RlZEZlYXR1cmUgJiYgIXZpZXcucG9wdXAudmlzaWJsZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gcG9wdXAgZ290IGNsb3NlZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRlbGV0ZSBlbnRpcmUgc2VsZWN0aW9uIGluIHRhYmxlXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRhYmxlLmhpZ2hsaWdodElkcy5yZW1vdmVBbGwoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLmhhbmRsZUVkaXRpbmdDbGljayA9ICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gdGhpcztcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlRWRpdGluZ1BvcG92ZXIoKTtcbiAgICAgICAgICAgIHRoaXMuZWRpdGluZ1BvcG92ZXJOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy10YWJsZS1lZGl0aW5nLXBvcG92ZXJcIik7XG4gICAgICAgICAgICB0aGlzLmVkaXRpbmdQb3BvdmVyTm9kZS5yZWZlcmVuY2VFbGVtZW50ID0gdGhpcy5lZGl0aW5nQWN0aW9uTm9kZTtcbiAgICAgICAgICAgIHRoaXMuZWRpdGluZ1BvcG92ZXJOb2RlLnN0cmluZ3MgPSBzdHJpbmdzO1xuICAgICAgICAgICAgdGhpcy5lZGl0aW5nUG9wb3Zlck5vZGUuYWRkRXZlbnRMaXN0ZW5lcihcImFyY2dpc1RhYmxlRWRpdGluZ1BvcG92ZXJDbG9zZVwiLCAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUVkaXRpbmdQb3BvdmVyKCk7XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLmVkaXRpbmdBY3Rpb25Ob2RlLnNldEZvY3VzKCksIDIwMCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRoaXMuZWRpdGluZ1BvcG92ZXJOb2RlLmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNUYWJsZUVkaXRpbmdQb3BvdmVyRGlzY29ubmVjdGVkXCIsIChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlRWRpdGluZ1BvcG92ZXIoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLmVkaXRpbmdQb3BvdmVyTm9kZSk7XG4gICAgICAgICAgICB0aGlzLmVkaXRpbmdQb3BvdmVyTm9kZS5zZXRPcGVuKHRydWUpO1xuICAgICAgICAgICAgLy8gbmVlZCB0byB3YWl0IHVudGlsIGl0J3MgYWxsIHZpc2libGVcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5lZGl0aW5nUG9wb3Zlck5vZGUuc2V0Rm9jdXMoKSwgMTAwKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5oYW5kbGVWaXNpYmlsaXR5Q2xpY2sgPSAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkU2VsZWN0aW9uUG9wb3Zlcikge1xuICAgICAgICAgICAgICAgIC8vIGFscmVhZHkgb3BlbiwgZG8gbm90aGluZ1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCB0aGlzLmNsaWNrSGFuZGxlcik7XG4gICAgICAgICAgICBjb25zdCB7IGxheWVyIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICAgICAgY29uc3QgeyBwcm9wcywgc3RyaW5ncywgY3VycmVudExhbmd1YWdlSW50bCwgdGFibGVUZW1wbGF0ZSwgdGFibGUsIGZpZWxkU29ydE9yZGVyIH0gPSB0aGlzO1xuICAgICAgICAgICAgY29uc3QgcG9wb3ZlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtdGFibGUtZmllbGQtc2VsZWN0aW9uXCIpO1xuICAgICAgICAgICAgcG9wb3Zlci5wcm9wcyA9IHByb3BzO1xuICAgICAgICAgICAgcG9wb3Zlci5zdHJpbmdzID0gc3RyaW5ncztcbiAgICAgICAgICAgIHBvcG92ZXIuY3VycmVudExhbmd1YWdlID0gY3VycmVudExhbmd1YWdlSW50bDtcbiAgICAgICAgICAgIHBvcG92ZXIuY29sdW1uVGVtcGxhdGVzID0gdGFibGVUZW1wbGF0ZS5jb2x1bW5UZW1wbGF0ZXM7XG4gICAgICAgICAgICBwb3BvdmVyLnNvcnRCeSA9IGZpZWxkU29ydE9yZGVyO1xuICAgICAgICAgICAgcG9wb3Zlci5hdHRhY2htZW50c0VuYWJsZWQgPVxuICAgICAgICAgICAgICAgIGxheWVyLnR5cGUgPT09IFwiZmVhdHVyZVwiICYmIGhhc0F0dGFjaG1lbnRzRW5hYmxlZChsYXllcikgPyB0YWJsZS5hdHRhY2htZW50c0VuYWJsZWQgOiBmYWxzZTtcbiAgICAgICAgICAgIHBvcG92ZXIucG9wb3ZlclJlZmVyZW5jZUVsZW1lbnQgPSBldmVudC50YXJnZXQ7XG4gICAgICAgICAgICBwb3BvdmVyLmFkZEV2ZW50TGlzdGVuZXIoXCJjb2x1bW5UZW1wbGF0ZXNDaGFuZ2VcIiwgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVUYWJsZShuZXcgdGhpcy5UYWJsZVRlbXBsYXRlKHsgY29sdW1uVGVtcGxhdGVzOiBldmVudC5kZXRhaWwgfSkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBwb3BvdmVyLmFkZEV2ZW50TGlzdGVuZXIoXCJhdHRhY2htZW50c0NoYW5nZVwiLCAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICB0aGlzLnRhYmxlLmF0dGFjaG1lbnRzRW5hYmxlZCA9IGV2ZW50LmRldGFpbDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcG9wb3Zlci5hZGRFdmVudExpc3RlbmVyKFwiZmllbGRTb3J0QnlDaGFuZ2VcIiwgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5maWVsZFNvcnRPcmRlciA9IGV2ZW50LmRldGFpbDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcG9wb3Zlci5hZGRFdmVudExpc3RlbmVyKFwiYXJjZ2lzVGFibGVGaWVsZFNlbGVjdGlvbkNsb3NlXCIsICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmNsb3NlUG9wb3ZlcnMoKTtcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuc2V0dGluZ3NBY3Rpb25Ob2RlLnNldEZvY3VzKCksIDIwMCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQocG9wb3Zlcik7XG4gICAgICAgICAgICB0aGlzLmZpZWxkU2VsZWN0aW9uUG9wb3ZlciA9IHBvcG92ZXI7XG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCB0aGlzLmNsaWNrSGFuZGxlciksIDIwMCk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuY2xpY2tIYW5kbGVyID0gKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuZmllbGRTZWxlY3Rpb25Qb3BvdmVyKSB7XG4gICAgICAgICAgICAgICAgLy8gcG9wb3ZlciBnb3QgcmVtb3ZlZCBhbm90aGVyIHdheVxuICAgICAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCB0aGlzLmNsaWNrSGFuZGxlcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmICghaXNJbk5vZGUoZXZlbnQudGFyZ2V0LCBcImFyY2dpcy10YWJsZS1maWVsZC1zZWxlY3Rpb25cIikpIHtcbiAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuZmllbGRTZWxlY3Rpb25Qb3BvdmVyKTtcbiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkU2VsZWN0aW9uUG9wb3ZlciA9IG51bGw7XG4gICAgICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIHRoaXMuY2xpY2tIYW5kbGVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5oYW5kbGVIb21lQ2xpY2sgPSAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IHZpZXcsIGluaXRpYWxWaWV3cG9pbnQgfSA9IHRoaXM7XG4gICAgICAgICAgICB2aWV3LmdvVG8oaW5pdGlhbFZpZXdwb2ludCk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuaGFuZGxlWm9vbVRvQ2xpY2sgPSAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IGxheWVyLCB2aWV3LCBzZWxlY3RlZEZlYXR1cmVJZHMsIFF1ZXJ5IH0gPSB0aGlzO1xuICAgICAgICAgICAgaWYgKGdldExheWVyVHlwZShsYXllcikgPT09IFwiaW1hZ2VyeVwiKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcXVlcnkgPSBuZXcgUXVlcnkoKTtcbiAgICAgICAgICAgICAgICBxdWVyeS5vdXRTcGF0aWFsUmVmZXJlbmNlID0gdmlldy5zcGF0aWFsUmVmZXJlbmNlO1xuICAgICAgICAgICAgICAgIHF1ZXJ5Lm9iamVjdElkcyA9IFsuLi5zZWxlY3RlZEZlYXR1cmVJZHNdO1xuICAgICAgICAgICAgICAgIHF1ZXJ5LnJldHVybkdlb21ldHJ5ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBsYXllci5xdWVyeVJhc3RlcnMocXVlcnkpLnRoZW4oKHJlc3VsdHMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdmlldy5nb1RvKHJlc3VsdHMuZmVhdHVyZXMpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcXVlcnkgPSBsYXllci5jcmVhdGVRdWVyeSgpO1xuICAgICAgICAgICAgICAgIHF1ZXJ5Lm91dFNwYXRpYWxSZWZlcmVuY2UgPSB2aWV3LnNwYXRpYWxSZWZlcmVuY2U7XG4gICAgICAgICAgICAgICAgcXVlcnkub2JqZWN0SWRzID0gWy4uLnNlbGVjdGVkRmVhdHVyZUlkc107XG4gICAgICAgICAgICAgICAgcXVlcnkucmV0dXJuR2VvbWV0cnkgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGxheWVyLnF1ZXJ5RmVhdHVyZXMocXVlcnkpLnRoZW4oKHJlc3VsdHMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdmlldy5nb1RvKHJlc3VsdHMuZmVhdHVyZXMpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLmhhbmRsZUNsZWFyQ2xpY2sgPSAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IHRhYmxlLCBzdXBwb3J0c1NlbGVjdGlvbiB9ID0gdGhpcztcbiAgICAgICAgICAgIGNvbnN0IHsgdmlld01vZGVsLCBncmlkIH0gPSB0YWJsZTtcbiAgICAgICAgICAgIHRhYmxlLmhpZ2hsaWdodElkcy5yZW1vdmVBbGwoKTtcbiAgICAgICAgICAgIHZpZXdNb2RlbC5jbGVhclNlbGVjdGlvbkZpbHRlcigpO1xuICAgICAgICAgICAgdGhpcy5zZWxlY3RlZE9ubHlNb2RlID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAoc3VwcG9ydHNTZWxlY3Rpb24pIHtcbiAgICAgICAgICAgICAgICBncmlkLnZpc2libGVFbGVtZW50cyA9IHsgc2VsZWN0aW9uQ29sdW1uOiB0cnVlIH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuaGFuZGxlU2hvd1NlbGVjdGVkQ2xpY2sgPSAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IHRhYmxlIH0gPSB0aGlzO1xuICAgICAgICAgICAgY29uc3QgeyB2aWV3TW9kZWwgfSA9IHRhYmxlO1xuICAgICAgICAgICAgdGhpcy5zZWxlY3RlZE9ubHlNb2RlID0gdHJ1ZTtcbiAgICAgICAgICAgIHZpZXdNb2RlbC5maWx0ZXJCeVNlbGVjdGlvbigpO1xuICAgICAgICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLmhhbmRsZVNob3dBbGxDbGljayA9ICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHsgdGFibGUgfSA9IHRoaXM7XG4gICAgICAgICAgICBjb25zdCB7IHZpZXdNb2RlbCB9ID0gdGFibGU7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkT25seU1vZGUgPSBmYWxzZTtcbiAgICAgICAgICAgIHZpZXdNb2RlbC5jbGVhclNlbGVjdGlvbkZpbHRlcigpO1xuICAgICAgICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLmhhbmRsZVNlbGVjdFZpc2libGVDbGljayA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHsgbGF5ZXIsIHZpZXcsIHRhYmxlIH0gPSB0aGlzO1xuICAgICAgICAgICAgdGFibGUuaGlnaGxpZ2h0SWRzLnJlbW92ZUFsbCgpO1xuICAgICAgICAgICAgY29uc3QgZXh0ZW50ID0gdmlldy5nZXQoXCJleHRlbnRcIik7XG4gICAgICAgICAgICAvLyB0byBkbyB0byBub3JtYWxpemUgZXh0ZW5kXG4gICAgICAgICAgICAvLyBpZiAoZ2V0TGF5ZXJUeXBlKGxheWVyKSA9PT0gXCJpbWFnZXJ5XCIgJiYgKGxheWVyIGFzIEltYWdlcnlMYXllcikudmVyc2lvbiA+PTEwICYmIHZpZXcud3JhcEFyb3VuZCkge1xuICAgICAgICAgICAgLy8gICBleHRlbnQgPSBleHRlbnQuX25vcm1hbGl6ZSh0cnVlKTtcbiAgICAgICAgICAgIC8vIH1cbiAgICAgICAgICAgIC8vIENvbnZlcnQgZXh0ZW50IHRvIHBvbHlnb25cbiAgICAgICAgICAgIGNvbnN0IGlkZW50aWZ5UGFyYW1zID0gYXdhaXQgZ2V0SWRlbnRpZnlQYXJhbXMoZXh0ZW50LCB2aWV3LCBsYXllcik7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdEZlYXR1cmVzRnJvbUlkZW50aWZ5KGlkZW50aWZ5UGFyYW1zKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5oYW5kbGVEaXNwbGF5U2VsZWN0ZWRDbGljayA9ICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMubG9ja1Jhc3RlciA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmxvY2tSYXN0ZXJzKCk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuaGFuZGxlRGlzcGxheUFsbENsaWNrID0gKCkgPT4ge1xuICAgICAgICAgICAgdmFyIF9hO1xuICAgICAgICAgICAgY29uc3QgeyBNb3NhaWNSdWxlIH0gPSB0aGlzO1xuICAgICAgICAgICAgdGhpcy5sb2NrUmFzdGVyID0gZmFsc2U7XG4gICAgICAgICAgICAvLyB1c2Ugc2VydmljZSdzIGRlZmF1bHQgbW9zYWljIHJ1bGUsIGZpbHRlcmVkIG91dCBjZXJ0YWluIG1vc2FpYyBtZXRob2RzIHRoYXQncmUgbm90IHN1cHBvcnRlZCB3aXRob3V0IGFkZGl0aW9uYWwgaW5wdXRzLlxuICAgICAgICAgICAgY29uc3QgbGF5ZXIgPSB0aGlzLmxheWVyO1xuICAgICAgICAgICAgY29uc3QgeyBzb3VyY2VKU09OIH0gPSBsYXllcjtcbiAgICAgICAgICAgIGNvbnN0IG1ldGhvZHMgPSBzb3VyY2VKU09OLmFsbG93ZWRNb3NhaWNNZXRob2RzXG4gICAgICAgICAgICAgICAgLnNwbGl0KFwiLFwiKVxuICAgICAgICAgICAgICAgIC5tYXAoKG1ldGhvZCkgPT4gbWV0aG9kLnRyaW0oKS50b0xvd2VyQ2FzZSgpKTtcbiAgICAgICAgICAgIG1ldGhvZHMudW5zaGlmdChzb3VyY2VKU09OLmRlZmF1bHRNb3NhaWNNZXRob2QudG9Mb3dlckNhc2UoKSk7XG4gICAgICAgICAgICAvLyB2aWV3cG9pbnQgaXMgbm90IGF2YWlsYWJsZSBmcm9tIHNvdXJjZUpTT04sIHNvcnRGaWVsZCBjYW4gYmUgbnVsbCB0b28uXG4gICAgICAgICAgICBjb25zdCBkZWZhdWx0TW9zYWljTWV0aG9kID0gKF9hID0gbWV0aG9kcy5maW5kKChtZXRob2QpID0+IG1ldGhvZCAhPT0gXCJsb2NrcmFzdGVyXCIgJiZcbiAgICAgICAgICAgICAgICBtZXRob2QgIT09IFwidmlld3BvaW50XCIgJiZcbiAgICAgICAgICAgICAgICAobWV0aG9kICE9PSBcImJ5YXR0cmlidXRlXCIgfHwgISFzb3VyY2VKU09OLnNvcnRGaWVsZCkpKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiBcIm5vbmVcIjtcbiAgICAgICAgICAgIGxheWVyLm1vc2FpY1J1bGUgPSBNb3NhaWNSdWxlLmZyb21KU09OKE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgc291cmNlSlNPTiksIHsgZGVmYXVsdE1vc2FpY01ldGhvZCB9KSk7XG4gICAgICAgICAgICBsYXllci52aXNpYmxlID0gdHJ1ZTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5oYW5kbGVSZWZyZXNoQ2xpY2sgPSAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IHRhYmxlIH0gPSB0aGlzO1xuICAgICAgICAgICAgdGFibGUucmVmcmVzaCgpO1xuICAgICAgICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLmhhbmRsZUV4cGFuZENsaWNrID0gKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgeyBzY2FsZSB9ID0gdGhpcztcbiAgICAgICAgICAgIGNvbnN0IG5ld1NjYWxlID0gc2NhbGUgPT09IHNjYWxlcy5TTUFMTCA/IHNjYWxlcy5NRURJVU0gOiBzY2FsZXMuU01BTEw7XG4gICAgICAgICAgICB0aGlzLmFyY2dpc1RhYmxlU2NhbGVDaGFuZ2UuZW1pdChuZXdTY2FsZSk7XG4gICAgICAgICAgICB0aGlzLnNjYWxlID0gbmV3U2NhbGU7XG4gICAgICAgICAgICB0aGlzLmNsb3NlUG9wb3ZlcnMoKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5oYW5kbGVDbG9zZUNsaWNrID0gKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5hcmNnaXNUYWJsZURpc21pc3NlZENoYW5nZS5lbWl0KCk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMudmlldyA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5sYXllciA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5pbml0aWFsVmlld3BvaW50ID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLnNjYWxlID0gc2NhbGVzLlNNQUxMO1xuICAgICAgICB0aGlzLmRpc21pc3NpYmxlID0gZmFsc2U7XG4gICAgICAgIHRoaXMudGFibGVUZW1wbGF0ZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5yZVJlbmRlciA9IGZhbHNlO1xuICAgICAgICB0aGlzLmxvY2tSYXN0ZXIgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5pc0JhckV4cGFuZGVkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWRGZWF0dXJlSWRzID0gW107XG4gICAgfVxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvL1xuICAgIC8vICBwdWJsaWMgY2FsbHNcbiAgICAvL1xuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICBhc3luYyBzZXRGb2N1cyhmb2N1c0lkKSB7XG4gICAgICAgIHZhciBfYSwgX2I7XG4gICAgICAgIGlmIChmb2N1c0lkID09PSBcImRpc21pc3MtYnV0dG9uXCIgfHwgKCFmb2N1c0lkICYmIHRoaXMuZGlzbWlzc2libGUpKSB7XG4gICAgICAgICAgICAoX2EgPSB0aGlzLmNsb3NlQnV0dG9uTm9kZSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNldEZvY3VzKCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgKF9iID0gdGhpcy5zZXR0aW5nc0FjdGlvbk5vZGUpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5zZXRGb2N1cygpO1xuICAgIH1cbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy9cbiAgICAvLyAgTGlmZWN5Y2xlXG4gICAgLy9cbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgYXN5bmMgY29tcG9uZW50V2lsbExvYWQoKSB7XG4gICAgICAgIGNvbnN0IFtzdHJpbmdzLCBjdXJyZW50TGFuZ3VhZ2UsIGN1cnJlbnRMYW5ndWFnZUludGxdID0gYXdhaXQgZ2V0TG9jYWxlQ29tcG9uZW50U3RyaW5ncyh0aGlzLmhvc3RFbGVtZW50KTtcbiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5ncztcbiAgICAgICAgdGhpcy5jdXJyZW50TGFuZ3VhZ2UgPSBjdXJyZW50TGFuZ3VhZ2U7XG4gICAgICAgIHRoaXMuY3VycmVudExhbmd1YWdlSW50bCA9IGN1cnJlbnRMYW5ndWFnZUludGw7XG4gICAgICAgIGF3YWl0IHRoaXMubG9hZEFsbE1vZHVsZXMoKTtcbiAgICAgICAgLypcbiAgICAgICAgLy8gYWxzbyBsb2FkIEpTLUFQSSBzdHlsZXNcbiAgICAgICAgc2V0RGVmYXVsdE9wdGlvbnMoe1xuICAgICAgICAgIGNzczogdHJ1ZVxuICAgICAgICAgIHVybDogYGh0dHBzOi8vanNkZXYuYXJjZ2lzLmNvbS80LjE2YCxcbiAgICAgICAgICBjc3M6IFwiaHR0cHM6Ly9qc2Rldi5hcmNnaXMuY29tLzQuMTYvZXNyaS9jc3MvbWFpbi5jc3NcIlxuICAgICAgICB9KTsgKi9cbiAgICAgICAgY29uc3QgeyB2aWV3LCBsYXllciB9ID0gdGhpcztcbiAgICAgICAgaWYgKGdldExheWVyVHlwZShsYXllcikgPT09IFwic3VibGF5ZXJcIikge1xuICAgICAgICAgICAgLy8gbmVlZCB0byBjcmVhdGUgYSBGZWF0dXJlTGF5ZXJcbiAgICAgICAgICAgIHRoaXMuc3VwcG9ydHNTZWxlY3Rpb24gPSBmYWxzZTtcbiAgICAgICAgICAgIGNvbnN0IG1hcEltYWdlU3VibGF5ZXIgPSBsYXllcjtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMucmVhY3RpdmVVdGlscy53aGVuT25jZSgoKSA9PiAhdmlldy51cGRhdGluZyk7XG4gICAgICAgICAgICBjb25zdCBzdWJsYXllckZMID0gYXdhaXQgbWFwSW1hZ2VTdWJsYXllci5jcmVhdGVGZWF0dXJlTGF5ZXIoKTtcbiAgICAgICAgICAgIGF3YWl0IHN1YmxheWVyRkwubG9hZCgpO1xuICAgICAgICAgICAgdGhpcy5wcm9wcyA9IHtcbiAgICAgICAgICAgICAgICB2aWV3LFxuICAgICAgICAgICAgICAgIGxheWVyOiBzdWJsYXllckZMLFxuICAgICAgICAgICAgICAgIG1hcEltYWdlU3VibGF5ZXJcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoZ2V0U2VydmljZVR5cGUobGF5ZXIpID09PSBzZXJ2aWNlVHlwZUVudW0uaW1hZ2VyeSkge1xuICAgICAgICAgICAgdGhpcy5zdXBwb3J0c1NlbGVjdGlvbiA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmltYWdlcnlTZWxlY3Rpb24gPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5wcm9wcyA9IHtcbiAgICAgICAgICAgICAgICB2aWV3LFxuICAgICAgICAgICAgICAgIGxheWVyOiBsYXllclxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuc3VwcG9ydHNTZWxlY3Rpb24gPSAhKFwiaXNUYWJsZVwiIGluIGxheWVyICYmIGxheWVyLmlzVGFibGUpO1xuICAgICAgICAgICAgdGhpcy5wcm9wcyA9IHtcbiAgICAgICAgICAgICAgICB2aWV3LFxuICAgICAgICAgICAgICAgIGxheWVyOiBsYXllclxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICBhd2FpdCB0aGlzLmdldEZpZWxkVGVtcGxhdGVzKCk7XG4gICAgfVxuICAgIGNvbXBvbmVudERpZExvYWQoKSB7XG4gICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB0aGlzLmNsb3NlQnV0dG9uTm9kZS5zZXRGb2N1cygpKTtcbiAgICB9XG4gICAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7XG4gICAgICAgIHZhciBfYSwgX2IsIF9jO1xuICAgICAgICB0aGlzLmNsb3NlUG9wb3ZlcnMoKTtcbiAgICAgICAgY29uc3QgeyB0YWJsZSB9ID0gdGhpcztcbiAgICAgICAgdGFibGUgPT09IG51bGwgfHwgdGFibGUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHRhYmxlLmRlc3Ryb3koKTtcbiAgICAgICAgKF9hID0gdGhpcy53YXRjaFRpdGxlSGFuZGxlcikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnJlbW92ZSgpO1xuICAgICAgICAoX2IgPSB0aGlzLndhdGNoSG5kbFNpemUpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5yZW1vdmUoKTtcbiAgICAgICAgKF9jID0gdGhpcy53YXRjaEhuZGxBY3RpdmUpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5yZW1vdmUoKTtcbiAgICB9XG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvL1xuICAgIC8vICBSZW5kZXIgTWV0aG9kc1xuICAgIC8vXG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgeyBwcm9wcyB9ID0gdGhpcztcbiAgICAgICAgY29uc3QgeyBsYXllciB9ID0gcHJvcHM7XG4gICAgICAgIGlmICghbGF5ZXIpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHJ0bCA9IGdldEVsZW1lbnREaXIodGhpcy5ob3N0RWxlbWVudCkgPT09IFwicnRsXCI7XG4gICAgICAgIHJldHVybiAoaChIb3N0LCB7IGNsYXNzOiBDU1MkMi5ob3N0IH0sIGgoXCJkaXZcIiwgeyBjbGFzczoge1xuICAgICAgICAgICAgICAgIFtDU1MkMi5jb250ZW50XTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBbQ1NTX1VUSUxJVFkucnRsXTogcnRsXG4gICAgICAgICAgICB9IH0sIHRoaXMucmVuZGVyQWN0aW9uQmFyKCksIGgoXCJjYWxjaXRlLXBhbmVsXCIsIHsgaGVhZGluZzogbGF5ZXIudGl0bGUsIHJlZjogdGhpcy5hZnRlckNyZWF0ZVBhbmVsLCBvbktleURvd246IHRoaXMucGFuZWxLZXlEb3duSGFuZGxlciB9LCB0aGlzLnJlbmRlckhlYWRlckFjdGlvbnMoKSwgdGhpcy5yZW5kZXJUYWJsZSgpKSkpKTtcbiAgICB9XG4gICAgcmVuZGVyQWN0aW9uQmFyKCkge1xuICAgICAgICBjb25zdCB7IHN1cHBvcnRzU2VsZWN0aW9uLCBzZWxlY3RlZEZlYXR1cmVJZHMsIGltYWdlcnlTZWxlY3Rpb24sIGlzQmFyRXhwYW5kZWQsIHN0cmluZ3MgfSA9IHRoaXM7XG4gICAgICAgIHJldHVybiAoaChcImNhbGNpdGUtYWN0aW9uLWJhclwiLCB7IGNsYXNzOiBDU1MkMi5hY3Rpb25CYXIsIG9uQ2FsY2l0ZUFjdGlvbkJhclRvZ2dsZTogKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5pc0JhckV4cGFuZGVkID0gZXZlbnQudGFyZ2V0LmV4cGFuZGVkO1xuICAgICAgICAgICAgfSB9LCBoKFwiY2FsY2l0ZS1hY3Rpb24tZ3JvdXBcIiwgbnVsbCwgc3VwcG9ydHNTZWxlY3Rpb24gJiYgKGgoRnJhZ21lbnQsIG51bGwsIGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IGlkOiBcInpvb21cIiwgaWNvbjogXCJ6b29tLXRvLW9iamVjdFwiLCB0ZXh0OiBzdHJpbmdzLnpvb21Ub1NlbGVjdGlvbiwgZGlzYWJsZWQ6ICEoc2VsZWN0ZWRGZWF0dXJlSWRzID09PSBudWxsIHx8IHNlbGVjdGVkRmVhdHVyZUlkcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2VsZWN0ZWRGZWF0dXJlSWRzLmxlbmd0aCksIG9uQ2xpY2s6IHRoaXMuaGFuZGxlWm9vbVRvQ2xpY2sgfSksICFpc0JhckV4cGFuZGVkICYmIChoKFwiY2FsY2l0ZS10b29sdGlwXCIsIHsgcmVmZXJlbmNlRWxlbWVudDogXCJ6b29tXCIsIGxhYmVsOiBzdHJpbmdzLnpvb21Ub1NlbGVjdGlvbiB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQyLnRvb2x0aXAgfSwgc3RyaW5ncy56b29tVG9TZWxlY3Rpb24pKSkpKSwgaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgaWQ6IFwiaG9tZVwiLCBpY29uOiBcImhvbWVcIiwgdGV4dDogc3RyaW5ncy5ob21lLCBvbkNsaWNrOiB0aGlzLmhhbmRsZUhvbWVDbGljayB9KSwgIWlzQmFyRXhwYW5kZWQgJiYgKGgoXCJjYWxjaXRlLXRvb2x0aXBcIiwgeyByZWZlcmVuY2VFbGVtZW50OiBcImhvbWVcIiwgbGFiZWw6IHN0cmluZ3MuaG9tZSB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQyLnRvb2x0aXAgfSwgc3RyaW5ncy5ob21lKSkpLCBoKFwiY2FsY2l0ZS10b29sdGlwXCIsIHsgc2xvdDogXCJtZW51LXRvb2x0aXBcIiwgbGFiZWw6IHN0cmluZ3MubW9yZSB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQyLnRvb2x0aXAgfSwgc3RyaW5ncy5tb3JlKSkpLCAhaW1hZ2VyeVNlbGVjdGlvbiAmJiB0aGlzLnJlbmRlclRhYmxlQWN0aW9ucygpLCBpbWFnZXJ5U2VsZWN0aW9uICYmIHN1cHBvcnRzU2VsZWN0aW9uICYmIHRoaXMucmVuZGVySW1hZ2VyeVRhYmxlQWN0aW9ucygpLCBoKFwiY2FsY2l0ZS10b29sdGlwXCIsIHsgc2xvdDogXCJleHBhbmQtdG9vbHRpcFwiLCBsYWJlbDogc3RyaW5ncy5leHBhbmQgfSwgaChcImRpdlwiLCB7IGNsYXNzOiBDU1MkMi50b29sdGlwIH0sIHN0cmluZ3MuZXhwYW5kKSkpKTtcbiAgICB9XG4gICAgcmVuZGVyVGFibGVBY3Rpb25zKCkge1xuICAgICAgICB2YXIgX2EsIF9iO1xuICAgICAgICBjb25zdCB7IHNlbGVjdGVkRmVhdHVyZUlkcywgc3VwcG9ydHNTZWxlY3Rpb24sIHRhYmxlLCBpc0JhckV4cGFuZGVkLCBzdHJpbmdzIH0gPSB0aGlzO1xuICAgICAgICBjb25zdCBoYXNTZWxlY3Rpb25GaWx0ZXIgPSAhISgoX2IgPSAoX2EgPSB0YWJsZSA9PT0gbnVsbCB8fCB0YWJsZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogdGFibGUudmlld01vZGVsKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuYWN0aXZlRmlsdGVycykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmZpbmQoKGZpbHRlcikgPT4gZmlsdGVyLnR5cGUgPT09IFwic2VsZWN0aW9uXCIpKTtcbiAgICAgICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1hY3Rpb24tZ3JvdXBcIiwgbnVsbCwgc3VwcG9ydHNTZWxlY3Rpb24gJiYgKGgoRnJhZ21lbnQsIG51bGwsIGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IGlkOiBcImVyYXNlXCIsIGljb246IFwiZXJhc2VcIiwgdGV4dDogc3RyaW5ncy5jbGVhclNlbGVjdGlvbiwgZGlzYWJsZWQ6ICEoc2VsZWN0ZWRGZWF0dXJlSWRzID09PSBudWxsIHx8IHNlbGVjdGVkRmVhdHVyZUlkcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2VsZWN0ZWRGZWF0dXJlSWRzLmxlbmd0aCksIG9uQ2xpY2s6IHRoaXMuaGFuZGxlQ2xlYXJDbGljayB9KSwgIWlzQmFyRXhwYW5kZWQgJiYgKGgoXCJjYWxjaXRlLXRvb2x0aXBcIiwgeyByZWZlcmVuY2VFbGVtZW50OiBcImVyYXNlXCIsIGxhYmVsOiBzdHJpbmdzLmNsZWFyU2VsZWN0aW9uIH0sIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDIudG9vbHRpcCB9LCBzdHJpbmdzLmNsZWFyU2VsZWN0aW9uKSkpKSksIHN1cHBvcnRzU2VsZWN0aW9uICYmIChoKEZyYWdtZW50LCBudWxsLCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBpZDogXCJzaG93U2VsZWN0ZWRcIiwgaWNvbjogXCJzZWxlY3RlZC1pdGVtcy1maWx0ZXJcIiwgdGV4dDogc3RyaW5ncy5zaG93U2VsZWN0ZWQsIGRpc2FibGVkOiAhKHNlbGVjdGVkRmVhdHVyZUlkcyA9PT0gbnVsbCB8fCBzZWxlY3RlZEZlYXR1cmVJZHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNlbGVjdGVkRmVhdHVyZUlkcy5sZW5ndGgpLCBvbkNsaWNrOiB0aGlzLmhhbmRsZVNob3dTZWxlY3RlZENsaWNrIH0pLCAhaXNCYXJFeHBhbmRlZCAmJiAoaChcImNhbGNpdGUtdG9vbHRpcFwiLCB7IHJlZmVyZW5jZUVsZW1lbnQ6IFwic2hvd1NlbGVjdGVkXCIsIGxhYmVsOiBzdHJpbmdzLnNob3dTZWxlY3RlZCB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQyLnRvb2x0aXAgfSwgc3RyaW5ncy5zaG93U2VsZWN0ZWQpKSkpKSwgc3VwcG9ydHNTZWxlY3Rpb24gJiYgKGgoRnJhZ21lbnQsIG51bGwsIGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IGlkOiBcInNob3dBbGxcIiwgaWNvbjogXCJsaXN0XCIsIHRleHQ6IHN0cmluZ3Muc2hvd0FsbCwgZGlzYWJsZWQ6ICFoYXNTZWxlY3Rpb25GaWx0ZXIsIG9uQ2xpY2s6IHRoaXMuaGFuZGxlU2hvd0FsbENsaWNrIH0pLCAhaXNCYXJFeHBhbmRlZCAmJiAoaChcImNhbGNpdGUtdG9vbHRpcFwiLCB7IHJlZmVyZW5jZUVsZW1lbnQ6IFwic2hvd0FsbFwiLCBsYWJlbDogc3RyaW5ncy5zaG93QWxsIH0sIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDIudG9vbHRpcCB9LCBzdHJpbmdzLnNob3dBbGwpKSkpKSwgaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgaWQ6IFwicmVmcmVzaFwiLCBpY29uOiBcInJlZnJlc2hcIiwgdGV4dDogc3RyaW5ncy5yZWZyZXNoLCBvbkNsaWNrOiB0aGlzLmhhbmRsZVJlZnJlc2hDbGljayB9KSwgIWlzQmFyRXhwYW5kZWQgJiYgKGgoXCJjYWxjaXRlLXRvb2x0aXBcIiwgeyByZWZlcmVuY2VFbGVtZW50OiBcInJlZnJlc2hcIiwgbGFiZWw6IHN0cmluZ3MucmVmcmVzaCB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQyLnRvb2x0aXAgfSwgc3RyaW5ncy5yZWZyZXNoKSkpLCBoKFwiY2FsY2l0ZS10b29sdGlwXCIsIHsgc2xvdDogXCJtZW51LXRvb2x0aXBcIiwgbGFiZWw6IHN0cmluZ3MubW9yZSB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQyLnRvb2x0aXAgfSwgc3RyaW5ncy5tb3JlKSkpKTtcbiAgICB9XG4gICAgcmVuZGVySW1hZ2VyeVRhYmxlQWN0aW9ucygpIHtcbiAgICAgICAgY29uc3QgeyBzZWxlY3RlZEZlYXR1cmVJZHMsIGxvY2tSYXN0ZXIsIGlzQmFyRXhwYW5kZWQsIHN0cmluZ3MgfSA9IHRoaXM7XG4gICAgICAgIHJldHVybiAoaChcImNhbGNpdGUtYWN0aW9uLWdyb3VwXCIsIG51bGwsIGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IGlkOiBcImVyYXNlXCIsIGljb246IFwiZXJhc2VcIiwgdGV4dDogc3RyaW5ncy5jbGVhclNlbGVjdGlvbiwgZGlzYWJsZWQ6ICEoc2VsZWN0ZWRGZWF0dXJlSWRzID09PSBudWxsIHx8IHNlbGVjdGVkRmVhdHVyZUlkcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2VsZWN0ZWRGZWF0dXJlSWRzLmxlbmd0aCksIG9uQ2xpY2s6IHRoaXMuaGFuZGxlQ2xlYXJDbGljayB9KSwgIWlzQmFyRXhwYW5kZWQgJiYgKGgoXCJjYWxjaXRlLXRvb2x0aXBcIiwgeyByZWZlcmVuY2VFbGVtZW50OiBcImVyYXNlXCIsIGxhYmVsOiBzdHJpbmdzLmNsZWFyU2VsZWN0aW9uIH0sIGgoXCJkaXZcIiwgeyBjbGFzczogQ1NTJDIudG9vbHRpcCB9LCBzdHJpbmdzLmNsZWFyU2VsZWN0aW9uKSkpLCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBpZDogXCJ2aXNpYmxlXCIsIGljb246IFwic2VsZWN0LXZpc2libGVcIiwgdGV4dDogc3RyaW5ncy5zZWxlY3RWaXNpYmxlLCBvbkNsaWNrOiB0aGlzLmhhbmRsZVNlbGVjdFZpc2libGVDbGljayB9KSwgIWlzQmFyRXhwYW5kZWQgJiYgKGgoXCJjYWxjaXRlLXRvb2x0aXBcIiwgeyByZWZlcmVuY2VFbGVtZW50OiBcInZpc2libGVcIiwgbGFiZWw6IHN0cmluZ3Muc2VsZWN0VmlzaWJsZSB9LCBoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQyLnRvb2x0aXAgfSwgc3RyaW5ncy5zZWxlY3RWaXNpYmxlKSkpLCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBpZDogXCJkaXNwbGF5SW1hZ2VcIiwgaWNvbjogbG9ja1Jhc3RlciA/IFwidW5sb2NrXCIgOiBcImxvY2tcIiwgdGV4dDogbG9ja1Jhc3RlciA/IHN0cmluZ3MuZGlzcGxheUFsbCA6IHN0cmluZ3MuZGlzcGxheVNlbGVjdGVkLCBvbkNsaWNrOiBsb2NrUmFzdGVyID8gdGhpcy5oYW5kbGVEaXNwbGF5QWxsQ2xpY2sgOiB0aGlzLmhhbmRsZURpc3BsYXlTZWxlY3RlZENsaWNrIH0pLCAhaXNCYXJFeHBhbmRlZCAmJiAoaChcImNhbGNpdGUtdG9vbHRpcFwiLCB7IHJlZmVyZW5jZUVsZW1lbnQ6IFwiZGlzcGxheUltYWdlXCIsIGxhYmVsOiBsb2NrUmFzdGVyID8gc3RyaW5ncy5kaXNwbGF5QWxsIDogc3RyaW5ncy5kaXNwbGF5U2VsZWN0ZWQgfSwgaChcImRpdlwiLCB7IGNsYXNzOiBDU1MkMi50b29sdGlwIH0sIGxvY2tSYXN0ZXIgPyBzdHJpbmdzLmRpc3BsYXlBbGwgOiBzdHJpbmdzLmRpc3BsYXlTZWxlY3RlZCkpKSwgaChcImNhbGNpdGUtdG9vbHRpcFwiLCB7IHNsb3Q6IFwibWVudS10b29sdGlwXCIsIGxhYmVsOiBzdHJpbmdzLm1vcmUgfSwgaChcImRpdlwiLCB7IGNsYXNzOiBDU1MkMi50b29sdGlwIH0sIHN0cmluZ3MubW9yZSkpKSk7XG4gICAgfVxuICAgIHJlbmRlckhlYWRlckFjdGlvbnMoKSB7XG4gICAgICAgIGNvbnN0IHsgbGF5ZXIsIHNjYWxlLCBzdHJpbmdzLCBkaXNtaXNzaWJsZSB9ID0gdGhpcztcbiAgICAgICAgY29uc3Qgc3VwcG9ydHNFZGl0aW5nT25seUZvclVzZXIgPSBcInR5cGVcIiBpbiBsYXllciAmJlxuICAgICAgICAgICAgbGF5ZXIudHlwZSA9PT0gXCJmZWF0dXJlXCIgJiZcbiAgICAgICAgICAgIGxheWVyLmVmZmVjdGl2ZUVkaXRpbmdFbmFibGVkICYmXG4gICAgICAgICAgICAhbGF5ZXIuZWRpdGluZ0VuYWJsZWQ7XG4gICAgICAgIHJldHVybiAoaChcImRpdlwiLCB7IHNsb3Q6IFwiaGVhZGVyLWFjdGlvbnMtZW5kXCIsIGNsYXNzOiBDU1MkMi5tZW51QWN0aW9ucyB9LCBzdXBwb3J0c0VkaXRpbmdPbmx5Rm9yVXNlciAmJiAoaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgaWQ6IFwidGFibGUtZWRpdGluZy1hY3Rpb25cIiwgdGV4dDogc3RyaW5ncy5sYXllckVkaXRpbmcsIHNjYWxlOiBcIm1cIiwgb25DbGljazogdGhpcy5oYW5kbGVFZGl0aW5nQ2xpY2ssIHJlZjogKG5vZGUpID0+ICh0aGlzLmVkaXRpbmdBY3Rpb25Ob2RlID0gbm9kZSkgfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcInNcIiwgaWNvbjogXCJleGNsYW1hdGlvbi1tYXJrLWNpcmNsZVwiIH0pKSksIGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IGlkOiBcInRhYmxlLXNldHRpbmdzLWFjdGlvblwiLCB0ZXh0OiBzdHJpbmdzLmZpZWxkVmlzaWJpbGl0eSwgc2NhbGU6IFwibVwiLCBvbkNsaWNrOiB0aGlzLmhhbmRsZVZpc2liaWxpdHlDbGljaywgcmVmOiAobm9kZSkgPT4gKHRoaXMuc2V0dGluZ3NBY3Rpb25Ob2RlID0gbm9kZSkgfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcInNcIiwgaWNvbjogXCJnZWFyXCIgfSkpLCBzY2FsZSA9PT0gc2NhbGVzLlNNQUxMID8gKGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IGtleTogXCJleHBhbmQtdGFibGVcIiwgdGV4dDogc3RyaW5ncy5leHBhbmQsIHNjYWxlOiBcInNcIiwgb25DbGljazogdGhpcy5oYW5kbGVFeHBhbmRDbGljayB9LCBoKFwiY2FsY2l0ZS1pY29uXCIsIHsgc2NhbGU6IFwibVwiLCBpY29uOiBcImNoZXZyb25zLXVwXCIgfSkpKSA6IChoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBrZXk6IFwiZXhwYW5kXCIsIHRleHQ6IHN0cmluZ3Muc2hyaW5rLCBzY2FsZTogXCJzXCIsIG9uQ2xpY2s6IHRoaXMuaGFuZGxlRXhwYW5kQ2xpY2sgfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcIm1cIiwgaWNvbjogXCJjaGV2cm9ucy1kb3duXCIgfSkpKSwgZGlzbWlzc2libGUgPyAoaChcImNhbGNpdGUtYWN0aW9uXCIsIHsgdGV4dDogc3RyaW5ncy5jbG9zZSwgaWNvbjogXCJ4XCIsIG9uQ2xpY2s6IHRoaXMuaGFuZGxlQ2xvc2VDbGljaywgcmVmOiB0aGlzLmFmdGVyQ3JlYXRlQ2xvc2VCdXR0b24gfSkpIDogbnVsbCkpO1xuICAgIH1cbiAgICByZW5kZXJUYWJsZSgpIHtcbiAgICAgICAgcmV0dXJuIChoKFwiZGl2XCIsIHsgY2xhc3M6IENTUyQyLnRhYmxlIH0sIGgoXCJkaXZcIiwgeyByZWY6IHRoaXMuYWZ0ZXJDcmVhdGVUYWJsZU5vZGUgfSkpKTtcbiAgICB9XG4gICAgcmVtb3ZlRWRpdGluZ1BvcG92ZXIoKSB7XG4gICAgICAgIGlmICh0aGlzLmVkaXRpbmdQb3BvdmVyTm9kZSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuZWRpdGluZ1BvcG92ZXJOb2RlKTtcbiAgICAgICAgICAgICAgICB0aGlzLmVkaXRpbmdQb3BvdmVyTm9kZSA9IG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXRjaCAoZSkgeyB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgaGFuZGxlSGlkZUNsaWNrKGZpZWxkTmFtZSkge1xuICAgICAgICB0aGlzLnRhYmxlLmhpZGVDb2x1bW4oZmllbGROYW1lKTtcbiAgICAgICAgdGhpcy50YWJsZVRlbXBsYXRlLmNvbHVtblRlbXBsYXRlcy5mb3JFYWNoKChjb2x1bW5UZW1wbGF0ZSkgPT4ge1xuICAgICAgICAgICAgaWYgKGNvbHVtblRlbXBsYXRlLmZpZWxkTmFtZSA9PT0gZmllbGROYW1lKSB7XG4gICAgICAgICAgICAgICAgY29sdW1uVGVtcGxhdGUudmlzaWJsZSA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgaGFuZGxlQ29sdW1uSW5mbyhmaWVsZE5hbWUpIHtcbiAgICAgICAgY29uc3QgeyBjdXJyZW50TGFuZ3VhZ2VJbnRsIH0gPSB0aGlzO1xuICAgICAgICBpZiAodGhpcy5jb2x1bW5JbmZvUG9wb3Zlcikge1xuICAgICAgICAgICAgLy8gYWxyZWFkeSBvcGVuLCBoaWRlIGl0XG4gICAgICAgICAgICB0aGlzLmNvbHVtbkluZm9Qb3BvdmVyLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGhpcy5jb2x1bW5JbmZvUG9wb3Zlcik7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgeyBwcm9wcywgc3RyaW5ncyB9ID0gdGhpcztcbiAgICAgICAgY29uc3QgcG9wb3ZlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhcmNnaXMtdGFibGUtY29sdW1uLWluZm9cIik7XG4gICAgICAgIHBvcG92ZXIucHJvcHMgPSBwcm9wcztcbiAgICAgICAgcG9wb3Zlci5zdHJpbmdzID0gc3RyaW5ncztcbiAgICAgICAgcG9wb3Zlci5jdXJyZW50TGFuZ3VhZ2UgPSBjdXJyZW50TGFuZ3VhZ2VJbnRsO1xuICAgICAgICBwb3BvdmVyLmZpZWxkTmFtZSA9IGZpZWxkTmFtZTtcbiAgICAgICAgcG9wb3Zlci5wb3BvdmVyUmVmZXJlbmNlRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwidGFibGUtc2V0dGluZ3MtYWN0aW9uXCIpO1xuICAgICAgICBwb3BvdmVyLmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNUYWJsZUNvbHVtbkluZm9DbG9zZVwiLCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmNsb3NlUG9wb3ZlcnMoKTtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5jbG9zZUJ1dHRvbk5vZGUuc2V0Rm9jdXMoKSwgMTAwKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQocG9wb3Zlcik7XG4gICAgICAgIHRoaXMuY29sdW1uSW5mb1BvcG92ZXIgPSBwb3BvdmVyO1xuICAgIH1cbiAgICBjbG9zZVBvcG92ZXJzKCkge1xuICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgdGhpcy5jbGlja0hhbmRsZXIpO1xuICAgICAgICBpZiAodGhpcy5maWVsZFNlbGVjdGlvblBvcG92ZXIpIHtcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5maWVsZFNlbGVjdGlvblBvcG92ZXIpO1xuICAgICAgICAgICAgdGhpcy5maWVsZFNlbGVjdGlvblBvcG92ZXIgPSBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmNvbHVtbkluZm9Qb3BvdmVyKSB7XG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRoaXMuY29sdW1uSW5mb1BvcG92ZXIpO1xuICAgICAgICAgICAgdGhpcy5jb2x1bW5JbmZvUG9wb3ZlciA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5yZW1vdmVFZGl0aW5nUG9wb3ZlcigpO1xuICAgIH1cbiAgICBhc3luYyBzZWxlY3RGZWF0dXJlc0Zyb21JZGVudGlmeShwYXJhbXMpIHtcbiAgICAgICAgdmFyIF9hO1xuICAgICAgICBjb25zdCB7IGxheWVyLCBpbWFnZVNlcnZpY2UgfSA9IHRoaXM7XG4gICAgICAgIGxldCBxdWVyeVJlc3VsdCA9IFtdO1xuICAgICAgICBpZiAobGF5ZXIudmlzaWJsZSkge1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaW1hZ2VTZXJ2aWNlLmlkZW50aWZ5KGxheWVyLnVybCwgcGFyYW1zKTtcbiAgICAgICAgICAgIGlmICgoKF9hID0gcmVzdWx0ID09PSBudWxsIHx8IHJlc3VsdCA9PT0gdm9pZCAwID8gdm9pZCAwIDogcmVzdWx0LmNhdGFsb2dJdGVtcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmZlYXR1cmVzKSAmJiByZXN1bHQuY2F0YWxvZ0l0ZW1WaXNpYmlsaXRpZXMpIHtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdC5jYXRhbG9nSXRlbXMuZmVhdHVyZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdC5jYXRhbG9nSXRlbVZpc2liaWxpdGllc1tpXSA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXJ5UmVzdWx0LnB1c2gocmVzdWx0LmNhdGFsb2dJdGVtcy5mZWF0dXJlc1tpXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBncmFwaGljcyA9IHF1ZXJ5UmVzdWx0Lm1hcCgoZmVhdHVyZSkgPT4gbmV3IHRoaXMuR3JhcGhpYyh7XG4gICAgICAgICAgICAgICAgYXR0cmlidXRlczogZmVhdHVyZS5hdHRyaWJ1dGVzLFxuICAgICAgICAgICAgICAgIGdlb21ldHJ5OiBmZWF0dXJlLmdlb21ldHJ5LFxuICAgICAgICAgICAgICAgIHNvdXJjZUxheWVyOiB0aGlzLnRhYmxlLmxheWVyLFxuICAgICAgICAgICAgICAgIGxheWVyOiB0aGlzLnRhYmxlLmxheWVyXG4gICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICBpZiAoIWdyYXBoaWNzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHRoaXMudGFibGUuaGlnaGxpZ2h0SWRzLnJlbW92ZUFsbCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy50YWJsZS5zZWxlY3RSb3dzKGdyYXBoaWNzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBhc3luYyBsb2NrUmFzdGVycygpIHtcbiAgICAgICAgY29uc3QgeyBzZWxlY3RlZEZlYXR1cmVJZHMsIGxheWVyLCBpbWFnZXJ5U2VsZWN0aW9uLCBNb3NhaWNSdWxlIH0gPSB0aGlzO1xuICAgICAgICBpZiAodGhpcy5sb2NrUmFzdGVyKSB7XG4gICAgICAgICAgICBpZiAoaW1hZ2VyeVNlbGVjdGlvbiAmJiBzZWxlY3RlZEZlYXR1cmVJZHMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaWRzID0gWy4uLnNlbGVjdGVkRmVhdHVyZUlkc107XG4gICAgICAgICAgICAgICAgY29uc3QgbW9zYWljUnVsZU9iamVjdCA9IG5ldyBNb3NhaWNSdWxlKCk7XG4gICAgICAgICAgICAgICAgbW9zYWljUnVsZU9iamVjdC5tZXRob2QgPSBcImxvY2stcmFzdGVyXCI7XG4gICAgICAgICAgICAgICAgbW9zYWljUnVsZU9iamVjdC5sb2NrUmFzdGVySWRzID0gaWRzO1xuICAgICAgICAgICAgICAgIGNvbnN0IHdoZXJlID0gbGF5ZXIuZGVmaW5pdGlvbkV4cHJlc3Npb247XG4gICAgICAgICAgICAgICAgaWYgKHdoZXJlKSB7XG4gICAgICAgICAgICAgICAgICAgIG1vc2FpY1J1bGVPYmplY3Qud2hlcmUgPSB3aGVyZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbGF5ZXIubW9zYWljUnVsZSA9IG1vc2FpY1J1bGVPYmplY3Q7XG4gICAgICAgICAgICAgICAgbGF5ZXIudmlzaWJsZSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBsYXllci52aXNpYmxlID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgdXBkYXRlVGFibGUodGFibGVUZW1wbGF0ZSkge1xuICAgICAgICB0aGlzLnRhYmxlLnRhYmxlVGVtcGxhdGUgPSB0YWJsZVRlbXBsYXRlO1xuICAgIH1cbiAgICBhc3luYyBnZXRGaWVsZFRlbXBsYXRlcygpIHtcbiAgICAgICAgdmFyIF9hO1xuICAgICAgICBjb25zdCB7IGxheWVyIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHRoaXM7XG4gICAgICAgIGNvbnN0IGdldE1lbnVDb25maWcgPSAoZmllbGROYW1lKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGl0ZW1zOiBbXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiBzdHJpbmdzLmluZm9ybWF0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgaWNvbkNsYXNzOiBcImVzcmktaWNvbi1kZXNjcmlwdGlvblwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgYXV0b0Nsb3NlTWVudTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsaWNrRnVuY3Rpb246ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUNvbHVtbkluZm8oZmllbGROYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IHN0cmluZ3MuaGlkZUZpZWxkLFxuICAgICAgICAgICAgICAgICAgICAgICAgaWNvbkNsYXNzOiBcImVzcmktaWNvbi1ub24tdmlzaWJsZVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgYXV0b0Nsb3NlTWVudTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsaWNrRnVuY3Rpb246ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUhpZGVDbGljayhmaWVsZE5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy50YWJsZVRlbXBsYXRlID0gbmV3IHRoaXMuVGFibGVUZW1wbGF0ZSh7IGNvbHVtblRlbXBsYXRlczogW10gfSk7XG4gICAgICAgIC8vIHVzZSBkZWZhdWx0IHBvcHVwIHNldHRpbmdzIGZvciBmaWVsZCB2aXNpYmlsaXR5XG4gICAgICAgIGNvbnN0IGZpZWxkSW5mb3MgPSB0aGlzLnBvcHVwVXRpbHMuY3JlYXRlRmllbGRJbmZvcyh7XG4gICAgICAgICAgICBmaWVsZHM6IGxheWVyLmZpZWxkcyxcbiAgICAgICAgICAgIG9iamVjdElkRmllbGQ6IGxheWVyLm9iamVjdElkRmllbGRcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IGZpZWxkSW5mb3NNYXAgPSBuZXcgTWFwKGZpZWxkSW5mb3MubWFwKChmaWVsZEluZm8pID0+IFtcbiAgICAgICAgICAgIGZpZWxkSW5mby5maWVsZE5hbWUsXG4gICAgICAgICAgICBmaWVsZEluZm9cbiAgICAgICAgXSkpO1xuICAgICAgICBsZXQgcG9wdXBGaWVsZHNNYXA7XG4gICAgICAgIGlmICgoX2EgPSBsYXllci5wb3B1cFRlbXBsYXRlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZmllbGRJbmZvcykge1xuICAgICAgICAgICAgY29uc3QgeyBwb3B1cFRlbXBsYXRlIH0gPSBsYXllcjtcbiAgICAgICAgICAgIHBvcHVwRmllbGRzTWFwID0gbmV3IE1hcChwb3B1cFRlbXBsYXRlLmZpZWxkSW5mb3MubWFwKChmaWVsZEluZm8pID0+IFtcbiAgICAgICAgICAgICAgICBmaWVsZEluZm8uZmllbGROYW1lLFxuICAgICAgICAgICAgICAgIGZpZWxkSW5mb1xuICAgICAgICAgICAgXSkpO1xuICAgICAgICAgICAgLyogcG9wdXBUZW1wbGF0ZS5maWVsZEluZm9zLmZvckVhY2goKGZpZWxkSW5mbzogRmllbGRJbmZvKSA9PiB7XG4gICAgICAgICAgICAgIGlmIChmaWVsZEluZm8uZmllbGROYW1lLnN0YXJ0c1dpdGgoXCJleHByZXNzaW9uL1wiKSkge1xuICAgICAgICAgICAgICAgIC8vIFRPRE9cbiAgICAgICAgICAgICAgfSBlbHNlIGlmIChmaWVsZEluZm8uZmllbGROYW1lLnN0YXJ0c1dpdGgoXCJyZWxhdGlvbnNoaXBzL1wiKSkge1xuICAgICAgICAgICAgICAgIC8vIFRPRE9cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7ICovXG4gICAgICAgICAgICAvLyB3YXRjaCBmb3IgY2hhbmdlc1xuICAgICAgICAgICAgdGhpcy5yZWFjdGl2ZVV0aWxzLndhdGNoKCgpID0+IGxheWVyLnBvcHVwVGVtcGxhdGUsICgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB7IHBvcHVwVGVtcGxhdGUgfSA9IGxheWVyO1xuICAgICAgICAgICAgICAgIHRoaXMudGFibGVUZW1wbGF0ZS5jb2x1bW5UZW1wbGF0ZXMuZm9yRWFjaCgoY29sdW1uVGVtcGxhdGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcG9wdXBUZW1wbGF0ZS5maWVsZEluZm9zLmZvckVhY2goKGZpZWxkSW5mbykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtblRlbXBsYXRlLmZpZWxkTmFtZSA9PT0gZmllbGRJbmZvLmZpZWxkTmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtblRlbXBsYXRlLmxhYmVsID0gZmllbGRJbmZvLmxhYmVsO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtblRlbXBsYXRlLmZvcm1hdCA9IGZpZWxkSW5mby5mb3JtYXQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlVGFibGUodGhpcy50YWJsZVRlbXBsYXRlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGxheWVyLmZpZWxkcy5mb3JFYWNoKChmaWVsZCkgPT4ge1xuICAgICAgICAgICAgaWYgKGZpZWxkLnR5cGUgPT09IFwiZ2VvbWV0cnlcIikge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGZpZWxkSW5mbyA9IGZpZWxkSW5mb3NNYXAuZ2V0KGZpZWxkLm5hbWUpO1xuICAgICAgICAgICAgY29uc3QgcG9wdXBGaWVsZEluZm8gPSBwb3B1cEZpZWxkc01hcCA9PT0gbnVsbCB8fCBwb3B1cEZpZWxkc01hcCA9PT0gdm9pZCAwID8gdm9pZCAwIDogcG9wdXBGaWVsZHNNYXAuZ2V0KGZpZWxkLm5hbWUpO1xuICAgICAgICAgICAgY29uc3QgZmllbGRDb2x1bW5UZW1wbGF0ZSA9IHtcbiAgICAgICAgICAgICAgICBmaWVsZE5hbWU6IGZpZWxkLm5hbWUsXG4gICAgICAgICAgICAgICAgbGFiZWw6IChwb3B1cEZpZWxkSW5mbyA9PT0gbnVsbCB8fCBwb3B1cEZpZWxkSW5mbyA9PT0gdm9pZCAwID8gdm9pZCAwIDogcG9wdXBGaWVsZEluZm8ubGFiZWwpIHx8IGZpZWxkLmFsaWFzIHx8IGZpZWxkLm5hbWUsXG4gICAgICAgICAgICAgICAgdmlzaWJsZTogZmllbGRJbmZvID09PSBudWxsIHx8IGZpZWxkSW5mbyA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmllbGRJbmZvLnZpc2libGUsXG4gICAgICAgICAgICAgICAgZm9ybWF0OiAocG9wdXBGaWVsZEluZm8gPT09IG51bGwgfHwgcG9wdXBGaWVsZEluZm8gPT09IHZvaWQgMCA/IHZvaWQgMCA6IHBvcHVwRmllbGRJbmZvLmZvcm1hdCkgfHwgdGhpcy5nZXREZWZhdWx0Rm9ybWF0KGZpZWxkKSxcbiAgICAgICAgICAgICAgICBtZW51Q29uZmlnOiBnZXRNZW51Q29uZmlnKGZpZWxkLm5hbWUpXG4gICAgICAgICAgICB9OyAvKiBGaWVsZENvbHVtblRlbXBsYXRlICovXG4gICAgICAgICAgICB0aGlzLnRhYmxlVGVtcGxhdGUuY29sdW1uVGVtcGxhdGVzLnB1c2goZmllbGRDb2x1bW5UZW1wbGF0ZSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBnZXREZWZhdWx0Rm9ybWF0KGZpZWxkKSB7XG4gICAgICAgIGlmIChbXCJpbnRlZ2VyXCIsIFwic21hbGwtaW50ZWdlclwiLCBcImJpZy1pbnRlZ2VyXCJdLmluZGV4T2YoZmllbGQudHlwZSkgPiAtMSkge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyB0aGlzLkZpZWxkSW5mb0Zvcm1hdCh7IGRpZ2l0U2VwYXJhdG9yOiBmYWxzZSwgcGxhY2VzOiAwIH0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKFtcInNpbmdsZVwiLCBcImRvdWJsZVwiLCBcImxvbmdcIl0uaW5kZXhPZihmaWVsZC50eXBlKSA+IC0xKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IHRoaXMuRmllbGRJbmZvRm9ybWF0KHtcbiAgICAgICAgICAgICAgICBkaWdpdFNlcGFyYXRvcjogZmFsc2UsXG4gICAgICAgICAgICAgICAgcGxhY2VzOiAyXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChbXCJkYXRlXCIsIFwidGltZS1vbmx5XCIsIFwidGltZXN0YW1wLW9mZnNldFwiXS5pbmRleE9mKGZpZWxkLnR5cGUpID4gLTEpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgdGhpcy5GaWVsZEluZm9Gb3JtYXQoe1xuICAgICAgICAgICAgICAgIGRhdGVGb3JtYXQ6IFwic2hvcnQtZGF0ZS1zaG9ydC10aW1lXCJcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKFwiZGF0ZS1vbmx5XCIgPT09IGZpZWxkLnR5cGUpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgdGhpcy5GaWVsZEluZm9Gb3JtYXQoe1xuICAgICAgICAgICAgICAgIGRhdGVGb3JtYXQ6IFwic2hvcnQtZGF0ZVwiXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBkaXNwbGF5Q291bnQoKSB7XG4gICAgICAgIGNvbnN0IHsgc3RyaW5ncywgcGFuZWxOb2RlLCByZWNvcmRzQ291bnQsIHNlbGVjdGVkQ291bnQsIHN1cHBvcnRzU2VsZWN0aW9uLCBpbnRsIH0gPSB0aGlzO1xuICAgICAgICBpZiAoIXBhbmVsTm9kZSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IG51bWJlckZvcm1hdEludGxPcHRpb25zID0gaW50bC5jb252ZXJ0TnVtYmVyRm9ybWF0VG9JbnRsT3B0aW9ucyh7XG4gICAgICAgICAgICBkaWdpdFNlcGFyYXRvcjogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgcmVjb3Jkc0NvdW50U3RyID0gaW50bC5mb3JtYXROdW1iZXIocmVjb3Jkc0NvdW50LCBudW1iZXJGb3JtYXRJbnRsT3B0aW9ucyk7XG4gICAgICAgIGlmICghaXNEZWZpbmVkKHNlbGVjdGVkQ291bnQpIHx8ICFzdXBwb3J0c1NlbGVjdGlvbikge1xuICAgICAgICAgICAgaWYgKHJlY29yZHNDb3VudCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHBhbmVsTm9kZS5kZXNjcmlwdGlvbiA9IHN0cmluZ3MuemVyb1JlY29yZHM7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChyZWNvcmRzQ291bnQgPT09IDEpIHtcbiAgICAgICAgICAgICAgICBwYW5lbE5vZGUuZGVzY3JpcHRpb24gPSBzdHJpbmdzLm9uZVJlY29yZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHBhbmVsTm9kZS5kZXNjcmlwdGlvbiA9IHN0cmluZ3MubnVtUmVjb3Jkcy5yZXBsYWNlKFwiJHtjb3VudH1cIiwgYCR7cmVjb3Jkc0NvdW50U3RyfWApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHNlbGVjdGVkQ291bnQgPT09IDApIHtcbiAgICAgICAgICAgIGlmIChyZWNvcmRzQ291bnQgPT09IDApIHtcbiAgICAgICAgICAgICAgICBwYW5lbE5vZGUuZGVzY3JpcHRpb24gPSBzdHJpbmdzLnplcm9SZWNvcmRzWmVyb1NlbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKHJlY29yZHNDb3VudCA9PT0gMSkge1xuICAgICAgICAgICAgICAgIHBhbmVsTm9kZS5kZXNjcmlwdGlvbiA9IHN0cmluZ3Mub25lUmVjb3JkWmVyb1NlbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHBhbmVsTm9kZS5kZXNjcmlwdGlvbiA9IHN0cmluZ3MubnVtUmVjb3Jkc1plcm9TZWwucmVwbGFjZShcIiR7Y291bnR9XCIsIGAke3JlY29yZHNDb3VudFN0cn1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChzZWxlY3RlZENvdW50ID09PSAxKSB7XG4gICAgICAgICAgICBpZiAocmVjb3Jkc0NvdW50ID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcGFuZWxOb2RlLmRlc2NyaXB0aW9uID0gc3RyaW5ncy56ZXJvUmVjb3Jkc09uZVNlbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKHJlY29yZHNDb3VudCA9PT0gMSkge1xuICAgICAgICAgICAgICAgIHBhbmVsTm9kZS5kZXNjcmlwdGlvbiA9IHN0cmluZ3Mub25lUmVjb3JkT25lU2VsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcGFuZWxOb2RlLmRlc2NyaXB0aW9uID0gc3RyaW5ncy5udW1SZWNvcmRzT25lU2VsLnJlcGxhY2UoXCIke2NvdW50fVwiLCBgJHtyZWNvcmRzQ291bnRTdHJ9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAvLyBuIHNlbGVjdGVkXG4gICAgICAgICAgICBjb25zdCBzZWxlY3RlZENvdW50U3RyID0gaW50bC5mb3JtYXROdW1iZXIoc2VsZWN0ZWRDb3VudCwgbnVtYmVyRm9ybWF0SW50bE9wdGlvbnMpO1xuICAgICAgICAgICAgaWYgKHJlY29yZHNDb3VudCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHBhbmVsTm9kZS5kZXNjcmlwdGlvbiA9IHN0cmluZ3MuemVyb1JlY29yZHNOdW1TZWwucmVwbGFjZShcIiR7Y291bnRTZWx9XCIsIGAke3NlbGVjdGVkQ291bnRTdHJ9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChyZWNvcmRzQ291bnQgPT09IDEpIHtcbiAgICAgICAgICAgICAgICBwYW5lbE5vZGUuZGVzY3JpcHRpb24gPSBzdHJpbmdzLm9uZVJlY29yZE51bVNlbC5yZXBsYWNlKFwiJHtjb3VudFNlbH1cIiwgYCR7c2VsZWN0ZWRDb3VudFN0cn1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHBhbmVsTm9kZS5kZXNjcmlwdGlvbiA9IHN0cmluZ3MubnVtUmVjb3Jkc051bVNlbFxuICAgICAgICAgICAgICAgICAgICAucmVwbGFjZShcIiR7Y291bnR9XCIsIGAke3JlY29yZHNDb3VudFN0cn1gKVxuICAgICAgICAgICAgICAgICAgICAucmVwbGFjZShcIiR7Y291bnRTZWx9XCIsIGAke3NlbGVjdGVkQ291bnRTdHJ9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgYXN5bmMgbG9hZEFsbE1vZHVsZXMoKSB7XG4gICAgICAgIGNvbnN0IFtGZWF0dXJlVGFibGUsIFRhYmxlVGVtcGxhdGUsIHBvcHVwVXRpbHMsIHJlYWN0aXZlVXRpbHMsIEZpZWxkSW5mb0Zvcm1hdCwgUXVlcnksIGltYWdlU2VydmljZSwgTW9zYWljUnVsZSwgR3JhcGhpYywgaW50bF0gPSBhd2FpdCBsb2FkTW9kdWxlcyhbXG4gICAgICAgICAgICBcImVzcmkvd2lkZ2V0cy9GZWF0dXJlVGFibGVcIixcbiAgICAgICAgICAgIFwiZXNyaS93aWRnZXRzL0ZlYXR1cmVUYWJsZS9zdXBwb3J0L1RhYmxlVGVtcGxhdGVcIixcbiAgICAgICAgICAgIFwiZXNyaS9zdXBwb3J0L3BvcHVwVXRpbHNcIixcbiAgICAgICAgICAgIFwiZXNyaS9jb3JlL3JlYWN0aXZlVXRpbHNcIixcbiAgICAgICAgICAgIFwiZXNyaS9wb3B1cC9zdXBwb3J0L0ZpZWxkSW5mb0Zvcm1hdFwiLFxuICAgICAgICAgICAgXCJlc3JpL3Jlc3Qvc3VwcG9ydC9RdWVyeVwiLFxuICAgICAgICAgICAgXCJlc3JpL3Jlc3QvaW1hZ2VTZXJ2aWNlXCIsXG4gICAgICAgICAgICBcImVzcmkvbGF5ZXJzL3N1cHBvcnQvTW9zYWljUnVsZVwiLFxuICAgICAgICAgICAgXCJlc3JpL0dyYXBoaWNcIixcbiAgICAgICAgICAgIFwiZXNyaS9pbnRsXCJcbiAgICAgICAgXSk7XG4gICAgICAgIHRoaXMuRmVhdHVyZVRhYmxlID0gRmVhdHVyZVRhYmxlO1xuICAgICAgICB0aGlzLlRhYmxlVGVtcGxhdGUgPSBUYWJsZVRlbXBsYXRlO1xuICAgICAgICB0aGlzLnBvcHVwVXRpbHMgPSBwb3B1cFV0aWxzO1xuICAgICAgICB0aGlzLnJlYWN0aXZlVXRpbHMgPSByZWFjdGl2ZVV0aWxzO1xuICAgICAgICB0aGlzLkZpZWxkSW5mb0Zvcm1hdCA9IEZpZWxkSW5mb0Zvcm1hdDtcbiAgICAgICAgdGhpcy5RdWVyeSA9IFF1ZXJ5O1xuICAgICAgICB0aGlzLmltYWdlU2VydmljZSA9IGltYWdlU2VydmljZTtcbiAgICAgICAgdGhpcy5Nb3NhaWNSdWxlID0gTW9zYWljUnVsZTtcbiAgICAgICAgdGhpcy5HcmFwaGljID0gR3JhcGhpYztcbiAgICAgICAgdGhpcy5pbnRsID0gaW50bDtcbiAgICB9XG4gICAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcbkFyY2dpc1RhYmxlLnN0eWxlID0gYXJjZ2lzVGFibGVDc3M7XG5cbmNvbnN0IENTUyQxID0ge1xuICAgIHBvcG92ZXI6IFwicG9wb3ZlclwiLFxuICAgIGZsb3c6IFwiZmxvd1wiLFxuICAgIGluZm86IFwiaW5mb1wiXG59O1xuXG5jb25zdCBhcmNnaXNUYWJsZUNvbHVtbkluZm9Dc3MgPSBcIi5mbG93e21heC1oZWlnaHQ6NDAwcHh9LmluZm97YmFja2dyb3VuZC1jb2xvcjojZmZmZmZmO21heC1oZWlnaHQ6NDAwcHg7d2lkdGg6MjB2dzttYXgtd2lkdGg6NDIwcHg7bWluLXdpZHRoOjI0MHB4fVwiO1xuXG5jb25zdCBBcmNnaXNUYWJsZUNvbHVtbkluZm8gPSBjbGFzcyB7XG4gICAgY29uc3RydWN0b3IoaG9zdFJlZikge1xuICAgICAgICByZWdpc3Rlckluc3RhbmNlKHRoaXMsIGhvc3RSZWYpO1xuICAgICAgICB0aGlzLmFyY2dpc1RhYmxlQ29sdW1uSW5mb0Nsb3NlID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNUYWJsZUNvbHVtbkluZm9DbG9zZVwiLCA3KTtcbiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAgICAgLy9cbiAgICAgICAgLy8gIFByaXZhdGUgbWV0aG9kc1xuICAgICAgICAvL1xuICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAgICB0aGlzLmFmdGVyQ3JlYXRlUG9wb3ZlciA9IChub2RlKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnBvcG92ZXJOb2RlID0gbm9kZTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5hZnRlckNyZWF0ZUNsb3NlQnV0dG9uID0gKG5vZGUpID0+IHtcbiAgICAgICAgICAgIHRoaXMuY2xvc2VCdXR0b25Ob2RlID0gbm9kZTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5hZnRlckNyZWF0ZUZpZWxkSW5mbyA9IChub2RlKSA9PiB7XG4gICAgICAgICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIoXCJhcmNnaXNGaWVsZEluZm9Db21wbGV0ZVwiLCAoKSA9PiB0aGlzLnJlcG9zaXRpb24oKSk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuaGFuZGxlQ2xvc2VDbGljayA9ICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuYXJjZ2lzVGFibGVDb2x1bW5JbmZvQ2xvc2UuZW1pdCgpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLnByb3BzID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLmZpZWxkTmFtZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5wb3BvdmVyUmVmZXJlbmNlRWxlbWVudCA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5zdHJpbmdzID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLmN1cnJlbnRMYW5ndWFnZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5pc09wZW4gPSBmYWxzZTtcbiAgICAgICAgdGhpcy5yZVJlbmRlciA9IGZhbHNlO1xuICAgIH1cbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy9cbiAgICAvLyAgUHVibGljIE1ldGhvZHNcbiAgICAvL1xuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICBhc3luYyByZXBvc2l0aW9uKCkge1xuICAgICAgICB2YXIgX2E7XG4gICAgICAgIChfYSA9IHRoaXMucG9wb3Zlck5vZGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5yZXBvc2l0aW9uKCk7XG4gICAgfVxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvL1xuICAgIC8vICBMaWZlY3ljbGVcbiAgICAvL1xuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICBhc3luYyBjb21wb25lbnRXaWxsTG9hZCgpIHtcbiAgICAgICAgY29uc3QgeyBsYXllciB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgdGhpcy5maWVsZHNNYXAgPSBhd2FpdCBnZW5lcmF0ZUxheWVyRmllbGRzTWFwKGxheWVyKTtcbiAgICB9XG4gICAgY29tcG9uZW50RGlkTG9hZCgpIHtcbiAgICAgICAgdGhpcy5yZXBvc2l0aW9uKCk7XG4gICAgICAgIHRoaXMuaXNPcGVuID0gdHJ1ZTtcbiAgICAgICAgLy8gbmVlZCB0aW1lb3V0IGJlY2F1c2Ugb2YgcmUtcmVuZGVyXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHRoaXMuY2xvc2VCdXR0b25Ob2RlLnNldEZvY3VzKCkpLCAxMDApO1xuICAgIH1cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vXG4gICAgLy8gIFJlbmRlciBNZXRob2RzXG4gICAgLy9cbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCB7IGZpZWxkTmFtZSwgZmllbGRzTWFwLCBwb3BvdmVyUmVmZXJlbmNlRWxlbWVudCB9ID0gdGhpcztcbiAgICAgICAgY29uc3QgZmllbGQgPSBmaWVsZHNNYXAuZ2V0KGZpZWxkTmFtZSk7XG4gICAgICAgIHJldHVybiAoaChIb3N0LCB7IGNsYXNzOiBcImpzLWFwcC1mbHlvdXRcIiB9LCBoKFwiY2FsY2l0ZS1wb3BvdmVyXCIsIHsgcGxhY2VtZW50OiBcImxlYWRpbmdcIiwgZGlyOiBkb2N1bWVudC5kaXIsIG9wZW46IHRoaXMuaXNPcGVuLCBwb2ludGVyRGlzYWJsZWQ6IHRydWUsIHJlZmVyZW5jZUVsZW1lbnQ6IHBvcG92ZXJSZWZlcmVuY2VFbGVtZW50LCBvZmZzZXREaXN0YW5jZTogLTQ4LCBvZmZzZXRTa2lkZGluZzogMCwgY2xhc3M6IENTUyQxLnBvcG92ZXIsIGxhYmVsOiBcIlwiLCByZWY6IHRoaXMuYWZ0ZXJDcmVhdGVQb3BvdmVyIH0sIGgoXCJjYWxjaXRlLWZsb3dcIiwgeyBjbGFzczogQ1NTJDEuZmxvdyB9LCBoKFwiY2FsY2l0ZS1mbG93LWl0ZW1cIiwgeyBoZWFkaW5nOiBmaWVsZC5hbGlhcyB8fCBmaWVsZC5uYW1lLCBkZXNjcmlwdGlvbjogZmllbGROYW1lIH0sIHRoaXMucmVuZGVyQ2xvc2VCdXR0b24oKSwgdGhpcy5yZW5kZXJJbmZvKCkpKSkpKTtcbiAgICB9XG4gICAgcmVuZGVyQ2xvc2VCdXR0b24oKSB7XG4gICAgICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gdGhpcztcbiAgICAgICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyB0ZXh0OiBzdHJpbmdzLmNsb3NlLCBzY2FsZTogXCJzXCIsIHNsb3Q6IFwiaGVhZGVyLWFjdGlvbnMtZW5kXCIsIG9uQ2xpY2s6IHRoaXMuaGFuZGxlQ2xvc2VDbGljaywgcmVmOiB0aGlzLmFmdGVyQ3JlYXRlQ2xvc2VCdXR0b24sIGljb246IFwieFwiIH0pKTtcbiAgICB9XG4gICAgcmVuZGVySW5mbygpIHtcbiAgICAgICAgY29uc3QgeyBsYXllciwgdmlldyB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgeyBmaWVsZE5hbWUsIGN1cnJlbnRMYW5ndWFnZSB9ID0gdGhpcztcbiAgICAgICAgcmV0dXJuIChoKFwiYXJjZ2lzLWZpZWxkLWluZm9cIiwgeyBmaWVsZE5hbWU6IGZpZWxkTmFtZSwgbGF5ZXI6IGxheWVyLCB2aWV3OiB2aWV3LCBsYW5nOiBjdXJyZW50TGFuZ3VhZ2UsIGNsYXNzOiBDU1MkMS5pbmZvLCByZWY6IHRoaXMuYWZ0ZXJDcmVhdGVGaWVsZEluZm8gfSkpO1xuICAgIH1cbiAgICBnZXQgaG9zdEVsZW1lbnQoKSB7IHJldHVybiBnZXRFbGVtZW50KHRoaXMpOyB9XG59O1xuQXJjZ2lzVGFibGVDb2x1bW5JbmZvLnN0eWxlID0gYXJjZ2lzVGFibGVDb2x1bW5JbmZvQ3NzO1xuXG5jb25zdCBDU1MgPSB7XG4gICAgcG9wb3ZlcjogXCJwb3BvdmVyXCIsXG4gICAgZmxvdzogXCJmbG93XCIsXG4gICAgaW5mbzogXCJpbmZvXCIsXG4gICAgc2VsZWN0QnV0dG9uOiBcInNlbGVjdC1idXR0b25cIlxufTtcblxuY29uc3QgYXJjZ2lzVGFibGVGaWVsZFNlbGVjdGlvbkNzcyA9IFwiLmZsb3d7bWF4LWhlaWdodDo0MDBweDt3aWR0aDoyODBweH0uY29udGVudHttYXgtaGVpZ2h0Ojgwdmh9LmluZm97YmFja2dyb3VuZC1jb2xvcjojZmZmZmZmfS5zZWxlY3QtYnV0dG9ue21hcmdpbjo0cHggMH1cIjtcblxuY29uc3QgQXJjZ2lzVGFibGVGaWVsZFNlbGVjdGlvbiA9IGNsYXNzIHtcbiAgICBjb25zdHJ1Y3Rvcihob3N0UmVmKSB7XG4gICAgICAgIHJlZ2lzdGVySW5zdGFuY2UodGhpcywgaG9zdFJlZik7XG4gICAgICAgIHRoaXMuYXJjZ2lzVGFibGVGaWVsZFNlbGVjdGlvbkNsb3NlID0gY3JlYXRlRXZlbnQodGhpcywgXCJhcmNnaXNUYWJsZUZpZWxkU2VsZWN0aW9uQ2xvc2VcIiwgNyk7XG4gICAgICAgIHRoaXMuY29sdW1uVGVtcGxhdGVzQ2hhbmdlID0gY3JlYXRlRXZlbnQodGhpcywgXCJjb2x1bW5UZW1wbGF0ZXNDaGFuZ2VcIiwgNyk7XG4gICAgICAgIHRoaXMuZmllbGRTb3J0QnlDaGFuZ2UgPSBjcmVhdGVFdmVudCh0aGlzLCBcImZpZWxkU29ydEJ5Q2hhbmdlXCIsIDcpO1xuICAgICAgICB0aGlzLmF0dGFjaG1lbnRzQ2hhbmdlID0gY3JlYXRlRXZlbnQodGhpcywgXCJhdHRhY2htZW50c0NoYW5nZVwiLCA3KTtcbiAgICAgICAgdGhpcy53YWl0SGFuZGxlciA9IG51bGw7XG4gICAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICAgIC8vXG4gICAgICAgIC8vICBQcml2YXRlIG1ldGhvZHNcbiAgICAgICAgLy9cbiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAgICAgdGhpcy5hZnRlckNyZWF0ZVBvcG92ZXIgPSAobm9kZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5wb3BvdmVyTm9kZSA9IG5vZGU7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuYWZ0ZXJDcmVhdGVGbG93ID0gKG5vZGUpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZmxvd05vZGUgPSBub2RlO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLmFmdGVyQ3JlYXRlRmxvd0l0ZW0gPSAobm9kZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5maXJzdFBhbmVsTm9kZSA9IG5vZGU7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuYWZ0ZXJDcmVhdGVDbG9zZUJ1dHRvbiA9IChub2RlKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmNsb3NlQnV0dG9uTm9kZSA9IG5vZGU7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuYWZ0ZXJDcmVhdGVQaWNrTGlzdCA9IChub2RlKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnBpY2tMaXN0Tm9kZSA9IG5vZGU7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuYWZ0ZXJDcmVhdGVQaWNrTGlzdEl0ZW0gPSAobm9kZSkgPT4ge1xuICAgICAgICAgICAgbm9kZS5hZGRFdmVudExpc3RlbmVyKFwiY2FsY2l0ZUxpc3RJdGVtQ2hhbmdlXCIsIChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlQ2FsY2l0ZUxpc3RJdGVtQ2hhbmdlKGV2ZW50KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLmFmdGVyQ3JlYXRlUGlja0xpc3RJdGVtQXR0YWNobWVudHMgPSAobm9kZSkgPT4ge1xuICAgICAgICAgICAgbm9kZS5hZGRFdmVudExpc3RlbmVyKFwiY2FsY2l0ZUxpc3RJdGVtQ2hhbmdlXCIsIChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlQ2FsY2l0ZUF0dGFjaG1lbnRzSXRlbUNoYW5nZShldmVudCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5oYW5kbGVDbG9zZUNsaWNrID0gKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5hcmNnaXNUYWJsZUZpZWxkU2VsZWN0aW9uQ2xvc2UuZW1pdCgpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLnByb3BzID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLmNvbHVtblRlbXBsYXRlcyA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5hdHRhY2htZW50c0VuYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5wb3BvdmVyUmVmZXJlbmNlRWxlbWVudCA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5zb3J0QnkgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuc3RyaW5ncyA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5jdXJyZW50TGFuZ3VhZ2UgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMucmVSZW5kZXIgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5sYXN0U29ydEJ5ID0gTGFzdFNvcnR5QnkuZGlzcGxheTtcbiAgICAgICAgdGhpcy5maWx0ZXJGaWVsZHMgPSBudWxsO1xuICAgICAgICB0aGlzLmlzT3BlbiA9IGZhbHNlO1xuICAgIH1cbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy9cbiAgICAvLyAgUHVibGljIE1ldGhvZHNcbiAgICAvL1xuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICBhc3luYyByZXBvc2l0aW9uKCkge1xuICAgICAgICB2YXIgX2E7XG4gICAgICAgIChfYSA9IHRoaXMucG9wb3Zlck5vZGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5yZXBvc2l0aW9uKCk7XG4gICAgfVxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvL1xuICAgIC8vICBMaWZlY3ljbGVcbiAgICAvL1xuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICBhc3luYyBjb21wb25lbnRXaWxsTG9hZCgpIHtcbiAgICAgICAgY29uc3QgeyBsYXllciB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgdGhpcy5maWVsZHNNYXAgPSBhd2FpdCBnZW5lcmF0ZUxheWVyRmllbGRzTWFwKGxheWVyKTtcbiAgICAgICAgdGhpcy50b3RhbENvdW50cyA9IHRoaXMuZ2V0VG90YWxGaWVsZFR5cGVDb3VudCgpO1xuICAgICAgICB0aGlzLmxhc3RTb3J0QnkgPSB0aGlzLnNvcnRCeSB8fCBMYXN0U29ydHlCeS5kZWZhdWx0O1xuICAgIH1cbiAgICBjb21wb25lbnREaWRMb2FkKCkge1xuICAgICAgICB0aGlzLnJlcG9zaXRpb24oKTtcbiAgICAgICAgdGhpcy5pc09wZW4gPSB0cnVlO1xuICAgICAgICAvLyBuZWVkIHRpbWVvdXQgYmVjYXVzZSBvZiByZS1yZW5kZXJcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gdGhpcy5jbG9zZUJ1dHRvbk5vZGUuc2V0Rm9jdXMoKSksIDIwMCk7XG4gICAgfVxuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy9cbiAgICAvLyAgUmVuZGVyIE1ldGhvZHNcbiAgICAvL1xuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICByZW5kZXIoKSB7XG4gICAgICAgIGNvbnN0IHsgc3RyaW5ncywgcG9wb3ZlclJlZmVyZW5jZUVsZW1lbnQgfSA9IHRoaXM7XG4gICAgICAgIHJldHVybiAoaChIb3N0LCB7IGNsYXNzOiBcImpzLWFwcC1mbHlvdXRcIiB9LCBoKFwiY2FsY2l0ZS1wb3BvdmVyXCIsIHsgcGxhY2VtZW50OiBcImxlYWRpbmdcIiwgZGlyOiBkb2N1bWVudC5kaXIsIG9wZW46IHRoaXMuaXNPcGVuLCBwb2ludGVyRGlzYWJsZWQ6IHRydWUsIHJlZmVyZW5jZUVsZW1lbnQ6IHBvcG92ZXJSZWZlcmVuY2VFbGVtZW50LCBvZmZzZXREaXN0YW5jZTogLTQ4LCBvZmZzZXRTa2lkZGluZzogMCwgY2xhc3M6IENTUy5wb3BvdmVyLCBsYWJlbDogXCJcIiwgcmVmOiB0aGlzLmFmdGVyQ3JlYXRlUG9wb3ZlciB9LCBoKFwiY2FsY2l0ZS1mbG93XCIsIHsgY2xhc3M6IENTUy5mbG93LCByZWY6IHRoaXMuYWZ0ZXJDcmVhdGVGbG93IH0sIGgoXCJjYWxjaXRlLWZsb3ctaXRlbVwiLCB7IGhlYWRpbmc6IHN0cmluZ3MuZmllbGRWaXNpYmlsaXR5LCByZWY6IHRoaXMuYWZ0ZXJDcmVhdGVGbG93SXRlbSB9LCB0aGlzLnJlbmRlckNsb3NlQnV0dG9uKCksIHRoaXMucmVuZGVyRG9uZUJ1dHRvbigpLCB0aGlzLnJlbmRlclBpY2tMaXN0KCkpKSkpKTtcbiAgICB9XG4gICAgcmVuZGVyQ2xvc2VCdXR0b24oKSB7XG4gICAgICAgIGNvbnN0IHsgc3RyaW5ncyB9ID0gdGhpcztcbiAgICAgICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyB0ZXh0OiBzdHJpbmdzLmNsb3NlLCBzY2FsZTogXCJzXCIsIHNsb3Q6IFwiaGVhZGVyLWFjdGlvbnMtZW5kXCIsIG9uQ2xpY2s6IHRoaXMuaGFuZGxlQ2xvc2VDbGljaywgaWNvbjogXCJ4XCIsIHJlZjogdGhpcy5hZnRlckNyZWF0ZUNsb3NlQnV0dG9uIH0pKTtcbiAgICB9XG4gICAgcmVuZGVyRG9uZUJ1dHRvbigpIHtcbiAgICAgICAgY29uc3QgeyBzdHJpbmdzIH0gPSB0aGlzO1xuICAgICAgICByZXR1cm4gKGgoXCJjYWxjaXRlLWJ1dHRvblwiLCB7IGFwcGVhcmFuY2U6IFwib3V0bGluZS1maWxsXCIsIHNjYWxlOiBcIm1cIiwgc2xvdDogXCJmb290ZXJcIiwgd2lkdGg6IFwiZnVsbFwiLCBvbkNsaWNrOiB0aGlzLmhhbmRsZUNsb3NlQ2xpY2ssIGxhYmVsOiBzdHJpbmdzLmRvbmUgfSwgc3RyaW5ncy5kb25lKSk7XG4gICAgfVxuICAgIHJlbmRlclBpY2tMaXN0KCkge1xuICAgICAgICBjb25zdCB7IHN0cmluZ3MgfSA9IHRoaXM7XG4gICAgICAgIHJldHVybiAoaChcImNhbGNpdGUtcGljay1saXN0XCIsIHsgY2xhc3M6IFwiY29udGVudFwiLCBcImRyYWctZW5hYmxlZFwiOiBmYWxzZSwgbXVsdGlwbGU6IHRydWUsIGZpbHRlckVuYWJsZWQ6IHRydWUsIGZpbHRlclBsYWNlaG9sZGVyOiBzdHJpbmdzLmZpbHRlckZpZWxkcywgcmVmOiB0aGlzLmFmdGVyQ3JlYXRlUGlja0xpc3QsIG9uQ2FsY2l0ZUxpc3RGaWx0ZXI6IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IG5vZGUgPSBldmVudC50YXJnZXQ7XG4gICAgICAgICAgICAgICAgdGhpcy5maWx0ZXJGaWVsZHMgPSBub2RlLmZpbHRlcmVkSXRlbXM7XG4gICAgICAgICAgICB9IH0sIHRoaXMucmVuZGVyU2VsZWN0aW9uKCksIHRoaXMucmVuZGVyU29ydCgpLCB0aGlzLnJlbmRlclBpY2tMaXN0SXRlbXMoKSwgdGhpcy5yZW5kZXJBdHRhY2htZW50UGlja0xpc3RJdGVtKCkpKTtcbiAgICB9XG4gICAgcmVuZGVyU2VsZWN0aW9uKCkge1xuICAgICAgICBjb25zdCB7IGZpbHRlckZpZWxkcywgc3RyaW5ncyB9ID0gdGhpcztcbiAgICAgICAgY29uc3QgY29udGFpbnNBbGwgPSB0aGlzLmZpbHRlckNvbnRhaW5zQWxsKCk7XG4gICAgICAgIHJldHVybiAoaChcImNhbGNpdGUtYnV0dG9uXCIsIHsga2V5OiBgJHtmaWx0ZXJGaWVsZHN9YCwgY2xhc3M6IENTUy5zZWxlY3RCdXR0b24sIGFwcGVhcmFuY2U6IFwidHJhbnNwYXJlbnRcIiwgc2NhbGU6IFwic1wiLCB3aWR0aDogXCJmdWxsXCIsIG9uQ2xpY2s6ICgpID0+IHRoaXMuaGFuZGxlU2VsZWN0aW9uQWxsQ2xpY2soY29udGFpbnNBbGwpLCBsYWJlbDogY29udGFpbnNBbGwgPyBzdHJpbmdzLmRlc2VsZWN0QWxsIDogc3RyaW5ncy5zZWxlY3RBbGwgfSwgY29udGFpbnNBbGwgPyBzdHJpbmdzLmRlc2VsZWN0QWxsIDogc3RyaW5ncy5zZWxlY3RBbGwpKTtcbiAgICB9XG4gICAgcmVuZGVyU29ydCgpIHtcbiAgICAgICAgY29uc3QgeyBsYXN0U29ydEJ5LCB0b3RhbENvdW50cywgc3RyaW5ncyB9ID0gdGhpcztcbiAgICAgICAgbGV0IGhhc051bWJlckZpZWxkcyA9IHRvdGFsQ291bnRzLm51bWJlciA+IDA7XG4gICAgICAgIGxldCBoYXNTdHJpbmdGaWVsZHMgPSB0b3RhbENvdW50cy5zdHJpbmcgPiAwO1xuICAgICAgICBsZXQgaGFzRGF0ZUZpZWxkcyA9IHRvdGFsQ291bnRzLmRhdGUgPiAwO1xuICAgICAgICBsZXQgY2FuU2hvd1NvcnQgPSBoYXNOdW1iZXJGaWVsZHMgJiYgKGhhc1N0cmluZ0ZpZWxkcyB8fCBoYXNEYXRlRmllbGRzKVxuICAgICAgICAgICAgPyB0cnVlXG4gICAgICAgICAgICA6IGhhc1N0cmluZ0ZpZWxkcyAmJiBoYXNEYXRlRmllbGRzXG4gICAgICAgICAgICAgICAgPyB0cnVlXG4gICAgICAgICAgICAgICAgOiBmYWxzZTtcbiAgICAgICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1kcm9wZG93blwiLCB7IHNsb3Q6IFwibWVudS1hY3Rpb25zXCIsIHBsYWNlbWVudDogXCJib3R0b20tZW5kXCIsIG92ZXJsYXlQb3NpdGlvbmluZzogXCJmaXhlZFwiIH0sIGgoXCJjYWxjaXRlLWFjdGlvblwiLCB7IHNsb3Q6IFwidHJpZ2dlclwiLCB0ZXh0OiBzdHJpbmdzLnNvcnRGaWVsZHMsIGxhYmVsOiBzdHJpbmdzLnNvcnRGaWVsZHMsIFwiYXJpYS1sYWJlbFwiOiBzdHJpbmdzLnNvcnRGaWVsZHMgfSwgaChcImNhbGNpdGUtaWNvblwiLCB7IHNjYWxlOiBcInNcIiwgaWNvbjogXCJzb3J0RGVzY2VuZGluZ1wiIH0pKSwgaChcImNhbGNpdGUtZHJvcGRvd24tZ3JvdXBcIiwgeyBcImdyb3VwLXRpdGxlXCI6IHN0cmluZ3Muc29ydEJ5IH0sIGgoXCJjYWxjaXRlLWRyb3Bkb3duLWl0ZW1cIiwgeyBzZWxlY3RlZDogbGFzdFNvcnRCeSA9PT0gTGFzdFNvcnR5QnkuZGVmYXVsdCwgb25DbGljazogKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubGFzdFNvcnRCeSA9IExhc3RTb3J0eUJ5LmRlZmF1bHQ7XG4gICAgICAgICAgICAgICAgdGhpcy5maWVsZFNvcnRCeUNoYW5nZS5lbWl0KHRoaXMubGFzdFNvcnRCeSk7XG4gICAgICAgICAgICB9IH0sIHN0cmluZ3MuZGVmYXVsdCksIGgoXCJjYWxjaXRlLWRyb3Bkb3duLWl0ZW1cIiwgeyBzZWxlY3RlZDogbGFzdFNvcnRCeSA9PT0gTGFzdFNvcnR5QnkuZGlzcGxheSwgb25DbGljazogKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubGFzdFNvcnRCeSA9IExhc3RTb3J0eUJ5LmRpc3BsYXk7XG4gICAgICAgICAgICAgICAgdGhpcy5maWVsZFNvcnRCeUNoYW5nZS5lbWl0KHRoaXMubGFzdFNvcnRCeSk7XG4gICAgICAgICAgICB9IH0sIHN0cmluZ3Muc29ydEJ5RGlzcGxheU5hbWUpLCBjYW5TaG93U29ydCA/IChoKFwiY2FsY2l0ZS1kcm9wZG93bi1pdGVtXCIsIHsgc2VsZWN0ZWQ6IGxhc3RTb3J0QnkgPT09IExhc3RTb3J0eUJ5LnR5cGUsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmxhc3RTb3J0QnkgPSBMYXN0U29ydHlCeS50eXBlO1xuICAgICAgICAgICAgICAgIHRoaXMuZmllbGRTb3J0QnlDaGFuZ2UuZW1pdCh0aGlzLmxhc3RTb3J0QnkpO1xuICAgICAgICAgICAgfSB9LCBzdHJpbmdzLnNvcnRCeVR5cGUpKSA6IG51bGwsIGgoXCJjYWxjaXRlLWRyb3Bkb3duLWl0ZW1cIiwgeyBzZWxlY3RlZDogbGFzdFNvcnRCeSA9PT0gTGFzdFNvcnR5QnkuZmllbGQsIG9uQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmxhc3RTb3J0QnkgPSBMYXN0U29ydHlCeS5maWVsZDtcbiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkU29ydEJ5Q2hhbmdlLmVtaXQodGhpcy5sYXN0U29ydEJ5KTtcbiAgICAgICAgICAgIH0gfSwgc3RyaW5ncy5zb3J0QnlGaWVsZE5hbWUpKSkpO1xuICAgIH1cbiAgICByZW5kZXJQaWNrTGlzdEl0ZW1zKCkge1xuICAgICAgICBjb25zdCB7IGxhc3RTb3J0QnkgfSA9IHRoaXM7XG4gICAgICAgIGxldCBjb2x1bW5UZW1wbGF0ZXMgPSB0aGlzLmNsb25lRmllbGRUZW1wbGF0ZXMoKTtcbiAgICAgICAgaWYgKGxhc3RTb3J0QnkgPT09IExhc3RTb3J0eUJ5LmRpc3BsYXkpIHtcbiAgICAgICAgICAgIGNvbHVtblRlbXBsYXRlcyA9IHRoaXMuc29ydEZpZWxkc0FscGhhYmV0aWNhbGx5KGNvbHVtblRlbXBsYXRlcyk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAobGFzdFNvcnRCeSA9PT0gTGFzdFNvcnR5QnkudHlwZSkge1xuICAgICAgICAgICAgY29sdW1uVGVtcGxhdGVzID0gdGhpcy5zb3J0RmllbGRzQnlUeXBlKHRoaXMuc29ydEZpZWxkc0FscGhhYmV0aWNhbGx5KGNvbHVtblRlbXBsYXRlcykpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGxhc3RTb3J0QnkgPT09IExhc3RTb3J0eUJ5LmZpZWxkKSB7XG4gICAgICAgICAgICBjb2x1bW5UZW1wbGF0ZXMuc29ydCgoYSwgYikgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBhLmZpZWxkTmFtZS5sb2NhbGVDb21wYXJlKGIuZmllbGROYW1lKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgO1xuICAgICAgICByZXR1cm4gY29sdW1uVGVtcGxhdGVzLm1hcCgoY29sdW1uVGVtcGxhdGUpID0+IHRoaXMucmVuZGVyUGlja0xpc3RJdGVtKGNvbHVtblRlbXBsYXRlKSk7XG4gICAgfVxuICAgIHJlbmRlclBpY2tMaXN0SXRlbShjb2x1bW5UZW1wbGF0ZSkge1xuICAgICAgICBjb25zdCB7IHN0cmluZ3MsIGZpbHRlckZpZWxkcyB9ID0gdGhpcztcbiAgICAgICAgbGV0IGlzSGlkZGVuID0gZmFsc2U7XG4gICAgICAgIGlmIChmaWx0ZXJGaWVsZHMgJiZcbiAgICAgICAgICAgICFmaWx0ZXJGaWVsZHMuc29tZSgoZmlsdGVyRmllbGQpID0+IGZpbHRlckZpZWxkLnZhbHVlID09PSBjb2x1bW5UZW1wbGF0ZS5maWVsZE5hbWUpKSB7XG4gICAgICAgICAgICBpc0hpZGRlbiA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIChoKFwiY2FsY2l0ZS1waWNrLWxpc3QtaXRlbVwiLCB7IGtleTogY29sdW1uVGVtcGxhdGUuZmllbGROYW1lLCBsYWJlbDogY29sdW1uVGVtcGxhdGUubGFiZWwsXG4gICAgICAgICAgICAvL2Rlc2NyaXB0aW9uPXtmaWVsZENvbmZpZy5uYW1lfVxuICAgICAgICAgICAgdmFsdWU6IGNvbHVtblRlbXBsYXRlLmZpZWxkTmFtZSwgc2VsZWN0ZWQ6IGNvbHVtblRlbXBsYXRlLnZpc2libGUsIGhpZGRlbjogaXNIaWRkZW4sIHJlZjogdGhpcy5hZnRlckNyZWF0ZVBpY2tMaXN0SXRlbSB9LCBoKFwiY2FsY2l0ZS1hY3Rpb25cIiwgeyBzbG90OiBcImFjdGlvbnMtZW5kXCIsIHRleHQ6IHN0cmluZ3MuaW5mbywgb25DbGljazogKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVJbmZvQ2xpY2soY29sdW1uVGVtcGxhdGUsIGV2ZW50LnRhcmdldCk7XG4gICAgICAgICAgICB9IH0sIGgoXCJjYWxjaXRlLWljb25cIiwgeyBzY2FsZTogXCJzXCIsIGljb246IFwiaW5mb3JtYXRpb25cIiB9KSkpKTtcbiAgICB9XG4gICAgcmVuZGVyQXR0YWNobWVudFBpY2tMaXN0SXRlbSgpIHtcbiAgICAgICAgY29uc3QgeyBsYXllciB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgY29uc3QgeyBzdHJpbmdzLCBhdHRhY2htZW50c0VuYWJsZWQgfSA9IHRoaXM7XG4gICAgICAgIGlmIChsYXllci50eXBlID09PSBcImltYWdlcnlcIikge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGxheWVyLnR5cGUgPT09IFwiZmVhdHVyZVwiICYmICFoYXNBdHRhY2htZW50c0VuYWJsZWQobGF5ZXIpKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gKGgoXCJjYWxjaXRlLXBpY2stbGlzdC1pdGVtXCIsIHsga2V5OiBcImF0dGFjaG1lbnRzXCIsIGxhYmVsOiBzdHJpbmdzLnBob3Rvc0FuZEZpbGVzLCBkZXNjcmlwdGlvbjogc3RyaW5ncy5hdHRhY2htZW50cywgdmFsdWU6IFwiX19hdHRhY2htZW50c1wiLCBzZWxlY3RlZDogYXR0YWNobWVudHNFbmFibGVkLCBoaWRkZW46IGZhbHNlLCByZWY6IHRoaXMuYWZ0ZXJDcmVhdGVQaWNrTGlzdEl0ZW1BdHRhY2htZW50cyB9KSk7XG4gICAgfVxuICAgIGhhbmRsZVNlbGVjdGlvbkFsbENsaWNrKGNvbnRhaW5zQWxsKSB7XG4gICAgICAgIGNvbnN0IHsgY29sdW1uVGVtcGxhdGVzLCBmaWx0ZXJGaWVsZHMgfSA9IHRoaXM7XG4gICAgICAgIC8vIHVwZGF0ZSBmaWVsZENvbmZpZ3NcbiAgICAgICAgY29sdW1uVGVtcGxhdGVzLmZvckVhY2goKGNvbHVtblRlbXBsYXRlKSA9PiB7XG4gICAgICAgICAgICBpZiAoIWZpbHRlckZpZWxkcyB8fFxuICAgICAgICAgICAgICAgIGZpbHRlckZpZWxkcy5zb21lKChmaWx0ZXJGaWVsZCkgPT4gZmlsdGVyRmllbGQudmFsdWUgPT09IGNvbHVtblRlbXBsYXRlLmZpZWxkTmFtZSkpIHtcbiAgICAgICAgICAgICAgICBjb2x1bW5UZW1wbGF0ZS52aXNpYmxlID0gIWNvbnRhaW5zQWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgLy8gdXBkYXRlIHBpY2stbGlzdC1pdGVtc1xuICAgICAgICB0aGlzLnBpY2tMaXN0Tm9kZVxuICAgICAgICAgICAgLnF1ZXJ5U2VsZWN0b3JBbGwoXCJjYWxjaXRlLXBpY2stbGlzdC1pdGVtXCIpXG4gICAgICAgICAgICAuZm9yRWFjaCgoaXRlbSkgPT4ge1xuICAgICAgICAgICAgaWYgKCFmaWx0ZXJGaWVsZHMgfHxcbiAgICAgICAgICAgICAgICBmaWx0ZXJGaWVsZHMuc29tZSgoZmlsdGVyRmllbGQpID0+IGZpbHRlckZpZWxkLnZhbHVlID09PSBpdGVtLmdldEF0dHJpYnV0ZShcInZhbHVlXCIpKSkge1xuICAgICAgICAgICAgICAgIGlmICghY29udGFpbnNBbGwpIHtcbiAgICAgICAgICAgICAgICAgICAgaXRlbS5zZXRBdHRyaWJ1dGUoXCJzZWxlY3RlZFwiLCBcInRydWVcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpdGVtLnJlbW92ZUF0dHJpYnV0ZShcInNlbGVjdGVkXCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMucmVSZW5kZXIgPSAhdGhpcy5yZVJlbmRlcjtcbiAgICB9XG4gICAgaGFuZGxlQ2FsY2l0ZUxpc3RJdGVtQ2hhbmdlKHsgZGV0YWlsOiB7IHZhbHVlLCBzZWxlY3RlZCB9IH0pIHtcbiAgICAgICAgY29uc3QgeyBjb2x1bW5UZW1wbGF0ZXMgfSA9IHRoaXM7XG4gICAgICAgIGNvbHVtblRlbXBsYXRlcy5mb3JFYWNoKChjb2x1bW5UZW1wbGF0ZSkgPT4ge1xuICAgICAgICAgICAgaWYgKGNvbHVtblRlbXBsYXRlLmZpZWxkTmFtZSA9PT0gdmFsdWUpIHtcbiAgICAgICAgICAgICAgICBjb2x1bW5UZW1wbGF0ZS52aXNpYmxlID0gc2VsZWN0ZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICAvLyBkb24ndCBmaXJlIHRvbyBtYW55IHVwZGF0ZXMgYXQgb25jZVxuICAgICAgICAvLyBlLmcuIGFmdGVyIGEgdXNlciBjbGlja3MgJ1NlbGVjdCBhbGwnXG4gICAgICAgIGlmICh0aGlzLndhaXRIYW5kbGVyKSB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy53YWl0SGFuZGxlcik7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy53YWl0SGFuZGxlciA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy53YWl0SGFuZGxlciA9IG51bGw7XG4gICAgICAgICAgICB0aGlzLmNvbHVtblRlbXBsYXRlc0NoYW5nZS5lbWl0KHRoaXMuY2xvbmVGaWVsZFRlbXBsYXRlcygpKTtcbiAgICAgICAgICAgIC8vIGNhdXNlcyBhIHN0YXRlIGNoYW5nZVxuICAgICAgICAgICAgdGhpcy5yZVJlbmRlciA9ICF0aGlzLnJlUmVuZGVyO1xuICAgICAgICB9LCAxMDApO1xuICAgIH1cbiAgICBoYW5kbGVDYWxjaXRlQXR0YWNobWVudHNJdGVtQ2hhbmdlKHsgZGV0YWlsOiB7IHNlbGVjdGVkIH0gfSkge1xuICAgICAgICB0aGlzLmF0dGFjaG1lbnRzQ2hhbmdlLmVtaXQoc2VsZWN0ZWQpO1xuICAgICAgICB0aGlzLmF0dGFjaG1lbnRzRW5hYmxlZCA9IHNlbGVjdGVkO1xuICAgIH1cbiAgICBoYW5kbGVJbmZvQ2xpY2soY29sdW1uVGVtcGxhdGUsIGFjdGlvbikge1xuICAgICAgICB2YXIgX2E7XG4gICAgICAgIGNvbnN0IHsgbGF5ZXIsIHZpZXcgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IHsgZmxvd05vZGUsIGZpcnN0UGFuZWxOb2RlLCBjdXJyZW50TGFuZ3VhZ2UgfSA9IHRoaXM7XG4gICAgICAgIGNvbnN0IHJlY3QgPSBmaXJzdFBhbmVsTm9kZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAgICAgY29uc3QgZmllbGRJbmZvID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFyY2dpcy1maWVsZC1pbmZvXCIpO1xuICAgICAgICBmaWVsZEluZm8ubGFuZyA9IGN1cnJlbnRMYW5ndWFnZTtcbiAgICAgICAgZmllbGRJbmZvLmZpZWxkTmFtZSA9IGNvbHVtblRlbXBsYXRlLmZpZWxkTmFtZTtcbiAgICAgICAgZmllbGRJbmZvLmxheWVyID0gbGF5ZXI7XG4gICAgICAgIGZpZWxkSW5mby52aWV3ID0gdmlldztcbiAgICAgICAgZmllbGRJbmZvLmNsYXNzTmFtZSA9IENTUy5pbmZvO1xuICAgICAgICBjb25zdCBmaWVsZEluZm9GbG93SXRlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJjYWxjaXRlLWZsb3ctaXRlbVwiKTtcbiAgICAgICAgZmllbGRJbmZvRmxvd0l0ZW0uaGVhZGluZyA9IChfYSA9IGNvbHVtblRlbXBsYXRlLmxhYmVsKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiBjb2x1bW5UZW1wbGF0ZS5maWVsZE5hbWU7XG4gICAgICAgIGZpZWxkSW5mb0Zsb3dJdGVtLmRlc2NyaXB0aW9uID0gY29sdW1uVGVtcGxhdGUuZmllbGROYW1lO1xuICAgICAgICAvLyBtYWtpbmcgdGhlIHN3aXRjaCBzbW9vdGhseVxuICAgICAgICBmaWVsZEluZm9GbG93SXRlbS5zdHlsZS5oZWlnaHQgPSBgJHtyZWN0LmhlaWdodH1weGA7XG4gICAgICAgIGZpZWxkSW5mb0Zsb3dJdGVtLnN0eWxlLndpZHRoID0gYCR7cmVjdC53aWR0aH1weGA7XG4gICAgICAgIGZpZWxkSW5mb0Zsb3dJdGVtLmFwcGVuZENoaWxkKGZpZWxkSW5mbyk7XG4gICAgICAgIGZpZWxkSW5mb0Zsb3dJdGVtLmFkZEV2ZW50TGlzdGVuZXIoXCJjYWxjaXRlRmxvd0l0ZW1CYWNrXCIsICgpID0+IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiBhY3Rpb24uc2V0Rm9jdXMoKSkpO1xuICAgICAgICBmbG93Tm9kZS5hcHBlbmRDaGlsZChmaWVsZEluZm9GbG93SXRlbSk7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4gZmllbGRJbmZvRmxvd0l0ZW0uc2V0Rm9jdXMoKSwgMjAwKTtcbiAgICAgICAgdGhpcy5yZXBvc2l0aW9uKCk7XG4gICAgfVxuICAgIGNsb25lRmllbGRUZW1wbGF0ZXMoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbHVtblRlbXBsYXRlcy5tYXAoKGNvbHVtblRlbXBsYXRlKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgY29sdW1uVGVtcGxhdGUpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgLy8gY2hlY2sgaWYgZmlsdGVyIGNvbnRhaW5zIGFsbCBjdXJyZW50IGZpZWxkIGNvbmZpZ3NcbiAgICBmaWx0ZXJDb250YWluc0FsbCgpIHtcbiAgICAgICAgY29uc3QgeyBjb2x1bW5UZW1wbGF0ZXMsIGZpbHRlckZpZWxkcywgYXR0YWNobWVudHNFbmFibGVkIH0gPSB0aGlzO1xuICAgICAgICBpZiAoZmlsdGVyRmllbGRzKSB7XG4gICAgICAgICAgICAvLyBhdHRhY2htZW50IGNvbHVtbiBpcyBwYXJ0IG9mIHRoZSBmaWx0ZXIsIGJ1dCBub3QgcGFydCBvZiB0aGUgZmllbGRDb25maWdzXG4gICAgICAgICAgICBjb25zdCBmaWx0ZXJGaWVsZHNGaWVsZHMgPSBmaWx0ZXJGaWVsZHNcbiAgICAgICAgICAgICAgICAuZmlsdGVyKChmaWx0ZXJGaWVsZCkgPT4gZmlsdGVyRmllbGQudmFsdWUgIT09IFwiX19hdHRhY2htZW50c1wiKVxuICAgICAgICAgICAgICAgIC5tYXAoKGZpbHRlckZpZWxkKSA9PiAoeyB2YWx1ZTogZmlsdGVyRmllbGQudmFsdWUsIHNlbGVjdGVkOiBmaWx0ZXJGaWVsZC5zZWxlY3RlZCB9KSk7XG4gICAgICAgICAgICBjb25zdCBmaWVsZENvbmZpZ3NJbkZpbHRlciA9IGNvbHVtblRlbXBsYXRlcy5maWx0ZXIoKGNvbHVtblRlbXBsYXRlKSA9PiBmaWx0ZXJGaWVsZHNGaWVsZHMuc29tZSgoZmlsdGVyRmllbGQpID0+IGNvbHVtblRlbXBsYXRlLmZpZWxkTmFtZSA9PT0gZmlsdGVyRmllbGQudmFsdWUpKTtcbiAgICAgICAgICAgIGxldCBoYXNBdHRhY2htZW50cyA9IGZpbHRlckZpZWxkcy5sZW5ndGggIT09IGZpbHRlckZpZWxkc0ZpZWxkcy5sZW5ndGg7XG4gICAgICAgICAgICBjb25zdCBjb250YWluc0FsbCA9IGZpbHRlckZpZWxkc0ZpZWxkcy5ldmVyeSgoZmlsdGVyKSA9PiAhZmllbGRDb25maWdzSW5GaWx0ZXIuc29tZSgoY29sdW1uVGVtcGxhdGUpID0+IGNvbHVtblRlbXBsYXRlLmZpZWxkTmFtZSA9PT0gZmlsdGVyLnZhbHVlICYmICFjb2x1bW5UZW1wbGF0ZS52aXNpYmxlKSk7XG4gICAgICAgICAgICByZXR1cm4gY29udGFpbnNBbGwgJiYgKChoYXNBdHRhY2htZW50cyAmJiBhdHRhY2htZW50c0VuYWJsZWQpIHx8ICFoYXNBdHRhY2htZW50cyk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gIWNvbHVtblRlbXBsYXRlcy5zb21lKChjb2x1bW5UZW1wbGF0ZSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiAhY29sdW1uVGVtcGxhdGUudmlzaWJsZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIGdldFRvdGFsRmllbGRUeXBlQ291bnQoKSB7XG4gICAgICAgIGNvbnN0IHsgY29sdW1uVGVtcGxhdGVzLCBmaWVsZHNNYXAgfSA9IHRoaXM7XG4gICAgICAgIGNvbnN0IGNvdW50cyA9IHsgc3RyaW5nOiAwLCBudW1iZXI6IDAsIGRhdGU6IDAgfTtcbiAgICAgICAgY29sdW1uVGVtcGxhdGVzLmZvckVhY2goKGNvbHVtblRlbXBsYXRlKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBmaWVsZCA9IGZpZWxkc01hcC5nZXQoY29sdW1uVGVtcGxhdGUuZmllbGROYW1lKTtcbiAgICAgICAgICAgIHN3aXRjaCAoZmllbGQudHlwZSkge1xuICAgICAgICAgICAgICAgIGNhc2UgXCJzbWFsbC1pbnRlZ2VyXCI6XG4gICAgICAgICAgICAgICAgY2FzZSBcImJpZy1pbnRlZ2VyXCI6XG4gICAgICAgICAgICAgICAgY2FzZSBcImludGVnZXJcIjpcbiAgICAgICAgICAgICAgICBjYXNlIFwic2luZ2xlXCI6XG4gICAgICAgICAgICAgICAgY2FzZSBcImRvdWJsZVwiOlxuICAgICAgICAgICAgICAgIGNhc2UgXCJsb25nXCI6XG4gICAgICAgICAgICAgICAgY2FzZSBcIm9pZFwiOlxuICAgICAgICAgICAgICAgIGNhc2UgXCJndWlkXCI6XG4gICAgICAgICAgICAgICAgICAgIGNvdW50cy5udW1iZXIrKztcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSBcInN0cmluZ1wiOlxuICAgICAgICAgICAgICAgICAgICBjb3VudHMuc3RyaW5nKys7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgXCJkYXRlXCI6XG4gICAgICAgICAgICAgICAgY2FzZSBcImRhdGUtb25seVwiOlxuICAgICAgICAgICAgICAgIGNhc2UgXCJ0aW1lLW9ubHlcIjpcbiAgICAgICAgICAgICAgICBjYXNlIFwidGltZXN0YW1wLW9mZnNldFwiOlxuICAgICAgICAgICAgICAgICAgICBjb3VudHMuZGF0ZSsrO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBjb3VudHM7XG4gICAgfVxuICAgIHNvcnRGaWVsZHNBbHBoYWJldGljYWxseShjb2x1bW5UZW1wbGF0ZXMpIHtcbiAgICAgICAgcmV0dXJuIGNvbHVtblRlbXBsYXRlcy5zb3J0KChhLCBiKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gYS5sYWJlbC5jaGFyQXQoMCkgPT09IFwiX1wiXG4gICAgICAgICAgICAgICAgPyAxXG4gICAgICAgICAgICAgICAgOiBiLmxhYmVsLmNoYXJBdCgwKSA9PT0gXCJfXCJcbiAgICAgICAgICAgICAgICAgICAgPyAtMVxuICAgICAgICAgICAgICAgICAgICA6IGEubGFiZWwubG9jYWxlQ29tcGFyZShiLmxhYmVsKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHNvcnRGaWVsZHNCeVR5cGUoY29sdW1uVGVtcGxhdGVzKSB7XG4gICAgICAgIC8vIG9yZGVyOiBudW1iZXIsIHN0cmluZywgZGF0ZSwgb2lkLCBndWlkXG4gICAgICAgIGNvbnN0IHsgZmllbGRzTWFwIH0gPSB0aGlzO1xuICAgICAgICByZXR1cm4gY29sdW1uVGVtcGxhdGVzXG4gICAgICAgICAgICAuZmlsdGVyKChjb2x1bW5UZW1wbGF0ZSkgPT4gW1wic21hbGwtaW50ZWdlclwiLCBcImJpZy1pbnRlZ2VyXCIsIFwiaW50ZWdlclwiLCBcInNpbmdsZVwiLCBcImRvdWJsZVwiLCBcImxvbmdcIl0uaW5kZXhPZihmaWVsZHNNYXAuZ2V0KGNvbHVtblRlbXBsYXRlLmZpZWxkTmFtZSkudHlwZSkgPiAtMSlcbiAgICAgICAgICAgIC5tYXAoKGNvbHVtblRlbXBsYXRlKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gY29sdW1uVGVtcGxhdGU7XG4gICAgICAgIH0pXG4gICAgICAgICAgICAuY29uY2F0KGNvbHVtblRlbXBsYXRlc1xuICAgICAgICAgICAgLmZpbHRlcigoY29sdW1uVGVtcGxhdGUpID0+IGZpZWxkc01hcC5nZXQoY29sdW1uVGVtcGxhdGUuZmllbGROYW1lKS50eXBlID09PSBcInN0cmluZ1wiKVxuICAgICAgICAgICAgLm1hcCgoY29sdW1uVGVtcGxhdGUpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBjb2x1bW5UZW1wbGF0ZTtcbiAgICAgICAgfSkpXG4gICAgICAgICAgICAuY29uY2F0KGNvbHVtblRlbXBsYXRlc1xuICAgICAgICAgICAgLmZpbHRlcigoY29sdW1uVGVtcGxhdGUpID0+IFtcImRhdGVcIiwgXCJkYXRlLW9ubHlcIiwgXCJ0aW1lLW9ubHlcIiwgXCJ0aW1lc3RhbXAtb2Zmc2V0XCJdLmluZGV4T2YoZmllbGRzTWFwLmdldChjb2x1bW5UZW1wbGF0ZS5maWVsZE5hbWUpLnR5cGUpID4gLTEpXG4gICAgICAgICAgICAubWFwKChjb2x1bW5UZW1wbGF0ZSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGNvbHVtblRlbXBsYXRlO1xuICAgICAgICB9KSlcbiAgICAgICAgICAgIC5jb25jYXQoY29sdW1uVGVtcGxhdGVzXG4gICAgICAgICAgICAuZmlsdGVyKChjb2x1bW5UZW1wbGF0ZSkgPT4gZmllbGRzTWFwLmdldChjb2x1bW5UZW1wbGF0ZS5maWVsZE5hbWUpLnR5cGUgPT09IFwib2lkXCIpXG4gICAgICAgICAgICAubWFwKChjb2x1bW5UZW1wbGF0ZSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGNvbHVtblRlbXBsYXRlO1xuICAgICAgICB9KSlcbiAgICAgICAgICAgIC5jb25jYXQoY29sdW1uVGVtcGxhdGVzXG4gICAgICAgICAgICAuZmlsdGVyKChjb2x1bW5UZW1wbGF0ZSkgPT4gZmllbGRzTWFwLmdldChjb2x1bW5UZW1wbGF0ZS5maWVsZE5hbWUpLnR5cGUgPT09IFwiZ3VpZFwiKVxuICAgICAgICAgICAgLm1hcCgoY29sdW1uVGVtcGxhdGUpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBjb2x1bW5UZW1wbGF0ZTtcbiAgICAgICAgfSkpXG4gICAgICAgICAgICAuY29uY2F0KGNvbHVtblRlbXBsYXRlc1xuICAgICAgICAgICAgLmZpbHRlcigoY29sdW1uVGVtcGxhdGUpID0+IFtcbiAgICAgICAgICAgIFwic21hbGwtaW50ZWdlclwiLFxuICAgICAgICAgICAgXCJiaWctaW50ZWdlclwiLFxuICAgICAgICAgICAgXCJpbnRlZ2VyXCIsXG4gICAgICAgICAgICBcInNpbmdsZVwiLFxuICAgICAgICAgICAgXCJkb3VibGVcIixcbiAgICAgICAgICAgIFwibG9uZ1wiLFxuICAgICAgICAgICAgXCJzdHJpbmdcIixcbiAgICAgICAgICAgIFwiZGF0ZVwiLFxuICAgICAgICAgICAgXCJkYXRlLW9ubHlcIixcbiAgICAgICAgICAgIFwidGltZS1vbmx5XCIsXG4gICAgICAgICAgICBcInRpbWVzdGFtcC1vZmZzZXRcIixcbiAgICAgICAgICAgIFwib2lkXCIsXG4gICAgICAgICAgICBcImd1aWRcIlxuICAgICAgICBdLmluZGV4T2YoZmllbGRzTWFwLmdldChjb2x1bW5UZW1wbGF0ZS5maWVsZE5hbWUpLnR5cGUpID09PSAtMSlcbiAgICAgICAgICAgIC5tYXAoKGNvbHVtblRlbXBsYXRlKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gY29sdW1uVGVtcGxhdGU7XG4gICAgICAgIH0pKTtcbiAgICB9XG4gICAgZ2V0IGhvc3RFbGVtZW50KCkgeyByZXR1cm4gZ2V0RWxlbWVudCh0aGlzKTsgfVxufTtcbkFyY2dpc1RhYmxlRmllbGRTZWxlY3Rpb24uc3R5bGUgPSBhcmNnaXNUYWJsZUZpZWxkU2VsZWN0aW9uQ3NzO1xuXG5leHBvcnQgeyBBcmNnaXNUYWJsZSBhcyBhcmNnaXNfdGFibGUsIEFyY2dpc1RhYmxlQ29sdW1uSW5mbyBhcyBhcmNnaXNfdGFibGVfY29sdW1uX2luZm8sIEFyY2dpc1RhYmxlRmllbGRTZWxlY3Rpb24gYXMgYXJjZ2lzX3RhYmxlX2ZpZWxkX3NlbGVjdGlvbiB9O1xuXG4vLyMgc291cmNlTWFwcGluZ1VSTD1hcmNnaXMtdGFibGVfMy5lbnRyeS5qcy5tYXAiLCIvKiFcbiAqIEFsbCBtYXRlcmlhbCBjb3B5cmlnaHQgRVNSSSwgQWxsIFJpZ2h0cyBSZXNlcnZlZCwgdW5sZXNzIG90aGVyd2lzZSBzcGVjaWZpZWQuXG4gKiB2NC4wLjU4XG4gKi9cbnZhciBzY2FsZXM7XG4oZnVuY3Rpb24gKHNjYWxlcykge1xuICAgIHNjYWxlc1tcIlNNQUxMXCJdID0gXCJzXCI7XG4gICAgc2NhbGVzW1wiTUVESVVNXCJdID0gXCJtXCI7XG4gICAgc2NhbGVzW1wiTEFSR0VcIl0gPSBcImxcIjtcbn0pKHNjYWxlcyB8fCAoc2NhbGVzID0ge30pKTtcbi8qKlxuICogUmV0dXJucyB0cnVlIGlmIHRoZSB2YWx1ZSBpcyBkZWZpbmVkXG4gKiBAcGFyYW0gdmFsdWUgLSB2YWx1ZSB0byBjaGVja1xuICovXG5mdW5jdGlvbiBpc0RlZmluZWQodmFsdWUpIHtcbiAgICByZXR1cm4gdmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gbnVsbDtcbn1cbi8qKlxuICogUmV0dXJucyB0cnVlIGlmIG5vZGUgaGFzIG5vZGVOYW1lIG9yIGlzIGNvbnRhaW5lZCBpbiBhIHBhcmVudCBub2RlIHdpdGggbm9kZU5hbWVcbiAqIEBwYXJhbSBub2RlXG4gKiBAcGFyYW0gbm9kZU5hbWVcbiAqL1xuZnVuY3Rpb24gaXNJbk5vZGUobm9kZSwgbm9kZU5hbWUpIHtcbiAgICB3aGlsZSAobm9kZSkge1xuICAgICAgICBpZiAobm9kZS5ub2RlTmFtZSA9PT0gbm9kZU5hbWUudG9VcHBlckNhc2UoKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50RWxlbWVudDtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xufVxuXG5leHBvcnQgeyBpc0RlZmluZWQgYXMgYSwgaXNJbk5vZGUgYXMgaSwgc2NhbGVzIGFzIHMgfTtcblxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9YmFzaWMtNmRiN2ViZDcuanMubWFwIiwiLyohXG4gKiBBbGwgbWF0ZXJpYWwgY29weXJpZ2h0IEVTUkksIEFsbCBSaWdodHMgUmVzZXJ2ZWQsIHVubGVzcyBvdGhlcndpc2Ugc3BlY2lmaWVkLlxuICogdjQuMC41OFxuICovXG5pbXBvcnQgeyBjIGFzIGNsb3Nlc3RFbGVtZW50Q3Jvc3NTaGFkb3dCb3VuZGFyeSB9IGZyb20gJy4vZG9tLTRkMzY3Njc3LmpzJztcbmltcG9ydCB7IGwgYXMgbGFuZ3VhZ2VNYXAgfSBmcm9tICcuL2xhbmd1YWdlVXRpbC1lZjBlNTRiMi5qcyc7XG5pbXBvcnQgeyBhIGFzIGdldEFzc2V0UGF0aCB9IGZyb20gJy4vaW5kZXgtZTNiZjdkYTcuanMnO1xuXG4vLyBodHRwczovL21lZGl1bS5jb20vc3RlbmNpbC10cmlja3MvaW1wbGVtZW50aW5nLWludGVybmF0aW9uYWxpc2F0aW9uLWkxOG4td2l0aC1zdGVuY2lsLTVlNjU1OTU1NDExN1xuZnVuY3Rpb24gZ2V0Q29tcG9uZW50Q2xvc2VzdExhbmd1YWdlKGVsZW1lbnQpIHtcbiAgICB2YXIgX2EsIF9iLCBfYztcbiAgICBjb25zdCBjbG9zZXN0RWxlbWVudCA9IChfYSA9IGNsb3Nlc3RFbGVtZW50Q3Jvc3NTaGFkb3dCb3VuZGFyeShlbGVtZW50LCBcIltsYW5nXVwiKSkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogKF9jID0gKF9iID0gZWxlbWVudC5zaGFkb3dSb290KSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Iub3duZXJEb2N1bWVudCkgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmRvY3VtZW50RWxlbWVudDtcbiAgICAvLyBsYW5ndWFnZSBzZXQgYnkgdGhlIGNhbGxpbmcgYXBwbGljYXRpb24gb3IgYnJvd3Nlci4gZGVmYXVsdHMgdG8gZW5nbGlzaC5cbiAgICBjb25zdCBsYW5nID0gKChjbG9zZXN0RWxlbWVudCA9PT0gbnVsbCB8fCBjbG9zZXN0RWxlbWVudCA9PT0gdm9pZCAwID8gdm9pZCAwIDogY2xvc2VzdEVsZW1lbnQubGFuZykgfHwgKG5hdmlnYXRvciA9PT0gbnVsbCB8fCBuYXZpZ2F0b3IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG5hdmlnYXRvci5sYW5ndWFnZSkgfHwgXCJlblwiKS50b0xvd2VyQ2FzZSgpO1xuICAgIGlmIChsYW5ndWFnZU1hcC5oYXMobGFuZykpIHtcbiAgICAgICAgcmV0dXJuIGxhbmd1YWdlTWFwLmdldChsYW5nKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIC8vIFwicnUtUlVcIiBtYXBzIHRvIFwicnVcIiB1c2UgY2FzZVxuICAgICAgICBpZiAobGFuZ3VhZ2VNYXAuaGFzKGxhbmcuc2xpY2UoMCwgMikpKSB7XG4gICAgICAgICAgICByZXR1cm4gbGFuZ3VhZ2VNYXAuZ2V0KGxhbmcuc2xpY2UoMCwgMikpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIFwiZW5cIjtcbiAgICAgICAgfVxuICAgIH1cbn1cbmZ1bmN0aW9uIGdldENvbXBvbmVudENsb3Nlc3RMYW5ndWFnZUludGwoZWxlbWVudCkge1xuICAgIHZhciBfYSwgX2IsIF9jO1xuICAgIC8vIGl0J3MgT0sgaWYgd2UgZG9uJ3QgaGF2ZSB0aGUgNCBsZXR0ZXIgbGFuZ3VhZ2UgZmlsZSBmb3IgaXRcbiAgICAvLyA0IGxldHRlciBsYW5ndWFnZSBjb2RlIG5lZWRlZCBmb3IgZm9ybWF0dGluZyBudW1iZXJzXG4gICAgY29uc3QgY2xvc2VzdEVsZW1lbnQgPSAoX2EgPSBjbG9zZXN0RWxlbWVudENyb3NzU2hhZG93Qm91bmRhcnkoZWxlbWVudCwgXCJbbGFuZ11cIikpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IChfYyA9IChfYiA9IGVsZW1lbnQuc2hhZG93Um9vdCkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLm93bmVyRG9jdW1lbnQpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5kb2N1bWVudEVsZW1lbnQ7XG4gICAgLy8gbGFuZ3VhZ2Ugc2V0IGJ5IHRoZSBjYWxsaW5nIGFwcGxpY2F0aW9uIG9yIGJyb3dzZXIuIGRlZmF1bHRzIHRvIGVuZ2xpc2guXG4gICAgY29uc3QgbGFuZyA9ICgoY2xvc2VzdEVsZW1lbnQgPT09IG51bGwgfHwgY2xvc2VzdEVsZW1lbnQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNsb3Nlc3RFbGVtZW50LmxhbmcpIHx8IChuYXZpZ2F0b3IgPT09IG51bGwgfHwgbmF2aWdhdG9yID09PSB2b2lkIDAgPyB2b2lkIDAgOiBuYXZpZ2F0b3IubGFuZ3VhZ2UpIHx8IFwiZW5cIikudG9Mb3dlckNhc2UoKTtcbiAgICBpZiAobGFuZ3VhZ2VNYXAuaGFzKGxhbmcpKSB7XG4gICAgICAgIHJldHVybiBsYW5ndWFnZU1hcC5nZXQobGFuZyk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBpZiAobGFuZ3VhZ2VNYXAuaGFzKGxhbmcuc2xpY2UoMCwgMikpKSB7XG4gICAgICAgICAgICAvLyB3ZSBzdXBwb3J0IHRoZSAyIGxldHRlciBjb2RlZCBsYW5ndWFnZVxuICAgICAgICAgICAgLy8gZS5nLiBpdC1DSCB2cyBpdFxuICAgICAgICAgICAgcmV0dXJuIGxhbmc7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gXCJlblwiO1xuICAgICAgICB9XG4gICAgfVxufVxuZnVuY3Rpb24gZmV0Y2hMb2NhbGVTdHJpbmdzRm9yQ29tcG9uZW50KGNvbXBvbmVudE5hbWUsIGxvY2FsZSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGZldGNoKGdldEFzc2V0UGF0aChgLi4vYXJjZ2lzLWFwcC1hc3NldHMvaTE4bi8ke2NvbXBvbmVudE5hbWV9LmkxOG4uJHtsb2NhbGV9Lmpzb25gKSkudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgICAgICBpZiAocmVzdWx0Lm9rKVxuICAgICAgICAgICAgICAgIHJlc29sdmUocmVzdWx0Lmpzb24oKSk7XG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgcmVqZWN0KCk7XG4gICAgICAgIH0sICgpID0+IHJlamVjdCgpKTtcbiAgICB9KTtcbn1cbmNvbnN0IHN0cmluZ0NhY2hlID0ge307XG5mdW5jdGlvbiBmZXRjaExvY2FsZVN0cmluZ3NGcm9tQ2FjaGUoY29tcG9uZW50TmFtZSwgbG9jYWxlKSB7XG4gICAgY29uc3QgaWQgPSBgJHtjb21wb25lbnROYW1lfSR7bG9jYWxlfWA7XG4gICAgaWYgKCFzdHJpbmdDYWNoZVtpZF0pIHtcbiAgICAgICAgc3RyaW5nQ2FjaGVbaWRdID0gZmV0Y2hMb2NhbGVTdHJpbmdzRm9yQ29tcG9uZW50KGNvbXBvbmVudE5hbWUsIGxvY2FsZSk7XG4gICAgfVxuICAgIHJldHVybiBzdHJpbmdDYWNoZVtpZF07XG59XG4vKipcbiAqIEdldCBzdHJpbmdzIGFuZCBsYW5ndWFnZSBjb2Rlcy5cbiAqIFRoaXMgbWV0aG9kIHJldHVybnMgMiBsYW5ndWFnZSBjb2Rlcy5cbiAqIFRoZSBmaXJzdCBvbmUgcmV0dXJucyBhIGNvZGUgdGhhdCdzIGFsc28gc3VwcG9ydGVkIGFzIGEgbGFuZ3VhZ2UgZmlsZS5cbiAqIFRoZSBzZWNvbmQgb25lIHJldHVybnMgYSBjb2RlIHdoZXJlIHRoZXJlIGlzIHN1cHBvcnQgZm9yIHRoZSBmaXJzdCAyIGxldHRlcnMgb2YgdGhlIGNvZGUgYXMgcGFydCBvZiBhIGxhbmd1YWdlIGZpbGUsXG4gKiBidXQgd2lsbCByZXR1cm4gdGhlIG9yaWdpbmFsIDQgbGV0dGVyIGNvZGUgZnJvbSB0aGUgcGFnZS5cbiAqIEUuZy4gRm9yIFwiaXQtY2hcIiBpdCB3aWxsIHJldHVybiBcIml0XCIgYXMgdGhlIGZpcnN0IGxhbmd1YWdlIGNvZGUgYW5kIFwiaXQtY2hcIiBhcyB0aGUgc2Vjb25kLlxuICogVGhlIHNlY29uZCBvbmUgaXMgcmVxdWlyZWQgZm9yIGVzcmkuaW50bC5zZXRMb2NhbGUoKSB0byBnZXQgdGhlIGNvcnJlY3QgZm9ybWF0dGluZy5cbiAqXG4gKiBJZiBhIHRhZ05hbWUgaXMgcHJvdmlkZWQgaXQgd2lsbCBvdmVyd2l0ZSB0aGUgZWxlbWVudCdzIHRhZ05hbWVcbiAqXG4gKiAgQHJldHVybiBbIHN0cmluZ3MsIGZpcnN0IGxhbmd1YWdlIGNvZGUsIHNlY29uZCBsYW5ndWFnZSBjb2RlXVxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRMb2NhbGVDb21wb25lbnRTdHJpbmdzKGVsZW1lbnQsIHRhZ05hbWUpIHtcbiAgICBjb25zdCBjb21wb25lbnROYW1lID0gdGFnTmFtZSB8fCBlbGVtZW50LnRhZ05hbWUudG9Mb3dlckNhc2UoKTtcbiAgICBjb25zdCBjb21wb25lbnRMYW5ndWFnZSA9IGdldENvbXBvbmVudENsb3Nlc3RMYW5ndWFnZShlbGVtZW50KTtcbiAgICBjb25zdCBjb21wb25lbnRMYW5ndWFnZUludGwgPSBnZXRDb21wb25lbnRDbG9zZXN0TGFuZ3VhZ2VJbnRsKGVsZW1lbnQpO1xuICAgIGxldCBzdHJpbmdzO1xuICAgIHRyeSB7XG4gICAgICAgIHN0cmluZ3MgPSBhd2FpdCBmZXRjaExvY2FsZVN0cmluZ3NGcm9tQ2FjaGUoY29tcG9uZW50TmFtZSwgY29tcG9uZW50TGFuZ3VhZ2UpO1xuICAgIH1cbiAgICBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLndhcm4oYG5vIGxvY2FsZSBmb3IgJHtjb21wb25lbnROYW1lfSAoJHtjb21wb25lbnRMYW5ndWFnZX0pIGxvYWRpbmcgZGVmYXVsdCBsb2NhbGUgZW4uYCk7XG4gICAgICAgIHN0cmluZ3MgPSBhd2FpdCBmZXRjaExvY2FsZVN0cmluZ3NGcm9tQ2FjaGUoY29tcG9uZW50TmFtZSwgXCJlblwiKTtcbiAgICB9XG4gICAgcmV0dXJuIFtzdHJpbmdzLCBjb21wb25lbnRMYW5ndWFnZSwgY29tcG9uZW50TGFuZ3VhZ2VJbnRsXTtcbn1cblxuZXhwb3J0IHsgZ2V0Q29tcG9uZW50Q2xvc2VzdExhbmd1YWdlIGFzIGEsIGdldExvY2FsZUNvbXBvbmVudFN0cmluZ3MgYXMgZyB9O1xuXG4vLyMgc291cmNlTWFwcGluZ1VSTD1sb2NhbGUtMDUwYjZkYjkuanMubWFwIl0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9