"use strict";
(self["webpackChunkexb_client"] = self["webpackChunkexb_client"] || []).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_overwr-a51470"],{

/***/ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/overwrite-7eb8dfd4.js":
/*!***************************************************************************************************************!*\
  !*** ./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/overwrite-7eb8dfd4.js ***!
  \***************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   a: () => (/* binding */ getPublishParameters),
/* harmony export */   b: () => (/* binding */ updateItemOverwrite),
/* harmony export */   c: () => (/* binding */ updateItemResource),
/* harmony export */   f: () => (/* binding */ fetchAndUpdateItem),
/* harmony export */   g: () => (/* binding */ getTokenFromProvider),
/* harmony export */   p: () => (/* binding */ publishForOverwrite),
/* harmony export */   r: () => (/* binding */ resetServiceTitle),
/* harmony export */   u: () => (/* binding */ updateTypeKeywords)
/* harmony export */ });
/* harmony import */ var _feature_layer_573bb473_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./feature-layer-573bb473.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/feature-layer-573bb473.js");
/* harmony import */ var _publish_item_17d2f9a3_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./publish-item-17d2f9a3.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/publish-item-17d2f9a3.js");
/* harmony import */ var _server_item_8d384796_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./server-item-8d384796.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/server-item-8d384796.js");
/* harmony import */ var _append_4e11032c_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./append-4e11032c.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/append-4e11032c.js");
/* harmony import */ var _portal_d518b571_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./portal-d518b571.js */ "./extensions/widgets/arcgis/analysis/node_modules/@arcgis/app-components/dist/esm/portal-d518b571.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * v4.0.58
 */






const getFormParameters = (item) => {
    const { name, title, tags, type, typeKeywords, accessInformation, licenseInfo, description, snippet, extent } = item;
    return {
        name,
        title,
        tags,
        type,
        typeKeywords,
        accessInformation,
        licenseInfo,
        description,
        snippet,
        extent
    };
};
const getFormData = (item, addItemProps) => {
    //for parameters of updating source data of feature layer.
    const overwriteOn = !!addItemProps.overwrite;
    const formProperties = getFormParameters(item);
    const formData = new FormData();
    Object.keys(formProperties).forEach((property) => {
        var _a;
        if (property === "description" || property === "snippet" || property === "extent") {
            formData.append(property, addItemProps.keepDescription ? formProperties[property] : "");
        }
        else {
            formData.append(property, (_a = formProperties[property]) !== null && _a !== void 0 ? _a : "");
        }
    });
    formData.set("overwrite", "true");
    formData.set("async", "true");
    formData.set("file", addItemProps.file, item.title);
    if (overwriteOn) {
        formData.set("overwriteService", "on");
    }
    formData.set("useDescription", "on");
    return formData;
};
const createOverwritePublishParameters = (serviceInfo, item, newItemId) => {
    var _a, _b, _c, _d, _e;
    const itemPublishParameters = item === null || item === void 0 ? void 0 : item.publishParameters;
    const itemData = (_a = item === null || item === void 0 ? void 0 : item.sourceData) !== null && _a !== void 0 ? _a : item;
    const type = (_c = (_b = item === null || item === void 0 ? void 0 : item.sourceData) === null || _b === void 0 ? void 0 : _b.type) !== null && _c !== void 0 ? _c : _append_4e11032c_js__WEBPACK_IMPORTED_MODULE_3__.A[(_d = item === null || item === void 0 ? void 0 : item.cloudProviderInfo) === null || _d === void 0 ? void 0 : _d.mimeType];
    const finalOverwriteParameters = {
        itemId: newItemId !== null && newItemId !== void 0 ? newItemId : itemData.id,
        filetype: _append_4e11032c_js__WEBPACK_IMPORTED_MODULE_3__.b[type.toLowerCase()],
        overwrite: true,
        deleteSourceItemUponCompletion: !!newItemId
    };
    let publishParameters;
    switch (type) {
        case "CSV": {
            const layerInfo = Object.assign(Object.assign({}, (_e = serviceInfo.layers) === null || _e === void 0 ? void 0 : _e[0]), { fields: itemPublishParameters.layerInfo.fields });
            publishParameters = Object.assign(Object.assign({ layerInfo, name: itemPublishParameters.name || itemData.title.replace(/ /g, "_") }, itemPublishParameters), serviceInfo);
            break;
        }
        case "Microsoft Excel": {
            publishParameters = generateExcelOverwritePublishParameters(itemPublishParameters, serviceInfo);
            break;
        }
        default:
            publishParameters = Object.assign(Object.assign(Object.assign({}, itemPublishParameters), serviceInfo), { name: itemData.title ? itemData.title.replace(/ /g, "_") : item.title.replace(/ /g, "_") });
            break;
    }
    finalOverwriteParameters.publishParameters = JSON.stringify(publishParameters);
    return finalOverwriteParameters;
};
const generateExcelOverwritePublishParameters = (publishParameters, serviceInfo) => {
    const finalOverwriteParameters = Object.assign({}, serviceInfo);
    //service level properties
    finalOverwriteParameters.name = publishParameters.name;
    finalOverwriteParameters.sourceSR = publishParameters.sourceSR;
    finalOverwriteParameters.targetSR = publishParameters.targetSR;
    //table is not valid in excel publish parameters, so copy to layer
    for (let i = 0; i < finalOverwriteParameters.tables.length; i++) {
        //if excel has Review Table, ignore it
        if (finalOverwriteParameters.tables[i].name != "Review") {
            finalOverwriteParameters.layers[finalOverwriteParameters.layers.length] = finalOverwriteParameters.tables[i];
        }
    }
    for (let layer of finalOverwriteParameters.layers) {
        const { excelSheetId, locationType, latitudeFieldName, longitudeFieldName, geocodeServiceUrl, sourceLocale, sourceCountry, standardizedFieldNames, addressFields, coordinateFieldName, coordinateFieldType, fields, dateFieldsTimeReference } = publishParameters.layers[layer.id];
        const propertiesToUpdate = {
            excelSheetId,
            locationType,
            latitudeFieldName,
            longitudeFieldName,
            geocodeServiceUrl,
            sourceLocale,
            sourceCountry,
            standardizedFieldNames,
            addressFields,
            coordinateFieldName,
            coordinateFieldType,
            fields,
            dateFieldsTimeReference
        };
        finalOverwriteParameters.layers[layer.id] = Object.assign({}, propertiesToUpdate);
    }
    return finalOverwriteParameters;
};

const publishForOverwrite = async (item, title, portal, user) => {
    var _a, _b;
    const params = await getPublishParameters(item, portal, user);
    const publishResponse = await (0,_publish_item_17d2f9a3_js__WEBPACK_IMPORTED_MODULE_1__.p)({ itemId: item.sourceData.id, user, title, itemOwnerUrl: item.itemOwner.userContentUrl }, // ! Use fetchUser if itemOwner is not available
    params);
    const service = (_b = (_a = publishResponse.result) === null || _a === void 0 ? void 0 : _a.services) === null || _b === void 0 ? void 0 : _b[0];
    return {
        id: service === null || service === void 0 ? void 0 : service.serviceItemId,
        jobId: service === null || service === void 0 ? void 0 : service.jobId,
        serviceType: service === null || service === void 0 ? void 0 : service.type,
        serviceUrl: service === null || service === void 0 ? void 0 : service.serviceurl,
        overwriteStatus: ""
    };
};
const getPublishParameters = async (item, portal, user, newItemId) => {
    const { result: serviceInfo } = await fetchFeatureServiceInfoForOverwrite(item, portal, false, user);
    return await createOverwritePublishParameters(serviceInfo, item, newItemId);
};
const fetchAndUpdateItem = async (item, userContentUrl, addItemProps) => {
    const sourceData = item.sourceData;
    try {
        await updateItemOverwrite(sourceData, userContentUrl, {
            file: addItemProps.file,
            overwrite: addItemProps.overwrite,
            keepDescription: addItemProps.keepDescription
        });
        await (0,_publish_item_17d2f9a3_js__WEBPACK_IMPORTED_MODULE_1__.c)({ id: sourceData.id, folder: "", success: true });
        return {};
    }
    catch (error) {
        console.error(error);
        return { error: { code: "unhandledError" } };
    }
};
const updateItemOverwrite = async (item, userContentUrl, addItemProps) => {
    const url = `${userContentUrl}/items/${item.id}/update`;
    const formData = getFormData(item, {
        file: addItemProps.file,
        overwrite: addItemProps.overwrite,
        keepDescription: addItemProps.keepDescription
    });
    return await (0,_portal_d518b571_js__WEBPACK_IMPORTED_MODULE_4__.d)(url, formData, {}, "post");
};
const fetchFeatureServiceInfoForOverwrite = async (item, portal, isSecure, user) => {
    try {
        const { url } = item;
        const serviceInfo = await (0,_portal_d518b571_js__WEBPACK_IMPORTED_MODULE_4__.r)(url);
        const serviceLayerInfo = await (0,_portal_d518b571_js__WEBPACK_IMPORTED_MODULE_4__.r)(url + "/layers");
        const formattedLayers = serviceLayerInfo === null || serviceLayerInfo === void 0 ? void 0 : serviceLayerInfo.layers.map((layer) => {
            delete layer.fields;
            return layer;
        });
        serviceInfo.tables = [...serviceLayerInfo === null || serviceLayerInfo === void 0 ? void 0 : serviceLayerInfo.tables];
        serviceInfo.layers = [...formattedLayers];
        return { result: serviceInfo };
    }
    catch (error) {
        if (!isSecure && (((error === null || error === void 0 ? void 0 : error.code) === 499 && (error === null || error === void 0 ? void 0 : error.message) === "Token Required") || error.code === 403) && user) {
            return fetchFeatureServiceInfoForOverwrite(item, portal, true, user);
        }
        console.error(error);
        return { error: { code: "unhandledError" } };
    }
};
const resetServiceTitle = async (item) => {
    let keywords = item.typeKeywords.toString();
    const updateContent = {
        title: item.title || "",
        tags: item.tags.toString() || ""
    };
    if (item.typeKeywords.indexOf("Involved Lookup") !== -1) {
        keywords += ",showUnmatchedAddresses";
        updateContent["typeKeywords"] = keywords;
    }
    try {
        const response = await (0,_server_item_8d384796_js__WEBPACK_IMPORTED_MODULE_2__.u)(item.id, updateContent);
        const jobStatus = await (0,_feature_layer_573bb473_js__WEBPACK_IMPORTED_MODULE_0__.x)(item.id, { success: response === null || response === void 0 ? void 0 : response.success });
        if (jobStatus.status === "failed") {
            return { error: { code: "unhandledError" } };
        }
        return { result: jobStatus };
    }
    catch (error) {
        console.error("error:", error);
        return { error: { code: "unhandledError" } };
    }
};
//for vector tile service case
const updateItemResource = async (item, userContentUrl, addItemProps) => {
    const folderId = item.folderId || item.ownerFolder;
    const url = `${userContentUrl}/${folderId ? folderId : ""}/items/${item.id}/updateResources`;
    const formData = new FormData();
    formData.set("file", addItemProps.file);
    formData.set("resourcesPrefix", "styles");
    formData.set("filename", "root.json");
    try {
        const response = await (0,_portal_d518b571_js__WEBPACK_IMPORTED_MODULE_4__.d)(url, formData, {}, "post");
        return { result: response };
    }
    catch (error) {
        console.error(error);
        return { error: { code: "unhandledError" } };
    }
};
const updateTypeKeywords = async (publishParametersJSON, item, serviceItemId) => {
    let typeKeywords = ["Cloud Drive"];
    const publishParameters = JSON.parse(publishParametersJSON);
    if (publishParameters.locationType === "address" ||
        (publishParameters.layers[0] && publishParameters.layers[0].locationType === "address")) {
        typeKeywords.push("showUnmatchedAddresses");
        typeKeywords.push("Involved Lookup");
    }
    else if (publishParameters.locationType === "none" ||
        (publishParameters.layers[0] && publishParameters.layers[0].locationType === "none")) {
        typeKeywords.push("Table");
    }
    const finalTypeKeywords = typeKeywords.join(",");
    return await (0,_server_item_8d384796_js__WEBPACK_IMPORTED_MODULE_2__.u)(item.id, {
        folderId: (item === null || item === void 0 ? void 0 : item.folderId) || item.ownerFolder,
        id: serviceItemId,
        typeKeywords: finalTypeKeywords
    });
};
async function getTokenFromProvider(provider) {
    try {
        const token = await provider.connect();
        return { result: token };
    }
    catch (error) {
        return { error: { code: "unhandledError" } };
    }
}



//# sourceMappingURL=overwrite-7eb8dfd4.js.map

/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0cy9jaHVua3MvYXJjZ2lzX2FuYWx5c2lzX25vZGVfbW9kdWxlc19hcmNnaXNfYXBwLWNvbXBvbmVudHNfZGlzdF9lc21fb3ZlcndyLWE1MTQ3MC5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDaUU7QUFDcUI7QUFDMUI7QUFDbUQ7QUFDekM7O0FBRXRFO0FBQ0EsWUFBWSxzR0FBc0c7QUFDbEg7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlLQUF5SyxrREFBZ0M7QUFDek07QUFDQTtBQUNBLGtCQUFrQixrREFBMkI7QUFDN0M7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNERBQTRELDJFQUEyRSxnREFBZ0Q7QUFDdkwsOERBQThELGtGQUFrRjtBQUNoSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDRFQUE0RSwwQ0FBMEMsMEZBQTBGO0FBQ2hOO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFEQUFxRDtBQUNyRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esb0JBQW9CLDRDQUE0QztBQUNoRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxnQkFBZ0Isc09BQXNPO0FBQ3RQO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG9FQUFvRTtBQUNwRTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0Esa0NBQWtDLDREQUFjLEdBQUcsc0ZBQXNGO0FBQ3pJO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxZQUFZLHNCQUFzQjtBQUNsQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1QsY0FBYyw0REFBYyxHQUFHLDhDQUE4QztBQUM3RTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQixTQUFTO0FBQzFCO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQixlQUFlLFNBQVMsUUFBUTtBQUNuRDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTCxpQkFBaUIsc0RBQVcsa0JBQWtCO0FBQzlDO0FBQ0E7QUFDQTtBQUNBLGdCQUFnQixNQUFNO0FBQ3RCLGtDQUFrQyxzREFBTztBQUN6Qyx1Q0FBdUMsc0RBQU87QUFDOUM7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLFNBQVM7QUFDMUI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwrQkFBK0IsMkRBQVU7QUFDekMsZ0NBQWdDLDZEQUFhLFlBQVksK0VBQStFO0FBQ3hJO0FBQ0EscUJBQXFCLFNBQVM7QUFDOUI7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLFNBQVM7QUFDMUI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1CQUFtQixlQUFlLEdBQUcseUJBQXlCLFNBQVMsUUFBUTtBQUMvRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsK0JBQStCLHNEQUFXLGtCQUFrQjtBQUM1RCxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLFNBQVM7QUFDMUI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLDJEQUFVO0FBQzNCO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0EsaUJBQWlCLFNBQVM7QUFDMUI7QUFDQTs7QUFFdU47O0FBRXZOIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vZXhiLWNsaWVudC8uL2V4dGVuc2lvbnMvd2lkZ2V0cy9hcmNnaXMvYW5hbHlzaXMvbm9kZV9tb2R1bGVzL0BhcmNnaXMvYXBwLWNvbXBvbmVudHMvZGlzdC9lc20vb3ZlcndyaXRlLTdlYjhkZmQ0LmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQWxsIG1hdGVyaWFsIGNvcHlyaWdodCBFU1JJLCBBbGwgUmlnaHRzIFJlc2VydmVkLCB1bmxlc3Mgb3RoZXJ3aXNlIHNwZWNpZmllZC5cbiAqIHY0LjAuNThcbiAqL1xuaW1wb3J0IHsgeCBhcyBnZXRJdGVtU3RhdHVzIH0gZnJvbSAnLi9mZWF0dXJlLWxheWVyLTU3M2JiNDczLmpzJztcbmltcG9ydCB7IHAgYXMgcHVibGlzaFNlcnZpY2UsIGMgYXMgY2hlY2tKb2JTdGF0dXMgfSBmcm9tICcuL3B1Ymxpc2gtaXRlbS0xN2QyZjlhMy5qcyc7XG5pbXBvcnQgeyB1IGFzIHVwZGF0ZUl0ZW0gfSBmcm9tICcuL3NlcnZlci1pdGVtLThkMzg0Nzk2LmpzJztcbmltcG9ydCB7IGIgYXMgQXBwZW5kT3ZlcndyaXRlUHVibGlzaFR5cGVzLCBBIGFzIEFwcGVuZE92ZXJ3cml0ZUNsb3VkUHVibGlzaFR5cGVzIH0gZnJvbSAnLi9hcHBlbmQtNGUxMTAzMmMuanMnO1xuaW1wb3J0IHsgZCBhcyBmb3JtUmVxdWVzdCwgciBhcyByZXF1ZXN0IH0gZnJvbSAnLi9wb3J0YWwtZDUxOGI1NzEuanMnO1xuXG5jb25zdCBnZXRGb3JtUGFyYW1ldGVycyA9IChpdGVtKSA9PiB7XG4gICAgY29uc3QgeyBuYW1lLCB0aXRsZSwgdGFncywgdHlwZSwgdHlwZUtleXdvcmRzLCBhY2Nlc3NJbmZvcm1hdGlvbiwgbGljZW5zZUluZm8sIGRlc2NyaXB0aW9uLCBzbmlwcGV0LCBleHRlbnQgfSA9IGl0ZW07XG4gICAgcmV0dXJuIHtcbiAgICAgICAgbmFtZSxcbiAgICAgICAgdGl0bGUsXG4gICAgICAgIHRhZ3MsXG4gICAgICAgIHR5cGUsXG4gICAgICAgIHR5cGVLZXl3b3JkcyxcbiAgICAgICAgYWNjZXNzSW5mb3JtYXRpb24sXG4gICAgICAgIGxpY2Vuc2VJbmZvLFxuICAgICAgICBkZXNjcmlwdGlvbixcbiAgICAgICAgc25pcHBldCxcbiAgICAgICAgZXh0ZW50XG4gICAgfTtcbn07XG5jb25zdCBnZXRGb3JtRGF0YSA9IChpdGVtLCBhZGRJdGVtUHJvcHMpID0+IHtcbiAgICAvL2ZvciBwYXJhbWV0ZXJzIG9mIHVwZGF0aW5nIHNvdXJjZSBkYXRhIG9mIGZlYXR1cmUgbGF5ZXIuXG4gICAgY29uc3Qgb3ZlcndyaXRlT24gPSAhIWFkZEl0ZW1Qcm9wcy5vdmVyd3JpdGU7XG4gICAgY29uc3QgZm9ybVByb3BlcnRpZXMgPSBnZXRGb3JtUGFyYW1ldGVycyhpdGVtKTtcbiAgICBjb25zdCBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuICAgIE9iamVjdC5rZXlzKGZvcm1Qcm9wZXJ0aWVzKS5mb3JFYWNoKChwcm9wZXJ0eSkgPT4ge1xuICAgICAgICB2YXIgX2E7XG4gICAgICAgIGlmIChwcm9wZXJ0eSA9PT0gXCJkZXNjcmlwdGlvblwiIHx8IHByb3BlcnR5ID09PSBcInNuaXBwZXRcIiB8fCBwcm9wZXJ0eSA9PT0gXCJleHRlbnRcIikge1xuICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKHByb3BlcnR5LCBhZGRJdGVtUHJvcHMua2VlcERlc2NyaXB0aW9uID8gZm9ybVByb3BlcnRpZXNbcHJvcGVydHldIDogXCJcIik7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQocHJvcGVydHksIChfYSA9IGZvcm1Qcm9wZXJ0aWVzW3Byb3BlcnR5XSkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogXCJcIik7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBmb3JtRGF0YS5zZXQoXCJvdmVyd3JpdGVcIiwgXCJ0cnVlXCIpO1xuICAgIGZvcm1EYXRhLnNldChcImFzeW5jXCIsIFwidHJ1ZVwiKTtcbiAgICBmb3JtRGF0YS5zZXQoXCJmaWxlXCIsIGFkZEl0ZW1Qcm9wcy5maWxlLCBpdGVtLnRpdGxlKTtcbiAgICBpZiAob3ZlcndyaXRlT24pIHtcbiAgICAgICAgZm9ybURhdGEuc2V0KFwib3ZlcndyaXRlU2VydmljZVwiLCBcIm9uXCIpO1xuICAgIH1cbiAgICBmb3JtRGF0YS5zZXQoXCJ1c2VEZXNjcmlwdGlvblwiLCBcIm9uXCIpO1xuICAgIHJldHVybiBmb3JtRGF0YTtcbn07XG5jb25zdCBjcmVhdGVPdmVyd3JpdGVQdWJsaXNoUGFyYW1ldGVycyA9IChzZXJ2aWNlSW5mbywgaXRlbSwgbmV3SXRlbUlkKSA9PiB7XG4gICAgdmFyIF9hLCBfYiwgX2MsIF9kLCBfZTtcbiAgICBjb25zdCBpdGVtUHVibGlzaFBhcmFtZXRlcnMgPSBpdGVtID09PSBudWxsIHx8IGl0ZW0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGl0ZW0ucHVibGlzaFBhcmFtZXRlcnM7XG4gICAgY29uc3QgaXRlbURhdGEgPSAoX2EgPSBpdGVtID09PSBudWxsIHx8IGl0ZW0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGl0ZW0uc291cmNlRGF0YSkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogaXRlbTtcbiAgICBjb25zdCB0eXBlID0gKF9jID0gKF9iID0gaXRlbSA9PT0gbnVsbCB8fCBpdGVtID09PSB2b2lkIDAgPyB2b2lkIDAgOiBpdGVtLnNvdXJjZURhdGEpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi50eXBlKSAhPT0gbnVsbCAmJiBfYyAhPT0gdm9pZCAwID8gX2MgOiBBcHBlbmRPdmVyd3JpdGVDbG91ZFB1Ymxpc2hUeXBlc1soX2QgPSBpdGVtID09PSBudWxsIHx8IGl0ZW0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGl0ZW0uY2xvdWRQcm92aWRlckluZm8pID09PSBudWxsIHx8IF9kID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZC5taW1lVHlwZV07XG4gICAgY29uc3QgZmluYWxPdmVyd3JpdGVQYXJhbWV0ZXJzID0ge1xuICAgICAgICBpdGVtSWQ6IG5ld0l0ZW1JZCAhPT0gbnVsbCAmJiBuZXdJdGVtSWQgIT09IHZvaWQgMCA/IG5ld0l0ZW1JZCA6IGl0ZW1EYXRhLmlkLFxuICAgICAgICBmaWxldHlwZTogQXBwZW5kT3ZlcndyaXRlUHVibGlzaFR5cGVzW3R5cGUudG9Mb3dlckNhc2UoKV0sXG4gICAgICAgIG92ZXJ3cml0ZTogdHJ1ZSxcbiAgICAgICAgZGVsZXRlU291cmNlSXRlbVVwb25Db21wbGV0aW9uOiAhIW5ld0l0ZW1JZFxuICAgIH07XG4gICAgbGV0IHB1Ymxpc2hQYXJhbWV0ZXJzO1xuICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICBjYXNlIFwiQ1NWXCI6IHtcbiAgICAgICAgICAgIGNvbnN0IGxheWVySW5mbyA9IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgKF9lID0gc2VydmljZUluZm8ubGF5ZXJzKSA9PT0gbnVsbCB8fCBfZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2VbMF0pLCB7IGZpZWxkczogaXRlbVB1Ymxpc2hQYXJhbWV0ZXJzLmxheWVySW5mby5maWVsZHMgfSk7XG4gICAgICAgICAgICBwdWJsaXNoUGFyYW1ldGVycyA9IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7IGxheWVySW5mbywgbmFtZTogaXRlbVB1Ymxpc2hQYXJhbWV0ZXJzLm5hbWUgfHwgaXRlbURhdGEudGl0bGUucmVwbGFjZSgvIC9nLCBcIl9cIikgfSwgaXRlbVB1Ymxpc2hQYXJhbWV0ZXJzKSwgc2VydmljZUluZm8pO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgY2FzZSBcIk1pY3Jvc29mdCBFeGNlbFwiOiB7XG4gICAgICAgICAgICBwdWJsaXNoUGFyYW1ldGVycyA9IGdlbmVyYXRlRXhjZWxPdmVyd3JpdGVQdWJsaXNoUGFyYW1ldGVycyhpdGVtUHVibGlzaFBhcmFtZXRlcnMsIHNlcnZpY2VJbmZvKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICBwdWJsaXNoUGFyYW1ldGVycyA9IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBpdGVtUHVibGlzaFBhcmFtZXRlcnMpLCBzZXJ2aWNlSW5mbyksIHsgbmFtZTogaXRlbURhdGEudGl0bGUgPyBpdGVtRGF0YS50aXRsZS5yZXBsYWNlKC8gL2csIFwiX1wiKSA6IGl0ZW0udGl0bGUucmVwbGFjZSgvIC9nLCBcIl9cIikgfSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICB9XG4gICAgZmluYWxPdmVyd3JpdGVQYXJhbWV0ZXJzLnB1Ymxpc2hQYXJhbWV0ZXJzID0gSlNPTi5zdHJpbmdpZnkocHVibGlzaFBhcmFtZXRlcnMpO1xuICAgIHJldHVybiBmaW5hbE92ZXJ3cml0ZVBhcmFtZXRlcnM7XG59O1xuY29uc3QgZ2VuZXJhdGVFeGNlbE92ZXJ3cml0ZVB1Ymxpc2hQYXJhbWV0ZXJzID0gKHB1Ymxpc2hQYXJhbWV0ZXJzLCBzZXJ2aWNlSW5mbykgPT4ge1xuICAgIGNvbnN0IGZpbmFsT3ZlcndyaXRlUGFyYW1ldGVycyA9IE9iamVjdC5hc3NpZ24oe30sIHNlcnZpY2VJbmZvKTtcbiAgICAvL3NlcnZpY2UgbGV2ZWwgcHJvcGVydGllc1xuICAgIGZpbmFsT3ZlcndyaXRlUGFyYW1ldGVycy5uYW1lID0gcHVibGlzaFBhcmFtZXRlcnMubmFtZTtcbiAgICBmaW5hbE92ZXJ3cml0ZVBhcmFtZXRlcnMuc291cmNlU1IgPSBwdWJsaXNoUGFyYW1ldGVycy5zb3VyY2VTUjtcbiAgICBmaW5hbE92ZXJ3cml0ZVBhcmFtZXRlcnMudGFyZ2V0U1IgPSBwdWJsaXNoUGFyYW1ldGVycy50YXJnZXRTUjtcbiAgICAvL3RhYmxlIGlzIG5vdCB2YWxpZCBpbiBleGNlbCBwdWJsaXNoIHBhcmFtZXRlcnMsIHNvIGNvcHkgdG8gbGF5ZXJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZpbmFsT3ZlcndyaXRlUGFyYW1ldGVycy50YWJsZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgLy9pZiBleGNlbCBoYXMgUmV2aWV3IFRhYmxlLCBpZ25vcmUgaXRcbiAgICAgICAgaWYgKGZpbmFsT3ZlcndyaXRlUGFyYW1ldGVycy50YWJsZXNbaV0ubmFtZSAhPSBcIlJldmlld1wiKSB7XG4gICAgICAgICAgICBmaW5hbE92ZXJ3cml0ZVBhcmFtZXRlcnMubGF5ZXJzW2ZpbmFsT3ZlcndyaXRlUGFyYW1ldGVycy5sYXllcnMubGVuZ3RoXSA9IGZpbmFsT3ZlcndyaXRlUGFyYW1ldGVycy50YWJsZXNbaV07XG4gICAgICAgIH1cbiAgICB9XG4gICAgZm9yIChsZXQgbGF5ZXIgb2YgZmluYWxPdmVyd3JpdGVQYXJhbWV0ZXJzLmxheWVycykge1xuICAgICAgICBjb25zdCB7IGV4Y2VsU2hlZXRJZCwgbG9jYXRpb25UeXBlLCBsYXRpdHVkZUZpZWxkTmFtZSwgbG9uZ2l0dWRlRmllbGROYW1lLCBnZW9jb2RlU2VydmljZVVybCwgc291cmNlTG9jYWxlLCBzb3VyY2VDb3VudHJ5LCBzdGFuZGFyZGl6ZWRGaWVsZE5hbWVzLCBhZGRyZXNzRmllbGRzLCBjb29yZGluYXRlRmllbGROYW1lLCBjb29yZGluYXRlRmllbGRUeXBlLCBmaWVsZHMsIGRhdGVGaWVsZHNUaW1lUmVmZXJlbmNlIH0gPSBwdWJsaXNoUGFyYW1ldGVycy5sYXllcnNbbGF5ZXIuaWRdO1xuICAgICAgICBjb25zdCBwcm9wZXJ0aWVzVG9VcGRhdGUgPSB7XG4gICAgICAgICAgICBleGNlbFNoZWV0SWQsXG4gICAgICAgICAgICBsb2NhdGlvblR5cGUsXG4gICAgICAgICAgICBsYXRpdHVkZUZpZWxkTmFtZSxcbiAgICAgICAgICAgIGxvbmdpdHVkZUZpZWxkTmFtZSxcbiAgICAgICAgICAgIGdlb2NvZGVTZXJ2aWNlVXJsLFxuICAgICAgICAgICAgc291cmNlTG9jYWxlLFxuICAgICAgICAgICAgc291cmNlQ291bnRyeSxcbiAgICAgICAgICAgIHN0YW5kYXJkaXplZEZpZWxkTmFtZXMsXG4gICAgICAgICAgICBhZGRyZXNzRmllbGRzLFxuICAgICAgICAgICAgY29vcmRpbmF0ZUZpZWxkTmFtZSxcbiAgICAgICAgICAgIGNvb3JkaW5hdGVGaWVsZFR5cGUsXG4gICAgICAgICAgICBmaWVsZHMsXG4gICAgICAgICAgICBkYXRlRmllbGRzVGltZVJlZmVyZW5jZVxuICAgICAgICB9O1xuICAgICAgICBmaW5hbE92ZXJ3cml0ZVBhcmFtZXRlcnMubGF5ZXJzW2xheWVyLmlkXSA9IE9iamVjdC5hc3NpZ24oe30sIHByb3BlcnRpZXNUb1VwZGF0ZSk7XG4gICAgfVxuICAgIHJldHVybiBmaW5hbE92ZXJ3cml0ZVBhcmFtZXRlcnM7XG59O1xuXG5jb25zdCBwdWJsaXNoRm9yT3ZlcndyaXRlID0gYXN5bmMgKGl0ZW0sIHRpdGxlLCBwb3J0YWwsIHVzZXIpID0+IHtcbiAgICB2YXIgX2EsIF9iO1xuICAgIGNvbnN0IHBhcmFtcyA9IGF3YWl0IGdldFB1Ymxpc2hQYXJhbWV0ZXJzKGl0ZW0sIHBvcnRhbCwgdXNlcik7XG4gICAgY29uc3QgcHVibGlzaFJlc3BvbnNlID0gYXdhaXQgcHVibGlzaFNlcnZpY2UoeyBpdGVtSWQ6IGl0ZW0uc291cmNlRGF0YS5pZCwgdXNlciwgdGl0bGUsIGl0ZW1Pd25lclVybDogaXRlbS5pdGVtT3duZXIudXNlckNvbnRlbnRVcmwgfSwgLy8gISBVc2UgZmV0Y2hVc2VyIGlmIGl0ZW1Pd25lciBpcyBub3QgYXZhaWxhYmxlXG4gICAgcGFyYW1zKTtcbiAgICBjb25zdCBzZXJ2aWNlID0gKF9iID0gKF9hID0gcHVibGlzaFJlc3BvbnNlLnJlc3VsdCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNlcnZpY2VzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2JbMF07XG4gICAgcmV0dXJuIHtcbiAgICAgICAgaWQ6IHNlcnZpY2UgPT09IG51bGwgfHwgc2VydmljZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2VydmljZS5zZXJ2aWNlSXRlbUlkLFxuICAgICAgICBqb2JJZDogc2VydmljZSA9PT0gbnVsbCB8fCBzZXJ2aWNlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZXJ2aWNlLmpvYklkLFxuICAgICAgICBzZXJ2aWNlVHlwZTogc2VydmljZSA9PT0gbnVsbCB8fCBzZXJ2aWNlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZXJ2aWNlLnR5cGUsXG4gICAgICAgIHNlcnZpY2VVcmw6IHNlcnZpY2UgPT09IG51bGwgfHwgc2VydmljZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2VydmljZS5zZXJ2aWNldXJsLFxuICAgICAgICBvdmVyd3JpdGVTdGF0dXM6IFwiXCJcbiAgICB9O1xufTtcbmNvbnN0IGdldFB1Ymxpc2hQYXJhbWV0ZXJzID0gYXN5bmMgKGl0ZW0sIHBvcnRhbCwgdXNlciwgbmV3SXRlbUlkKSA9PiB7XG4gICAgY29uc3QgeyByZXN1bHQ6IHNlcnZpY2VJbmZvIH0gPSBhd2FpdCBmZXRjaEZlYXR1cmVTZXJ2aWNlSW5mb0Zvck92ZXJ3cml0ZShpdGVtLCBwb3J0YWwsIGZhbHNlLCB1c2VyKTtcbiAgICByZXR1cm4gYXdhaXQgY3JlYXRlT3ZlcndyaXRlUHVibGlzaFBhcmFtZXRlcnMoc2VydmljZUluZm8sIGl0ZW0sIG5ld0l0ZW1JZCk7XG59O1xuY29uc3QgZmV0Y2hBbmRVcGRhdGVJdGVtID0gYXN5bmMgKGl0ZW0sIHVzZXJDb250ZW50VXJsLCBhZGRJdGVtUHJvcHMpID0+IHtcbiAgICBjb25zdCBzb3VyY2VEYXRhID0gaXRlbS5zb3VyY2VEYXRhO1xuICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHVwZGF0ZUl0ZW1PdmVyd3JpdGUoc291cmNlRGF0YSwgdXNlckNvbnRlbnRVcmwsIHtcbiAgICAgICAgICAgIGZpbGU6IGFkZEl0ZW1Qcm9wcy5maWxlLFxuICAgICAgICAgICAgb3ZlcndyaXRlOiBhZGRJdGVtUHJvcHMub3ZlcndyaXRlLFxuICAgICAgICAgICAga2VlcERlc2NyaXB0aW9uOiBhZGRJdGVtUHJvcHMua2VlcERlc2NyaXB0aW9uXG4gICAgICAgIH0pO1xuICAgICAgICBhd2FpdCBjaGVja0pvYlN0YXR1cyh7IGlkOiBzb3VyY2VEYXRhLmlkLCBmb2xkZXI6IFwiXCIsIHN1Y2Nlc3M6IHRydWUgfSk7XG4gICAgICAgIHJldHVybiB7fTtcbiAgICB9XG4gICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICByZXR1cm4geyBlcnJvcjogeyBjb2RlOiBcInVuaGFuZGxlZEVycm9yXCIgfSB9O1xuICAgIH1cbn07XG5jb25zdCB1cGRhdGVJdGVtT3ZlcndyaXRlID0gYXN5bmMgKGl0ZW0sIHVzZXJDb250ZW50VXJsLCBhZGRJdGVtUHJvcHMpID0+IHtcbiAgICBjb25zdCB1cmwgPSBgJHt1c2VyQ29udGVudFVybH0vaXRlbXMvJHtpdGVtLmlkfS91cGRhdGVgO1xuICAgIGNvbnN0IGZvcm1EYXRhID0gZ2V0Rm9ybURhdGEoaXRlbSwge1xuICAgICAgICBmaWxlOiBhZGRJdGVtUHJvcHMuZmlsZSxcbiAgICAgICAgb3ZlcndyaXRlOiBhZGRJdGVtUHJvcHMub3ZlcndyaXRlLFxuICAgICAgICBrZWVwRGVzY3JpcHRpb246IGFkZEl0ZW1Qcm9wcy5rZWVwRGVzY3JpcHRpb25cbiAgICB9KTtcbiAgICByZXR1cm4gYXdhaXQgZm9ybVJlcXVlc3QodXJsLCBmb3JtRGF0YSwge30sIFwicG9zdFwiKTtcbn07XG5jb25zdCBmZXRjaEZlYXR1cmVTZXJ2aWNlSW5mb0Zvck92ZXJ3cml0ZSA9IGFzeW5jIChpdGVtLCBwb3J0YWwsIGlzU2VjdXJlLCB1c2VyKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgeyB1cmwgfSA9IGl0ZW07XG4gICAgICAgIGNvbnN0IHNlcnZpY2VJbmZvID0gYXdhaXQgcmVxdWVzdCh1cmwpO1xuICAgICAgICBjb25zdCBzZXJ2aWNlTGF5ZXJJbmZvID0gYXdhaXQgcmVxdWVzdCh1cmwgKyBcIi9sYXllcnNcIik7XG4gICAgICAgIGNvbnN0IGZvcm1hdHRlZExheWVycyA9IHNlcnZpY2VMYXllckluZm8gPT09IG51bGwgfHwgc2VydmljZUxheWVySW5mbyA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2VydmljZUxheWVySW5mby5sYXllcnMubWFwKChsYXllcikgPT4ge1xuICAgICAgICAgICAgZGVsZXRlIGxheWVyLmZpZWxkcztcbiAgICAgICAgICAgIHJldHVybiBsYXllcjtcbiAgICAgICAgfSk7XG4gICAgICAgIHNlcnZpY2VJbmZvLnRhYmxlcyA9IFsuLi5zZXJ2aWNlTGF5ZXJJbmZvID09PSBudWxsIHx8IHNlcnZpY2VMYXllckluZm8gPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNlcnZpY2VMYXllckluZm8udGFibGVzXTtcbiAgICAgICAgc2VydmljZUluZm8ubGF5ZXJzID0gWy4uLmZvcm1hdHRlZExheWVyc107XG4gICAgICAgIHJldHVybiB7IHJlc3VsdDogc2VydmljZUluZm8gfTtcbiAgICB9XG4gICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGlmICghaXNTZWN1cmUgJiYgKCgoZXJyb3IgPT09IG51bGwgfHwgZXJyb3IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGVycm9yLmNvZGUpID09PSA0OTkgJiYgKGVycm9yID09PSBudWxsIHx8IGVycm9yID09PSB2b2lkIDAgPyB2b2lkIDAgOiBlcnJvci5tZXNzYWdlKSA9PT0gXCJUb2tlbiBSZXF1aXJlZFwiKSB8fCBlcnJvci5jb2RlID09PSA0MDMpICYmIHVzZXIpIHtcbiAgICAgICAgICAgIHJldHVybiBmZXRjaEZlYXR1cmVTZXJ2aWNlSW5mb0Zvck92ZXJ3cml0ZShpdGVtLCBwb3J0YWwsIHRydWUsIHVzZXIpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICByZXR1cm4geyBlcnJvcjogeyBjb2RlOiBcInVuaGFuZGxlZEVycm9yXCIgfSB9O1xuICAgIH1cbn07XG5jb25zdCByZXNldFNlcnZpY2VUaXRsZSA9IGFzeW5jIChpdGVtKSA9PiB7XG4gICAgbGV0IGtleXdvcmRzID0gaXRlbS50eXBlS2V5d29yZHMudG9TdHJpbmcoKTtcbiAgICBjb25zdCB1cGRhdGVDb250ZW50ID0ge1xuICAgICAgICB0aXRsZTogaXRlbS50aXRsZSB8fCBcIlwiLFxuICAgICAgICB0YWdzOiBpdGVtLnRhZ3MudG9TdHJpbmcoKSB8fCBcIlwiXG4gICAgfTtcbiAgICBpZiAoaXRlbS50eXBlS2V5d29yZHMuaW5kZXhPZihcIkludm9sdmVkIExvb2t1cFwiKSAhPT0gLTEpIHtcbiAgICAgICAga2V5d29yZHMgKz0gXCIsc2hvd1VubWF0Y2hlZEFkZHJlc3Nlc1wiO1xuICAgICAgICB1cGRhdGVDb250ZW50W1widHlwZUtleXdvcmRzXCJdID0ga2V5d29yZHM7XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdXBkYXRlSXRlbShpdGVtLmlkLCB1cGRhdGVDb250ZW50KTtcbiAgICAgICAgY29uc3Qgam9iU3RhdHVzID0gYXdhaXQgZ2V0SXRlbVN0YXR1cyhpdGVtLmlkLCB7IHN1Y2Nlc3M6IHJlc3BvbnNlID09PSBudWxsIHx8IHJlc3BvbnNlID09PSB2b2lkIDAgPyB2b2lkIDAgOiByZXNwb25zZS5zdWNjZXNzIH0pO1xuICAgICAgICBpZiAoam9iU3RhdHVzLnN0YXR1cyA9PT0gXCJmYWlsZWRcIikge1xuICAgICAgICAgICAgcmV0dXJuIHsgZXJyb3I6IHsgY29kZTogXCJ1bmhhbmRsZWRFcnJvclwiIH0gfTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4geyByZXN1bHQ6IGpvYlN0YXR1cyB9O1xuICAgIH1cbiAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcImVycm9yOlwiLCBlcnJvcik7XG4gICAgICAgIHJldHVybiB7IGVycm9yOiB7IGNvZGU6IFwidW5oYW5kbGVkRXJyb3JcIiB9IH07XG4gICAgfVxufTtcbi8vZm9yIHZlY3RvciB0aWxlIHNlcnZpY2UgY2FzZVxuY29uc3QgdXBkYXRlSXRlbVJlc291cmNlID0gYXN5bmMgKGl0ZW0sIHVzZXJDb250ZW50VXJsLCBhZGRJdGVtUHJvcHMpID0+IHtcbiAgICBjb25zdCBmb2xkZXJJZCA9IGl0ZW0uZm9sZGVySWQgfHwgaXRlbS5vd25lckZvbGRlcjtcbiAgICBjb25zdCB1cmwgPSBgJHt1c2VyQ29udGVudFVybH0vJHtmb2xkZXJJZCA/IGZvbGRlcklkIDogXCJcIn0vaXRlbXMvJHtpdGVtLmlkfS91cGRhdGVSZXNvdXJjZXNgO1xuICAgIGNvbnN0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgZm9ybURhdGEuc2V0KFwiZmlsZVwiLCBhZGRJdGVtUHJvcHMuZmlsZSk7XG4gICAgZm9ybURhdGEuc2V0KFwicmVzb3VyY2VzUHJlZml4XCIsIFwic3R5bGVzXCIpO1xuICAgIGZvcm1EYXRhLnNldChcImZpbGVuYW1lXCIsIFwicm9vdC5qc29uXCIpO1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZm9ybVJlcXVlc3QodXJsLCBmb3JtRGF0YSwge30sIFwicG9zdFwiKTtcbiAgICAgICAgcmV0dXJuIHsgcmVzdWx0OiByZXNwb25zZSB9O1xuICAgIH1cbiAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgIHJldHVybiB7IGVycm9yOiB7IGNvZGU6IFwidW5oYW5kbGVkRXJyb3JcIiB9IH07XG4gICAgfVxufTtcbmNvbnN0IHVwZGF0ZVR5cGVLZXl3b3JkcyA9IGFzeW5jIChwdWJsaXNoUGFyYW1ldGVyc0pTT04sIGl0ZW0sIHNlcnZpY2VJdGVtSWQpID0+IHtcbiAgICBsZXQgdHlwZUtleXdvcmRzID0gW1wiQ2xvdWQgRHJpdmVcIl07XG4gICAgY29uc3QgcHVibGlzaFBhcmFtZXRlcnMgPSBKU09OLnBhcnNlKHB1Ymxpc2hQYXJhbWV0ZXJzSlNPTik7XG4gICAgaWYgKHB1Ymxpc2hQYXJhbWV0ZXJzLmxvY2F0aW9uVHlwZSA9PT0gXCJhZGRyZXNzXCIgfHxcbiAgICAgICAgKHB1Ymxpc2hQYXJhbWV0ZXJzLmxheWVyc1swXSAmJiBwdWJsaXNoUGFyYW1ldGVycy5sYXllcnNbMF0ubG9jYXRpb25UeXBlID09PSBcImFkZHJlc3NcIikpIHtcbiAgICAgICAgdHlwZUtleXdvcmRzLnB1c2goXCJzaG93VW5tYXRjaGVkQWRkcmVzc2VzXCIpO1xuICAgICAgICB0eXBlS2V5d29yZHMucHVzaChcIkludm9sdmVkIExvb2t1cFwiKTtcbiAgICB9XG4gICAgZWxzZSBpZiAocHVibGlzaFBhcmFtZXRlcnMubG9jYXRpb25UeXBlID09PSBcIm5vbmVcIiB8fFxuICAgICAgICAocHVibGlzaFBhcmFtZXRlcnMubGF5ZXJzWzBdICYmIHB1Ymxpc2hQYXJhbWV0ZXJzLmxheWVyc1swXS5sb2NhdGlvblR5cGUgPT09IFwibm9uZVwiKSkge1xuICAgICAgICB0eXBlS2V5d29yZHMucHVzaChcIlRhYmxlXCIpO1xuICAgIH1cbiAgICBjb25zdCBmaW5hbFR5cGVLZXl3b3JkcyA9IHR5cGVLZXl3b3Jkcy5qb2luKFwiLFwiKTtcbiAgICByZXR1cm4gYXdhaXQgdXBkYXRlSXRlbShpdGVtLmlkLCB7XG4gICAgICAgIGZvbGRlcklkOiAoaXRlbSA9PT0gbnVsbCB8fCBpdGVtID09PSB2b2lkIDAgPyB2b2lkIDAgOiBpdGVtLmZvbGRlcklkKSB8fCBpdGVtLm93bmVyRm9sZGVyLFxuICAgICAgICBpZDogc2VydmljZUl0ZW1JZCxcbiAgICAgICAgdHlwZUtleXdvcmRzOiBmaW5hbFR5cGVLZXl3b3Jkc1xuICAgIH0pO1xufTtcbmFzeW5jIGZ1bmN0aW9uIGdldFRva2VuRnJvbVByb3ZpZGVyKHByb3ZpZGVyKSB7XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgdG9rZW4gPSBhd2FpdCBwcm92aWRlci5jb25uZWN0KCk7XG4gICAgICAgIHJldHVybiB7IHJlc3VsdDogdG9rZW4gfTtcbiAgICB9XG4gICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHJldHVybiB7IGVycm9yOiB7IGNvZGU6IFwidW5oYW5kbGVkRXJyb3JcIiB9IH07XG4gICAgfVxufVxuXG5leHBvcnQgeyBnZXRQdWJsaXNoUGFyYW1ldGVycyBhcyBhLCB1cGRhdGVJdGVtT3ZlcndyaXRlIGFzIGIsIHVwZGF0ZUl0ZW1SZXNvdXJjZSBhcyBjLCBmZXRjaEFuZFVwZGF0ZUl0ZW0gYXMgZiwgZ2V0VG9rZW5Gcm9tUHJvdmlkZXIgYXMgZywgcHVibGlzaEZvck92ZXJ3cml0ZSBhcyBwLCByZXNldFNlcnZpY2VUaXRsZSBhcyByLCB1cGRhdGVUeXBlS2V5d29yZHMgYXMgdSB9O1xuXG4vLyMgc291cmNlTWFwcGluZ1VSTD1vdmVyd3JpdGUtN2ViOGRmZDQuanMubWFwIl0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9